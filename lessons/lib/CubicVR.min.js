/*
  Javascript port of CubicVR 3D engine for WebGL
  by Charles J. Cliffe
  http://www.cubicvr.org/

  May be used under the terms of the MIT license.
  http://www.opensource.org/licenses/mit-license.php
*/

/*globals alert: false */
try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(u,s,m,l,h){function d(a,b){t.registry[a]=!0;var g=b(t),e;for(e in g)g.hasOwnProperty(e)&&(f[e]=g[e])}var n="";try{for(var c=s.querySelectorAll("script"),m=0,a=c.length;m<a;m++){var b=c[m].src.lastIndexOf("/CubicVR.js");b>-1&&(n=c[m].src.substr(0,b)+"/")}}catch(e){}var f=u.CubicVR={},g={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,resize_active:!1,
emptyLight:null,resizeList:[]},r;try{r=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(q){r=function(){}}var t={undef:h,scriptLocation:n,GLCore:g,Textures:[],Textures_obj:[],Textures_ref:[],Images:[],ShaderPool:[],log:r,registry:{},MAX_LIGHTS:6},E={};g.init=function(a,b,e){var c,d=f.util;b&&e?(b=d.getScriptContents(b),e=d.getScriptContents(e)):f.CubicVRCoreVS&&f.CubicVRCoreFS?(b=f.CubicVRCoreVS,e=f.CubicVRCoreFS):(b=d.getScriptContents(n+"CubicVR_Core.vs"),
e=d.getScriptContents(n+"CubicVR_Core.fs"));if(a===h)a=s.createElement("canvas"),c||(c=a.getContext("experimental-webgl")),g.gl=c,g.fixed_size!==null?(g.width=g.fixed_size[0],g.height=g.fixed_size[1],g.resizeElement(a,g.width,g.height)):(a.style.position="absolute",g.addResizeable(a),g.resizeElement(a,u.innerWidth,u.innerHeight)),s.body.appendChild(a);if(a.getContext!==h&&a.width!==h&&a.height!==h){try{c||(c=a.getContext("experimental-webgl")),c.viewport(0,0,a.width,a.height),g.canvas=a,g.width=a.width,
g.height=a.height,c.clearColor(0,0,0,1),c.clearDepth(1),c.enable(c.DEPTH_TEST),c.depthFunc(c.LEQUAL)}catch(q){}if(!c)return null}else c=a;g.gl=c;g.CoreShader_vs=b;g.CoreShader_fs=e;c.enable(c.CULL_FACE);c.cullFace(c.BACK);c.frontFace(c.CCW);for(b=E.light.type.NULL;b<E.light.type.MAX;b++)t.ShaderPool[b]=[];e=new f.Texture;a=new f.Material;for(b=0;b<E.texture.map.MAX;b++)b!==E.texture.map.BUMP&&a.setTexture(e,b);a.opacity=0.5;b=1;try{for(;;){a.use(E.light.type.POINT,b);if(b===8){t.MAX_LIGHTS=b;break}b++}}catch(o){t.MAX_LIGHTS=
b}a=g.emptyLight=new f.Light(E.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;r("Calibrated maximum lights per pass to: "+b);for(b=E.light.type.NULL;b<E.light.type.MAX;b++)t.ShaderPool[b]=[];if(g.resizeList.length)u.addEventListener("resize",function(){f.GLCore.onResize()},!1),g.resize_active=!0;return c};g.addResizeable=function(a){f.GLCore.resizeList.push(a)};g.onResize=function(){var a=u.innerWidth,b=u.innerHeight;g.fixed_size!==null&&(a=f.GLCore.fixed_size[0],
b=f.GLCore.fixed_size[1]);for(var e=0,c=f.GLCore.resizeList.length;e<c;e++)g.resizeElement(f.GLCore.resizeList[e],a,b)};g.setFixedAspect=function(a){f.GLCore.fixed_aspect=a};g.setFixedSize=function(a,b){f.GLCore.fixed_size=[a,b]};g.getCanvas=function(){return f.GLCore.canvas};g.resizeElement=function(a,b,e){var c=g.gl;if(g.fixed_aspect!==0){var r=b*(1/f.GLCore.fixed_aspect);r>e&&(r=e,b=e*f.GLCore.fixed_aspect);e=r}if(a.getContext!==h){a.width=b;a.height=e;if(!f.GLCore.fixed_size)a.style.left=parseInt(u.innerWidth/
2-b/2)+"px",a.style.top=parseInt(u.innerHeight/2-e/2)+"px";c.viewport(0,0,b,e)}else a.resize(b,e)};g.setDepthAlpha=function(a,b,f){g.depth_alpha=a;g.depth_alpha_near=b;g.depth_alpha_far=f};g.setDefaultFilter=function(a){g.default_filter=a};g.setSoftShadows=function(a){g.soft_shadow=a};var o={GLCore:g,init:g.init,addResizeable:g.addResizeable,setFixedAspect:g.setFixedAspect,setFixedSize:g.setFixedSize,getCanvas:g.getCanvas,enums:E,IdentityMatrix:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Textures:t.Textures,
Textures_obj:t.Textures_obj,Images:t.Images,globalAmbient:[0.1,0.1,0.1],setGlobalAmbient:function(a){f.globalAmbient=a},setGlobalDepthAlpha:g.setDepthAlpha,setDefaultFilter:g.setDefaultFilter,setSoftShadows:g.setSoftShadows,RegisterModule:d,getScriptLocation:function(){return n}};d("Core",function(){return o})})(window,window.document,Math,function(){console.log("nop!")});
(function(){function u(){for(var d=0;d<s.length;d++)importScripts(CubicVR.getScriptLocation()+"/source/CubicVR."+s[d]+".js")}var s=["Math","Utility","Shader","MainLoop","Texture","Material","Mesh","UVMapper","Renderer","Light","Camera","Motion","Scene","PostProcess","Layout","Primitives","COLLADA","GML","Particles","Landscape","Octree","CVRXML","Worker"];try{for(var m=0;m<s.length;m++)document.write('<script type="text/javascript" src="'+CubicVR.getScriptLocation()+"/source/CubicVR."+s[m]+'.js"><\/script>')}catch(l){var h=
function(d){var n=d.data.data+"";CubicVR.getScriptLocation=function(){return n};u();self.removeEventListener("message",h,!1);CubicVR.InitWorker()};self.addEventListener("message",h,!1)}})();CubicVR.RegisterModule("COLLADA",function(u){function s(n,c){var a=CubicVR.util;new CubicVR.Mesh;new CubicVR.Scene;var b=a.getXML(n),e,f,g,r,q,t,h,o,B,p,z,w,x,F,v=CubicVR.util.xml2badgerfish(b),b=null;if(!v.COLLADA)throw Error(n+" does not appear to be a valid COLLADA file.");v=v.COLLADA;b={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(v.asset){var u=v.asset.up_axis.$;if(u==="X_UP")b.up_axis=0;else if(u==="Y_UP")b.up_axis=1;else if(u==="Z_UP")b.up_axis=
2}u=b.up_axis;if(v.library_images){if(v.library_images.image&&!v.library_images.image.length)v.library_images.image=[v.library_images.image];if(v.library_images.image.length){f=v.library_images.image;p=0;for(var y=f.length;p<y;p++){var A=f[p],s=A["@id"];e=A["@name"];A=A.init_from;if(A.$)A=A.$,c!==m&&A.lastIndexOf("/")!==-1&&(A=A.substr(A.lastIndexOf("/")+1)),c!==m&&A.lastIndexOf("\\")!==-1&&(A=A.substr(A.lastIndexOf("\\")+1)),b.images[s]={source:A,id:s,name:e}}}}var D,G,J;if(v.library_effects){var C=
v.library_effects.effect;C&&!C.length&&(C=[C]);A=0;for(D=C.length;A<D;A++){p=C[A];s=p["@id"];q={};q.id=s;q.surfaces=[];q.samplers=[];(y=p.profile_COMMON.newparam)&&!y.length&&(y=[y]);if(y){f=0;for(g=y.length;f<g;f++){var H=y[f];e=H["@sid"];if(H.surface){if(q.surfaces[e]={},H=H.surface.init_from.$,typeof b.images[H]==="object")q.surfaces[e].source=c+"/"+b.images[H].source}else if(H.sampler2D){q.samplers[e]={};q.samplers[e].source=H.sampler2D.source.$;if(H.sampler2D.minfilter)q.samplers[e].minfilter=
H.sampler2D.minfilter.$;if(H.sampler2D.magfilter)q.samplers[e].magfiter=H.sampler2D.magfilter.$}}}(f=p.profile_COMMON.technique)&&!f.length&&(f=[f]);g=function(){return function(b){if(!b.color)return!1;return(b=b.color)?a.floatDelimArray(b.$," "):!1}}();var H=function(){return function(a){var E;if(!a["float"])return!1;return E=(a=a["float"])?parseFloat(a.$):0,a=E}}(),K=function(){return function(a){if(!a.texture)return!1;return a.texture["@texture"]}}();q.material={textures_ref:[]};p=0;for(y=f.length;p<
y;p++){e=f[p].blinn;if(!e)e=f[p].phong;if(!e)e=f[p].lambert;if(e)for(x in e){var R=e[x],M=g(R),U=H(R),R=K(R);M!==!1&&M.length>3&&M.pop();if(x=="emission"){if(M!==!1)q.material.ambient=M}else if(x!="ambient")if(x=="diffuse"){if(M!==!1)q.material.color=M}else if(x=="specular"){if(M!==!1)q.material.specular=M}else if(x=="shininess"&&U!==!1)q.material.shininess=U;if(R!==!1)M=q.surfaces[q.samplers[R].source].source,x=="emission"?q.material.textures_ref.push({image:M,type:l.texture.map.AMBIENT}):x=="ambient"?
q.material.textures_ref.push({image:M,type:l.texture.map.AMBIENT}):x=="diffuse"?q.material.textures_ref.push({image:M,type:l.texture.map.COLOR}):x=="specular"?q.material.textures_ref.push({image:M,type:l.texture.map.SPECULAR}):x!="shininess"&&(x=="reflective"?q.material.textures_ref.push({image:M,type:l.texture.map.REFLECT}):x!="reflectivity"&&x=="transparent"&&q.material.textures_ref.push({image:M,type:l.texture.map.ALPHA}))}b.effects[s]=q}}}p=d.getAllOf(v.library_visual_scenes,"instance_material");
x=[];if(p.length){g=0;for(f=p.length;g<f;g++)s=p[g],y=s["@symbol"],s=s["@target"].substr(1),x[y]=s}f=v.library_materials;if(f.material){(y=f.material)&&!y.length&&(y=[y]);f=0;for(p=y.length;f<p;f++)if(s=y[f],e=s["@id"],A=s["@name"],s=s.instance_effect)s=s["@url"].substr(1),b.materials.push({id:e,name:A,mat:b.effects[s].material})}if(f=v.library_geometries)if((s=f.geometry)&&!s.length&&(s=[s]),s.length){e=0;for(A=s.length;e<A;e++){D={id:m,points:[],parts:[]};var T=s[e].mesh;if(T){var S=s[e]["@id"];
q=s[e]["@name"];(p=T.source)&&!p.length&&(p=[p]);C=[];y=0;for(g=p.length;y<g;y++)if(H=p[y],f=H["@id"],K=H["@name"],(M=H.float_array)&&(C[f]={id:f,name:K,data:a.floatDelimArray(M.$?M.$:""," ")}),H=H.technique_common.accessor)if(C[f].count=parseInt(H["@count"]),C[f].stride=parseInt(H["@stride"]),C[f].count)C[f].data=a.repackArray(C[f].data,C[f].stride,C[f].count);f=T.vertices;R=U=M=K=H=null;if(f&&(K=f["@id"],(g=f.input)&&!g.length&&(g=[g]),g)){o=0;for(t=g.length;o<t;o++)G=g[o],G["@semantic"]==="POSITION"&&
(H=G["@source"].substr(1))}var O=T.triangles;O&&!O.length&&(O=[O]);if(O){p=0;for(y=O.length;p<y;p++){var P={material:0,faces:[],normals:[],texcoords:[],colors:[]};f=parseInt(O[p]["@count"],10);(g=O[p].input)&&!g.length&&(g=[g]);J=[];if(g.length){o=0;for(t=g.length;o<t;o++)G=g[o],B=parseInt(G["@offset"],10),r=G["@source"].substr(1),G["@semantic"]==="VERTEX"?(r===K&&(r=H),J[B]=0):G["@semantic"]==="NORMAL"?(M=r,C[M].count&&(J[B]=1)):G["@semantic"]==="TEXCOORD"?(R=r,C[R].count&&(J[B]=2)):G["@semantic"]===
"COLOR"?(U=r,C[U].count&&(J[B]=3)):J[B]=4}o=J.length;g=O[p]["@material"];g===null?P.material=0:x[g]===m?(log("missing material ["+g+"]@"+q+"?"),P.material=0):P.material=x[g];g=O[p].p;o=[];g&&(o=a.intDelimArray(g.$," "));if(o.length&&(g=o.length/J.length/3,g===f)){if(D.points.length===0)D.points=C[H].data;g=B=0;f=o.length;for(B=J.length;g<f;g+=B*3){t=[];r=[];h=[];G=[];for(z=0;z<B*3;z++)w=z%B,J[w]===0?r.push(o[g+z]):J[w]===1?t.push(o[g+z]):J[w]===2?h.push(o[g+z]):J[w]===3&&G.push(o[g+z]);r.length&&
(P.faces.push(r),t.length===3&&P.normals.push([d.fixuaxis(b.up_axis,C[M].data[t[0]]),d.fixuaxis(b.up_axis,C[M].data[t[1]]),d.fixuaxis(b.up_axis,C[M].data[t[2]])]),h.length===3&&P.texcoords.push([C[R].data[h[0]],C[R].data[h[1]],C[R].data[h[2]]]),G.length===3&&P.colors.push([C[U].data[G[0]],C[U].data[G[1]],C[U].data[G[2]]]))}}D.parts.push(P)}}q=T.polylist;if(!q)q=T.polygons;q&&!q.length&&(q=[q]);if(q){p=0;for(y=q.length;p<y;p++){P={material:0,faces:[],normals:[],texcoords:[],colors:[]};h=parseInt(q[p]["@count"],
10);(g=q[p].input)&&!g.length&&(g=[g]);J=[];if(g.length){o=0;for(t=g.length;o<t;o++)G=g[o],f=G["@offset"],f===null&&(f=G["@idx"]),B=parseInt(f,10),r=G["@source"].substr(1),G["@semantic"]==="VERTEX"?(r===K&&(r=H),J[B]=0):G["@semantic"]==="NORMAL"?(M=r,J[B]=1):G["@semantic"]==="TEXCOORD"?(R=r,J[B]=2):G["@semantic"]==="COLOR"?(U=r,J[B]=3):J[B]=4}f=q[p].vcount;T=[];f&&(T=a.intDelimArray(f.$," "));g=q[p]["@material"];P.material=g===m?0:x[g];G=q[p].p;o=J.length;O=[];if(G.length>1&&!T.length){f=0;for(g=
G.length;f<g;f++)B=a.intDelimArray(G[f].$," "),T[f]=parseInt(B.length/o,10),O.splice(O.length,0,B)}else G&&(O=a.intDelimArray(G.$," "));if(O.length)if(g=T.length,g!==h)log("poly vcount data doesn't add up, skipping object load: "+g+" !== "+h);else{if(D.points.length===0)D.points=C[H].data;g=B=0;for(f=T.length;g<f;g++){t=[];r=[];h=[];G=[];z=0;for(w=T[g]*o;z<w;z++)J[z%o]===0?r.push(O[B]):J[z%o]===1?t.push(O[B]):J[z%o]===2?h.push(O[B]):J[z%o]===3&&G.push(O[B]),B++;if(r.length){P.faces.push(r);if(t.length){r=
[];z=0;for(w=t.length;z<w;z++)r.push(d.fixuaxis(b.up_axis,C[M].data[t[z]]));P.normals.push(r)}if(h.length){t=[];z=0;for(w=h.length;z<w;z++)t.push(C[R].data[h[z]]);P.texcoords.push(t)}if(G.length){t=[];z=0;for(w=G.length;z<w;z++)t.push(C[U].data[G[z]]);P.colors.push(t)}}}}D.parts.push(P)}}if(u!==1){g=0;for(f=D.points.length;g<f;g++)D.points[g]=d.fixuaxis(b.up_axis,D.points[g])}D.id=S;b.meshes.push(D)}}}if(x=v.library_cameras){(s=x.camera)&&!s.length&&(s=[s]);x=0;for(p=s.length;x<p;x++){f=s[x];e=f["@id"];
D=A=y=0;if(f.optics&&f.optics.technique_common&&f.optics.technique_common.perspective)y=f.optics.technique_common.perspective.yfov,A=f.optics.technique_common.perspective.znear,D=f.optics.technique_common.perspective.zfar;var N,Q;if(!y&&!A&&!D){(y=f.param)&&!y.length&&(y=[y]);g=0;for(f=y.length;g<f;g++)A=y[g].$,D=y[g]["@name"],D=="YFOV"?N=parseFloat(A):D=="ZNEAR"?Q=parseFloat(A):D=="ZFAR"&&(F=parseFloat(A))}else N=y?parseFloat(y.$):60,Q=A?parseFloat(A.$):0.1,F=D?parseFloat(D.$):1E3;b.cameras.push({id:e,
targeted:!1,fov:parseFloat(N),nearclip:parseFloat(Q),farclip:parseFloat(F)})}}if(N=v.library_lights)if((N=N.light)&&!N.length&&(N=[N]),N){Q=0;for(F=N.length;Q<F;Q++)if(s=N[Q],f=(x=s.technique_common.point)?x:null,x=s["@id"],f!==null)p=(p=f.intensity)?parseFloat(p.$):1,y=(y=f.distance)?parseFloat(y.$):10,f=f.color,G=[1,1,1],f&&(G=a.floatDelimArray(f.$," ")),b.lights.push({id:x,name:x,type:l.light.type.POINT,method:l.light.method.STATIC,diffuse:G,specular:[0,0,0],distance:y,intensity:p})}if(Q=v.library_visual_scenes){N=
null;(N=Q.visual_scene)&&!N.length&&(N=[N]);Q=0;for(F=N.length;Q<F;Q++){f=N[Q];x={id:f["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};p={};y=[];for(s=[f];s.length;)if(e=s.pop(),e.node&&((r=e.node)&&!r.length&&(r=[r]),r)){g=0;for(f=r.length;g<f;g++)r[g].parentNode=e,y.push(r[g]),s.push(r[g])}if(y.length){e=0;for(A=y.length;e<A;e++){K=y[e];q=K.instance_geometry;s=y[e].instance_light;f=y[e].instance_camera;D=K["@id"];C=K["@name"];g=d.cl_getInitalTransform(b.up_axis,K);if(u===2)g.rotation=
d.quaternionFilterZYYZ(g.rotation,f?[-90,0,0]:m);H={};q?(q=q["@url"].substr(1),H.name=H.id=C?C:D,H.position=g.position,H.rotation=g.rotation,H.scale=g.scale,H.meshId=S,H.meshName=q,x.sceneObjects.push(H),p[H.id]=!0,K.parentNode&&(f=K.parentNode["@id"])&&p[f]&&x.parentMap.push({parent:f,child:H.id})):f?(f=f["@url"].substr(1),x.cameras.push({name:C?C:D,id:C?C:D,source:f,position:g.position,rotation:g.rotation})):s?(f=s["@url"].substr(1),x.lights.push({name:C?C:D,id:C?C:D,source:f,position:g.position})):
x.sceneObjects.push({id:C!==null?C:D,name:C!==null?C:D,position:g.position,rotation:g.rotation,scale:g.scale})}}b.scenes.push(x)}}if(S=v.library_animations)if((u=S.animation)&&!u.length&&(u=[u]),u){N=0;for(Q=u.length;N<Q;N++){p=u[N];S=p["@id"];b.animations[S]={};b.animations[S].sources=[];(y=p.source)&&!y.length&&(y=[y]);if(y.length){F=0;for(x=y.length;F<x;F++){e=y[F];f=e["@id"];q=e.technique_common;A=s=null;e.name_array?s=a.textDelimArray(e.name_array.$," "):e.Name_array?s=a.textDelimArray(e.Name_array.$,
" "):e.float_array&&(A=a.floatDelimArray(e.float_array.$," "));e=0;C="";D=1;if(q)e=q,q=e.accessor,e=parseInt(q["@count"],10),C=q["@source"].substr(1),(q=q["@stride"])&&(D=parseInt(q,10));b.animations[S].sources[f]={data:s?s:A,count:e,source:C,stride:D};if(D!==1)b.animations[S].sources[f].data=a.repackArray(b.animations[S].sources[f].data,D,e)}}(y=p.sampler)&&!y.length&&(y=[y]);if(y){b.animations[S].samplers=[];F=0;for(x=y.length;F<x;F++)if(f=y[F],s=f["@id"],(g=f.input)&&!g.length&&(g=[g]),g){A=[];
e=0;for(f=g.length;e<f;e++)G=g[e],A[G["@semantic"]]=G["@source"].substr(1);b.animations[S].samplers[s]=A}}(F=p.channel)&&!F.length&&(F=[F]);if(F){b.animations[S].channels=[];x=0;for(p=F.length;x<p;x++)y=F[x],f=y["@source"].substr(1),y=y["@target"],e=y.split("/"),s=e[0],e=e[1].split("."),b.animations[S].channels.push({source:f,target:y,targetName:s,paramName:e[0],typeName:e[1]})}}}if(v=v.scene)if(f=v.instance_visual_scene)v=f["@url"].substr(1),b.scene=v;return b}var m=u.undef,l=CubicVR.enums,h=u.GLCore,
d={fixuaxis:function(d,c){if(d===0)return[c[1],c[0],c[2]];else if(d===1)return c;else if(d===2)return[c[0],c[2],-c[1]]},fixscaleaxis:function(d,c){if(d===0)return[c[1],c[0],c[2]];else if(d===1)return c;else if(d===2)return[c[0],c[2],c[1]]},fixukaxis:function(d,c,a,b){if(c===l.motion.POS&&a===l.motion.Z&&d===l.motion.Z)return-b;return b},getAllOf:function(d,c){for(var a=[d],b=[];a.length;){var e=a.pop(),f;for(f in e)if(e.hasOwnProperty(f)){if(f===c)if(e[f].length)for(var g=0,r=e[f].length;g<r;g++)b.push(e[f][g]);
else b.push(e[f]);if(typeof e[f]=="object")if(e[f].length){g=0;for(r=e[f].length;g<r;g++)a.push(e[f][g])}else a.push(e[f])}}return b},quaternionFilterZYYZ:function(d,c){var a=CubicVR.vec3,b=d,e=new CubicVR.Quaternion;c!==m&&(b=a.add(d,c));e.fromEuler(b[0],b[2],-b[1]);return e.toEuler()},cl_getInitalTransform:function(n,c){var a=CubicVR.util,b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=c.translate,f=c.rotate,g=c.scale;if(e)b.position=d.fixuaxis(n,a.floatDelimArray(e.$," "));if(f)for(var e=
0,r=f.length;e<r;e++){var q=f[e],t=q["@sid"],q=a.floatDelimArray(q.$," ");if(t=="rotateX"||t=="rotationX")b.rotation[0]=q[3];else if(t=="rotateY"||t=="rotationY")b.rotation[1]=q[3];else if(t=="rotateZ"||t=="rotationZ")b.rotation[2]=q[3]}if(g)b.scale=d.fixscaleaxis(n,a.floatDelimArray(g.$," "));return b}};return{loadCollada:function(n,c,a){for(var c=s(n,c,a),b=c.up_axis,e=[],f=0,g=c.materials.length;f<g;f++){for(var r=c.materials[f],q=new CubicVR.Material(r.mat),t=0,E=r.mat.textures_ref.length;t<E;t++){var o=
r.mat.textures_ref[t],B=null,B=u.Textures_ref[o.image]===void 0?new CubicVR.Texture(o.image,h.default_filter,a,n):u.Textures_obj[u.Textures_ref[o.image]];q.setTexture(B,o.type)}e[r.id]=q}r=[];f=0;for(g=c.meshes.length;f<g;f++){E=c.meshes[f];o=new CubicVR.Mesh(E.id);o.points=E.points;for(var B=0,p=E.parts.length;B<p;B++){var z=E.parts[B];z.material!==0&&o.setFaceMaterial(e[z.material]);var w=z.normals.length?!0:!1,x=z.texcoords.length?!0:!1,F=z.colors.length?!0:!1;if(F)e[z.material].color_map=!0;q=
0;for(t=z.faces.length;q<t;q++){var v=o.addFace(z.faces[q]);if(w)o.faces[v].point_normals=z.normals[q];if(x)o.faces[v].uvs=z.texcoords[q];if(F)o.faces[v].point_colors=z.colors[q]}}a?a.addMesh(n,n+":"+meshId,o):(o.triangulateQuads(),o.compile());r[E.id]=o}g=[];n=0;for(q=c.cameras.length;n<q;n++)g[c.cameras[n].id]=c.cameras[n];E=[];q=0;for(t=c.lights.length;q<t;q++)E[c.lights[q].id]=c.lights[q];a={};e={};f={};n={};o=0;for(B=c.scenes.length;o<B;o++){p=c.scenes[o];z=new CubicVR.Scene;q=0;for(t=p.sceneObjects.length;q<
t;q++)w=p.sceneObjects[q],x=new CubicVR.SceneObject(w),x.obj=(r[w.meshName]?r[w.meshName]:r[w.meshId])||null,a[w.id]=x,z.bindSceneObject(x);q=0;for(t=p.lights.length;q<t;q++)w=p.lights[q],x=new CubicVR.Light(E[w.source]),x.position=w.position,e[w.id]=x,z.bindLight(x);if(p.cameras.length)q=p.cameras[0],t=new CubicVR.Camera(g[q.source]),t.position=q.position,t.rotation=q.rotation,f[q.id]=t,z.camera=t;q=0;for(t=p.parentMap.length;q<t;q++)w=p.parentMap[q],a[w.parent].bindChild(a[w.child]);n[p.id]=z}for(animId in c.animations)if(c.animations.hasOwnProperty(animId)&&
(r=c.animations[animId],r.channels.length)){cCount=0;for(q=r.channels.length;cCount<q;cCount++){var g=r.channels[cCount],w=r.samplers[g.source],t=r.sources[w.INPUT],E=r.sources[w.OUTPUT],o=r.sources[w.INTERPOLATION],B=r.sources[w.IN_TANGENT],p=r.sources[w.OUT_TANGENT],z=w.IN_TANGENT!==m,w=w.OUT_TANGENT!==m,x=null,v=a[g.targetName],F=f[g.targetName],I=e[g.targetName];if(v){if(v.motion===null)v.motion=new CubicVR.Motion;x=v.motion}else if(F){if(F.motion===null)F.motion=new CubicVR.Motion;x=F.motion}else if(I){if(I.motion===
null)I.motion=new CubicVR.Motion;x=I.motion}if(x!==null){var v=l.motion.POS,y=l.motion.X;if(b===2)x.yzflip=!0;var A=g.paramName;if(A==="rotateX"||A==="rotationX")v=l.motion.ROT,y=l.motion.X;else if(A==="rotateY"||A==="rotationY")v=l.motion.ROT,y=l.motion.Y;else if(A==="rotateZ"||A==="rotationZ")v=l.motion.ROT,y=l.motion.Z;else if(A==="location"){v=l.motion.POS;if(g.typeName==="X")y=l.motion.X;if(g.typeName==="Y")y=l.motion.Y;if(g.typeName==="Z")y=l.motion.Z}else if(A==="translate"){v=l.motion.POS;
if(g.typeName==="X")y=l.motion.X;if(g.typeName==="Y")y=l.motion.Y;if(g.typeName==="Z")y=l.motion.Z}else if(A==="LENS")continue;else if(A==="FOV")v=l.motion.FOV,y=3;else if(A==="ZNEAR")v=l.motion.NEARCLIP,y=3;else if(A==="ZFAR")v=l.motion.FARCLIP,y=3;else if(A==="intensity")v=l.motion.INTENSITY,y=3;if(I&&v<3)I.method=l.light.method.DYNAMIC;mCount=0;for(g=t.data.length;mCount<g;mCount++)if(k=null,typeof E.data[mCount]==="object"){i=0;for(iMax=E.data[mCount].length;i<iMax;i++)if(I=i,b===2&&i===2?I=1:
b===2&&i===1&&(I=2),k=x.setKey(v,I,t.data[mCount],d.fixukaxis(c.up_axis,v,I,E.data[mCount][i])),o)if(A=o.data[mCount][i],A==="LINEAR")k.shape=l.envelope.shape.LINE;else if(A==="BEZIER")k.shape=!z&&!w?l.envelope.shape.LINEAR:l.envelope.shape.BEZI}else if(I=y,ofs=0,F&&v===l.motion.ROT&&b===2&&I===0&&(ofs=-90),v===l.motion.ROT?k=x.setKey(v,I,t.data[mCount],E.data[mCount]+ofs):(b===2&&y===2?I=1:b===2&&y===1&&(I=2),k=x.setKey(v,I,t.data[mCount],d.fixukaxis(c.up_axis,v,I,E.data[mCount]))),o)if(A=o.data[mCount],
A==="LINEAR")k.shape=l.envelope.shape.LINE;else if(A==="BEZIER")if(!z&&!w)k.shape=l.envelope.shape.LINEAR,k.continutity=1;else{k.shape=l.envelope.shape.BEZ2;var A=B.data[mCount][0],L,D=p.data[mCount][0];v===l.motion.ROT?(L=B.data[mCount][1],I=p.data[mCount][1],k.param[0]=A-k.time,k.param[1]=L-k.value+ofs,k.param[2]=D-k.time,k.param[3]=I-k.value+ofs):(L=d.fixukaxis(c.up_axis,v,I,B.data[mCount][1]),I=d.fixukaxis(c.up_axis,v,I,p.data[mCount][1]),k.param[0]=A-k.time,k.param[1]=L-k.value,k.param[2]=D-
k.time,k.param[3]=I-k.value)}}}}b=null;return b=c.scene?n[c.scene]:n.pop()},parseCollada:s}});CubicVR.RegisterModule("CVRXML",function(u){function s(c){if(c===null)return!1;return c.getElementsByTagName("x").length||c.getElementsByTagName("y").length||c.getElementsByTagName("z").length||c.getElementsByTagName("fov").length}function m(c,a,b){var e=CubicVR.util,f=[];f[0]=c.getElementsByTagName("x");f[1]=c.getElementsByTagName("y");f[2]=c.getElementsByTagName("z");f[3]=c.getElementsByTagName("fov");var g,r,q,n,l,o;for(o in f)if(f.hasOwnProperty(o)&&f[o]!==h&&f[o].length){g=f[o][0].getElementsByTagName("time");
r=f[o][0].getElementsByTagName("value");q=f[o][0].getElementsByTagName("in");n=f[o][0].getElementsByTagName("out");l=f[o][0].getElementsByTagName("tcb");var m=null,p=null,z=null,w=c=null;q.length&&(c=e.collectTextNode(q[0]));n.length&&(w=e.collectTextNode(n[0]));g.length&&(m=e.floatDelimArray(e.collectTextNode(g[0])," "));r.length&&(p=e.floatDelimArray(e.collectTextNode(r[0])," "));l.length&&(z=e.floatDelimArray(e.collectTextNode(l[0])," "));if(m!==null&&p!==null){g=0;for(r=m.length;g<r;g++)if(q=
b.setKey(a,o,m[g],p[g]),z)q.tension=z[g*3],q.continuity=z[g*3+1],q.bias=z[g*3+2]}p=m=d.envelope.behavior.CONSTANT;if(c)switch(c){case "reset":m=d.envelope.behavior.RESET;break;case "constant":m=d.envelope.behavior.CONSTANT;break;case "repeat":m=d.envelope.behavior.REPEAT;break;case "oscillate":m=d.envelope.behavior.OSCILLATE;break;case "offset":m=d.envelope.behavior.OFFSET;break;case "linear":m=d.envelope.behavior.LINEAR}if(w)switch(w){case "reset":p=d.envelope.behavior.RESET;break;case "constant":p=
d.envelope.behavior.CONSTANT;break;case "repeat":p=d.envelope.behavior.REPEAT;break;case "oscillate":p=d.envelope.behavior.OSCILLATE;break;case "offset":p=d.envelope.behavior.OFFSET;break;case "linear":p=d.envelope.behavior.LINEAR}b.setBehavior(a,o,m,p)}}function l(c,a){if(n[c]!==h)return n[c];var b=CubicVR.util,e,f,g,r,q,t,l=new CubicVR.Mesh,o=b.getXML(c);e=o.getElementsByTagName("points");var m=b.collectTextNode(e[0]).split(" ");e=0;for(r=m.length;e<r;e++){m[e]=m[e].split(",");f=0;for(q=m[e].length;f<
q;f++)m[e][f]=parseFloat(m[e][f])}l.addPoint(m);o=o.getElementsByTagName("material");m=[];e=0;for(r=o.length;e<r;e++){var p=o[e];f=p.getElementsByTagName("name").length?p.getElementsByTagName("name")[0].firstChild.nodeValue:null;g=new CubicVR.Material(f);if(p.getElementsByTagName("alpha").length)g.opacity=parseFloat(p.getElementsByTagName("alpha")[0].firstChild.nodeValue);if(p.getElementsByTagName("shininess").length)g.shininess=parseFloat(p.getElementsByTagName("shininess")[0].firstChild.nodeValue)/
100;if(p.getElementsByTagName("max_smooth").length)g.max_smooth=parseFloat(p.getElementsByTagName("max_smooth")[0].firstChild.nodeValue);if(p.getElementsByTagName("color").length)g.color=b.floatDelimArray(p.getElementsByTagName("color")[0].firstChild.nodeValue);if(p.getElementsByTagName("ambient").length)g.ambient=b.floatDelimArray(p.getElementsByTagName("ambient")[0].firstChild.nodeValue);if(p.getElementsByTagName("diffuse").length)g.diffuse=b.floatDelimArray(p.getElementsByTagName("diffuse")[0].firstChild.nodeValue);
if(p.getElementsByTagName("specular").length)g.specular=b.floatDelimArray(p.getElementsByTagName("specular")[0].firstChild.nodeValue);p.getElementsByTagName("texture").length&&(f=(a?a:"")+p.getElementsByTagName("texture")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),g.setTexture(f,d.texture.map.COLOR));p.getElementsByTagName("texture_luminosity").length&&(f=(a?a:"")+p.getElementsByTagName("texture_luminosity")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==
h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),g.setTexture(f,d.texture.map.AMBIENT));p.getElementsByTagName("texture_normal").length&&(f=(a?a:"")+p.getElementsByTagName("texture_normal")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),g.setTexture(f,d.texture.map.NORMAL));p.getElementsByTagName("texture_specular").length&&(f=(a?a:"")+p.getElementsByTagName("texture_specular")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:
new CubicVR.Texture(f),g.setTexture(f,d.texture.map.SPECULAR));p.getElementsByTagName("texture_bump").length&&(f=(a?a:"")+p.getElementsByTagName("texture_bump")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),g.setTexture(f,d.texture.map.BUMP));p.getElementsByTagName("texture_envsphere").length&&(f=(a?a:"")+p.getElementsByTagName("texture_envsphere")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),
g.setTexture(f,d.texture.map.ENVSPHERE));p.getElementsByTagName("texture_alpha").length&&(f=(a?a:"")+p.getElementsByTagName("texture_alpha")[0].firstChild.nodeValue,f=u.Textures_ref[f]!==h?u.Textures_obj[u.Textures_ref[f]]:new CubicVR.Texture(f),g.setTexture(f,d.texture.map.ALPHA));var z=null;if(p.getElementsByTagName("uvmapper").length){var w=new CubicVR.UVMapper,x=p.getElementsByTagName("uvmapper")[0];t="";if(x.getElementsByTagName("type").length)switch(t=p.getElementsByTagName("type")[0].firstChild.nodeValue,
t){case "planar":w.projection_mode=d.uv.projection.PLANAR;break;case "cylindrical":w.projection_mode=d.uv.projection.CYLINDRICAL;break;case "spherical":w.projection_mode=d.uv.projection.SPHERICAL;break;case "cubic":w.projection_mode=d.uv.projection.CUBIC}if(t==="uv"&&x.getElementsByTagName("uv").length){z=b.collectTextNode(p.getElementsByTagName("uv")[0]).split(" ");f=0;for(q=z.length;f<q;f++)z[f]=b.floatDelimArray(z[f])}if(x.getElementsByTagName("axis").length)switch(p.getElementsByTagName("axis")[0].firstChild.nodeValue){case "x":w.projection_axis=
d.uv.axis.X;break;case "y":w.projection_axis=d.uv.axis.Y;break;case "z":w.projection_axis=d.uv.axis.Z}if(p.getElementsByTagName("center").length)w.center=b.floatDelimArray(p.getElementsByTagName("center")[0].firstChild.nodeValue);if(p.getElementsByTagName("rotation").length)w.rotation=b.floatDelimArray(p.getElementsByTagName("rotation")[0].firstChild.nodeValue);if(p.getElementsByTagName("scale").length)w.scale=b.floatDelimArray(p.getElementsByTagName("scale")[0].firstChild.nodeValue);t!==""&&t!==
"uv"&&m.push([w,g])}x=w=null;p.getElementsByTagName("segments").length&&(w=b.intDelimArray(b.collectTextNode(p.getElementsByTagName("segments")[0])," "));p.getElementsByTagName("triangles").length&&(x=b.intDelimArray(b.collectTextNode(p.getElementsByTagName("triangles")[0])," "));w===null&&(w=[0,parseInt(x.length/3,10)]);p=0;l.setFaceMaterial(g);if(x.length){g=0;for(t=w.length;g<t;g+=2){var s=w[g+1]*3;l.setSegment(w[g]);f=p;for(q=p+s;f<q;f+=3){var v=l.addFace([x[f],x[f+1],x[f+2]]);z&&l.faces[v].setUV([z[f],
z[f+1],z[f+2]])}p+=s}}}l.calcNormals();e=0;for(r=m.length;e<r;e++)m[e][0].apply(l,m[e][1]);l.compile();return n[c]=l}var h=u.undef,d=CubicVR.enums,n=[];return{loadMesh:l,loadScene:function(c,a,b){var e=CubicVR.util;a===h&&(a="");b===h&&(b="");for(var f=new CubicVR.Mesh,g=e.getXML(c),c=new CubicVR.Scene,r=[],q=g.getElementsByTagName("sceneobjects"),n,E,o,B=0,p=q[0].childNodes.length;B<p;B++){var z=q[0].childNodes[B];if(z.tagName==="sceneobject"){var w="unnamed",x="",u="",f=z.getElementsByTagName("name");
f.length&&(w=e.collectTextNode(f[0]));f=z.getElementsByTagName("parent");f.length&&(x=e.collectTextNode(f[0]));f=z.getElementsByTagName("model");f.length&&(u=e.collectTextNode(f[0]));o=E=n=null;f=z.getElementsByTagName("position");f.length&&(n=f[0]);f=z.getElementsByTagName("rotation");f.length&&(E=f[0]);f=z.getElementsByTagName("scale");f.length&&(o=f[0]);f=null;u!==""&&(f=l(a+u,b));f=new CubicVR.SceneObject(f,w);if(s(n)){if(!f.motion)f.motion=new CubicVR.Motion;m(n,d.motion.POS,f.motion)}else if(n)f.position=
e.floatDelimArray(e.collectTextNode(n));if(s(E)){if(!f.motion)f.motion=new CubicVR.Motion;m(E,d.motion.ROT,f.motion)}else f.rotation=e.floatDelimArray(e.collectTextNode(E));if(s(o)){if(!f.motion)f.motion=new CubicVR.Motion;m(o,d.motion.SCL,f.motion)}else f.scale=e.floatDelimArray(e.collectTextNode(o));c.bindSceneObject(f);x!==""&&r.push([f,x])}}for(var v in r)r.hasOwnProperty(v)&&c.getSceneObject(r[v][1]).bindChild(r[v][0]);a=g.getElementsByTagName("camera");if(a.length){E=n=null;b="";f=a[0].getElementsByTagName("name");
v=c.camera;g=null;if(f.length)b=f[0].firstChild.nodeValue;f=a[0].getElementsByTagName("target");if(f.length)b=f[0].firstChild.nodeValue;if(b!=="")v.targetSceneObject=c.getSceneObject(b);f=a[0].getElementsByTagName("position");f.length&&(n=f[0]);f=a[0].getElementsByTagName("rotation");f.length&&(E=f[0]);f=a[0].getElementsByTagName("fov");f.length&&(g=f[0]);if(s(n)){if(!v.motion)v.motion=new CubicVR.Motion;m(n,d.motion.POS,v.motion)}else if(n)v.position=e.floatDelimArray(n.firstChild.nodeValue);if(s(E)){if(!v.motion)v.motion=
new CubicVR.Motion;m(E,d.motion.ROT,v.motion)}else if(E)v.rotation=e.floatDelimArray(E.firstChild.nodeValue);if(s(g)){if(!v.motion)v.motion=new CubicVR.Motion;m(g,d.motion.FOV,v.motion)}else if(g)v.fov=parseFloat(g.firstChild.nodeValue)}return c}}});CubicVR.RegisterModule("Camera",function(u){function s(c,a,b,e,f){var g=CubicVR.mat4;this.frustum=new CubicVR.Frustum;typeof c=="object"?(this.position=c.position?c.position:[0,0,0],this.rotation=c.rotation?c.rotation:[0,0,0],this.target=c.target?c.target:[0,0,0],this.fov=c.fov?c.fov:60,this.nearclip=c.nearclip?c.nearclip:0.1,this.farclip=c.farclip?c.farclip:400,this.targeted=c.targeted?c.targeted:!0,this.calc_nmatrix=c.calcNormalMatrix?c.calcNormalMatrix:!0,a=c.height?c.height:h,c=c.width?c.width:
h):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=b!==h?b:60,this.nearclip=e!==h?e:0.1,this.farclip=f!==h?f:400,this.calc_nmatrix=this.targeted=!0);this.motion=this.targetSceneObject=null;this.transform=new CubicVR.Transform;this.manual=!1;this.setDimensions(c!==h?c:512,a!==h?a:512);this.mvMatrix=g.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null}function m(c){this.position=c!==h?c:[0,0,0]}
function l(c,a,b){this.camPath=new CubicVR.Motion;this.targetPath=new CubicVR.Motion;this.start_position=c!==h?c:[8,8,8];this.target=a!==h?a:[0,0,0];this.bounds=b!==h?b:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var h=u.undef,d=CubicVR.enums,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];s.prototype={setParent:function(c){this.parent=
c},setOrtho:function(c,a,b,e){this.ortho=!0;this.ortho_view.left=c;this.ortho_view.right=a;this.ortho_view.bottom=b;this.ortho_view.top=e},control:function(c,a,b){c===d.motion.ROT?this.rotation[a]=b:c===d.motion.POS?this.position[a]=b:c===d.motion.FOV?this.setFOV(b):c===d.motion.LENS?this.setLENS(b):c===d.motion.NEARCLIP?this.setClip(b,this.farclip):c===d.motion.FARCLIP&&this.setClip(this.nearclip,b)},makeFrustum:function(c,a,b,e,f,g){return[2*f/(a-c),0,0,0,0,2*f/(e-b),0,0,(a+c)/(a-c),(e+b)/(e-b),
-(g+f)/(g-f),-1,0,0,-2*g*f/(g-f),0]},setTargeted:function(c){this.targeted=c},calcProjection:function(){var c=CubicVR.mat4,a=CubicVR.mat3;this.pMatrix=this.ortho?c.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):c.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted)c.identity(this.mvMatrix),c.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),c.translate(-this.position[0],-this.position[1],
-this.position[2],this.mvMatrix),this.parent!==null&&c.multiply(this.mvMatrix.slice(0),c.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=c.inverse_mat3(this.mvMatrix),a.transpose_inline(this.nMatrix)):c.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(c,a){this.nearclip=c;this.farclip=a;this.calcProjection()},setDimensions:function(c,a){this.width=c;this.height=a;this.aspect=c/a;this.calcProjection()},resize:function(c,a){this.setDimensions(c,
a)},setFOV:function(c){this.fov=c;this.ortho=!1;this.calcProjection()},setLENS:function(c){this.setFOV(2*Math.atan(16/c)*(180/Math.PI))},lookat:function(c,a,b,e,f,g,r,d,t){var h=CubicVR.mat4,o=CubicVR.mat3;if(typeof c=="object")this.lookat(this.position[0],this.position[1],this.position[2],c[0],c[1],c[2],0,1,0);else{this.mvMatrix=h.lookat(c,a,b,e,f,g,r,d,t);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=
this.transform.getResult();this.calc_nmatrix?(this.nMatrix=h.inverse_mat3(this.mvMatrix),o.transpose_inline(this.nMatrix)):this.nMatrix=n;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(c,a,b){var e=CubicVR.mat4,f=[0,0,this.width,this.height];if(b===h)b=this.farclip;c=e.vec4_multiply(e.vec4_multiply([(c-f[0])/f[2]*2-1,-((a-f[1])/f[3]*2-1),(b-this.nearclip)/(this.farclip-this.nearclip),1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix));return[c[0]/c[3],c[1]/c[3],c[2]/
c[3]]},project:function(c,a,b){var e=CubicVR.mat4,c=e.vec4_multiply(e.vec4_multiply([c,a,b,1],this.mvMatrix),this.pMatrix);return[(c[0]/c[3]+1)/2*this.width,(-c[1]/c[3]+1)/2*this.height,c[2]/c[3]*(this.farclip-this.nearclip)+this.nearclip]}};m.prototype={control:function(c,a,b){c===d.motion.POS&&(this.position[a]=b)}};l.prototype={inBounds:function(c){var a=CubicVR.vec3;if(!(c[0]>this.bounds[0][0]&&c[1]>this.bounds[0][1]&&c[2]>this.bounds[0][2]&&c[0]<this.bounds[1][0]&&c[1]<this.bounds[1][1]&&c[2]<
this.bounds[1][2]))return!1;for(var b=0,e=this.avoid_sphere.length;b<e;b++)if(a.length(c,this.avoid_sphere[b][0])<this.avoid_sphere[b][1])return!1;return!0},findNextNode:function(c,a){var b=CubicVR.vec3,e=[0,0,0],f=[0,0,0],g=e=0,r=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=b.normalize(f),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,e=b.add(a.position,b.multiply(f,e)),r=this.inBounds(e),g++,g>30){e=a.position;break}while(!r);return e},
run:function(c){this.current_time=c;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(d.motion.POS,d.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(d.motion.POS,d.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(d.motion.POS,d.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var a=new m,b=new m;this.path_length&&this.camPath.apply(this.path_time-
this.segment_time*2,a);this.camPath.apply(this.path_time-this.segment_time,b);a=this.findNextNode(a,b);this.camPath.setKey(d.motion.POS,d.motion.X,this.path_time,a[0]);this.camPath.setKey(d.motion.POS,d.motion.Y,this.path_time,a[1]);this.camPath.setKey(d.motion.POS,d.motion.Z,this.path_time,a[2]);this.path_length++}a=new m;this.camPath.apply(c,a);return a.position},addSafeBound:function(c,a){this.safe_bb.push([c,a])},addAvoidSphere:function(c,a){this.avoid_sphere.push([c,a])}};return{Camera:s,AutoCamera:l}});CubicVR.RegisterModule("GML",function(u){function s(l){var h=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(l!==m){var l=h.getXML(l),d=l.getElementsByTagName("header");if(!d.length)return null;var n=d[0],d=l.getElementsByTagName("environment");if(!d.length)return null;this.name=null;n=n.getElementsByTagName("name");if(n.length)this.name=h.collectTextNode(n[0]);n=d[0].getElementsByTagName("screenBounds");if(n.length)this.bounds=
[parseFloat(h.collectTextNode(n[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(n[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(n[0].getElementsByTagName("z")[0]))];n=d[0].getElementsByTagName("origin");if(n.length)this.origin=[parseFloat(h.collectTextNode(n[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(n[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(n[0].getElementsByTagName("z")[0]))];d=d[0].getElementsByTagName("up");if(d.length)this.upvector=
[parseFloat(h.collectTextNode(d[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(d[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(d[0].getElementsByTagName("z")[0]))];l=l.getElementsByTagName("drawing");d=0;for(n=l.length;d<n;d++)for(var c=l[d].getElementsByTagName("stroke"),a=0,b=0,e=0,f=0,g=0,r=c.length;g<r;g++){for(var q=c[g].getElementsByTagName("pt"),t=q.length,E=Array(t),o,B,p,z=0,w=t;z<w;z++)p=q[z],t=parseFloat(h.collectTextNode(p.getElementsByTagName("x")[0])),
o=parseFloat(h.collectTextNode(p.getElementsByTagName("y")[0])),B=parseFloat(h.collectTextNode(p.getElementsByTagName("z")[0])),p=parseFloat(h.collectTextNode(p.getElementsByTagName("time")[0])),this.upvector[0]===1?E[z]=[o!==o?0:o,t!==t?0:-t,B!==B?0:B,p]:this.upvector[1]===1?E[z]=[t!==t?0:t,o!==o?0:o,B!==B?0:B,p]:this.upvector[2]===1&&(E[z]=[t!==t?0:t,B!==B?0:-B,o!==o?0:o,p]),a<t&&(a=t),b<o&&(b=o),e<B&&(e=B),f<p&&(f=p);if(e>f){q=0;for(z=E.length;q<z;q++)t=E[q][3],E[q][3]=E[q][2],E[q][2]=t/this.bounds[2]}this.strokes[g]=
E}}}var m=u.undef;s.prototype={addStroke:function(l,h){var d=[];h===m&&(h=0.1);for(var n=0,c=l.length;n<c;n++){var a=[l[n][0],l[n][1],l[n][2]];this.manual_pos+=h;a.push(this.manual_pos);d.push(a)}this.strokes.push(d)},recenter:function(){var l=CubicVR.vec3,h=[0,0,0],d=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],n,c,a,b;a=0;for(b=this.strokes.length;a<b;a++){n=0;for(c=this.strokes[a].length;n<c;n++)h[0]>this.strokes[a][n][0]&&(h[0]=this.strokes[a][n][0]),h[1]>this.strokes[a][n][1]&&
(h[1]=this.strokes[a][n][1]),h[2]>this.strokes[a][n][2]&&(h[2]=this.strokes[a][n][2]),d[0]<this.strokes[a][n][0]&&(d[0]=this.strokes[a][n][0]),d[1]<this.strokes[a][n][1]&&(d[1]=this.strokes[a][n][1]),d[2]<this.strokes[a][n][2]&&(d[2]=this.strokes[a][n][2])}l=l.multiply(l.subtract(d,h),0.5);a=0;for(b=this.strokes.length;a<b;a++){n=0;for(c=this.strokes[a].length;n<c;n++)this.strokes[a][n][0]-=l[0],this.strokes[a][n][1]-=this.upvector[1]?l[1]:-l[1],this.strokes[a][n][2]-=l[2]}},generateObject:function(l,
h,d,n,c){var a=CubicVR.vec3;l===m&&(l=0);h===m&&(h=0);c===m&&(c=!1);n===m&&(n=0.02);d===m&&(d=0.015);for(var b=h!==0,e=0,f=0,g=new CubicVR.Mesh(this.name),r,q,t,E,o,B,p=0,z=this.strokes.length;p<z;p++){B=new CubicVR.Envelope;var w=new CubicVR.Envelope,x=new CubicVR.Envelope,s=this.strokes[p].length,v=0,u=[],y=[],A=0,L=this.strokes[p];for(o=0;o<s;o++){var D=L[o],G=B.addKey(D[3],D[0]),J=w.addKey(D[3],D[1]),C;C=c?x.addKey(D[3],D[2]):x.addKey(D[3],0);G.tension=0.5;J.tension=0.5;C.tension=0.5;o!==0?(r=
D[0]-r,q=D[1]-q,t=D[2]-t,E=D[3]-E,t=Math.sqrt(r*r+q*q+t*t),v+=t,u[o-1]=t,y[o-1]=E):A=D[3];r=D[0];q=D[1];t=D[2];E=D[3]}v=A;s=g.points.length;for(o=0;o<u.length;o++){A=y[o];L=v;D=v+A;for(G=A/Math.ceil(u[o]/n*3);L<D-G;L+=G){L===v&&(r=B.evaluate(L),q=w.evaluate(L),t=x.evaluate(L));var H,J=B.evaluate(L+G);C=w.evaluate(L+G);H=x.evaluate(L+G);var K;K=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([J-r,C-q,H-t]))),d/2);g.addPoint([r-K[0],-(q-K[1]),t-K[2]+(b?h/2:0)]);g.addPoint([r+K[0],-(q+K[1]),
t+K[2]+(b?h/2:0)]);r=J;q=C;t=H}v+=A}w=g.points.length;if(b){o=s;for(B=w;o<B;o++)g.addPoint([g.points[o][0],g.points[o][1],g.points[o][2]-(b?h/2:0)])}o=0;for(B=w-s;o<=B-4;o+=2)e%l===0&&f++,g.setSegment(f),x=[s+o,s+o+1,s+o+3,s+o+2],g.addFace(x),b&&(x=[x[3]+w-s,x[2]+w-s,x[1]+w-s,x[0]+w-s],g.addFace(x),x=[s+o,s+o+2,s+o+2+w-s,s+o+w-s],g.addFace(x),x=[s+o+1+w-s,s+o+3+w-s,s+o+3,s+o+1],g.addFace(x),o===0&&(x=[s+o+w-s,s+o+1+w-s,s+o+1,s+o],g.addFace(x)),o===B-4&&(x=[s+o+2,s+o+3,s+o+3+w-s,s+o+2+w-s],g.addFace(x))),
e++}g.calcFaceNormals();g.triangulateQuads();g.calcNormals();g.compile();return g}};return{GML:s}});CubicVR.RegisterModule("Landscape",function(u){function s(d,n,c,a){this.doTransform=function(){};this.tMatrix=l;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.size=d;this.divisions_w=n;this.divisions_h=c;this.matRef=a;this.children=null;this.obj=new CubicVR.Mesh;this.divisions_w>this.divisions_h?(this.size_w=d,this.size_h=d/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?d/this.divisions_h*this.divisions_w:d,this.size_h=d);for(n=-(this.size_h/2);n<
this.size_h/2;n+=this.size_h/this.divisions_h)for(d=-(this.size_w/2);d<this.size_w/2;d+=this.size_w/this.divisions_w)this.obj.addPoint([d+this.size_w/this.divisions_w/2,0,n+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(n=0;n<this.divisions_h-1;n++)for(d=0;d<this.divisions_w-1;d++)this.obj.addFace([d+(n+1)*this.divisions_w,d+1+n*this.divisions_w,d+n*this.divisions_w]),this.obj.addFace([d+(n+1)*this.divisions_w,d+1+(n+1)*this.divisions_w,d+1+n*this.divisions_w])}var m=u.undef,
l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h=Math.PI/2;s.prototype={getMesh:function(){return this.obj},setIndexedHeight:function(d,n,c){obj.points[d+n*this.divisions_w][1]=c},mapGen:function(d,n,c,a,b){if(n!==m&&c!==m&&a!==m&&b!==m){if(!(n>=this.divisions_w)&&!(c>=this.divisions_h)&&(n+a>=this.divisions_w&&(a=this.divisions_w-1-n),c+b>=this.divisions_h&&(b=this.divisions_h-1-c),!(a<=0||b<=0)))for(var e=n,a=n+a;e<a;e++)for(var f=c,g=c+b;f<g;f++)n=this.obj.points[e+f*this.divisions_w],n[1]=d(n[0],n[2])}else{c=
0;for(b=this.obj.points.length;c<b;c++)n=this.obj.points[c],n[1]=d(n[0],n[2])}},getFaceAt:function(d,n){if(typeof d==="object")return this.getFaceAt(d[0],d[2]);var c=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((d+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),c=parseInt(Math.floor((n+c)/this.size_h*this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(c<0)return-1;if(c>=this.divisions_h-1)return-1;var a=parseInt(a+c*(this.divisions_w-
1),10)*2,c=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(n-b[2])/Math.abs(d-b[0])>=1?a:c},getHeightValue:function(d,n){var c=CubicVR.triangle;if(typeof d==="object")return this.getHeightValue(d[0],d[2]);var a,b=this.getFaceAt(d,n);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var e=c.normal(this.obj.points[this.obj.faces[b].points[0]],this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),c=e[0],b=e[1],e=e[2];
return(c*d+e*n+(-(c*a[0])-b*a[1]-e*a[2]))/-b},orient:function(d,n,c,a,b,e){e===m&&(e=0);var f,g,r=[];f=c/2;var q=a/2;g=Math.sqrt(q*q+f*f);q=Math.atan2(q,f);b*=Math.PI/180;f=d+Math.sin(b)*e;e=n+Math.cos(b)*e;r[0]=this.getHeightValue([f+g*Math.cos(-q-h+b),0,e+g*-Math.sin(-q-h+b)]);r[1]=this.getHeightValue([f+g*Math.cos(q-h+b),0,e+g*-Math.sin(q-h+b)]);r[2]=this.getHeightValue([f+g*Math.cos(-q+h+b),0,e+g*-Math.sin(-q+h+b)]);r[3]=this.getHeightValue([f+g*Math.cos(q+h+b),0,e+g*-Math.sin(q+h+b)]);g=-Math.atan2(r[1]-
r[2],c);e=-Math.atan2(r[0]-r[1],a);g+=-Math.atan2(r[0]-r[3],c);e+=-Math.atan2(r[3]-r[2],a);g/=2;e/=2;return[[d,(r[2]+r[3]+r[1]+r[0])/4,n],[g*(180/Math.PI),b,e*(180/Math.PI)]]}};return{Landscape:s}});CubicVR.RegisterModule("Layout",function(){function u(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity=typeof m.opacity!=="undefined"?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function s(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;
this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity=typeof m.opacity!=="undefined"?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}u.prototype={addSubview:function(m){this.childViews.push(m);m.superView=this},makePanel:function(m){return this.superView.makePanel(m)}};s.prototype={setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(m){m.setInt("srcTex",0);m.addVector("screen");m.addVector("position");m.addVector("tint");m.addVector("size")}})},addSubview:function(m){this.childViews.push(m);m.superView=this},makePanel:function(m){var l=CubicVR.GLCore.gl,h={};h.vbo_points=new Float32Array([-1,
-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);h.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);h.gl_points=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,h.gl_points);l.bufferData(l.ARRAY_BUFFER,h.vbo_points,l.STATIC_DRAW);h.gl_uvs=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,h.gl_uvs);l.bufferData(l.ARRAY_BUFFER,h.vbo_uvs,l.STATIC_DRAW);m.panel=h},renderPanel:function(m){if(!m.texture)return!1;m.texture.use(CubicVR.GLCore.gl.TEXTURE0)},renderView:function(m){if(m.texture){var l=CubicVR.GLCore.gl,h=
m.offsetLeft,d=m.offsetTop;h||(h=0);d||(d=0);var n=this.shader.shader;n.use();n.setVector("screen",[this.width,this.height,0]);n.setVector("position",[m.x+h,m.y+d,0]);n.setVector("size",[m.width,m.height,0]);n.setVector("tint",m.tint);m.blend&&(l.enable(l.BLEND),l.blendFunc(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA));m.texture.use(l.TEXTURE0);l.drawArrays(l.TRIANGLES,0,6);m.blend&&(l.disable(l.BLEND),l.blendFunc(l.ONE,l.ZERO))}},render:function(){var m=CubicVR.GLCore.gl;m.disable(m.DEPTH_TEST);this.texture&&
this.renderView(this);var l=[];this.offsetTop=this.offsetLeft=0;l.push(this);shader=this.shader.shader;shader.use();m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_points);m.vertexAttribPointer(shader.uniforms.aVertex,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(shader.uniforms.aVertex);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_uvs);m.vertexAttribPointer(shader.uniforms.aTex,2,m.FLOAT,!1,0,0);m.enableVertexAttribArray(shader.uniforms.aTex);for(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,
null);l.length;){var h=l.pop();this.renderView(h);if(h.childViews.length)for(var d=h.childViews.length-1;d>=0;d--)h.childViews[d].offsetLeft=h.x+h.offsetLeft,h.childViews[d].offsetTop=h.y+h.offsetTop,l.push(h.childViews[d])}m.disableVertexAttribArray(shader.uniforms.aTex);m.enable(m.DEPTH_TEST)}};return{Layout:s,View:u}});CubicVR.RegisterModule("Light",function(u){function s(d,c){var a=CubicVR.aabb;if(d===h)d=l.light.type.POINT;if(c===h)c=l.light.method.DYNAMIC;typeof d=="object"?(this.light_type=d.type!==h?d.type:l.light.type.POINT,this.diffuse=d.diffuse!==h?d.diffuse:[1,1,1],this.specular=d.specular!==h?d.specular:[1,1,1],this.intensity=d.intensity!==h?d.intensity:1,this.position=d.position!==h?d.position:[0,0,0],this.direction=d.direction!==h?d.direction:[0,0,0],this.distance=d.distance!==h?d.distance:this.light_type===
l.light.type.AREA?30:10,this.cutoff=d.cutoff!==h?d.cutoff:60,this.map_res=d.map_res!==h?d.map_res:this.light_type===l.light.type.AREA?2048:512,this.map_res=d.mapRes!==h?d.mapRes:this.map_res,this.method=d.method!==h?d.method:c,this.areaCam=d.areaCam!==h?d.areaCam:null,this.areaCeiling=d.areaCeiling!==h?d.areaCeiling:40,this.areaFloor=d.areaFloor!==h?d.areaFloor:-40,this.areaAxis=d.areaAxis!==h?d.areaAxis:[1,1,0]):(this.light_type=d,this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=
[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===l.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===l.light.type.AREA?2048:512,this.method=c,this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0]);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);
this.adjust_octree=CubicVR.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===l.light.type.SPOT_SHADOW||this.light_type===l.light.type.AREA)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var m=u.GLCore,l=CubicVR.enums,h=u.undef,d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];l.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,MAX:7},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};s.prototype={setType:function(){this.light_type=
type},setParent:function(d){this.parent=d},setMethod:function(d){this.method=d},setDiffuse:function(d){this.diffuse=d},setSpecular:function(d){this.specular=d},setIntensity:function(d){this.intensity=d},setPosition:function(d){this.position=d},setDistance:function(d){this.distance=d},setCutoff:function(d){this.cutoff=d},prepare:function(d){var c=CubicVR.mat4,a=CubicVR.mat3,b=this.light_type;if(this.parent)if(b===l.light.type.SPOT||b===l.light.type.SPOT_SHADOW)b=c.inverse_mat3(this.parent.tMatrix),
a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,d.nMatrix),this.lPos=c.vec3_multiply(this.position,c.multiply(d.mvMatrix,this.parent.tMatrix));else{if(b===l.light.type.POINT)this.lPos=c.vec3_multiply(this.position,c.multiply(d.mvMatrix,this.parent.tMatrix))}else if(b===l.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,d.nMatrix);else if(b===l.light.type.SPOT||b===l.light.type.SPOT_SHADOW)this.lDir=a.vec3_multiply(this.direction,
d.nMatrix),this.lPos=c.vec3_multiply(this.position,d.mvMatrix);else if(b===l.light.type.POINT)this.lPos=c.vec3_multiply(this.position,d.mvMatrix);else if(b===l.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,d.nMatrix)},control:function(d,c,a){if(d===l.motion.POS)this.position[c]=a;else if(d===l.motion.INTENSITY)this.intensity=a},getAABB:function(){var d=CubicVR.vec3,c=CubicVR.aabb,a=[[0,0,0],[0,0,0]];c.engulf(a,[this.distance,this.distance,this.distance]);c.engulf(a,[-this.distance,-this.distance,
-this.distance]);a[0]=d.add(a[0],this.position);a[1]=d.add(a[1],this.position);return this.aabb=a},setDirection:function(d,c,a){var b=CubicVR.vec3;if(typeof d==="object")this.setDirection(d[0],d[1],d[2]);else return this.direction=b.normalize([d,c,a]),this},lookat:function(d,c,a){var b=CubicVR.vec3;if(typeof d==="object")this.lookat(d[0],d[1],d[2]);else return this.direction=b.normalize(b.subtract([d,c,a],this.position)),this},setRotation:function(d,c,a){var b=CubicVR.mat4,e=CubicVR.vec3;if(typeof d===
"object")this.setRotation(d[0],d[1],d[2]);else{var f=new CubicVR.Transform;f.rotate([-d,-c,-a]);f.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],f.getResult()));this.rotation=[d,c,a];return this}},setupShader:function(d,c){var a=m.gl;a.uniform3fv(d.lDiff[c],this.diffuse);a.uniform3fv(d.lSpec[c],this.specular);this.lPos&&a.uniform3fv(d.lPos[c],this.lPos);this.lDir&&a.uniform3fv(d.lDir[c],this.lDir);a.uniform1f(d.lInt[c],this.intensity);a.uniform1f(d.lDist[c],this.distance);(this.light_type===
l.light.type.SPOT_SHADOW||this.light_type===l.light.type.SPOT)&&a.uniform1f(d.lCut[c],this.cutoff);if(this.light_type===l.light.type.SPOT_SHADOW||this.light_type===l.light.type.AREA)this.shadowMapTex.texture.use(m.gl.TEXTURE0+c),a.uniform1i(d.lDepthTex[c],c),a.uniform3fv(d.lDepth[c],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(d.spMatrix[c],!1,this.spMatrix)},setShadow:function(d){this.map_res=d;this.shadowMapTex=new CubicVR.RenderBuffer(this.map_res,this.map_res,
!0);this.shadowMapTex.texture.setFilter(l.texture.filter.NEAREST);this.dummyCam=new CubicVR.Camera(this.map_res,this.map_res,80,0.1,this.distance);this.dummyCam.calc_nmatrix=!1;this.dummyCam.setTargeted(!0);this.has_shadow=!0},hasShadow:function(){return has_shadow},shadowBegin:function(){var d=m.gl,c=CubicVR.mat4,a=CubicVR.mat3;this.shadowMapTex.use();d.viewport(0,0,this.map_res,this.map_res);d.clear(d.DEPTH_BUFFER_BIT|d.COLOR_BUFFER_BIT);this.light_type!==l.light.type.AREA?(this.dummyCam.setClip(0.1,
this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=c.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a=a.vec3_multiply(this.direction,b);c=c.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(c[0],c[1],c[2],c[0]+a[0]*10,c[1]+a[1]*10,c[2]+a[2]*10,0,1,0)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+
this.direction[2]*10,0,1,0);d.cullFace(d.FRONT)},shadowEnd:function(){var d=m.gl;d.bindFramebuffer(d.FRAMEBUFFER,null);d.cullFace(d.BACK);this.setupTexGen()},setupTexGen:function(){var n=CubicVR.mat4;this.spMatrix=n.multiply(d,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=n.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=n.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(d){this.areaAxis=d},updateAreaLight:function(){var d=CubicVR.vec3,c=this.areaCeiling-
this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=d.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=d.normalize(b);d.normalize(d.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);b=d.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];e-=Math.atan2(a[0],a[2]);this.position=d.add(d.add(this.areaCam.position,
b),d.multiply(a,c));this.position[1]=this.areaCeiling;this.target=d.add(d.add(this.areaCam.position,b),d.multiply(a,-c));this.target[1]=this.areaFloor;this.direction=d.normalize(d.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/Math.PI);d=this.dummyCam.nearclip;c=this.dummyCam.farclip*Math.abs(this.direction[1])*c;d=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);d[0][1]<this.areaCeiling&&(d=this.areaCeiling-
d[0][1]);d=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);d[1][1]>this.areaFloor&&(d=d[1][1]-this.areaFloor,c+=d/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=c;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(d,c,a,b,e,f){var b=CubicVR.vec3,g=b.normalize([e[0],e[4],e[8]]),r=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(r,
g)),q;q=a/2;a=[];c=b.multiply(g,c/2);g=b.multiply(r,q);f=b.multiply(e,f);a[0]=b.add(b.subtract(d,c),b.add(g,f));a[1]=b.add(b.add(d,c),b.add(g,f));a[2]=b.subtract(b.subtract(d,c),b.add(g,f));a[3]=b.subtract(b.add(d,c),b.add(g,f));aabb1=a[0];aabb2=a[0];for(d=1;d<4;d++)aabb1[0]>a[d][0]&&(aabb1[0]=a[d][0]),aabb1[1]>a[d][1]&&(aabb1[1]=a[d][1]),aabb1[2]>a[d][2]&&(aabb1[2]=a[d][2]),aabb2[0]<a[d][0]&&(aabb2[0]=a[d][0]),aabb2[1]<a[d][1]&&(aabb2[1]=a[d][1]),aabb2[2]<a[d][2]&&(aabb2[2]=a[d][2]);return[aabb1,
aabb2]}};return{Light:s}});CubicVR.RegisterModule("MainLoop",function(u){function s(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function m(){CubicVR.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(m),CubicVR.GLCore.mainloop.interval())}function l(c,a){if(window.requestAnimationFrame===d)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(CubicVR.GLCore.mainloop!==null)!window.requestAnimationFrame&&CubicVR.GLCore.mainloop&&clearInterval(CubicVR.GLCore.mainloop.interval),CubicVR.GLCore.mainloop=null;if(c===null)CubicVR.GLCore.mainloop=null;else{this.renderList=[];var b=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],e=new s;e.start();this.timer=e;this.func=c;this.doclear=a!==d?a:!0;CubicVR.GLCore.mainloop=this;if(n.resizeList.length&&!CubicVR.GLCore.resize_active)window.addEventListener("resize",
function(){CubicVR.GLCore.onResize()},!1),CubicVR.GLCore.resize_active=!0;var f=function(){return function(){var a=CubicVR.GLCore.gl;e.update();CubicVR.GLCore.mainloop.doclear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);c(e,CubicVR.GLCore.gl);var f=b[b.length-1],d=f.scenes;f.update&&f.update(e,a);if(d){a=0;for(f=d.length;a<f;++a){var t=d[a];t.paused||(t.update&&t.update(e,CubicVR.GLCore.gl),t.render())}}}}();window.requestAnimationFrame?(this.interval=f,window.requestAnimationFrame(m)):this.interval=
setInterval(f,20)}}function h(c,a,b){this.canvas=c;this.camera=a;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,e.mpos,e.keyState)}}();
this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-e.mpos[0];b[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,b,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(){}}();this.onKeyUp=function(){return function(){}}();this.eventDefaults=
{mouseMove:function(a,b,e){a.mdown&&a.orbitView(e)},mouseWheel:function(a,b,e){a.zoomView(e)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null};b!==!1&&this.setEvents(b===d?this.eventDefaults:b);this.bind()}var d=u.undef,n=u.GLCore;s.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},
lockFramerate:function(){this.lock_rate=1/this.f_rate;this.lock_state=!0},unlock:function(){var c=this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=c-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=parseInt(lock_rate*1E3):this.system_milliseconds=(new Date).getTime();
this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(c){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-c},setSeconds:function(c){this.setMilliseconds(parseInt(c*1E3))},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/
1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(c){this.paused_state=c},getPaused:function(){return this.paused_state}};l.prototype={setPaused:function(c){this.timer.setPaused(c)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(c){this.timer.setSeconds(c)},
getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(c){this.renderStack[this.renderStack.length-1].scenes.push(c);return c},pushSceneGroup:function(c){c.scenes=c.scenes||[];this.renderStack.push(c);for(var a=0;a<c.scenes.length;++a)c.scenes[a].enable();c.start&&c.start()},popSceneGroup:function(){for(var c=this.renderStack[this.renderStack.length-1],a=0;a<c.scenes.length;++a)c.scenes[a].disable();this.renderStack.length>1&&this.renderStack.pop();
c.stop&&c.stop()},getScene:function(c){for(var a=renderStack[renderStack.length-1],b,e=0,f=a.scenes.length;e<f;++e)if(a.scenes[e].scene.name===c){b=a.scenes[e];break}return b},resumeScene:function(c){typeof c==="string"&&(c=this.getScene(c));c.enable();c.paused=!1},pauseScene:function(c){typeof c==="string"&&(c=this.getScene(c));c.paused=!0;c.disable()},removeScene:function(c){var a=renderStack[renderStack.length-1];typeof c==="string"&&(c=this.getScene(c));var b=a.scenes.indexOf(c);b>-1&&a.scenes.splice(b,
1);return c}};h.prototype={setEvents:function(c){this.mEvents={};for(var a in c)this.bindEvent(a,c[a])},orbitView:function(c){var a=CubicVR.vec3,b=a.subtract(this.camera.target,this.camera.position),b=a.length(b);this.camera.position=a.moveViewRelative(this.camera.position,this.camera.target,-b*c[0]/300,0);this.camera.position[1]+=b*c[1]/300;this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),b))},panView:function(c,a){var b=CubicVR.vec3;
a||(a=!1);var e=b.subtract(this.camera.target,this.camera.position),e=b.length(e),f=this.camera.position;a?this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*c[0]/300,-e*c[1]/300):(this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*c[0]/300,0),this.camera.position[1]+=e*c[1]/300);e=b.subtract(this.camera.position,f);this.camera.target=b.add(this.camera.target,e)},zoomView:function(c,a,b){var e=CubicVR.vec3,f=e.subtract(this.camera.target,
this.camera.position),f=e.length(f);f-=c/1E3;a||(a=0.1);b||(b=1E3);f<a&&(f=a);f>b&&(f=b);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(c,a){this.mEvents[c]=a===d?this.eventDefaults[c]:a},unbindEvent:function(c){this.bindEvent(c,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",
this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.addEventListener("keydown",this.onKeyDown,!1);this.canvas.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);this.canvas.removeEventListener("keydown",this.onKeyDown,!1);this.canvas.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(c){this.camera=c},getMousePosition:function(){return this.mpos}};return{Timer:s,MainLoop:l,MouseViewController:h,setMainLoop:function(c){CubicVR.GLCore.mainloop=c}}});CubicVR.RegisterModule("Material",function(u){function s(d){this.initialized=!1;this.textures=[];this.shader=[];this.customShader=null;typeof d==="object"?(this.diffuse=d.diffuse===m?[1,1,1]:d.diffuse,this.specular=d.specular===m?[0.1,0.1,0.1]:d.specular,this.color=d.color===m?[1,1,1]:d.color,this.ambient=d.ambient===m?[0,0,0]:d.ambient,this.opacity=d.opacity===m?1:d.opacity,this.shininess=d.shininess===m?1:d.shininess,this.max_smooth=d.max_smooth===m?60:d.max_smooth,this.env_amount=d.env_amount===
m?0.75:d.env_amount,this.morph=d.morph===m?!1:d.morph,this.color_map=d.colorMap===m?!1:d.colorMap,this.name=d.name===m?m:d.name,typeof d.textures==="object"&&(d.textures.color!==m&&this.setTexture(d.textures.color,h.texture.map.COLOR),d.textures.envsphere!==m&&this.setTexture(d.textures.envsphere,h.texture.map.ENVSPHERE),d.textures.normal!==m&&this.setTexture(d.textures.normal,h.texture.map.NORMAL),d.textures.bump!==m&&this.setTexture(d.textures.bump,h.texture.map.BUMP),d.textures.reflect!==m&&this.setTexture(d.textures.reflect,
h.texture.map.REFLECT),d.textures.specular!==m&&this.setTexture(d.textures.specular,h.texture.map.SPECULAR),d.textures.ambient!==m&&this.setTexture(d.textures.ambient,h.texture.map.AMBIENT),d.textures.alpha!==m&&this.setTexture(d.textures.alpha,h.texture.map.ALPHA))):(this.diffuse=[1,1,1],this.specular=[0.1,0.1,0.1],this.color=[1,1,1],this.ambient=[0,0,0],this.shininess=this.opacity=1,this.max_smooth=60,this.name=d,this.color_map=this.morph=!1)}var m=u.undef,l=u.GLCore,h=CubicVR.enums;s.prototype=
{setTexture:function(d,h){h===m&&(h=0);this.textures[h]=d},calcShaderMask:function(){var d=0;d+=typeof this.textures[h.texture.map.COLOR]==="object"?h.shader.map.COLOR:0;d+=typeof this.textures[h.texture.map.SPECULAR]==="object"?h.shader.map.SPECULAR:0;d+=typeof this.textures[h.texture.map.NORMAL]==="object"?h.shader.map.NORMAL:0;d+=typeof this.textures[h.texture.map.BUMP]==="object"?h.shader.map.BUMP:0;d+=typeof this.textures[h.texture.map.REFLECT]==="object"?h.shader.map.REFLECT:0;d+=typeof this.textures[h.texture.map.ENVSPHERE]===
"object"?h.shader.map.ENVSPHERE:0;d+=typeof this.textures[h.texture.map.AMBIENT]==="object"?h.shader.map.AMBIENT:0;d+=typeof this.textures[h.texture.map.ALPHA]==="object"?h.shader.map.ALPHA:0;d+=this.opacity!==1?h.shader.map.ALPHA:0;return d},getShaderHeader:function(d,n){return(n!==m?"#define loopCount "+n+"\n":"")+"#define hasColorMap "+(typeof this.textures[h.texture.map.COLOR]==="object"?1:0)+"\n#define hasSpecularMap "+(typeof this.textures[h.texture.map.SPECULAR]==="object"?1:0)+"\n#define hasNormalMap "+
(typeof this.textures[h.texture.map.NORMAL]==="object"?1:0)+"\n#define hasBumpMap "+(typeof this.textures[h.texture.map.BUMP]==="object"?1:0)+"\n#define hasReflectMap "+(typeof this.textures[h.texture.map.REFLECT]==="object"?1:0)+"\n#define hasEnvSphereMap "+(typeof this.textures[h.texture.map.ENVSPHERE]==="object"?1:0)+"\n#define hasAmbientMap "+(typeof this.textures[h.texture.map.AMBIENT]==="object"?1:0)+"\n#define hasAlphaMap "+(typeof this.textures[h.texture.map.ALPHA]==="object"?1:0)+"\n#define hasAlpha "+
(this.opacity!==1?1:0)+"\n#define lightPoint "+(d===h.light.type.POINT?1:0)+"\n#define lightDirectional "+(d===h.light.type.DIRECTIONAL?1:0)+"\n#define lightSpot "+(d===h.light.type.SPOT||d===h.light.type.SPOT_SHADOW?1:0)+"\n#define hasShadow "+(d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA?1:0)+"\n#define softShadow "+(l.soft_shadow?1:0)+"\n#define lightArea "+(d===h.light.type.AREA?1:0)+"\n#define depthPack "+(d===h.light.type.DEPTH_PACK?1:0)+"\n#define alphaDepth "+(l.depth_alpha?1:0)+"\n#define hasMorph "+
(this.morph?1:0)+"\n#define hasVertexColorMap "+(this.color_map?1:0)+"\n\n"},bindObject:function(d,h){var c=l.gl,a=h.aVertexPosition,b=h.aTextureCoord,e=h.aNormal,f=h.aColor;c.bindBuffer(c.ARRAY_BUFFER,d.compiled.gl_points);c.vertexAttribPointer(a,3,c.FLOAT,!1,0,0);c.enableVertexAttribArray(a);b!==null&&d.compiled.gl_uvs!==null&&b!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,d.compiled.gl_uvs),c.vertexAttribPointer(b,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(b));e!==null&&d.compiled.gl_normals!==null&&e!==
-1&&(c.bindBuffer(c.ARRAY_BUFFER,d.compiled.gl_normals),c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e));f!==null&&d.compiled.gl_colors!==null&&f!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,d.compiled.gl_colors),c.vertexAttribPointer(f,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(f));if(d.morphTarget)a=h.amVertexPosition,e=h.amNormal,c.bindBuffer(c.ARRAY_BUFFER,d.morphTarget.gl_points),c.vertexAttribPointer(a,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(a),e!==null&&d.morphTarget.gl_normals!==
null&&e!==-1&&(c.bindBuffer(c.ARRAY_BUFFER,d.morphTarget.gl_normals),c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e)),c.uniform1f(h.morphWeight,d.morphWeight);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,d.compiled.gl_elements)},clearObject:function(d,h){var c=l.gl,a=h.aTextureCoord,b=h.aNormal,e=h.aColor;a!==null&&d.compiled.gl_uvs!==null&&a!==-1&&c.disableVertexAttribArray(a);b!==null&&d.compiled.gl_normals!==null&&b!==-1&&c.disableVertexAttribArray(b);e!=null&&d.compiled.gl_colors!==
null&&e!==-1&&c.disableVertexAttribArray(e);if(d.morphTarget)up=h.amVertexPosition,c.disableVertexAttribArray(up),b=h.amNormal,b!=null&&d.compiled.gl_normals!==null&&b!==-1&&c.disableVertexAttribArray(b)},use:function(d,n){n===m&&(n=0);if(this.customShader!==null)this.customShader.use();else{d===m&&(d=0);var c,a=this.textures;this.shader[d]===m&&(this.shader[d]=[]);if(this.shader[d][n]===m){var b=this.calcShaderMask(d);u.ShaderPool[d][b]===m&&(u.ShaderPool[d][b]=[]);if(u.ShaderPool[d][b][n]===m){c=
this.getShaderHeader(d,n);var e=new CubicVR.Shader(c+l.CoreShader_vs,c+l.CoreShader_fs);u.ShaderPool[d][b][n]=e;c=0;if(d!==h.light.type.DEPTH_PACK){if(d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA)c+=n;typeof a[h.texture.map.COLOR]==="object"&&e.addInt("colorMap",c++);typeof a[h.texture.map.ENVSPHERE]==="object"&&e.addInt("envSphereMap",c++);typeof a[h.texture.map.NORMAL]==="object"&&e.addInt("normalMap",c++);typeof a[h.texture.map.BUMP]==="object"&&e.addInt("bumpMap",c++);typeof a[h.texture.map.REFLECT]===
"object"&&e.addInt("reflectMap",c++);typeof a[h.texture.map.SPECULAR]==="object"&&e.addInt("specularMap",c++);typeof a[h.texture.map.AMBIENT]==="object"&&e.addInt("ambientMap",c++)}typeof a[h.texture.map.ALPHA]==="object"&&e.addInt("alphaMap",c++);e.addMatrix("uMVMatrix");e.addMatrix("uPMatrix");e.addMatrix("uOMatrix");e.addMatrix("uNMatrix");e.addVertexArray("aVertexPosition");e.addVertexArray("aNormal");this.color_map&&e.addVertexArray("aColor");this.morph&&(e.addVertexArray("amVertexPosition"),
e.addVertexArray("amNormal"),e.addFloat("morphWeight",0));for(c=0;c<n;c++)if(e.addVector("lDiff["+c+"]"),e.addVector("lSpec["+c+"]"),e.addFloat("lInt["+c+"]"),e.addFloat("lDist["+c+"]"),e.addVector("lPos["+c+"]"),e.addVector("lDir["+c+"]"),(d===h.light.type.SPOT_SHADOW||d===h.light.type.SPOT)&&e.addFloat("lCut["+c+"]"),d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA)e.addInt("lDepthTex["+c+"]"),e.addVector("lDepth["+c+"]"),e.addMatrix("spMatrix["+c+"]");d!==h.light.type.DEPTH_PACK&&(e.addVector("lAmb"),
e.addVector("mDiff"),e.addVector("mColor"),e.addVector("mAmb"),e.addVector("mSpec"),e.addFloat("mShine"),e.addFloat("envAmount"));e.addFloat("mAlpha");(l.depth_alpha||d===h.light.type.DEPTH_PACK||d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA)&&e.addVector("depthInfo");e.addUVArray("aTextureCoord")}this.shader[d][n]=u.ShaderPool[d][b][n]}b=this.shader[d][n];e=l.gl;b.use();c=0;var f;if(d!==h.light.type.DEPTH_PACK){if(d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA)c+=n;if(f=a[h.texture.map.COLOR])f.use(l.gl.TEXTURE0+
c),c++;if(f=a[h.texture.map.ENVSPHERE])f.use(l.gl.TEXTURE0+c),c++,e.uniform1f(b.envAmount,this.env_amount);if(f=a[h.texture.map.NORMAL])f.use(l.gl.TEXTURE0+c),c++;if(f=a[h.texture.map.BUMP])f.use(l.gl.TEXTURE0+c),c++;if(f=a[h.texture.map.REFLECT])f.use(l.gl.TEXTURE0+c),c++;if(f=a[h.texture.map.SPECULAR])f.use(l.gl.TEXTURE0+c),c++;if(f=a[h.texture.map.AMBIENT])f.use(l.gl.TEXTURE0+c),c++}(f=a[h.texture.map.ALPHA])&&f.use(l.gl.TEXTURE0+c);d!==h.light.type.DEPTH_PACK?(e.uniform3fv(b.mColor,this.color),
e.uniform3fv(b.mDiff,this.diffuse),e.uniform3fv(b.mAmb,this.ambient),e.uniform3fv(b.mSpec,this.specular),e.uniform1f(b.mShine,this.shininess*128),e.uniform3fv(b.lAmb,CubicVR.globalAmbient),(l.depth_alpha||d===h.light.type.SPOT_SHADOW||d===h.light.type.AREA)&&e.uniform3fv(b.depthInfo,[l.depth_alpha_near,l.depth_alpha_far,0])):e.uniform3fv(b.depthInfo,[l.shadow_near,l.shadow_far,0]);this.opacity!==1&&e.uniform1f(b.mAlpha,this.opacity)}}};return{Material:s}});CubicVR.RegisterModule("Math",function(u){function s(a){return this.clearStack(a)}function m(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var l=u.undef,h=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],d=Math.PI/2,n={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*
a[1]+a[2]*a[2]);if(b===0)return[0,0,0];return[a[0]/b,a[1]/b,a[2]/b]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-
b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===l&&(e=1.0E-7);if(a===l&&b===l)return!0;if(a===l||b===l)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,f,g){var c=Math.sqrt(e*e+f*f),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(f,e)+d;if(typeof g==="object")return[g[0]+c*Math.cos(b),g[1],g[2]+c*Math.sin(b)];return[a[0]+c*Math.cos(b),a[1],a[2]+c*Math.sin(b)]},trackTarget:function(a,b,e,f){var b=n.subtract(b,a),g=n.length(b),c;
c=n.normalize(b);c=n.multiply(c,e*(1/(1/(g-f))));g>f?a=n.add(a,c):g<f?(c=n.normalize(b),c=n.multiply(c,e*(1/(1/Math.abs(g-f)))),a=n.subtract(a,c)):a=[a[0],a[1]+c[2],a[2]];return a},getClosestTo:function(a,b,e){b=n.subtract(b,a);e=n.subtract(e,a);return n.add(n.multiply(b,n.dot(b,e)/n.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,f){var g=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(f[0]-e[0])+a[1]*(f[1]-e[1])+a[2]*(f[2]-e[2]);if(Math.abs(b)<0.0010)return!1;a=-(g+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+
a*(f[0]-e[0]),e[1]+a*(f[1]-e[1]),e[2]+a*(f[2]-e[2])]}},c={lookat:function(a,b,e,f,g,c,d,t,h){var o=[],l=[],p=[],l=[];o[0]=f-a;o[1]=g-b;o[2]=c-e;p[0]=d;p[1]=t;p[2]=h;o=n.normalize(o);l=n.cross(o,p);l=n.normalize(l);p=n.cross(l,o);l=[l[0],p[0],-o[0],0,l[1],p[1],-o[1],0,l[2],p[2],-o[2],0,0,0,0,1];f=new CubicVR.Transform(l);f.translate([-a,-b,-e]);return f.getResult()},multiply:function(a,b,e){e===l&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=
a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*
b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===l&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===l&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+
b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,f){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(f+e)/(f-e),-1,0,0,-(2*f*e)/(f-e),0]},ortho:function(a,b,e,f,g,c){return[2/(b-a),0,0,0,0,2/(f-e),0,0,0,0,-2/(c-g),0,-(a+b)/(b-a),-(f+e)/(f-e),-(c+g)/(c-g),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*
a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],f=a[1],g=a[2],c=a[4],d=a[5],t=a[6],h=a[8],o=a[9],a=a[10],l=a*d-t*o,n=-a*c+t*h,m=o*c-d*h,w=e*l+f*n+g*m;if(!w)return null;w=1/w;b[0]=l*w;b[1]=(-a*f+g*o)*w;b[2]=(t*
f-g*d)*w;b[3]=n*w;b[4]=(a*e-g*h)*w;b[5]=(-t*e+g*c)*w;b[6]=m*w;b[7]=(-o*e+f*h)*w;b[8]=(d*e-f*c)*w;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],f=a[0]*a[6]-a[2]*a[4],g=a[0]*a[7]-a[3]*a[4],c=a[1]*a[6]-a[2]*a[5],d=a[1]*a[7]-a[3]*a[5],t=a[2]*a[7]-a[3]*a[6],h=a[8]*a[13]-a[9]*a[12],o=a[8]*a[14]-a[10]*a[12],n=a[8]*a[15]-a[11]*a[12],p=a[9]*a[14]-a[10]*a[13],m=a[9]*a[15]-a[11]*a[13],w=a[10]*a[15]-a[11]*a[14],s=e*w-f*m+g*p+c*n-d*o+t*h;if(s!=0)return b===l&&(b=[]),b[0]=0+a[5]*w-a[6]*m+a[7]*p,b[4]=
0-a[4]*w+a[6]*n-a[7]*o,b[8]=0+a[4]*m-a[5]*n+a[7]*h,b[12]=0-a[4]*p+a[5]*o-a[6]*h,b[1]=0-a[1]*w+a[2]*m-a[3]*p,b[5]=0+a[0]*w-a[2]*n+a[3]*o,b[9]=0-a[0]*m+a[1]*n-a[3]*h,b[13]=0+a[0]*p-a[1]*o+a[2]*h,b[2]=0+a[13]*t-a[14]*d+a[15]*c,b[6]=0-a[12]*t+a[14]*g-a[15]*f,b[10]=0+a[12]*d-a[13]*g+a[15]*e,b[14]=0-a[12]*c+a[13]*f-a[14]*e,b[3]=0-a[9]*t+a[10]*d-a[11]*c,b[7]=0+a[8]*t-a[10]*g+a[11]*f,b[11]=0-a[8]*d+a[9]*g-a[11]*e,b[15]=0+a[8]*c-a[9]*f+a[10]*e,e=1/s,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,
b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b;return null},identity:function(a){if(a==l)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,f){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(f===l)return a;c.multiply(f.slice(0),a,f)},rotateAxis:function(a,b,e,f,g){var d=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*e*
(1-a)-f*d,b*f*(1-a)+e*d,0,e*b*(1-a)+f*d,a+e*e*(1-a),e*f*(1-a)-b*d,0,f*b*(1-a)-e*d,f*e*(1-a)+b*d,a+f*f*(1-a),0,0,0,0,1];if(g===l)return b;c.multiply(g.slice(0),b,g)},rotate:function(a,b,e,f){var g;f===l&&(f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);e!==0&&(g=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),c.multiply(f.slice(0),[e,g,0,0,-g,e,0,0,0,0,1,0,0,0,0,1],f));b!==0&&(g=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),c.multiply(f.slice(0),[e,0,-g,0,0,1,0,0,g,0,e,0,0,0,0,1],f));a!==0&&(g=
Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),c.multiply(f.slice(0),[1,0,0,0,0,e,g,0,0,-g,e,0,0,0,0,1],f));return f},scale:function(a,b,e,f){if(f===l)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];c.multiply(f.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],f)}};s.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=
0;this.result=null;return this},getResult:function(){var a=CubicVR.mat4;if(!this.c_stack)return this.m_stack[0];var b=h;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:h;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=
[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==l?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var f=CubicVR.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var g=this.getIdentity();g[12]=a;g[13]=b;g[14]=e;this.m_stack[this.c_stack]=f.multiply(this.m_stack[this.c_stack],g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var f=CubicVR.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);
var g=this.getIdentity();g[0]=a;g[5]=b;g[10]=e;this.m_stack[this.c_stack]=f.multiply(this.m_stack[this.c_stack],g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,f){var g=CubicVR.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var c,d;if(b||e||f)c=Math.sin(-a*(Math.PI/180)),d=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=d*b,a[9]=c*b,a[6]=-c*b,a[10]=d*b,this.m_stack[this.c_stack]=g.multiply(a,
this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=d*e,b[8]=-c*e,b[2]=c*e,b[10]=d*e,this.m_stack[this.c_stack]=g.multiply(b,this.m_stack[this.c_stack]));f&&(e=this.getIdentity(),e[0]=d*f,e[4]=c*f,e[1]=-c*f,e[5]=d*f,this.m_stack[this.c_stack]=g.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};m.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());
this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromEuler:function(a,b,c){var f=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),g=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),d=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),q=f*g,t=b*c;this.w=q*d-t*a;this.x=q*a+t*d;this.y=b*g*d+f*c*a;this.z=f*c*d-b*g*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,c=this.y*this.y,f=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-c+f+a),180/Math.PI*Math.asin(-2*
(this.x*this.z-this.y*this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-c-f+a)]},multiply:function(a,b){b===l&&(b=a,a=this);return new m(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,c){c===l&&(c=1.0E-8);if(a===l&&b===l)return!0;if(a===l||b===l)return!1;return Math.abs(a[0]-b[0])<c&&Math.abs(a[1]-b[1])<c}},vec3:n,mat3:{transpose_inline:function(a){var b=a[1],c=a[2],
f=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=c;a[7]=f},vec3_multiply:function(a,b,c){c===l&&(c=[]);c[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];c[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];c[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return c}},mat4:c,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=
b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var c=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(c<0)return-1;else if(c>0)return 1;return 0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var c=CubicVR.vec3.subtract([a[0],
a[1],a[2]],[b[0],b[1],b[2]]),c=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),f=a[3]+b[3];if(c*c<f*f)return!0;return!1}},triangle:{normal:function(a,b,c,f){f===l&&(f=[]);var g=a[0]-b[0],d=a[1]-b[1],a=a[2]-b[2],q=b[0]-c[0],t=b[1]-c[1],b=b[2]-c[2];f[0]=d*b-a*t;f[1]=a*q-g*b;f[2]=g*t-d*q;return f}},Transform:s,Quaternion:m}});CubicVR.RegisterModule("Mesh",function(u){function s(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function m(d){this.points=[];this.faces=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.bb=this.originBuffer=this.compiled=null;this.name=d?d:null;this.materials=[];this.morphTarget=this.morphTargets=this.bb=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1}var l=u.undef,h=u.GLCore;
s.prototype={setUV:function(d,h){h!==l?this.uvs[h]=d:d.length!==2?this.uvs=d:this.uvs.push(d)},setColor:function(d,h){h!==l?this.point_colors[h]=d:typeof colors[0]!=="number"?this.point_colors=d:this.point_colors.push(d)},flip:function(){for(var d=0,h=this.point_normals.length;d<h;d++)this.point_normals[d]=[-this.point_normals[d][0],-this.point_normals[d][1],-this.point_normals[d][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],
-this.normal[2]]}};m.prototype={showAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&(this.segment_state[d]=!0)},hideAllSegments:function(){for(var d in this.segment_state)this.segment_state.hasOwnProperty(d)&&(this.segment_state[d]=!1)},setSegment:function(d,h){h!==l?this.segment_state[d]=h:this.currentSegment=d},addPoint:function(d){if(d.length!==3||typeof d[0]==="object")for(var h=0,c=d.length;h<c;h++)this.points.push(d[h]);else this.points.push(d);return this.points.length-
1},getMaterialIndex:function(d){return this.materials.indexOf(d)},setFaceMaterial:function(d,h){typeof d=="number"?mat_id=d:(mat_id=this.materials.indexOf(d),mat_id===-1&&(this.materials.push(d),mat_id=this.materials.length-1));if(h!==l){if(this.faces[h]!==l)this.faces[h].material=mat_id}else this.currentMaterial=mat_id;return this},addFace:function(d,h,c,a){if(typeof d[0]!=="number"){h=0;for(c=d.length;h<c;h++)this.addFace(d[h])}else{h===l?(this.currentFace=this.faces.length,this.faces.push(new s)):
(this.faces[h]===l&&(this.faces[h]=new s),this.currentFace=h);if(typeof d==="object")this.faces[this.currentFace].points=d;c!==l?this.setFaceMaterial(c,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=a!==l?a:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var d=0,h=this.faces.length;d<h;d++)this.faces[d].flip()},triangulateQuads:function(){for(var d=0,h=this.faces.length;d<h;d++)if(this.faces[d].points.length===
4){var c=this.faces.length;this.addFace([this.faces[d].points[2],this.faces[d].points[3],this.faces[d].points[0]],this.faces.length,this.faces[d].material,this.faces[d].segment);this.faces[d].points.pop();this.faces[c].normal=this.faces[d].normal;this.faces[d].uvs!==l&&this.faces[d].uvs.length===4&&(this.faces[c].setUV(this.faces[d].uvs[2],0),this.faces[c].setUV(this.faces[d].uvs[3],1),this.faces[c].setUV(this.faces[d].uvs[0],2),this.faces[d].uvs.pop());this.faces[d].point_normals.length===4&&(this.faces[c].point_normals[0]=
this.faces[d].point_normals[2],this.faces[c].point_normals[1]=this.faces[d].point_normals[3],this.faces[c].point_normals[2]=this.faces[d].point_normals[0],this.faces[d].point_normals.pop())}return this},booleanAdd:function(d,h){var c=CubicVR.mat4,a=this.points.length,b,e,f,g;if(h!==l){e=h.getResult();b=0;for(f=d.points.length;b<f;b++)this.addPoint(c.vec3_multiply(d.points[b],e))}else{b=0;for(f=d.points.length;b<f;b++)this.addPoint([d.points[b][0],d.points[b][1],d.points[b][2]])}c=[];b=0;for(f=d.materials.length;b<
f;b++)e=this.materials.indexOf(d.materials[b]),e===-1?(this.materials.push(d.materials[b]),c[b]=this.materials.length-1):c[b]=e;b=0;for(f=d.faces.length;b<f;b++){var r=[];e=0;for(g=d.faces[b].points.length;e<g;e++)r.push(d.faces[b].points[e]+a);r=this.faces[this.addFace(r)];r.segment=d.faces[b].segment;r.material=c[d.faces[b].material];e=0;for(g=d.faces[b].uvs.length;e<g;e++)r.uvs[e]=[d.faces[b].uvs[e][0],d.faces[b].uvs[e][1]];e=0;for(g=d.faces[b].point_normals.length;e<g;e++)r.point_normals[e]=[d.faces[b].point_normals[e][0],
d.faces[b].point_normals[e][1],d.faces[b].point_normals[e][2]]}return this},calcFaceNormals:function(){for(var d=CubicVR.vec3,h=CubicVR.triangle,c=0,a=this.faces.length;c<a;c++)this.faces[c].normal=this.faces[c].points.length<3?[0,0,0]:d.normalize(h.normal(this.points[this.faces[c].points[0]],this.points[this.faces[c].points[1]],this.points[this.faces[c].points[2]]));return this},getMaterial:function(d){for(var h=0,c=this.materials.length;h<c;h++)if(this.materials[h].name===d)return this.materials[h];
return null},calcNormals:function(d){var h=CubicVR.vec3,c=!1;d!==l&&(c=!0);this.calcFaceNormals();var a,b,e,f,g=Array(this.points.length);a=0;for(f=g.length;a<f;a++)g[a]=[];e=this.faces.length;for(a=0;a<e;a++){f=this.faces[a].points.length;for(b=0;b<f;b++)g[this.faces[a].points[b]].push([a,b])}a=0;for(f=this.points.length;a<f;a++){var r=g[a].length;for(b=0;b<r;b++){var q=1,t=g[a][b][0],m=g[a][b][1],o=this.materials.length?this.materials[this.faces[t].material].max_smooth:60,B=this.faces[t];c&&(d[t]===
l&&(d[t]=[]),d[t][m]===l&&(d[t][m]=[]));var p=Array(3);p[0]=B.normal[0];p[1]=B.normal[1];p[2]=B.normal[2];if(o!==0)for(e=0;e<r;e++)if(b!==e){var z=g[a][e][0],w=this.faces[z],s=h.angle(w.normal,B.normal);if(s!==s||s*(180/Math.PI)<=o)c&&d[t][m].push(z),p[0]+=w.normal[0],p[1]+=w.normal[1],p[2]+=w.normal[2],q++}p[0]/=q;p[1]/=q;p[2]/=q;this.faces[t].point_normals[m]=h.normalize(p)}}return this},recalcNormals:function(d){this.calcFaceNormals();for(var h=0,c=this.faces.length;h<c;h++)for(var a=this.faces[h],
b=0,e=a.points.length;b<e;b++){var f=d[h][b],g=a.point_normals[b];g[0]=a.normal[0];g[1]=a.normal[1];g[2]=a.normal[2];for(var r=f.length,q=0;q<r;q++){var t=this.faces[f[q]];g[0]+=t.normal[0];g[1]+=t.normal[1];g[2]+=t.normal[2]}r!=0&&(g[0]/=r+1,g[1]/=r+1,g[2]/=r+1,f=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),g[0]/=f,g[1]/=f,g[2]/=f)}return this},prepare:function(d){d===l&&(d=!0);this.triangulateQuads().compile();d&&this.clean();return this},clean:function(){var d,h;d=0;for(h=this.points.length;d<h;d++)delete this.points[d],
this.points[d]=null;this.points=[];d=0;for(h=this.faces.length;d<h;d++)delete this.faces[d].points,delete this.faces[d].point_normals,delete this.faces[d].uvs,delete this.faces[d].normal,delete this.faces[d],this.faces[d]=null;this.faces=[];return this},compileMap:function(d){var h=CubicVR.vec3,c=CubicVR.vec2;d===l&&(d=1.0E-5);var a={segments:[],bounds:[]},b=[],e,f,g,r,q,t,m,o;this.materials.length||this.materials.push(new CubicVR.Material);e=0;for(t=this.materials.length;e<t;e++)b[e]=[];e=0;for(t=
this.faces.length;e<t;e++)if(this.faces[e].points.length===3)g=this.faces[e].material,r=this.faces[e].segment,b[g][r]===l&&(b[g][r]=[],a.segments.push(r)),b[g][r].push(e);var B=[],p=0,z=!1,w=!1,s=!1,u;e=0;for(t=b.length;e<t;e++)for(f in b[e])if(b[e].hasOwnProperty(f))for(g=0;g<b[e][f].length;g++)u=b[e][f][g],z=z||this.faces[u].uvs.length!==0,w=w||this.faces[u].point_normals.length!==0,s=s||this.faces[u].point_colors.length!==0;if(z)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(f=
0;f<this.faces[e].points.length;f++)this.faces[e].uvs.push([0,0]);if(w)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(f=0;f<this.faces[e].points.length;f++)this.faces[e].point_normals.push([0,0,0]);if(s)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(f=0;f<this.faces[e].points.length;f++)this.faces[e].point_colors.push([0,0,0]);e=0;for(t=b.length;e<t;e++)for(f in b[e])if(b[e].hasOwnProperty(f)){g=0;for(m=b[e][f].length;g<m;g++){u=b[e][f][g];for(r=
0;r<3;r++){var v=this.faces[u].points[r],I=-1;if(B[v]!==l){q=0;for(o=B[v].length;q<o;q++){var y=B[v][q][0],A=B[v][q][1],I=B[v][q][2];w&&(I=h.equal(this.faces[y].point_normals[A],this.faces[u].point_normals[r],d)?I:-1);z&&(I=c.equal(this.faces[y].uvs[A],this.faces[u].uvs[r],d)?I:-1);s&&(I=h.equal(this.faces[y].point_colors[A],this.faces[u].point_colors[r],d)?I:-1)}}if(I!==-1){if(a.elements===l)a.elements=[];a.elements[e]===l&&(a.elements[e]=[]);a.elements[e][f]===l&&(a.elements[e][f]=[]);a.elements[e][f].push(I)}else{if(a.points===
l)a.points=[];a.points.push(v);a.bounds.length===0?(a.bounds[0]=[this.points[v][0],this.points[v][1],this.points[v][2]],a.bounds[1]=[this.points[v][0],this.points[v][1],this.points[v][2]]):(this.points[v][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[v][0]),this.points[v][1]<a.bounds[0][1]&&(a.bounds[0][1]=this.points[v][1]),this.points[v][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[v][2]),this.points[v][0]>a.bounds[1][0]&&(a.bounds[1][0]=this.points[v][0]),this.points[v][1]>a.bounds[1][1]&&(a.bounds[1][1]=
this.points[v][1]),this.points[v][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[v][2]));if(w){if(a.normals===l)a.normals=[];a.normals.push([u,r])}if(s){if(a.colors===l)a.colors=[];a.colors.push([u,r])}if(z){if(a.uvs===l)a.uvs=[];a.uvs.push([u,r])}if(a.elements===l)a.elements=[];a.elements[e]===l&&(a.elements[e]=[]);a.elements[e][f]===l&&(a.elements[e][f]=[]);a.elements[e][f].push(p);B[v]===l&&(B[v]=[]);B[v].push([u,r,p]);p++}}}}return a},compileVBO:function(d,h,c,a,b,e){typeof h=="object"?(h=h.element!==
l?h.element:!0,c=h.vertex!==l?h.vertex:!0,e=h.color!==l?h.color:!0,a=h.normal!==l?h.normal:!0,b=h.uv!==l?h.uv:!0):(h===l&&(h=!0),c===l&&(c=!0),e===l&&(e=!0),a===l&&(a=!0),b===l&&(b=!0));var f={};if(d.points&&c){var g=d.points.length;f.vbo_points=new Float32Array(g*3);for(var r=0,c=0;c<g;c++){var q=d.points[c];f.vbo_points[r++]=this.points[q][0];f.vbo_points[r++]=this.points[q][1];f.vbo_points[r++]=this.points[q][2]}}if(d.normals&&a){g=d.normals.length;f.vbo_normals=new Float32Array(g*3);for(c=r=0;c<
g;c++)q=d.normals[c],f.vbo_normals[r++]=this.faces[q[0]].point_normals[q[1]][0],f.vbo_normals[r++]=this.faces[q[0]].point_normals[q[1]][1],f.vbo_normals[r++]=this.faces[q[0]].point_normals[q[1]][2]}if(d.colors&&e){g=d.colors.length;f.vbo_colors=new Float32Array(g*3);for(c=r=0;c<g;c++)q=d.colors[c],f.vbo_colors[r++]=this.faces[q[0]].point_colors[q[1]][0],f.vbo_colors[r++]=this.faces[q[0]].point_colors[q[1]][1],f.vbo_colors[r++]=this.faces[q[0]].point_colors[q[1]][2]}if(d.uvs&&b){g=d.uvs.length;f.vbo_uvs=
new Float32Array(g*2);for(c=r=0;c<g;c++)q=d.uvs[c],f.vbo_uvs[r++]=this.faces[q[0]].uvs[q[1]][0],f.vbo_uvs[r++]=this.faces[q[0]].uvs[q[1]][1]}if(h){f.elements_ref=[];f.vbo_elements=[];c=0;for(g=d.elements.length;c<g;c++)for(j in f.elements_ref[c]=[],h=0,d.elements[c])if(d.elements[c].hasOwnProperty(j)){a=d.elements[c][j];k=0;for(kMax=a.length;k<kMax;k++)f.vbo_elements.push(a[k]);f.elements_ref[c][h]=[parseInt(j),parseInt(a.length)];h++}f.vbo_elements=new Uint16Array(f.vbo_elements)}f.segments=d.segments;
f.bounds=d.bounds;return f},bufferVBO:function(d,m){var c=h.gl,a={};m===l&&(m={});a.gl_points=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,a.gl_points);c.bufferData(c.ARRAY_BUFFER,d.vbo_points,c.STATIC_DRAW);d.vbo_normals?(a.gl_normals=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,a.gl_normals),c.bufferData(c.ARRAY_BUFFER,d.vbo_normals,c.STATIC_DRAW)):a.gl_normals=m.gl_normals?m.gl_normals:null;d.vbo_uvs?(a.gl_uvs=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,a.gl_uvs),c.bufferData(c.ARRAY_BUFFER,d.vbo_uvs,
c.STATIC_DRAW)):a.gl_uvs=m.gl_uvs?m.gl_uvs:null;d.vbo_colors?(a.gl_colors=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,a.gl_colors),c.bufferData(c.ARRAY_BUFFER,d.vbo_colors,c.STATIC_DRAW)):a.gl_colors=m.gl_colors?m.gl_colors:null;!d.vbo_elements&&m.gl_elements?(a.gl_elements=m.gl_elements,a.elements_ref=m.elements_ref):(a.gl_elements=c.createBuffer(),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,a.gl_elements),c.bufferData(c.ELEMENT_ARRAY_BUFFER,d.vbo_elements,c.STATIC_DRAW),a.elements_ref=d.elements_ref);
a.segments=d.segments;a.bounds=d.bounds;m.elements_ref&&!d.elements_ref&&c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return a},bindBuffer:function(d){if(this.originBuffer===null)this.originBuffer=d;this.compiled=d;this.segment_state=[];for(var h=0,c=d.segments.length;h<c;h++)this.segment_state[d.segments[h]]=!0;this.bb=d.bounds},compile:function(d){this.bindBuffer(this.bufferVBO(this.compileVBO(this.compileMap(d))));return this},addMorphTarget:function(d){if(this.morphTargets===null)this.morphTargets=
[];this.morphTargets.push(d)},setMorphSource:function(d){if(this.morphSourceIndex!==d)this.morphSourceIndex=d,this.bindBuffer(this.morphTargets[d])},setMorphTarget:function(d){if(this.morphTargetIndex!==d)this.morphTargetIndex=d,this.morphTarget=this.morphTargets[d]},setMorphWeight:function(d){this.morphWeight=d},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:0}};return{Mesh:m,Face:s}});CubicVR.RegisterModule("Motion",function(u){function s(){this.time=this.value=0;this.shape=d.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function m(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=a.in_behavior?a.in_behavior:d.envelope.behavior.CONSTANT,this.out_behavior=a.out_behavior?a.out_behavior:d.envelope.behavior.CONSTANT):this.out_behavior=this.in_behavior=d.envelope.behavior.CONSTANT}function l(a,b){this.env_init=
a;this.key_init=b;this.controllers=[];this.yzflip=!1}var h=u.undef,d=CubicVR.enums;d.motion={POS:0,ROT:1,SCL:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};d.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var n=function(a,b,c){var e=0,e=c-b;if(e===0)return[b,0];b=a-e*Math.floor((a-b)/e);e=-parseInt((b-a)/e+(b>a?0.5:-0.5),10);return[b,e]},c=function(a,b,c,e,d){var h,o;o=d*d;h=3*(b-a);b=3*(c-b)-h;return(e-
a-h-b)*o*d+b*o+h*d+a},a=function(b,g,e,d,h,l,o){var m,p;p=l+(o-l)*0.5;m=c(b,g,e,d,p);return Math.abs(h-m)>1.0E-4?(m>h?o=p:l=p,a(b,g,e,d,h,l,o)):p},b=function(a,b){var c,e,h,l;a.shape===d.envelope.shape.TCB?(c=(1-a.tension)*(1+a.continuity)*(1+a.bias),e=(1-a.tension)*(1-a.continuity)*(1-a.bias),h=b.value-a.value,a.prev?(l=(b.time-a.time)/(b.time-a.prev.time),c=l*(c*(a.value-a.prev.value)+e*h)):c=e*h):a.shape===d.envelope.shape.LINE?(h=b.value-a.value,a.prev?(l=(b.time-a.time)/(b.time-a.prev.time),
c=l*(a.value-a.prev.value+h)):c=h):a.shape===d.envelope.shape.BEZI||a.shape===d.envelope.shape.HERM?(c=a.param[1],a.prev&&(c*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===d.envelope.shape.BEZ2?(c=a.param[3]*(b.time-a.time),Math.abs(a.param[2])>1.0E-5?c/=a.param[2]:c*=1E5):c=0;return c},e=function(a,b){var c,e,h,l;b.shape===d.envelope.shape.LINE?(h=b.value-a.value,b.next?(l=(b.time-a.time)/(b.next.time-a.time),c=l*(b.next.value-b.value+h)):c=h):b.shape===d.envelope.shape.TCB?(c=(1-b.tension)*(1-
b.continuity)*(1+b.bias),e=(1-b.tension)*(1+b.continuity)*(1-b.bias),h=b.value-a.value,b.next?(l=(b.time-a.time)/(b.next.time-a.time),c=l*(e*(b.next.value-b.value)+c*h)):c*=h):b.shape===d.envelope.shape.HERM||b.shape===d.envelope.shape.BEZI?(c=b.param[0],b.next&&(c*=(b.time-a.time)/(b.next.time-a.time))):b.shape===d.envelope.shape.BEZ2?(c=b.param[1]*(b.time-a.time),Math.abs(b.param[0])>1.0E-5?c/=b.param[0]:c*=1E5):c=0;return c};m.prototype={setBehavior:function(a,b){this.in_behavior=a;this.out_behavior=
b},empty:function(){return this.nKeys===0},addKey:function(a,b,c){var e=typeof a=="object"?a:c;b||(b=0);a||(a=0);e?(e=a,a=e.time,c=this.insertKey(a),c.value=e.value?e.value:b,c.time=e.time?e.time:a,c.shape=e.shape?e.shape:d.envelope.shape.TCB,c.tension=e.tension?e.tension:0,c.continuity=e.continuity?e.continuity:0,c.bias=e.bias?e.bias:0,c.param=e.param?e.param:[0,0,0,0]):(c=this.insertKey(a),c.value=b);return c},insertKey:function(a){var b=new s;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=
this.keys=b,this.nKeys++,b;for(var c=this.keys;c;){if(this.firstKey.time>a)this.firstKey=b;else if(this.lastKey.time<a)this.lastKey=b;if(c.time>b.time){b.prev=c.prev;if(b.prev)b.prev.next=b;b.next=c;b.next.prev=b;this.nKeys++;return b}else if(!c.next)return b.prev=c,c.next=b,this.nKeys++,b;c=c.next}return null},evaluate:function(f){var g,r,h,t,l,o=0;if(this.nKeys===0)return 0;if(this.nKeys===1)return this.keys.value;r=this.firstKey;g=this.lastKey;if(f<r.time)if(t=this.in_behavior,t===d.envelope.behavior.RESET)return 0;
else if(t===d.envelope.behavior.CONSTANT)return r.value;else if(t===d.envelope.behavior.REPEAT)t=n(f,r.time,g.time),f=t[0];else if(t===d.envelope.behavior.OCILLATE)t=n(f,r.time,g.time),f=t[0],t=t[1],t%2&&(f=g.time-r.time-f);else if(t===d.envelope.behavior.OFFSET)t=n(f,r.time,g.time),f=t[0],t=t[1],o=t*(g.value-r.value);else{if(t===d.envelope.behavior.LINEAR)return l=b(r,r.next)/(r.next.time-r.time),l*(f-r.time)+r.value}else if(f>g.time)if(t=this.out_behavior,t===d.envelope.behavior.RESET)return 0;
else if(t===d.envelope.behavior.CONSTANT)return g.value;else if(t===d.envelope.behavior.REPEAT)t=n(f,r.time,g.time),f=t[0];else if(t===d.envelope.behavior.OCILLATE)t=n(f,r.time,g.time),f=t[0],t=t[1],t%2&&(f=g.time-r.time-f);else if(t===d.envelope.behavior.OFFSET)t=n(f,r.time,g.time),f=t[0],t=t[1],o=t*(g.value-r.value);else if(t===d.envelope.behavior.LINEAR)return t=e(g.prev,g)/(g.time-g.prev.time),t*(f-g.time)+g.value;if(this.lastKey0)if(f>this.lastKey0.time)g=this.lastKey0;else if(f<this.lastKey0.time)for(g=
this.lastKey;f<g.time&&g.prev;)g=g.prev;else g=this.keys;else g=this.keys;for(;f>g.next.time;)g=g.next;r=g.next;this.lastKey0=g;if(f===g.time)return g.value+o;else if(f===r.time)return r.value+o;h=(f-g.time)/(r.time-g.time);t=r.shape;if(t===d.envelope.shape.TCB||t===d.envelope.shape.BEZI||t===d.envelope.shape.HERM){l=b(g,r);t=e(g,r);var m,p;p=h*h;m=h*p;f=3*p-m-m;m-=p;f=[1-f,f,m-p+h,m];return f[0]*g.value+f[1]*r.value+f[2]*l+f[3]*t+o}else return t===d.envelope.shape.BEZ2?(f=a(g.time,g.shape===d.envelope.shape.BEZ2?
g.time+g.param[2]:g.time+(r.time-g.time)/3,r.time+r.param[0],r.time,f,0,1),o=c(g.value,g.shape===d.envelope.shape.BEZ2?g.value+g.param[3]:g.value+g.param[1]/3,r.param[1]+r.value,r.value,f)+o):o=t===d.envelope.shape.LINE?g.value+h*(r.value-g.value)+o:t===d.envelope.shape.STEP?g.value+o:o,o}};l.prototype={envelope:function(a,b){this.controllers[a]===h&&(this.controllers[a]=[]);this.controllers[a][b]===h&&(this.controllers[a][b]=new m(this.env_init));return this.controllers[a][b]},evaluate:function(a){var b=
[],c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){b[c]=[];for(var e in this.controllers[c])this.controllers[c].hasOwnProperty(e)&&(b[c][e]=this.controllers[c][e].evaluate(a))}return b},apply:function(a,b){for(var c in this.controllers)if(this.controllers.hasOwnProperty(c)){var e=parseInt(c,10);if(this.yzflip&&e===d.motion.ROT){if(!this.q)this.q=new CubicVR.Quaternion;var h=this.q,l=this.controllers[c][0].evaluate(a),o=this.controllers[c][1].evaluate(a),m=this.controllers[c][2].evaluate(a);
h.fromEuler(l,m,-o);h=h.toEuler();b.control(e,0,h[0]);b.control(e,1,h[1]);b.control(e,2,h[2])}else for(var p in this.controllers[c])this.controllers[c].hasOwnProperty(p)&&b.control(e,parseInt(p,10),this.controllers[c][p].evaluate(a))}},setKey:function(a,b,c,e,d){return this.envelope(a,b).addKey(c,e,d?d:this.key_init)},setArray:function(a,b,c,e){var d=[],h;for(h in c)if(c.hasOwnProperty(h)){var o=this.envelope(a,h);d[h]=o.addKey(b,c[h],e?e:this.key_init)}return d},setBehavior:function(a,b,c,e){this.envelope(a,
b).setBehavior(c,e)},setBehaviorArray:function(a,b,c){for(var e in this.controllers[a])this.controllers[a].hasOwnProperty(e)&&this.envelope(a,e).setBehavior(b,c)}};return{Motion:l,Envelope:m,EnvelopeKey:s}});CubicVR.RegisterModule("Octree",function(u){function s(a,b,c,f,g){var d=this._children=[];this._dirty=!1;d[0]=null;d[1]=null;d[2]=null;d[3]=null;d[4]=null;d[5]=null;d[6]=null;d[7]=null;this._child_index=g||-1;this._root=c||null;this._max_depth=b||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];c=CubicVR.aabb;c.reset(b,f);a/=2;c.engulf(b,[f[0]+
a,f[1]+a,f[2]+a]);c.engulf(b,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function m(){this.position=[0,0,0];this.visible=!1;this._object=null}function l(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var h=u.undef,d=CubicVR.plane,n=CubicVR.sphere,c=CubicVR.enums;c.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};c.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};Array_remove=function(a,b,c){c=
a.slice((c||b)+1||a.length);a.length=b<0?a.length+b:b;return a.push.apply(a,c)};s.prototype.destroy=function(){for(var a=0,b=this._static_lights.length;a<b;++a){var c=this._static_lights[a];c.octree_leaves=null;c.octree_common_root=null;c.octree_aabb=null}a=0;for(b=this._lights.length;a<b;++a)c=this._lights[a],c.octree_leaves=null,c.octree_common_root=null,c.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].destroy();
a=0;for(b=this._nodes.length;a<b;++a)c=this._nodes[a],c.octree_leaves=null,c.octree_common_root=null,c.octree_aabb=null,c.dynamic_lights=[],c.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};s.prototype.toString=function(){return"[Octree: @"+
this._position+", depth: "+this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};s.prototype.remove=function(a){var b=!1,c=this._nodes.length,f;f=c-1;for(c=this._nodes.length;f>=0;--f)if(a===this._nodes[f]){Array_remove(this._nodes,f);this.dirty_lineage();b=!0;break}if(!b)for(f=c-1;f>=0;--f)if(a===this._lights[f]){Array_remove(this._lights,f);this.dirty_lineage();break}};s.prototype.dirty_lineage=
function(){this._dirty=!0;this._root!==null&&this._root.dirty_lineage()};s.prototype.cleanup=function(){for(var a=this._children.length,b=0,c=0;c<a;++c){var f=this._children[c];if(f!==null){var g=!0;f._dirty===!0&&(g=f.cleanup());g?++b:this._children[c]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(b===0||a===0))return!1;return!0};s.prototype.insert_light=function(a){this.insert(a,!0)};s.prototype.propagate_static_light=function(a){var b,c;b=0;for(c=this._nodes.length;b<
c;++b)this._nodes[b].static_lights.indexOf(a)===-1&&this._nodes[b].static_lights.push(a);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].propagate_static_light(a)};s.prototype.collect_static_lights=function(a){for(var b=0,c=this._static_lights.length;b<c;++b)a.static_lights.indexOf(this._static_lights[b])===-1&&a.static_lights.push(this._static_lights[b]);for(b=0;b<8;++b)this._children[b]!==null&&this._children[b].collect_static_lights(a)};s.prototype.insert=function(a,b){function e(a,
b,g,f){var e;if(g)if(b.method===c.light.method.STATIC){a._static_lights.indexOf(b)===-1&&a._static_lights.push(b);for(g=0;g<a._nodes.length;++g)a._nodes[g].static_lights.indexOf(b)===-1&&a._nodes[g].static_lights.push(b);for(e=a._root;e!==null;){for(var g=0,d=e._nodes.length;g<d;++g){var r=e._nodes[g];r.static_lights.indexOf(b)===-1&&r.static_lights.push(b)}e=e._root}}else a._lights.indexOf(b)===-1&&a._lights.push(b);else{a._nodes.push(b);g=0;for(e=a._static_lights.length;g<e;++g)b.static_lights.indexOf(a._static_lights[g])===
-1&&b.static_lights.push(a._static_lights[g]);for(e=a._root;e!==null;){g=0;for(d=e._static_lights.length;g<d;++g)r=e._static_lights[g],b.static_lights.indexOf(r)===-1&&b.static_lights.push(r);e=e._root}}b.octree_leaves.push(a);b.octree_common_root=f;f=CubicVR.aabb;f.engulf(b.octree_aabb,a._bbox[0]);f.engulf(b.octree_aabb,a._bbox[1])}b===h&&(b=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)e(this,a,b,this._root);else{var f=this._position,g,d,q,t,l,o,m;
d=a.getAABB();m=[d[0][0],d[0][1],d[0][2]];var p=[d[1][0],d[1][1],d[1][2]];g=m[0]<f[0]&&m[1]<f[1]&&m[2]<f[2];d=p[0]>f[0]&&m[1]<f[1]&&m[2]<f[2];l=m[0]<f[0]&&p[1]>f[1]&&m[2]<f[2];o=p[0]>f[0]&&p[1]>f[1]&&m[2]<f[2];q=m[0]<f[0]&&m[1]<f[1]&&p[2]>f[2];t=p[0]>f[0]&&m[1]<f[1]&&p[2]>f[2];m=m[0]<f[0]&&p[1]>f[1]&&p[2]>f[2];f=p[0]>f[0]&&p[1]>f[1]&&p[2]>f[2];if(g&&d&&l&&o&&q&&t&&m&&f)e(this,a,b,this),b?a.method==c.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var p=0,
n=this._static_lights.length;p<n;++p){if(a.static_lights===h)a.static_lights=[];a.static_lights.indexOf(this._static_lights[p])===-1&&a.static_lights.push(this._static_lights[p])}var p=this._size/2,n=this._size/4,w=0,x=this._position[0],u=this._position[1],v=this._position[2];g&&(g=[x-n,u-n,v-n],this._children[c.octree.TOP_NW]===null&&(this._children[c.octree.TOP_NW]=new s(p,this._max_depth-1,this,g,c.octree.TOP_NW)),this._children[c.octree.TOP_NW].insert(a,b),++w);d&&(g=[x+n,u-n,v-n],this._children[c.octree.TOP_NE]===
null&&(this._children[c.octree.TOP_NE]=new s(p,this._max_depth-1,this,g,c.octree.TOP_NE)),this._children[c.octree.TOP_NE].insert(a,b),++w);l&&(g=[x-n,u+n,v-n],this._children[c.octree.BOTTOM_NW]===null&&(this._children[c.octree.BOTTOM_NW]=new s(p,this._max_depth-1,this,g,c.octree.BOTTOM_NW)),this._children[c.octree.BOTTOM_NW].insert(a,b),++w);o&&(g=[x+n,u+n,v-n],this._children[c.octree.BOTTOM_NE]===null&&(this._children[c.octree.BOTTOM_NE]=new s(p,this._max_depth-1,this,g,c.octree.BOTTOM_NE)),this._children[c.octree.BOTTOM_NE].insert(a,
b),++w);q&&(g=[x-n,u-n,v+n],this._children[c.octree.TOP_SW]===null&&(this._children[c.octree.TOP_SW]=new s(p,this._max_depth-1,this,g,c.octree.TOP_SW)),this._children[c.octree.TOP_SW].insert(a,b),++w);t&&(g=[x+n,u-n,v+n],this._children[c.octree.TOP_SE]===null&&(this._children[c.octree.TOP_SE]=new s(p,this._max_depth-1,this,g,c.octree.TOP_SE)),this._children[c.octree.TOP_SE].insert(a,b),++w);m&&(g=[x-n,u+n,v+n],this._children[c.octree.BOTTOM_SW]===null&&(this._children[c.octree.BOTTOM_SW]=new s(p,
this._max_depth-1,this,g,c.octree.BOTTOM_SW)),this._children[c.octree.BOTTOM_SW].insert(a,b),++w);f&&(g=[x+n,u+n,v+n],this._children[c.octree.BOTTOM_SE]===null&&(this._children[c.octree.BOTTOM_SE]=new s(p,this._max_depth-1,this,g,c.octree.BOTTOM_SE)),this._children[c.octree.BOTTOM_SE].insert(a,b),++w);if(w>1||a.octree_common_root===null)a.octree_common_root=this}}};s.prototype.draw_on_map=function(a,b,c){function f(a,c,f,e,h){var q=a<f?a:f,t=c<e?c:e,a=a<f?f-a:a-f,c=c<e?e-c:c-e;b.save();if(h!==void 0)b.fillStyle=
h,b.fillRect(g+q,d+t,a,c);b.strokeRect(g+q,d+t,a,c);b.restore()}var g=a.width/2,d=a.height/2,q,t,l,o,m,p;if(c===h||c==="map")b.save(),this._debug_visible!==!1?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),m=this._size/2,q=this._position[0],t=this._position[2],b.moveTo(g+q-m,g+t-m),b.lineTo(g+q-m,g+t+m),b.lineTo(g+q+m,g+t+m),b.lineTo(g+q+m,g+t-m),b.stroke(),b.fill(),b.restore();if(c===h||c==="objects"){b.save();m=0;for(p=
this._nodes.length;m<p;++m){var n=this._nodes[m];b.fillStyle="#5500FF";b.strokeStyle=n.visible===!0&&n.culled===!1?"#FFFFFF":"#000000";b.beginPath();q=n.aabb[0][0];t=n.aabb[0][2];l=n.aabb[1][0]-q;o=n.aabb[1][2]-t;b.rect(g+q,d+t,l,o);b.stroke()}b.restore()}if(c===h||c==="lights"){m=0;for(p=this._lights.length;m<p;++m)o=this._lights[m],b.fillStyle=o.culled===!1&&o.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),n=o.distance,q=o.position[0],t=
o.position[2],b.arc(g+q,d+t,n,0,Math.PI*2,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),q=o.aabb[0][0],t=o.aabb[0][2],l=o.aabb[1][0]-q,o=o.aabb[1][2]-t,b.rect(g+q,d+t,l,o),b.closePath(),b.stroke();m=0;for(p=this._static_lights.length;m<p;++m)o=this._static_lights[m],b.fillStyle=o.culled===!1&&o.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),n=o.distance,q=o.position[0],t=o.position[2],b.arc(g+q,d+t,n,0,Math.PI*2,!0),b.closePath(),b.stroke(),
b.fill(),b.beginPath(),q=o.aabb[0][0],t=o.aabb[0][2],l=o.aabb[1][0]-q,o=o.aabb[1][2]-t,b.rect(g+q,d+t,l,o),b.closePath(),b.stroke()}if(c!="lights"&&c!="objects"&&c!="map"){b.save();q=this._nodes;m=0;for(o=q.length;m<o;++m)if(n=q[m],n.name==c){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();q=n.aabb[0][0];t=n.aabb[0][2];l=n.aabb[1][0]-q;o=n.aabb[1][2]-t;b.rect(g+q,d+t,l,o);b.closePath();b.stroke();q=n.octree_aabb;b.strokeStyle="#0000FF";f(q[0][0],q[0][2],q[1][0],q[1][2]);b.lineWidth=1;if(n.common_root!==
null)b.strokeStyle="#00FF00";break}b.lineWidth=1;b.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}m=0;for(p=this._children.length;m<p;++m)this._children[m]!==null&&this._children[m].draw_on_map(a,b,c)};s.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-
this._size/2&&a[2]>=this._position[2]-this._size/2};s.prototype.get_frustum_hits=function(a,b){var c={objects:[],lights:[]};if((b===h||b===!0)&&!this.contains_point(a.position)){if(n.intersects(a.frustum.sphere,this._sphere)===!1)return c;var f=a.frustum.contains_sphere(this._sphere);if(f===-1)return this._debug_visible=!1,c;else if(f===1)this._debug_visible=2,b=!1;else if(f===0)if(this._debug_visible=!0,f=a.frustum.contains_box(this._bbox),f===-1)return this._debug_visible=!1,c;else if(f===1)this._debug_visible=
3,b=!1}var g,f=0;for(g=this._nodes.length;f<g;++f){var d=this._nodes[f];c.objects.push(d);d.dynamic_lights=[].concat(this._lights);d.was_culled=d.culled;d.culled=!1;d.drawn_this_frame=!1}this._debug_visible=this._lights.length>0?4:this._debug_visible;f=0;for(g=this._lights.length;f<g;++f)if(d=this._lights[f],d.visible===!0)c.lights.push(d),d.was_culled=d.culled,d.culled=!1;f=0;for(g=this._static_lights.length;f<g;++f)if(d=this._static_lights[f],d.visible===!0)d.culled=!1;for(f=0;f<8;++f)if(this._children[f]!==
null){g=this._children[f].get_frustum_hits(a,b);var q,d=0;for(q=g.objects.length;d<q;++d){c.objects.push(g.objects[d]);for(var t=g.objects[d].dynamic_lights,l=0,o=this._lights.length;l<o;++l)t.indexOf(this._lights[l])<0&&t.push(this._lights[l])}d=0;for(q=g.lights.length;d<q;++d)c.lights.indexOf(g.lights[d])<0&&c.lights.push(g.lights[d])}return c};s.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=!0;a=0;for(b=this._lights.length;a<
b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};m.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};m.prototype.attach=function(a){this._object=a};l.prototype.extract=function(a,b,e){var f=CubicVR.vec3;if(!(b===h||e===h)){var g=CubicVR.mat4.multiply(e,b),b=this._planes;b[c.frustum.plane.LEFT][0]=g[3]+g[0];b[c.frustum.plane.LEFT][1]=
g[7]+g[4];b[c.frustum.plane.LEFT][2]=g[11]+g[8];b[c.frustum.plane.LEFT][3]=g[15]+g[12];b[c.frustum.plane.RIGHT][0]=g[3]-g[0];b[c.frustum.plane.RIGHT][1]=g[7]-g[4];b[c.frustum.plane.RIGHT][2]=g[11]-g[8];b[c.frustum.plane.RIGHT][3]=g[15]-g[12];b[c.frustum.plane.TOP][0]=g[3]-g[1];b[c.frustum.plane.TOP][1]=g[7]-g[5];b[c.frustum.plane.TOP][2]=g[11]-g[9];b[c.frustum.plane.TOP][3]=g[15]-g[13];b[c.frustum.plane.BOTTOM][0]=g[3]+g[1];b[c.frustum.plane.BOTTOM][1]=g[7]+g[5];b[c.frustum.plane.BOTTOM][2]=g[11]+
g[9];b[c.frustum.plane.BOTTOM][3]=g[15]+g[13];b[c.frustum.plane.NEAR][0]=g[3]+g[2];b[c.frustum.plane.NEAR][1]=g[7]+g[6];b[c.frustum.plane.NEAR][2]=g[11]+g[10];b[c.frustum.plane.NEAR][3]=g[15]+g[14];b[c.frustum.plane.FAR][0]=g[3]-g[2];b[c.frustum.plane.FAR][1]=g[7]-g[6];b[c.frustum.plane.FAR][2]=g[11]-g[10];b[c.frustum.plane.FAR][3]=g[15]-g[14];for(var r=0;r<6;++r)d.normalize(b[r]);r=-b[c.frustum.plane.NEAR][3];b=b[c.frustum.plane.FAR][3]-r;e=b*(1/e[5]);e=f.subtract([0,0,r+b*0.5],[e,e,r+b]);e=f.length(e);
g=[g[3],g[9],g[10]];r=f.length(g);g=f.multiply(g,1/r);a=[a.position[0],a.position[1],a.position[2]];a=f.add(a,f.multiply(g,b*0.5));a=f.add(a,f.multiply(g,1));this.sphere=[a[0],a[1],a[2],e]}};l.prototype.contains_sphere=function(a){for(var b=CubicVR.vec3,c=this._planes,f=0;f<6;++f){var g=c[f],g=b.dot([g[0],g[1],g[2]],[a[0],a[1],a[2]])+g.d;this.last_in[f]=1;if(g<-a[3])return-1;if(Math.abs(g)<a[3])return 0}return 1};l.prototype.draw_on_map=function(a,b){var c=a.width/2,f=a.height/2;b.save();for(var g=
this._planes,d=[0,1,4,5],h=0,t=d.length;h<t;++h){var l=g[d[h]];b.strokeStyle="#FF00FF";if(h<this.last_in.length&&this.last_in[h])b.strokeStyle="#FFFF00";var o=-c,m=c,p=(-l[3]-l[0]*m)/l[2];b.moveTo(c+o,f+(-l[3]-l[0]*o)/l[2]);b.lineTo(c+m,f+p);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(c+this.sphere[0],f+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);b.closePath();b.stroke();b.restore()};l.prototype.contains_box=function(a){var b=0,c=[];c[0]=a[0];c[1]=[a[0][0],a[0][1],a[1][2]];c[2]=[a[0][0],
a[1][1],a[0][2]];c[3]=[a[0][0],a[1][1],a[1][2]];c[4]=[a[1][0],a[0][1],a[0][2]];c[5]=[a[1][0],a[0][1],a[1][2]];c[6]=[a[1][0],a[1][1],a[0][2]];c[7]=a[1];for(var a=this._planes,f=0;f<6;++f){for(var g=8,h=1,q=0;q<8;++q)d.classifyPoint(a[f],c[q])===-1&&(h=0,--g);this.last_in[f]=h;if(g===0)return-1;b+=h}if(b===6)return 1;return 0};return{Frustum:l,Octree:s}});CubicVR.RegisterModule("Particles",function(u){function s(h,d,l,c,a,b,e){if(h){this.last_particle=this.particles=null;this.pTex=l!==m?l:null;this.vWidth=c;this.vHeight=a;this.alpha=b!==m?b:!1;this.alphaCut=e!==m?e:0;this.pfunc=function(a,b){var c=b-a.start_time;if(c<0)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];this.pgov!==null&&this.pgov(a,
b);return 1};this.pgov=null;this.hasColor=d===m?!1:d;l=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",l?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",l?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",l?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",l?"uniform sampler2D pMap;":"","varying vec4 color;",l?"varying vec2 screenPos;":"",l?"uniform vec3 screenDim;":"",l?"varying float pSize;":"","void main(void) {\nvec4 c = color;",l?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",l?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",l?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=h;this.numParticles=0;this.arPoints=new Float32Array(h*3);this.glPoints=null;if(d)this.arColor=new Float32Array(h*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[c,a,0]));this.genBuffer()}}var m=u.undef,l=u.GLCore;s.prototype={resizeView:function(h,d){this.vWidth=h;this.vHeight=d;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[h,d,0]))},addParticle:function(h){this.last_particle===null?this.particles=h:this.last_particle.nextParticle=h;this.last_particle=h},genBuffer:function(){var h=l.gl;this.glPoints=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW);if(this.hasColor)this.glColor=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW)},updatePoints:function(){var h=l.gl;h.bindBuffer(h.ARRAY_BUFFER,
this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW)},updateColors:function(){var h=l.gl;this.hasColor&&(h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW))},draw:function(h,d,n){var c=l.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(c.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",h);this.shader_particle.setMatrix("uPMatrix",d);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);c.bindBuffer(c.ARRAY_BUFFER,this.glPoints);
c.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,c.FLOAT,!1,0,0);c.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(c.bindBuffer(c.ARRAY_BUFFER,this.glColor),c.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(this.shader_particle.uniforms.aColor));n===m&&(n=0);if(this.particles===null)c.disable(c.BLEND);else{for(var h=this.particles,d=null,a=this.numParticles=0;h!==null;){var b=this.numParticles*
3,e=this.pfunc(h,n);if(e===1){if(this.arPoints[b]=h.pos[0],this.arPoints[b+1]=h.pos[1],this.arPoints[b+2]=h.pos[2],h.color!==null&&this.arColor!==m&&(this.arColor[b]=h.color[0],this.arColor[b+1]=h.color[1],this.arColor[b+2]=h.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(e===-1){if(d!==null)d.nextParticle=h.nextParticle}else e===0&&a++;d=h;h=h.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors();this.alpha&&
(c.enable(c.BLEND),c.enable(c.DEPTH_TEST),c.depthMask(0),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_COLOR));c.drawArrays(c.POINTS,0,this.numParticles);this.alpha&&(c.disable(c.BLEND),c.depthMask(1),c.blendFunc(c.ONE,c.ONE));this.hasColor&&c.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}}};return{ParticleSystem:s,Particle:function(h,d,l,c,a){this.startpos=new Float32Array(h);this.pos=new Float32Array(h);this.velocity=new Float32Array(c!==m?c:[0,0,0]);this.accel=new Float32Array(a!==m?a:[0,
0,0]);this.start_time=d!==m?d:0;this.life_time=l!==m?l:0;this.nextParticle=this.color=null}}});CubicVR.RegisterModule("PostProcess",function(u){function s(a){if(a.shader_vertex===h)return null;if(a.shader_fragment===h)return null;this.outputMode=a.outputMode===h?n.post.output.REPLACE:a.outputMode;this.onresize=a.onresize===h?null:a.onresize;this.onupdate=a.onupdate===h?null:a.onupdate;this.init=a.init===h?null:a.init;this.enabled=a.enabled===h?!0:a.enabled;this.outputDivisor=a.outputDivisor===h?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,a.shader_fragment);this.shader.use();
this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function m(a,c,f){var g=d.gl;this.width=a;this.height=c;this.accum=f===h?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,c,!0);this.bufferA=new CubicVR.RenderBuffer(a,c,!1);this.bufferB=new CubicVR.RenderBuffer(a,c,!1);this.bufferC=new CubicVR.RenderBuffer(a,
c,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,c,!1),this.accumBuffer.use(),g.clearColor(0,0,0,1),g.clear(g.COLOR_BUFFER_BIT),this.blur_shader=new s({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.bufferB.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new s({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,c)}function l(a,c,f){this.createBuffer(a,c,f)}var h=u.undef,d=u.GLCore,n=CubicVR.enums;n.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var c=[],a=[];m.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,c){var f=d.gl,g=[],h=a/a,q=c/c;g.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);g.vbo_uvs=new Float32Array([0,0,h,0,h,q,0,q,0,0,h,q]);g.gl_points=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,
g.gl_points);f.bufferData(f.ARRAY_BUFFER,g.vbo_points,f.STATIC_DRAW);g.gl_uvs=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,g.gl_uvs);f.bufferData(f.ARRAY_BUFFER,g.vbo_uvs,f.STATIC_DRAW);return g},destroyFSQuad:function(a){var c=d.gl;c.deleteBuffer(a.gl_points);c.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,c){var f=d.gl;a.use();f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.bindBuffer(f.ARRAY_BUFFER,c.gl_points);f.vertexAttribPointer(a.aVertex,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(a.aVertex);
f.bindBuffer(f.ARRAY_BUFFER,c.gl_uvs);f.vertexAttribPointer(a.aTex,2,f.FLOAT,!1,0,0);f.enableVertexAttribArray(a.aTex);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.drawArrays(f.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1){if(c[b.outputDivisor]===h)var e=parseInt(this.width/b.outputDivisor);var f=parseInt(this.height/b.outputDivisor);c[b.outputDivisor]=new CubicVR.RenderBuffer(e,
f,!1);a[b.outputDivisor]=this.makeFSQuad(e,f)}},resize:function(b,e){var f=d.gl;this.width=b;this.height=e;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&
(this.accumBuffer.destroyBuffer(),this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT));for(var g in c){var f=parseInt(this.width/g),h=parseInt(this.height/g);c[g].destroyBuffer();c[g].createBuffer(f,h,!1);this.destroyFSQuad(a[g]);a[g]=this.makeFSQuad(f,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;g=0;for(f=this.shaders.length;g<f;g++)if(this.shaders[g].shader.use(),this.shaders[g].shader.setVector("texel",
this.vTexel),this.shaders[g].onresize!==null)this.shaders[g].onresize(this.shaders[g].shader,this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(){this.captureBuffer.use()},end:function(){var a=d.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=d.gl;this.captureBuffer.texture.use(b.TEXTURE1);this.outputBuffer.use();
this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,f=0,g=this.shaders.length;f<g;f++){var h=this.shaders[f];if(h.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var q=h.outputMode;if(q===n.post.output.REPLACE)h.outputDivisor!==1?c[h.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(q===n.post.output.ADD||q===n.post.output.BLEND)h.outputDivisor!==
1?c[h.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);h.onupdate!==null&&(h.shader.use(),h.onupdate(h.shader));h.outputDivisor!==1?(b.viewport(0,0,c[h.outputDivisor].width,c[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===n.post.output.REPLACE?(this.outputBuffer.use(),c[h.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,this.fsQuad)):b.viewport(0,
0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);q===n.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),h.outputDivisor!==1?c[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):q===n.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE),
h.outputDivisor!==1?c[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}e===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.renderFSQuad(this.blur_shader.shader,
this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};l.prototype={createBuffer:function(a,c,f){this.texture=this.depth=this.fbo=
null;this.width=parseInt(a,10);this.height=parseInt(c,10);var a=this.sizeParam(a),c=this.sizeParam(c),g=d.gl;this.fbo=g.createFramebuffer();if(f)this.depth=g.createRenderbuffer();g.bindFramebuffer(g.FRAMEBUFFER,this.fbo);f&&(g.bindRenderbuffer(g.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_COMPONENT16,a,c),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,this.depth)):(g.renderbufferStorage(g.RENDERBUFFER,
g.DEPTH_STENCIL,a,c),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_STENCIL_ATTACHMENT,g.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;g.bindTexture(g.TEXTURE_2D,u.Textures[this.texture.tex_id]);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,a,c,0,g.RGBA,
g.UNSIGNED_BYTE,null);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,u.Textures[this.texture.tex_id],0);g.bindFramebuffer(g.FRAMEBUFFER,null)},destroyBuffer:function(){var a=d.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(u.Textures[this.texture.tex_id]);u.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=d.gl;a.bindFramebuffer(a.FRAMEBUFFER,this.fbo)}};return{RenderBuffer:l,
PostProcessShader:s,PostProcessChain:m,fsQuad:{make:m.prototype.makeFSQuad,destroy:m.prototype.destroyFSQuad,render:m.prototype.renderFSQuad}}});CubicVR.RegisterModule("Primitives",function(u){function s(c,g,d,e,h,l){var o=CubicVR.mat4,m=CubicVR.vec3,p=[],n,s=[0,1,0],x=[1,0,0],u=[0,0,0],v=c.points.length,I,y,A;for(I=n=0;I<b;I+=b/d){if(n===d)break;x=[Math.cos(I),0,Math.sin(I)];y=0;for(A=g.length;y<A;y++)u=m.add(m.multiply(x,g[y][0]),m.multiply(s,g[y][1])),p[n]===a&&(p[n]=[]),p[n].push(u);n++}A=null;h!==a&&(A=h.getResult!==a?h.getResult():h);for(y=0;y<d;y++){h=0;for(n=g.length;h<n;h++)A?c.addPoint(o.vec3_multiply(p[y][h],A)):c.addPoint(p[y][h])}c.setFaceMaterial(e);
for(h=0;h<d;h++){y=0;for(A=g.length-1;y<A;y++)o=y+g.length*h,p=y+g.length*((h+1)%d),m.equal(c.points[v+o],c.points[v+p])?c.addFace([v+o+1,v+p+1,v+p]):m.equal(c.points[v+o+1],c.points[v+p+1])?c.addFace([v+o,v+o+1,v+p]):c.addFace([v+o,v+o+1,v+p+1,v+p])}l!==a&&(g=null,l.apply!==a?g=l:l&&(g=new CubicVR.UVMapper(l)),g!==null&&(c.calcNormals(),g.apply(c,e)))}function m(b,c,d,e,h){var l=CubicVR.mat4;c*=0.5;var o=b.points.length;b.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([l.vec3_multiply([c,
-c,0],e),l.vec3_multiply([c,c,0],e),l.vec3_multiply([-c,c,0],e),l.vec3_multiply([-c,-c,0],e)])):b.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);b.addFace([[o+0,o+1,o+2,o+3],[o+3,o+2,o+1,o+0]]);h!==a&&(l=null,h.apply!==a?l=h:h&&(l=new CubicVR.UVMapper(h)),l!==null&&(b.calcNormals(),l.apply(b,d)))}function l(b,c,d,e,h){var l=CubicVR.mat4;c/=2;var o=b.points.length;b.setFaceMaterial(d);e!==a?(e=e.getResult!==a?e.getResult():e,b.addPoint([l.vec3_multiply([c,-c,c],e),l.vec3_multiply([c,c,c],e),l.vec3_multiply([-c,
c,c],e),l.vec3_multiply([-c,-c,c],e),l.vec3_multiply([c,-c,-c],e),l.vec3_multiply([c,c,-c],e),l.vec3_multiply([-c,c,-c],e),l.vec3_multiply([-c,-c,-c],e)])):b.addPoint([[c,-c,c],[c,c,c],[-c,c,c],[-c,-c,c],[c,-c,-c],[c,c,-c],[-c,c,-c],[-c,-c,-c]]);b.addFace([[o+0,o+1,o+2,o+3],[o+7,o+6,o+5,o+4],[o+4,o+5,o+1,o+0],[o+5,o+6,o+2,o+1],[o+6,o+7,o+3,o+2],[o+7,o+4,o+0,o+3]]);h!==a&&(l=null,h.apply!==a?l=h:h&&(l=new CubicVR.UVMapper(h)),l!==null&&(b.calcNormals(),l.apply(b,d)))}function h(a,c,e,d,h,l,o,m){var p=
[];e-=c;c+=e/2;for(var n=b/h,s=0,x=0;x<=h;x++)p.push([c+Math.cos(s)*e,Math.sin(s)*e,0]),s+=n;CubicVR.genLatheObject(a,p,d,l,o,m)}function d(a,b,c,e,d,h,l){CubicVR.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],e,d,h,l)}function n(a,b,c,e,d,h,l){CubicVR.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],e,d,h,l)}function c(a,b,c,d,h,l,o){for(var m=[],d=parseInt(d/=2),c=parseInt(c),p=Math.PI/d,n=-e,s=0;s<=d;s++)m.push([Math.cos(n)*b,Math.sin(n)*b,0]),n+=p;CubicVR.genLatheObject(a,m,
c,h,l,o)}var a=u.undef,b=2*Math.PI,e=Math.PI/2;return{genPlaneObject:m,genBoxObject:l,genLatheObject:s,genTorusObject:h,genConeObject:d,genCylinderObject:n,genSphereObject:c,primitives:{lathe:function(b){var c,e;if(b.points==a)return null;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;s(c,b.points,b.divisions!==a?b.divisions:24,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},box:function(b){var c,e;c=b.mesh!==a?b.mesh:
new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;l(c,b.size!==a?b.size:1,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},plane:function(b){var c,e;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;m(c,b.size!==a?b.size:1,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},sphere:function(b){var g,e;g=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==
a?b.material:new CubicVR.Material;c(g,b.radius!==a?b.radius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return g},torus:function(b){var c,e;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;h(c,b.innerRadius!==a?b.innerRadius:0.75,b.outerRadius!==a?b.outerRadius:1,b.lon!==a?b.lon:24,b.lat!==a?b.lat:24,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},cone:function(b){var c,
e;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;d(c,b.base!==a?b.base:1,b.height!==a?b.height:1,b.lon!==a?b.lon:24,e,b.transform!==a?b.transform:a,b.uvmapper!==a?b.uvmapper:a);return c},cylinder:function(b){var c,e,d,h,l,o;c=b.mesh!==a?b.mesh:new CubicVR.Mesh(b.name!==a?b.name:a);e=b.material!==a?b.material:new CubicVR.Material;d=b.transform!==a?b.transform:a;h=b.uvmapper!==a?b.uvmapper:a;l=b.radius!==a?b.radius:1;o=b.height!==a?b.height:
1;lon=b.lon!==a?b.lon:24;n(c,l,o,lon,e,d,h);return c}}}});CubicVR.RegisterModule("Renderer",function(u){var s=u.undef;return{renderObject:function(m,l,h,d){if(m.compiled!==null){var n=0,c=CubicVR.GLCore.gl,a=d===s?0:d.length,b,e=0,f,g=null,r=!1;c.depthFunc(c.LEQUAL);h===s&&(h=cubicvr_identity);for(var q=0,t=m.compiled.elements_ref.length;q<t;q++){var g=m.materials[q],E=0,e=!1;g.opacity!==1?(c.enable(c.BLEND),c.depthMask(0),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA)):(c.depthMask(1),c.disable(c.BLEND),c.blendFunc(c.ONE,c.ONE));for(var o=0,B=m.compiled.elements_ref[q].length;o<
B;o++){f=m.compiled.elements_ref[q][o][0];var e=!1,p=m.compiled.elements_ref[q][o][1];E+=p;if(!m.segment_state[f])if(E>p){n+=p*2;E-=p;if(a){for(var p=0,z=!1,p=0;p<a;){nLights=a-p;if(nLights>u.MAX_LIGHTS)nLights=u.MAX_LIGHTS;p>0&&!z&&(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.depthFunc(c.EQUAL),z=!0);b=d[p];for(var w=b.light_type,e=0;e<nLights;e++)if(d[e+p].light_type!=w){nLights=e;break}g.use(b.light_type,nLights);b=g.shader[b.light_type][nLights];c.uniformMatrix4fv(b.uMVMatrix,!1,l.mvMatrix);
c.uniformMatrix4fv(b.uPMatrix,!1,l.pMatrix);c.uniformMatrix4fv(b.uOMatrix,!1,h);c.uniformMatrix3fv(b.uNMatrix,!1,l.nMatrix);r||(g.bindObject(m,b),r=!0);for(e=0;e<nLights;e++)d[e+p].setupShader(b,e);c.drawElements(c.TRIANGLES,E,c.UNSIGNED_SHORT,n);p+=nLights}z&&(c.disable(c.BLEND),c.depthFunc(c.LEQUAL))}else g.use(0,0),c.uniformMatrix4fv(g.shader[0][0].uMVMatrix,!1,l.mvMatrix),c.uniformMatrix4fv(g.shader[0][0].uPMatrix,!1,l.pMatrix),c.uniformMatrix4fv(g.shader[0][0].uOMatrix,!1,h),c.uniformMatrix3fv(g.shader[0][0].uNMatrix,
!1,l.nMatrix),r||(g.bindObject(m,g.shader[0][0]),r=!0),c.drawElements(c.TRIANGLES,E,c.UNSIGNED_SHORT,n);n+=E*2;E=0;e=!0}else n+=E*2,E=0}if(!e&&m.segment_state[f]){if(a){z=!1;for(p=0;p<a;){nLights=a-p;if(nLights>u.MAX_LIGHTS)nLights=u.MAX_LIGHTS;p>0&&!z&&(c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE),c.depthFunc(c.EQUAL),z=!0);b=d[p];w=b.light_type;for(e=0;e<nLights;e++)if(d[e+p].light_type!=w){nLights=e;break}g.use(b.light_type,nLights);b=g.shader[b.light_type][nLights];c.uniformMatrix4fv(b.uMVMatrix,
!1,l.mvMatrix);c.uniformMatrix4fv(b.uPMatrix,!1,l.pMatrix);c.uniformMatrix4fv(b.uOMatrix,!1,h);c.uniformMatrix3fv(b.uNMatrix,!1,l.nMatrix);r||(g.bindObject(m,b),r=!0);for(e=0;e<nLights;e++)d[e+p].setupShader(b,e);c.drawElements(c.TRIANGLES,E,c.UNSIGNED_SHORT,n);p+=nLights}z&&(c.disable(c.BLEND),c.depthFunc(c.LEQUAL))}else g.use(0,0),c.uniformMatrix4fv(g.shader[0][0].uMVMatrix,!1,l.mvMatrix),c.uniformMatrix4fv(g.shader[0][0].uPMatrix,!1,l.pMatrix),c.uniformMatrix4fv(g.shader[0][0].uOMatrix,!1,h),c.uniformMatrix3fv(g.shader[0][0].uNMatrix,
!1,l.nMatrix),r||(g.bindObject(m,g.shader[0][0]),r=!0),c.drawElements(c.TRIANGLES,E,c.UNSIGNED_SHORT,n);n+=E*2}}g&&b&&g.clearObject(m,b);c.depthMask(1);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null)}}}});CubicVR.RegisterModule("Scene",function(u){function s(a,b){return a.light_type-b.light_type}function m(c,e){var f=null;c!==d&&c!==null&&(f=c.compile?null:c);f?(this.morphWeight=f.morphWeight||0,this.morphSource=f.morphSource||-1,this.morphTarget=f.morphTarget||-1,this.position=f.position===d?[0,0,0]:f.position,this.rotation=f.rotation===d?[0,0,0]:f.rotation,this.scale=f.scale===d?[1,1,1]:f.scale,this.shadowCast=f.shadowCast===d?!0:f.shadowCast,this.motion=f.motion===d?null:f.motion,this.obj=f.mesh===
d?c!==d&&f.faces!==d?c:null:f.mesh,this.name=f.name===d?e!==d?e:null:f.name):(this.position=[0,0,0],this.rotation=[0,0,0],this.scale=[1,1,1],this.motion=null,this.obj=c,this.name=e,this.shadowCast=!0);this.parent=this.children=null;this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,
[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[]}function l(a,b,c,e,d,h){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.collect_stats=!1;typeof a==="object"?(this.octree=a.octree,this.skybox=a.skybox||null,this.camera=new CubicVR.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip),this.name=a.name||
"scene"+f,this.destroy=a.destroy||function(){},this.update=a.update||function(){},this.enable=a.enable||function(){},this.disable=a.disable||function(){},a=a.setup&&a.setup(this),this.update=a.update||this.update,this.enable=a.enable||this.enable,this.disable=a.disable||this.disable,this.destroy=a.destroy||this.destroy):(this.skybox=null,this.octree=h,this.camera=new CubicVR.Camera(a,b,c,e,d),this.name="scene"+f+Date.now());this.paused=!1;++f}function h(){this.meshBin={};this.imageBin={};this.meshMap=
{};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var d=u.undef,n=CubicVR.enums,c=u.GLCore,a=CubicVR.aabb,b=CubicVR.mat4,e=0;m.prototype={setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:0},doTransform:function(a){var c=
CubicVR.vec3;if(!c.equal(this.lposition,this.position)||!c.equal(this.lrotation,this.rotation)||!c.equal(this.lscale,this.scale)||a!==d)a!==d?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===this.scale[1]===this.scale[2]!==1&&b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),
this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0},adjust_octree:function(){var b=this.getAABB(),c=this.octree_aabb,e=b[0][0],f=b[0][1],h=b[0][2],l=b[1][0],m=b[1][1],p=b[1][2],n=c[0][0],s=c[0][1],x=c[0][2],u=c[1][0],
v=c[1][1],c=c[1][2];if(this.octree_leaves.length>0&&(e<n||f<s||h<x||l>u||m>v||p>c)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(e!==null){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==d&&e._root!==null)e=e._root;else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},bindChild:function(a){if(this.children===null)this.children=
[];a.parent=this;this.children.push(a)},control:function(a,b,c){a===n.motion.POS?this.position[b]=c:a===n.motion.SCL?this.scale[b]=c:a===n.motion.ROT&&(this.rotation[b]=c)},getAABB:function(){var a=CubicVR.mat4,b=CubicVR.vec3;if(this.dirty){var c=Array(8);this.doTransform();var e,f;if(this.obj!==null){if(this.obj.bb===null)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];e=this.obj.bb[0];f=this.obj.bb[1]}if(this.obj===null||e===d||f===d)return this.aabb=[b.add([-1,-1,
-1],this.position),b.add([1,1,1],this.position)];var h=e;e=b.subtract(f,e);c[0]=[h[0],h[1],h[2]];c[1]=[h[0],h[1],h[2]+e[2]];c[2]=[h[0]+e[0],h[1],h[2]];c[3]=[h[0]+e[0],h[1],h[2]+e[2]];c[4]=[h[0],h[1]+e[1],h[2]];c[5]=[h[0],h[1]+e[1],h[2]+e[2]];c[6]=[h[0]+e[0],h[1]+e[1],h[2]];c[7]=[h[0]+e[0],h[1]+e[1],h[2]+e[2]];h=a.vec3_multiply(c[0],this.tMatrix);e=[h[0],h[1],h[2]];f=[h[0],h[1],h[2]];for(b=1;b<8;++b)h=a.vec3_multiply(c[b],this.tMatrix),e[0]>h[0]&&(e[0]=h[0]),e[1]>h[1]&&(e[1]=h[1]),e[2]>h[2]&&(e[2]=
h[2]),f[0]<h[0]&&(f[0]=h[0]),f[1]<h[1]&&(f[1]=h[1]),f[2]<h[2]&&(f[2]=h[2]);this.aabb[0]=e;this.aabb[1]=f;this.dirty=!1}return this.aabb}};var f=0;l.prototype={attachOctree:function(b){this.octree=b;b.init&&b.init(this);var c=this.lights;this.lights=[];for(var b=0,f=c.length;b<f;b++)this.bindLight(c[b]);c=this.sceneObjects;if(this.octree!==d){f=0;for(b=c.length;f<b;++f){var h=c[f];if(h.obj!==null){if(h.id<0)h.id=e,++e;this.sceneObjectsById[h.id]=h;a.reset(h.octree_aabb,h.position);this.octree.insert(h);
(h.octree_common_root===void 0||h.octree_common_root===null)&&log("!!",h.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,c,f){if(this.sceneObjects.indexOf(b)==-1){this.sceneObjects.push(b);c!==d&&c&&this.pickables.push(b);b.name!==null&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==d&&(f===d||f==="true")){if(b.id<0)b.id=e,++e;this.sceneObjectsById[b.id]=b;a.reset(b.octree_aabb,
b.position);this.octree.insert(b)}if(b.children)for(var h=0,l=b.children.length;h<l;h++)this.bindSceneObject(b.children[h],c,f);return b}},removeLight:function(a){var b;(b=this.lights.indexOf(a))>=0&&this.lights.splice(b,1)},removeSceneObject:function(a){var b;(b=this.sceneObjects.indexOf(a))>=0&&this.sceneObjects.splice(b,1);this.pickables.indexOf(a)>=0&&pickable&&this.pickables.push(a);a.name!==null&&this.sceneObjectsByName[a.name]!==d&&delete this.sceneObjectsByName[a.name];if(a.children){b=0;
for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==d&&(b===d||b==="true"))a.method===n.light.method.GLOBAL?this.global_lights.push(a):(a.method===n.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(s)},bindCamera:function(a){this.camera=a},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&this.sceneObjects[b].motion.apply(a,
this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,this.camera)}b=0;for(c=this.lights.length;b<c;b++){var e=this.lights[b];e.motion!==null&&e.motion.apply(a,e)}},renderSceneObjectChildren:function(a,b,e){for(var d=c.gl,f=!1,h=0,l=a.children.length;h<l;h++)if(a.children[h].visible!==!1){try{a.children[h].doTransform(a.tMatrix)}catch(m){break}var n=a.children[h],s=a.children[h].obj;
if(s){a.children[h].scale[0]<0&&(f=!f);a.children[h].scale[1]<0&&(f=!f);a.children[h].scale[2]<0&&(f=!f);f&&d.cullFace(d.FRONT);if(s.morphTargets!==null&&(n.morphSource!==-1&&s.setMorphSource(n.morphSource),n.morphTarget!==-1&&s.setMorphTarget(n.morphTarget),n.morphWeight!==null))s.morphWeight=n.morphWeight;CubicVR.renderObject(obj,b,a.children[h].tMatrix,e);f&&d.cullFace(d.BACK)}a.children[h].children!==null&&this.renderSceneObjectChildren(a.children[h],b,e)}},updateShadows:function(){var a=c.gl,
b=!1;this.updateCamera();for(var e=!1,d=a.getParameter(a.VIEWPORT),f=0,h=this.lights.length;f<h;f++){var l=this.lights[f];if(l.light_type==n.light.type.SPOT_SHADOW||l.light_type==n.light.type.AREA){var e=!0,m=new CubicVR.Light(n.light.type.DEPTH_PACK);if(l.light_type===n.light.type.AREA)l.areaCam=this.camera,l.updateAreaLight();c.shadow_near=l.dummyCam.nearclip;c.shadow_far=l.dummyCam.farclip;l.shadowBegin();for(var s=0,w=this.sceneObjects.length;s<w;s++){var u=this.sceneObjects[s];if(u.parent===
null&&!(u.visible===!1||u.shadowCast===!1)){u.doTransform();if(u.obj!==null){u.scale[0]<0&&(b=!b);u.scale[1]<0&&(b=!b);u.scale[2]<0&&(b=!b);b&&a.cullFace(a.FRONT);var F=u.obj;if(F.morphTargets!==null&&(u.morphSource!==-1&&F.setMorphSource(u.morphSource),u.morphTarget!==-1&&F.setMorphTarget(u.morphTarget),u.morphWeight!==null))F.morphWeight=u.morphWeight;CubicVR.renderObject(F,l.dummyCam,u.tMatrix,[m]);b&&a.cullFace(a.BACK);b=!1}u.children!==null&&this.renderSceneObjectChildren(u,l.dummyCam,[m])}}l.shadowEnd()}}e&&
a.viewport(d[0],d[1],d[2],d[3])},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());c.depth_alpha_near=this.camera.nearclip;c.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},render:function(){++this.frames;this.updateCamera();for(var a=
0,b=this.lights.length;a<b;a++)this.lights[a].prepare(this.camera);var e=c.gl,f=this.octree!==d,h=0;if(f)this.octree.reset_node_visibility(),this.octree.cleanup(),a=this.octree.get_frustum_hits(this.camera),h=a.lights.length;for(var l=!1,m=0,n=[],a=0,b=this.sceneObjects.length;a<b;a++){var u=this.lights,w=this.sceneObjects[a];if(w.parent===null){w.doTransform();if(f){w.dirty&&w.obj!==null&&w.adjust_octree();if(w.visible===!1||f&&(w.ignore_octree||w.drawn_this_frame===!0||w.culled===!0))continue;u=
w.dynamic_lights;u=u.concat(w.static_lights);u=u.concat(this.global_lights);this.collect_stats&&(h=Math.max(u.length,h),h===u.length&&(n=u),++m);u=u.length===0?[c.emptyLight]:u.sort(s);w.drawn_this_frame=!0}else if(w.visible===!1)continue;if(w.obj!==null){w.scale[0]<0&&(l=!l);w.scale[1]<0&&(l=!l);w.scale[2]<0&&(l=!l);l&&e.cullFace(e.FRONT);var x=w.obj;if(x.morphTargets!==null&&(w.morphSource!==-1&&x.setMorphSource(w.morphSource),w.morphTarget!==-1&&x.setMorphTarget(w.morphTarget),w.morphWeight!==
null))x.morphWeight=w.morphWeight;CubicVR.renderObject(x,this.camera,w.tMatrix,u);l&&e.cullFace(e.BACK);l=!1}w.children!==null&&this.renderSceneObjectChildren(w,this.camera,u)}}if(this.collect_stats)this.stats["objects.num_rendered"]=m,this.stats["lights.num_rendered"]=h,this.stats["lights.rendered"]=n,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)e.cullFace(e.FRONT),f=this.camera.farclip*
2/Math.sqrt(3),this.skybox.scene_object.position=[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[f,f,f],this.skybox.scene_object.doTransform(),CubicVR.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),e.cullFace(e.BACK)},bbRayTest:function(a,b,c){var e=CubicVR.vec3,d=[],b=b.length===2?this.camera.unProject(b[0],b[1]):e.add(a,b),f;for(f in this.pickables)if(this.pickables.hasOwnProperty(f)){var h=this.pickables[f];
if(h.visible===!0){var l,m;m=h.getAABB();l=m[0];m=m[1];m[0]-l[0]<0.2&&(l[0]-=0.1,m[0]+=0.1);m[1]-l[1]<0.2&&(l[1]-=0.1,m[1]+=0.1);m[2]-l[2]<0.2&&(l[2]-=0.1,m[2]+=0.1);var n=e.multiply(e.add(l,m),0.5),s=e.getClosestTo(a,b,n),n=e.length(e.subtract(s,n));(s[0]>=l[0]&&s[0]<=m[0]?1:0)+(s[1]>=l[1]&&s[1]<=m[1]?1:0)+(s[2]>=l[2]&&s[2]<=m[2]?1:0)>=c&&d.push({dist:n,obj:h})}}d.length&&d.sort(function(a,b){if(a.dist==b.dist)return 0;return a.dist<b.dist?-1:1});return d}};h.prototype={addMesh:function(a,b,c){this.meshBin[a]===
d&&(this.meshBin[a]=[],this.meshBinPtr[a]===d&&(this.meshBinPtr[a]=0));this.meshMap[b]===d&&(this.meshMap[b]=c,this.meshBin[a].push(c))},addImage:function(a,b,c){this.imageBin[a]===d&&(this.imageBin[a]=[],this.imageBinPtr[a]===d&&(this.imageBinPtr[a]=0));this.imageMap[b]===d&&(this.imageMap[b]=c,this.imageBin[a].push(c))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=
0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,
this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:l,SceneObject:m,SkyBox:function(a){var b=a.texture,a=a.mapping,c=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/u.Images[c.texture.tex_id].width;if(c.mapping===null)c.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new CubicVR.Material({name:"skybox",textures:{color:b}}),
e=new CubicVR.Mesh;e.sky_mapping=c.mapping;CubicVR.primitives.box({mesh:e,size:1,material:a,uvmapper:{projectionMode:CubicVR.enums.uv.projection.SKY,scale:[1,1,1]}});e.prepare();c.scene_object=new CubicVR.SceneObject(e);c.ready=!0};if(b){if(typeof b==="string")b=new CubicVR.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;if(a)this.mapping=a,this.onready()}},DeferredBin:h}});CubicVR.RegisterModule("Shader",function(u){function s(c,a){var b=CubicVR.util,e,f;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];c.indexOf("\n")!==-1?e=d(l.gl,c,"x-shader/x-vertex"):(e=n(l.gl,c),e===null&&(f=b.getURL(c),e=d(l.gl,f,"x-shader/x-vertex")));a.indexOf("\n")!==-1?f=d(l.gl,a,"x-shader/x-fragment"):(f=n(l.gl,a),f===null&&(f=b.getURL(a),f=d(l.gl,f,"x-shader/x-fragment")));this.shader=l.gl.createProgram();l.gl.attachShader(this.shader,e);l.gl.attachShader(this.shader,f);l.gl.linkProgram(this.shader);
if(!l.gl.getProgramParameter(this.shader,l.gl.LINK_STATUS))throw Error("Could not initialise shader vert("+c+"), frag("+a+")");}var m=u.undef,l=u.GLCore,h=CubicVR.enums;h.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var d=function(c,a,b){if(b==="x-shader/x-fragment")b=c.createShader(c.FRAGMENT_SHADER);else if(b==="x-shader/x-vertex")b=c.createShader(c.VERTEX_SHADER);
else return null;c.shaderSource(b,a);c.compileShader(b);if(!c.getShaderParameter(b,c.COMPILE_STATUS))return log(c.getShaderInfoLog(b)),null;return b},n=function(c,a){var b=document.getElementById(a);if(!b)return null;for(var e="",d=b.firstChild;d;)d.nodeType===3&&(e+=d.textContent),d=d.nextSibling;if(b.type==="x-shader/x-fragment")b=c.createShader(c.FRAGMENT_SHADER);else if(b.type==="x-shader/x-vertex")b=c.createShader(c.VERTEX_SHADER);else return null;c.shaderSource(b,e);c.compileShader(b);c.getShaderParameter(b,
c.COMPILE_STATUS)||log(c.getShaderInfoLog(b));return b};s.prototype={bindSelf:function(c){var a,b,e;c.indexOf(".")!==-1?c.indexOf("[")!==-1?(a=c.split("["),e=a[0],a=a[1].split("]"),b=a[0],a=a[1].split("."),a=a[1],this[e]===m&&(this[e]=[]),this[e][b]===m&&(this[e][b]={}),this[e][b][a]=this.uniforms[c]):(a=c.split("."),e=a[0],a=a[1],this[e]===m&&(this[e]={}),this[e][a]=this.uniforms[c]):c.indexOf("[")!==-1?(a=c.split("["),e=a[0],a=a[1].split("]"),b=a[0],this[e]===m&&(this[e]=[]),this[e][b]=this.uniforms[c]):
this[c]=this.uniforms[c]},addMatrix:function(c,a){this.use();this.uniforms[c]=l.gl.getUniformLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);a!==m&&this.setMatrix(c,a);this.bindSelf(c);return this.uniforms[c]},addVector:function(c,a){this.use();this.uniforms[c]=l.gl.getUniformLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);
a!==m&&this.setVector(c,a);this.bindSelf(c);return this.uniforms[c]},addFloat:function(c,a){this.use();this.uniforms[c]=l.gl.getUniformLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);a!==m&&this.setFloat(c,a);this.bindSelf(c);return this.uniforms[c]},addVertexArray:function(c){this.use();this.uniforms[c]=l.gl.getAttribLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[c],
this.uniform_type[c]]);this.bindSelf(c);return this.uniforms[c]},addUVArray:function(c){this.use();this.uniforms[c]=l.gl.getAttribLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);this.bindSelf(c);return this.uniforms[c]},addFloatArray:function(c){this.use();this.uniforms[c]=l.gl.getAttribLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);
this.bindSelf(c);return this.uniforms[c]},addInt:function(c,a){this.use();this.uniforms[c]=l.gl.getUniformLocation(this.shader,c);this.uniform_type[c]=h.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[c],this.uniform_type[c]]);a!==m&&this.setInt(c,a);this.bindSelf(c);return this.uniforms[c]},use:function(){l.gl.useProgram(this.shader)},setMatrix:function(c,a){var b=this.uniforms[c];if(b!==null){var e=a.length;e===16?l.gl.uniformMatrix4fv(b,!1,a):e===9?l.gl.uniformMatrix3fv(b,!1,a):e===
4&&l.gl.uniformMatrix2fv(b,!1,a)}},setInt:function(c,a){var b=this.uniforms[c];b!==null&&l.gl.uniform1i(b,a)},setFloat:function(c,a){var b=this.uniforms[c];b!==null&&l.gl.uniform1f(b,a)},setVector:function(c,a){var b=this.uniforms[c];if(b!==null){var e=a.length;e==3?l.gl.uniform3fv(b,a):e==2?l.gl.uniform2fv(b,a):l.gl.uniform4fv(b,a)}},clearArray:function(c){c=this.uniforms[c];c!==null&&l.gl.disableVertexAttribArray(c)},bindArray:function(c,a){var b=l.gl,e=this.uniforms[c];if(e!==null){var d=this.uniform_type[c];
d===h.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,a),b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):d===h.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,a),b.vertexAttribPointer(e,2,b.FLOAT,!1,0,0)):d===h.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,a),b.vertexAttribPointer(e,1,b.FLOAT,!1,0,0))}}};return{Shader:s}});CubicVR.RegisterModule("Texture",function(u){function s(a){var c=CubicVR.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}var f=this.canvasSource,g=f.width,f=f.height,h=!0;if(g===
1||f===1)h=!1;else{if(g!==1)for(;g%2===0;)g/=2;if(f!==1)for(;f%2===0;)f/=2;g>1&&(h=!1);f>1&&(h=!1)}this.updateFunction=a.update;this.texture=new CubicVR.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;h?(this.setFilter(d.texture.filter.LINEAR_MIP),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)):(this.setFilter(d.texture.filter.LINEAR),
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));a.nodeName==="IMG"&&this.update()}function m(a,c,f){var g=CubicVR.GLCore.gl;this.texture=new CubicVR.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=c;this.canvas.height=f;this.pjs=new Processing(this.canvas,CubicVR.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();a=this.canvas.width;c=this.canvas.height;f=!0;if(a===1||c===1)f=!1;else{if(a!==1)for(;a%
2===0;)a/=2;if(c!==1)for(;c%2===0;)c/=2;a>1&&(f=!1);c>1&&(f=!1)}this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;f?this.setFilter(d.texture.filter.LINEAR_MIP):(this.setFilter(d.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE))}function l(a,c,f){var g=h.gl;this.width=c;this.height=f;this.srcTex=
a;this.outTex=new CubicVR.RenderBuffer(c,f);var a=c,l=f;if(!(a===1||l===1)){if(a!==1)for(;a%2===0;)a/=2;if(l!==1)for(;l%2===0;)l/=2}a=[1/c,1/f,0];this.outputBuffer=new CubicVR.RenderBuffer(c,f,!1);this.fsQuad=CubicVR.fsQuad.makeFSQuad(c,f);shaderNMap=new CubicVR.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",a);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(g.TEXTURE0);this.setFilter(d.texture.filter.LINEAR);
g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT)}var h=u.GLCore,d=CubicVR.enums,n=u.undef;d.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var c=function(a,c){this.img_path=a;this.filter_type=c};c.prototype={getTexture:function(b,c){return new a(this.img_path,this.filter_type,b,c)}};var a=function(a,c,f,g,l){var m=h.gl;this.tex_id=
u.Textures.length;this.filterType=-1;this.onready=l;this.loaded=!1;u.Textures[this.tex_id]=m.createTexture();u.Textures_obj[this.tex_id]=this;if(a)typeof a==="string"?u.Images[this.tex_id]=new Image:typeof a==="object"&&a.nodeName==="IMG"&&(u.Images[this.tex_id]=a),u.Textures_ref[a]=this.tex_id;m.bindTexture(m.TEXTURE_2D,u.Textures[this.tex_id]);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR);if(a){var t=this.tex_id,s=c!==n?c:
h.default_filter,o=this;u.Images[this.tex_id].onload=function(){m.bindTexture(m.TEXTURE_2D,u.Textures[t]);m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0);m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE);var a=u.Images[t];m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,a);var b=a.width,a=a.height,c=!0;if(b===1||a===1)c=!1;else{if(b!==1)for(;b%2===0;)b/=2;if(a!==1)for(;a%2===0;)a/=2;b>1&&(c=!1);a>1&&(c=!1)}c||(m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,
m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE));if(u.Textures_obj[t].filterType===-1){if(!c&&s===d.texture.filter.LINEAR_MIP)s=d.texture.filter.LINEAR;u.Textures_obj[t].filterType===-1&&u.Textures_obj[t].setFilter(s)}else u.Textures_obj[t].setFilter(u.Textures_obj[t].filterType);m.bindTexture(m.TEXTURE_2D,null);if(o.onready)o.onready();o.loaded=!0};if(f)u.Images[this.tex_id].deferredSrc=a,f.addImage(g,a,u.Images[this.tex_id]);else if(typeof a==="string")u.Images[this.tex_id].src=a}this.active_unit=-1};a.prototype=
{setFilter:function(a){var c=CubicVR.GLCore.gl;c.bindTexture(c.TEXTURE_2D,u.Textures[this.tex_id]);a===d.texture.filter.LINEAR?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR)):a===d.texture.filter.LINEAR_MIP?(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D)):a===d.texture.filter.NEAREST?(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST)):a===d.texture.filter.NEAREST_MIP&&(c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST_MIPMAP_LINEAR),c.generateMipmap(c.TEXTURE_2D));this.filterType=a},use:function(a){h.gl.activeTexture(a);h.gl.bindTexture(h.gl.TEXTURE_2D,u.Textures[this.tex_id]);this.active_unit=a},clear:function(){if(this.active_unit!==-1)h.gl.activeTexture(this.active_unit),
h.gl.bindTexture(h.gl.TEXTURE_2D,null),this.active_unit=-1}};s.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=CubicVR.GLCore.gl;a.bindTexture(a.TEXTURE_2D,u.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===d.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};m.prototype={update:function(){var a=
CubicVR.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,u.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===d.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};l.prototype={update:function(){var a=h.gl,c=a.getParameter(a.VIEWPORT);this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);
this.srcTex.use(a.TEXTURE0);CubicVR.fsQuad.renderFSQuad(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(c[0],c[1],c[2],c[3])}};return{Texture:a,DeferredLoadTexture:c,CanvasTexture:s,TextTexture:function(a,c){var d=c&&c.color||"#fff",g=c&&c.bgcolor,h=c&&c.font||"18pt Arial",l=c&&c.align||"start",m=c&&c.y||0,u=c&&c.width||n,o=c&&c.height||n,B=document.createElement("CANVAS"),p=B.getContext("2d"),z=0,z=typeof a==="string"?1:a.length;p.font=h;var w=c&&c.lineHeight||p.measureText("OO").width,
x;if(z===1)x=p.measureText(a).width;else for(var F=x=0;F<z;++F){var v=p.measureText(a[F]).width;v>x&&(x=v)}B.width=u||x;B.height=o||w*z;if(g)p.fillStyle=g,p.fillRect(0,0,B.width,B.height);p.fillStyle=d;p.font=h;p.textAlign=l;p.textBaseline="top";if(z===1)d=c&&c.x||l==="center"?B.width/2:l==="right"?B.width:0,p.fillText(a,d,m);else for(F=0;F<z;++F)d=c&&c.x||l==="center"?B.width/2:l==="right"?B.width:0,p.fillText(a[F],d,m+F*w);p.fill();this.use=s.prototype.use;this.clear=s.prototype.clear;this.update=
s.prototype.update;s.apply(this,[B]);this.update();this.canvasSource=null},PJSTexture:m,NormalMapGen:l}});CubicVR.RegisterModule("UVMapper",function(u){function s(a){a!==m?(this.rotation=a.rotation===m?[0,0,0]:a.rotation,this.scale=a.scale===m?[1,1,1]:a.scale,this.center=a.center===m?[0,0,0]:a.center,this.projection_mode=a.projectionMode===m?l.uv.projection.PLANAR:a.projectionMode,this.projection_axis=a.projectionAxis===m?l.uv.axis.X:a.projectionAxis,this.wrap_w_count=a.wrapW===m?1:a.wrapW,this.wrap_h_count=a.wrapH===m?1:a.wrapH):(this.rotation=[0,0,0],this.scale=[1,1,1],this.center=[0,0,0],this.projection_mode=
l.uv.projection.PLANAR,this.projection_axis=l.uv.axis.X,this.wrap_h_count=this.wrap_w_count=1)}var m=u.undef,l=CubicVR.enums,h=2*Math.PI,d=Math.PI/2;l.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var n=function(a,b,c){return a===0&&c===0?0:c===0?a<0?d:-d:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c)},c=function(a,b,c){var f;a===0&&c===0?(f=0,a=b!==0?b<0?-d:d:0):(f=c===0?a<0?d:-d:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c),a=Math.sqrt(a*a+c*c),a=a===0?b<
0?-d:d:Math.atan(b/a));return[f,a]};s.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e){var f=CubicVR.mat4,g,r,q,t,s,o=new CubicVR.Transform,u=!1,p=null;if(this.center[0]||this.center[1]||this.center[2])o.translate(-this.center[0],
-this.center[1],-this.center[2]),u=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&o.rotate(this.rotation[2],0,0,1),this.rotation[1]&&o.rotate(this.rotation[1],0,1,0),this.rotation[2]&&o.rotate(this.rotation[0],1,0,0),u=!0;u&&(p=o.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));for(var o=0,z=a.faces.length;o<z;o++)if(a.faces[o].material===b&&!(e!==m&&a.faces[o].segment!==e)){var w,x,F;if(this.projection_mode===l.uv.projection.CUBIC||this.projection_mode===
l.uv.projection.SKY)w=Math.abs(a.faces[o].normal[0]),x=Math.abs(a.faces[o].normal[1]),F=Math.abs(a.faces[o].normal[2]);for(var v=[],I=0,y=a.faces[o].points.length;I<y;I++){r=a.faces[o].points[I];var A=a.faces[o].points[(I+1)%3],L=a.faces[o].points[(I+2)%3];g=a.points[r];var D=a.points[A],G=a.points[L];u&&(g=f.vec3_multiply(g,p));var J=this.projection_mode;if(J===l.uv.projection.SKY)r=a.sky_mapping,w>=x&&w>=F&&(q=g[2]/this.scale[2]+this.scale[2]/2,t=-g[1]/this.scale[1]+this.scale[1]/2,a.faces[o].normal[0]<
0?(q=(r[2][2]-r[2][0])*(1-q),t=1-(r[2][3]-r[2][1])*t,q+=r[2][0],t+=r[2][1]):(q*=r[3][2]-r[3][0],t=1-(r[3][3]-r[3][1])*t,q+=r[3][0],t+=r[3][1])),x>=w&&x>=F&&(q=g[0]/this.scale[0]+this.scale[0]/2,t=-g[2]/this.scale[2]+this.scale[2]/2,a.faces[o].normal[1]<0?(q*=r[1][2]-r[1][0],t=1-(r[1][3]-r[1][1])*t,q+=r[1][0],t-=r[1][1]):(q*=r[0][2]-r[0][0],t=1-(r[0][3]-r[0][1])*t,q+=r[0][0],t-=r[0][1])),F>=w&&F>=x&&(q=g[0]/this.scale[0]+this.scale[0]/2,t=g[1]/this.scale[1]+this.scale[1]/2,a.faces[o].normal[2]<0?(q*=
r[4][2]-r[4][0],t=1-(r[4][3]-r[4][1])*(1-t),q+=r[4][0],t-=r[4][1]):(q=(r[5][2]-r[5][0])*(1-q),t=1-(r[5][3]-r[5][1])*(1-t),q+=r[5][0],t+=r[5][1])),a.faces[o].setUV([q,t],I);else if(J===l.uv.projection.CUBIC)w>=x&&w>=F&&(q=g[2]/this.scale[2]+0.5,t=g[1]/this.scale[1]+0.5),x>=w&&x>=F&&(q=-g[0]/this.scale[0]+0.5,t=g[2]/this.scale[2]+0.5),F>=w&&F>=x&&(q=-g[0]/this.scale[0]+0.5,t=g[1]/this.scale[1]+0.5),a.faces[o].normal[0]>0&&(q=-q),a.faces[o].normal[1]<0&&(q=-q),a.faces[o].normal[2]>0&&(q=-q),a.faces[o].setUV([q,
t],I);else if(J===l.uv.projection.PLANAR)q=this.projection_axis===l.uv.axis.X?g[2]/this.scale[2]+0.5:-g[0]/this.scale[0]+0.5,t=this.projection_axis===l.uv.axis.Y?g[2]/this.scale[2]+0.5:g[1]/this.scale[1]+0.5,a.faces[o].setUV([q,t],I);else{if(J===l.uv.projection.CYLINDRICAL)J=this.projection_axis,J===l.uv.axis.X?(s=n(g[2],g[0],-g[1]),t=-g[0]/this.scale[0]+0.5):J===l.uv.axis.Y?(s=n(-g[0],g[1],g[2]),t=-g[1]/this.scale[1]+0.5):J===l.uv.axis.Z&&(s=n(-g[0],g[2],-g[1]),t=-g[2]/this.scale[2]+0.5),s=1-s/h,
this.wrap_w_count!==1&&(s*=this.wrap_w_count),g=s,r=t;else if(J===l.uv.projection.SPHERICAL){var C,H,K,J=this.projection_axis;J===l.uv.axis.X?(C=v[r]?v[r]:c(g[2],g[0],-g[1]),v[r]||(v[r]=C),H=v[A]?v[A]:c(D[2],D[0],-D[1]),v[A]||(v[A]=H),K=v[L]?v[L]:c(G[2],G[0],-G[1]),v[L]||(v[L]=K)):J===l.uv.axis.Y?(C=v[r]?v[r]:c(g[0],-g[1],g[2]),v[r]||(v[r]=C),H=v[A]?v[A]:c(D[0],-D[1],D[2]),v[A]||(v[A]=H),K=v[L]?v[L]:c(G[0],-G[1],G[2]),v[L]||(v[L]=K)):J===l.uv.axis.Z&&(C=v[r]?v[r]:c(-g[0],g[2],-g[1]),v[r]||(v[r]=C),
H=v[A]?v[A]:c(-D[0],D[2],-D[1]),v[A]||(v[A]=H),K=v[L]?v[L]:c(-G[0],G[2],-G[1]),v[L]||(v[L]=K));Math.abs(C[0]-H[0])>d&&Math.abs(C[0]-K[0])>d&&(C[0]>H[0]&&C[0]>K[0]?C[0]-=h:C[0]+=h);Math.abs(C[1]-H[1])>d&&Math.abs(C[1]-K[1])>d&&(C[1]>H[1]&&C[1]>K[1]?C[1]-=h:C[1]+=h);s=1-C[0]/h;r=0.5-C[1]/Math.PI;this.wrap_w_count!==1&&(s*=this.wrap_w_count);this.wrap_h_count!==1&&(r*=this.wrap_h_count);g=s}else r=g=0;a.faces[o].setUV([g,r],I)}}}return this}};return{UVMapper:s}});CubicVR.RegisterModule("Utility",function(u){var s=u.undef;return{util:{getScriptContents:function(m){var l=document.getElementById(m),h="",d="";if(l){if(l.src!==""||l.attributes.srcUrl!==s)d=l.src!==""?l.src:l.attributes.srcUrl.value}else d=m;if(d.length!==0){if(m=new XMLHttpRequest,m.open("GET",d,!1),m.send(null),m.status===200||m.status===0)h=m.responseText}else for(d=l.firstChild;d;)d.nodeType===3&&(h+=d.textContent),d=d.nextSibling;return h},getURL:function(m){try{var l=new XMLHttpRequest;l.open("GET",
m,!1);l.send(null);if(l.status===200||l.status===0)if(l.responseText.length)return l.responseText;else if(l.responseXML)return l.responseXML}catch(h){alert(m+" failed to load.")}return null},getXML:function(m){try{var l=new XMLHttpRequest;l.open("GET",m,!1);l.overrideMimeType("application/xml");l.send(null);if(l.status===200||l.status===0)return l.responseXML}catch(h){try{alert(m+" failed to load.")}catch(d){throw h;}}return null},repackArray:function(m,l,h){m.length!==parseInt(l,10)*parseInt(h,10)&&
log("array repack error, data size !== stride*count: data.length="+m.length+" stride="+l+" count="+h);for(var h=[],d=0,n=0,c=m.length;n<c;n++){var a=n%l;a===0&&(h[d]=[]);h[d][a]=m[n];a===l-1&&d++}return h},collectTextNode:function(m){if(!m)return"";for(var l="",m=m.childNodes,h=0,d=m.length;h<d;h++)l+=m[h].nodeValue;return l},floatDelimArray:function(m,l){for(var h=m.split(l?l:","),d=0,n=h.length;d<n;d++)h[d]=parseFloat(h[d]);h[h.length-1]!==h[h.length-1]&&h.pop();return h},intDelimArray:function(m,
l){for(var h=m.split(l?l:","),d=0,n=h.length;d<n;d++)h[d]=parseInt(h[d],10);h[h.length-1]!==h[h.length-1]&&h.pop();return h},textDelimArray:function(m,l){for(var h=m.split(l?l:","),d=0,n=h.length;d<n;d++)h[d]=h[d];return h},xml2badgerfish:function(m){var l={},h=[],d,n=m,c,a,b,e=/^\s+|\s+$/g;m.jsonParent=l;for(h.push(m);h.length;){var n=h.pop(),f=null;c=n.jsonParent;m=0;for(d=n.childNodes.length;m<d;m++)a=n.childNodes[m],b=a.tagName,b!==s&&(f=f||{},f[b]=f[b]||0,f[b]++);if(n.attributes&&n.attributes.length){m=
0;for(d=n.attributes.length;m<d;m++)a=n.attributes[m],c["@"+a.name]=a.value}m=0;for(d=n.childNodes.length;m<d;m++)if(a=n.childNodes[m],b=a.tagName,a.nodeType===1)f[b]>1?(c[b]=c[b]||[],c[b].push({}),a.jsonParent=c[b][c[b].length-1]):(c[b]=c[b]||{},a.jsonParent=c[b]),h.push(a);else if(a.nodeType===3&&a.nodeValue.replace(e,"")!=="")c.$=c.$||"",c.$+=a.nodeValue}return l}}}});CubicVR.RegisterModule("Worker",function(u){function s(c){var a=this;this.message=c.message||function(){};this.send=function(a,c){postMessage({message:a,data:c})};self.addEventListener("message",function(b){b.data.message!=="init"&&a.message(b.data)},!1)}function m(c){function a(a){setTimeout(function(){b.send("test",a)},1E3)}c&&a(c);var b=new s({message:a})}function l(c){function a(a){a=util.getURL(a);b.send("done",a.length)}var b;b=new s({message:function(b){a(b)}});c&&a(c)}function h(c){function a(a){a=
util.getURL(a);b.send("loaded",a)}var b,d;b=new s({message:function(a){if(a.message==="parse")d=new DeferredBin,CubicVR.loadCollada("","",d,a.data),b.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var c=a.triangulateQuads().compileVBO(a.compileMap());b.send("getMesh",{mesh:a,vbo:c})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});c&&a(c)}function d(c){function a(a){var c=new Mesh,d;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);a=c.triangulateQuads().compileVBO(c.compileMap());
b.send("done",a)}var b;b=new s({message:function(b){a(b)}});c&&a(c)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(n){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}enums=CubicVR.enums;undefined=u.undef;Mesh=CubicVR.Mesh;Texture=CubicVR.Texture;Material=CubicVR.Material;SceneObject=CubicVR.SceneObject;Motion=CubicVR.Motion;Envelope=CubicVR.Envelope;DeferredBin=CubicVR.DeferredBin;util=CubicVR.util;return{Worker:function(c){this.worker=
new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=c.message||function(){};this.error=c.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=c.type;var a=this;this.worker.onmessage=function(b){a.message(b.data)};this.worker.onerror=function(b){a.error(b)};this.init=function(b){a.send("init",{type:a.type,data:b})};this.send=function(b,c){a.worker.postMessage({message:b,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(c.data||c.autoStart)&&
a.init(c.data)},ResourcePool:function(){function c(a){var b=a.parsed||function(){},c={},d;a.url.match(/\.dae/)&&(d=new CubicVR.Worker({type:"sceneFile",data:a.url,message:function(a){if(a.message==="loaded"){var a=(new DOMParser).parseFromString(a.data,"text/xml"),e=util.xml2badgerfish(a);console.log(a);d.send("parse",e)}else if(a.message==="getMesh"){var e=new Mesh,f;for(f in a.data.mesh)a.data.mesh.hasOwnProperty(f)&&(e[f]=a.data.mesh[f]);e.bindBuffer(e.bufferVBO(a.data.vbo));c.getMesh&&c.getMesh(e)}else a.message===
"parsed"&&b()}}));this.getSceneObject=function(a,b){d.send("getMesh",a);c.getMesh=b}}function a(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var b=this,d={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return d[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete d[settings];else for(var b in d)(d[b]=a)&&delete d[b]};this.createSceneObjectFromMesh=function(c){var d=c.scene,e=c.object,h=c.assetBase||"",l=b.createSceneFileManager({url:c.mesh,
parsed:function(){e&&l.getSceneObject(e,function(b){for(var b=a(b,new Mesh),c=0,e=b.materials.length;c<e;++c){for(var f=a(b.materials[c],new Material),l=0,m=f.textures.length;l<m;++l){var n=f.textures[c];f.textures[c]=new Texture(h+n.img_path,n.filter_type)}b.materials[c]=f}b=new SceneObject(b);d.bindSceneObject(b)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,a,b,d){var f;try{f=new Worker(CubicVR.getScriptLocation()+
"collada.js")}catch(g){throw Error("Can't find collada.js");}var h=[],l=[];f.onmessage=function(a){function f(a,b){for(var c in a)b[c]=a[c]}var g=a.data.message;if(g=="materials")for(var m=JSON.parse(a.data.data),a=0,g=m.length;a<g;++a){var n=new Material(m[a].name),s=n.material_id;f(m[a],n);n.material_id=s;h[m[a].material_id]=s;for(var s=0,u=m[a].textures.length;s<u;++s){var x=m[a].textures[s];if(x){var F=Texture_ref[x.img_path];F===void 0?(x=new Texture(x.img_path,x.filter_type,d,c),n.textures[s]=
x):n.textures[s]=Textures_obj[F]}else n.textures[s]=0}}else if(g=="scene"){m=JSON.parse(a.data.data);n=function(a){if(a.motion){for(var b=a.motion.controllers,c=[],d=0,e=b.length;d<e;++d){var g=b[d];if(g){for(var h=[],l=0,m=g.length;l<m;++l){var n=g[l];if(n){var o=n.keys[0];if(n.keys.length>1)o.prev=null,o.next=n.keys[1],o=n.keys[1];for(var p=1,q=n.keys.length-1;p<q;++p)o.prev=n.keys[p-1],o.next=n.keys[p+1],o=n.keys[p+1];if(n.keys.length>1)o=n.keys[n.keys.length-1],o.prev=n.keys[n.keys.length-2],
o.next=null;n.firstKey=n.keys[0];n.lastKey=n.keys[n.keys.length-1];n.keys=n.firstKey;o=new Envelope;f(n,o);h[l]=o}else g[l]=void 0}c[d]=h}else b[d]=void 0}a.motion.controllers=c;b=new Motion;f(a.motion,b);a.motion=b}};a=0;for(g=m.sceneObjects.length;a<g;++a){s=m.sceneObjects[a];s.obj!==null&&nop();if(s.reassembled===void 0)n(s),s.reassembled=!0;var v=function(a){var b=new SceneObject;f(a,b);if(a.obj!==null){var g=l[a.obj.id];if(g===void 0)if(g=new Mesh,f(a.obj,g),b.obj=g,l[a.obj.id]=g,d){if(g.points.length>
0){d.addMesh(c,c+":"+g.id,g);for(var m=0,n=g.faces.length;m<n;++m){var o=g.faces[m],p=o.material;o.material=h[p]!==void 0?h[p]:0}}}else b.obj.triangulateQuads(),b.obj.calcNormals(),b.obj.compile(),b.obj.clean();else b.obj=g}b.trans=new Transform;if(a.children&&a.children.length>0&&(b.children=[],a.children)){g=0;for(m=a.children.length;g<m;++g)n=v(a.children[g]),b.bindChild(n)}return b};m.sceneObjects[a]=v(s)}s=new Scene;a=s.camera;g=a.transform;f(m.camera,a);f(m.camera.transform,g);n(a);s.camera=
a;s.camera.transform=g;s.camera.frustum=new Frustum;a=0;for(g=m.sceneObjects.length;a<g;++a){u=m.sceneObjects[a];s.bindSceneObject(u);try{u.getAABB()}catch(I){}}a=0;for(g=m.lights.length;a<g;++a)u=new Light,f(m.lights[a],u),u.trans=new Transform,n(u),s.bindLight(u);b(s)}else console.log("message from collada worker:",a.data.message)};f.onerror=function(a){console.log("error from collada worker:",a.message)};f.postMessage({message:"start",params:{meshUrl:c,prefix:a,rootDir:CubicVR.getScriptLocation()}})},
InitWorker:function(){var c={test:m,prepareMesh:d,file:l,sceneFile:h};self.addEventListener("message",function(a){if(a.data.message==="init"){var b=a.data.data.type;if(b in c)new c[b](a.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
/* Auto Embed ./CubicVR_Core.vs */
window.CubicVR.CubicVRCoreVS="attribute vec3 aVertexPosition;\nattribute vec3 aNormal;\nattribute vec2 aTextureCoord;\n#if hasVertexColorMap\nattribute vec3 aColor;\nvarying vec3 cmapColor;\n#endif\n#if hasMorph\nattribute vec3 amVertexPosition;\nattribute vec3 amNormal;\nuniform float morphWeight;\n#endif\nvarying vec2 vTextureCoord;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nuniform mat4 uOMatrix;\nuniform mat3 uNMatrix;\nvec3 mSpec;\nfloat mShine;\nvarying vec3 vNormal;\nvarying vec4 vPosition;\n#if !depthPack\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform mat4 spMatrix[loopCount];\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasBumpMap||hasNormalMap\nvarying vec3 eyeVec;\n#endif\n#endif \nvoid main(void)\n{\nmat4 uMVOMatrix = uMVMatrix * uOMatrix;\nmat4 uMVPMatrix = uPMatrix * uMVMatrix;\n#if hasMorph\nvPosition = uMVOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0);\n#else\nvPosition = uMVOMatrix * vec4(aVertexPosition, 1.0);\ngl_Position = uMVPMatrix * uOMatrix * vec4(aVertexPosition, 1.0);\n#endif\nvTextureCoord = aTextureCoord;\n#if !depthPack\n#if hasVertexColorMap\ncmapColor = aColor;\n#endif\n#if hasMorph\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal+(amNormal-aNormal)*morphWeight,0.0)).xyz;\n#else\nvNormal = uNMatrix * normalize(uOMatrix*vec4(aNormal,0.0)).xyz;\n#endif\n#if hasBumpMap||hasNormalMap\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( aNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( aNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(aNormal, tangent);\nbinormal = normalize(binormal);\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (aNormal, 0.0)))\n);\neyeVec = vec3(uMVOMatrix * vec4(aVertexPosition,1.0)) * TBNMatrix;\n#endif\n#if (lightSpot||lightArea) && hasShadow\nfor (int i = 0; i < loopCount; i++)\n{\n#if hasShadow\n#if hasMorph\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition+(amVertexPosition-aVertexPosition)*morphWeight, 1.0));\n#else\nshadowProj[i] = spMatrix[i] * (uOMatrix * vec4(aVertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nu = normalize( vPosition.xyz );\n#else\nvec3 ws = (uMVMatrix * vec4(aVertexPosition,1.0)).xyz;\nvec3 u = normalize( vPosition.xyz );\nvec3 r = reflect(ws, vNormal );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvEnvTextureCoord.s = r.x/m + 0.5;\nvEnvTextureCoord.t = r.y/m + 0.5;\n#endif\n#endif\n#endif \n}\n";
/* Auto Embed ./CubicVR_Core.fs */
window.CubicVR.CubicVRCoreFS="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 mDiff;\nuniform vec3 mColor;\nuniform vec3 mAmb;\nuniform vec3 mSpec;\nuniform float mShine;\nuniform vec3 lAmb;\n#if lightPoint||lightDirectional||lightSpot||lightArea\nuniform vec3 lDir[loopCount];\nuniform vec3 lPos[loopCount];\nuniform vec3 lSpec[loopCount];\nuniform vec3 lDiff[loopCount];\nuniform float lInt[loopCount];\nuniform float lDist[loopCount];\n#if lightSpot\nuniform float lCut[loopCount];\n#endif\n#endif\nvarying vec3 vNormal;\nvarying vec2 vTextureCoord;\n#if hasVertexColorMap\nvarying vec3 cmapColor;\n#endif\n#if alphaDepth||depthPack||hasShadow\nuniform vec3 depthInfo;\nfloat ConvertDepth3(float d) { return (depthInfo.x*depthInfo.y)/(depthInfo.y-d*(depthInfo.y-depthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - depthInfo.x ) / ( depthInfo.y - depthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if depthPack\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if hasShadow\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if softShadow\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if hasShadow\nvarying vec4 shadowProj[loopCount];\nuniform sampler2D lDepthTex[loopCount];\nuniform vec3 lDepth[loopCount];\n#endif\n#if !depthPack\n#if hasColorMap\nuniform sampler2D colorMap;\n#endif\n#if hasBumpMap\nvarying vec3 eyeVec;\nuniform sampler2D bumpMap;\n#endif\n#if hasEnvSphereMap\nuniform sampler2D envSphereMap;\nuniform float envAmount;\n#if hasNormalMap\nvarying vec3 u;\n#else\nvarying vec2 vEnvTextureCoord;\n#endif\n#endif\n#if hasReflectMap\nuniform sampler2D reflectMap;\n#endif\n#if hasNormalMap\nuniform sampler2D normalMap;\n#endif\nuniform float mAlpha;\n#if hasAmbientMap\nuniform sampler2D ambientMap;\n#endif\n#if hasSpecularMap\nuniform sampler2D specularMap;\n#endif\n#endif \n#if hasAlphaMap\nuniform sampler2D alphaMap;\n#endif\nvarying vec4 vPosition;\nuniform mat4 uPMatrix;\nvoid main(void)\n{\n#if depthPack\nvec2 texCoord = vTextureCoord;\n#else\nvec3 n;\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if hasBumpMap\nfloat height = texture2D(bumpMap, vTextureCoord.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(eyeVec);\nvec2 texCoord = vTextureCoord.xy + (eye.xy * v);\n#else\nvec2 texCoord = vTextureCoord;\n#endif\n#if hasNormalMap\nvec3 bumpNorm = vec3(texture2D(normalMap, texCoord));\nn = (vec4(normalize(vNormal),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nn = normalize((n+bumpNorm)/2.0);\n#else\nn = normalize(vNormal);\n#endif\n#if hasColorMap\n#if !(lightPoint||lightDirectional||lightSpot||lightArea)\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\n#else\ncolor = texture2D(colorMap, vec2(texCoord.s, texCoord.t)).rgba;\ncolor.rgb *= mColor;\n#endif\nif (color.a<=0.9) discard;\n#else\n#if hasVertexColorMap\ncolor = vec4(cmapColor,1.0);\n#else\ncolor = vec4(mColor,1.0);\n#endif\n#endif\n#if hasAlphaMap\ncolor.a = texture2D(alphaMap, texCoord).r;\n#if alphaDepth\nif (color.a < 0.9) discard;\n#else\n#if !hasAlpha\nif (color.a<0.9) discard;\n#else\nif (color.a==0.0) discard;\n#endif\n#endif\n#else\n#if hasAlpha\ncolor.a = mAlpha;\n#endif\n#endif\nvec3 accum = lAmb;\n#if lightPoint\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < loopCount; i++) {\nvec3 lDir = lPos[i]-vPosition.xyz;\nfloat dist = length(lDir);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lDir);\nfloat NdotL = max(dot(normalize(lDir),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\naccum += att * NdotL * lDiff[i] * mDiff;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nvec3 spec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nvec3 spec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightDirectional\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightArea\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < loopCount; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lDir[i]);\nNdotL = max(dot(normalize(-lDir[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\naccum += shadow * lInt[i] * mDiff * lDiff[i] * NdotL;\n#else\naccum += lInt[i] * mDiff * lDiff[i] * NdotL;\n#endif\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,mShine);\n#else\nspec2 = lSpec[i] * mSpec * pow(NdotHV,mShine);\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if hasShadow\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if lightSpot\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < loopCount; i++) {\nvec3 l = lPos[i]-vPosition.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lDist[i]-dist)/lDist[i]), 0.0, 1.0)*lInt[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lDir[i]));\nif ( spotDot < cos((lCut[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vPosition.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, mShine);\n}\nelse {\npower = 0.0;\n}\n#if hasShadow\nvec4 shadowCoord = shadowProj[i] / shadowProj[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lDepth[i].x,lDepth[i].y),lDepth[i].x,lDepth[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lDepthTex[0],shadowCoord,shadowProj[i].w,lDepth[i].z);}\n#if loopCount>1\nelse if (i == 1) { shadow = getShadowVal(lDepthTex[1],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>2\nelse if (i == 2) { shadow = getShadowVal(lDepthTex[2],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\n#if loopCount>3\nelse if (i == 3) { shadow = getShadowVal(lDepthTex[3],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>4\nelse if (i == 4) { shadow = getShadowVal(lDepthTex[4],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>5\nelse if (i == 5) { shadow = getShadowVal(lDepthTex[5],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>6\nelse if (i == 6) { shadow = getShadowVal(lDepthTex[6],shadowCoord,shadowProj[i].w,lDepth[i].z);  }\n#endif\n#if loopCount>7\nelse if (i == 7) { shadow = getShadowVal(lDepthTex[7],shadowCoord,shadowProj[i].w,lDepth[i].z); }\n#endif\natt = att * shadow;\n#endif\naccum += att * lDiff[i] * mDiff * NdotL;\n#if hasSpecularMap\nspec2 = lSpec[i] * texture2D(specularMap, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lSpec[i] * mSpec * power;\n#endif\n#if hasShadow\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if hasShadow\n#endif\n#endif\n#if hasReflectMap\nfloat environmentAmount = texture2D( reflectMap, texCoord).r;\n#endif\n#if hasEnvSphereMap\n#if hasNormalMap\nvec3 r = reflect( u, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, coord.st).rgb * envAmount;\n#endif\n#else\n#if hasReflectMap\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb * environmentAmount;\n#else\ncolor.rgb += mColor*accum*texture2D( envSphereMap, vEnvTextureCoord).rgb*envAmount;\n#endif\n#endif\n#endif\n#if hasAmbientMap\n#if lightPoint||lightDirectional||lightSpot||lightArea\ncolor.rgb += texture2D(ambientMap, texCoord).rgb*(vec3(1.0,1.0,1.0)+mColor*mAmb);\n#else\ncolor.rgb = color.rgb*texture2D(ambientMap, texCoord).rgb;\n#endif\n#else\n#if !hasColorMap\ncolor.rgb += mColor*mAmb;\n#else\ncolor.rgb += mAmb*texture2D(colorMap, texCoord).rgb;\n#endif\n#endif\n#if alphaDepth\n#if !hasAlpha\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\ngl_FragColor = clamp(color,0.0,1.0);\n#endif \n#if depthPack\n#if hasAlphaMap\nfloat alphaVal = texture2D(alphaMap, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\ngl_FragColor = packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n#endif\n}\n";
