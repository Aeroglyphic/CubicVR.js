<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>

    <head>
        <title>
            CubicVR.js Performance Test Runner
        </title>
        <script src="../../CubicVR.js" type="text/javascript"></script>
    </head>

    <body>
        <h1>CubicVR.js Performance Test Runner</h1>
        <p>To start the tests click Start.  Each test is run in order (downloaded from the server).  Tests are run for based on the given number of iterations (specified below), and the time is recorded.</p>

        <h3>Settings</h3>
        <div>Run basic  Tests: &nbsp;
            Frames Per Test: <input type="text" size="4" id="iterations" onchange="updateIterations();"/>&nbsp;
            <input onclick="webGLStart();" type="button" value="Start"/><span id="testCount"></span></div>

        <h3>Results</h3>
        <div id="total"></div>
        <div id="results" style="margin: 5px; padding-top: 10px;"></div>
        <div style='font-family:Arial;font-size:14px;font-weight:bold'>Time Taken: <span id='timeTaken'>...</span></div>
        <div style='font-family:Arial;font-size:14px;font-weight:bold'>FPS: <span id='fpsText'>...</span></div>
        <p id='frames'>Time taken.</p>
        <p id='FilePull'>FilePull.</p>

        <script type='text/javascript'>
            var timerMilliseconds;
            var timerSeconds = 0;
            var timerLastSeconds = 0;
            var frameCounter = 0;
            var frames = 0;
            var camera;
            var boxObject;
            var scene;
            var drawScene;
            var frames = 0;
            var results = document.getElementById('results');
            var gl;
            var canvas;
            var xp = 0;
            var boxMesh;
            var total = document.getElementById('total');
            total.innerHTML = '';

            // Frame Value after the loop stops
            var iterationCount = 100;
            document.getElementById('iterations').value = iterationCount;

            function updateIterations() {
                var newIterationCount = document.getElementById('iterations').value;
                if (newIterationCount) {
                    iterationCount = parseInt(newIterationCount, 10);
                }
            }

            function download(file) {
                var req = new XMLHttpRequest();
                req.open('GET', file, false);
                if (req.overrideMimeType) {
                    req.overrideMimeType('text/javascript');
                }
                req.send(null);
                if (req.status != 200 && req.status !=0) {
                    return null;
                } else {
                    return req.responseText;
                }
            }

            function getTest(testName) {
                var responseText = download(testName);

                /*function is3D(script) {
                    // look for size(100,100,OPENGL) or size(100,100,P3D)
                    var match = script.match(/size\([\s]*[\d]+[\s]*\,[\s]*[\d]+[\s]*\,?([^\)]+)?\)/);
                    if (match && match[1]) {
                        return match[1] == "OPENGL" || match[1] == "P3D";
                    }
                    return false;
                }*/

                if (!responseText) {
                    return null;
                }

                // Split out the canvas info in the comment:
                /*var test = {name: testName, code: responseText};
                test.is3D = is3D(test.code);*/
                return responseText;
            }

            function webGLStart() {
                // Build a canvas and append to the 'results' tag
                var buildCanvas = function(id, w, h) {
                    var c = document.createElement('canvas');
                    c.id = id;
                    c.width = w;
                    c.height = h;
                    c.className = "test";
                    return c;
                };
                canvas = buildCanvas('myCanvas',400,400);
                results.appendChild(canvas);
                gl = CubicVR.init(canvas);

                if (!gl) {
                    alert("Sorry, no WebGL support.");
                    return;
                };

                // Object will eventually be moved to another file.
                /*/ Create a material for the mesh
                var boxMaterial = new CubicVR.Material({
                    textures: {
                        color: new CubicVR.Texture("../images/6583-diffuse.jpg"),
                        bump: new CubicVR.Texture("../images/6583-bump.jpg")
                    }
                });

                // Add a box to mesh, size 1.0, apply material and UV parameters
                boxMesh = CubicVR.primitives.box({
                    size: 1.0,
                    material: boxMaterial,
                    uvmapper: {
                        projectionMode: CubicVR.enums.uv.projection.CUBIC,
                        scale: [1, 1, 1]
                    }
                });

                // triangulate and buffer object to GPU, remove unused data
                boxMesh.prepare();*/

                var test = /*function() {alert('Alert Box!');};/*/ getTest("basic_cube.js");
                document.getElementById('FilePull').innerHTML = test;
                window.eval(test);
                // New scene with our canvas dimensions and default camera with FOV 80
                scene = new CubicVR.Scene(canvas.width, canvas.height, 80);

                // SceneObject container for the mesh
                boxObject = new CubicVR.SceneObject(boxMesh);

                // Add SceneObject containing the mesh to the scene
                scene.bindSceneObject(boxObject);

                // set initial camera position and target
                scene.camera.position = [1, 1, 1];
                scene.camera.target = [0, 0, 0];

                // initialize a mouse view controller
                mvc = new CubicVR.MouseViewController(canvas, scene.camera);

                // Start our main drawing loop, it provides a timer and the gl context as parameters
                CubicVR.MainLoop(function(timer, gl) {
                    scene.render();
                    document.getElementById('frames').innerHTML = frames;
                    ++frames;
                    // Stop the MainLoop after it reaches a given value.
                    if (frames===iterationCount) {
                        document.getElementById('timeTaken').innerHTML = timer.getTotalMilliseconds() + "ms";
                        CubicVR.MainLoop(null);
                        window.eval(test);
                        return;
                    }
                    if (!timerMilliseconds)
                    {
                        timerMilliseconds = (new Date()).getTime();
                        return;
                    }

                    frameCounter++;

                    var newTimerMilliseconds = (new Date()).getTime();

                    timerLastSeconds = (newTimerMilliseconds-timerMilliseconds)/1000.0;

                    if (timerLastSeconds > (1/10)) timerLastSeconds = (1/10);

                    timerSeconds += timerLastSeconds;
                    timerMilliseconds = newTimerMilliseconds;

                    if (frameCounter%30==0)
                    {
                        fpsStr = ""+frameCounter/timerSeconds;
                        document.getElementById('fpsText').innerHTML=fpsStr.substring(0,6);
                        frameCounter=0;
                        timerSeconds=0;
                    }
                });
            }

        </script>
    </body>
</html>
