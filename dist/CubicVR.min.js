try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(m,x,z,q,r){function s(a,d){if(typeof a!=="object")return h("enumerator validation failed, invalid type base object."),r;if(d===r)return r;else if(typeof d==="number")return d;else if(typeof d==="string"){var b=parseInt(d,10);if(d!==""&&isFinite(b))return b;b=d.toUpperCase();b=a[b];if(b!==r)return b;else{h("enumerator validation failed, unknown enum value: "+d);var b="",f;for(f in a)a.hasOwnProperty(f)&&(b!==""&&(b+=", "),b+=f.toLowerCase());h("possible enum values are: "+b);return r}}else return r}
var c="";try{for(var g=x.querySelectorAll("script"),a=0,b=g.length;a<b;a++){var e=g[a].src.lastIndexOf("/CubicVR.js");e>-1&&(c=g[a].src.substr(0,e)+"/")}}catch(f){}var d=m.CubicVR={};d.contexts={};var h;try{h=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(n){h=q}var o={quality:{LOW:0,MEDIUM:1,HIGH:2}};m.cubicvr=o;var B={},y=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],w=function(a){var b=this,f;a&&(f=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,
get:function(){return f}}));b.undef=r;b.nop=q;b.scriptLocation=c;b.GLCore=e;b.Textures=[];b.Textures_obj=[];b.Textures_ref=[];b.Images=[];b.ShaderPool=[];b.log=h;b.enums=d.enums;b.MAX_LIGHTS=6;b.features={};b.quality=d.enums.HIGH;var n={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};b.features=
n.high;var e={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1};e.init=function(a,f,n){var o,g=b.util,w=d.enums;f&&n?(f=g.getScriptContents(f),n=g.getScriptContents(n)):m.CubicVRShader.CubicVRCoreVS&&m.CubicVRShader.CubicVRCoreFS?
(f=m.CubicVRShader.CubicVRCoreVS,n=m.CubicVRShader.CubicVRCoreFS):(f=g.getScriptContents(c+"CubicVR_Core.vs"),n=g.getScriptContents(c+"CubicVR_Core.fs"));if(a===r){a=x.createElement("canvas");if(!o)try{o=a.getContext("experimental-webgl",{antialias:b.features.antiAlias})}catch(B){return null}e.gl=o;if(e.fixed_size!==null)e.width=e.fixed_size[0],e.height=e.fixed_size[1],e.resizeElement(a,e.width,e.height);else if(e.addResizeable(a),e.canvasSizeFactor!==1&&a.getContext!==r){var g=z.round(m.innerWidth*
e.canvasSizeFactor),y=z.round(m.innerHeight*e.canvasSizeFactor);e.resizeElement(a,g,y);a.style.top=m.innerHeight/2-y/2+"px";a.style.left=m.innerWidth/2-g/2+"px";a.style.position="absolute"}else e.resizeElement(a,m.innerWidth,m.innerHeight);x.body.appendChild(a)}if(a.getContext!==r&&a.width!==r&&a.height!==r){try{o||(o=a.getContext("experimental-webgl",{antialias:b.features.antiAlias})),o.viewport(0,0,a.width,a.height),e.canvas=a,e.width=a.width,e.height=a.height,o.clearColor(0,0,0,1),o.clearDepth(1),
o.enable(o.DEPTH_TEST),o.depthFunc(o.LEQUAL)}catch(v){}if(!o)return null}else o=a;e.gl=o;e.CoreShader_vs=f;e.CoreShader_fs=n;o.enable(o.CULL_FACE);o.cullFace(o.BACK);o.frontFace(o.CCW);for(f=d.enums.light.type.NULL;f<w.light.type.MAX;f++)b.ShaderPool[f]=[];n=new b.Texture;a=new b.Material;for(f=0;f<w.texture.map.MAX;f++)f!==w.texture.map.BUMP&&a.setTexture(n,f);a.opacity=0.5;for(f=1;;){if(!a.use(w.light.type.POINT,f)||f===8){b.MAX_LIGHTS=f;break}f++}a=e.emptyLight=new b.Light(w.light.type.POINT);
a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;h("Calibrated maximum lights per pass to: "+f);for(f=w.light.type.NULL;f<w.light.type.MAX;f++)b.ShaderPool[f]=[];if(e.resizeList.length)m.addEventListener("resize",function(){b.GLCore.onResize()},!1),e.resize_active=!0;return o};e.addResizeable=function(a){b.GLCore.resizeList.push(a)};e.onResize=function(){var a=m.innerWidth,d=m.innerHeight;e.fixed_size!==null&&(a=b.GLCore.fixed_size[0],d=b.GLCore.fixed_size[1]);for(var f=
0,n=b.GLCore.resizeList.length;f<n;f++)e.resizeElement(b.GLCore.resizeList[f],a,d)};e.setFixedAspect=function(a){b.GLCore.fixed_aspect=a};e.setFixedSize=function(a,d){b.GLCore.fixed_size=[a,d]};e.getCanvas=function(){return b.GLCore.canvas};e.resizeElement=function(a,d,f){var n=e.gl;if(e.fixed_aspect!==0){var h=d*(1/b.GLCore.fixed_aspect);h>f&&(h=f,d=f*b.GLCore.fixed_aspect);f=h}if(a.getContext!==r){a.width=d;a.height=f;if(!b.GLCore.fixed_size)a.style.left=(m.innerWidth/2-d/2|0)+"px",a.style.top=
(m.innerHeight/2-f/2|0)+"px",a.style.position="absolute";n.viewport(0,0,d,f)}else a.resize(d,f)};e.setDepthAlpha=function(a,b,d){e.depth_alpha=a;e.depth_alpha_near=b;e.depth_alpha_far=d};e.setDefaultFilter=function(a){e.default_filter=s(b.enums.texture.filter,a)};e.setSoftShadows=function(a){e.soft_shadow=a};e.setFog=function(a){e.fog_enabled=a};e.setFogExp=function(a,b){e.fog_enabled=!0;e.fogLinear=!1;e.fogExp=!0;e.fogColor=a;e.fogDensity=b};e.setNoise=function(a){e.fogNoise=a};e.setFogLinear=function(a,
b,d){e.fog_enabled=!0;e.fogExp=!1;e.fogLinear=!0;e.fogColor=a;e.fogNear=b;e.fogFar=d};e.setCanvasSizeFactor=function(a){e.canvasSizeFactor=a};e.setQuality=function(a){a=s(o.quality,a);if(a===o.quality.HIGH)b.features=n.high;else if(a===o.quality.MEDIUM)b.features=n.medium;else if(a===o.quality.LOW)b.features=n.low;b.quality=a;return b.features};e.getQuality=function(){return b.features};var g=function(a,d,f){for(var n,h=x.getElementsByTagName("script"),o=0;o<h.length;++o){var c=h[o];if(c.getAttribute("data-cubicvr")){var g=
c.getAttribute("src");if(g){var w=new XMLHttpRequest;w.open("GET",g,!1);w.send(null);if(w.status===200||w.status===0)c.text=w.responseText}}}typeof a==="object"?a.getContext?n=a:(n=a.canvas,d=a.vertexShader||d,f=a.fragmentShader||f):a&&(a[0]=="#"&&(a=a.substr(1)),n=x.getElementById(a));for(var y in B){var a=B[y](b),v;for(v in a)a.hasOwnProperty(v)&&(b[v]=a[v])}e.init(n,d,f);return e.gl};b.GLCore=e;b.init=g;b.start=function(a,d,f,n,h){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=r);f=f||"Sorry, your browser does not appear to support WebGL :-(";
if(a=g(a,n,h))return d&&typeof d==="function"&&d(a,b.getCanvas()),a;if(!a)return f&&typeof f==="function"?f():alert(f),!1};b.addResizeable=e.addResizeable;b.setFixedAspect=e.setFixedAspect;b.setFixedSize=e.setFixedSize;b.setCanvasSizeFactor=e.setCanvasSizeFactor;b.getCanvas=e.getCanvas;b.enums=o;b.IdentityMatrix=y;b.Textures=b.Textures;b.Textures_obj=b.Textures_obj;b.Images=b.Images;b.globalAmbient=[0.1,0.1,0.1];b.setGlobalAmbient=function(a){b.globalAmbient=a};b.setGlobalDepthAlpha=e.setDepthAlpha;
b.setDefaultFilter=e.setDefaultFilter;b.setSoftShadows=e.setSoftShadows;b.setQuality=e.setQuality;b.getQuality=e.getQuality;b.RegisterModule=d.RegisterModule;b.getScriptLocation=d.getScriptLocation;b.setFogExp=e.setFogExp;b.setFogLinear=e.setFogLinear;b.setFogNoise=e.setFogNoise;b.parseEnum=s};d.init=function(a,b,f){var n;if(a&&a.context&&typeof a.context==="string")n=a.context;n=new w(n);return n.context?(d.contexts[n.context]=n,n.init(a,b,f),n):(m.CubicVR=d=n,n.init(a,b,f),n.GLCore.gl)};d.start=
function(a,b,f,n,h){var o=new w;m.CubicVR=d=o;o.start(a,b,f,n,h);return o};d.RegisterModule=function(a,b){B[a]=b};d.getScriptLocation=function(){return c};d.enums=o})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(m){function x(a){return this.clearStack(a)}function z(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var q=m.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=Math.PI/2,c={length:function(a){var b=a[0],e=a[1],a=a[2];return Math.sqrt(b*b+e*e+a*a)},normalize:function(a){var b=a[0],e=a[1],f=a[2];
if(b=Math.sqrt(b*b+e*e+f*f))return[a[0]/b,a[1]/b,a[2]/b];return[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,
b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===q&&(e=1.0E-7);if(a===q&&b===q)return!0;if(a===q||b===q)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,f,d){var h=Math.sqrt(e*e+f*f),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(f,e)+s;if(typeof d==="object")return[d[0]+h*Math.cos(b),d[1],d[2]+h*Math.sin(b)];return[a[0]+h*Math.cos(b),a[1],a[2]+h*Math.sin(b)]},trackTarget:function(a,b,e,f){var b=c.subtract(b,a),d=
c.length(b),h;h=c.normalize(b);h=c.multiply(h,e*(1/(1/(d-f))));d>f?a=c.add(a,h):d<f?(h=c.normalize(b),h=c.multiply(h,e*(1/(1/Math.abs(d-f)))),a=c.subtract(a,h)):a=[a[0],a[1]+h[2],a[2]];return a},getClosestTo:function(a,b,e){b=c.subtract(b,a);e=c.subtract(e,a);return c.add(c.multiply(b,c.dot(b,e)/c.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,f){var d=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(f[0]-e[0])+a[1]*(f[1]-e[1])+a[2]*(f[2]-e[2]);if(Math.abs(b)<0.001)return!1;a=-(d+a[0]*e[0]+a[1]*e[1]+a[2]*
e[2])/b;return[e[0]+a*(f[0]-e[0]),e[1]+a*(f[1]-e[1]),e[2]+a*(f[2]-e[2])]}},g={lookat:function(a,b,e,f,d,h,n,o,g){var y=[],w=[],v=[],w=[];y[0]=f-a;y[1]=d-b;y[2]=h-e;v[0]=n;v[1]=o;v[2]=g;y=c.normalize(y);w=c.cross(y,v);w=c.normalize(w);v=c.cross(w,y);w=[w[0],v[0],-y[0],0,w[1],v[1],-y[1],0,w[2],v[2],-y[2],0,0,0,0,1];f=new m.Transform(w);f.translate([-a,-b,-e]);return f.getResult()},multiply:function(a,b,e){e===q&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+
a[13]*b[3];e[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+
a[4]*b[13]+a[8]*b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===q&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===q&&(e=[]);e[0]=b[0]*a[0]+b[4]*
a[1]+b[8]*a[2]+b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,f){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(f+e)/(f-e),-1,0,0,-(2*f*e)/(f-e),0]},ortho:function(a,b,e,f,d,h){return[2/(b-a),0,0,0,0,2/(f-e),0,0,0,0,-2/(h-d),0,-(a+b)/(b-a),-(f+e)/(f-e),-(h+d)/(h-d),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-
a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],f=a[1],d=a[2],h=a[4],n=a[5],o=a[6],c=a[8],g=a[9],a=a[10],w=a*n-o*g,v=-a*h+o*c,A=g*h-n*c,m=e*w+f*v+d*A;if(!m)return null;m=1/m;b[0]=w*m;b[1]=(-a*
f+d*g)*m;b[2]=(o*f-d*n)*m;b[3]=v*m;b[4]=(a*e-d*c)*m;b[5]=(-o*e+d*h)*m;b[6]=A*m;b[7]=(-g*e+f*c)*m;b[8]=(n*e-f*h)*m;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],f=a[0]*a[6]-a[2]*a[4],d=a[0]*a[7]-a[3]*a[4],h=a[1]*a[6]-a[2]*a[5],n=a[1]*a[7]-a[3]*a[5],o=a[2]*a[7]-a[3]*a[6],c=a[8]*a[13]-a[9]*a[12],g=a[8]*a[14]-a[10]*a[12],w=a[8]*a[15]-a[11]*a[12],v=a[9]*a[14]-a[10]*a[13],A=a[9]*a[15]-a[11]*a[13],m=a[10]*a[15]-a[11]*a[14],r=e*m-f*A+d*v+h*w-n*g+o*c;if(r!==0)return b===q&&(b=[]),b[0]=0+a[5]*m-
a[6]*A+a[7]*v,b[4]=0-a[4]*m+a[6]*w-a[7]*g,b[8]=0+a[4]*A-a[5]*w+a[7]*c,b[12]=0-a[4]*v+a[5]*g-a[6]*c,b[1]=0-a[1]*m+a[2]*A-a[3]*v,b[5]=0+a[0]*m-a[2]*w+a[3]*g,b[9]=0-a[0]*A+a[1]*w-a[3]*c,b[13]=0+a[0]*v-a[1]*g+a[2]*c,b[2]=0+a[13]*o-a[14]*n+a[15]*h,b[6]=0-a[12]*o+a[14]*d-a[15]*f,b[10]=0+a[12]*n-a[13]*d+a[15]*e,b[14]=0-a[12]*h+a[13]*f-a[14]*e,b[3]=0-a[9]*o+a[10]*n-a[11]*h,b[7]=0+a[8]*o-a[10]*d+a[11]*f,b[11]=0-a[8]*n+a[9]*d-a[11]*e,b[15]=0+a[8]*h-a[9]*f+a[10]*e,e=1/r,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=
e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b;return null},identity:function(a){if(a==q)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,f){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(f===q)return a;g.multiply(f.slice(0),a,f)},rotateAxis:function(a,b,e,f,d){var h=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=
[a+b*b*(1-a),b*e*(1-a)-f*h,b*f*(1-a)+e*h,0,e*b*(1-a)+f*h,a+e*e*(1-a),e*f*(1-a)-b*h,0,f*b*(1-a)-e*h,f*e*(1-a)+b*h,a+f*f*(1-a),0,0,0,0,1];if(d===q)return b;g.multiply(d.slice(0),b,d)},rotate:function(a,b,e,f){var d;f===q&&(f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);e!==0&&(d=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),g.multiply(f.slice(0),[e,d,0,0,-d,e,0,0,0,0,1,0,0,0,0,1],f));b!==0&&(d=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),g.multiply(f.slice(0),[e,0,-d,0,0,1,0,0,d,0,e,0,0,0,0,
1],f));a!==0&&(d=Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),g.multiply(f.slice(0),[1,0,0,0,0,e,d,0,0,-d,e,0,0,0,0,1],f));return f},scale:function(a,b,e,f){if(f===q)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];g.multiply(f.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],f)},transform:function(a,b,e){var f=g.identity();a&&g.translate(a[0],a[1],a[2],f);b&&(b[0]===0&&b[1]===0&&b[2]===0||g.rotate(b[0],b[1],b[2],f));e&&(e[0]===1&&e[1]===1&&e[2]===1||g.scale(e[0],e[1],e[2],f));return f}};x.prototype={setIdentity:function(){this.m_stack[this.c_stack]=
[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=m.mat4;if(!this.c_stack)return this.m_stack[0];var b=r;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=
this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:r;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==q?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var f=m.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var d=this.getIdentity();d[12]=a;d[13]=b;d[14]=e;this.m_stack[this.c_stack]=
f.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var f=m.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);var d=this.getIdentity();d[0]=a;d[5]=b;d[10]=e;this.m_stack[this.c_stack]=f.multiply(this.m_stack[this.c_stack],d);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,f){var d=m.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],
0,0,1),this;var h,n;if(b||e||f)h=Math.sin(-a*(Math.PI/180)),n=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=n*b,a[9]=h*b,a[6]=-h*b,a[10]=n*b,this.m_stack[this.c_stack]=d.multiply(a,this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=n*e,b[8]=-h*e,b[2]=h*e,b[10]=n*e,this.m_stack[this.c_stack]=d.multiply(b,this.m_stack[this.c_stack]));f&&(e=this.getIdentity(),e[0]=n*f,e[4]=h*f,e[1]=-h*f,e[5]=n*f,this.m_stack[this.c_stack]=d.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&
this.c_stack&&this.valid--;return this}};z.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],e,f,d;b>1.0E-8?(e=Math.sqrt(b)*2,b=(a[9]-a[6])/e,f=(a[2]-a[8])/e,d=(a[4]-a[1])/e,a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=Math.sqrt(1+a[0]-a[5]-a[10])*2,b=0.25*e,f=(a[4]+a[1])/e,d=(a[2]+a[8])/e,a=(a[9]-a[6])/e):a[5]>a[10]?
(e=Math.sqrt(1+a[5]-a[0]-a[10])*2,b=(a[4]+a[1])/e,f=0.25*e,d=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=Math.sqrt(1+a[10]-a[0]-a[5])*2,b=(a[2]+a[8])/e,f=(a[9]+a[6])/e,d=0.25*e,a=(a[4]-a[1])/e);this.x=b;this.y=f;this.z=d;this.w=a},fromEuler:function(a,b,e){var f=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),d=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),h=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),n=f*d,o=b*e;this.w=n*h-o*a;this.x=n*a+o*h;this.y=b*d*h+f*e*a;this.z=f*e*h-b*d*a},toEuler:function(){var a=
this.w*this.w,b=this.x*this.x,e=this.y*this.y,f=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+f+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-f+a)]},multiply:function(a,b){b===q&&(b=a,a=this);return new z(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,e){e===q&&(e=1.0E-8);if(a===
q&&b===q)return!0;if(a===q||b===q)return!1;return Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e}},vec3:c,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],f=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=f},vec3_multiply:function(a,b,e){e===q&&(e=[]);e[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:g,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<
b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(e<0)return-1;else if(e>0)return 1;return 0},normalize:function(a){var b=
Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=m.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),f=a[3]+b[3];if(e*e<f*f)return!0;return!1}},triangle:{normal:function(a,b,e,f){f===q&&(f=[]);var d=a[0]-b[0],h=a[1]-b[1],a=a[2]-b[2],n=b[0]-e[0],o=b[1]-e[1],b=b[2]-e[2];f[0]=h*b-a*o;f[1]=a*n-d*b;f[2]=d*o-h*n;return f}},Transform:x,Quaternion:z}});
CubicVR.RegisterModule("Utility",function(m){var x=m.undef,z=m.log,q={},r={},s={multiSplit:function(c,g){for(var a=c.split(g[0]),b=1,e=g.length;b<e;b++)for(var f=g[b],d=0,h=a.length;d<h;d++){var n=a[d].trim().split(f),o=!0;if(n.length>1)for(var B=0;B<n.length;B++)n[B].trim()!==""&&(a.splice(d+B,B===0?1:0,n[B]),B&&h++,o=!1);else a[d]=a[d].trim().replace(f,""),a[d]!==""&&(o=!1);o&&(a.splice(d,1),h--,d--)}return a},getJSONScriptObj:function(c,g){if(typeof c==="string"&&c.length>0&&c.charAt(0)==="#"){var a=
document.getElementById(c.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return c},getScriptContents:function(c){var g=document.getElementById(c),a="",b="";if(g){if(g.src!==""||g.attributes.srcUrl!==x)b=g.src!==""?g.src:g.attributes.srcUrl.value}else b=c;if(b.length!==0){if(c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("application/json"),c.open("GET",b,!1),c.send(null),c.status===200||c.status===0)a=c.responseText}else for(b=g.firstChild;b;)b.nodeType===3&&(a+=b.textContent),
b=b.nextSibling;return a},xmlNeedsBadgerFish:function(c){for(c=[c];c.length;){var g=c.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,b=g.childNodes.length;a<b;a++)c.push(g.childNodes[a])}return!1},getFirstEntry:function(c){for(var g in c)if(c.hasOwnProperty(g))return c[g]},getURIFileType:function(c){function g(a){for(var b in e)if(e.hasOwnProperty(b)&&e[b].indexOf(a)!==-1)return b;return x}var a=c.toLowerCase(),b=["_ext","ext"],e={json:["js","javascript","json"],xml:["xml"]};if(a.indexOf("?")!==
-1){var f=a.split("?"),a=f[0];if(f[1])for(var f=f[1].indexOf("&")===-1?[f[1]]:f[1].split("&"),d=0,h=f.length;d<h;d++){var n=f[d];if(n.indexOf("=")!==-1&&(n=n.split("="),b.indexOf(n[0])!==-1)){var o=g(n[1]);if(o)return o;else z("Unable to determine extension type '"+n[1]+"' provided for URI: ["+c+"], falling back to filename part.")}}}if(a.indexOf(".")!==-1)return c=a.split("."),g(c[c.length-1]);return x},get:function(c,g){var a=null,b=null,e=null,g=g||null;if(c===x)return x;if(isFinite(c))return c;
typeof c==="function"&&(c=c(g));if(typeof c==="object"){if(g&&!(c instanceof g))return new g(c);return c}if(typeof c=="string"){if(c.indexOf("\n")!==-1)return c;else c[0]=="#"&&(a=c.substr(1),(e=document.getElementById(a))&&(b=e.src||null));!e&&!a&&!b&&c&&(b=c)}if(e&&!b)return CubicVR.util.collectTextNode(e);else if(b){var a=null,f=r[b]||null;if(!f){var d=s.getURIFileType(b);if(d===x&&!e)return b;d==="json"?f=CubicVR.util.getJSON(b):a=d==="xml"?CubicVR.util.getXML(b):CubicVR.util.getURL(b);a&&a.childNodes?
f=s.getFirstEntry(s.xml2json(a)):a&&(f=a)}f&&r[b]===x&&(r[b]=f);if(g)if(q[b]&&q[b]instanceof g)return q[b];else{if(f)return q[b]=new g(f),q[b]}else if(f)return f;return b}else return a&&!e&&console.log("Unable to retrieve requested ID: '"+c+"'"),x},clearCache:function(){q={};r={}},getURL:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.send(null);if(g.status===200||g.status===0)if(g.responseText.length)return g.responseText;else if(g.responseXML)return g.responseXML}catch(a){alert(c+
" failed to load.")}return null},getXML:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/xml");g.send(null);if(g.status===200||g.status===0)return g.responseXML}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;}}return null},getJSON:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/json");g.send(null);if(g.status===200||g.status===0)return eval("("+g.responseText+")")}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;
}}return null},repackArray:function(c,g,a){c.length!==parseInt(g,10)*parseInt(a,10)&&z("array repack error, data size !== stride*count: data.length="+c.length+" stride="+g+" count="+a);for(var a=[],b=0,e=0,f=c.length;e<f;e++){var d=e%g;d===0&&(a[b]=[]);a[b][d]=c[e];d===g-1&&b++}return a},collectTextNode:function(c){if(!c)return"";for(var g="",c=c.childNodes,a=0,b=c.length;a<b;a++)g+=c[a].nodeValue;return g},floatDelimArray:function(c,g){g!="\n"&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=
c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=parseFloat(a[b]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(c,g){g!="\n"&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=parseInt(a[b],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(c,g){g!="\n"&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=a[b];return a},xmlstring2json:function(c){for(var c=
c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],f={},d=f,h=0,n=c.length;h<n;h++){var o=c[h];if(!(g.test(o)||o==="")&&!/<\?\s?xml[^>]*>/.test(o))if(/<.*?>/.test(o)){a=o.split(/<([^>]*?)(.*)?>/g)[2];if(a[0]!=="/"&&(o=a.split(" "),a=o[0],o=o.slice(1).join(" "),b.push(a),e.push(f),f[a]&&!(f[a]instanceof Array)?f[a]=[f[a]]:(f[a]||(f[a]={}),f=f[a]),f instanceof Array&&(f.push({}),f=f[f.length-1]),a.substr(a.length-1)==="/"||o.substr(o.length-1)==="/"))a=
"/"+a;if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;else b.pop(),f=e.length?e[e.length-1]:null,e.pop()}else{var B=e[e.length-1][a];B instanceof Array?(B.pop(),B.push(s.parseNumeric(o))):e[e.length-1][a]=s.parseNumeric(o)}}return d},xmlstring2badgerfish:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],f={},d=f,h=0,n=c.length;h<n;h++)if(a=c[h],!(g.test(a)||a===
"")&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=a.split(/<([^>]*?)(.*)?>/g)[2];if(a[0]!=="/"){var o=a.split(" ");a=o[0];o=o.slice(1).join(" ");b.push(a);e.push(f);f[a]&&!(f[a]instanceof Array)?f[a]=[f[a]]:f[a]||(f[a]={});f=f[a];f instanceof Array&&(f.push({}),f=f[f.length-1]);if(a.substr(a.length-1)==="/"||o.substr(o.length-1)==="/")a="/"+a;for(var o=s.multiSplit(o,"= "),B="",y=0;y<o.length;y++){var w=o[y];w[w.length-1]==="/"&&(w=w.substr(0,w.length-1));if(y%2===1){if(w[0]==="'"||w[0]==='"'){for(var v=
w[0],w=w.substr(1);w[w.length-1]!==v&&o.length+1<y;)w+=o.splice(y+1,1);w[w.length-1]===v&&(w=w.substr(0,w.length-1))}f["@"+B]=w}else B=w}}if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+b[b.length-1]),!1;else b.pop(),f=e.length?e[e.length-1]:null,e.pop()}else f.$=a;return d},xml2badgerfish:function(c){var g={},a=[],b,e,f,d,h,n=/^\s+|\s+$/g;c.jsonParent=g;for(a.push(c);a.length;){e=a.pop();var o=null;f=e.jsonParent;c=0;for(b=e.childNodes.length;c<
b;c++)d=e.childNodes[c],h=d.tagName,h!==x&&(o=o||{},o[h]=o[h]||0,o[h]++);if(e.attributes&&e.attributes.length){c=0;for(b=e.attributes.length;c<b;c++)d=e.attributes[c],f["@"+d.name]=d.value}c=0;for(b=e.childNodes.length;c<b;c++)if(d=e.childNodes[c],h=d.tagName,d.nodeType===1)o[h]>1?(f[h]=f[h]||[],f[h].push({}),d.jsonParent=f[h][f[h].length-1]):(f[h]=f[h]||{},d.jsonParent=f[h]),a.push(d);else if(d.nodeType===3&&d.nodeValue.replace(n,"")!=="")f.$=f.$||"",f.$+=d.nodeValue}return g},isTextNode:function(c){for(var c=
c.childNodes,g=0,a=c.length;g<a;g++)if(c[g].nodeType!==3||c[g].childNodes.length)return!1;return!0},parseNumeric:function(c){var g=null,a,g=c.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(g==="")return g;if((g.indexOf(" ")!==-1||g.indexOf(",")!==-1)&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=
g.split(" ");c=0;for(a=g.length;c<a;c++)g[c]=s.floatDelimArray(g[c],",");return g}}else{g=g.split(" ");c=0;for(a=g.length;c<a;c++)g[c]=s.intDelimArray(g[c],",");return g}else return s.floatDelimArray(g,",");else return s.floatDelimArray(g," ");else return s.intDelimArray(g,",");else return s.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);if(!isNaN(a))return/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10);return c},xml2json:function(c){var g={},a=[],b,e,f,d,h;c.jsonParent=g;for(a.push(c);a.length;){e=
a.pop();var n=null;f=e.jsonParent;c=0;for(b=e.childNodes.length;c<b;c++)d=e.childNodes[c],h=d.tagName,h!==x&&(n=n||{},n[h]=n[h]||0,n[h]++);c=0;for(b=e.childNodes.length;c<b;c++){d=e.childNodes[c];h=d.tagName;var o=s.isTextNode(d);if(d.nodeType===1)n[h]>1?(f[h]=f[h]||[],o?f[h].push(s.parseNumeric(s.collectTextNode(d))):(f[h].push({}),d.jsonParent=f[h][f[h].length-1])):o?f[h]=s.parseNumeric(s.collectTextNode(d)):(f[h]=f[h]||{},d.jsonParent=f[h]),o||a.push(d)}}return g}};return{util:s,get:s.get,clearCache:s.clearCache}});
CubicVR.RegisterModule("COLLADA",function(m){function x(g,a){function b(a){if(!a.color)return!1;return(a=a.color)?f.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function e(a){var J;if(!a["float"])return!1;return J=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0,a=J}var f=m.util,d,h,n,o,B;B=typeof g=="object"?g:g.indexOf(".js")!=-1?f.getJSON(g):m.util.xml2badgerfish(f.getXML(g));var y,w,v,A,r,I,u,t,K,C,D,x=B;B=null;if(!x.COLLADA)throw Error(g+
" does not appear to be a valid COLLADA file.");x=x.COLLADA;B={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(x.asset){var H=x.asset.up_axis.$;if(H==="X_UP")B.up_axis=0;else if(H==="Y_UP")B.up_axis=1;else if(H==="Z_UP")B.up_axis=2}H=B.up_axis;if(x.library_images){if(x.library_images.image&&!x.library_images.image.length)x.library_images.image=[x.library_images.image];if(x.library_images.image.length){h=x.library_images.image;d=0;for(t=h.length;d<
t;d++){var F=h[d],E=F["@id"];A=F["@name"];F=F.init_from;if(F.$)F=F.$,a!==z&&F.lastIndexOf("/")!==-1&&(F=F.substr(F.lastIndexOf("/")+1)),a!==z&&F.lastIndexOf("\\")!==-1&&(F=F.substr(F.lastIndexOf("\\")+1)),B.images[E]={source:F,id:E,name:A}}}}var G,N,L,R,W;if(x.library_effects){var M=x.library_effects.effect;M&&!M.length&&(M=[M]);F=0;for(G=M.length;F<G;F++){t=M[F];A=t["@id"];o={};o.id=A;o.surfaces=[];o.samplers=[];(E=t.profile_COMMON.newparam)&&!E.length&&(E=[E]);if(E){h=0;for(d=E.length;h<d;h++){var P=
E[h],O=P["@sid"];if(P.surface){if(o.surfaces[O]={},P=P.surface.init_from.$,typeof B.images[P]==="object")o.surfaces[O].source=a+"/"+B.images[P].source}else if(P.sampler2D){o.samplers[O]={};o.samplers[O].source=P.sampler2D.source.$;if(P.sampler2D.minfilter)o.samplers[O].minfilter=P.sampler2D.minfilter.$;if(P.sampler2D.magfilter)o.samplers[O].magfiter=P.sampler2D.magfilter.$}}}(h=t.profile_COMMON.technique)&&!h.length&&(h=[h]);o.material={textures_ref:[]};t=0;for(E=h.length;t<E;t++){d=h[t].blinn;if(!d)d=
h[t].phong;if(!d)d=h[t].lambert;if(d)for(u in d){var S=d[u],O=b(S),P=e(S);S=S.texture?S.texture["@texture"]:!1;O!==!1&&O.length>3&&O.pop();if(u=="emission"){if(O!==!1)o.material.ambient=O}else if(u!="ambient")if(u=="diffuse"){if(O!==!1)o.material.color=O}else if(u=="specular"){if(O!==!1)o.material.specular=O}else if(u=="shininess"&&P!==!1)o.material.shininess=P;if(S!==!1)O=o.surfaces[o.samplers[S].source].source,u=="emission"?o.material.textures_ref.push({image:O,type:q.texture.map.AMBIENT}):u=="ambient"?
o.material.textures_ref.push({image:O,type:q.texture.map.AMBIENT}):u=="diffuse"?o.material.textures_ref.push({image:O,type:q.texture.map.COLOR}):u=="specular"?o.material.textures_ref.push({image:O,type:q.texture.map.SPECULAR}):u!="shininess"&&(u=="reflective"?o.material.textures_ref.push({image:O,type:q.texture.map.REFLECT}):u!="reflectivity"&&u=="transparent"&&o.material.textures_ref.push({image:O,type:q.texture.map.ALPHA}))}B.effects[A]=o}}}t=c.getAllOf(x,"instance_geometry");u=[];if(t.length){d=
0;for(h=t.length;d<h;d++)if(E=t[d],A=c.getAllOf(E,"instance_material"),A.length){D=0;for(I=A.length;D<I;D++)G=A[D],F=G["@symbol"],G=G["@target"].substr(1),u[E["@url"].substr(1)+":"+F]=G}}if((h=x.library_materials)&&h.material){(t=h.material)&&!t.length&&(t=[t]);h=0;for(d=t.length;h<d;h++)if(A=t[h],E=A["@id"],F=A["@name"],A=A.instance_effect)A=A["@url"].substr(1),B.materials.push({id:E,name:F,mat:B.effects[A].material})}h=x.library_geometries;var Y;if(h&&((A=h.geometry)&&!A.length&&(A=[A]),A.length)){F=
0;for(G=A.length;F<G;F++){var M={id:z,points:[],parts:[]},Z=A[F].mesh;if(Z){Y=A[F]["@id"];o=A[F]["@name"];(d=Z.source)&&!d.length&&(d=[d]);o=[];t=0;for(E=d.length;t<E;t++)if(O=d[t],h=O["@id"],P=O["@name"],(S=O.float_array)&&(o[h]={id:h,name:P,data:f.floatDelimArray(S.$?S.$:""," ")}),O=O.technique_common.accessor)if(o[h].count=O["@count"]|0,o[h].stride=O["@stride"]|0,o[h].count)o[h].data=f.repackArray(o[h].data,o[h].stride,o[h].count);h=Z.vertices;var Q=S=P=O=null,$=null;if(h&&(P=h["@id"],(d=h.input)&&
!d.length&&(d=[d]),d)){v=0;for(N=d.length;v<N;v++)L=d[v],L["@semantic"]==="POSITION"&&(O=L["@source"].substr(1))}var T=Z.triangles;T&&!T.length&&(T=[T]);if(T){t=0;for(E=T.length;t<E;t++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};h=parseInt(T[t]["@count"],10);(d=T[t].input)&&!d.length&&(d=[d]);R=[];if(d.length){v=0;for(N=d.length;v<N;v++)L=d[v],r=parseInt(L["@offset"],10),n=L["@source"].substr(1),L["@semantic"]==="VERTEX"?(n===P&&(n=O),R[r]=0):L["@semantic"]==="NORMAL"?(S=n,o[S].count&&
(R[r]=1)):L["@semantic"]==="TEXCOORD"?($=n,o[$].count&&(R[r]=2)):L["@semantic"]==="COLOR"?(Q=n,o[Q].count&&(R[r]=3)):R[r]=4}v=R.length;d=Y+":"+T[t]["@material"];d===null?W.material=0:u[d]===z?(s("missing material ["+d+"]@"+Y+"?"),W.material=0):W.material=u[d];d=T[t].p;v=[];d&&(v=f.intDelimArray(d.$," "));if(v.length&&(d=v.length/R.length/3,d===h)){if(M.points.length===0)M.points=o[O].data;d=r=0;h=v.length;for(r=R.length;d<h;d+=r*3){y=[];w=[];n=[];L=[];for(D=0;D<r*3;D++)N=D%r,R[N]===0?w.push(v[d+D]):
R[N]===1?y.push(v[d+D]):R[N]===2?n.push(v[d+D]):R[N]===3&&L.push(v[d+D]);w.length&&(W.faces.push(w),y.length===3&&W.normals.push([c.fixuaxis(B.up_axis,o[S].data[y[0]]),c.fixuaxis(B.up_axis,o[S].data[y[1]]),c.fixuaxis(B.up_axis,o[S].data[y[2]])]),n.length===3&&W.texcoords.push([o[$].data[n[0]],o[$].data[n[1]],o[$].data[n[2]]]),L.length===3&&W.colors.push([o[Q].data[L[0]],o[Q].data[L[1]],o[Q].data[L[2]]]))}}M.parts.push(W)}}T=Z.polylist;if(!T)T=Z.polygons;T&&!T.length&&(T=[T]);if(T){t=0;for(E=T.length;t<
E;t++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};D=parseInt(T[t]["@count"],10);(d=T[t].input)&&!d.length&&(d=[d]);R=[];if(d.length){v=0;for(N=d.length;v<N;v++)L=d[v],h=L["@offset"],h===null&&(h=L["@idx"]),r=parseInt(h,10),n=L["@source"].substr(1),L["@semantic"]==="VERTEX"?(n===P&&(n=O),R[r]=0):L["@semantic"]==="NORMAL"?(S=n,R[r]=1):L["@semantic"]==="TEXCOORD"?($=n,R[r]=2):L["@semantic"]==="COLOR"?(Q=n,R[r]=3):R[r]=4}h=T[t].vcount;Z=[];h&&(Z=f.intDelimArray(h.$," "));d=Y+":"+T[t]["@material"];
W.material=d===z?0:u[d];L=T[t].p;v=R.length;N=[];if(L.length>1&&!Z.length){h=0;for(d=L.length;h<d;h++)r=f.intDelimArray(L[h].$," "),Z[h]=parseInt(r.length/v,10),N=N.concat(r)}else L&&(N=f.intDelimArray(L.$," "));if(N.length)if(d=Z.length,d!==D)s("poly vcount data doesn't add up, skipping object load: "+d+" !== "+D);else{if(M.points.length===0)M.points=o[O].data;d=r=0;for(h=Z.length;d<h;d++){y=[];w=[];n=[];L=[];D=0;for(I=Z[d]*v;D<I;D++)R[D%v]===0?w.push(N[r]):R[D%v]===1?y.push(N[r]):R[D%v]===2?n.push(N[r]):
R[D%v]===3&&L.push(N[r]),r++;if(w.length){W.faces.push(w);if(y.length){D=[];I=0;for(w=y.length;I<w;I++)D.push(c.fixuaxis(B.up_axis,o[S].data[y[I]]));W.normals.push(D)}if(n.length){D=[];I=0;for(w=n.length;I<w;I++)D.push(o[$].data[n[I]]);W.texcoords.push(D)}if(L.length){D=[];I=0;for(w=L.length;I<w;I++)D.push(o[Q].data[L[I]]);W.colors.push(D)}}}}M.parts.push(W)}}if(H!==1){d=0;for(h=M.points.length;d<h;d++)M.points[d]=c.fixuaxis(B.up_axis,M.points[d])}M.id=Y;B.meshes.push(M)}}}if(h=x.library_cameras){(A=
h.camera)&&!A.length&&(A=[A]);u=0;for(t=A.length;u<t;u++){h=A[u];F=h["@id"];G=E=d=0;if(h.optics&&h.optics.technique_common&&h.optics.technique_common.perspective)d=h.optics.technique_common.perspective.yfov,E=h.optics.technique_common.perspective.znear,G=h.optics.technique_common.perspective.zfar;var V;if(!d&&!E&&!G){(E=h.param)&&!E.length&&(E=[E]);d=0;for(h=E.length;d<h;d++)G=E[d].$,M=E[d]["@name"],M=="YFOV"?V=parseFloat(G):M=="ZNEAR"?K=parseFloat(G):M=="ZFAR"&&(C=parseFloat(G))}else V=d?parseFloat(d.$):
60,K=E?parseFloat(E.$):0.1,C=G?parseFloat(G.$):1E3;B.cameras.push({id:F,targeted:!1,fov:parseFloat(V),nearclip:parseFloat(K),farclip:parseFloat(C)})}}if(V=x.library_lights)if((V=V.light)&&!V.length&&(V=[V]),V){K=0;for(C=V.length;K<C;K++)if(d=V[K],u=(h=d.technique_common.point)?h:null,h=d["@id"],u!==null)d=(d=u.intensity)?parseFloat(d.$):1,t=(t=u.distance)?parseFloat(t.$):10,u=u.color,L=[1,1,1],u&&(L=f.floatDelimArray(u.$," ")),B.lights.push({id:h,name:h,type:q.light.type.POINT,method:q.light.method.STATIC,
diffuse:L,specular:[0,0,0],distance:t,intensity:d})}if(K=x.library_visual_scenes){V=null;(V=K.visual_scene)&&!V.length&&(V=[V]);K=0;for(C=V.length;K<C;K++){A=V[K];u={id:A["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};t=[];var E=[],X;if(h=x.library_nodes){(G=h.node)&&!G.length&&(G=[G]);t=[];d=0;for(h=G.length;d<h;d++)F=G[d],mnodeId=F["@id"],t[X]=F;for(F=[A];F.length;){G=F.pop();if(G.node&&((D=G.node)&&!D.length&&(D=[D]),D)){d=0;for(h=D.length;d<h;d++)F.push(D[d])}if(G.instance_node){(M=
G.instance_node)&&!M.length&&(M=[M]);d=0;for(h=M.length;d<h;d++)if(o=M[d]["@url"].substr(1),t[o]){if(G.node&&G.node.length)G.node=[G.node];G.node?G.node.push(t[o]):G.node=[t[o]]}}}}for(F=[A];F.length;)if(G=F.pop(),G.node&&((D=G.node)&&!D.length&&(D=[D]),D)){d=0;for(h=D.length;d<h;d++)D[d].parentNode=G,E.push(D[d]),F.push(D[d])}if(E.length){A=0;for(F=E.length;A<F;A++){O=E[A];P=O.instance_geometry;d=E[A].instance_light;h=E[A].instance_camera;X=O["@id"];G=O["@name"];M=c.cl_getInitalTransform(B.up_axis,
O);if(H===2)M.rotation=c.quaternionFilterZYYZ(M.rotation,h?[-90,0,0]:z);Q=S=null;if(P){P&&!P.length&&(P=[P]);d=0;for(h=P.length;d<h;d++){o=P[d]["@url"].substr(1);Q={};Q.name=(G?G:X)+(d?d:"");Q.id=(X?X:G)+(d?d:"");Q.meshId=Y;Q.meshName=o;if(!S)Q.position=M.position,Q.rotation=M.rotation,Q.scale=M.scale,Q.matrix=M.matrix;u.sceneObjects.push(Q);t[Q.id]=!0;O.parentNode&&((o=O.parentNode["@id"])&&t[o]?u.parentMap.push({parent:o,child:Q.id}):P.length>1&&(S?t[S.id]&&u.parentMap.push({parent:S.id,child:Q.id}):
(S=Q,Q={})))}}else h?(h=h["@url"].substr(1),u.cameras.push({name:G?G:X,id:G?G:X,source:h,position:M.position,rotation:M.rotation})):d?(h=d["@url"].substr(1),u.lights.push({name:G?G:X,id:G?G:X,source:h,position:M.position})):(Q={position:M.position,rotation:M.rotation,scale:M.scale,matrix:M.matrix},Q.name=G?G:X,Q.id=X?X:G,u.sceneObjects.push(Q),t[Q.id]=!0,O.parentNode&&(o=O.parentNode["@id"])&&t[o]&&u.parentMap.push({parent:o,child:Q.id}))}}B.scenes.push(u)}}if(Y=x.library_animations)if((X=Y.animation)&&
!X.length&&(X=[X]),X){H=0;for(V=X.length;H<V;H++){u=X[H];Y=u["@id"];B.animations[Y]={};B.animations[Y].sources=[];(t=u.source)&&!t.length&&(t=[t]);if(t.length){K=0;for(C=t.length;K<C;K++){d=t[K];h=d["@id"];M=d.technique_common;A=E=null;d.name_array?E=f.textDelimArray(d.name_array.$," "):d.Name_array?E=f.textDelimArray(d.Name_array.$," "):d.float_array&&(A=f.floatDelimArray(d.float_array.$," "));d=0;G="";F=1;if(M)d=M,M=d.accessor,d=parseInt(M["@count"],10),G=M["@source"].substr(1),(M=M["@stride"])&&
(F=parseInt(M,10));B.animations[Y].sources[h]={data:E?E:A,count:d,source:G,stride:F};if(F!==1)B.animations[Y].sources[h].data=f.repackArray(B.animations[Y].sources[h].data,F,d)}}(t=u.sampler)&&!t.length&&(t=[t]);if(t){B.animations[Y].samplers=[];K=0;for(C=t.length;K<C;K++)if(h=t[K],E=h["@id"],(d=h.input)&&!d.length&&(d=[d]),d){F=[];A=0;for(h=d.length;A<h;A++)L=d[A],F[L["@semantic"]]=L["@source"].substr(1);B.animations[Y].samplers[E]=F}}(K=u.channel)&&!K.length&&(K=[K]);if(K){B.animations[Y].channels=
[];u=0;for(t=K.length;u<t;u++)h=K[u],C=h["@source"].substr(1),h=h["@target"],E=h.split("/"),d=E[0],E=E[1].split("."),B.animations[Y].channels.push({source:C,target:h,targetName:d,paramName:E[0],typeName:E[1]})}}}if(x=x.scene)if(A=x.instance_visual_scene)x=A["@url"].substr(1),B.scene=x;return B}var z=m.undef,q=m.enums,r=m.GLCore,s=m.log,c={fixuaxis:function(c,a){if(c===0)return[a[1],a[0],a[2]];else if(c===1)return a;else if(c===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(c,a){if(c===0)return[a[1],
a[0],a[2]];else if(c===1)return a;else if(c===2)return[a[0],a[2],a[1]]},fixukaxis:function(c,a,b,e){if(a===q.motion.POS&&b===q.motion.Z&&c===q.motion.Z)return-e;return e},getAllOf:function(c,a){for(var b=[c],e=[],f,d,h,n;b.length;)for(d in f=b.pop(),f)if(f.hasOwnProperty(d)){if(d===a)if(f[d].length){h=0;for(n=f[d].length;h<n;h++)e.push(f[d][h])}else e.push(f[d]);if(typeof f[d]=="object")if(f[d].length){h=0;for(n=f[d].length;h<n;h++)b.push(f[d][h])}else b.push(f[d])}return e},quaternionFilterZYYZ:function(c,
a){var b=m.vec3,e=c,f=new m.Quaternion;a!==z&&(e=b.add(c,a));f.fromEuler(e[0],e[2],-e[1]);return f.toEuler()},cl_getInitalTransform:function(g,a){var b=m.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},f=a.translate,d=a.rotate,h=a.scale;if(a.matrix&&!f&&!d&&!h)return e;if(f&&f.$)e.position=c.fixuaxis(g,b.floatDelimArray(f.$," "));if(d)for(var f=0,n=d.length;f<n;f++){var o=d[f],B=o["@sid"],o=b.floatDelimArray(o.$," ");if(B=="rotateX"||B=="rotationX")e.rotation[0]=o[3];else if(B=="rotateY"||
B=="rotationY")e.rotation[1]=o[3];else if(B=="rotateZ"||B=="rotationZ")e.rotation[2]=o[3]}if(h)e.scale=c.fixscaleaxis(g,b.floatDelimArray(h.$," "));return e}};return{loadCollada:function(g,a,b){var a=x(g,a,b),e=a.up_axis,f=[],d,h,n,o,B,y,w,v;h=0;for(n=a.materials.length;h<n;h++){B=a.materials[h];w=new m.Material(B.mat);w.name=B.name||null;y=0;for(o=B.mat.textures_ref.length;y<o;y++){v=B.mat.textures_ref[y];var A=null,A=m.Textures_ref[v.image]===void 0?new m.Texture(v.image,r.default_filter,b,g):m.Textures_obj[m.Textures_ref[v.image]];
w.setTexture(A,v.type)}f[B.id]=w}y=[];h=0;for(n=a.meshes.length;h<n;h++){var A=a.meshes[h],J=new m.Mesh({name:A.id});J.points=A.points;var s=!1;w=0;for(v=A.parts.length;w<v;w++){var u=A.parts[w];u.material!==0&&((o=f[u.material])||(o=new m.Material({name:u.material})),J.setFaceMaterial(o));var t=u.normals.length?!0:!1,K=u.texcoords.length?!0:!1,C=u.colors.length?!0:!1;if(C)f[u.material].color_map=!0;o=0;for(B=u.faces.length;o<B;o++){var D=J.addFace(u.faces[o]);if(t)J.faces[D].point_normals=u.normals[o];
if(K)J.faces[D].uvs=u.texcoords[o];if(C)J.faces[D].point_colors=u.colors[o]}s|=t}J.faces.length&&(b?b.addMesh(g,g+":"+meshId,J):(s||J.calcNormals(),J.triangulateQuads(),J.compile()),y[A.id]=J)}n=[];g=0;for(o=a.cameras.length;g<o;g++)n[a.cameras[g].id]=a.cameras[g];A=[];o=0;for(B=a.lights.length;o<B;o++)A[a.lights[o].id]=a.lights[o];b={};f={};h={};g={};w=0;for(v=a.scenes.length;w<v;w++){J=a.scenes[w];s=new m.Scene;o=0;for(B=J.sceneObjects.length;o<B;o++)u=J.sceneObjects[o],t=new m.SceneObject(u),t.obj=
(y[u.meshName]?y[u.meshName]:y[u.meshId])||null,u.matrix&&t.setMatrix(u.matrix),b[u.id]=t,s.bindSceneObject(t);o=0;for(B=J.lights.length;o<B;o++)u=J.lights[o],t=new m.Light(A[u.source]),t.position=u.position,f[u.id]=t,s.bindLight(t);if(J.cameras.length)o=J.cameras[0],B=new m.Camera(n[o.source]),B.position=o.position,B.rotation=o.rotation,h[o.id]=B,s.camera=B;o=0;for(B=J.parentMap.length;o<B;o++)u=J.parentMap[o],b[u.parent].bindChild(b[u.child]);g[J.id]=s}for(var U in a.animations)if(a.animations.hasOwnProperty(U)&&
(y=a.animations[U],y.channels.length)){cCount=0;for(o=y.channels.length;cCount<o;cCount++){n=y.channels[cCount];u=y.samplers[n.source];B=y.sources[u.INPUT];w=y.sources[u.OUTPUT];v=y.sources[u.INTERPOLATION];var A=y.sources[u.IN_TANGENT],J=y.sources[u.OUT_TANGENT],s=u.IN_TANGENT!==z,u=u.OUT_TANGENT!==z,t=null,C=b[n.targetName],K=h[n.targetName],H=f[n.targetName];if(C){if(C.motion===null)C.motion=new m.Motion;t=C.motion}else if(K){if(K.motion===null)K.motion=new m.Motion;t=K.motion}else if(H){if(H.motion===
null)H.motion=new m.Motion;t=H.motion}if(t!==null){C=q.motion.POS;D=q.motion.X;if(e===2)t.yzflip=!0;d=n.paramName;if(d==="rotateX"||d==="rotationX")C=q.motion.ROT,D=q.motion.X;else if(d==="rotateY"||d==="rotationY")C=q.motion.ROT,D=q.motion.Y;else if(d==="rotateZ"||d==="rotationZ")C=q.motion.ROT,D=q.motion.Z;else if(d==="location"){C=q.motion.POS;if(n.typeName==="X")D=q.motion.X;if(n.typeName==="Y")D=q.motion.Y;if(n.typeName==="Z")D=q.motion.Z}else if(d==="translate"){C=q.motion.POS;if(n.typeName===
"X")D=q.motion.X;if(n.typeName==="Y")D=q.motion.Y;if(n.typeName==="Z")D=q.motion.Z}else if(d==="LENS")continue;else if(d==="FOV")C=q.motion.FOV,D=3;else if(d==="ZNEAR")C=q.motion.NEARCLIP,D=3;else if(d==="ZFAR")C=q.motion.FARCLIP,D=3;else if(d==="intensity")C=q.motion.INTENSITY,D=3;if(H&&C<3)H.method=q.light.method.DYNAMIC;mCount=0;for(n=B.data.length;mCount<n;mCount++)if(k=null,typeof w.data[mCount]==="object"){i=0;for(iMax=w.data[mCount].length;i<iMax;i++)if(H=i,e===2&&i===2?H=1:e===2&&i===1&&(H=
2),k=t.setKey(C,H,B.data[mCount],c.fixukaxis(a.up_axis,C,H,w.data[mCount][i])),v)if(d=v.data[mCount][i],d==="LINEAR")k.shape=q.envelope.shape.LINE;else if(d==="BEZIER")k.shape=!s&&!u?q.envelope.shape.LINEAR:q.envelope.shape.BEZI}else if(H=D,ofs=0,K&&C===q.motion.ROT&&e===2&&H===0&&(ofs=-90),C===q.motion.ROT?k=t.setKey(C,H,B.data[mCount],w.data[mCount]+ofs):(e===2&&D===2?H=1:e===2&&D===1&&(H=2),k=t.setKey(C,H,B.data[mCount],c.fixukaxis(a.up_axis,C,H,w.data[mCount]))),v)if(d=v.data[mCount],d==="LINEAR")k.shape=
q.envelope.shape.LINE;else if(d==="BEZIER")if(!s&&!u)k.shape=q.envelope.shape.LINEAR,k.continutity=1;else{k.shape=q.envelope.shape.BEZ2;d=A.data[mCount][0];var F,E=J.data[mCount][0];C===q.motion.ROT?(F=A.data[mCount][1],H=J.data[mCount][1],k.param[0]=d-k.time,k.param[1]=F-k.value+ofs,k.param[2]=E-k.time,k.param[3]=H-k.value+ofs):(F=c.fixukaxis(a.up_axis,C,H,A.data[mCount][1]),H=c.fixukaxis(a.up_axis,C,H,J.data[mCount][1]),k.param[0]=d-k.time,k.param[1]=F-k.value,k.param[2]=E-k.time,k.param[3]=H-k.value)}}}}U=
null;return U=a.scene?g[a.scene]:g.pop()},parseCollada:x}});
CubicVR.RegisterModule("CVRXML",function(m){function x(a,f,d,h){var n=CubicVR.util,o=null,c=null;h.triangles&&(c=n.intDelimArray(b.getTextNode(h,"triangles")," "));if(c&&(h.segments&&(o=n.intDelimArray(b.getTextNode(h,"segments")," ")),o===null&&(o=[0,parseInt(c.length/3,10)]),h=0,a.setFaceMaterial(f),c.length)){p=0;for(pMax=o.length;p<pMax;p+=2){f=o[p+1]*3;a.setSegment(o[p]);j=h;for(jMax=h+f;j<jMax;j+=3)n=a.addFace([c[j],c[j+1],c[j+2]]),d&&a.faces[n].setUV([d[j],d[j+1],d[j+2]]);h+=f}}}function z(a){var f=
CubicVR.util,d=new CubicVR.UVMapper,h=null,n=null;if(a.type)switch(h=b.getTextNode(a,"type"),h){case "planar":d.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":d.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":d.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":d.projection_mode=g.uv.projection.CUBIC}if(!h)return null;h==="uv"&&a.uv&&(n=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":d.projection_axis=g.uv.axis.X;break;case "y":d.projection_axis=
g.uv.axis.Y;break;case "z":d.projection_axis=g.uv.axis.Z}if(a.center)d.center=f.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)d.rotation=f.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)d.scale=f.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)d.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)d.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return h!==""&&h!=="uv"?d:n}function q(e,f){if(a[e]!==c)return a[e];var d=CubicVR.util,h,n,o,B;h=null;h=typeof e==
"object"?e:e.indexOf(".js")!=-1?d.getJSON(e):CubicVR.util.xml2badgerfish(d.getXML(e));if(h.root)h=h.root;if(h.properties)h=h.properties;d=new CubicVR.Mesh;h.points&&(o=b.getPoints(h,"points"))&&d.addPoint(o);var y=h.material;y&&!y.length&&(y=[y]);var w=[];if(y){h=0;for(o=y.length;h<o;h++){var v=y[h],A;A=v;var r=f,q=new CubicVR.Material({name:A.name?A.name.$:null});if(A.shininess)q.shininess=b.getFloatNode(A,"shininess",q.shininess)/100;q.opacity=b.getFloatNode(A,"alpha",q.opacity);q.max_smooth=b.getFloatNode(A,
"max_smooth",q.max_smooth);q.color=b.getFloatDelimNode(A,"color",q.color);q.ambient=b.getFloatDelimNode(A,"ambient",q.ambient);q.diffuse=b.getFloatDelimNode(A,"diffuse",q.diffuse);q.specular=b.getFloatDelimNode(A,"specular",q.specular);n=void 0;if(n=b.getTextNode(A,"texture"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.COLOR);if(n=b.getTextNode(A,"texture_luminosity"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:
new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.AMBIENT);if(n=b.getTextNode(A,"texture_normal"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.NORMAL);if(n=b.getTextNode(A,"texture_specular"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.SPECULAR);if(n=b.getTextNode(A,"texture_bump"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:
new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.BUMP);if(n=b.getTextNode(A,"texture_envsphere"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.ENVSPHERE);if(n=b.getTextNode(A,"texture_alpha"))n=(r?r:"")+n,tex=m.Textures_ref[n]!==c?m.Textures_obj[m.Textures_ref[n]]:new CubicVR.Texture(n),q.setTexture(tex,g.texture.map.ALPHA);A=q;var u=null;n=r=null;v.uvmapper&&((r=z(v.uvmapper))&&!r.length?w.push([r,A]):n=r);(q=v.part)&&
!q.length&&(q=[q]);if(q&&q.length){var t=null,s=null;n=0;for(B=q.length;n<B;n++){var C=q[n],t=null;if(u=C.uvmapper)if(t=z(u),v.triangles)s=u=d.faces.length,t&&!t.length?(x(d,A,null,C),s=d.faces.length-1,d.calcFaceNormals(u,s),t.apply(d,A,c,u,s)):t&&t.length?x(d,A,t,C):r&&!r.length&&(x(d,A,null,C),s=d.faces.length-1,d.calcFaceNormals(u,s),r.apply(d,A,c,u,s));if(C.procedural){(u=C.uvmapper)&&(t=z(u));var s=C.transform?b.getTransform(C.transform):c,u=c,C=C.procedural,D=b.getTextNode(C,"type");s&&(u=
new CubicVR.Transform,u.translate(s.position),u.pushMatrix(),u.rotate(s.rotation),u.pushMatrix(),u.scale(s.scale));r||(r=c);t={material:A,uvmapper:r||t};if(D==="box"||D==="cube")t.size=b.getFloatNode(C,"size"),d.booleanAdd(CubicVR.primitives.box(t),u);else if(D==="sphere")t.radius=b.getFloatNode(C,"radius"),t.lat=b.getIntNode(C,"lat"),t.lon=b.getIntNode(C,"lon"),d.booleanAdd(CubicVR.primitives.sphere(t),u);else if(D==="cone")t.base=b.getFloatNode(C,"base"),t.height=b.getFloatNode(C,"height"),t.lon=
b.getIntNode(C,"lon"),d.booleanAdd(CubicVR.primitives.cone(t),u);else if(D==="plane")t.size=b.getFloatNode(C,"size"),d.booleanAdd(CubicVR.primitives.plane(t),u);else if(D==="cylinder")t.radius=b.getFloatNode(C,"radius"),t.height=b.getFloatNode(C,"height"),t.lon=b.getIntNode(C,"lon"),d.booleanAdd(CubicVR.primitives.cylinder(t),u);else if(D==="torus")t.innerRadius=b.getFloatNode(C,"innerRadius"),t.outerRadius=b.getFloatNode(C,"outerRadius"),t.lat=b.getIntNode(C,"lat"),t.lon=b.getIntNode(C,"lon"),d.booleanAdd(CubicVR.primitives.torus(t),
u);else if(D==="lathe")t.points=b.getPoints(C,"p"),t.lon=b.getIntNode(C,"lon"),d.booleanAdd(CubicVR.primitives.lathe(t),u);else if(D==="polygon"){s=b.getPoints(C,"p");s=new CubicVR.Polygon(s);(D=C.cut)&&!D.length&&(D=[D]);if(D.length){n=0;for(o=D.length;n<B;n++)s.cut(new CubicVR.Polygon(b.getPoints(D[n])))}t.front=0;t.back=0;t.frontShift=0;t.backShift=0;t.frontDepth=0;t.backDepth=0;if(C.extrude){C=C.extrude;t.front=b.getFloatNode(C,"front",0);t.back=b.getFloatNode(C,"back",0);t.frontShift=b.getFloatNode(C,
"frontBevelShift",0);t.backShift=b.getFloatNode(C,"backBevelShift",0);t.frontDepth=b.getFloatNode(C,"frontBevelDepth",0);t.backDepth=b.getFloatNode(C,"backBevelDepth",0);t.depth=b.getFloatNode(C,"depth",0);t.shift=b.getFloatNode(C,"shift",0);t.bevel=b.getFloatNode(C,"bevel",0);if(t.depth&&!t.backDepth&&!t.frontDepth)t.front=-t.depth/2,t.back=t.depth/2;if(t.shift&&!t.backShift&&!t.frontShift)t.frontShift=t.shift,t.backShift=t.shift;if(t.bevel&&!t.backDepth&&!t.frontDepth)t.frontDepth=t.bevel,t.backDepth=
t.bevel}C=s.toExtrudedBeveledMesh(new CubicVR.Mesh,t);C.setFaceMaterial(t.material);d.booleanAdd(C,u)}}}}else x(d,A,n,v)}}d.triangulateQuads();d.calcNormals();h=0;for(o=w.length;h<o;h++)w[h][0].apply(d,w[h][1]);d.compile();return a[e]=d}function r(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function s(a,b,d){var h=CubicVR.util,n=[];n[0]=a.getElementsByTagName("x");n[1]=
a.getElementsByTagName("y");n[2]=a.getElementsByTagName("z");n[3]=a.getElementsByTagName("fov");var o,B,y,w,v,A;for(A in n)if(n.hasOwnProperty(A)&&n[A]!==c&&n[A].length){o=n[A][0].getElementsByTagName("time");B=n[A][0].getElementsByTagName("value");y=n[A][0].getElementsByTagName("in");w=n[A][0].getElementsByTagName("out");v=n[A][0].getElementsByTagName("tcb");var m=null,r=null,q=null,t=a=null;y.length&&(a=h.collectTextNode(y[0]));w.length&&(t=h.collectTextNode(w[0]));o.length&&(m=h.floatDelimArray(h.collectTextNode(o[0]),
" "));B.length&&(r=h.floatDelimArray(h.collectTextNode(B[0])," "));v.length&&(q=h.floatDelimArray(h.collectTextNode(v[0])," "));if(m!==null&&r!==null){o=0;for(B=m.length;o<B;o++)if(y=d.setKey(b,A,m[o],r[o]),q)y.tension=q[o*3],y.continuity=q[o*3+1],y.bias=q[o*3+2]}r=m=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":m=g.envelope.behavior.RESET;break;case "constant":m=g.envelope.behavior.CONSTANT;break;case "repeat":m=g.envelope.behavior.REPEAT;break;case "oscillate":m=g.envelope.behavior.OSCILLATE;
break;case "offset":m=g.envelope.behavior.OFFSET;break;case "linear":m=g.envelope.behavior.LINEAR}if(t)switch(t){case "reset":r=g.envelope.behavior.RESET;break;case "constant":r=g.envelope.behavior.CONSTANT;break;case "repeat":r=g.envelope.behavior.REPEAT;break;case "oscillate":r=g.envelope.behavior.OSCILLATE;break;case "offset":r=g.envelope.behavior.OFFSET;break;case "linear":r=g.envelope.behavior.LINEAR}d.setBehavior(b,A,m,r)}}var c=m.undef,g=CubicVR.enums,a=[],b={getPoints:function(a,f,d){a=f?
b.getTextNode(a,f):a.$;if(!a)return c;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);d&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},h;postition=a.position;h=a.rotation;a=a.scale;if(h)d.rotation=b.floatDelimArray(h.$);if(a)d.scale=b.floatDelimArray(a.$);if(h||a)return d;return null},getTextNode:function(a,b,d){a=a[b];
if(!a)return d;a.length&&(a=a[0]);if(a.$)return a.$;return d},getFloatNode:function(a,f,d){if(a=b.getTextNode(a,f)){a=parseFloat(a);if(a!=a)return d;return a}return d},getIntNode:function(a,f,d){if(a=b.getTextNode(a,f)){a=parseInt(a,10);if(a!=a)return d;return a}return d},getFloatDelimNode:function(a,f,d,h){var n=CubicVR.util;if(a=b.getTextNode(a,f))return n.floatDelimArray(a,h);return d},getIntDelimNode:function(a,f,d,h){var n=CubicVR.util;if(a=b.getTextNode(a,f))return n.intDelimArray(a,h);return d}};
return{loadMesh:q,loadScene:function(a,b,d){var h=CubicVR.util;b===c&&(b="");d===c&&(d="");for(var n=new CubicVR.Mesh,o=h.getXML(a),a=new CubicVR.Scene,B=[],y=o.getElementsByTagName("sceneobjects"),w,v,A,m=0,z=y[0].childNodes.length;m<z;m++){var u=y[0].childNodes[m];if(u.tagName==="sceneobject"){var t="unnamed",K="",C="",n=u.getElementsByTagName("name");n.length&&(t=h.collectTextNode(n[0]));n=u.getElementsByTagName("parent");n.length&&(K=h.collectTextNode(n[0]));n=u.getElementsByTagName("model");
n.length&&(C=h.collectTextNode(n[0]));A=v=w=null;n=u.getElementsByTagName("position");n.length&&(w=n[0]);n=u.getElementsByTagName("rotation");n.length&&(v=n[0]);n=u.getElementsByTagName("scale");n.length&&(A=n[0]);n=null;C!==""&&(n=q(b+C,d));n=new CubicVR.SceneObject(n,t);if(r(w)){if(!n.motion)n.motion=new CubicVR.Motion;s(w,g.motion.POS,n.motion)}else if(w)n.position=h.floatDelimArray(h.collectTextNode(w));if(r(v)){if(!n.motion)n.motion=new CubicVR.Motion;s(v,g.motion.ROT,n.motion)}else n.rotation=
h.floatDelimArray(h.collectTextNode(v));if(r(A)){if(!n.motion)n.motion=new CubicVR.Motion;s(A,g.motion.SCL,n.motion)}else n.scale=h.floatDelimArray(h.collectTextNode(A));a.bindSceneObject(n);K!==""&&B.push([n,K])}}for(var D in B)B.hasOwnProperty(D)&&a.getSceneObject(B[D][1]).bindChild(B[D][0]);b=o.getElementsByTagName("camera");if(b.length){v=w=null;d="";n=b[0].getElementsByTagName("name");D=a.camera;o=null;if(n.length)d=n[0].firstChild.nodeValue;n=b[0].getElementsByTagName("target");if(n.length)d=
n[0].firstChild.nodeValue;if(d!=="")D.targetSceneObject=a.getSceneObject(d);n=b[0].getElementsByTagName("position");n.length&&(w=n[0]);n=b[0].getElementsByTagName("rotation");n.length&&(v=n[0]);n=b[0].getElementsByTagName("fov");n.length&&(o=n[0]);if(r(w)){if(!D.motion)D.motion=new CubicVR.Motion;s(w,g.motion.POS,D.motion)}else if(w)D.position=h.floatDelimArray(w.firstChild.nodeValue);if(r(v)){if(!D.motion)D.motion=new CubicVR.Motion;s(v,g.motion.ROT,D.motion)}else if(v)D.rotation=h.floatDelimArray(v.firstChild.nodeValue);
if(r(o)){if(!D.motion)D.motion=new CubicVR.Motion;s(o,g.motion.FOV,D.motion)}else if(o)D.fov=parseFloat(o.firstChild.nodeValue)}return a}}});
CubicVR.RegisterModule("Camera",function(m){function x(a,b,e,f,d){var h=m.mat4;this.frustum=new m.Frustum;typeof a=="object"?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==r?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==r?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,b=a.height?a.height:r,a=a.width?
a.width:r):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==r?e:60,this.nearclip=f!==r?f:0.1,this.farclip=d!==r?d:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new m.Transform;this.manual=!1;this.setDimensions(a!==r?a:512,b!==r?b:512);this.mvMatrix=h.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}function z(a){this.position=
a!==r?a:[0,0,0]}function q(a,b,e){this.camPath=new m.Motion;this.targetPath=new m.Motion;this.start_position=a!==r?a:[8,8,8];this.target=b!==r?b:[0,0,0];this.bounds=e!==r?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var r=m.undef,s=m.enums,c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=0;x.prototype={trackTarget:function(a,
b,e){this.position=m.vec3.trackTarget(this.position,a,b,e)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?m.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,e,f){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=e;this.ortho_view.top=f},control:function(a,b,
e){a===s.motion.ROT?this.rotation[b]=e:a===s.motion.POS?this.position[b]=e:a===s.motion.FOV?this.setFOV(e):a===s.motion.LENS?this.setLENS(e):a===s.motion.NEARCLIP?this.setClip(e,this.farclip):a===s.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,b,e,f,d,h){return[2*d/(b-a),0,0,0,0,2*d/(f-e),0,0,(b+a)/(b-a),(f+e)/(f-e),-(h+d)/(h-d),-1,0,0,-2*h*d/(h-d),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=m.mat4,b=m.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,
this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted&&this.mvMatrix)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),
b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,e,f,d,h,n,o,g){var y=
m.mat4,w=m.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=y.lookat(a,b,e,f,d,h,n,o,g);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&y.multiply(this.mvMatrix.slice(0),y.inverse(this.parent.tMatrix),this.mvMatrix);this.calc_nmatrix?(this.nMatrix=y.inverse_mat3(this.mvMatrix),
w.transpose_inline(this.nMatrix)):this.nMatrix=c;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,e){var f=m.mat4,d=m.vec3,h=[0,0,this.width,this.height],a=f.vec4_multiply(f.vec4_multiply([(a-h[0])/h[2]*2-1,-((b-h[1])/h[3]*2-1),1,1],f.inverse(this.pMatrix)),f.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(e!==r)return b=this.getParentedPosition(),d.add(b,d.multiply(d.normalize(d.subtract(a,b)),e));return a},project:function(a,b,e){var f=m.mat4,f=f.vec4_multiply(f.vec4_multiply([a,
b,e,1],this.mvMatrix),this.pMatrix);f[2]=m.vec3.length(m.vec3.subtract([a,b,e],this.position));return[(f[0]/f[3]+1)/2*this.width,(-f[1]/f[3]+1)/2*this.height,f[2]]}};z.prototype={control:function(a,b,e){a===s.motion.POS&&(this.position[b]=e)}};q.prototype={inBounds:function(a){var b=m.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,f=this.avoid_sphere.length;e<f;e++)if(b.length(a,
this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,b){var e=m.vec3,f=[0,0,0],d=[0,0,0],h=f=0,n=!1;do if(d[0]=Math.random()-0.5,d[1]=Math.random()-0.5,d[2]=Math.random()-0.5,d=e.normalize(d),f=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,f=e.add(b.position,e.multiply(d,f)),n=this.inBounds(f),h++,h>30){f=b.position;break}while(!n);return f},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(s.motion.POS,
s.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new z,e=new z;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,e);b=this.findNextNode(b,e);this.camPath.setKey(s.motion.POS,
s.motion.X,this.path_time,b[0]);this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,b[1]);this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,b[2]);this.path_length++}b=new z;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:x,AutoCamera:q}});
CubicVR.RegisterModule("CollisionMap",function(m){var x=m.enums;x.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var z=function(m){this.shapes=[];this.result=null;if(m){m&&!m.length&&(m=[m]);for(var r=0,s=m.length;r<s;r++)this.addShape(m[r])}};z.prototype={addShape:function(q){q.type=m.parseEnum(x.collision.shape,q.type);q.position=q.position||[0,0,0];q.rotation=q.rotation||[0,0,0];q.size=q.size||[1,1,1];q.radius=q.radius||1;q.height=q.height||1;
q.margin=q.margin||0;q.mesh=q.mesh||null;this.shapes.push(q)},getShapes:function(){return this.shapes},setResult:function(m){this.result=m},getResult:function(){return this.result}};return{CollisionMap:z}});
CubicVR.RegisterModule("GML",function(m){function x(m){var r=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==z){var m=r.getXML(m),s=m.getElementsByTagName("header");if(!s.length)return null;var c=s[0],s=m.getElementsByTagName("environment");if(!s.length)return null;this.name=null;c=c.getElementsByTagName("name");if(c.length)this.name=r.collectTextNode(c[0]);c=s[0].getElementsByTagName("screenBounds");if(c.length)this.bounds=
[parseFloat(r.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("z")[0]))];c=s[0].getElementsByTagName("origin");if(c.length)this.origin=[parseFloat(r.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(c[0].getElementsByTagName("z")[0]))];s=s[0].getElementsByTagName("up");if(s.length)this.upvector=
[parseFloat(r.collectTextNode(s[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(s[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(s[0].getElementsByTagName("z")[0]))];m=m.getElementsByTagName("drawing");s=0;for(c=m.length;s<c;s++)for(var g=m[s].getElementsByTagName("stroke"),a=0,b=0,e=0,f=0,d=0,h=g.length;d<h;d++){for(var n=g[d].getElementsByTagName("pt"),o=n.length,B=Array(o),y,w,v,A=0,J=o;A<J;A++)v=n[A],o=parseFloat(r.collectTextNode(v.getElementsByTagName("x")[0])),
y=parseFloat(r.collectTextNode(v.getElementsByTagName("y")[0])),w=parseFloat(r.collectTextNode(v.getElementsByTagName("z")[0])),v=parseFloat(r.collectTextNode(v.getElementsByTagName("time")[0])),this.upvector[0]===1?B[A]=[y!==y?0:y,o!==o?0:-o,w!==w?0:w,v]:this.upvector[1]===1?B[A]=[o!==o?0:o,y!==y?0:y,w!==w?0:w,v]:this.upvector[2]===1&&(B[A]=[o!==o?0:o,w!==w?0:-w,y!==y?0:y,v]),a<o&&(a=o),b<y&&(b=y),e<w&&(e=w),f<v&&(f=v);if(e>f){n=0;for(A=B.length;n<A;n++)o=B[n][3],B[n][3]=B[n][2],B[n][2]=o/this.bounds[2]}this.strokes[d]=
B}}}var z=m.undef;x.prototype={addStroke:function(m,r){var s=[];r===z&&(r=0.1);for(var c=0,g=m.length;c<g;c++){var a=[m[c][0],m[c][1],m[c][2]];this.manual_pos+=r;a.push(this.manual_pos);s.push(a)}this.strokes.push(s)},recenter:function(){var m=CubicVR.vec3,r=[0,0,0],s=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,g,a,b;a=0;for(b=this.strokes.length;a<b;a++){c=0;for(g=this.strokes[a].length;c<g;c++)r[0]>this.strokes[a][c][0]&&(r[0]=this.strokes[a][c][0]),r[1]>this.strokes[a][c][1]&&
(r[1]=this.strokes[a][c][1]),r[2]>this.strokes[a][c][2]&&(r[2]=this.strokes[a][c][2]),s[0]<this.strokes[a][c][0]&&(s[0]=this.strokes[a][c][0]),s[1]<this.strokes[a][c][1]&&(s[1]=this.strokes[a][c][1]),s[2]<this.strokes[a][c][2]&&(s[2]=this.strokes[a][c][2])}m=m.multiply(m.subtract(s,r),0.5);a=0;for(b=this.strokes.length;a<b;a++){c=0;for(g=this.strokes[a].length;c<g;c++)this.strokes[a][c][0]-=m[0],this.strokes[a][c][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[a][c][2]-=m[2]}},generateObject:function(m,
r,s,c,g){var a=CubicVR.vec3;m===z&&(m=0);r===z&&(r=0);g===z&&(g=!1);c===z&&(c=0.02);s===z&&(s=0.015);for(var b=r!==0,e=0,f=0,d=new CubicVR.Mesh(this.name),h,n,o,B,y,w,v=0,A=this.strokes.length;v<A;v++){w=new CubicVR.Envelope;var J=new CubicVR.Envelope,I=new CubicVR.Envelope,u=this.strokes[v].length,t=0,K=[],C=[],D=0,x=this.strokes[v];for(y=0;y<u;y++){var H=x[y],F=w.addKey(H[3],H[0]),E=J.addKey(H[3],H[1]),G;G=g?I.addKey(H[3],H[2]):I.addKey(H[3],0);F.tension=0.5;E.tension=0.5;G.tension=0.5;y!==0?(h=
H[0]-h,n=H[1]-n,o=H[2]-o,B=H[3]-B,o=Math.sqrt(h*h+n*n+o*o),t+=o,K[y-1]=o,C[y-1]=B):D=H[3];h=H[0];n=H[1];o=H[2];B=H[3]}t=D;u=d.points.length;for(y=0;y<K.length;y++){D=C[y];x=t;H=t+D;for(F=D/Math.ceil(K[y]/c*3);x<H-F;x+=F){x===t&&(h=w.evaluate(x),n=J.evaluate(x),o=I.evaluate(x));var N,E=w.evaluate(x+F);G=J.evaluate(x+F);N=I.evaluate(x+F);var L;L=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([E-h,G-n,N-o]))),s/2);d.addPoint([h-L[0],-(n-L[1]),o-L[2]+(b?r/2:0)]);d.addPoint([h+L[0],-(n+L[1]),
o+L[2]+(b?r/2:0)]);h=E;n=G;o=N}t+=D}J=d.points.length;if(b){y=u;for(w=J;y<w;y++)d.addPoint([d.points[y][0],d.points[y][1],d.points[y][2]-(b?r/2:0)])}y=0;for(w=J-u;y<=w-4;y+=2)e%m===0&&f++,d.setSegment(f),I=[u+y,u+y+1,u+y+3,u+y+2],d.addFace(I),b&&(I=[I[3]+J-u,I[2]+J-u,I[1]+J-u,I[0]+J-u],d.addFace(I),I=[u+y,u+y+2,u+y+2+J-u,u+y+J-u],d.addFace(I),I=[u+y+1+J-u,u+y+3+J-u,u+y+3,u+y+1],d.addFace(I),y===0&&(I=[u+y+J-u,u+y+1+J-u,u+y+1,u+y],d.addFace(I)),y===w-4&&(I=[u+y+2,u+y+3,u+y+3+J-u,u+y+2+J-u],d.addFace(I))),
e++}d.calcFaceNormals();d.triangulateQuads();d.calcNormals();d.compile();return d}};return{GML:x}});
CubicVR.RegisterModule("Landscape",function(m){function x(r,c,g,a){this.doTransform=function(){};this.tMatrix=q;this.parent=null;this.position=[0,0,0];this.scale=[1,1,1];this.rotation=[0,0,0];this.size=r;this.divisions_w=c;this.divisions_h=g;this.matRef=a;this.children=null;this.visible=!0;this.obj=new m.Mesh({dynamic:!0,buildWireframe:!0});this.divisions_w>this.divisions_h?(this.size_w=r,this.size_h=r/this.divisions_w*this.divisions_h):(this.size_w=this.divisions_h>this.divisions_w?r/this.divisions_h*
this.divisions_w:r,this.size_h=r);for(c=-(this.size_h/2);c<this.size_h/2;c+=this.size_h/this.divisions_h)for(r=-(this.size_w/2);r<this.size_w/2;r+=this.size_w/this.divisions_w)this.obj.addPoint([r+this.size_w/this.divisions_w/2,0,c+this.size_h/this.divisions_h/2]);this.obj.setFaceMaterial(this.matRef);for(c=0;c<this.divisions_h-1;c++)for(r=0;r<this.divisions_w-1;r++)this.obj.addFace([r+(c+1)*this.divisions_w,r+1+c*this.divisions_w,r+c*this.divisions_w]),this.obj.addFace([r+(c+1)*this.divisions_w,
r+1+(c+1)*this.divisions_w,r+1+c*this.divisions_w])}var z=m.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=Math.PI/2;x.prototype={isWireframe:function(){return!1},getMesh:function(){return this.obj},getEventHandler:function(){return z},setIndexedHeight:function(m,c,g){obj.points[m+c*this.divisions_w][1]=g},mapGen:function(m,c,g,a,b){if(c!==z&&g!==z&&a!==z&&b!==z){if(!(c>=this.divisions_w)&&!(g>=this.divisions_h)&&(c+a>=this.divisions_w&&(a=this.divisions_w-1-c),g+b>=this.divisions_h&&(b=this.divisions_h-
1-g),!(a<=0||b<=0)))for(var e=c,a=c+a;e<a;e++)for(var f=g,d=g+b;f<d;f++){var h=e+f*this.divisions_w,c=this.obj.points[h];c[1]=m(c[0],c[2],h)}}else{g=0;for(b=this.obj.points.length;g<b;g++)c=this.obj.points[g],c[1]=m(c[0],c[2],g)}},getFaceAt:function(m,c){if(typeof m==="object")return this.getFaceAt(m[0],m[2]);var g=this.size_h/2-this.size_h/this.divisions_h/2,a=parseInt(Math.floor((m+(this.size_w/2-this.size_w/this.divisions_w/2))/this.size_w*this.divisions_w),10),g=parseInt(Math.floor((c+g)/this.size_h*
this.divisions_h),10);if(a<0)return-1;if(a>=this.divisions_w-1)return-1;if(g<0)return-1;if(g>=this.divisions_h-1)return-1;var a=parseInt(a+g*(this.divisions_w-1),10)*2,g=parseInt(a+1,10),b=this.obj.points[this.obj.faces[a].points[0]];return Math.abs(c-b[2])/Math.abs(m-b[0])>=1?a:g},getHeightValue:function(r,c){var g=m.triangle;if(typeof r==="object")return this.getHeightValue(r[0],r[2]);var a,b=this.getFaceAt(r,c);if(b===-1)return 0;a=this.obj.points[this.obj.faces[b].points[0]];var e=g.normal(this.obj.points[this.obj.faces[b].points[0]],
this.obj.points[this.obj.faces[b].points[1]],this.obj.points[this.obj.faces[b].points[2]]),g=e[0],b=e[1],e=e[2];return(g*r+e*c+(-(g*a[0])-b*a[1]-e*a[2]))/-b},orient:function(m,c,g,a,b,e){e===z&&(e=0);var f,d,h=[];f=g/2;var n=a/2;d=Math.sqrt(n*n+f*f);n=Math.atan2(n,f);b*=Math.PI/180;f=m+Math.sin(b)*e;e=c+Math.cos(b)*e;h[0]=this.getHeightValue([f+d*Math.cos(-n-r+b),0,e+d*-Math.sin(-n-r+b)]);h[1]=this.getHeightValue([f+d*Math.cos(n-r+b),0,e+d*-Math.sin(n-r+b)]);h[2]=this.getHeightValue([f+d*Math.cos(-n+
r+b),0,e+d*-Math.sin(-n+r+b)]);h[3]=this.getHeightValue([f+d*Math.cos(n+r+b),0,e+d*-Math.sin(n+r+b)]);d=-Math.atan2(h[1]-h[2],g);e=-Math.atan2(h[0]-h[1],a);d+=-Math.atan2(h[0]-h[3],g);e+=-Math.atan2(h[3]-h[2],a);d/=2;e/=2;return[[m,(h[2]+h[3]+h[1]+h[0])/4,c],[d*(180/Math.PI),b,e*(180/Math.PI)]]}};return{Landscape:x}});
CubicVR.RegisterModule("Layout",function(){function m(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity=typeof m.opacity!=="undefined"?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function x(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;
this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity=typeof m.opacity!=="undefined"?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}m.prototype={addSubview:function(m){this.childViews.push(m);m.superView=this},makePanel:function(m){return this.superView.makePanel(m)}};x.prototype={resize:function(m,q){this.width=m;this.height=q},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(m){m.setInt("srcTex",0);m.addVector("screen");m.addVector("position");m.addVector("tint");m.addVector("size")}})},addSubview:function(m){this.childViews.push(m);m.superView=this},removeSubview:function(m){m=this.childViews.indexOf(m);m>-1&&this.childViews.splice(m,
1)},makePanel:function(m){var q=CubicVR.GLCore.gl,r={};r.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);r.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);r.gl_points=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,r.gl_points);q.bufferData(q.ARRAY_BUFFER,r.vbo_points,q.STATIC_DRAW);r.gl_uvs=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,r.gl_uvs);q.bufferData(q.ARRAY_BUFFER,r.vbo_uvs,q.STATIC_DRAW);m.panel=r},renderPanel:function(m){if(!m.texture)return!1;m.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(m){if(m.texture){var q=CubicVR.GLCore.gl,r=m.offsetLeft,s=m.offsetTop;r||(r=0);s||(s=0);var c=this.shader.shader;c.use();c.setVector("screen",[this.width,this.height,0]);c.setVector("position",[m.x+r,m.y+s,0]);c.setVector("size",[m.width,m.height,0]);c.setVector("tint",m.tint);m.blend&&(q.enable(q.BLEND),q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA));m.texture.use(q.TEXTURE0);q.drawArrays(q.TRIANGLES,0,6);m.blend&&(q.disable(q.BLEND),q.blendFunc(q.ONE,q.ZERO))}},render:function(){var m=
CubicVR.GLCore.gl;m.disable(m.DEPTH_TEST);this.texture&&this.renderView(this);var q=[];this.offsetTop=this.offsetLeft=0;q.push(this);var r=this.shader.shader;r.use();m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_points);m.vertexAttribPointer(r.uniforms.aVertex,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(r.uniforms.aVertex);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_uvs);m.vertexAttribPointer(r.uniforms.aTex,2,m.FLOAT,!1,0,0);m.enableVertexAttribArray(r.uniforms.aTex);
for(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);q.length;){var s=q.pop();this.renderView(s);if(s.childViews.length)for(var c=s.childViews.length-1;c>=0;c--)s.childViews[c].offsetLeft=s.x+s.offsetLeft,s.childViews[c].offsetTop=s.y+s.offsetTop,q.push(s.childViews[c])}m.disableVertexAttribArray(r.uniforms.aTex);m.enable(m.DEPTH_TEST)}};return{Layout:x,View:m}});
CubicVR.RegisterModule("Light",function(m){function x(c,g){var a=m.aabb,c=m.get(c)||{};if(c===r)c=q.light.type.POINT;if(g===r)g=q.light.method.DYNAMIC;typeof c=="object"?(this.light_type=c.type!==r?m.parseEnum(q.light.type,c.type):q.light.type.POINT,this.diffuse=c.diffuse!==r?c.diffuse:[1,1,1],this.specular=c.specular!==r?c.specular:[1,1,1],this.intensity=c.intensity!==r?c.intensity:1,this.position=c.position!==r?c.position:[0,0,0],this.direction=c.direction!==r?c.direction:[0,0,0],this.distance=
c.distance!==r?c.distance:this.light_type===q.light.type.AREA?30:10,this.cutoff=c.cutoff!==r?c.cutoff:60,this.map_res=c.map_res!==r?c.map_res:this.light_type===q.light.type.AREA?2048:512,this.map_res=c.mapRes!==r?c.mapRes:this.map_res,this.method=c.method!==r?m.parseEnum(q.light.method,c.method):g,this.areaCam=c.areaCam!==r?c.areaCam:null,this.areaCeiling=c.areaCeiling!==r?c.areaCeiling:40,this.areaFloor=c.areaFloor!==r?c.areaFloor:-40,this.areaAxis=c.areaAxis!==r?c.areaAxis:[1,1,0],this.projectorTex=
c.projector!==r?c.projector:null):(this.light_type=m.parseEnum(q.light.type,c),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===q.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===q.light.type.AREA?2048:512,this.method=m.parseEnum(q.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&typeof this.projectorTex===
"string"){var b=this.projectorTex;this.projectorTex=m.Textures_ref[b]!==r?m.Textures_obj[m.Textures_ref[b]]:new m.Texture(b)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=m.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];
(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA&&m.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var z=m.GLCore,q=m.enums,r=m.undef,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];q.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};x.prototype={setType:function(c){if(c===
q.light.type.AREA&&!m.features.lightShadows)this.dummyCam=new m.Camera,this.areaCam=new m.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=q.light.type.DIRECTIONAL;else if((c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR)&&!m.features.lightShadows)c=q.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=c},setIntensity:function(c){this.intensity=
c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var g=m.mat4,a=m.mat3,b=this.light_type;if(this.parent)if(b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR)b=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,c.nMatrix),this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,
this.parent.tMatrix));else{if(b===q.light.type.POINT)this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))}else if(b===q.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,c.nMatrix);else if(b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,c.nMatrix),this.lPos=g.vec3_multiply(this.position,c.mvMatrix);else if(b===q.light.type.POINT)this.lPos=g.vec3_multiply(this.position,
c.mvMatrix);else if(b===q.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,c.nMatrix)},control:function(c,g,a){if(c===q.motion.POS)this.position[g]=a;else if(c===q.motion.INTENSITY)this.intensity=a},getAABB:function(){var c=m.vec3,g=m.aabb,a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=c.add(a[0],this.position);a[1]=c.add(a[1],this.position);return this.aabb=a},setDirection:function(c,g,a){var b=m.vec3;
if(typeof c==="object")this.setDirection(c[0],c[1],c[2]);else return this.direction=b.normalize([c,g,a]),this},lookat:function(c,g,a){var b=m.vec3;if(typeof c==="object")this.lookat(c[0],c[1],c[2]);else return this.direction=b.normalize(b.subtract([c,g,a],this.position)),this},setRotation:function(c,g,a){var b=m.mat4,e=m.vec3;if(typeof c==="object")this.setRotation(c[0],c[1],c[2]);else{var f=new m.Transform;f.rotate([-c,-g,-a]);f.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],f.getResult()));
this.rotation=[c,g,a];return this}},setupShader:function(c,g){var a=z.gl;a.uniform3fv(c.lightDiffuse[g],this.diffuse);a.uniform3fv(c.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(c.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(c.lightDirection[g],this.lDir);a.uniform1f(c.lightIntensity[g],this.intensity);a.uniform1f(c.lightDistance[g],this.distance);(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.SPOT)&&
a.uniform1f(c.lightCutOffAngle[g],this.cutoff);if(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA)this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(z.gl.TEXTURE0+g*2),a.uniform1i(c.lightShadowMap[g],g*2),this.projectorTex.use(z.gl.TEXTURE0+g*2+1),a.uniform1i(c.lightProjectionMap[g],g*2+1)):(this.shadowMapTex.texture.use(z.gl.TEXTURE0+g),a.uniform1i(c.lightShadowMap[g],g)),a.uniform3fv(c.lightDepthClip[g],
[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(c.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(c){if(m.features.lightShadows)this.map_res=c,this.shadowMapTex=new m.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(q.texture.filter.NEAREST),this.dummyCam=new m.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},
setProjector:function(c){this.projectorTex=c},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var c=z.gl,g=m.mat4,a=m.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==q.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,
b);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+
this.direction[2]*10,0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=z.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var c=m.mat4;this.spMatrix=c.multiply(s,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=m.vec3,g=this.areaCeiling-this.areaFloor;
this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=c.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=c.normalize(b);c.normalize(c.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);b=c.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];e-=Math.atan2(a[0],a[2]);this.position=c.add(c.add(this.areaCam.position,
b),c.multiply(a,g));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,b),c.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/Math.PI);c=this.dummyCam.nearclip;g=this.dummyCam.farclip*Math.abs(this.direction[1])*g;c=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);c=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);c[1][1]>this.areaFloor&&(c=c[1][1]-this.areaFloor,g+=c/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=g;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(c,g,a,b,e,f){var b=m.vec3,d=b.normalize([e[0],e[4],e[8]]),h=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(h,d)),n;n=a/2;a=[];g=b.multiply(d,g/2);d=b.multiply(h,
n);f=b.multiply(e,f);a[0]=b.add(b.subtract(c,g),b.add(d,f));a[1]=b.add(b.add(c,g),b.add(d,f));a[2]=b.subtract(b.subtract(c,g),b.add(d,f));a[3]=b.subtract(b.add(c,g),b.add(d,f));aabb1=a[0];aabb2=a[0];for(c=1;c<4;c++)aabb1[0]>a[c][0]&&(aabb1[0]=a[c][0]),aabb1[1]>a[c][1]&&(aabb1[1]=a[c][1]),aabb1[2]>a[c][2]&&(aabb1[2]=a[c][2]),aabb2[0]<a[c][0]&&(aabb2[0]=a[c][0]),aabb2[1]<a[c][1]&&(aabb2[1]=a[c][1]),aabb2[2]<a[c][2]&&(aabb2[2]=a[c][2]);return[aabb1,aabb2]}};return{Light:x}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(m){if(!m.src)throw"PDF Error: you must specify a src url for a PDF.";var x=m.src,z=m.callback||function(){},q,r=[],s=[];this.__defineGetter__("pages",function(){return q?q.numPages:0});this.getPage=function(c){var g=q.numPages,c=c<1?1:c,c=c>g?g:c;c-=1;return r[c]};this.getPageTexture=function(c,g,a){c=this.getPage(c);g=g||c.width;a=a||c.height;return new CubicVR.PdfTexture(c,{width:g,height:a})};getPdf({url:x,error:function(){console.log("PDF Error: error loading pdf `"+
x+"`")}},function(c){q=new PDFDoc(c);for(var c=1,g=q.numPages;c<=g;c++){var a=q.getPage(c);r.push(a);s.push(a)}z()})}}});
CubicVR.RegisterModule("MainLoop",function(m){function x(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function z(){m.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(z),m.GLCore.mainloop.interval())}function q(a,b,e){if(window.requestAnimationFrame===s)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(m.GLCore.mainloop!==null)!window.requestAnimationFrame&&m.GLCore.mainloop&&clearInterval(m.GLCore.mainloop.interval),m.GLCore.mainloop=null;if(a===null)m.GLCore.mainloop=null;else{this.renderList=[];var f=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],d=new x;d.start();this.timer=d;this.func=a;this.doclear=b!==s?b:!0;m.GLCore.mainloop=this;if(g.resizeList.length&&!m.GLCore.resize_active)window.addEventListener("resize",
function(){m.GLCore.onResize()},!1),m.GLCore.resize_active=!0;b=function(){return function(){var b=m.GLCore.gl;d.update();m.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(d,m.GLCore.gl);var n=f[f.length-1],o=n.scenes;n.update&&n.update(d,b);if(o){b=0;for(n=o.length;b<n;++b){var e=o[b];e.paused||(e.update&&e.update(d,m.GLCore.gl),e.render())}}}}();e?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(z)):this.interval=setInterval(b,
20)}}function r(a,b,e){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var f=this;this.mEvents={};this.keyState=[];for(var d in c.keyboard)this.keyState[d]=!1;this.onMouseDown=function(){return function(a){f.mdown=!0;f.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];f.mEvents.mouseDown&&f.mEvents.mouseDown(f,f.mpos,f.keyState)}}();this.onMouseUp=function(){return function(a){f.mdown=!1;f.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];f.mEvents.mouseUp&&f.mEvents.mouseUp(f,
f.mpos,f.keyState)}}();this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-f.mpos[0];b[1]=a[1]-f.mpos[1];f.mpos=a;f.mEvents.mouseMove&&f.mEvents.mouseMove(f,f.mpos,b,f.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;f.mEvents.mouseWheel&&f.mEvents.mouseWheel(f,f.mpos,a,f.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,b=null;f.mEvents.keyPress?
(b=f.mEvents.keyPress(f,f.mpos,a,f.keyState),f.keyState[a]=b!==s?!!b:!0):f.keyState[a]=!0;f.keyState[a]&&f.mEvents.keyDown&&(b=f.mEvents.keyDown(f,f.mpos,a,f.keyState),f.keyState[a]=b!==s?!!b:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;f.mEvents.keyUp&&f.mEvents.keyUp(f,f.mpos,a,f.keyState);f.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,b,d){a.mdown&&a.orbitView(d)},mouseWheel:function(a,b,d){a.zoomView(d)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
e!==!1&&this.setEvents(e===s?this.eventDefaults:e);this.bind()}var s=m.undef,c=m.enums,g=m.GLCore;c.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};x.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=this.lock_rate*1E3|0:this.system_milliseconds=Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(a*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};q.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();this.renderStack.length>1&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=renderStack[renderStack.length-1],e,f=0,d=b.scenes.length;f<d;++f)if(b.scenes[f].scene.name===a){e=
b.scenes[f];break}return e},resumeScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];typeof a==="string"&&(a=this.getScene(a));var e=b.scenes.indexOf(a);e>-1&&b.scenes.splice(e,1);return a},runOnce:function(){this.loopFunc()}};r.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents=
{};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=m.vec3,e=b.subtract(this.camera.target,this.camera.position),e=b.length(e);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0);this.camera.position[1]+=e*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),e))},panView:function(a,b){var e=m.vec3;b||(b=!1);var f=e.subtract(this.camera.target,this.camera.position),
f=e.length(f),d=this.camera.position;b?this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-f*a[0]/300,-f*a[1]/300):(this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-f*a[0]/300,0),this.camera.position[1]+=f*a[1]/300);f=e.subtract(this.camera.position,d);this.camera.target=e.add(this.camera.target,f)},zoomView:function(a,b,e){var f=m.vec3,d=f.subtract(this.camera.target,this.camera.position),d=f.length(d);d-=a/1E3;b||(b=0.1);e||(e=1E3);d<
b&&(d=b);d>e&&(d=e);this.camera.position=f.add(this.camera.target,f.multiply(f.normalize(f.subtract(this.camera.position,this.camera.target)),d))},bindEvent:function(a,b){this.mEvents[a]=b===s?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:x,MainLoop:q,MouseViewController:r,setMainLoop:function(a){m.GLCore.mainloop=a},keyboard:c.keyboard}});
CubicVR.RegisterModule("Texture",function(m){function x(a,b){if(a===1||b===1)return!1;else{if(a!==1)for(;a%2===0;)a/=2;if(b!==1)for(;b%2===0;)b/=2;if(a>1)return!1;if(b>1)return!1}return!0}function z(a){var d=m.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG"||a.nodeName==="VIDEO")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=
a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new m.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var h=this.canvasSource;(!h.height||!h.width)&&f("Warning - CanvasTexture input has no initial width and height, edges clamped.");!h.height||!h.width||!x(h.width,h.height)?(this.setFilter(b.texture.filter.LINEAR),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE)):(this.setFilter(b.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT));a.nodeName==="IMG"&&this.update()}function q(a,d){if(!a)throw"PDF Texture Error: page is null.";var f=this,h=m.GLCore.gl,e=this.canvasSource=document.createElement("canvas"),c;e.mozOpaque=!0;e.width=d.width;e.height=
d.height;c=this.canvasContext=e.getContext("2d");c.save();c.fillStyle="rgb(255, 255, 255)";c.fillRect(0,0,e.width,e.height);c.restore();a.startRendering(c,function(){f.update()});this.texture=new m.Texture;this.updateFunction=d.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(e.width,e.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),h.texParameteri(h.TEXTURE_2D,
h.TEXTURE_WRAP_S,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function r(a,d,f){var h=m.GLCore.gl;this.texture=new m.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=d;this.canvas.height=f;this.pjs=new Processing(this.canvas,m.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=
this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function s(d,f,h){var e=a.gl;this.width=f;this.height=h;this.srcTex=d;this.outTex=new m.RenderBuffer(f,
h);x(f,h);d=[1/f,1/h,0];this.outputBuffer=new m.RenderBuffer(f,h,!1);this.fsQuad=m.fsQuad.make(f,h);shaderNMap=new m.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",d);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(e.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)}function c(d,f,h){var e=a.gl;this.width=d;this.height=f;this.outTex=new m.RenderBuffer(d,f,h);this.texture=this.outTex.texture;var c=x(d,f);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(e.TEXTURE0);c?(this.setFilter(b.texture.filter.LINEAR),
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE));this.dims=[d,f];this.depth=h?!0:!1}function g(a,b){this.scene=a;this.renderTex=new c(b?b.width:a.camera.width,b?b.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=m.GLCore,b=m.enums,e=m.undef,f=m.log;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var d=function(a,b){this.img_path=a;this.filter_type=b};d.prototype={getTexture:function(a,b){return new h(this.img_path,this.filter_type,a,b)}};var h=function(d,f,h,c,g){var v=
a.gl;this.tex_id=m.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;m.Textures[this.tex_id]=v.createTexture();m.Textures_obj[this.tex_id]=this;if(d)typeof d==="string"?m.Images[this.tex_id]=new Image:typeof d==="object"&&d.nodeName==="IMG"&&(m.Images[this.tex_id]=d),m.Textures_ref[d]=this.tex_id;v.bindTexture(v.TEXTURE_2D,m.Textures[this.tex_id]);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.LINEAR);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.LINEAR);if(d){var r=this.tex_id,
q=f!==e?f:a.default_filter,s=this;m.Images[this.tex_id].onload=function(){v.bindTexture(v.TEXTURE_2D,m.Textures[r]);v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!0);v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.NONE);var a=m.Images[r];v.texImage2D(v.TEXTURE_2D,0,v.RGBA,v.RGBA,v.UNSIGNED_BYTE,a);(a=x(a.width,a.height))?(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.REPEAT),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.REPEAT)):(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,
v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE));if(m.Textures_obj[r].filterType===-1){if(a)q=b.texture.filter.LINEAR_MIP;else if(q===b.texture.filter.LINEAR_MIP)q=b.texture.filter.LINEAR;m.Textures_obj[r].filterType===-1&&m.Textures_obj[r].setFilter(q)}else m.Textures_obj[r].setFilter(m.Textures_obj[r].filterType);if(s.onready)s.onready();v.bindTexture(v.TEXTURE_2D,null);s.loaded=!0};if(h)m.Images[this.tex_id].deferredSrc=d,h.addImage(c,d,m.Images[this.tex_id]);else if(typeof d==="string")m.Images[this.tex_id].src=
d}this.active_unit=-1};h.prototype={setFilter:function(a){if(this.tex_id>-1){var d=m.GLCore.gl;d.bindTexture(d.TEXTURE_2D,m.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR)):a===b.texture.filter.LINEAR_MIP?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR_MIPMAP_NEAREST),d.generateMipmap(d.TEXTURE_2D)):a===
b.texture.filter.NEAREST?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST_MIPMAP_LINEAR),d.generateMipmap(d.TEXTURE_2D));this.filterType=a}},use:function(d){if(this.tex_id>-1)a.gl.activeTexture(d),a.gl.bindTexture(a.gl.TEXTURE_2D,m.Textures[this.tex_id]),this.active_unit=
d},clear:function(){if(this.tex_id>-1&&this.active_unit!==-1)a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1},destroy:function(){var a=m.GLCore.gl;if(this.tex_id>-1&&m.Textures[this.tex_id])a.deleteTexture(m.Textures[this.tex_id]),delete m.Textures_obj[this.tex_id],this.tex_id=-1}};z.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){var a=m.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var d=
a.gl,b=d.getParameter(d.VIEWPORT);this.outputBuffer.use();d.viewport(0,0,this.width,this.height);d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.srcTex.use(d.TEXTURE0);m.fsQuad.render(this.shaderNorm,this.fsQuad);d.bindFramebuffer(d.FRAMEBUFFER,null);d.viewport(b[0],b[1],b[2],b[3])}};c.prototype={begin:function(){var d=a.gl;this.dims=d.getParameter(d.VIEWPORT);this.outTex.use();d.viewport(0,0,this.width,this.height);this.depth?d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT):d.clear(d.COLOR_BUFFER_BIT)},
end:function(){var d=a.gl;d.bindFramebuffer(d.FRAMEBUFFER,null);d.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:h,DeferredLoadTexture:d,CanvasTexture:z,PdfTexture:q,TextTexture:function(a,d){var b=d&&d.color||"#fff",f=d&&d.bgcolor,h=d&&d.font||"18pt Arial",c=d&&d.align||"start",g=d&&d.y||0,m=d&&d.width||e,r=d&&d.height||e,q,t=document.createElement("CANVAS"),
s=t.getContext("2d"),C=0,C=typeof a==="string"?1:a.length;s.font=h;var D=d&&d.lineHeight||s.measureText("OO").width,x;if(C===1)x=s.measureText(a).width;else for(q=x=0;q<C;++q){var H=s.measureText(a[q]).width;H>x&&(x=H)}t.width=m||x;t.height=r||D*C;if(f)s.fillStyle=f,s.fillRect(0,0,t.width,t.height);s.fillStyle=b;s.font=h;s.textAlign=c;s.textBaseline="top";if(C===1)b=d&&d.x||c==="center"?t.width/2:c==="right"?t.width:0,s.fillText(a,b,g);else for(q=0;q<C;++q)b=d&&d.x||c==="center"?t.width/2:c==="right"?
t.width:0,s.fillText(a[q],b,g+q*D);s.fill();this.use=z.prototype.use;this.clear=z.prototype.clear;this.update=z.prototype.update;z.apply(this,[t]);this.update();this.canvasSource=null},PJSTexture:r,NormalMapGen:s,RenderTexture:c,SceneRenderTexture:g}});
CubicVR.RegisterModule("Material",function(m){function x(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=m.get(a)||{},a.shader||null);s===null&&(s=new m.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
s._init_shader(s._vertex,s._fragment,!1));if(this.customShader&&!this.customShader._init_shader&&typeof this.customShader==="object")this.customShader=new m.CustomShader(this.customShader);this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==z?a.visible:!0;this.friction=a.friction!==z?a.friction:0.3;this.collision=a.visible!==z?a.collision:!0;this.opacity=a.opacity===z?1:
a.opacity;this.shininess=a.shininess===z?1:a.shininess;this.max_smooth=a.max_smooth===z?60:a.max_smooth;this.env_amount=a.env_amount===z?0.75:a.env_amount;this.morph=a.morph===z?!1:a.morph;this.color_map=a.colorMap===z?!1:a.colorMap;this.uvOffset=a.uvOffset===z?[0,0]:a.uvOffset;this.noFog=a.noFog===z?!1:a.noFog;if(a.textures)for(var e in a.textures)this.setTexture(a.textures[e],e)}var z=m.undef,q=m.GLCore,r=m.enums,s=null,c=[r.texture.map.REFLECT,r.texture.map.SPECULAR,r.texture.map.NORMAL,r.texture.map.BUMP],
g=[],a=["textureColor","textureEnvSphere","textureNormal","textureBump","textureReflect","textureSpecular","textureAmbient","textureAlpha","matrixModelView","matrixProjection","matrixObject","matrixNormal","vertexPosition","vertexNormal","vertexColor","vertexTexCoord","materialTexOffset","vertexMorphPosition","vertexMorphNormal","materialMorphWeight","lightDiffuse","lightSpecular","lightIntensity","lightDistance","lightPosition","lightDirection","lightCutOffAngle","lightShadowMap","lightProjectionMap",
"lightDepthClip","lightShadowMatrix","lightAmbient","materialDiffuse","materialColor","materialAmbient","materialSpecular","materialShininess","materialEnvironment","materialAlpha","postDepthInfo"];x.prototype={clone:function(){var a=new m.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,
collision:this.collision,name:this.name}),e;for(e in this.textures)this.textures.hasOwnProperty(e)&&a.setTexture(this.textures[e],e);return a},setVisibility:function(a){this.visible=a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,e){if(a&&(e=m.parseEnum(r.texture.map,e)||0,m.features.texturePerPixel||
c.indexOf(e)===-1))!a.use&&typeof a==="string"&&(a=m.Textures_ref[a]!==z?m.Textures_obj[m.Textures_ref[a]]:new m.Texture(a)),this.textures[e]=a},calcShaderMask:function(){var a=0;a+=typeof this.textures[r.texture.map.COLOR]==="object"?r.shader.map.COLOR:0;a+=typeof this.textures[r.texture.map.SPECULAR]==="object"?r.shader.map.SPECULAR:0;a+=typeof this.textures[r.texture.map.NORMAL]==="object"?r.shader.map.NORMAL:0;a+=typeof this.textures[r.texture.map.BUMP]==="object"?r.shader.map.BUMP:0;a+=typeof this.textures[r.texture.map.REFLECT]===
"object"?r.shader.map.REFLECT:0;a+=typeof this.textures[r.texture.map.ENVSPHERE]==="object"?r.shader.map.ENVSPHERE:0;a+=typeof this.textures[r.texture.map.AMBIENT]==="object"?r.shader.map.AMBIENT:0;a+=typeof this.textures[r.texture.map.ALPHA]==="object"?r.shader.map.ALPHA:0;a+=this.opacity!==1?r.shader.map.ALPHA:0;a+=this.color_map?r.shader.map.COLORMAP:0;if(this.opacity!==1)this.blendEnabled=!0;return a},getShaderHeader:function(a,e){return(e!==z?"#define LIGHT_COUNT "+e+"\n":"")+"#define TEXTURE_COLOR "+
(typeof this.textures[r.texture.map.COLOR]==="object"?1:0)+"\n#define TEXTURE_SPECULAR "+(typeof this.textures[r.texture.map.SPECULAR]==="object"?1:0)+"\n#define TEXTURE_NORMAL "+(typeof this.textures[r.texture.map.NORMAL]==="object"?1:0)+"\n#define TEXTURE_BUMP "+(typeof this.textures[r.texture.map.BUMP]==="object"?1:0)+"\n#define TEXTURE_REFLECT "+(typeof this.textures[r.texture.map.REFLECT]==="object"?1:0)+"\n#define TEXTURE_ENVSPHERE "+(typeof this.textures[r.texture.map.ENVSPHERE]==="object"?
1:0)+"\n#define TEXTURE_AMBIENT "+(typeof this.textures[r.texture.map.AMBIENT]==="object"?1:0)+"\n#define TEXTURE_ALPHA "+(typeof this.textures[r.texture.map.ALPHA]==="object"?1:0)+"\n#define MATERIAL_ALPHA "+(this.opacity!==1?1:0)+"\n#define LIGHT_IS_POINT "+(a===r.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===r.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===r.light.type.SPOT||a===r.light.type.SPOT_SHADOW||a===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+
(a===r.light.type.SPOT_SHADOW||a===r.light.type.SPOT_SHADOW_PROJECTOR||a===r.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(q.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===r.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===r.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(q.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+
(q.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(q.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(q.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(m.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(a,e){var f=q.gl,d=e.vertexPosition,h=e.vertexTexCoord,n=e.vertexNormal,o=e.vertexColor;f.bindBuffer(f.ARRAY_BUFFER,a.compiled.gl_points);f.vertexAttribPointer(d,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(d);h!==null&&a.compiled.gl_uvs!==null&&h!==-1&&(f.bindBuffer(f.ARRAY_BUFFER,a.compiled.gl_uvs),
f.vertexAttribPointer(h,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(h));g.uv=h;n!==null&&a.compiled.gl_normals!==null&&n!==-1&&(f.bindBuffer(f.ARRAY_BUFFER,a.compiled.gl_normals),f.vertexAttribPointer(n,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(n));g.un=n;o!==null&&a.compiled.gl_colors!==null&&o!==-1&&(f.bindBuffer(f.ARRAY_BUFFER,a.compiled.gl_colors),f.vertexAttribPointer(o,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(o));g.uc=o;if(a.morphTarget)d=e.vertexMorphPosition,n=e.vertexMorphNormal,f.bindBuffer(f.ARRAY_BUFFER,
a.morphTarget.gl_points),f.vertexAttribPointer(d,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(d),n!==null&&a.morphTarget.gl_normals!==null&&n!==-1&&(f.bindBuffer(f.ARRAY_BUFFER,a.morphTarget.gl_normals),f.vertexAttribPointer(n,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(n)),f.uniform1f(e.materialMorphWeight,a.morphWeight);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,e){var f=q.gl;g.uv!==z&&g.uv!==-1&&f.disableVertexAttribArray(g.uv);g.un!==z&&g.un!==-1&&f.disableVertexAttribArray(g.un);
g.uc!==z&&g.uc!==-1&&f.disableVertexAttribArray(g.uc);if(a.morphTarget&&e)up=e.vertexMorphPosition,f.disableVertexAttribArray(up),un=e.vertexMorphNormal,un!==null&&a.compiled.gl_normals!==null&&un!==-1&&f.disableVertexAttribArray(un)},use:function(b,e){var f,d=q.gl,h=this.textures,n=!0,e=e||0,b=b||0;this.shader[b]||(this.shader[b]=[]);var o=this.shader[b][e];f=this.customShader&&b===r.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();if(o&&this.opacity!==1&&this.blendEnabled!==!0)this.dirtyFlag=
!0;if(this.dirtyFlag===!0)o=null,this.dirtyFlag=!1;if(o)n=o!==s,o.use(),this.customShader&&!f&&this.customShader._doUpdate();else{var c=this.calcShaderMask(b);if(!this.customShader||f)m.ShaderPool[b][c]||(m.ShaderPool[b][c]=[]),o=m.ShaderPool[b][c][e];if(!o){var g=this.getShaderHeader(b,e),w=g+q.CoreShader_vs;g+=q.CoreShader_fs;this.customShader&&!f?this.customShader._initialized||(this.customShader._init_shader(w,g,a),o=this.customShader.getShader(),o.isCompiled()||(n=!1,o=s.getShader())):(o=new m.Shader(w,
g),o.isCompiled()||(n=!1,o=s.getShader()),m.ShaderPool[b][c][e]=o);f=0;if(b!==r.light.type.DEPTH_PACK){if(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)f+=e,b===r.light.type.SPOT_SHADOW_PROJECTOR&&(f+=e);typeof h[r.texture.map.COLOR]==="object"&&o.addInt("textureColor",f++);typeof h[r.texture.map.ENVSPHERE]==="object"&&o.addInt("textureEnvSphere",f++);typeof h[r.texture.map.NORMAL]==="object"&&o.addInt("textureNormal",f++);typeof h[r.texture.map.BUMP]===
"object"&&o.addInt("textureBump",f++);typeof h[r.texture.map.REFLECT]==="object"&&o.addInt("textureReflect",f++);typeof h[r.texture.map.SPECULAR]==="object"&&o.addInt("textureSpecular",f++);typeof h[r.texture.map.AMBIENT]==="object"&&o.addInt("textureAmbient",f++)}typeof h[r.texture.map.ALPHA]==="object"&&o.addInt("textureAlpha",f++);o.addMatrix("matrixModelView");o.addMatrix("matrixProjection");o.addMatrix("matrixObject");o.addMatrix("matrixNormal");o.addVertexArray("vertexPosition");o.addVertexArray("vertexNormal");
this.color_map&&o.addVertexArray("vertexColor");this.morph&&(o.addVertexArray("vertexMorphPosition"),o.addVertexArray("vertexMorphNormal"),o.addFloat("materialMorphWeight",0));for(f=0;f<e;f++)if(o.addVector("lightDiffuse["+f+"]"),o.addVector("lightSpecular["+f+"]"),o.addFloat("lightIntensity["+f+"]"),o.addFloat("lightDistance["+f+"]"),o.addVector("lightPosition["+f+"]"),o.addVector("lightDirection["+f+"]"),(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.SPOT)&&
o.addFloat("lightCutOffAngle["+f+"]"),b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)o.addInt("lightShadowMap["+f+"]"),b===r.light.type.SPOT_SHADOW_PROJECTOR&&o.addInt("lightProjectionMap["+f+"]"),o.addVector("lightDepthClip["+f+"]"),o.addMatrix("lightShadowMatrix["+f+"]");b!==r.light.type.DEPTH_PACK&&(o.addVector("lightAmbient"),o.addVector("materialDiffuse"),o.addVector("materialColor"),o.addVector("materialAmbient"),o.addVector("materialSpecular"),o.addFloat("materialShininess"),
o.addFloat("materialEnvironment"));o.addFloat("materialAlpha");(q.depth_alpha||b===r.light.type.DEPTH_PACK||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)&&o.addVector("postDepthInfo");o.addUVArray("vertexTexCoord");o.addVector("materialTexOffset");q.fog_enabled&&!this.noFog&&(o.addVector("fogColor",q.fogColor),o.addFloat("fogDensity",q.fogDensity),o.addFloat("fogNear",q.fogNear),o.addFloat("fogFar",q.fogFar))}this.shader[b][e]=o;o.use();o.materialTexOffset!=
-1&&d.uniform2fv(o.materialTexOffset,[0,0]);this.customShader&&this.customShader._doUpdate()}f=0;var v;if(b!==r.light.type.DEPTH_PACK){if(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)f+=e,b===r.light.type.SPOT_SHADOW_PROJECTOR&&(f+=e);if(v=h[r.texture.map.COLOR])v.use(q.gl.TEXTURE0+f),f++;if(v=h[r.texture.map.ENVSPHERE])v.use(q.gl.TEXTURE0+f),f++,d.uniform1f(o.materialEnvironment,this.env_amount);if(v=h[r.texture.map.NORMAL])v.use(q.gl.TEXTURE0+f),f++;
if(v=h[r.texture.map.BUMP])v.use(q.gl.TEXTURE0+f),f++;if(v=h[r.texture.map.REFLECT])v.use(q.gl.TEXTURE0+f),f++;if(v=h[r.texture.map.SPECULAR])v.use(q.gl.TEXTURE0+f),f++;if(v=h[r.texture.map.AMBIENT])v.use(q.gl.TEXTURE0+f),f++}(v=h[r.texture.map.ALPHA])&&v.use(q.gl.TEXTURE0+f);q.fog_enabled&&!this.noFog&&(d.uniform3fv(o.fogColor,q.fogColor),d.uniform1f(o.fogDensity,q.fogDensity),d.uniform1f(o.fogNear,q.fogNear),d.uniform1f(o.fogFar,q.fogFar));b!==r.light.type.DEPTH_PACK?(d.uniform3fv(o.materialColor,
this.color),d.uniform3fv(o.materialDiffuse,this.diffuse),d.uniform3fv(o.materialAmbient,this.ambient),d.uniform3fv(o.materialSpecular,this.specular),d.uniform1f(o.materialShininess,this.shininess*128),d.uniform3fv(o.lightAmbient,m.globalAmbient),this.opacity!==1&&d.uniform1f(o.materialAlpha,this.opacity),(q.depth_alpha||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)&&d.uniform3fv(o.postDepthInfo,[q.depth_alpha_near,q.depth_alpha_far,0])):d.uniform3fv(o.postDepthInfo,
[q.shadow_near,q.shadow_far,0]);o.materialTexOffset&&d.uniform2fv(o.materialTexOffset,this.uvOffset);return n}};return{Material:x}});
CubicVR.RegisterModule("Mesh",function(m){function x(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function z(c){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;c=m.get(c)||
{};if(c instanceof m.Mesh)this.booleanAdd(c),c._clones=c._clones||1,c._clones++,this.name=c.name?c.name+"_copy"+c._clones:null;else{this.name=c.name||null;this.dynamic=c.dynamic||!1;if(c.material){var g=c.material;g.length?this.materials=g:typeof g==="object"&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new m.Material(g)))}c.points&&this.build(c);c.part?this.build(c.part):c.parts&&this.build(c.parts);if((this.primitives=c.primitives||c.primitive||null)&&!this.primitives.length||typeof this.primitives===
"string")this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var b=this.primitives[g];typeof b==="string"&&(b=m.get(b));var e=m.primitives[b.type];if(b.type&&e)this.booleanAdd(e(b));else if(b.type){s("Mesh error, primitive "+b.type+" is unknown.");var b="",f;for(f in m.primitives)m.primitives.hasOwnProperty(f)&&(b!==""&&(b+=", "),b+=f);s("Available primitive types are: "+b)}else s("Mesh error, primitive "+(g+1)+" lacks type.")}this.buildWireframe=
c.buildWireframe||c.wireframe||!!c.wireframeMaterial||c.triangulateWireframe||!1;this.triangulateWireframe=c.triangulateWireframe||null;this.wireframeMaterial=m.get(c.wireframeMaterial,m.Material)||null;this.wireframe=c.wireframe||!1;c.flipFaces&&this.faces.length&&this.flipFaces();(c.prepare||c.compile&&this.faces.length)&&this.prepare();(c.clean||c.compile&&this.faces.length&&!this.dynamic)&&this.clean();c.calcNormals&&!c.compile&&!c.prepare&&this.calcNormals()}}var q=m.undef,r=m.GLCore,s=m.log;
x.prototype={setUV:function(c,g){g!==q?this.uvs[g]=c:c.length!==2?this.uvs=c:this.uvs.push(c)},setColor:function(c,g){g!==q?this.point_colors[g]=c:typeof c[0]!=="number"?this.point_colors=c:this.point_colors.push(c)},flip:function(){for(var c=0,g=this.point_normals.length;c<g;c++)this.point_normals[c]=[-this.point_normals[c][0],-this.point_normals[c][1],-this.point_normals[c][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
z.prototype={setWireframe:function(c){this.wireframe=c},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(c){this.wireframeMaterial=c},build:function(c,g){var a,b;typeof c==="string"&&(c=m.get(c));c&&!c.length&&(c=[c]);var e=this.faces.length;g&&g.length&&this.points.concat(g);for(var f=0,d=c.length;f<d;f++){var h=c[f];a=h.material;b=h.points;var n=h.faces,o=h.uv,B=h.color,h=h.segment||null;h!==null&&this.setSegment(parseInt(h,10));if(b&&b.length&&(this.points=this.points.concat(b),
n&&e)){n=n.slice(0);b=0;for(h=n.length;b<h;b++)for(var y=n[b],w=0,v=n.length;w<v;w++)y[w]+=e}if(a)a.length?this.materials=a:typeof a==="object"&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new m.Material(a)));n&&n.length&&this.addFace(n);if(n&&o&&typeof o==="object"){h=null;if(o.length&&o.length===n.length)if(o.length===n.length){a=0;for(b=o.length;a<b;a++)this.faces[a+e].setUV(o[a])}else s("Mesh error in part, face count: "+n.length+", uv count:"+o.length);else h=o.apply?o:new m.UVMapper(o);
h&&h.apply(this,this.currentMaterial,this.currentSegment,e,this.faces.length-e)}if(n&&B&&typeof B==="object")if(B.length&&B.length===n.length){a=0;for(b=B.length;a<b;a++)this.faces[a+e].setColor(B[a]);this.materials[this.currentMaterial].colorMap=!0}else s("Mesh error in part, face count: "+n.length+", color count:"+B.length)}return this},showAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!0)},hideAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&
(this.segment_state[c]=!1)},setSegment:function(c,g){g!==q?this.segment_state[c]=g:this.currentSegment=c},addPoint:function(c){if(c.length!==3||typeof c[0]==="object")for(var g=0,a=c.length;g<a;g++)this.points.push(c[g]);else this.points.push(c);return this.points.length-1},getMaterialIndex:function(c){return this.materials.indexOf(c)},setFaceMaterial:function(c,g){var a;typeof c=="number"?a=c:(a=this.materials.indexOf(c),a===-1&&(this.materials.push(c),a=this.materials.length-1));if(g!==q){if(this.faces[g]!==
q)this.faces[g].material=a}else this.currentMaterial=a;return this},addFace:function(c,g,a,b){if(typeof c[0]!=="number"){g=0;for(a=c.length;g<a;g++)this.addFace(c[g])}else{g===q?(this.currentFace=this.faces.length,this.faces.push(new x)):(this.faces[g]===q&&(this.faces[g]=new x),this.currentFace=g);if(typeof c==="object")this.faces[this.currentFace].points=c;a!==q?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=
b!==q?b:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var c=0,g=this.faces.length;c<g;c++)this.faces[c].flip()},triangulateQuads:function(){for(var c=0,g=this.faces.length;c<g;c++)if(this.faces[c].points.length===4){var a=this.faces.length;this.addFace([this.faces[c].points[2],this.faces[c].points[3],this.faces[c].points[0]],this.faces.length,this.faces[c].material,this.faces[c].segment);this.faces[c].points.pop();this.faces[a].normal=this.faces[c].normal.slice(0);this.faces[c].point_colors.length===
4&&(this.faces[a].setColor(this.faces[c].point_colors[2],0),this.faces[a].setColor(this.faces[c].point_colors[3],1),this.faces[a].setColor(this.faces[c].point_colors[0],2),this.faces[c].point_colors.pop());this.faces[c].uvs.length===4&&(this.faces[a].setUV(this.faces[c].uvs[2],0),this.faces[a].setUV(this.faces[c].uvs[3],1),this.faces[a].setUV(this.faces[c].uvs[0],2),this.faces[c].uvs.pop());this.faces[c].point_normals.length===4&&(this.faces[a].point_normals[0]=this.faces[c].point_normals[2],this.faces[a].point_normals[1]=
this.faces[c].point_normals[3],this.faces[a].point_normals[2]=this.faces[c].point_normals[0],this.faces[c].point_normals.pop())}return this},booleanAdd:function(c,g){var a=m.mat4,b=this.points.length,e,f,d,h;e=g;g=e===q?q:typeof e==="array"?e:typeof e==="object"?e.getResult?e.getResult():e.position||e.rotation||e.scale?m.mat4.transform(e.position,e.rotation,e.scale):q:void 0;if(c.wireframeMaterial)this.wireframeMaterial=c.wireframeMaterial;if(g!==q){f=g;e=0;for(d=c.points.length;e<d;e++)this.addPoint(a.vec3_multiply(c.points[e],
f))}else{e=0;for(d=c.points.length;e<d;e++)this.addPoint([c.points[e][0],c.points[e][1],c.points[e][2]])}a=[];e=0;for(d=c.materials.length;e<d;e++)f=this.materials.indexOf(c.materials[e]),f===-1?(this.materials.push(c.materials[e]),a[e]=this.materials.length-1):a[e]=f;e=0;for(d=c.faces.length;e<d;e++){var n=[];f=0;for(h=c.faces[e].points.length;f<h;f++)n.push(c.faces[e].points[f]+b);n=this.faces[this.addFace(n)];n.segment=c.faces[e].segment;n.material=a[c.faces[e].material];if(n.material===q)n.material=
0;f=0;for(h=c.faces[e].uvs.length;f<h;f++)n.uvs[f]=[c.faces[e].uvs[f][0],c.faces[e].uvs[f][1]];f=0;for(h=c.faces[e].point_normals.length;f<h;f++)n.point_normals[f]=[c.faces[e].point_normals[f][0],c.faces[e].point_normals[f][1],c.faces[e].point_normals[f][2]]}return this},calcFaceNormals:function(c,g){var a=m.vec3,b=m.triangle,e=0,f=this.faces.length,d,h=this.points,n;c&&(e=c);for(g&&(f=g+1);e<f;e++)d=this.faces[e],n=d.points,n.length<3?d.normal=[0,0,0]:a.normalize(b.normal(h[n[0]],h[n[1]],h[n[2]],
d.normal));return this},getMaterial:function(c){if(!isNaN(parseInt(c,10)))return this.materials[g];for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===c)return this.materials[g];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(c){this.instanceMaterials=c},calcNormals:function(c){var g=m.vec3,a=!1,b;this.dynamic&&(b=[],c=c||{});c!==q&&(b=[],a=!0);this.calcFaceNormals();var e,f,d,h,n=Array(this.points.length);e=0;for(h=n.length;e<h;e++)n[e]=
[];h=this.faces.length;for(e=0;e<h;e++){d=this.faces[e].points.length;for(f=0;f<d;f++)n[this.faces[e].points[f]].push([e,f])}e=0;for(h=this.points.length;e<h;e++){var o=n[e].length;for(f=0;f<o;f++){var B=1,y=n[e][f][0],w=n[e][f][1],v=this.materials.length?this.materials[this.faces[y].material].max_smooth:60,r=this.faces[y];a&&(b[y]===q&&(b[y]=[]),b[y][w]===q&&(b[y][w]=[]));var s=Array(3);s[0]=r.normal[0];s[1]=r.normal[1];s[2]=r.normal[2];if(v!==0)for(d=0;d<o;d++)if(f!==d){var I=n[e][d][0],u=this.faces[I],
t=g.angle(u.normal,r.normal);if(t!==t||t*(180/Math.PI)<=v)a&&b[y][w].push(I),s[0]+=u.normal[0],s[1]+=u.normal[1],s[2]+=u.normal[2],B++}s[0]/=B;s[1]/=B;s[2]/=B;this.faces[y].point_normals[w]=g.normalize(s)}}if(a){e=g=0;for(h=b.length;e<h;e++){f=0;for(d=b[e].length;f<d;f++)g+=b[e][f].length}if(!c.faceCount)c.faceCount=new Uint8Array(this.faces.length*3);if(!c.faceNorm)c.faceNorm=new Uint16Array(g);if(!c.faceNormIdx)c.faceNormIdx=new Uint16Array(this.faces.length);e=g=0;for(h=this.faces.length;e<h;e++)for(f=
0;f<3;f++)if(a=b[e][f],c.faceCount[e*3+f]=a?a.length:0,c.faceNormIdx[e]=g,a){d=0;for(a=a.length;d<a;d++)c.faceNorm[g++]=b[e][f][d]}else g++;this.normalMapRef=c}return this},recalcNormals:function(c,g){var a,b,e,f,d,h,n,o,m,y;if(c=c||this.normalMapRef){a=g.segments!==q?!0:!1;b=g.segments;this.calcFaceNormals();var w=0,v=0,r=0,s;if(a)for(var v=this.dynamicData.VBO.dynamicMap,I=c.faceNormIdx,u=0,t=b.length;u<t;u++)for(var x=v.segmentMap[b[u]],C=0,D=x.length;C<D;C++){a=x[C];m=this.faces[a];s=m.normal;
w=I[a];for(j=0;j<3;j++){o=m.point_normals[j];d=s[0];h=s[1];n=s[2];y=c.faceCount[a*3+j];e=0;for(iMax=y;e<iMax;e++)f=c.faceNorm[w+e],f=this.faces[f],f=f.normal,d+=f[0],h+=f[1],n+=f[2];y?(e=y+1,d/=e,h/=e,n/=e,e=Math.sqrt(d*d+h*h+n*n),d/=e,h/=e,n/=e,o[0]=d,o[1]=h,o[2]=n):r++}}else{a=0;for(b=this.faces.length;a<b;a++){m=this.faces[a];s=m.normal;for(j=0;j<3;j++){o=m.point_normals[j];d=s[0];h=s[1];n=s[2];y=c.faceCount[v++];e=0;for(iMax=y;e<iMax;e++)f=c.faceNorm[w++],f=this.faces[f],f=f.normal,d+=f[0],h+=
f[1],n+=f[2];y?(e=y+1,d/=e,h/=e,n/=e,e=Math.sqrt(d*d+h*h+n*n),d/=e,h/=e,n/=e,o[0]=d,o[1]=h,o[2]=n):r++}}}return this}},removeDoubles:function(c){var g=[],a=[],b,e,f,d;b=0;for(e=this.points.length;b<e;b++){var h=-1,n=this.points[b];f=0;for(d=g.length;f<d;f++)if(m.vec3.equal(n,g[f],c)){h=f;break}h!=-1?a[b]=h:(a[b]=g.length,g.push(this.points[b]))}this.points=g;b=0;for(e=this.faces.length;b<e;b++){c=this.faces[b];f=0;for(d=c.points.length;f<d;f++)c.points[f]=a[c.points[f]]}return this},buildEdges:function(){var c,
g,a,b,e=[],f=[];c=0;for(a=this.faces.length;c<a;c++){var d=this.faces[c];g=0;for(b=d.points.length;g<b;g++){var h,n,o;o=d.segment;matId=d.material;g?(n=d.points[g],h=d.points[g-1]):(n=d.points[g],h=d.points[b-1]);e[h]=e[h]||{};e[h][matId]=e[h][matId]||{};e[h][matId][o]=e[h][matId][o]||{};!e[h][matId][o][n]&&(!e[n]||!e[n][matId][o][h])&&f.push([matId,o,h,n])}}this.edges=f;return this},subdivide:function(c,g){var a=m.vec3,g=g===q?!0:g;c===q&&(c=1);if(c!==0){var b,e,f,d,h,n={},o=[],B=[],y=this.points.length,
w=this.faces.length,v=[],r=[],J=[],I=[];b=0;for(f=w;b<f;b++)if(h=this.faces[b],h.points&&(h.points.length===3||h.points.length===4)){var u=[0,0,0];e=0;for(d=h.points.length;e<d;e++){var t=this.points[h.points[e]];u[0]+=t[0];u[1]+=t[1];u[2]+=t[2]}u[0]/=d;u[1]/=d;u[2]/=d;v[b]=this.addPoint(u);if(h.uvs.length===h.points.length){u=[0,0];e=0;for(d=h.uvs.length;e<d;e++)t=h.uvs[e],u[0]+=t[0],u[1]+=t[1];u[0]/=d;u[1]/=d;r[b]=u}if(h.point_colors.length===h.points.length){u=[0,0,0];e=0;for(d=h.point_colors.length;e<
d;e++)t=h.point_colors[e],u[0]+=t[0],u[1]+=t[1],u[2]+=t[2];u[0]/=d;u[1]/=d;u[2]/=d;J[b]=u}if(h.point_normals.length===h.points.length){u=[0,0,0];e=0;for(d=h.point_normals.length;e<d;e++)t=h.point_normals[e],u[0]+=t[0],u[1]+=t[1],u[2]+=t[2];u[0]/=d;u[1]/=d;u[2]/=d;I[b]=u}}b=0;for(f=this.faces.length;b<f;b++){h=this.faces[b];e=0;for(d=h.points.length;e<d;e++){var x,C;e?(x=e,C=e-1):(x=e,C=d-1);t=h.points[x];u=h.points[C];n[u]=n[u]||{};o[u]=o[u]||[];o[u].push(b);n[u][t]={face:b,a:u,b:t,fpa:x,fpb:C}}}for(b in n)if(n.hasOwnProperty(b))for(e in n[b])if(n[b].hasOwnProperty(e)){f=
n[b][e];h=n[e][b];if(h===q){s("Mesh.subdivide error. Hole at face #"+f.face+", Edge:["+f.fpa+"->"+f.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}if(!f.edge_point)d=a.multiply(a.add(this.points[f.a],this.points[f.b]),0.5),g?(u=a.multiply(a.add(this.points[v[f.face]],this.points[v[h.face]]),0.5),f.edge_point=a.multiply(a.add(d,u),0.5)):f.edge_point=d,h.edge_point=f.edge_point,f.edge_avg=d,h.edge_avg=d,f.ep_idx=this.addPoint(f.edge_point),h.ep_idx=f.ep_idx;B[f.a]=B[f.a]||
[];B[f.a].push(f.edge_avg);d=this.faces[f.face].uvs;if(d.length)h=d[f.fpa],d=d[f.fpb],f.uv=[(h[0]+d[0])/2,(h[1]+d[1])/2];h=this.faces[f.face].point_colors;if(h.length)f.color=a.multiply(a.add(h[f.fpa],h[f.fpb]),0.5);h=this.faces[f.face].point_normals;if(h.length)f.normal=a.normalize(a.multiply(a.add(h[f.fpa],h[f.fpb]),0.5))}if(g){h=[];b=0;for(f=y;b<f;b++)if(u=[0,0,0],o[b]){e=0;for(d=o[b].length;e<d;e++)t=this.points[v[o[b][e]]],u[0]+=t[0],u[1]+=t[1],u[2]+=t[2];u[0]/=d;u[1]/=d;u[2]/=d;h[b]=u}u=[];
b=0;for(f=y;b<f;b++)if(t=[0,0,0],B[b]){e=0;for(d=B[b].length;e<d;e++)x=B[b][e],t[0]+=x[0],t[1]+=x[1],t[2]+=x[2];t[0]/=d;t[1]/=d;t[2]/=d;u[b]=t}b=0;for(f=y;b<f;b++)if(o[b])y=o[b].length,e=1/y,B=2/y,y=a.multiply(this.points[b],(y-3)/y),y=a.add(y,a.multiply(h[b],e)),y=a.add(y,a.multiply(u[b],B)),this.points[b]=y}for(b=0;b<w;b++)if(h=this.faces[b],!(h.points.length!==3&&h.points.length!==4))if(a=h.points.slice(0),o=h.uvs.slice(0),e=h.point_colors.slice(0),B=h.point_normals.slice(0),y=o.length===a.length,
f=e.length===a.length,d=B.length===a.length,h=h.material,a.length===3){this.setFaceMaterial(h);u=n[a[0]][a[1]];t=n[a[2]][a[0]];this.addFace([a[0],u.ep_idx,v[b],t.ep_idx],b);if(y)this.faces[b].uvs=[o[0],u.uv,r[b],t.uv];if(f)this.faces[b].point_colors=[e[0],u.color,J[b],t.color];if(d)this.faces[b].point_normals=[B[0],u.normal,I[b],t.normal];u=n[a[1]][a[2]];t=n[a[0]][a[1]];h=this.addFace([a[1],u.ep_idx,v[b],t.ep_idx]);if(y)this.faces[h].uvs=[o[1],u.uv,r[b],t.uv];if(f)this.faces[h].point_colors=[e[1],
u.color,J[b],t.color];if(d)this.faces[h].point_normals=[B[1],u.normal,I[b],t.normal];u=n[a[2]][a[0]];t=n[a[1]][a[2]];h=this.addFace([a[2],u.ep_idx,v[b],t.ep_idx]);if(y)this.faces[h].uvs=[o[2],u.uv,r[b],t.uv];if(f)this.faces[h].point_colors=[e[2],u.color,J[b],t.color];if(d)this.faces[h].point_normals=[B[2],u.normal,I[b],t.normal]}else{this.setFaceMaterial(h);u=n[a[0]][a[1]];t=n[a[3]][a[0]];this.addFace([a[0],u.ep_idx,v[b],t.ep_idx],b);if(y)this.faces[b].uvs=[o[0],u.uv,r[b],t.uv];if(f)this.faces[b].point_colors=
[e[0],u.color,J[b],t.color];if(d)this.faces[b].point_normals=[B[0],u.normal,I[b],t.normal];u=n[a[1]][a[2]];t=n[a[0]][a[1]];h=this.addFace([a[1],u.ep_idx,v[b],t.ep_idx]);if(y)this.faces[h].uvs=[o[1],u.uv,r[b],t.uv];if(f)this.faces[h].point_colors=[e[1],u.color,J[b],t.color];if(d)this.faces[h].point_normals=[B[1],u.normal,I[b],t.normal];u=n[a[2]][a[3]];t=n[a[1]][a[2]];h=this.addFace([a[2],u.ep_idx,v[b],t.ep_idx]);if(y)this.faces[h].uvs=[o[2],u.uv,r[b],t.uv];if(f)this.faces[h].point_colors=[e[2],u.color,
J[b],t.color];if(d)this.faces[h].point_normals=[B[2],u.normal,I[b],t.normal];u=n[a[3]][a[0]];t=n[a[2]][a[3]];h=this.addFace([a[3],u.ep_idx,v[b],t.ep_idx]);if(y)this.faces[h].uvs=[o[3],u.uv,r[b],t.uv];if(f)this.faces[h].point_colors=[e[3],u.color,J[b],t.color];if(d)this.faces[h].point_normals=[B[3],u.normal,I[b],t.normal]}c--;if(c!==0)this.subdivide(c,g);else return this}},removeInternals:function(){var c,g,a,b,e,f={},d=this.faces.length,h,n,o,m;c=0;for(a=this.faces.length;c<a;c++){e=this.faces[c];
g=0;for(b=e.points.length;g<b;g++)g?(o=g,m=g-1):(o=g,m=b-1),h=e.points[o],n=e.points[m],f[h]=f[h]||{},f[h][n]===q?f[h][n]=[c]:f[h][n].push(c)}a=function(a){return f[n][h].indexOf(a)!==-1};for(c=0;c<d;c++){e=this.faces[c];var y=null;g=0;for(b=e.points.length;g<b;g++)g?(o=g,m=g-1):(o=g,m=b-1),h=e.points[o],n=e.points[m],y=y?y.filter(a):f[n][h];y.length&&(this.faces.splice(c,1),d--,c--)}return this},prepare:function(c){c===q&&(c=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();
this.triangulateQuads().calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();c&&!this.dynamic&&this.clean();return this},clean:function(){var c,g;c=0;for(g=this.points.length;c<g;c++)delete this.points[c],this.points[c]=null;this.points=[];c=0;for(g=this.faces.length;c<g;c++)delete this.faces[c].points,delete this.faces[c].point_normals,delete this.faces[c].uvs,delete this.faces[c].normal,delete this.faces[c],this.faces[c]=null;this.faces=[];return this},
compileMap:function(c){var g=m.vec3,a=m.vec2;c===q&&(c=1.0E-5);var b={segments:[],bounds:[]},e=[],f,d,h,n,o,B,y,w;this.materials.length||this.materials.push(new m.Material);f=0;for(B=this.materials.length;f<B;f++)e[f]=[];f=0;for(B=this.faces.length;f<B;f++)if(this.faces[f].points.length===3)h=this.faces[f].material,n=this.faces[f].segment,e[h][n]===q&&(e[h][n]=[],b.segments.push(n)),e[h][n].push(f);var v=[],r=0,s=!1,I=!1,u=!1,t;f=0;for(B=e.length;f<B;f++)for(d in e[f])if(e[f].hasOwnProperty(d))for(h=
0;h<e[f][d].length;h++)t=e[f][d][h],s=s||this.faces[t].uvs.length!==0,I=I||this.faces[t].point_normals.length!==0,u=u||this.faces[t].point_colors.length!==0;if(s)for(f=0;f<this.faces.length;f++)if(!this.faces[f].uvs.length)for(d=0;d<this.faces[f].points.length;d++)this.faces[f].uvs.push([0,0]);if(I)for(f=0;f<this.faces.length;f++)if(!this.faces[f].point_normals.length)for(d=0;d<this.faces[f].points.length;d++)this.faces[f].point_normals.push([0,0,0]);if(u)for(f=0;f<this.faces.length;f++)if(!this.faces[f].point_colors.length)for(d=
0;d<this.faces[f].points.length;d++)this.faces[f].point_colors.push([0,0,0]);f=0;for(B=e.length;f<B;f++)for(d in e[f])if(e[f].hasOwnProperty(d)){h=0;for(y=e[f][d].length;h<y;h++){t=e[f][d][h];for(n=0;n<3;n++){var x=this.faces[t].points[n],C=-1;if(v[x]!==q){o=0;for(w=v[x].length;o<w;o++){var D=v[x][o][0],z=v[x][o][1],C=v[x][o][2];I&&(C=g.equal(this.faces[D].point_normals[z],this.faces[t].point_normals[n],c)?C:-1);s&&(C=a.equal(this.faces[D].uvs[z],this.faces[t].uvs[n],c)?C:-1);u&&(C=g.equal(this.faces[D].point_colors[z],
this.faces[t].point_colors[n],c)?C:-1)}}if(C!==-1){if(b.elements===q)b.elements=[];b.elements[f]===q&&(b.elements[f]=[]);b.elements[f][d]===q&&(b.elements[f][d]=[]);b.elements[f][d].push(C)}else{if(b.points===q)b.points=[];b.points.push(x);b.bounds.length===0?(b.bounds[0]=[this.points[x][0],this.points[x][1],this.points[x][2]],b.bounds[1]=[this.points[x][0],this.points[x][1],this.points[x][2]]):(this.points[x][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[x][0]),this.points[x][1]<b.bounds[0][1]&&
(b.bounds[0][1]=this.points[x][1]),this.points[x][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[x][2]),this.points[x][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[x][0]),this.points[x][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[x][1]),this.points[x][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[x][2]));if(I){if(b.normals===q)b.normals=[];b.normals.push([t,n])}if(u){if(b.colors===q)b.colors=[];b.colors.push([t,n])}if(s){if(b.uvs===q)b.uvs=[];b.uvs.push([t,n])}if(b.elements===q)b.elements=[];
b.elements[f]===q&&(b.elements[f]=[]);b.elements[f][d]===q&&(b.elements[f][d]=[]);b.elements[f][d].push(r);v[x]===q&&(v[x]=[]);v[x].push([t,n,r]);r++}}}}if(this.edges){b.line_elements=[];f=0;for(B=this.edges.length;f<B;f++)g=this.edges[f],h=g[0],n=g[1],c=g[2],g=g[3],b.line_elements[h]=b.line_elements[h]||[],b.line_elements[h][n]=b.line_elements[h][n]||[],b.line_elements[h][n].push(v[c][0][2]),b.line_elements[h][n].push(v[g][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(c,g,a,b,e,f,d,
h){if(typeof g=="object")g=g.element!==q?g.element:!0,a=g.vertex!==q?g.vertex:!0,f=g.color!==q?g.color:!0,b=g.normal!==q?g.normal:!0,e=g.uv!==q?g.uv:!0,d=g.lines!==q?g.lines:!!c.line_elements,h=g.dynamic!==q?g.dynamic:c.dynamic;else if(g===q&&(g=!0),a===q&&(a=!0),f===q&&(f=!0),b===q&&(b=!0),e===q&&(e=!0),d===q&&(d=!!c.line_elements),h===q)h=c.dynamic;var n={},o,m,y,w,v;if(h)w={points:new Int16Array(c.points.length),face_points:new Int16Array(c.points.length*2),segments:null},n.dynamicMap=w,n.dynamic=
!0;if(c.points&&a){o=c.points.length;n.vbo_points=new Float32Array(o*3);for(a=0;a<o;a++)m=c.points[a],n.vbo_points[a*3]=this.points[m][0],n.vbo_points[a*3+1]=this.points[m][1],n.vbo_points[a*3+2]=this.points[m][2],h&&(w.points[a]=m)}if(h){v=c.normals||c.colors||c.uvs;a=0;for(o=v.length;a<o;a++)m=v[a],w.face_points[a*2]=m[0],w.face_points[a*2+1]=m[1]}if(c.normals&&b){o=c.normals.length;n.vbo_normals=new Float32Array(o*3);for(a=b=0;a<o;a++)m=c.normals[a],n.vbo_normals[b++]=this.faces[m[0]].point_normals[m[1]][0],
n.vbo_normals[b++]=this.faces[m[0]].point_normals[m[1]][1],n.vbo_normals[b++]=this.faces[m[0]].point_normals[m[1]][2]}if(c.colors&&f){o=c.colors.length;n.vbo_colors=new Float32Array(o*3);for(a=b=0;a<o;a++)m=c.colors[a],n.vbo_colors[b++]=this.faces[m[0]].point_colors[m[1]][0],n.vbo_colors[b++]=this.faces[m[0]].point_colors[m[1]][1],n.vbo_colors[b++]=this.faces[m[0]].point_colors[m[1]][2]}if(c.uvs&&e){o=c.uvs.length;n.vbo_uvs=new Float32Array(o*2);for(a=b=0;a<o;a++)m=c.uvs[a],n.vbo_uvs[b++]=this.faces[m[0]].uvs[m[1]][0],
n.vbo_uvs[b++]=this.faces[m[0]].uvs[m[1]][1]}if(g){n.elements_ref=[];n.vbo_elements=[];a=0;for(o=c.elements.length;a<o;a++)for(y in n.elements_ref[a]=[],g=0,c.elements[a])if(c.elements[a].hasOwnProperty(y)){b=c.elements[a][y];e=0;for(f=b.length;e<f;e++)n.vbo_elements.push(b[e]);n.elements_ref[a][g]=[y|0,b.length|0];g++}n.vbo_elements=new Uint16Array(n.vbo_elements)}if(d){n.line_elements_ref=[];n.vbo_line_elements=[];a=0;for(o=c.line_elements.length;a<o;a++)for(y in n.line_elements_ref[a]=[],g=0,c.line_elements[a])if(c.line_elements[a].hasOwnProperty(y)){b=
c.line_elements[a][y];e=0;for(f=b.length;e<f;e++)n.vbo_line_elements.push(b[e]);n.line_elements_ref[a][g]=[y|0,b.length|0];g++}n.vbo_line_elements=new Uint16Array(n.vbo_line_elements)}n.segments=c.segments;n.bounds=c.bounds;if(h&&c.segments.length>1){c=[];v=w.points;a=0;for(o=v.length;a<o;a++)d=this.faces[w.face_points[a*2]].segment||0,c[d]===q&&(c[d]=[]),c[d].push(a);n.dynamicMap.segmentMap=c}return n},updateVBO:function(c,g){if(!c.dynamic)return!1;var a,b,e=c.dynamicMap,f=g.points&&!!c.vbo_points,
d=g.normals&&!!c.vbo_normals,h=g.uvs&&!!c.vbo_uvs,n=g.colors&&!!c.vbo_colors;b=g.segments;var o,m,y;if(g.segments!==q)for(var w=0,v=b.length;w<v;w++)for(var r=e.segmentMap[b[w]],s=0,x=r.length;s<x;s++)a=r[s],m=this.faces[e.face_points[a*2]],y=e.face_points[a*2+1],f&&(o=this.points[e.points[a]],c.vbo_points[a*3]=o[0],c.vbo_points[a*3+1]=o[1],c.vbo_points[a*3+2]=o[2]),d&&(o=m.point_normals[y],c.vbo_normals[a*3]=o[0],c.vbo_normals[a*3+1]=o[1],c.vbo_normals[a*3+2]=o[2]),n&&(o=m.point_colors[y],c.vbo_colors[a*
3]=o[0],c.vbo_colors[a*3+1]=o[1],c.vbo_colors[a*3+2]=o[2]),h&&(o=m.uvs[y],c.vbo_uvs[a*2]=o[0],c.vbo_uvs[a*2+1]=o[1]);else{a=0;for(b=e.points.length;a<b;a++)m=this.faces[e.face_points[a*2]],y=e.face_points[a*2+1],f&&(o=this.points[e.points[a]],c.vbo_points[a*3]=o[0],c.vbo_points[a*3+1]=o[1],c.vbo_points[a*3+2]=o[2]),d&&(o=m.point_normals[y],c.vbo_normals[a*3]=o[0],c.vbo_normals[a*3+1]=o[1],c.vbo_normals[a*3+2]=o[2]),n&&(o=m.point_colors[y],c.vbo_colors[a*3]=o[0],c.vbo_colors[a*3+1]=o[1],c.vbo_colors[a*
3+2]=o[2]),h&&(o=m.uvs[y],c.vbo_uvs[a*2]=o[0],c.vbo_uvs[a*2+1]=o[1])}return this},rebufferVBO:function(c,g,a){var b=r.gl;a.points&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_points),b.bufferData(b.ARRAY_BUFFER,c.vbo_points,b.DYNAMIC_DRAW));a.normals&&c.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_normals),b.bufferData(b.ARRAY_BUFFER,c.vbo_normals,b.DYNAMIC_DRAW));a.uvs&&c.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs),b.bufferData(b.ARRAY_BUFFER,c.vbo_uvs,b.DYNAMIC_DRAW));a.colors&&c.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,
g.gl_colors),b.bufferData(b.ARRAY_BUFFER,c.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(c,g){var a=r.gl,b={};g===q&&(g={});b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,c.vbo_points,a.STATIC_DRAW);c.vbo_normals?(b.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_normals),a.bufferData(a.ARRAY_BUFFER,c.vbo_normals,a.STATIC_DRAW)):b.gl_normals=g.gl_normals?g.gl_normals:null;c.vbo_uvs?
(b.gl_uvs=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_uvs),a.bufferData(a.ARRAY_BUFFER,c.vbo_uvs,a.STATIC_DRAW)):b.gl_uvs=g.gl_uvs?g.gl_uvs:null;c.vbo_colors?(b.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_colors),a.bufferData(a.ARRAY_BUFFER,c.vbo_colors,a.STATIC_DRAW)):b.gl_colors=g.gl_colors?g.gl_colors:null;!c.vbo_elements&&g.gl_elements?(b.gl_elements=g.gl_elements,b.elements_ref=g.elements_ref):(b.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_elements),
a.bufferData(a.ELEMENT_ARRAY_BUFFER,c.vbo_elements,a.STATIC_DRAW),b.elements_ref=c.elements_ref);!c.vbo_line_elements&&g.gl_line_elements?(b.gl_line_elements=g.gl_line_elements,b.line_elements_ref=g.line_elements_ref):(b.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,c.vbo_line_elements,a.STATIC_DRAW),b.line_elements_ref=c.line_elements_ref);b.segments=c.segments;b.bounds=c.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);
return b},update:function(c){var c=c||{},g=c.points||c.point||c.vertex||c.vertices||c.all||!0,a=c.uvs||c.uv||c.texture||c.all||!1,b=c.normals||c.normal||c.all||!0,e=c.colors||c.color||c.all||!1,c=c.segments||c.segment;c!==q&&c.length===q&&(c=[c]);if(!this.dynamic)return s("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals(q,{segments:c});g={points:g,uvs:a,normals:b,colors:e,segments:c};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,
this.dynamicData.buffer,g)},bindBuffer:function(c){if(this.originBuffer===null)this.originBuffer=c;this.compiled=c;this.segment_state=[];for(var g=0,a=c.segments.length;g<a;g++)this.segment_state[c.segments[g]]=!0;this.bb=c.bounds},compile:function(c){if(this.faces.length>0&&this.points.length>0){var c=this.compileVBO(this.compileMap(c)),g=this.bufferVBO(c);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,b=this.points.length;a<b;a++)this.sourcePoints[a]=this.points[a].slice(0);
this.dynamicData={VBO:c,buffer:g}}}return this},addMorphTarget:function(c){if(this.morphTargets===null)this.morphTargets=[];this.morphTargets.push(c)},setMorphSource:function(c){if(this.morphSourceIndex!==c)this.morphSourceIndex=c,this.bindBuffer(this.morphTargets[c])},setMorphTarget:function(c){if(this.morphTargetIndex!==c)this.morphTargetIndex=c,this.morphTarget=this.morphTargets[c]},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:
0}};return{Mesh:z,Face:x}});
CubicVR.RegisterModule("Motion",function(m){function x(){this.time=this.value=0;this.shape=s.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function z(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(s.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||s.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||s.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=s.envelope.behavior.CONSTANT}function q(a,d){this.controllers=[];this.yzflip=!1;if(typeof a==="object"){var b=CubicVR.get(a);this.env_init=CubicVR.get(b.envelope);this.key_init=CubicVR.get(b.key);for(var n in b)if(b.hasOwnProperty(n)&&!(n==="envelope"||n==="key")){var e=b[n],c=CubicVR.get(e.envelope),g;for(g in e)if(e.hasOwnProperty(g)&&!(g==="envelope"||g==="key")){var w=e[g];if(typeof w==="object")for(var m in w)this.setKey(n,m,g,w[m]),c&&this.setBehavior(n,m,
c)}}}else this.env_init=a,this.key_init=d}var r=m.undef,s=CubicVR.enums;s.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};s.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var c=function(a,d,b){var n=0,n=b-d;if(n===0)return[d,0];d=a-n*Math.floor((a-d)/n);n=-parseInt((d-a)/n+(d>a?0.5:-0.5),10);return[d,n]},g=function(a,d,b,n,e){var c,g;g=e*e;c=3*(d-
a);d=3*(b-d)-c;return(n-a-c-d)*g*e+d*g+c*e+a},a=function(b,d,h,n,e,c,m){var w,v;v=c+(m-c)*0.5;w=g(b,d,h,n,v);return Math.abs(e-w)>1.0E-4?(w>e?m=v:c=v,a(b,d,h,n,e,c,m)):v},b=function(a,d){var b,n,e,c;a.shape===s.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),n=(1-a.tension)*(1-a.continuity)*(1-a.bias),e=d.value-a.value,a.prev?(c=(d.time-a.time)/(d.time-a.prev.time),b=c*(b*(a.value-a.prev.value)+n*e)):b=n*e):a.shape===s.envelope.shape.LINE?(e=d.value-a.value,a.prev?(c=(d.time-a.time)/
(d.time-a.prev.time),b=c*(a.value-a.prev.value+e)):b=e):a.shape===s.envelope.shape.BEZI||a.shape===s.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(d.time-a.time)/(d.time-a.prev.time))):a.shape===s.envelope.shape.BEZ2?(b=a.param[3]*(d.time-a.time),Math.abs(a.param[2])>1.0E-5?b/=a.param[2]:b*=1E5):b=0;return b},e=function(a,d){var b,n,e,c;d.shape===s.envelope.shape.LINE?(e=d.value-a.value,d.next?(c=(d.time-a.time)/(d.next.time-a.time),b=c*(d.next.value-d.value+e)):b=e):d.shape===s.envelope.shape.TCB?
(b=(1-d.tension)*(1-d.continuity)*(1+d.bias),n=(1-d.tension)*(1+d.continuity)*(1-d.bias),e=d.value-a.value,d.next?(c=(d.time-a.time)/(d.next.time-a.time),b=c*(n*(d.next.value-d.value)+b*e)):b*=e):d.shape===s.envelope.shape.HERM||d.shape===s.envelope.shape.BEZI?(b=d.param[0],d.next&&(b*=(d.time-a.time)/(d.next.time-a.time))):d.shape===s.envelope.shape.BEZ2?(b=d.param[1]*(d.time-a.time),Math.abs(d.param[0])>1.0E-5?b/=d.param[0]:b*=1E5):b=0;return b};z.prototype={setBehavior:function(a,d){this.in_behavior=
CubicVR.parseEnum(s.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,d)},empty:function(){return this.nKeys===0},addKey:function(a,d,b){var n=typeof a=="object"?a:b;d||(d=0);a||(a=0);n?(n=a,a=n.time,b=this.insertKey(a),b.value=n.value?n.value:d,b.time=n.time?n.time:a,b.shape=CubicVR.parseEnum(s.envelope.shape,n.shape)||s.envelope.shape.TCB,b.tension=n.tension?n.tension:0,b.continuity=n.continuity?n.continuity:0,b.bias=n.bias?n.bias:0,b.param=n.param?n.param:[0,0,0,0]):
(b=this.insertKey(a),b.value=d);return b},insertKey:function(a){var d=new x;d.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=d,this.nKeys++,d;for(var b=this.keys;b;){if(this.firstKey.time>a)this.firstKey=d;else if(this.lastKey.time<a)this.lastKey=d;if(b.time>d.time){d.prev=b.prev;if(d.prev)d.prev.next=d;d.next=b;d.next.prev=d;this.nKeys++;return d}else if(!b.next)return d.prev=b,b.next=d,this.nKeys++,d;b=b.next}return null},evaluate:function(f){var d,h,n,o,m,y=0;if(this.nKeys===
0)return 0;if(this.nKeys===1)return this.keys.value;h=this.firstKey;d=this.lastKey;if(f<h.time)if(o=this.in_behavior,o===s.envelope.behavior.RESET)return 0;else if(o===s.envelope.behavior.CONSTANT)return h.value;else if(o===s.envelope.behavior.REPEAT)o=c(f,h.time,d.time),f=o[0];else if(o===s.envelope.behavior.OCILLATE)o=c(f,h.time,d.time),f=o[0],o=o[1],o%2&&(f=d.time-h.time-f);else if(o===s.envelope.behavior.OFFSET)o=c(f,h.time,d.time),f=o[0],o=o[1],y=o*(d.value-h.value);else{if(o===s.envelope.behavior.LINEAR)return m=
b(h,h.next)/(h.next.time-h.time),m*(f-h.time)+h.value}else if(f>d.time)if(o=this.out_behavior,o===s.envelope.behavior.RESET)return 0;else if(o===s.envelope.behavior.CONSTANT)return d.value;else if(o===s.envelope.behavior.REPEAT)o=c(f,h.time,d.time),f=o[0];else if(o===s.envelope.behavior.OCILLATE)o=c(f,h.time,d.time),f=o[0],o=o[1],o%2&&(f=d.time-h.time-f);else if(o===s.envelope.behavior.OFFSET)o=c(f,h.time,d.time),f=o[0],o=o[1],y=o*(d.value-h.value);else if(o===s.envelope.behavior.LINEAR)return o=
e(d.prev,d)/(d.time-d.prev.time),o*(f-d.time)+d.value;if(this.lastKey0)if(f>this.lastKey0.time)d=this.lastKey0;else if(f<this.lastKey0.time)for(d=this.lastKey;f<d.time&&d.prev;)d=d.prev;else d=this.keys;else d=this.keys;for(;f>d.next.time;)d=d.next;h=d.next;this.lastKey0=d;if(f===d.time)return d.value+y;else if(f===h.time)return h.value+y;n=(f-d.time)/(h.time-d.time);o=h.shape;if(o===s.envelope.shape.TCB||o===s.envelope.shape.BEZI||o===s.envelope.shape.HERM){m=b(d,h);o=e(d,h);var w,v;v=n*n;w=n*v;
f=3*v-w-w;w-=v;f=[1-f,f,w-v+n,w];return f[0]*d.value+f[1]*h.value+f[2]*m+f[3]*o+y}else return o===s.envelope.shape.BEZ2?(f=a(d.time,d.shape===s.envelope.shape.BEZ2?d.time+d.param[2]:d.time+(h.time-d.time)/3,h.time+h.param[0],h.time,f,0,1),y=g(d.value,d.shape===s.envelope.shape.BEZ2?d.value+d.param[3]:d.value+d.param[1]/3,h.param[1]+h.value,h.value,f)+y):y=o===s.envelope.shape.LINE?d.value+n*(h.value-d.value)+y:o===s.envelope.shape.STEP?d.value+y:y,y}};q.prototype={clone:function(){var a=new m.Motion(this.env_init,
this.key_init),d;for(d in this.controllers)if(this.controllers.hasOwnProperty(d)){a.controllers[d]===r&&(a.controllers[d]=[]);for(var b in this.controllers[d])if(this.controllers[d].hasOwnProperty(b)){var n=this.controllers[d][b],e=a.controllers[d][b]=new z({in_behavior:n.in_behavior,out_behavior:n.out_behavior});e.nKeys=n.nKeys;e.keys=n.keys;e.firstKey=n.firstKey;e.lastKey=n.lastKey}}return a},envelope:function(a,d){d=CubicVR.parseEnum(s.motion,d)||0;a=CubicVR.parseEnum(s.motion,a)||0;this.controllers[a]===
r&&(this.controllers[a]=[]);this.controllers[a][d]===r&&(this.controllers[a][d]=new z(this.env_init));return this.controllers[a][d]},evaluate:function(a){var d=[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){d[b]=[];for(var n in this.controllers[b])this.controllers[b].hasOwnProperty(n)&&(d[b][n]=this.controllers[b][n].evaluate(a))}return d},apply:function(a,d){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var n=parseInt(b,10);if(this.yzflip&&n===s.motion.ROT){if(!this.q)this.q=
new CubicVR.Quaternion;var e=this.q,c=this.controllers[b][0].evaluate(a),g=this.controllers[b][1].evaluate(a),w=this.controllers[b][2].evaluate(a);e.fromEuler(c,w,-g);e=e.toEuler();d.control(n,0,e[0]);d.control(n,1,e[1]);d.control(n,2,e[2])}else for(var m in this.controllers[b])this.controllers[b].hasOwnProperty(m)&&d.control(n,parseInt(m,10),this.controllers[b][m].evaluate(a))}},setKey:function(a,d,b,n,e){d=CubicVR.parseEnum(s.motion,d)||0;a=CubicVR.parseEnum(s.motion,a)||0;return this.envelope(a,
d).addKey(b,n,e?e:this.key_init)},setArray:function(a,d,b,n){var e=[],a=CubicVR.parseEnum(s.motion,a)||0,c;for(c in b)if(b.hasOwnProperty(c)){var g=this.envelope(a,CubicVR.parseEnum(s.motion,c));e[c]=g.addKey(d,b[c],n?n:this.key_init)}return e},setBehavior:function(a,d,b,n){var e=this.envelope(a,d);typeof b==="object"&&(n=b,b=n.in_behavior||n.inBehavior||n.behavior,n=n.out_behavior||n.outBehavior||n.behavior);CubicVR.parseEnum(s.motion,d);CubicVR.parseEnum(s.motion,a);e.setBehavior(b,n)},setBehaviorArray:function(a,
d,b){var a=CubicVR.parseEnum(s.motion,a)||0,n=this.controllers[a],e;for(e in n)n.hasOwnProperty(e)&&this.envelope(a,CubicVR.parseEnum(s.motion,e)||0).setBehavior(d,b)}};return{Motion:q,Envelope:z,EnvelopeKey:x}});
CubicVR.RegisterModule("Octree",function(m){function x(a,e,f,d,h){var n=this._children=[];this._dirty=!1;n[0]=null;n[1]=null;n[2]=null;n[3]=null;n[4]=null;n[5]=null;n[6]=null;n[7]=null;this._child_index=h||-1;this._root=f||null;this._max_depth=e||0;a=this._size=a||0;d=this._position=d||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[d[0],d[1],d[2],Math.sqrt(3*(this._size/2*this._size/2))];e=this._bbox=[[0,0,0],[0,0,0]];f=m.aabb;f.reset(e,d);a/=2;f.engulf(e,[d[0]+a,d[1]+
a,d[2]+a]);f.engulf(e,[d[0]-a,d[1]-a,d[2]-a]);this._debug_visible=!1}function z(){this.position=[0,0,0];this.visible=!1;this._object=null}function q(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var r=m.undef,s=m.plane,c=m.sphere,g=m.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,e,f){f=a.slice((f||e)+1||a.length);
a.length=e<0?a.length+e:e;return a.push.apply(a,f)};x.prototype.destroy=function(){var a,e,f;a=0;for(e=this._static_lights.length;a<e;++a)f=this._static_lights[a],f.octree_leaves=null,f.octree_common_root=null,f.octree_aabb=null;a=0;for(e=this._lights.length;a<e;++a)f=this._lights[a],f.octree_leaves=null,f.octree_common_root=null,f.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(e=this._children.length;a<e;++a)this._children[a]!==null&&this._children[a].destroy();a=0;for(e=this._nodes.length;a<
e;++a)f=this._nodes[a],f.octree_leaves=null,f.octree_common_root=null,f.octree_aabb=null,f.dynamic_lights=[],f.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};x.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};x.prototype.remove=function(b){var e=!1,f=this._nodes.length,d;d=f-1;for(f=this._nodes.length;d>=0;--d)if(b===this._nodes[d]){a(this._nodes,d);this.dirty_lineage();e=!0;break}if(!e)for(d=f-1;d>=0;--d)if(b===this._lights[d]){a(this._lights,d);this.dirty_lineage();break}};x.prototype.dirty_lineage=function(){this._dirty=!0;this._root!==null&&
this._root.dirty_lineage()};x.prototype.cleanup=function(){for(var a=this._children.length,e=0,f=0;f<a;++f){var d=this._children[f];if(d!==null){var h=!0;d._dirty===!0&&(h=d.cleanup());h?++e:this._children[f]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(e===0||a===0))return!1;return!0};x.prototype.insert_light=function(a){this.insert(a,!0)};x.prototype.propagate_static_light=function(a){var e,f;e=0;for(f=this._nodes.length;e<f;++e)this._nodes[e].static_lights.indexOf(a)===
-1&&this._nodes[e].static_lights.push(a);for(e=0;e<8;++e)this._children[e]!==null&&this._children[e].propagate_static_light(a)};x.prototype.collect_static_lights=function(a){var e,f;e=0;for(f=this._static_lights.length;e<f;++e)a.static_lights.indexOf(this._static_lights[e])===-1&&a.static_lights.push(this._static_lights[e]);for(e=0;e<8;++e)this._children[e]!==null&&this._children[e].collect_static_lights(a)};x.prototype.insert=function(a,e){function f(a,d,b,f){var h,n;if(b)if(d.method===g.light.method.STATIC){a._static_lights.indexOf(d)===
-1&&a._static_lights.push(d);b=0;for(h=a._nodes.length;b<h;++b)a._nodes[b].static_lights.indexOf(d)===-1&&a._nodes[b].static_lights.push(d);for(n=a._root;n!==null;){b=0;for(l=n._nodes.length;b<l;++b)h=n._nodes[b],h.static_lights.indexOf(d)===-1&&h.static_lights.push(d);n=n._root}}else a._lights.indexOf(d)===-1&&a._lights.push(d);else{a._nodes.push(d);b=0;for(h=a._static_lights.length;b<h;++b)d.static_lights.indexOf(a._static_lights[b])===-1&&d.static_lights.push(a._static_lights[b]);for(n=a._root;n!==
null;){b=0;for(h=n._static_lights.length;b<h;++b){var e=n._static_lights[b];d.static_lights.indexOf(e)===-1&&d.static_lights.push(e)}n=n._root}}d.octree_leaves.push(a);d.octree_common_root=f;f=m.aabb;f.engulf(d.octree_aabb,a._bbox[0]);f.engulf(d.octree_aabb,a._bbox[1])}e===r&&(e=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)f(this,a,e,this._root);else{var d=this._position,h,n,o,c,y,w,v;n=a.getAABB();v=[n[0][0],n[0][1],n[0][2]];var A=[n[1][0],n[1][1],
n[1][2]];h=v[0]<d[0]&&v[1]<d[1]&&v[2]<d[2];n=A[0]>d[0]&&v[1]<d[1]&&v[2]<d[2];y=v[0]<d[0]&&A[1]>d[1]&&v[2]<d[2];w=A[0]>d[0]&&A[1]>d[1]&&v[2]<d[2];o=v[0]<d[0]&&v[1]<d[1]&&A[2]>d[2];c=A[0]>d[0]&&v[1]<d[1]&&A[2]>d[2];v=v[0]<d[0]&&A[1]>d[1]&&A[2]>d[2];d=A[0]>d[0]&&A[1]>d[1]&&A[2]>d[2];if(h&&n&&y&&w&&o&&c&&v&&d)f(this,a,e,this),e?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var A=0,q=this._static_lights.length;A<q;++A){if(a.static_lights===r)a.static_lights=
[];a.static_lights.indexOf(this._static_lights[A])===-1&&a.static_lights.push(this._static_lights[A])}var A=this._size/2,q=this._size/4,s=0,u=this._position[0],t=this._position[1],z=this._position[2];h&&(h=[u-q,t-q,z-q],this._children[g.octree.TOP_NW]===null&&(this._children[g.octree.TOP_NW]=new x(A,this._max_depth-1,this,h,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,e),++s);n&&(h=[u+q,t-q,z-q],this._children[g.octree.TOP_NE]===null&&(this._children[g.octree.TOP_NE]=new x(A,this._max_depth-
1,this,h,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,e),++s);y&&(h=[u-q,t+q,z-q],this._children[g.octree.BOTTOM_NW]===null&&(this._children[g.octree.BOTTOM_NW]=new x(A,this._max_depth-1,this,h,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,e),++s);w&&(h=[u+q,t+q,z-q],this._children[g.octree.BOTTOM_NE]===null&&(this._children[g.octree.BOTTOM_NE]=new x(A,this._max_depth-1,this,h,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,e),++s);o&&(h=[u-q,t-q,
z+q],this._children[g.octree.TOP_SW]===null&&(this._children[g.octree.TOP_SW]=new x(A,this._max_depth-1,this,h,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,e),++s);c&&(h=[u+q,t-q,z+q],this._children[g.octree.TOP_SE]===null&&(this._children[g.octree.TOP_SE]=new x(A,this._max_depth-1,this,h,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,e),++s);v&&(h=[u-q,t+q,z+q],this._children[g.octree.BOTTOM_SW]===null&&(this._children[g.octree.BOTTOM_SW]=new x(A,this._max_depth-1,this,
h,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,e),++s);d&&(h=[u+q,t+q,z+q],this._children[g.octree.BOTTOM_SE]===null&&(this._children[g.octree.BOTTOM_SE]=new x(A,this._max_depth-1,this,h,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,e),++s);if(s>1||a.octree_common_root===null)a.octree_common_root=this}}};x.prototype.draw_on_map=function(a,e,f){function d(a,d,b,f,o){var c=a<b?a:b,g=d<f?d:f,a=a<b?b-a:a-b,d=d<f?f-d:d-f;e.save();if(o!==void 0)e.fillStyle=o,e.fillRect(h+
c,n+g,a,d);e.strokeRect(h+c,n+g,a,d);e.restore()}var h=a.width/2,n=a.height/2,o,c,g,w,m,q,s;if(f===r||f==="map")e.save(),this._debug_visible!==!1?(e.fillStyle="rgba(0,0,0,0)",e.strokeStyle="#FF0000"):(e.fillStyle="rgba(0,0,0,0)",e.strokeStyle="rgba(0,0,0,0)"),e.beginPath(),m=this._size/2,o=this._position[0],c=this._position[2],e.moveTo(h+o-m,h+c-m),e.lineTo(h+o-m,h+c+m),e.lineTo(h+o+m,h+c+m),e.lineTo(h+o+m,h+c-m),e.stroke(),e.fill(),e.restore();if(f===r||f==="objects"){e.save();m=0;for(s=this._nodes.length;m<
s;++m)q=this._nodes[m],e.fillStyle="#5500FF",e.strokeStyle=q.visible===!0&&q.culled===!1?"#FFFFFF":"#000000",e.beginPath(),o=q.aabb[0][0],c=q.aabb[0][2],g=q.aabb[1][0]-o,w=q.aabb[1][2]-c,e.rect(h+o,n+c,g,w),e.stroke();e.restore()}if(f===r||f==="lights"){m=0;for(s=this._lights.length;m<s;++m)w=this._lights[m],e.fillStyle=w.culled===!1&&w.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",e.strokeStyle="#FFFF00",e.beginPath(),q=w.distance,o=w.position[0],c=w.position[2],e.arc(h+o,n+
c,q,0,Math.PI*2,!0),e.closePath(),e.stroke(),e.fill(),e.beginPath(),o=w.aabb[0][0],c=w.aabb[0][2],g=w.aabb[1][0]-o,w=w.aabb[1][2]-c,e.rect(h+o,n+c,g,w),e.closePath(),e.stroke();m=0;for(s=this._static_lights.length;m<s;++m)w=this._static_lights[m],e.fillStyle=w.culled===!1&&w.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",e.strokeStyle="#FF66BB",e.beginPath(),q=w.distance,o=w.position[0],c=w.position[2],e.arc(h+o,n+c,q,0,Math.PI*2,!0),e.closePath(),e.stroke(),e.fill(),e.beginPath(),
o=w.aabb[0][0],c=w.aabb[0][2],g=w.aabb[1][0]-o,w=w.aabb[1][2]-c,e.rect(h+o,n+c,g,w),e.closePath(),e.stroke()}if(f!="lights"&&f!="objects"&&f!="map"){e.save();o=this._nodes;m=0;for(w=o.length;m<w;++m)if(q=o[m],q.name==f){e.strokeStyle="#FFFF00";e.lineWidth=3;e.beginPath();o=q.aabb[0][0];c=q.aabb[0][2];g=q.aabb[1][0]-o;w=q.aabb[1][2]-c;e.rect(h+o,n+c,g,w);e.closePath();e.stroke();o=q.octree_aabb;e.strokeStyle="#0000FF";d(o[0][0],o[0][2],o[1][0],o[1][2]);e.lineWidth=1;if(q.common_root!==null)e.strokeStyle=
"#00FF00";break}e.lineWidth=1;e.strokeStyle="#FFFF00";d(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");e.fill();e.restore()}m=0;for(s=this._children.length;m<s;++m)this._children[m]!==null&&this._children[m].draw_on_map(a,e,f)};x.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=
this._position[2]-this._size/2};x.prototype.get_frustum_hits=function(a,e){var f={objects:[],lights:[]};if((e===r||e===!0)&&!this.contains_point(a.position)){if(c.intersects(a.frustum.sphere,this._sphere)===!1)return f;var d=a.frustum.contains_sphere(this._sphere);if(d===-1)return this._debug_visible=!1,f;else if(d===1)this._debug_visible=2,e=!1;else if(d===0)if(this._debug_visible=!0,d=a.frustum.contains_box(this._bbox),d===-1)return this._debug_visible=!1,f;else if(d===1)this._debug_visible=3,e=
!1}var h,n,d=0;for(h=this._nodes.length;d<h;++d)n=this._nodes[d],f.objects.push(n),n.dynamic_lights=[].concat(this._lights),n.was_culled=n.culled,n.culled=!1,n.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;d=0;for(h=this._lights.length;d<h;++d)if(n=this._lights[d],n.visible===!0)f.lights.push(n),n.was_culled=n.culled,n.culled=!1;d=0;for(h=this._static_lights.length;d<h;++d)if(n=this._static_lights[d],n.visible===!0)n.culled=!1;for(d=0;d<8;++d)if(this._children[d]!==
null){h=this._children[d].get_frustum_hits(a,e);var o;n=0;for(o=h.objects.length;n<o;++n){f.objects.push(h.objects[n]);for(var g=h.objects[n].dynamic_lights,m=0,w=this._lights.length;m<w;++m)g.indexOf(this._lights[m])<0&&g.push(this._lights[m])}n=0;for(o=h.lights.length;n<o;++n)f.lights.indexOf(h.lights[n])<0&&f.lights.push(h.lights[n])}return f};x.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,e;a=0;for(e=this._nodes.length;a<e;++a)this._nodes[a].culled=!0;a=0;for(e=this._lights.length;a<
e;++a)this._lights[a].culled=!0;a=0;for(e=this._static_lights.length;a<e;++a)this._static_lights[a].culled=!0;a=0;for(e=this._children.length;a<e;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};z.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};z.prototype.attach=function(a){this._object=a};q.prototype.extract=function(a,e,f){var d=m.vec3;if(!(e===r||f===r)){var h=m.mat4.multiply(f,e),e=this._planes;e[g.frustum.plane.LEFT][0]=h[3]+h[0];e[g.frustum.plane.LEFT][1]=
h[7]+h[4];e[g.frustum.plane.LEFT][2]=h[11]+h[8];e[g.frustum.plane.LEFT][3]=h[15]+h[12];e[g.frustum.plane.RIGHT][0]=h[3]-h[0];e[g.frustum.plane.RIGHT][1]=h[7]-h[4];e[g.frustum.plane.RIGHT][2]=h[11]-h[8];e[g.frustum.plane.RIGHT][3]=h[15]-h[12];e[g.frustum.plane.TOP][0]=h[3]-h[1];e[g.frustum.plane.TOP][1]=h[7]-h[5];e[g.frustum.plane.TOP][2]=h[11]-h[9];e[g.frustum.plane.TOP][3]=h[15]-h[13];e[g.frustum.plane.BOTTOM][0]=h[3]+h[1];e[g.frustum.plane.BOTTOM][1]=h[7]+h[5];e[g.frustum.plane.BOTTOM][2]=h[11]+
h[9];e[g.frustum.plane.BOTTOM][3]=h[15]+h[13];e[g.frustum.plane.NEAR][0]=h[3]+h[2];e[g.frustum.plane.NEAR][1]=h[7]+h[6];e[g.frustum.plane.NEAR][2]=h[11]+h[10];e[g.frustum.plane.NEAR][3]=h[15]+h[14];e[g.frustum.plane.FAR][0]=h[3]-h[2];e[g.frustum.plane.FAR][1]=h[7]-h[6];e[g.frustum.plane.FAR][2]=h[11]-h[10];e[g.frustum.plane.FAR][3]=h[15]-h[14];for(var n=0;n<6;++n)s.normalize(e[n]);n=-e[g.frustum.plane.NEAR][3];e=e[g.frustum.plane.FAR][3]-n;f=e*(1/f[5]);f=d.subtract([0,0,n+e*0.5],[f,f,n+e]);f=d.length(f);
h=[h[3],h[9],h[10]];n=d.length(h);h=d.multiply(h,1/n);a=[a.position[0],a.position[1],a.position[2]];a=d.add(a,d.multiply(h,e*0.5));a=d.add(a,d.multiply(h,1));this.sphere=[a[0],a[1],a[2],f]}};q.prototype.contains_sphere=function(a){for(var e=m.vec3,f=this._planes,d=0;d<6;++d){var h=f[d],h=e.dot([h[0],h[1],h[2]],[a[0],a[1],a[2]])+h.d;this.last_in[d]=1;if(h<-a[3])return-1;if(Math.abs(h)<a[3])return 0}return 1};q.prototype.draw_on_map=function(a,e){var f=a.width/2,d=a.height/2;e.save();for(var h=this._planes,
n=[0,1,4,5],o=0,c=n.length;o<c;++o){var g=h[n[o]];e.strokeStyle="#FF00FF";if(o<this.last_in.length&&this.last_in[o])e.strokeStyle="#FFFF00";var m=-f,r=f,q=(-g[3]-g[0]*r)/g[2];e.moveTo(f+m,d+(-g[3]-g[0]*m)/g[2]);e.lineTo(f+r,d+q);e.stroke()}e.strokeStyle="#0000FF";e.beginPath();e.arc(f+this.sphere[0],d+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);e.closePath();e.stroke();e.restore()};q.prototype.contains_box=function(a){var e=0,f=[];f[0]=a[0];f[1]=[a[0][0],a[0][1],a[1][2]];f[2]=[a[0][0],a[1][1],a[0][2]];
f[3]=[a[0][0],a[1][1],a[1][2]];f[4]=[a[1][0],a[0][1],a[0][2]];f[5]=[a[1][0],a[0][1],a[1][2]];f[6]=[a[1][0],a[1][1],a[0][2]];f[7]=a[1];for(var a=this._planes,d=0;d<6;++d){for(var h=8,n=1,c=0;c<8;++c)s.classifyPoint(a[d],f[c])===-1&&(n=0,--h);this.last_in[d]=n;if(h===0)return-1;e+=n}if(e===6)return 1;return 0};return{Frustum:q,Octree:x}});
CubicVR.RegisterModule("Particles",function(m){function x(m,q,c,g,a,b,e){if(m){this.last_particle=this.particles=null;this.pTex=c!==z?c:null;this.vWidth=g;this.vHeight=a;this.alpha=b!==z?b:!1;this.alphaCut=e!==z?e:0;this.pfunc=function(a,d){var b=d-a.start_time;if(b<0)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];this.pgov!==null&&this.pgov(a,
d);return 1};this.pgov=null;this.hasColor=q===z?!1:q;c=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=m;this.numParticles=0;this.arPoints=new Float32Array(m*3);this.glPoints=null;if(q)this.arColor=new Float32Array(m*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0]));this.genBuffer()}}var z=m.undef,q=m.GLCore;x.prototype={resizeView:function(m,q){this.vWidth=m;this.vHeight=q;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[m,q,0]))},addParticle:function(m){this.last_particle===null?this.particles=m:this.last_particle.nextParticle=m;this.last_particle=m},genBuffer:function(){var m=q.gl;this.glPoints=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,this.glPoints);m.bufferData(m.ARRAY_BUFFER,this.arPoints,m.DYNAMIC_DRAW);if(this.hasColor)this.glColor=m.createBuffer(),m.bindBuffer(m.ARRAY_BUFFER,this.glColor),m.bufferData(m.ARRAY_BUFFER,this.arColor,m.DYNAMIC_DRAW)},updatePoints:function(){var m=q.gl;m.bindBuffer(m.ARRAY_BUFFER,
this.glPoints);m.bufferData(m.ARRAY_BUFFER,this.arPoints,m.DYNAMIC_DRAW)},updateColors:function(){var m=q.gl;this.hasColor&&(m.bindBuffer(m.ARRAY_BUFFER,this.glColor),m.bufferData(m.ARRAY_BUFFER,this.arColor,m.DYNAMIC_DRAW))},draw:function(m,s,c){var g=q.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",m);this.shader_particle.setMatrix("uPMatrix",s);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(c!==z){this.numParticles=0;if(this.particles===null){g.disable(g.BLEND);return}for(var m=this.particles,s=null,a=0;m!==null;){var b=this.numParticles*
3,e=this.pfunc(m,c);if(e===1){if(this.arPoints[b]=m.pos[0],this.arPoints[b+1]=m.pos[1],this.arPoints[b+2]=m.pos[2],m.color!==null&&this.arColor!==z&&(this.arColor[b]=m.color[0],this.arColor[b+1]=m.color[1],this.arColor[b+2]=m.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(e===-1){if(s!==null)s.nextParticle=m.nextParticle}else e===0&&a++;s=m;m=m.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(g.enable(g.BLEND),g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:x,Particle:function(m,q,c,g,a){this.startpos=new Float32Array(m);this.pos=new Float32Array(m);this.velocity=new Float32Array(g!==z?g:[0,0,0]);this.accel=new Float32Array(a!==z?a:[0,0,
0]);this.start_time=q!==z?q:0;this.life_time=c!==z?c:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("PostProcess",function(m){function x(a){if(a.shader_vertex===r)return null;if(a.shader_fragment===r)return null;this.outputMode=a.outputMode===r?c.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===r?null:a.onresize;this.onupdate=a.onupdate===r?null:a.onupdate;this.init=a.init===r?null:a.init;this.enabled=a.enabled===r?!0:a.enabled;this.outputDivisor=a.outputDivisor===r?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function z(a,e,f){var d=s.gl;this.width=a;this.height=e;this.accum=f===r?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,e,!0);this.bufferA=new CubicVR.RenderBuffer(a,e,!1);this.bufferB=new CubicVR.RenderBuffer(a,
e,!1);this.bufferC=new CubicVR.RenderBuffer(a,e,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,e,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT),this.blur_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.bufferB.use();d.clearColor(0,0,0,1);d.clear(d.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,e)}function q(a,e,f){this.createBuffer(a,e,f)}var r=m.undef,s=m.GLCore,c=CubicVR.enums;c.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];z.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,e){var f=s.gl,d={},h=a/a,n=e/e;d.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);d.vbo_uvs=new Float32Array([0,0,h,0,h,n,0,n,0,0,h,n]);d.gl_points=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,
d.gl_points);f.bufferData(f.ARRAY_BUFFER,d.vbo_points,f.STATIC_DRAW);d.gl_uvs=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,d.gl_uvs);f.bufferData(f.ARRAY_BUFFER,d.vbo_uvs,f.STATIC_DRAW);return d},destroyFSQuad:function(a){var e=s.gl;e.deleteBuffer(a.gl_points);e.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,e){var f=s.gl;a.use();f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.bindBuffer(f.ARRAY_BUFFER,e.gl_points);f.vertexAttribPointer(a.aVertex,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(a.aVertex);
f.bindBuffer(f.ARRAY_BUFFER,e.gl_uvs);f.vertexAttribPointer(a.aTex,2,f.FLOAT,!1,0,0);f.enableVertexAttribArray(a.aTex);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.drawArrays(f.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&g[b.outputDivisor]===r){var e=this.width/b.outputDivisor|0,f=this.height/b.outputDivisor|0;g[b.outputDivisor]=new CubicVR.RenderBuffer(e,f,!1);a[b.outputDivisor]=
this.makeFSQuad(e,f)}},resize:function(b,e){var f=s.gl;this.width=b;this.height=e;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT));for(var d in g){var f=this.width/d|0,h=this.height/d|0;g[d].destroyBuffer();g[d].createBuffer(f,h,!1);this.destroyFSQuad(a[d]);a[d]=this.makeFSQuad(f,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;d=0;for(f=this.shaders.length;d<f;d++)if(this.shaders[d].shader.use(),this.shaders[d].shader.setVector("texel",this.vTexel),this.shaders[d].onresize!==null)this.shaders[d].onresize(this.shaders[d].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var e=s.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT):e.clear(e.COLOR_BUFFER_BIT))},end:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=s.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,f=0,d=this.shaders.length;f<d;f++){var h=this.shaders[f];if(h.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var n=h.outputMode;if(n===c.post.output.REPLACE)h.outputDivisor!==1?g[h.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(n===c.post.output.ADD||
n===c.post.output.BLEND)h.outputDivisor!==1?g[h.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);h.onupdate!==null&&(h.shader.use(),h.onupdate(h.shader));h.outputDivisor!==1?(b.viewport(0,0,g[h.outputDivisor].width,g[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===c.post.output.REPLACE?(this.outputBuffer.use(),g[h.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);n===c.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):n===c.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}e===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};q.prototype={createBuffer:function(a,
e,f){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(e,10);var a=this.sizeParam(a),e=this.sizeParam(e),d=s.gl;this.fbo=d.createFramebuffer();if(f)this.depth=d.createRenderbuffer();d.bindFramebuffer(d.FRAMEBUFFER,this.fbo);f&&(d.bindRenderbuffer(d.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_COMPONENT16,a,e),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_ATTACHMENT,d.RENDERBUFFER,this.depth)):
(d.renderbufferStorage(d.RENDERBUFFER,d.DEPTH_STENCIL,a,e),d.framebufferRenderbuffer(d.FRAMEBUFFER,d.DEPTH_STENCIL_ATTACHMENT,d.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;d.bindTexture(d.TEXTURE_2D,m.Textures[this.texture.tex_id]);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE);d.texImage2D(d.TEXTURE_2D,
0,d.RGBA,a,e,0,d.RGBA,d.UNSIGNED_BYTE,null);d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,m.Textures[this.texture.tex_id],0);d.bindFramebuffer(d.FRAMEBUFFER,null)},destroyBuffer:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(m.Textures[this.texture.tex_id]);m.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:q,PostProcessShader:x,PostProcessChain:z,fsQuad:{make:z.prototype.makeFSQuad,destroy:z.prototype.destroyFSQuad,render:z.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Polygon",function(m){function x(a){var b=[],n=a.length;if(n<3)return null;var e=[],c;c=a.length;for(var g=0,m=c-1,v=0;v<c;m=v++)g+=a[m][0]*a[v][1]-a[v][0]*a[m][1];if(0<g*0.5)for(c=0;c<n;c++)e[c]=c;else for(c=0;c<n;c++)e[c]=n-1-c;v=2*n;g=0;for(c=n-1;n>2;){if(0>=v--)return null;var q=c;n<=q&&(q=0);c=q+1;n<=c&&(c=0);m=c+1;n<=m&&(m=0);var r;a:{r=a;var s=q,u=c,t=m,x=n,C=e,D=void 0,z=void 0,H=void 0,F=void 0,E=void 0,G=void 0,N=void 0,L=void 0,R=void 0,z=r[C[s]][0],H=r[C[s]][1],
F=r[C[u]][0],E=r[C[u]][1],G=r[C[t]][0],N=r[C[t]][1];if(f>(F-z)*(N-H)-(E-H)*(G-z))r=!1;else{for(D=0;D<x;D++)if(!(D==s||D==u||D==t)){var L=r[C[D]][0],R=r[C[D]][1],W=void 0,M=void 0,P=void 0,O=void 0,S=void 0,Y=void 0,Z=void 0,Q=void 0,$=void 0,T=void 0,V=void 0,X=void 0,W=P=S=void 0,W=G-F,M=N-E,P=z-G,O=H-N,S=F-z,Y=E-H,Z=L-z,Q=R-H,$=L-F,T=R-E,V=L-G,X=R-N,W=W*T-M*$,S=S*Q-Y*Z,P=P*X-O*V;if(W>=0&&P>=0&&S>=0){r=!1;break a}}r=!0}}if(r){v=e[q];q=e[c];m=e[m];b.push(v);b.push(q);b.push(m);g++;m=c;for(v=c+1;v<
n;m++,v++)e[m]=e[v];n--;v=2*n}}return b}function z(a,b,f){f===e&&(f=0);var c;c=x(b);var g=CubicVR.util.repackArray(c,3,c.length/3),m=[],w=a.points.length;c=0;for(iMax=b.length;c<iMax;c++)m.push([b[c][0],b[c][1],f]);a.addPoint(m);c=0;for(iMax=g.length;c<iMax;c++)a.addFace([g[c][0]+w,g[c][1]+w,g[c][2]+w])}function q(a,b){var f=b[0]-a[0],e=b[1]-a[1];return Math.sqrt(f*f+e*e)}function r(a,b){var f,e,c=[],g=a.length,m=b.length,v=[];for(f=0;f<g;f++)for(e=0;e<m;e++){var r=q(a[f],b[e]);c.push([r,f,e])}c.sort(function(a,
d){return a[0]>d[0]});for(f=0;f<5;f++)for(e=0;e<c.length;e++)f!=e&&c[f][1]!=c[e][1]&&c[f][2]!=c[e][2]&&c[f][1]<c[e][1]&&c[f][2]<c[e][2]&&Math.abs(c[f][1]-c[e][1])<4&&Math.abs(c[f][2]-c[e][2])<4&&v.push([f,e]);v.sort(function(a,d){return c[a[0]][0]+c[a[1]][0]>c[d[0]][0]+c[d[1]][0]});if(v.length>10)v.length=10;e=[];for(f=0;f<v.length;f++)e.push([c[v[f][0]],c[v[f][1]]]);return e}function s(a,b){var f=r(a,b),e;if(!f.length)return null;e=f[0][0];var c=f[0][1],f=c[1]-e[1],c=c[2]-e[2],g=a.slice(e[1]),g=
g.concat(a.slice(0,e[1])),m=b.slice(e[2]),m=m.concat(b.slice(0,e[2])),v=[];for(e=f;e<g.length;e++)v.push(g[e]);v.push(g[0]);for(e=c;e<m.length;e++)v.push(m[e]);v.push(m[0]);var q=[];for(e=0;e<=f;e++)q.push(g[e]);for(e=0;e<=c;e++)q.push(m[e]);return[v,q]}function c(a){for(var b=[0,0],f=0;f<a.length;f++)b[0]+=a[f][0],b[1]+=a[f][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,f){for(var e=[],c=0;c<a.length;c++){var g=[a[c][0]-b[0],a[c][1]-b[1]],m=Math.sqrt(g[0]*g[0]+g[1]*g[1])+f,g=Math.atan2(g[1],
g[0]);e[c]=[b[0]+Math.cos(g)*m,b[1]+Math.sin(g)*m]}return e}function a(a,b,f,e,c){var g,m=a.points.length;if(b.length!=f.length)return null;var v=b.length;for(g=0;g<v;g++)a.addPoint([b[g][0],b[g][1],e]);for(g=0;g<v;g++)a.addPoint([f[g][0],f[g][1],c]);for(g=0;g<v-1;g++)a.addFace([m+g,m+g+1,m+(g+v+1),m+(g+v)]);g=v-1;a.addFace([m+g,m,m+v,m+(g+v)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var e=m.undef,f=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var f=this.cuts[b].points.slice(0),f=f.reverse(),f=s(this.result[0],f);this.result[0]=f[0];this.result.push(f[1])}for(b=0;b<this.result.length;b++)z(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(d,b,f){if(this.points.length!==0){var c,g;b===e&&(b=0);f===e&&(f=0);var m=b!=f;d||(d=new CubicVR.Mesh);this.result=[this.points];for(g=0;g<this.cuts.length;g++)c=this.cuts[g].points.slice(0),
c=c.reverse(),c=s(this.result[0],c),this.result[0]=c[0],this.result.push(c[1]);c=new CubicVR.Mesh;for(g=0;g<this.result.length;g++)z(c,this.result[g],f);d.booleanAdd(c);c.flipFaces();if(m)for(g=0;g<c.points.length;g++)c.points[g][2]=b;d.booleanAdd(c);if(m){a(d,this.points,this.points,b,f);for(g=0;g<this.cuts.length;g++)c=this.cuts[g].points.slice(0),c=c.reverse(),a(d,c,c,b,f)}d.removeDoubles();return d}},toExtrudedBeveledMesh:function(d,b,f,e,m,q,w){var v=[],r=[],x,I,u,t;if(this.points.length!==0){typeof b===
"object"&&(w=b,b=w.front||0,f=w.back||0,e=w.frontDepth||0,m=w.frontShift||0,q=w.backDepth||0,w=w.backShift||0);var K=b!==f,C=q!==0,D=e!==0;d||(d=new CubicVR.Mesh);D?(I=c(this.points),I=g(this.points,I,-m),this.result=[I.slice(0)]):this.result=[this.points.slice(0)];for(t=0;t<this.cuts.length;t++)u=c(this.cuts[t].points),u=g(this.cuts[t].points,u,m),u=u.reverse(),v.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);m=new CubicVR.Mesh;for(t=0;t<this.result.length;t++)z(m,this.result[t],
b-e);m.flipFaces();d.booleanAdd(m);if(C||D){x=c(this.points);x=g(this.points,x,-w);this.result=[x.slice(0)];for(t=0;t<this.cuts.length;t++)u=c(this.cuts[t].points),u=g(this.cuts[t].points,u,w),u=u.reverse(),r.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);m=new CubicVR.Mesh;for(t=0;t<this.result.length;t++)z(m,this.result[t],f+q)}else{for(t=0;t<m.points.length;t++)m.points[t][2]=f;m.flipFaces()}d.booleanAdd(m);D&&a(d,I,this.points,b-e,b);K&&a(d,this.points,this.points,b,
f);C&&a(d,this.points,x,f,f+q);for(t=0;t<v.length;t++)u=this.cuts[t].points.slice(0).reverse(),D&&a(d,v[t],u,b-e,b),K&&a(d,u,u,b,f),C&&a(d,u,r[t],f,f+q);d.removeDoubles();return d}}};return{polygon:{triangulate2D:x,toMesh:z,findNearPair:function(a,b){for(var f=[0,0],e=q(a[0],b[0]),c=a.length,g=b.length,m=0;m<c;m++)for(var v=0;v<g;v++){var r=q(a[m],b[v]);r<e&&(f[0]=m,f[1]=v,e=r)}return f},subtract:s,addOffset:function(a,b){for(var f=[],e=0,c=a.length;e<c;e++){var g=a[e];f.push([g[0]+b[0],g[1]+b[1]])}return f}},
Polygon:b}});
CubicVR.RegisterModule("Primitives",function(m){function x(a,b,e,h,c,g){var q=m.mat4,r=m.vec3,s=[],u,t=[0,1,0],x=[1,0,0],C=[0,0,0],z=a.points.length,U,H,F;for(U=u=0;U<d;U+=d/e){if(u===e)break;x=[Math.cos(U),0,Math.sin(U)];H=0;for(F=b.length;H<F;H++)C=r.add(r.multiply(x,b[H][0]),r.multiply(t,b[H][1])),s[u]===f&&(s[u]=[]),s[u].push(C);u++}F=null;c!==f&&(F=c.getResult!==f?c.getResult():c);for(H=0;H<e;H++){c=0;for(u=b.length;c<u;c++)F?a.addPoint(q.vec3_multiply(s[H][c],F)):a.addPoint(s[H][c])}typeof h==="string"&&
(h=new m.Material(h));a.setFaceMaterial(h);for(c=0;c<e;c++){H=0;for(F=b.length-1;H<F;H++)q=H+b.length*c,s=H+b.length*((c+1)%e),r.equal(a.points[z+q],a.points[z+s])?a.addFace([z+q+1,z+s+1,z+s]):r.equal(a.points[z+q+1],a.points[z+s+1])?a.addFace([z+q,z+q+1,z+s]):a.addFace([z+q,z+q+1,z+s+1,z+s])}g!==f&&(b=null,g.apply!==f?b=g:g&&(b=new m.UVMapper(g)),b!==null&&(a.calcFaceNormals(),b.apply(a,h)))}function z(a,d,b,e,c){var h=m.mat4;d*=0.5;var g=a.points.length;typeof b==="string"&&(b=new m.Material(b));
a.setFaceMaterial(b);e!==f?(e=e.getResult!==f?e.getResult():e,a.addPoint([h.vec3_multiply([d,-d,0],e),h.vec3_multiply([d,d,0],e),h.vec3_multiply([-d,d,0],e),h.vec3_multiply([-d,-d,0],e)])):a.addPoint([[d,-d,0],[d,d,0],[-d,d,0],[-d,-d,0]]);a.addFace([[g+0,g+1,g+2,g+3],[g+3,g+2,g+1,g+0]]);c!==f&&(h=null,c.apply!==f?h=c:c&&(h=new m.UVMapper(c)),h!==null&&(a.calcFaceNormals(),h.apply(a,b)))}function q(a,d,b,e,h){var c=m.mat4,g,q;typeof d==="object"?(g=d[0]/2,q=d[1]/2,d=d[2]/2):g=q=d/=2;var r=a.points.length;
typeof b==="string"&&(b=new m.Material(b));a.setFaceMaterial(b);e!==f?(e=e.getResult!==f?e.getResult():e,a.addPoint([c.vec3_multiply([g,-q,d],e),c.vec3_multiply([g,q,d],e),c.vec3_multiply([-g,q,d],e),c.vec3_multiply([-g,-q,d],e),c.vec3_multiply([g,-q,-d],e),c.vec3_multiply([g,q,-d],e),c.vec3_multiply([-g,q,-d],e),c.vec3_multiply([-g,-q,-d],e)])):a.addPoint([[g,-q,d],[g,q,d],[-g,q,d],[-g,-q,d],[g,-q,-d],[g,q,-d],[-g,q,-d],[-g,-q,-d]]);a.addFace([[r+0,r+1,r+2,r+3],[r+7,r+6,r+5,r+4],[r+4,r+5,r+1,r+0],
[r+5,r+6,r+2,r+1],[r+6,r+7,r+3,r+2],[r+7,r+4,r+0,r+3]]);h!==f&&(c=null,h.apply!==f?c=h:h&&(c=new m.UVMapper(h)),c!==null&&(a.calcFaceNormals(),c.apply(a,b)))}function r(a,b,f,e,c,h,g,q){var r=[];f-=b;b+=f/2;for(var s=d/c,t=0,x=0;x<=c;x++)r.push([b+Math.cos(t)*f,Math.sin(t)*f,0]),t+=s;m.genLatheObject(a,r,e,h,g,q)}function s(a,d,b,f,e,c,h){m.genLatheObject(a,[[0,-b/2,0],[d/2,-b/2,0],[0,b/2,0]],f,e,c,h)}function c(a,d,b,f,e,c,h){m.genLatheObject(a,[[0,-b/2,0],[d,-b/2,0],[d,b/2,0],[0,b/2,0]],f,e,c,h)}
function g(a,d,b,f,e,c,g){var q=[],f=(f/=2)|0;b|=0;for(var r=Math.PI/f,s=-h,t=0;t<=f;t++)q.push([Math.cos(s)*d,Math.sin(s)*d,0]),s+=r;m.genLatheObject(a,q,b,e,c,g)}function a(a){typeof a==="string"&&(a=m.get(a,m.Material));if(a===f)return new m.Material;return a.use?a:typeof a==="object"?new m.Material(a):new m.Material}function b(a){if(a===f)return f;if(typeof a==="array")return a;if(typeof a==="object")return a.getResult?a.getResult():a.position||a.rotation||a.scale?m.mat4.transform(a.position,
a.rotation,a.scale):f}function e(a){typeof a==="string"&&(a=m.get(a));if(a===f)return f;return a.apply?a:typeof a==="object"?new m.UVMapper(a):f}var f=m.undef,d=2*Math.PI,h=Math.PI/2;return{genPlaneObject:z,genBoxObject:q,genLatheObject:x,genTorusObject:r,genConeObject:s,genCylinderObject:c,genSphereObject:g,primitives:{lathe:function(d){var c,h,g,w;if(d.points==f)return null;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);g=b(d.transform);w=e(d.uvmapper||d.uv);x(c,d.points,d.divisions!==
f?d.divisions:24,h,g,w);return c},box:function(d){var c,h,g,w;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);g=b(d.transform);w=e(d.uvmapper||d.uv);q(c,d.size!==f?d.size:1,h,g,w);return c},plane:function(d){var c,h,g,w;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);g=b(d.transform);w=e(d.uvmapper||d.uv);z(c,d.size!==f?d.size:1,h,g,w);return c},sphere:function(d){var c,h,q,w;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);q=b(d.transform);
w=e(d.uvmapper||d.uv);g(c,d.radius!==f?d.radius:1,d.lon!==f?d.lon:24,d.lat!==f?d.lat:24,h,q,w);return c},torus:function(d){var c,h,g,w;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);g=b(d.transform);w=e(d.uvmapper||d.uv);r(c,d.innerRadius!==f?d.innerRadius:0.75,d.outerRadius!==f?d.outerRadius:1,d.lon!==f?d.lon:24,d.lat!==f?d.lat:24,h,g,w);return c},cone:function(d){var c,h,g,w;c=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);h=a(d.material);g=b(d.transform);w=e(d.uvmapper||
d.uv);s(c,d.base!==f?d.base:1,d.height!==f?d.height:1,d.lon!==f?d.lon:24,h,g,w);return c},cylinder:function(d){var h,g,q,w;h=d.mesh!==f?d.mesh:new m.Mesh(d.name!==f?d.name:f);g=a(d.material);q=b(d.transform);w=e(d.uvmapper||d.uv);c(h,d.radius!==f?d.radius:1,d.height!==f?d.height:1,d.lon!==f?d.lon:24,g,q,w);return h}}}});
CubicVR.RegisterModule("Renderer",function(m){var x=m.undef;return{renderObject:function(z,q,r,s,c,g,a){var b=!1,c=c||!1,g=g||!1;if(z.compiled!==null){var e=0,f=m.GLCore.gl,d,h=s===x?0:s.length,n,o=0,B,y=null,w=z.instanceMaterials||z.materials,v=(a=(z.wireframe||a)&&z.compiled.line_elements_ref)?z.compiled.line_elements_ref:z.compiled.elements_ref,A=!1,J,I,u;f.depthFunc(f.LEQUAL);r===x&&(r=cubicvr_identity);for(var t=0,K=v.length;t<K;t++){var y=a&&z.wireframeMaterial?z.wireframeMaterial:w[t],C=0,
o=!1;if(y.opacity<1&&c)b=!0;else if(!(g&&y.opacity>=1)){y.opacity!==1?(f.enable(f.BLEND),f.depthMask(0),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA)):(f.depthMask(1),f.disable(f.BLEND),f.blendFunc(f.ONE,f.ONE));for(var D=0,U=v[t].length;D<U;D++)if(B=v[t][D][0],o=!1,d=v[t][D][1],C+=d,y.visible){if(!z.segment_state[B])if(C>d){e+=d*2;C-=d;if(h){I=!1;for(J=0;J<h;){d=h-J;if(d>m.MAX_LIGHTS)d=m.MAX_LIGHTS;J>0&&!I&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),I=!0);n=s[J];u=n.light_type;
for(o=0;o<d;o++)if(s[o+J].light_type!=u){d=o;break}y.use(n.light_type,d);n=y.shader[n.light_type][d];f.uniformMatrix4fv(n.matrixModelView,!1,q.mvMatrix);f.uniformMatrix4fv(n.matrixProjection,!1,q.pMatrix);f.uniformMatrix4fv(n.matrixObject,!1,r);f.uniformMatrix3fv(n.matrixNormal,!1,q.nMatrix);A||(y.bindObject(z,n),A=n.vertexTexCoord!=-1,a&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements));for(o=0;o<d;o++)s[o+J].setupShader(n,o);a?f.drawElements(f.LINES,C,f.UNSIGNED_SHORT,e):f.drawElements(f.TRIANGLES,
C,f.UNSIGNED_SHORT,e);J+=d}I&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else y.use(0,0),f.uniformMatrix4fv(y.shader[0][0].matrixModelView,!1,q.mvMatrix),f.uniformMatrix4fv(y.shader[0][0].matrixProjection,!1,q.pMatrix),f.uniformMatrix4fv(y.shader[0][0].matrixObject,!1,r),f.uniformMatrix3fv(y.shader[0][0].matrixNormal,!1,q.nMatrix),A||(y.bindObject(z,y.shader[0][0]),A=y.shader[0][0].vertexTexCoord!=-1,a&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements)),a?f.drawElements(f.LINES,C,f.UNSIGNED_SHORT,
e):f.drawElements(f.TRIANGLES,C,f.UNSIGNED_SHORT,e);e+=C*2;C=0;o=!0}else e+=C*2,C=0}else e+=d*2,C-=d;if(!o&&z.segment_state[B]&&y.visible){if(h){I=!1;for(J=0;J<h;){d=h-J;if(d>m.MAX_LIGHTS)d=m.MAX_LIGHTS;J>0&&!I&&(f.enable(f.BLEND),f.blendFunc(f.ONE,f.ONE),f.depthFunc(f.EQUAL),I=!0);n=s[J];u=n.light_type;for(o=0;o<d;o++)if(s[o+J].light_type!=u){d=o;break}y.use(n.light_type,d);n=y.shader[n.light_type][d];f.uniformMatrix4fv(n.matrixModelView,!1,q.mvMatrix);f.uniformMatrix4fv(n.matrixProjection,!1,q.pMatrix);
f.uniformMatrix4fv(n.matrixObject,!1,r);f.uniformMatrix3fv(n.matrixNormal,!1,q.nMatrix);A||(y.bindObject(z,n),A=n.vertexTexCoord!=-1,a&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements));for(o=0;o<d;o++)s[o+J].setupShader(n,o);a?f.drawElements(f.LINES,C,f.UNSIGNED_SHORT,e):f.drawElements(f.TRIANGLES,C,f.UNSIGNED_SHORT,e);J+=d}I&&(f.disable(f.BLEND),f.depthFunc(f.LEQUAL))}else y.use(0,0),f.uniformMatrix4fv(y.shader[0][0].matrixModelView,!1,q.mvMatrix),f.uniformMatrix4fv(y.shader[0][0].matrixProjection,
!1,q.pMatrix),f.uniformMatrix4fv(y.shader[0][0].matrixObject,!1,r),f.uniformMatrix3fv(y.shader[0][0].matrixNormal,!1,q.nMatrix),A||(y.bindObject(z,y.shader[0][0]),A=y.shader[0][0].vertexTexCoord!=-1,a&&f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements)),a?f.drawElements(f.LINES,C,f.UNSIGNED_SHORT,e):f.drawElements(f.TRIANGLES,C,f.UNSIGNED_SHORT,e);e+=C*2}}}y&&n?y.clearObject(z,n):y.clearObject(z,null);f.depthMask(1);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);return b}}}});
CubicVR.RegisterModule("EventHandler",function(m){function x(g){g=CubicVR.parseEnum(s.event,g);if(g===r)return c("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1;if(!isNaN(parseInt(g,10))&&(g>=s.event.EVENT_MAX||g<0))return c("Unknown event ID passed: "+g),!1;return g}function z(c){c=c||{};this.name=c.name;c.id=x(c.id)||s.event.TICK;this.id=c.id;this.interval=c.interval||0;this.enabled=
c.enabled||!0;this.action=c.action||null;this.properties=c.properties||{};this.event_properties=c.event_properties||{};this.buffered=c.buffered||!1;this.weight=c.weight===r?-1:c.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function q(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}
var r=m.undef,s=CubicVR.enums,c=m.log;s.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};z.prototype={getName:function(){return this.name},setName:function(c){this.name=c},getSubject:function(){return this.subject},setSubject:function(c){this.subject=c},getId:function(){return this.id},setId:function(c){this.id=c},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},
enable:function(){this.setEnabled(!0)},setEnabled:function(c){if(c&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=c},isBuffered:function(){return this.buffered},setBuffered:function(c){this.buffered=c},setInterval:function(c){this.interval=c},getInterval:function(){return this.interval},setAction:function(c){this.action=c},getAction:function(){return this.action},getProperties:function(){return this.properties},
setProperties:function(c){this.properties=c},getProperty:function(c){return this.properties[c]},setProperty:function(c,a){this.properties[c]=a},setEventProperties:function(c){this.event_properties=c},getEventProperties:function(){return this.event_properties},getEventProperty:function(c){return this.event_properties[c]},setEventProperty:function(c,a){this.properties[c]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},
getSeconds:function(){return this.getTimeUpdated()},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(c){this.t_rest=c},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(c){this.setRestInterval(c||0)},awake:function(){this.t_rest=0},update:function(c,a){if(!this.enabled)return!1;var b=0,e=!0;if(this.n_updates===0)this.t_updatecall=
this.t_update=c,b=1/60;else if(c!==this.t_update){if(!this.t_rest)this.t_last=c-this.t_update,this.t_update=c;b=c-this.t_updatecall;this.t_updatecall=c}else e=!1;if(this.t_rest>0){if(e&&(this.t_resting+=b,this.t_rest-=b,this.t_rest<0))this.t_rest=0}else{if(e){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(a);return!0}e&&this.n_updates++;return!1},callEvent:function(c){if(!this.action)return!1;return this.action(this,c)}};q.prototype=
{addEvent:function(c){c.callEvent||(c=new z(c));var a=c.getId();this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(c);this.listenerNames.indexOf(a)===-1&&this.listenerNames.push(a);return c},removeEvent:function(c){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(c)==-1&&this.lockRemovals.push(c)}else{var a=this.events.indexOf(c);a!==-1&&(c=c.getId(),this.events.splice(a,1),this.listeners[c]--,
this.listeners[c]||(this.eventHandled[c]=!0,this.eventParameters[c]={},this.eventProperties[c]=[],this.eventPropertyCount[c]=0,a=this.listenerNames.indexOf(c),a>=0&&this.listenerNames.splice(a,1)))}},getProperties:function(c){this.eventParameters[c]=this.eventParameters[c]||{};return this.eventParameters[c]},setProperties:function(c,a){this.eventParameters[c]=a},getProperty:function(c,a){return this.getProperties(c)[a]},setProperty:function(c,a,b){this.getProperties(c)[a]=b},hasEvent:function(c){return!!this.listeners[c]},
triggerEvent:function(c,a){if(!this.listeners[c])return null;this.eventProperties[c]==r&&(this.eventProperties[c]=[]);var b=this.eventProperties[c];this.eventPropertyCount[c]===r&&(this.eventPropertyCount[c]=0);var e=this.eventPropertyCount[c];e>20&&console.log("Warning, event "+c+" count > 20: "+e);b[e]=a&&b?a:b[e]||{};this.eventPropertyCount[c]++;this.eventHandled[c]=!1;return b[e]},update:function(c){var a,b,e,f,d,h;if(this.hasEvent(s.event.TICK)&&this.eventPropertyCount[s.event.TICK]===0&&(a=
this.triggerEvent(s.event.TICK)))a.time=c,a.handler=this;this.lockState=!0;a=0;for(b=this.events.length;a<b;a++){d=this.events[a];h=d.getId();f=this.eventPropertyCount[h];var n=!1;e=!1;if(f){var o=this.eventProperties[h];if(d.isEnabled()){if(d.isBuffered()){if(o.length=f,d.setEventProperties(o),n=n||d.update(c,this),d.isChainBroken()){d.breakChain(!1);break}}else for(e=0;e<f;e++)if(d.setEventProperties(o[a]),n=n||d.update(c,this),d.isChainBroken()){d.breakChain(!1);break}e=!0}}if(n||!e)this.eventHandled[h]=
!0}a=0;for(b=this.listenerNames.length;a<b;a++)h=this.listenerNames[a],this.eventHandled[h]&&(this.eventPropertyCount[h]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(b=this.lockRemovals.length;a<b;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:z,EventHandler:q,registerEvent:function(g){g=g.toUpperCase();s.event[g]!==r?c("Error, event '"+g+"' is already registered."):(s.event[g]=s.event.ENUM_MAX,s.event.ENUM_MAX++)},validateEvent:x}});
CubicVR.RegisterModule("Scene",function(m){function x(a,b){return a.light_type-b.light_type}function z(d,f){var c=null,e;d!==s&&d!==null?d.compile?c={}:(c=m.get(d)||{},d=null):c={};this.morphWeight=c.morphWeight||0;this.morphSource=c.morphSource||-1;this.morphTarget=c.morphTarget||-1;this.position=c.position===s?[0,0,0]:c.position;this.rotation=c.rotation===s?[0,0,0]:c.rotation;this.scale=c.scale===s?[1,1,1]:c.scale;this.shadowCast=c.shadowCast===s?!0:c.shadowCast;this.wireframe=c.wireframe||!1;this.motion=
c.motion===s?null:m.get(c.motion,m.Motion)||null;this.obj=!c.mesh?d?m.get(d,m.Mesh):null:m.get(c.mesh,m.Mesh);this.name=c.name===s?f!==s?f:null:c.name;this.properties=m.get(c.properties)||{};this.parent=this.children=null;var g=c.children||c.child||c.sceneObject||c.sceneObjects;if(g){if(g&&!g.length||typeof g==="string")g=[g];if(g.length){c=0;for(e=g.length;c<e;c++)this.bindChild(m.get(g[c],m.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function q(a,b,c,e,g,q){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if(typeof a==="object"||typeof a==="string"){a=m.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+f;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((e=a.sceneObjects||a.sceneObject||a.objects)&&!e.length||typeof e==="string")e=[e];if(e&&e.length){b=0;for(c=e.length;b<c;b++)this.bindSceneObject(m.get(e[b],m.SceneObject))}if((e=a.lights||a.light)&&!e.length||typeof e==="string")e=[e];if(e&&e.length){b=0;for(c=e.length;b<c;b++)this.bindLight(m.get(e[b],m.Light))}if((e=a.cameras||
a.camera)&&!e.length||typeof e==="string")e=[e];if(e&&e.length){b=0;for(c=e.length;b<c;b++)this.bindCamera(m.get(e[b],m.Camera));this.camera=this.cameras[0]}if(!e)this.camera=new m.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip)}else this.skybox=null,this.octree=q,this.name="scene"+f,this.camera=new m.Camera(a,b,c,e,g),this.wireframe=!1;this.paused=!1;++f}function r(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var s=m.undef,c=m.enums,
g=m.GLCore,a=m.aabb,b=m.mat4,e=0;z.prototype={clone:function(){var a,b;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var f=new m.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(this.instanceMaterials!==null){f.instanceMaterials=
[];a=0;for(b=this.instanceMaterials.length;a<b;a++)f.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(this.children!==null){a=0;for(b=this.children.length;a<b;a++)f.bindChild(this.children[a].clone())}return f},evaluate:function(a){var b,f;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(this.children!==null){b=0;for(f=this.children.length;b<f;b++)this.children[b].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){if(!this.eventHandler)this.eventHandler=
new m.EventHandler;a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=
b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),f=0,c=b.length;f<c;f++)if(b[f].name==a)return b[f];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=
a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MATRIX_UPDATE)))a.triggerEvent(c.event.MATRIX_UPDATE).matrix=
this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var f=m.vec3;if(!this.matrixLock&&(!f.equal(this.lposition,this.position)||!f.equal(this.lrotation,this.rotation)||!f.equal(this.lscale,this.scale)||a!==s))if(a!==s?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===
1||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MOVE)))a=
a.triggerEvent(c.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var d=this.getAABB(),b=this.octree_aabb,f=d[0][0],c=d[0][1],e=d[0][2],g=d[1][0],m=d[1][1],q=d[1][2],r=b[0][0],x=b[0][1],z=b[0][2],u=b[1][0],t=b[1][1],b=b[1][2];if(this.octree_leaves.length>0&&(f<r||c<x||e<z||g>u||m>t||q>b)){for(f=0;f<this.octree_leaves.length;++f)this.octree_leaves[f].remove(this);
this.octree_leaves=[];this.static_lights=[];f=this.octree_common_root;this.octree_common_root=null;if(f!==null){for(;;)if(!f.contains_point(d[0])||!f.contains_point(d[1]))if(f._root!==s&&f._root!==null)f=f._root;else break;else break;a.reset(this.octree_aabb,this.position);f.insert(this)}}},bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,f){a===c.motion.POS?this.position[b]=f:a===c.motion.SCL?this.scale[b]=f:a===c.motion.ROT&&
(this.rotation[b]=f)},getAABB:function(){var a=m.mat4,b=m.vec3;if(this.dirty){var f=Array(8);this.doTransform();var c,e;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];c=this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||c===s||e===s)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var g=c;c=b.subtract(e,c);f[0]=[g[0],g[1],g[2]];f[1]=[g[0],g[1],g[2]+c[2]];f[2]=[g[0]+c[0],g[1],g[2]];f[3]=[g[0]+c[0],g[1],g[2]+c[2]];
f[4]=[g[0],g[1]+c[1],g[2]];f[5]=[g[0],g[1]+c[1],g[2]+c[2]];f[6]=[g[0]+c[0],g[1]+c[1],g[2]];f[7]=[g[0]+c[0],g[1]+c[1],g[2]+c[2]];g=a.vec3_multiply(f[0],this.tMatrix);c=[g[0],g[1],g[2]];e=[g[0],g[1],g[2]];for(b=1;b<8;++b)g=a.vec3_multiply(f[b],this.tMatrix),c[0]>g[0]&&(c[0]=g[0]),c[1]>g[1]&&(c[1]=g[1]),c[2]>g[2]&&(c[2]=g[2]),e[0]<g[0]&&(e[0]=g[0]),e[1]<g[1]&&(e[1]=g[1]),e[2]<g[2]&&(e[2]=g[2]);this.aabb[0]=c;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var f=0;q.prototype={isWireframe:function(){return this.wireframe},
setWireframe:function(a){this.wireframe=a},attachOctree:function(d){this.octree=d;d.init&&d.init(this);d=this.lights;this.lights=[];for(var b=0,f=d.length;b<f;b++)this.bindLight(d[b]);d=this.sceneObjects;if(this.octree!==s){b=0;for(f=d.length;b<f;++b){var c=d[b];if(c.obj!==null){if(c.id<0)c.id=e,++e;this.sceneObjectsById[c.id]=c;a.reset(c.octree_aabb,c.position);this.octree.insert(c);(c.octree_common_root===void 0||c.octree_common_root===null)&&log("!!",c.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=
a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(d,b,f){if(this.sceneObjects.indexOf(d)==-1){this.sceneObjects.push(d);b!==s&&b&&this.pickables.push(d);d.name!==null&&(this.sceneObjectsByName[d.name]=d);if(this.octree!==s&&(f===s||f==="true")){if(d.id<0)d.id=e,++e;this.sceneObjectsById[d.id]=d;a.reset(d.octree_aabb,d.position);this.octree.insert(d)}if(d.children)for(var c=0,g=d.children.length;c<g;c++)this.bindSceneObject(d.children[c],b,f);return d}},removeLight:function(a){a=
this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(a)==-1&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),b>=0&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),b>=0&&this.pickables.splice(b,1),a.name!==null&&this.sceneObjectsByName[a.name]!==s&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var f=a.children.length;b<f;b++)this.removeSceneObject(a.children[b])}},
bindLight:function(a,b){this.lights.push(a);if(this.octree!==s&&(b===s||b==="true"))a.method===c.light.method.GLOBAL?this.global_lights.push(a):(a.method===c.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(x)},bindCamera:function(a){this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!=="object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),
this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof m.Light?this.bindLight(a):a instanceof m.SceneObject?this.bindSceneObject(a):a instanceof m.Camera?this.bindCamera(a):a instanceof m.Vehicle?a.bindToScene(this):a instanceof m.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof m.Light?this.removeLight(a):a instanceof m.SceneObject?this.removeSceneObject(a):a instanceof m.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},
setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===s)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,f;b=0;for(f=this.sceneObjects.length;b<f;b++)this.sceneObjects[b].motion&&!this.sceneObjects[b].independentMotion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,
this.camera)}b=0;for(f=this.lights.length;b<f;b++){var c=this.lights[b];c.motion!==null&&c.motion.apply(a,c)}},prepareTransforms:function(a){var b,f;if(a){if(a.doTransform(),a.children){b=0;for(f=a.children.length;b<f;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==0){b=0;for(f=this.sceneObjects.length;b<f;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=g.gl;if(this.shadows_updated)return!1;else a||
this.doTransform(),this.shadows_updated=!0;if(m.features.lightShadows){for(var a=b.getParameter(b.FRAMEBUFFER_BINDING),f=!1,e=b.getParameter(b.VIEWPORT),q=0,r=this.lights.length;q<r;q++){var w=this.lights[q];if(w.light_type==c.light.type.SPOT_SHADOW||w.light_type==c.light.type.SPOT_SHADOW_PROJECTOR||w.light_type==c.light.type.AREA){var f=!0,v=[new m.Light(c.light.type.DEPTH_PACK)];if(w.light_type===c.light.type.AREA)w.areaCam=this.camera,w.updateAreaLight();g.shadow_near=w.dummyCam.nearclip;g.shadow_far=
w.dummyCam.farclip;w.shadowBegin();for(var s=0,x=this.sceneObjects.length;s<x;s++){var z=this.sceneObjects[s];z.parent||z.visible===!1||z.shadowCast===!1||this.renderSceneObject(z,w.dummyCam,v,!1,!0)}w.shadowEnd();a&&b.bindFramebuffer(b.FRAMEBUFFER,a)}}f&&b.viewport(e[0],e[1],e[2],e[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],
0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==s,b=0,f=this.sceneObjects.length;b<f;b++){var c=this.sceneObjects[b];if(c.parent===null&&(this.prepareTransforms(c),a&&(lights=[],c.dirty&&c.obj!==null&&c.adjust_octree(),!(c.visible===!1||a&&(c.ignore_octree||c.drawn_this_frame===!0||c.culled===!0))))){lights=c.dynamic_lights;
lights=lights.concat(c.static_lights);lights=lights.concat(this.global_lights);if(this.collect_stats)this.lights_rendered=Math.max(lights.length,this.lights_rendered),this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered;lights=lights.length===0?[g.emptyLight]:lights.sort(x);c.drawn_this_frame=!0}}},renderSceneObject:function(a,b,f,c,e,q,w){var r=!1,A=g.gl,c=c!==s&&c,e=e||!1,q=q||!1;if(a.visible&&a.obj){a.scale[0]<0&&(r=!r);a.scale[1]<0&&(r=!r);a.scale[2]<0&&(r=!r);r&&
A.cullFace(A.FRONT);var x=a.obj;if(x.morphTargets!==null&&(a.morphSource!==-1&&x.setMorphSource(a.morphSource),a.morphTarget!==-1&&x.setMorphTarget(a.morphTarget),a.morphWeight!==null))x.morphWeight=a.morphWeight;a.instanceMaterials&&x.bindInstanceMaterials(a.instanceMaterials);m.renderObject(x,b,a.tMatrix,f,e,q,this.isWireframe()||a.isWireframe())&&w&&w.push(a);a.instanceMaterials&&x.bindInstanceMaterials(null);r&&A.cullFace(A.BACK)}a=a.children;if(c&&a){c=0;for(r=a.length;c<r;c++)this.renderSceneObject(a[c],
b,f,!0,e,q,w)}},runEvents:function(a){var b,f;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(f=this.sceneObjects.length;b<f;b++){var c=this.sceneObjects[b];c.hasEvents()&&c.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(f=this.lockRemovals.length;b<f;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var f=g.gl,c;c=this.octree!==s;this.lights_rendered=
0;if(c)this.octree.reset_node_visibility(),this.octree.cleanup(),c=this.octree.get_frustum_hits(this.camera),this.lights_rendered=c.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e;c=0;for(e=this.lights.length;c<e;c++)this.lights[c].prepare(this.camera);this.objects_rendered=0;var q=[],r=[],w=this.lights;c=0;for(e=this.sceneObjects.length;c<e;c++){var v=this.sceneObjects[c];v.visible===!1||v.parent!==null||this.renderSceneObject(v,this.camera,
w,!0,!0,!1,r)}c=0;for(e=r.length;c<e;c++)this.renderSceneObject(r[c],this.camera,w,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=this.objects_rendered,this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=q,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)f.cullFace(f.FRONT),c=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=
this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[c,c,c],this.skybox.scene_object.doTransform(),m.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),f.cullFace(f.BACK);a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,b,f){var c=m.vec3,e=[],b=b.length===2?this.camera.unProject(b[0],
b[1]):c.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var w=this.pickables[g];if(w.visible===!0){var q,r;r=w.getAABB();q=r[0];r=r[1];r[0]-q[0]<0.2&&(q[0]-=0.1,r[0]+=0.1);r[1]-q[1]<0.2&&(q[1]-=0.1,r[1]+=0.1);r[2]-q[2]<0.2&&(q[2]-=0.1,r[2]+=0.1);var s=c.multiply(c.add(q,r),0.5),x=c.getClosestTo(a,b,s),s=c.length(c.subtract(x,s));(x[0]>=q[0]&&x[0]<=r[0]?1:0)+(x[1]>=q[1]&&x[1]<=r[1]?1:0)+(x[2]>=q[2]&&x[2]<=r[2]?1:0)>=f&&e.push({dist:s,obj:w})}}e.length&&e.sort(function(a,b){if(a.dist==
b.dist)return 0;return a.dist<b.dist?-1:1});return e}};r.prototype={addMesh:function(a,b,f){this.meshBin[a]===s&&(this.meshBin[a]=[],this.meshBinPtr[a]===s&&(this.meshBinPtr[a]=0));this.meshMap[b]===s&&(this.meshMap[b]=f,this.meshBin[a].push(f))},addImage:function(a,b,f){this.imageBin[a]===s&&(this.imageBin[a]=[],this.imageBinPtr[a]===s&&(this.imageBinPtr[a]=0));this.imageMap[b]===s&&(this.imageMap[b]=f,this.imageBin[a].push(f))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},
rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);
if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:q,SceneObject:z,SkyBox:function(a){var b=a.texture,a=a.mapping,f=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/m.Images[f.texture.tex_id].width;if(f.mapping===null)f.mapping=
[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new m.Material({name:"skybox",textures:{color:b},noFog:!0}),d=new m.Mesh;d.sky_mapping=f.mapping;m.primitives.box({mesh:d,size:1,material:a,uvmapper:{projectionMode:m.enums.uv.projection.SKY,scale:[1,1,1]}});d.prepare();f.scene_object=new m.SceneObject(d);f.ready=!0};if(b){if(typeof b==="string")b=new m.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;
if(a)this.mapping=a,this.onready()}},DeferredBin:r}});
CubicVR.RegisterModule("ScenePhysics",function(m){function x(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function z(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function q(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function r(a){return new Ammo.btVector3(a[0],a[1],a[2])}function s(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function c(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=m.undef,b=m.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var e,f,d,h,n,o=function(a,b,d){var f;
if(!a.position&&a.sceneObject)f=a,a=a.sceneObject,b=f.properties,d=f.collision;f=m.get(f)||{};this.properties=new m.RigidProperties(b?m.get(b):{collision:d});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=f.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=f.angularVelocity||[0,0,0];this.init_impulse=this.impulse=f.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
f.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(r(this.init_position));this.transform.setRotation(s(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};o.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),x(this.linearVelocity,h),this.body.setLinearVelocity(h),x(this.angularVelocity,h),this.body.setAngularVelocity(h),m.vec3.equal([0,0,0],this.impulse)||(x(this.impulse,h),x(this.impulsePosition,n),this.body.applyImpulse(h,n)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),f.x=a.x(),f.y=a.y(),f.z=a.z(),f.w=a.w(),f.x!=f.x?console.log("rotation is NaN"):(a=f.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();x(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;f.fromEuler(a[0],a[1],a[2]);a=[f.x,f.y,f.z,f.w];d.setX(a[0]);d.setY(a[1]);d.setZ(a[2]);d.setW(a[3]);this.body.getWorldTransform().setRotation(d);this.activate()}},resetMotion:function(){x(this.init_linearVelocity,
h);this.body.setLinearVelocity(h);x(this.init_angularVelocity,h);this.body.setAngularVelocity(h);m.vec3.equal([0,0,0],this.init_impulse)||(x(this.init_impulse,h),x(this.init_impulsePosition,n),this.body.applyImpulse(h,n))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var d=a.getShapes(),f,c,g,h,n,o,q,y=[],B=null;c=0;for(g=d.length;c<g;c++){f=d[c];B=null;if(f.type===b.collision.shape.BOX)B=new Ammo.btBoxShape(new Ammo.btVector3(f.size[0]/
2,f.size[1]/2,f.size[2]/2));else if(f.type===b.collision.shape.SPHERE)B=new Ammo.btSphereShape(f.radius);else if(f.type===b.collision.shape.CAPSULE)B=new Ammo.btCapsuleShape(f.radius,f.height);else if(f.type===b.collision.shape.CYLINDER)B=new Ammo.btCylinderShape(new Ammo.btVector3(f.size[0]/2,f.size[1]/2,f.size[2]/2));else if(f.type===b.collision.shape.CONE)B=new Ammo.btConeShape(f.radius,f.height);else if(f.type===b.collision.shape.MESH){q=f.mesh;B=new Ammo.btTriangleMesh;o=f.size;var z=new Ammo.btVector3(0,
0,0),F=new Ammo.btVector3(0,0,0),E=new Ammo.btVector3(0,0,0),G=q.getMaterials();h=0;for(n=q.faces.length;h<n;h++){var N=q.faces[h];G[N.material].collision&&N.points.length===3&&(z.setValue(q.points[N.points[0]][0]*o[0],q.points[N.points[0]][1]*o[1],q.points[N.points[0]][2]*o[2]),F.setValue(q.points[N.points[1]][0]*o[0],q.points[N.points[1]][1]*o[1],q.points[N.points[1]][2]*o[2]),E.setValue(q.points[N.points[2]][0]*o[0],q.points[N.points[2]][1]*o[1],q.points[N.points[2]][2]*o[2]),B.addTriangle(z,F,
E))}this.getMass()===0||this.getType()==b.physics.body.STATIC||this.getType()==b.physics.body.GHOST?(this.setMass(0),B=new Ammo.btBvhTriangleMeshShape(B,!0)):B=new Ammo.btConvexTriangleMeshShape(B,!0)}else if(f.type===b.collision.shape.CONVEX_HULL){q=f.mesh;o=f.size;z=new Ammo.btVector3(0,0,0);B=new Ammo.btConvexHullShape;h=0;for(n=q.points.length;h<n;h++)x([q.points[h][0]*o[0],q.points[h][1]*o[1],q.points[h][2]*o[2]],z),B.addPoint(z)}else if(f.type===b.collision.shape.HEIGHTFIELD){F=z=q=o=0;if(f.landscape&&
f.landscape instanceof m.Landscape)o=f.landscape.divisions_w,z=f.landscape.divisions_h,q=f.landscape.size_w,F=f.landscape.size_h,B=f.landscape.getMesh().points;else continue;E=Ammo.allocate(B.length*4,"float",Ammo.ALLOC_NORMAL);h=0;for(n=o*z;h<n;h++)Ammo.setValue(E+(h<<2),B[h][1],"float");B=new Ammo.btHeightfieldTerrainShape(o,z,E,1,-100,100,1,0,!1);B.setUseDiamondSubdivision(!0);h=new Ammo.btVector3(q/o,1,F/z);B.setLocalScaling(h)}B&&(f.margin!==0&&B.setMargin(f.margin),y.push({cShape:f,btShape:B}))}d=
null;if(y.length===1)d=y[0].btShape;else if(y.length>1){e=new Ammo.btTransform;d=new Ammo.btCompoundShape(!1);c=0;for(g=y.length;c<g;c++)e.setIdentity(),e.setOrigin(r(y[c].cShape.position)),e.setRotation(s(y[c].cShape.rotation)),d.addChildShape(e,y[c].btShape)}a.setResult(d);a=d}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(x(a,h),this.body.setAngularVelocity(h))},setGravity:function(a){this.gravity=a;this.body&&(x(a,h),this.body.setGravity(h))},
getGravity:function(){if(this.gravity&&!this.body)return this.gravity;return c(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(x(a,h),this.body.setLinearVelocity(h))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!m.vec3.equal([0,0,0],a)&&(x(this.impulse,h),x(this.impulsePosition,n),this.body.applyImpulse(h,n))},applyForce:function(a,b){this.body&&!m.vec3.equal([0,0,0],a)&&(x(a,h),x(b,n),this.body.applyImpulse(h,
n))},getAngularVelocity:function(){return c(this.body.getAngularVelocity())},getLinearVelocity:function(){return c(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),x(b,h),this.body.setAngularFactor(h))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==
b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a=m.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)x(a,h),this.body&&this.body.getCenterOfMassTransform().setOrigin(h),this.ghost&&this.ghost.getWorldTransform().setOrigin(h)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;
this.body&&this.body.getCenterOfMassTransform().getRotation(d);this.ghost&&this.ghost.getWorldTransform().getRotation(d);var a=new m.Quaternion;q(d,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)z(a,d),this.body&&this.body.getCenterOfMassTransform().setRotation(d),this.ghost&&this.ghost.getWorldTransform().setRotation(d)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new m.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(d);
this.ghost&&this.ghost.getWorldTransform().getRotation(d);q(d,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;d.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(d);this.ghost&&this.body.getWorldTransform().setRotation(d)}};var B=function(d){d=d||{};this.ctype=m.parseEnum(b.physics.constraint,d.ctype)||b.physics.constraint.P2P;this.strength=d.strength||0.1;this.maxImpulse=
d.maxImpulse||0;this.rigidBodyA=d.rigidBodyA||d.rigidBody||null;this.rigidBodyB=d.rigidBodyB||null;this.positionA=d.positionA||[0,0,0];this.positionB=d.positionB||d.position||[0,0,0];this.damping=d.damping!=a?d.damping:1;this.btConstraint=null;this.localPivotA=r(this.positionA);this.localPivotB=r(this.positionB)};B.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},
setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(x(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=
this.manifold.getContactPoint(j);if(a===Ammo.NULL)return null;return{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:c(a.getPositionWorldOnA()),positionB:c(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var y=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;
this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!f)h=
new Ammo.btVector3,n=new Ammo.btVector3,e=new Ammo.btTransform,f=new m.Quaternion,d=new Ammo.btQuaternion};y.prototype={addConstraint:function(a){var b=a.getConstraint();if(b)return this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0;return!1},removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){x(a,h);this.dynamicsWorld.setGravity(h)},bindSceneObject:function(a,b){var d=new m.RigidBody(a,b);this.rigidObjects.push(d);
d.getBody();d.activate();this.dynamicsWorld.addRigidBody(d.getBody());d.updateSceneObject(!0);return d},bind:function(a){a instanceof m.Vehicle?a.initBody(this):a instanceof m.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof m.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)!==-1)return;this.ghostObjects.push(a);var d=a.getBody();a.properties.blocker||d.setCollisionFlags(d.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);
this.dynamicsWorld.addCollisionObject(d)}else{if(this.rigidObjects.indexOf(a)!==-1)return;this.rigidObjects.push(a);d=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(d);a.updateSceneObject(!0)}var f,c;if((f=a.getSceneObject())&&(c=f.getEventHandler()))c.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),c.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)===-1)return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),
1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(this.rigidObjects.indexOf(a)===-1)return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var d,f;if((d=a.getSceneObject())&&(f=d.getEventHandler()))f.hasEvent(b.event.CONTACT)&&this.contactObjects.indexOf(a)!==-1&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),f.hasEvent(b.event.COLLIDE)&&this.collisionObjects.indexOf(a)!==-1&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),
1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var d=0,f=0,c=this.rigidObjects.length;f<c;f++)this.rigidObjects[f].updateSceneObject()&&d++;this.active_count=d},triggerEvents:function(){var a,d,f,c,e=this.dynamicsWorld;if(this.contactObjects.length){var h=e.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var n=e.getDispatcher().getManifoldByIndexInternal(a),m=Ammo.wrapPointer(n.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||
null,o=Ammo.wrapPointer(n.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(m&&(c=m.getSceneObject())&&(d=c.getEventHandler())&&d.hasEvent(b.event.CONTACT))f=d.triggerEvent(b.event.CONTACT),f.self=m,f.other=o,f.contacts?f.contacts.setManifold(n):f.contacts=new g(n);else if(o&&o.isStatic()&&(c=o.getSceneObject())&&(d=c.getEventHandler())&&d.hasEvent(b.event.CONTACT))f=d.triggerEvent(b.event.CONTACT),f.other=m,f.self=o,f.contacts?f.contacts.setManifold(n):f.contacts=new g(n)}}e=this.collisionObjects.length;
for(a=0;a<e;a++)if(m=this.collisionObjects[a],(c=m.getSceneObject())&&(d=c.getEventHandler())&&d.hasEvent(b.event.COLLIDE))if(f=d.getProperties(b.event.COLLIDE),n=f.collidesWith,f.mf=f.mf||[],f.alg=f.alg||[],n&&n.length){h=[];m=m.getBody();a=0;for(iMax=n.length;a<iMax;a++){var o=n[a],q=o.getBody();f.mf[a]||(f.mf[a]=new Ammo.btManifoldResult(m,q));f.alg[a]||(f.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(m,q));f.alg[a].processCollision(m,q,this.dynamicsWorld.getDispatchInfo(),f.mf[a]);f.mf[a].getPersistentManifold().getNumContacts()>
0&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(f.mf[a].getPersistentManifold()))}if(h.length&&(f=d.triggerEvent(b.event.COLLIDE)))f.collisions=h}e=this.ghostObjects.length;for(a=0;a<e;a++)if(f=this.ghostObjects[a],c=f.getSceneObject())if((d=c.getEventHandler())&&d.hasEvent(b.event.CONTACT_GHOST))if(c=f.getBody(),h=c.getNumOverlappingObjects()){f=d.triggerEvent(b.event.CONTACT_GHOST);f.contacts=f.contacts||[];if(f.contacts.length>h)f.contacts.length=h;for(d=0;d<h;d++)n=Ammo.btRigidBody.prototype.upcast(c.getOverlappingObject(d)),
f.contacts[d]=n._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,d,f){var e,a=r(a);e=r(b);d=d||!1;f=f||!1;b=new Ammo.ClosestRayResultCallback(a,e);this.dynamicsWorld.rayTest(a,e,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!f)))return d=body,f=b.get_m_hitPointWorld(),a=d.getCenterOfMassTransform().inverse().op_mul(f),
(e=d._cvr_rigidbody)?(Ammo.destroy(b),{position:c(f),localPosition:c(a),rigidBody:e,ammoBody:d}):(Ammo.destroy(b),{position:c(f),localPosition:c(a),rigidBody:null,ammoBody:d});Ammo.destroy(b)}};return{ScenePhysics:y,Constraint:B,RigidProperties:function(d){this.type=m.parseEnum(b.physics.body,d.type);this.mass=d.mass!==a?d.mass:this.type?1:0;this.size=d.size||[1,1,1];this.restitution=d.restitution||(this.type?0:1);this.friction=d.friction||1;if((this.collision=d.collision)&&!this.collision.getShapes)this.collision=
new m.CollisionMap(this.collision);this.blocker=d.blocker||!1},RigidBody:o,vec3bt_copy:x,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:z,btquat_copy:q}});
CubicVR.RegisterModule("Shader",function(m){function x(f,d){var e=m.util,g,o,q,s,w=r.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";f.indexOf("\n")!==-1?(q=f,g=a(r.gl,f,"x-shader/x-vertex")):(g=b(r.gl,f),g===null&&(q=e.getURL(f),g=a(r.gl,q,"x-shader/x-vertex")));if(!w.getShaderParameter(g,w.COMPILE_STATUS))this.vertexLog=w.getShaderInfoLog(g),this.success=!1;d.indexOf("\n")!==-1?(s=d,o=a(r.gl,d,"x-shader/x-fragment")):(o=b(r.gl,
d),o===null&&(s=e.getURL(d),o=a(r.gl,s,"x-shader/x-fragment")));if(!w.getShaderParameter(o,w.COMPILE_STATUS))this.fragmentLog=w.getShaderInfoLog(o),this.success=!1;if(this.success){if(this.shader=w.createProgram(),w.attachShader(this.shader,g),w.attachShader(this.shader,o),w.linkProgram(this.shader),!r.gl.getProgramParameter(this.shader,w.LINK_STATUS))c("Error linking shader:\n"+w.getProgramInfoLog(this.shader)),this.success=!1}else g=e.multiSplit(this.vertexLog,";\n"),e=e.multiSplit(this.fragmentLog,
";\n"),g.length&&this.dumpErrors(g,q),e.length&&this.dumpErrors(e,s)}function z(a){this._update=a.update||null;this._init=a.init||null;this._vertex=m.get(a.vertex)||null;this._fragment=m.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=a.trim()!==""?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var q=m.undef,r=m.GLCore,s=m.enums,c=m.log,g=m.util;s.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,b,c){if(c==="x-shader/x-fragment")c=a.createShader(a.FRAGMENT_SHADER);else if(c==="x-shader/x-vertex")c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,b);a.compileShader(c);return c},b=function(a,b){var c=document.getElementById(b);if(!c)return null;for(var e="",g=c.firstChild;g;)g.nodeType===3&&(e+=g.textContent),
g=g.nextSibling;if(c.type==="x-shader/x-fragment")c=a.createShader(a.FRAGMENT_SHADER);else if(c.type==="x-shader/x-vertex")c=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(c,e);a.compileShader(c);return c};x.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,b,c){c=c||"Error on line";c+=" ";for(var b=b.split("\n"),e=0,g=a.length;e<g;e++){var m=a[e];if(m.indexOf("ERROR: ")===0){var m=m.substr(7).trim(),q=m.substr(0,m.indexOf(" ")),m=m.substr(q.length),q=q.split(":"),
q=parseInt(q[1],10);console.log(q+"> "+b[q-1]);console.log(c+q+", :"+m)}}},bindSelf:function(a){var b,c,e;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[e]===q&&(this[e]=[]),this[e][c]===q&&(this[e][c]={}),this[e][c][b]=this.uniforms[a]):(b=a.split("."),e=b[0],b=b[1],this[e]===q&&(this[e]={}),this[e][b]=this.uniforms[a]):a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],this[e]===q&&(this[e]=[]),this[e][c]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
b!==q&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){r.gl.useProgram(this.shader)},setMatrix:function(a,b){var c=this.uniforms[a];if(c!==null){var e=b.length;e===16?r.gl.uniformMatrix4fv(c,!1,b):e===9?r.gl.uniformMatrix3fv(c,!1,b):e===
4&&r.gl.uniformMatrix2fv(c,!1,b)}},setInt:function(a,b){var c=this.uniforms[a];c!==null&&r.gl.uniform1i(c,b)},setFloat:function(a,b){var c=this.uniforms[a];c!==null&&r.gl.uniform1f(c,b)},setVector:function(a,b){var c=this.uniforms[a];if(c!==null){var e=b.length;e==3?r.gl.uniform3fv(c,b):e==2?r.gl.uniform2fv(c,b):r.gl.uniform4fv(c,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&r.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var c=r.gl,e=this.uniforms[a];if(e!==null){var g=this.uniform_type[a];
g===s.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(e)):g===s.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,2,c.FLOAT,!1,0,0)):g===s.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,b),c.vertexAttribPointer(e,1,c.FLOAT,!1,0,0))}}};var e={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g," ").replace(/ *\[ */g,
"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var c=a[i];c.indexOf("#define")===0&&(c=c.split(" "),c.length>2&&(b[c[1]]=c.slice(2).join(" ")))}return b},replaceAll:function(a,b,c,e){var c=c||"",e=e||"",g;for(g in b)if(b.hasOwnProperty(g))for(var m=c+g+e;a.indexOf(m)!==-1;)a=a.replace(m,c+b[g]+e);return a},getShaderInfo:function(a,b){var c,m,o,r,s,w,v=["uniform","attribute",
"varying"],x=[],z={};w={};var I;b===q&&(b="");a=e.tidyScript(a);b=e.tidyScript(b);z.v_define=e.getDefines(a);z.f_define=e.getDefines(b);a=e.replaceAll(a,z.v_define,"[","]");b=e.replaceAll(b,z.f_define,"[","]");I=g.multiSplit(a+"\n"+b,"\n;");var u=[];r=o=-1;c=0;for(m=I.length;c<m;c++)s=I[c],o===-1&&s.indexOf("struct")===0?o=c:r===-1&&o!==-1&&s.indexOf("}")!==-1&&(r=c+1),o!==-1&&r!==-1&&(s=I.slice(o,r).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,"").replace(/\n\n/gm,"\n"),
u.push({start:o,end:r,struct:s.split("\n")}),r=o=-1);c=0;for(m=u.length;c<m;c++){var t=u[c].struct,K=null;o=0;for(r=t.length;o<r;o++)s=t[o].split(" "),s.length<=1||(s[0]=="struct"?(K=s[1],w[K]={}):K&&(w[K][s[1]]=s[0]))}z.struct=w;c=0;for(m=v.length;c<m;c++)z[v[c]]=[];c=0;for(m=I.length;c<m;c++){s=I[c];o=0;for(r=v.length;o<r;o++)if(u=v[o],s.indexOf(u)===0&&(w=s.split(" "),w.length===3&&w[0]==u&&x.indexOf(w[2])===-1))if(x.push(w[2]),w[2].indexOf("[")!==-1){var t=w[2].split("["),K=t[1].replace("]",""),
C=parseInt(K,10);C!==C||(K=C);z[u].push({name:t[0],type:w[1],isArray:!0,len:K})}else z[u].push({name:w[2],type:w[1]})}return z},genShaderVarList:function(a,b){var c=a[b],e=[],g,m,q,r,s,x;if(!c)return[];g=0;for(m=c.length;g<m;g++){var z=c[g];if(a.struct[z.type]){var I=a.struct[z.type];if(I&&z.isArray){q=0;for(r=z.len;q<r;q++)for(x in s=z.name+"["+q+"]",I)I.hasOwnProperty(x)&&e.push({location:s+"."+x,type:I[x],basename:z.name})}else for(x in I)e.push({location:z.name+"."+x,type:I[x],basename:z.name})}else if(z.isArray){q=
0;for(r=z.len;q<r;q++)s=z.name+"["+q+"]",e.push({location:s,type:z.type,basename:z.name})}else e.push({location:z.name,type:z.type,basename:z.name})}return e},getShaderVars:function(a){var b={};b.uniform=e.genShaderVarList(a,"uniform");b.attribute=e.genShaderVarList(a,"attribute");return b}};z.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},hasDepthPack:function(){return this._hasDepthPack},
_init_shader:function(a,b,c,g,o){c=c||[];a=m.util.get(a);b=m.util.get(b);o=o||"#define customShader_splice";if(g=g===q?this._vertex||this._fragment:g)g=a.indexOf(o),o=b.indexOf(o),g!==-1&&this._vertex&&(a=a.substr(0,g)+this._vertex),o!==-1&&this._fragment&&(b=b.substr(0,o)+this._fragment);this._shader=new m.Shader(a,b);this._shaderInfo=e.getShaderInfo(a,b);this._shaderVars=e.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,"uniform",c);this._appendShaderVars(this._shaderVars,
"attribute",c);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,c){for(var a=0,e=this._shaderVars[b].length;a<e;a++){var g=this._shaderVars[b][a],m=g.location;if(c.indexOf(g.basename)===-1)g=g.type,g==="vec3"?b==="attribute"?this._shader.addVertexArray(m):this._shader.addVector(m):g==="vec2"?b==="attribute"?this._shader.addUVArray(m):this._shader.addVector(m):g==="float"?b==="attribute"?this._shader.addFloatArray(m):this._shader.addFloat(m):
g==="sampler2D"||g==="int"?this._shader.addInt(m):(g==="mat4"||g==="mat3"||g==="mat2")&&this._shader.addMatrix(m),this._bindSelf(m)}},_bindSelf:function(a){var b,c,e,g;if(this._shader.uniforms[a]!==null&&(a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],b=b[1].split("."),b=b[1],this[e]===q&&(this[e]=[]),this[e][c]===q&&(this[e][c]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[e][c][b]=g):(b=a.split("."),e=b[0],b=
b[1],this[e]===q&&(this[e]={}),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[e][b]=g):a.indexOf("[")!==-1?(b=a.split("["),e=b[0],b=b[1].split("]"),c=b[0],this[e]===q&&(this[e]=[]),g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[e][c]=g):(g={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=g),this._bindings.push(g),g))g.set=function(a){return function(b){g.value=b;a.update(g)}}(this,
g)},_doUpdate:function(){if(this._initialized)if(this._update)this._update(this);else for(var a=0,b=this._bindings.length;a<b;a++)this.update(this._bindings[a])},update:function(a){if(this._initialized){var b=r.gl,c=a.value,e=a.location;if(e!==null)a.type===s.shader.uniform.MATRIX?(a=c.length,a===16?b.uniformMatrix4fv(e,!1,c):a===9?b.uniformMatrix3fv(e,!1,c):a===4&&b.uniformMatrix2fv(e,!1,c)):a.type===s.shader.uniform.INT?b.uniform1i(e,c):a.type===s.shader.uniform.VECTOR?(a=c.length,a===3?b.uniform3fv(e,
c):a===2?b.uniform2fv(e,c):b.uniform4fv(e,c)):a.type===s.shader.uniform.FLOAT?b.uniform1f(e,c):a.type===s.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):a.type===s.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e)):a.type===s.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,c),b.vertexAttribPointer(e,1,b.FLOAT,!1,0,0),b.enableVertexAttribArray(e))}}};
return{Shader:x,shader_util:e,CustomShader:z}});
CubicVR.RegisterModule("UVMapper",function(m){function x(a){a=m.get(a)||{};this.rotation=a.rotation===z?[0,0,0]:a.rotation;this.scale=a.scale===z?[1,1,1]:a.scale;this.center=a.center===z?[0,0,0]:a.center;this.projection_mode=a.projectionMode===z?q.uv.projection.PLANAR:m.parseEnum(q.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===z?q.uv.axis.X:m.parseEnum(q.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===z?1:a.wrapW;this.wrap_h_count=a.wrapH===z?1:a.wrapH}var z=m.undef,
q=m.enums,r=2*Math.PI,s=Math.PI/2;q.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var c=function(a,b,c){return a===0&&c===0?0:c===0?a<0?s:-s:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c)},g=function(a,b,c){var f;a===0&&c===0?(f=0,a=b!==0?b<0?-s:s:0):(f=c===0?a<0?s:-s:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c),a=Math.sqrt(a*a+c*c),a=a===0?b<0?-s:s:Math.atan(b/a));return[f,a]};x.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e,f,d){var h=m.mat4,n,o,x,y,w,v=new m.Transform,A=!1,J=null;if(this.center[0]||this.center[1]||this.center[2])v.translate(-this.center[0],-this.center[1],-this.center[2]),A=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
v.rotate(this.rotation[2],0,0,1),this.rotation[1]&&v.rotate(this.rotation[1],0,1,0),this.rotation[2]&&v.rotate(this.rotation[0],1,0,0),A=!0;A&&(J=v.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var v=0,I=a.faces.length;f&&(v=f);for(d&&(I=d+1);v<I;v++)if(a.faces[v].material===b&&!(e!==z&&a.faces[v].segment!==e)){var u,t,K;if(this.projection_mode===q.uv.projection.CUBIC||this.projection_mode===q.uv.projection.SKY)u=Math.abs(a.faces[v].normal[0]),t=Math.abs(a.faces[v].normal[1]),K=Math.abs(a.faces[v].normal[2]);
for(var f=[],d=0,C=a.faces[v].points.length;d<C;d++){o=a.faces[v].points[d];var D=a.faces[v].points[(d+1)%3],U=a.faces[v].points[(d+2)%3];n=a.points[o];var H=a.points[D],F=a.points[U],E;A&&(n=h.vec3_multiply(n,J));E=this.projection_mode;if(E===q.uv.projection.SKY)o=a.sky_mapping,u>=t&&u>=K&&(x=n[2]/this.scale[2]+this.scale[2]/2,y=-n[1]/this.scale[1]+this.scale[1]/2,a.faces[v].normal[0]<0?(x=(o[2][2]-o[2][0])*(1-x),y=1-(o[2][3]-o[2][1])*y,x+=o[2][0],y+=o[2][1]):(x*=o[3][2]-o[3][0],y=1-(o[3][3]-o[3][1])*
y,x+=o[3][0],y+=o[3][1])),t>=u&&t>=K&&(x=n[0]/this.scale[0]+this.scale[0]/2,y=-n[2]/this.scale[2]+this.scale[2]/2,a.faces[v].normal[1]<0?(x*=o[1][2]-o[1][0],y=1-(o[1][3]-o[1][1])*y,x+=o[1][0],y-=o[1][1]):(x*=o[0][2]-o[0][0],y=1-(o[0][3]-o[0][1])*y,x+=o[0][0],y-=o[0][1])),K>=u&&K>=t&&(x=n[0]/this.scale[0]+this.scale[0]/2,y=n[1]/this.scale[1]+this.scale[1]/2,a.faces[v].normal[2]<0?(x*=o[4][2]-o[4][0],y=1-(o[4][3]-o[4][1])*(1-y),x+=o[4][0],y-=o[4][1]):(x=(o[5][2]-o[5][0])*(1-x),y=1-(o[5][3]-o[5][1])*
(1-y),x+=o[5][0],y+=o[5][1])),a.faces[v].setUV([x,y],d);else if(E===q.uv.projection.CUBIC)u>=t&&u>=K&&(x=n[2]/this.scale[2]+0.5,y=n[1]/this.scale[1]+0.5),t>=u&&t>=K&&(x=-n[0]/this.scale[0]+0.5,y=n[2]/this.scale[2]+0.5),K>=u&&K>=t&&(x=-n[0]/this.scale[0]+0.5,y=n[1]/this.scale[1]+0.5),a.faces[v].normal[0]>0&&(x=-x),a.faces[v].normal[1]<0&&(x=-x),a.faces[v].normal[2]>0&&(x=-x),a.faces[v].setUV([x,y],d);else if(E===q.uv.projection.PLANAR)x=this.projection_axis===q.uv.axis.X?n[2]/this.scale[2]+0.5:-n[0]/
this.scale[0]+0.5,y=this.projection_axis===q.uv.axis.Y?n[2]/this.scale[2]+0.5:n[1]/this.scale[1]+0.5,a.faces[v].setUV([x,y],d);else{if(E===q.uv.projection.CYLINDRICAL)E=this.projection_axis,E===q.uv.axis.X?(w=c(n[2],n[0],-n[1]),y=-n[0]/this.scale[0]+0.5):E===q.uv.axis.Y?(w=c(-n[0],n[1],n[2]),y=-n[1]/this.scale[1]+0.5):E===q.uv.axis.Z&&(w=c(-n[0],n[2],-n[1]),y=-n[2]/this.scale[2]+0.5),w=1-w/r,this.wrap_w_count!==1&&(w*=this.wrap_w_count),n=w,o=y;else if(E===q.uv.projection.SPHERICAL){var G,N,L;E=this.projection_axis;
E===q.uv.axis.X?(G=f[o]?f[o]:g(n[2],n[0],-n[1]),f[o]||(f[o]=G),N=f[D]?f[D]:g(H[2],H[0],-H[1]),f[D]||(f[D]=N),L=f[U]?f[U]:g(F[2],F[0],-F[1]),f[U]||(f[U]=L)):E===q.uv.axis.Y?(G=f[o]?f[o]:g(n[0],-n[1],n[2]),f[o]||(f[o]=G),N=f[D]?f[D]:g(H[0],-H[1],H[2]),f[D]||(f[D]=N),L=f[U]?f[U]:g(F[0],-F[1],F[2]),f[U]||(f[U]=L)):E===q.uv.axis.Z&&(G=f[o]?f[o]:g(-n[0],n[2],-n[1]),f[o]||(f[o]=G),N=f[D]?f[D]:g(-H[0],H[2],-H[1]),f[D]||(f[D]=N),L=f[U]?f[U]:g(-F[0],F[2],-F[1]),f[U]||(f[U]=L));Math.abs(G[0]-N[0])>s&&Math.abs(G[0]-
L[0])>s&&(G[0]>N[0]&&G[0]>L[0]?G[0]-=r:G[0]+=r);Math.abs(G[1]-N[1])>s&&Math.abs(G[1]-L[1])>s&&(G[1]>N[1]&&G[1]>L[1]?G[1]-=r:G[1]+=r);w=1-G[0]/r;o=0.5-G[1]/Math.PI;this.wrap_w_count!==1&&(w*=this.wrap_w_count);this.wrap_h_count!==1&&(o*=this.wrap_h_count);n=w}else o=n=0;a.faces[v].setUV([n,o],d)}}}return this}};return{UVMapper:x}});
CubicVR.RegisterModule("Worker",function(m){function x(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function z(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new x({message:b})}function q(a){function b(a){a=o.getURL(a);c.send("done",a.length)}var c;c=new x({message:function(a){b(a)}});a&&b(a)}function r(a){function b(a){a=
o.getURL(a);c.send("loaded",a)}var c,d;c=new x({message:function(a){if(a.message==="parse")d=new n,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function s(b){function c(b){var f=new a,e;for(e in b)b.hasOwnProperty(e)&&(f[e]=b[e]);b=f.triangulateQuads().compileVBO(f.compileMap());
d.send("done",b)}var d;d=new x({message:function(a){c(a)}});b&&c(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(c){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=m.undef,a=CubicVR.Mesh,b=CubicVR.Texture,e=CubicVR.Material,f=CubicVR.SceneObject,d=CubicVR.Motion,h=CubicVR.Envelope,n=CubicVR.DeferredBin,o=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=
b.parsed||function(){},f={},e;b.url.match(/\.dae/)&&(e=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=o.xml2badgerfish(b);console.log(b);e.send("parse",c)}else if(b.message==="getMesh"){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));f.getMesh&&f.getMesh(c)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){e.send("getMesh",a);f.getMesh=b}}function d(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(c){var h=c.scene,m=c.object,n=c.assetBase||"",o=g.createSceneFileManager({url:c.mesh,parsed:function(){m&&
o.getSceneObject(m,function(c){for(var c=d(c,new a),g=0,m=c.materials.length;g<m;++g){for(var o=d(c.materials[g],new e),q=0,r=o.textures.length;q<r;++q){var s=o.textures[g];o.textures[g]=new b(n+s.img_path,s.filter_type)}c.materials[g]=o}c=new f(c);h.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,m,n,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],u=[];q.onmessage=function(m){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,c=[],f=0,e=b.length;f<e;++f){var g=b[f];if(g){for(var m=[],n=0,o=g.length;n<o;++n){var s=g[n];if(s){var t=s.keys[0];if(s.keys.length>1)t.prev=null,t.next=s.keys[1],t=s.keys[1];for(var u=1,v=s.keys.length-1;u<v;++u)t.prev=s.keys[u-1],t.next=s.keys[u+1],t=s.keys[u+1];if(s.keys.length>1)t=s.keys[s.keys.length-1],t.prev=s.keys[s.keys.length-2],t.next=null;s.firstKey=
s.keys[0];s.lastKey=s.keys[s.keys.length-1];s.keys=s.firstKey;t=new h;q(s,t);m[n]=t}else g[n]=null}c[f]=m}else b[f]=null}a.motion.controllers=c;b=new d;q(a.motion,b);a.motion=b}}function x(b){var d=new f;q(b,d);if(b.obj!==null){var e=u[b.obj.id];if(e===g)if(e=new a,q(b.obj,e),d.obj=e,u[b.obj.id]=e,o){if(e.points.length>0){o.addMesh(c,c+":"+e.id,e);for(var h=0,m=e.faces.length;h<m;++h){var n=e.faces[h],r=n.material;n.material=s[r]!==g?s[r]:0}}}else d.obj.triangulateQuads(),d.obj.calcNormals(),d.obj.compile(),
d.obj.clean();else d.obj=e}d.trans=new Transform;if(b.children&&b.children.length>0&&(d.children=[],b.children)){e=0;for(h=b.children.length;e<h;++e)m=x(b.children[e]),d.bindChild(m)}return d}var y;y=m.data.message;if(y=="materials"){var z=JSON.parse(m.data.data),m=0;for(y=z.length;m<y;++m){var A=new e(z[m].name),E=A.material_id;q(z[m],A);A.material_id=E;s[z[m].material_id]=E;for(var E=0,G=z[m].textures.length;E<G;++E){var J=z[m].textures[E];if(J){var L=Texture_ref[J.img_path];L===g?(J=new b(J.img_path,
J.filter_type,o,c),A.textures[E]=J):A.textures[E]=Textures_obj[L]}else A.textures[E]=0}}}else if(y=="scene"){z=JSON.parse(m.data.data);m=0;for(y=z.sceneObjects.length;m<y;++m){A=z.sceneObjects[m];A.obj!==null&&nop();if(A.reassembled===g)r(A),A.reassembled=!0;z.sceneObjects[m]=x(A)}A=new Scene;m=A.camera;y=m.transform;q(z.camera,m);q(z.camera.transform,y);r(m);A.camera=m;A.camera.transform=y;A.camera.frustum=new Frustum;m=0;for(y=z.sceneObjects.length;m<y;++m){E=z.sceneObjects[m];A.bindSceneObject(E);
try{E.getAABB()}catch(R){}}m=0;for(y=z.lights.length;m<y;++m)E=new Light,q(z.lights[m],E),E.trans=new Transform,r(E),A.bindLight(E);n(A)}else console.log("message from collada worker:",m.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:c,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:z,prepareMesh:s,file:q,sceneFile:r};self.addEventListener("message",function(b){if(b.data.message===
"init"){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("RigidVehicle",function(m){var x=m.undef,z=m.enums,q,r,s=function(c){var c=m.get(c)||{},a=c.mesh,b=c.collision;this.maxEngineForce=c.maxEngineForce||2E3;this.maxBreakingForce=c.maxBreakingForce||125;this.steeringClamp=c.steeringClamp||0.51;this.mass=c.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new m.CollisionMap(b);this.sceneObject=new m.SceneObject(this.bodyMesh);if(!q||!r)new Ammo.btVector3,new Ammo.btVector3,q=new Ammo.btTransform,r=new m.Quaternion,new Ammo.btQuaternion;if(c.wheels!=x){a=0;for(b=c.wheels.length;a<b;a++){var e=c.wheels[a];e instanceof m.VehicleWheel?this.addWheel(e):this.addWheel(new m.VehicleWheel(e))}}};s.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(c){this.body=
new m.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});m.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);m.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(c.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(z.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,b=0;b<this.wheels.length;b++)m.vec3bt_copy(this.wheels[b].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[b].getSuspensionRest(),this.wheels[b].getWheelRadius(),this.m_tuning,this.wheels[b].getSteering());c.dynamicsWorld.addVehicle(this.m_vehicle);c.bind(this.body);this.updateSuspension()},evaluate:function(){for(var c=this.m_vehicle.getNumWheels(),
a=0;a<c;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var b=this.m_vehicle.getWheelTransformWS(a),e=b.getOrigin();this.wheels[a].wheelObj.position[0]=e.x();this.wheels[a].wheelObj.position[1]=e.y();this.wheels[a].wheelObj.position[2]=e.z();b=b.getRotation();r.x=
b.x();r.y=b.y();r.z=b.z();r.w=b.w();b=r.toEuler();this.wheels[a].wheelObj.rotation[0]=b[0];this.wheels[a].wheelObj.rotation[1]=b[1];this.wheels[a].wheelObj.rotation[2]=b[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(c){if(this.body&&(this.body.isActive()||c))return this.body.getBody().getMotionState().getWorldTransform(q),c=q.getOrigin(),c.x!=c.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
c.x(),this.sceneObject.position[1]=c.y(),this.sceneObject.position[2]=c.z()),c=q.getRotation(),r.x=c.x(),r.y=c.y(),r.z=c.z(),r.w=c.w(),r.x!=r.x?console.log("rotation is NaN"):(c=r.toEuler(),this.sceneObject.rotation[0]=c[0],this.sceneObject.rotation[1]=c[1],this.sceneObject.rotation[2]=c[2]),!0},setEngineForce:function(c){this.gEngineForce=c;if(this.gEngineForce>this.maxEngineForce)this.gEngineForce=this.maxEngineForce;if(this.gEngineForce<-this.maxEngineForce)this.gEngineForce=-this.maxEngineForce},
getEngineForce:function(){return this.gEngineForce},incEngine:function(c){this.setEngineForce(this.getEngineForce()+c)},decEngine:function(c){this.setEngineForce(this.getEngineForce()-c)},setSteering:function(c){this.gVehicleSteering=c},getSteering:function(){return this.gVehicleSteering},incSteering:function(c){this.gVehicleSteering+=c;if(this.gVehicleSteering>this.steeringClamp)this.gVehicleSteering=this.steeringClamp;if(this.gVehicleSteering<-this.steeringClamp)this.gVehicleSteering=-this.steeringClamp},
setBrake:function(c){this.gBreakingForce=c},getWheelGroundPosition:function(c){return this.wheels[c].wheelObj.getWorldPosition()-[0,wheels[c].getWheelRadius(),0]},getWheelSkid:function(c){return this.m_vehicle.getWheelInfo(c).get_m_skidInfo()},getRigidGround:function(c){this.m_vehicle.getWheelInfo(c)},addWheel:function(c,a){if(a===x)a=this.wheels.length;this.wheels[a]=c},getWheel:function(c){return this.wheels[c]},bindToScene:function(c){for(var a=this.wheels.length,b=0;b<a;b++)c.bind(this.getWheelObj(b));
c.bind(this.getSceneObject())},getWheelObj:function(c){return this.getWheel(c).wheelObj},updateSuspension:function(){var c,a=this.m_vehicle.getNumWheels();for(c=0;c<a;c++){var b=this.m_vehicle.getWheelInfo(c);b.set_m_suspensionStiffness(this.wheels[c].getSuspensionStiffness());b.set_m_suspensionRestLength1(this.wheels[c].getSuspensionRest());b.set_m_wheelsDampingRelaxation(this.wheels[c].getDampingRelaxation());b.set_m_wheelsDampingCompression(this.wheels[c].getDampingCompression());b.set_m_frictionSlip(this.wheels[c].getFrictionSlip());
b.set_m_rollInfluence(this.wheels[c].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(c=0;c<a;c++)this.m_vehicle.updateWheelTransform(c,!0)}},getMass:function(){return this.mass},setMass:function(c){this.mass=c;this.body&&this.body.setMass(this.mass)}};var c=function(c){c=m.get(c)||{};this.wheelRef=new m.SceneObject;this.wheelObj=new m.SceneObject;this.wheelRef.scale=c.scale||[1,1,1];this.wheelRadius=c.radius||0;this.wheelWidth=c.width||0;c.mesh!=x&&this.setModel(c.mesh);
this.suspensionStiffness=c.suspensionStiffness||40;this.suspensionRest=c.suspensionRest||0.05;this.dampingRelaxation=c.dampingRelaxation||2.3;this.dampingCompression=c.dampingCompression||2.4;this.frictionSlip=c.frictionSlip||0.94;this.rollInfluence=c.rollInfluence||0.5;this.wheelPosition=c.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=c.steering||!1;this.braking=c.braking||!1;this.driving=c.driving||!1};c.prototype={setModel:function(c,a,b){this.wheelModel=c;this.wheelRadius=a||0;this.wheelWidth=
b||0;if(this.wheelRadius===0)this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2;if(this.wheelWidth===0)this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0];this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(c){this.suspensionStiffness=c},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(c){this.suspensionRest=
c},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(c){this.dampingRelaxation=c},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(c){this.dampingCompression=c},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(c){this.frictionSlip=c},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(c){this.rollInfluence=c},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(c){this.wheelRadius=c},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(c){this.wheelWidth=c},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(c){this.wheelRotation=c;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(c){this.wheelPosition=c;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(c){this.steering=
c},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(c){this.driving=c},isDriving:function(){return this.driving}};return{Vehicle:s,VehicleWheel:c}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
