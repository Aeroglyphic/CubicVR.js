try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e$$5){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(n,y,z,q,r){function s(a,f){if(typeof a!=="object")return h("enumerator validation failed, invalid type base object."),r;if(f===r)return r;else if(typeof f==="number")return f;else if(typeof f==="string"){var b=parseInt(f,10);if(f!==""&&isFinite(b))return b;b=f.toUpperCase();b=a[b];if(b!==r)return b;else{h("enumerator validation failed, unknown enum value: "+f);var b="",d;for(d in a)a.hasOwnProperty(d)&&(b!==""&&(b+=", "),b+=d.toLowerCase());h("possible enum values are: "+b);return r}}else return r}
var e="";try{for(var g=y.querySelectorAll("script"),a=0,b=g.length;a<b;a++){var c=g[a].src.lastIndexOf("/CubicVR.js");c>-1&&(e=g[a].src.substr(0,c)+"/")}}catch(d){}var f=n.CubicVR={};f.contexts={};var h;try{h=console!==void 0&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(o){h=q}var m={quality:{LOW:0,MEDIUM:1,HIGH:2}};n.cubicvr=m;var B={},x=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t=function(a){function b(a,f,d){var o=function(){};o.prototype=a.prototype;f.prototype=new o;for(var h in d)f.prototype[h]=
d[h];return f}var d=this,o;a&&(o=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return o}}));d.undef=r;d.nop=q;d.scriptLocation=e;d.GLCore=g;d.Textures=[];d.Textures_obj=[];d.Textures_ref=[];d.Images=[];d.ShaderPool=[];d.log=h;d.enums=f.enums;d.MAX_LIGHTS=6;d.extendClassGeneral=b;d.extendClass=function(a,f,d){return b(a,function(){a.apply(this);f.apply(this,arguments)},d)};d.features={};d.quality=f.enums.HIGH;var c={low:{antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},medium:{antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},high:{antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0}};d.features=c.high;var g={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,
fogFar:0,resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1};g.init=function(a,b,o){var m,c=d.util,t=f.enums;b&&o?(b=c.getScriptContents(b),o=c.getScriptContents(o)):n.CubicVRShader.CubicVRCoreVS&&n.CubicVRShader.CubicVRCoreFS?(b=n.CubicVRShader.CubicVRCoreVS,o=n.CubicVRShader.CubicVRCoreFS):(b=c.getScriptContents(e+"CubicVR_Core.vs"),o=c.getScriptContents(e+"CubicVR_Core.fs"));if(a===r){a=y.createElement("canvas");if(!m)try{m=a.getContext("experimental-webgl",{antialias:d.features.antiAlias})}catch(x){return null}g.gl=
m;if(g.fixed_size!==null)g.width=g.fixed_size[0],g.height=g.fixed_size[1],g.resizeElement(a,g.width,g.height);else if(g.addResizeable(a),g.canvasSizeFactor!==1&&a.getContext!==r){var c=z.round(n.innerWidth*g.canvasSizeFactor),B=z.round(n.innerHeight*g.canvasSizeFactor);g.resizeElement(a,c,B);a.style.top=n.innerHeight/2-B/2+"px";a.style.left=n.innerWidth/2-c/2+"px";a.style.position="absolute"}else g.resizeElement(a,n.innerWidth,n.innerHeight);y.body.appendChild(a)}if(a.getContext!==r&&a.width!==r&&
a.height!==r){try{m||(m=a.getContext("experimental-webgl",{antialias:d.features.antiAlias})),m.viewport(0,0,a.width,a.height),g.canvas=a,g.width=a.width,g.height=a.height,m.clearColor(0,0,0,1),m.clearDepth(1),m.enable(m.DEPTH_TEST),m.depthFunc(m.LEQUAL)}catch(v){}if(!m)return null}else m=a;g.gl=m;g.CoreShader_vs=b;g.CoreShader_fs=o;m.enable(m.CULL_FACE);m.cullFace(m.BACK);m.frontFace(m.CCW);for(b=f.enums.light.type.NULL;b<t.light.type.MAX;b++)d.ShaderPool[b]=[];o=new d.Texture;a=new d.Material;for(b=
0;b<t.texture.map.MAX;b++)b!==t.texture.map.BUMP&&a.setTexture(o,b);a.opacity=0.5;for(b=1;;){if(!a.use(t.light.type.POINT,b)||b===8){d.MAX_LIGHTS=b;break}b++}a=g.emptyLight=new d.Light(t.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;h("Calibrated maximum lights per pass to: "+b);for(b=t.light.type.NULL;b<t.light.type.MAX;b++)d.ShaderPool[b]=[];if(g.resizeList.length)n.addEventListener("resize",function(){d.GLCore.onResize()},!1),g.resize_active=!0;return m};
g.addResizeable=function(a){d.GLCore.resizeList.push(a)};g.onResize=function(){var a=n.innerWidth,f=n.innerHeight;g.fixed_size!==null&&(a=d.GLCore.fixed_size[0],f=d.GLCore.fixed_size[1]);for(var b=0,o=d.GLCore.resizeList.length;b<o;b++)g.resizeElement(d.GLCore.resizeList[b],a,f)};g.setFixedAspect=function(a){d.GLCore.fixed_aspect=a};g.setFixedSize=function(a,f){d.GLCore.fixed_size=[a,f]};g.getCanvas=function(){return d.GLCore.canvas};g.resizeElement=function(a,f,b){var o=g.gl;if(g.fixed_aspect!==
0){var h=f*(1/d.GLCore.fixed_aspect);h>b&&(h=b,f=b*d.GLCore.fixed_aspect);b=h}if(a.getContext!==r){a.width=f;a.height=b;if(!d.GLCore.fixed_size)a.style.left=(n.innerWidth/2-f/2|0)+"px",a.style.top=(n.innerHeight/2-b/2|0)+"px",a.style.position="absolute";o.viewport(0,0,f,b)}else a.resize(f,b)};g.setDepthAlpha=function(a,f,b){g.depth_alpha=a;g.depth_alpha_near=f;g.depth_alpha_far=b};g.setDefaultFilter=function(a){g.default_filter=s(d.enums.texture.filter,a)};g.setSoftShadows=function(a){g.soft_shadow=
a};g.setFog=function(a){g.fog_enabled=a};g.setFogExp=function(a,f){g.fog_enabled=!0;g.fogLinear=!1;g.fogExp=!0;g.fogColor=a;g.fogDensity=f};g.setNoise=function(a){g.fogNoise=a};g.setFogLinear=function(a,f,b){g.fog_enabled=!0;g.fogExp=!1;g.fogLinear=!0;g.fogColor=a;g.fogNear=f;g.fogFar=b};g.setCanvasSizeFactor=function(a){g.canvasSizeFactor=a};g.setQuality=function(a){a=s(m.quality,a);if(a===m.quality.HIGH)d.features=c.high;else if(a===m.quality.MEDIUM)d.features=c.medium;else if(a===m.quality.LOW)d.features=
c.low;d.quality=a;return d.features};g.getQuality=function(){return d.features};var t=function(a,f,b){for(var o,h=y.getElementsByTagName("script"),m=0;m<h.length;++m){var c=h[m];if(c.getAttribute("data-cubicvr")){var e=c.getAttribute("src");if(e){var t=new XMLHttpRequest;t.open("GET",e,!1);t.send(null);if(t.status===200||t.status===0)c.text=t.responseText}}}typeof a==="object"?a.getContext?o=a:(o=a.canvas,f=a.vertexShader||f,b=a.fragmentShader||b):a&&(a[0]=="#"&&(a=a.substr(1)),o=y.getElementById(a));
for(var x in B){var a=B[x](d),v;for(v in a)a.hasOwnProperty(v)&&(d[v]=a[v])}g.init(o,f,b);return g.gl};d.GLCore=g;d.init=t;d.start=function(a,f,b,o,h){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=r);b=b||"Sorry, your browser does not appear to support WebGL :-(";if(a=t(a,o,h))return f&&typeof f==="function"&&f(a,d.getCanvas()),a;if(!a)return b&&typeof b==="function"?b():alert(b),!1};d.addResizeable=g.addResizeable;d.setFixedAspect=g.setFixedAspect;d.setFixedSize=g.setFixedSize;d.setCanvasSizeFactor=
g.setCanvasSizeFactor;d.getCanvas=g.getCanvas;d.enums=m;d.IdentityMatrix=x;d.Textures=d.Textures;d.Textures_obj=d.Textures_obj;d.Images=d.Images;d.globalAmbient=[0.1,0.1,0.1];d.setGlobalAmbient=function(a){d.globalAmbient=a};d.setGlobalDepthAlpha=g.setDepthAlpha;d.setDefaultFilter=g.setDefaultFilter;d.setSoftShadows=g.setSoftShadows;d.setQuality=g.setQuality;d.getQuality=g.getQuality;d.RegisterModule=f.RegisterModule;d.getScriptLocation=f.getScriptLocation;d.setFogExp=g.setFogExp;d.setFogLinear=g.setFogLinear;
d.setFogNoise=g.setFogNoise;d.parseEnum=s};f.init=function(a,b,d){var o;if(a&&a.context&&typeof a.context==="string")o=a.context;o=new t(o);return o.context?(f.contexts[o.context]=o,o.init(a,b,d),o):(n.CubicVR=f=o,o.init(a,b,d),o.GLCore.gl)};f.start=function(a,b,d,o,h){var m=new t;n.CubicVR=f=m;m.start(a,b,d,o,h);return m};f.RegisterModule=function(a,f){B[a]=f};f.getScriptLocation=function(){return e};f.enums=m})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(n){function y(a){return this.clearStack(a)}function z(){if(arguments.length===1)this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3];if(arguments.length===4)this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3]}var q=n.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=Math.PI/2,e={length:function(a){var b=a[0],c=a[1],a=a[2];return Math.sqrt(b*b+c*c+a*a)},normalize:function(a){var b=a[0],c=a[1],d=a[2];
if(b=Math.sqrt(b*b+c*c+d*d))return[a[0]/b,a[1]/b,a[2]/b];return[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,
b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,c){c===q&&(c=1.0E-7);if(a===q&&b===q)return!0;if(a===q||b===q)return!1;return Math.abs(a[0]-b[0])<c&&Math.abs(a[1]-b[1])<c&&Math.abs(a[2]-b[2])<c},moveViewRelative:function(a,b,c,d,f){var h=Math.sqrt(c*c+d*d),b=Math.atan2(b[2]-a[2],b[0]-a[0])+Math.atan2(d,c)+s;if(typeof f==="object")return[f[0]+h*Math.cos(b),f[1],f[2]+h*Math.sin(b)];return[a[0]+h*Math.cos(b),a[1],a[2]+h*Math.sin(b)]},trackTarget:function(a,b,c,d){var b=e.subtract(b,a),f=
e.length(b),h;h=e.normalize(b);h=e.multiply(h,c*(1/(1/(f-d))));f>d?a=e.add(a,h):f<d?(h=e.normalize(b),h=e.multiply(h,c*(1/(1/Math.abs(f-d)))),a=e.subtract(a,h)):a=[a[0],a[1]+h[2],a[2]];return a},getClosestTo:function(a,b,c){b=e.subtract(b,a);c=e.subtract(c,a);return e.add(e.multiply(b,e.dot(b,c)/e.dot(b,b)),a)},linePlaneIntersect:function(a,b,c,d){var f=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(d[0]-c[0])+a[1]*(d[1]-c[1])+a[2]*(d[2]-c[2]);if(Math.abs(b)<0.001)return!1;a=-(f+a[0]*c[0]+a[1]*c[1]+a[2]*
c[2])/b;return[c[0]+a*(d[0]-c[0]),c[1]+a*(d[1]-c[1]),c[2]+a*(d[2]-c[2])]}},g={lookat:function(a,b,c,d,f,h,o,m,g){var x=[],t=[],v=[],t=[];x[0]=d-a;x[1]=f-b;x[2]=h-c;v[0]=o;v[1]=m;v[2]=g;x=e.normalize(x);t=e.cross(x,v);t=e.normalize(t);v=e.cross(t,x);t=[t[0],v[0],-x[0],0,t[1],v[1],-x[1],0,t[2],v[2],-x[2],0,0,0,0,1];d=new n.Transform(t);d.translate([-a,-b,-c]);return d.getResult()},multiply:function(a,b,c){c===q&&(c=[]);c[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];c[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+
a[13]*b[3];c[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];c[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];c[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];c[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];c[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];c[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];c[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];c[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];c[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];c[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];c[12]=a[0]*b[12]+
a[4]*b[13]+a[8]*b[14]+a[12]*b[15];c[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];c[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];c[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return c},vec4_multiply:function(a,b,c){c===q&&(c=[]);c[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];c[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];c[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];c[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return c},vec3_multiply:function(a,b,c){c===q&&(c=[]);c[0]=b[0]*a[0]+b[4]*
a[1]+b[8]*a[2]+b[12];c[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];c[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return c},perspective:function(a,b,c,d){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(d+c)/(d-c),-1,0,0,-(2*d*c)/(d-c),0]},ortho:function(a,b,c,d,f,h){return[2/(b-a),0,0,0,0,2/(d-c),0,0,0,0,-2/(h-f),0,-(a+b)/(b-a),-(d+c)/(d-c),-(h+f)/(h-f),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-
a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],c=a[0],d=a[1],f=a[2],h=a[4],o=a[5],m=a[6],g=a[8],e=a[9],a=a[10],t=a*o-m*e,v=-a*h+m*g,C=e*h-o*g,q=c*t+d*v+f*C;if(!q)return null;q=1/q;b[0]=t*q;b[1]=(-a*
d+f*e)*q;b[2]=(m*d-f*o)*q;b[3]=v*q;b[4]=(a*c-f*g)*q;b[5]=(-m*c+f*h)*q;b[6]=C*q;b[7]=(-e*c+d*g)*q;b[8]=(o*c-d*h)*q;return b},inverse:function(a,b){var c=a[0]*a[5]-a[1]*a[4],d=a[0]*a[6]-a[2]*a[4],f=a[0]*a[7]-a[3]*a[4],h=a[1]*a[6]-a[2]*a[5],o=a[1]*a[7]-a[3]*a[5],m=a[2]*a[7]-a[3]*a[6],g=a[8]*a[13]-a[9]*a[12],e=a[8]*a[14]-a[10]*a[12],t=a[8]*a[15]-a[11]*a[12],v=a[9]*a[14]-a[10]*a[13],C=a[9]*a[15]-a[11]*a[13],n=a[10]*a[15]-a[11]*a[14],r=c*n-d*C+f*v+h*t-o*e+m*g;if(r!==0)return b===q&&(b=[]),b[0]=0+a[5]*n-
a[6]*C+a[7]*v,b[4]=0-a[4]*n+a[6]*t-a[7]*e,b[8]=0+a[4]*C-a[5]*t+a[7]*g,b[12]=0-a[4]*v+a[5]*e-a[6]*g,b[1]=0-a[1]*n+a[2]*C-a[3]*v,b[5]=0+a[0]*n-a[2]*t+a[3]*e,b[9]=0-a[0]*C+a[1]*t-a[3]*g,b[13]=0+a[0]*v-a[1]*e+a[2]*g,b[2]=0+a[13]*m-a[14]*o+a[15]*h,b[6]=0-a[12]*m+a[14]*f-a[15]*d,b[10]=0+a[12]*o-a[13]*f+a[15]*c,b[14]=0-a[12]*h+a[13]*d-a[14]*c,b[3]=0-a[9]*m+a[10]*o-a[11]*h,b[7]=0+a[8]*m-a[10]*f+a[11]*d,b[11]=0-a[8]*o+a[9]*f-a[11]*c,b[15]=0+a[8]*h-a[9]*d+a[10]*c,c=1/r,b[0]*=c,b[1]*=c,b[2]*=c,b[3]*=c,b[4]*=
c,b[5]*=c,b[6]*=c,b[7]*=c,b[8]*=c,b[9]*=c,b[10]*=c,b[11]*=c,b[12]*=c,b[13]*=c,b[14]*=c,b[15]*=c,b;return null},identity:function(a){if(a==q)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,c,d){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,c,1];if(d===q)return a;g.multiply(d.slice(0),a,d)},rotateAxis:function(a,b,c,d,f){var h=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=
[a+b*b*(1-a),b*c*(1-a)-d*h,b*d*(1-a)+c*h,0,c*b*(1-a)+d*h,a+c*c*(1-a),c*d*(1-a)-b*h,0,d*b*(1-a)-c*h,d*c*(1-a)+b*h,a+d*d*(1-a),0,0,0,0,1];if(f===q)return b;g.multiply(f.slice(0),b,f)},rotate:function(a,b,c,d){var f;d===q&&(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);c!==0&&(f=Math.sin(c*(Math.PI/180)),c=Math.cos(c*(Math.PI/180)),g.multiply(d.slice(0),[c,f,0,0,-f,c,0,0,0,0,1,0,0,0,0,1],d));b!==0&&(f=Math.sin(b*(Math.PI/180)),c=Math.cos(b*(Math.PI/180)),g.multiply(d.slice(0),[c,0,-f,0,0,1,0,0,f,0,c,0,0,0,0,
1],d));a!==0&&(f=Math.sin(a*(Math.PI/180)),c=Math.cos(a*(Math.PI/180)),g.multiply(d.slice(0),[1,0,0,0,0,c,f,0,0,-f,c,0,0,0,0,1],d));return d},scale:function(a,b,c,d){if(d===q)return[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1];g.multiply(d.slice(0),[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1],d)},transform:function(a,b,c){var d=g.identity();a&&g.translate(a[0],a[1],a[2],d);b&&(b[0]===0&&b[1]===0&&b[2]===0||g.rotate(b[0],b[1],b[2],d));c&&(c[0]===1&&c[1]===1&&c[2]===1||g.scale(c[0],c[1],c[2],d));return d}};y.prototype={setIdentity:function(){this.m_stack[this.c_stack]=
[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=n.mat4;if(!this.c_stack)return this.m_stack[0];var b=r;if(this.valid>this.c_stack-1)this.valid=this.c_stack-1;for(var c=this.valid;c<this.c_stack+1;c++)b=a.multiply(b,this.m_stack[c]),this.m_cache[c]=b;this.valid=this.c_stack-1;return this.result=
this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:r;return this},popMatrix:function(){if(this.c_stack!==0)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==q?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,c){var d=n.mat4;if(typeof a==="object")return this.translate(a[0],a[1],a[2]);var f=this.getIdentity();f[12]=a;f[13]=b;f[14]=c;this.m_stack[this.c_stack]=
d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,c){var d=n.mat4;if(typeof a==="object")return this.scale(a[0],a[1],a[2]);var f=this.getIdentity();f[0]=a;f[5]=b;f[10]=c;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,c,d){var f=n.mat4;if(typeof a==="object")return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],
0,0,1),this;var h,o;if(b||c||d)h=Math.sin(-a*(Math.PI/180)),o=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=o*b,a[9]=h*b,a[6]=-h*b,a[10]=o*b,this.m_stack[this.c_stack]=f.multiply(a,this.m_stack[this.c_stack]));c&&(b=this.getIdentity(),b[0]=o*c,b[8]=-h*c,b[2]=h*c,b[10]=o*c,this.m_stack[this.c_stack]=f.multiply(b,this.m_stack[this.c_stack]));d&&(c=this.getIdentity(),c[0]=o*d,c[4]=h*d,c[1]=-h*d,c[5]=o*d,this.m_stack[this.c_stack]=f.multiply(c,this.m_stack[this.c_stack]));this.valid===this.c_stack&&
this.c_stack&&this.valid--;return this}};z.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],c,d,f;b>1.0E-8?(c=Math.sqrt(b)*2,b=(a[9]-a[6])/c,d=(a[2]-a[8])/c,f=(a[4]-a[1])/c,a=0.25*c):a[0]>a[5]&&a[0]>a[10]?(c=Math.sqrt(1+a[0]-a[5]-a[10])*2,b=0.25*c,d=(a[4]+a[1])/c,f=(a[2]+a[8])/c,a=(a[9]-a[6])/c):a[5]>a[10]?
(c=Math.sqrt(1+a[5]-a[0]-a[10])*2,b=(a[4]+a[1])/c,d=0.25*c,f=(a[9]+a[6])/c,a=(a[2]-a[8])/c):(c=Math.sqrt(1+a[10]-a[0]-a[5])*2,b=(a[2]+a[8])/c,d=(a[9]+a[6])/c,f=0.25*c,a=(a[4]-a[1])/c);this.x=b;this.y=d;this.z=f;this.w=a},fromEuler:function(a,b,c){var d=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),f=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),h=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),o=d*f,m=b*c;this.w=o*h-m*a;this.x=o*a+m*h;this.y=b*f*h+d*c*a;this.z=d*c*h-b*f*a},toEuler:function(){var a=
this.w*this.w,b=this.x*this.x,c=this.y*this.y,d=this.z*this.z;return[180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-c+d+a),180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-c-d+a)]},multiply:function(a,b){b===q&&(b=a,a=this);return new z(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,c){c===q&&(c=1.0E-8);if(a===
q&&b===q)return!0;if(a===q||b===q)return!1;return Math.abs(a[0]-b[0])<c&&Math.abs(a[1]-b[1])<c}},vec3:e,mat3:{transpose_inline:function(a){var b=a[1],c=a[2],d=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=c;a[7]=d},vec3_multiply:function(a,b,c){c===q&&(c=[]);c[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];c[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];c[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return c}},mat4:g,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<
b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){b===void 0&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var c=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];if(c<0)return-1;else if(c>0)return 1;return 0},normalize:function(a){var b=
Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var c=n.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),c=Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2]),d=a[3]+b[3];if(c*c<d*d)return!0;return!1}},triangle:{normal:function(a,b,c,d){d===q&&(d=[]);var f=a[0]-b[0],h=a[1]-b[1],a=a[2]-b[2],o=b[0]-c[0],m=b[1]-c[1],b=b[2]-c[2];d[0]=h*b-a*m;d[1]=a*o-f*b;d[2]=f*m-h*o;return d}},Transform:y,Quaternion:z}});
CubicVR.RegisterModule("Utility",function(n){var y=n.undef,z=n.log,q={},r={},s={multiSplit:function(e,g){for(var a=e.split(g[0]),b=1,c=g.length;b<c;b++)for(var d=g[b],f=0,h=a.length;f<h;f++){var o=a[f].trim().split(d),m=!0;if(o.length>1)for(var B=0;B<o.length;B++)o[B].trim()!==""&&(a.splice(f+B,B===0?1:0,o[B]),B&&h++,m=!1);else a[f]=a[f].trim().replace(d,""),a[f]!==""&&(m=!1);m&&(a.splice(f,1),h--,f--)}return a},getJSONScriptObj:function(e,g){if(typeof e==="string"&&e.length>0&&e.charAt(0)==="#"){var a=
document.getElementById(e.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return e},getScriptContents:function(e){var g=document.getElementById(e),a="",b="";if(g){if(g.src!==""||g.attributes.srcUrl!==y)b=g.src!==""?g.src:g.attributes.srcUrl.value}else b=e;if(b.length!==0){if(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("application/json"),e.open("GET",b,!1),e.send(null),e.status===200||e.status===0)a=e.responseText}else for(b=g.firstChild;b;)b.nodeType===3&&(a+=b.textContent),
b=b.nextSibling;return a},xmlNeedsBadgerFish:function(e){for(e=[e];e.length;){var g=e.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,b=g.childNodes.length;a<b;a++)e.push(g.childNodes[a])}return!1},getFirstEntry:function(e){for(var g in e)if(e.hasOwnProperty(g))return e[g]},getURIFileType:function(e){function g(a){for(var f in c)if(c.hasOwnProperty(f)&&c[f].indexOf(a)!==-1)return f;return y}var a=e.toLowerCase(),b=["_ext","ext"],c={json:["js","javascript","json"],xml:["xml"]};if(a.indexOf("?")!==
-1){var d=a.split("?"),a=d[0];if(d[1])for(var d=d[1].indexOf("&")===-1?[d[1]]:d[1].split("&"),f=0,h=d.length;f<h;f++){var o=d[f];if(o.indexOf("=")!==-1&&(o=o.split("="),b.indexOf(o[0])!==-1)){var m=g(o[1]);if(m)return m;else z("Unable to determine extension type '"+o[1]+"' provided for URI: ["+e+"], falling back to filename part.")}}}if(a.indexOf(".")!==-1)return e=a.split("."),g(e[e.length-1]);return y},get:function(e,g){var a=null,b=null,c=null,g=g||null;if(e===y)return y;if(isFinite(e))return e;
typeof e==="function"&&(e=e(g));if(typeof e==="object"){if(g&&!(e instanceof g))return new g(e);return e}if(typeof e=="string"){if(e.indexOf("\n")!==-1)return e;else e[0]=="#"&&(a=e.substr(1),(c=document.getElementById(a))&&(b=c.src||null));!c&&!a&&!b&&e&&(b=e)}if(c&&!b)return CubicVR.util.collectTextNode(c);else if(b){var a=null,d=r[b]||null;if(!d){var f=s.getURIFileType(b);if(f===y&&!c)return b;f==="json"?d=CubicVR.util.getJSON(b):a=f==="xml"?CubicVR.util.getXML(b):CubicVR.util.getURL(b);a&&a.childNodes?
d=s.getFirstEntry(s.xml2json(a)):a&&(d=a)}d&&r[b]===y&&(r[b]=d);if(g)if(q[b]&&q[b]instanceof g)return q[b];else{if(d)return q[b]=new g(d),q[b]}else if(d)return d;return b}else return a&&!c&&console.log("Unable to retrieve requested ID: '"+e+"'"),y},clearCache:function(){q={};r={}},getURL:function(e){try{var g=new XMLHttpRequest;g.open("GET",e,!1);g.send(null);if(g.status===200||g.status===0)if(g.responseText.length)return g.responseText;else if(g.responseXML)return g.responseXML}catch(a){alert(e+
" failed to load.")}return null},getXML:function(e){try{var g=new XMLHttpRequest;g.open("GET",e,!1);g.overrideMimeType("application/xml");g.send(null);if(g.status===200||g.status===0)return g.responseXML}catch(a){try{alert(e+" failed to load.")}catch(b){throw a;}}return null},getJSON:function(e){try{var g=new XMLHttpRequest;g.open("GET",e,!1);g.overrideMimeType("application/json");g.send(null);if(g.status===200||g.status===0)return eval("("+g.responseText+")")}catch(a){try{alert(e+" failed to load.")}catch(b){throw a;
}}return null},repackArray:function(e,g,a){e.length!==parseInt(g,10)*parseInt(a,10)&&z("array repack error, data size !== stride*count: data.length="+e.length+" stride="+g+" count="+a);for(var a=[],b=0,c=0,d=e.length;c<d;c++){var f=c%g;f===0&&(a[b]=[]);a[b][f]=e[c];f===g-1&&b++}return a},collectTextNode:function(e){if(!e)return"";for(var g="",e=e.childNodes,a=0,b=e.length;a<b;a++)g+=e[a].nodeValue;return g},floatDelimArray:function(e,g){g!="\n"&&(e=e.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=
e.split(g?g:","),b=0,c=a.length;b<c;b++)a[b]=parseFloat(a[b]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(e,g){g!="\n"&&(e=e.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=e.split(g?g:","),b=0,c=a.length;b<c;b++)a[b]=parseInt(a[b],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(e,g){g!="\n"&&(e=e.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=e.split(g?g:","),b=0,c=a.length;b<c;b++)a[b]=a[b];return a},xmlstring2json:function(e){for(var e=
e.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],c=[],d={},f=d,h=0,o=e.length;h<o;h++){var m=e[h];if(!(g.test(m)||m==="")&&!/<\?\s?xml[^>]*>/.test(m))if(/<.*?>/.test(m)){a=m.split(/<([^>]*?)(.*)?>/g)[2];if(a[0]!=="/"&&(m=a.split(" "),a=m[0],m=m.slice(1).join(" "),b.push(a),c.push(d),d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:(d[a]||(d[a]={}),d=d[a]),d instanceof Array&&(d.push({}),d=d[d.length-1]),a.substr(a.length-1)==="/"||m.substr(m.length-1)==="/"))a=
"/"+a;if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;else b.pop(),d=c.length?c[c.length-1]:null,c.pop()}else{var B=c[c.length-1][a];B instanceof Array?(B.pop(),B.push(s.parseNumeric(m))):c[c.length-1][a]=s.parseNumeric(m)}}return f},xmlstring2badgerfish:function(e){for(var e=e.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],c=[],d={},f=d,h=0,o=e.length;h<o;h++)if(a=e[h],!(g.test(a)||a===
"")&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=a.split(/<([^>]*?)(.*)?>/g)[2];if(a[0]!=="/"){var m=a.split(" ");a=m[0];m=m.slice(1).join(" ");b.push(a);c.push(d);d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:d[a]||(d[a]={});d=d[a];d instanceof Array&&(d.push({}),d=d[d.length-1]);if(a.substr(a.length-1)==="/"||m.substr(m.length-1)==="/")a="/"+a;for(var m=s.multiSplit(m,"= "),B="",x=0;x<m.length;x++){var t=m[x];t[t.length-1]==="/"&&(t=t.substr(0,t.length-1));if(x%2===1){if(t[0]==="'"||t[0]==='"'){for(var v=
t[0],t=t.substr(1);t[t.length-1]!==v&&m.length+1<x;)t+=m.splice(x+1,1);t[t.length-1]===v&&(t=t.substr(0,t.length-1))}d["@"+B]=t}else B=t}}if(a[0]==="/")if(a=a.substr(1),b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+b[b.length-1]),!1;else b.pop(),d=c.length?c[c.length-1]:null,c.pop()}else d.$=a;return f},xml2badgerfish:function(e){var g={},a=[],b,c,d,f,h,o=/^\s+|\s+$/g;e.jsonParent=g;for(a.push(e);a.length;){c=a.pop();var m=null;d=c.jsonParent;e=0;for(b=c.childNodes.length;e<
b;e++)f=c.childNodes[e],h=f.tagName,h!==y&&(m=m||{},m[h]=m[h]||0,m[h]++);if(c.attributes&&c.attributes.length){e=0;for(b=c.attributes.length;e<b;e++)f=c.attributes[e],d["@"+f.name]=f.value}e=0;for(b=c.childNodes.length;e<b;e++)if(f=c.childNodes[e],h=f.tagName,f.nodeType===1)m[h]>1?(d[h]=d[h]||[],d[h].push({}),f.jsonParent=d[h][d[h].length-1]):(d[h]=d[h]||{},f.jsonParent=d[h]),a.push(f);else if(f.nodeType===3&&f.nodeValue.replace(o,"")!=="")d.$=d.$||"",d.$+=f.nodeValue}return g},isTextNode:function(e){for(var e=
e.childNodes,g=0,a=e.length;g<a;g++)if(e[g].nodeType!==3||e[g].childNodes.length)return!1;return!0},parseNumeric:function(e){var g=null,a,g=e.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(g==="")return g;if((g.indexOf(" ")!==-1||g.indexOf(",")!==-1)&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=
g.split(" ");e=0;for(a=g.length;e<a;e++)g[e]=s.floatDelimArray(g[e],",");return g}}else{g=g.split(" ");e=0;for(a=g.length;e<a;e++)g[e]=s.intDelimArray(g[e],",");return g}else return s.floatDelimArray(g,",");else return s.floatDelimArray(g," ");else return s.intDelimArray(g,",");else return s.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);if(!isNaN(a))return/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10);return e},xml2json:function(e){var g={},a=[],b,c,d,f,h;e.jsonParent=g;for(a.push(e);a.length;){c=
a.pop();var o=null;d=c.jsonParent;e=0;for(b=c.childNodes.length;e<b;e++)f=c.childNodes[e],h=f.tagName,h!==y&&(o=o||{},o[h]=o[h]||0,o[h]++);e=0;for(b=c.childNodes.length;e<b;e++){f=c.childNodes[e];h=f.tagName;var m=s.isTextNode(f);if(f.nodeType===1)o[h]>1?(d[h]=d[h]||[],m?d[h].push(s.parseNumeric(s.collectTextNode(f))):(d[h].push({}),f.jsonParent=d[h][d[h].length-1])):m?d[h]=s.parseNumeric(s.collectTextNode(f)):(d[h]=d[h]||{},f.jsonParent=d[h]),m||a.push(f)}}return g}};return{util:s,get:s.get,clearCache:s.clearCache}});
CubicVR.RegisterModule("Shader",function(n){function y(d,f){var h=n.util,o,m,c,g,t=r.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";d.indexOf("\n")!==-1?(c=d,o=a(r.gl,d,"x-shader/x-vertex")):(o=b(r.gl,d),o===null&&(c=h.getURL(d),o=a(r.gl,c,"x-shader/x-vertex")));if(!t.getShaderParameter(o,t.COMPILE_STATUS))this.vertexLog=t.getShaderInfoLog(o),this.success=!1;f.indexOf("\n")!==-1?(g=f,m=a(r.gl,f,"x-shader/x-fragment")):(m=b(r.gl,
f),m===null&&(g=h.getURL(f),m=a(r.gl,g,"x-shader/x-fragment")));if(!t.getShaderParameter(m,t.COMPILE_STATUS))this.fragmentLog=t.getShaderInfoLog(m),this.success=!1;if(this.success){if(this.shader=t.createProgram(),t.attachShader(this.shader,o),t.attachShader(this.shader,m),t.linkProgram(this.shader),!r.gl.getProgramParameter(this.shader,t.LINK_STATUS))e("Error linking shader:\n"+t.getProgramInfoLog(this.shader)),this.success=!1}else o=h.multiSplit(this.vertexLog,";\n"),h=h.multiSplit(this.fragmentLog,
";\n"),o.length&&this.dumpErrors(o,c),h.length&&this.dumpErrors(h,g)}function z(a){this._update=a.update||null;this._init=a.init||null;this._vertex=n.get(a.vertex)||null;this._fragment=n.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=a.trim()!==""?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var q=n.undef,r=n.GLCore,s=n.enums,e=n.log,g=n.util;s.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,f,b){if(b==="x-shader/x-fragment")b=a.createShader(a.FRAGMENT_SHADER);else if(b==="x-shader/x-vertex")b=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(b,f);a.compileShader(b);return b},b=function(a,f){var b=document.getElementById(f);if(!b)return null;for(var o="",m=b.firstChild;m;)m.nodeType===3&&(o+=m.textContent),
m=m.nextSibling;if(b.type==="x-shader/x-fragment")b=a.createShader(a.FRAGMENT_SHADER);else if(b.type==="x-shader/x-vertex")b=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(b,o);a.compileShader(b);return b};y.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,f,b){b=b||"Error on line";b+=" ";for(var f=f.split("\n"),o=0,m=a.length;o<m;o++){var c=a[o];if(c.indexOf("ERROR: ")===0){var c=c.substr(7).trim(),g=c.substr(0,c.indexOf(" ")),c=c.substr(g.length),g=g.split(":"),
g=parseInt(g[1],10);console.log(g+"> "+f[g-1]);console.log(b+g+", :"+c)}}},bindSelf:function(a){var f,b,o;a.indexOf(".")!==-1?a.indexOf("[")!==-1?(f=a.split("["),o=f[0],f=f[1].split("]"),b=f[0],f=f[1].split("."),f=f[1],this[o]===q&&(this[o]=[]),this[o][b]===q&&(this[o][b]={}),this[o][b][f]=this.uniforms[a]):(f=a.split("."),o=f[0],f=f[1],this[o]===q&&(this[o]={}),this[o][f]=this.uniforms[a]):a.indexOf("[")!==-1?(f=a.split("["),o=f[0],f=f[1].split("]"),b=f[0],this[o]===q&&(this[o]=[]),this[o][b]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,f){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==q&&this.setMatrix(a,f);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,f){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
f!==q&&this.setVector(a,f);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,f){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==q&&this.setFloat(a,f);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=r.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,f){this.use();this.uniforms[a]=r.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==q&&this.setInt(a,f);this.bindSelf(a);return this.uniforms[a]},use:function(){r.gl.useProgram(this.shader)},setMatrix:function(a,f){var b=this.uniforms[a];if(b!==null){var o=f.length;o===16?r.gl.uniformMatrix4fv(b,!1,f):o===9?r.gl.uniformMatrix3fv(b,!1,f):o===
4&&r.gl.uniformMatrix2fv(b,!1,f)}},setInt:function(a,f){var b=this.uniforms[a];b!==null&&r.gl.uniform1i(b,f)},setFloat:function(a,f){var b=this.uniforms[a];b!==null&&r.gl.uniform1f(b,f)},setVector:function(a,b){var h=this.uniforms[a];if(h!==null){var o=b.length;o==3?r.gl.uniform3fv(h,b):o==2?r.gl.uniform2fv(h,b):r.gl.uniform4fv(h,b)}},clearArray:function(a){a=this.uniforms[a];a!==null&&r.gl.disableVertexAttribArray(a)},bindArray:function(a,b){var h=r.gl,o=this.uniforms[a];if(o!==null){var m=this.uniform_type[a];
m===s.shader.uniform.ARRAY_VERTEX?(h.bindBuffer(h.ARRAY_BUFFER,b),h.vertexAttribPointer(o,3,h.FLOAT,!1,0,0),h.enableVertexAttribArray(o)):m===s.shader.uniform.ARRAY_UV?(h.bindBuffer(h.ARRAY_BUFFER,b),h.vertexAttribPointer(o,2,h.FLOAT,!1,0,0)):m===s.shader.uniform.ARRAY_FLOAT&&(h.bindBuffer(h.ARRAY_BUFFER,b),h.vertexAttribPointer(o,1,h.FLOAT,!1,0,0))}}};var c={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g," ").replace(/ *\[ */g,
"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var h=a[i];h.indexOf("#define")===0&&(h=h.split(" "),h.length>2&&(b[h[1]]=h.slice(2).join(" ")))}return b},replaceAll:function(a,b,h,o){var h=h||"",o=o||"",m;for(m in b)if(b.hasOwnProperty(m))for(var c=h+m+o;a.indexOf(c)!==-1;)a=a.replace(c,h+b[m]+o);return a},getShaderInfo:function(a,b){var h,o,m,e,x,t,v=["uniform","attribute",
"varying"],C=[],n={};t={};var r;b===q&&(b="");a=c.tidyScript(a);b=c.tidyScript(b);n.v_define=c.getDefines(a);n.f_define=c.getDefines(b);a=c.replaceAll(a,n.v_define,"[","]");b=c.replaceAll(b,n.f_define,"[","]");r=g.multiSplit(a+"\n"+b,"\n;");var w=[];e=m=-1;h=0;for(o=r.length;h<o;h++)x=r[h],m===-1&&x.indexOf("struct")===0?m=h:e===-1&&m!==-1&&x.indexOf("}")!==-1&&(e=h+1),m!==-1&&e!==-1&&(x=r.slice(m,e).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,"").replace(/\n\n/gm,"\n"),
w.push({start:m,end:e,struct:x.split("\n")}),e=m=-1);h=0;for(o=w.length;h<o;h++){var u=w[h].struct,s=null;m=0;for(e=u.length;m<e;m++)x=u[m].split(" "),x.length<=1||(x[0]=="struct"?(s=x[1],t[s]={}):s&&(t[s][x[1]]=x[0]))}n.struct=t;h=0;for(o=v.length;h<o;h++)n[v[h]]=[];h=0;for(o=r.length;h<o;h++){x=r[h];m=0;for(e=v.length;m<e;m++)if(w=v[m],x.indexOf(w)===0&&(t=x.split(" "),t.length===3&&t[0]==w&&C.indexOf(t[2])===-1))if(C.push(t[2]),t[2].indexOf("[")!==-1){var u=t[2].split("["),s=u[1].replace("]",""),
z=parseInt(s,10);z!==z||(s=z);n[w].push({name:u[0],type:t[1],isArray:!0,len:s})}else n[w].push({name:t[2],type:t[1]})}return n},genShaderVarList:function(a,b){var h=a[b],o=[],m,c,g,e,v,C;if(!h)return[];m=0;for(c=h.length;m<c;m++){var q=h[m];if(a.struct[q.type]){var n=a.struct[q.type];if(n&&q.isArray){g=0;for(e=q.len;g<e;g++)for(C in v=q.name+"["+g+"]",n)n.hasOwnProperty(C)&&o.push({location:v+"."+C,type:n[C],basename:q.name})}else for(C in n)o.push({location:q.name+"."+C,type:n[C],basename:q.name})}else if(q.isArray){g=
0;for(e=q.len;g<e;g++)v=q.name+"["+g+"]",o.push({location:v,type:q.type,basename:q.name})}else o.push({location:q.name,type:q.type,basename:q.name})}return o},getShaderVars:function(a){var b={};b.uniform=c.genShaderVarList(a,"uniform");b.attribute=c.genShaderVarList(a,"attribute");return b}};z.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},hasDepthPack:function(){return this._hasDepthPack},
_init_shader:function(a,b,h,o,m){h=h||[];a=n.util.get(a);b=n.util.get(b);m=m||"#define customShader_splice";if(o=o===q?this._vertex||this._fragment:o)o=a.indexOf(m),m=b.indexOf(m),o!==-1&&this._vertex&&(a=a.substr(0,o)+this._vertex),m!==-1&&this._fragment&&(b=b.substr(0,m)+this._fragment);this._shader=new n.Shader(a,b);this._shaderInfo=c.getShaderInfo(a,b);this._shaderVars=c.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,"uniform",h);this._appendShaderVars(this._shaderVars,
"attribute",h);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,h){for(var a=0,o=this._shaderVars[b].length;a<o;a++){var m=this._shaderVars[b][a],c=m.location;if(h.indexOf(m.basename)===-1&&(m=m.type,m==="vec3"?b==="attribute"?this._shader.addVertexArray(c):this._shader.addVector(c):m==="vec2"?b==="attribute"?this._shader.addUVArray(c):this._shader.addVector(c):m==="float"?b==="attribute"?this._shader.addFloatArray(c):this._shader.addFloat(c):
m==="sampler2D"||m==="int"?this._shader.addInt(c):(m==="mat4"||m==="mat3"||m==="mat2")&&this._shader.addMatrix(c),c=this._bindSelf(c),m=="sampler2D"&&c)){var g=r.gl;c.set=function(a,b){return function(f,d){d!==q&&(g.activeTexture(g.TEXTURE0+f),g.bindTexture(r.gl.TEXTURE_2D,n.Textures[d.tex_id]));b.value=f;a.update(b)}}(this,c)}}},_bindSelf:function(a){var b,h,o,m;if(this._shader.uniforms[a]!==null){a.indexOf(".")!==-1?a.indexOf("[")!==-1?(b=a.split("["),o=b[0],b=b[1].split("]"),h=b[0],b=b[1].split("."),
b=b[1],this[o]===q&&(this[o]=[]),this[o][h]===q&&(this[o][h]={}),m={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][h][b]=m):(b=a.split("."),o=b[0],b=b[1],this[o]===q&&(this[o]={}),m={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][b]=m):a.indexOf("[")!==-1?(b=a.split("["),o=b[0],b=b[1].split("]"),h=b[0],this[o]===q&&(this[o]=[]),m={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][h]=
m):(m={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=m);this._bindings.push(m);if(m)m.set=function(a,b){return function(f){b.value=f;a.update(b)}}(this,m);return m}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var b=0,h=this._bindings.length;b<h;b++)this.update(this._bindings[b],a)},update:function(a){if(this._initialized){var b=r.gl,h=a.value,o=a.location;if(o!==null)a.type===s.shader.uniform.MATRIX?(a=h.length,
a===16?b.uniformMatrix4fv(o,!1,h):a===9?b.uniformMatrix3fv(o,!1,h):a===4&&b.uniformMatrix2fv(o,!1,h)):a.type===s.shader.uniform.INT?b.uniform1i(o,h):a.type===s.shader.uniform.VECTOR?(a=h.length,a===3?b.uniform3fv(o,h):a===2?b.uniform2fv(o,h):b.uniform4fv(o,h)):a.type===s.shader.uniform.FLOAT?b.uniform1f(o,h):a.type===s.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,h),b.vertexAttribPointer(o,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o)):a.type===s.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,
h),b.vertexAttribPointer(o,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o)):a.type===s.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,h),b.vertexAttribPointer(o,1,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o))}}};return{Shader:y,shader_util:c,CustomShader:z}});
CubicVR.RegisterModule("MainLoop",function(n){function y(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function z(){n.GLCore.mainloop!==null&&(window.requestAnimationFrame&&window.requestAnimationFrame(z),n.GLCore.mainloop.interval())}function q(a,b,c){if(window.requestAnimationFrame===s)window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null;if(n.GLCore.mainloop!==null)!window.requestAnimationFrame&&n.GLCore.mainloop&&clearInterval(n.GLCore.mainloop.interval),n.GLCore.mainloop=null;if(a===null)n.GLCore.mainloop=null;else{this.renderList=[];var d=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],f=new y;f.start();this.timer=f;this.func=a;this.doclear=b!==s?b:!0;n.GLCore.mainloop=this;if(g.resizeList.length&&!n.GLCore.resize_active)window.addEventListener("resize",
function(){n.GLCore.onResize()},!1),n.GLCore.resize_active=!0;b=function(){return function(){var b=n.GLCore.gl;f.update();n.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(f,n.GLCore.gl);var o=d[d.length-1],m=o.scenes;o.update&&o.update(f,b);if(m){b=0;for(o=m.length;b<o;++b){var c=m[b];c.paused||(c.update&&c.update(f,n.GLCore.gl),c.render())}}}}();c?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(z)):this.interval=setInterval(b,
20)}}function r(a,b,c){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var d=this;this.mEvents={};this.keyState=[];for(var f in e.keyboard)this.keyState[f]=!1;this.onMouseDown=function(){return function(a){d.mdown=!0;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseDown&&d.mEvents.mouseDown(d,d.mpos,d.keyState)}}();this.onMouseUp=function(){return function(a){d.mdown=!1;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseUp&&d.mEvents.mouseUp(d,
d.mpos,d.keyState)}}();this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-d.mpos[0];b[1]=a[1]-d.mpos[1];d.mpos=a;d.mEvents.mouseMove&&d.mEvents.mouseMove(d,d.mpos,b,d.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:-a.detail*100;d.mEvents.mouseWheel&&d.mEvents.mouseWheel(d,d.mpos,a,d.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,b=null;d.mEvents.keyPress?
(b=d.mEvents.keyPress(d,d.mpos,a,d.keyState),d.keyState[a]=b!==s?!!b:!0):d.keyState[a]=!0;d.keyState[a]&&d.mEvents.keyDown&&(b=d.mEvents.keyDown(d,d.mpos,a,d.keyState),d.keyState[a]=b!==s?!!b:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;d.mEvents.keyUp&&d.mEvents.keyUp(d,d.mpos,a,d.keyState);d.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,b,f){a.mdown&&a.orbitView(f)},mouseWheel:function(a,b,f){a.zoomView(f)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
c!==!1&&this.setEvents(c===s?this.eventDefaults:c);this.bind()}var s=n.undef,e=n.enums,g=n.GLCore;e.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};y.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.lock_state?this.system_milliseconds+=this.lock_rate*1E3|0:this.system_milliseconds=Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(a*1E3|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};q.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();this.renderStack.length>1&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=renderStack[renderStack.length-1],c,d=0,f=b.scenes.length;d<f;++d)if(b.scenes[d].scene.name===a){c=
b.scenes[d];break}return c},resumeScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){typeof a==="string"&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];typeof a==="string"&&(a=this.getScene(a));var c=b.scenes.indexOf(a);c>-1&&b.scenes.splice(c,1);return a},runOnce:function(){this.loopFunc()}};r.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents=
{};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=n.vec3,c=b.subtract(this.camera.target,this.camera.position),c=b.length(c);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-c*a[0]/300,0);this.camera.position[1]+=c*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),c))},panView:function(a,b){var c=n.vec3;b||(b=!1);var d=c.subtract(this.camera.target,this.camera.position),
d=c.length(d),f=this.camera.position;b?this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,-d*a[1]/300):(this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0),this.camera.position[1]+=d*a[1]/300);d=c.subtract(this.camera.position,f);this.camera.target=c.add(this.camera.target,d)},zoomView:function(a,b,c){var d=n.vec3,f=d.subtract(this.camera.target,this.camera.position),f=d.length(f);f-=a/1E3;b||(b=0.1);c||(c=1E3);f<
b&&(f=b);f>c&&(f=c);this.camera.position=d.add(this.camera.target,d.multiply(d.normalize(d.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(a,b){this.mEvents[a]=b===s?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:y,MainLoop:q,MouseViewController:r,setMainLoop:function(a){n.GLCore.mainloop=a},keyboard:e.keyboard}});
CubicVR.RegisterModule("Texture",function(n){function y(a,b){if(a===1||b===1)return!1;else{if(a!==1)for(;a%2===0;)a/=2;if(b!==1)for(;b%2===0;)b/=2;if(a>1)return!1;if(b>1)return!1}return!0}function z(a){var f=n.GLCore.gl;if(a.nodeName==="CANVAS"||a.nodeName==="IMG"||a.nodeName==="VIDEO")this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(a.width===void 0||a.height===void 0)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=
a.width;this.canvasSource.height=a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new n.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var h=this.canvasSource;(!h.height||!h.width)&&d("Warning - CanvasTexture input has no initial width and height, edges clamped.");!h.height||!h.width||!y(h.width,h.height)?(this.setFilter(b.texture.filter.LINEAR),
f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)):(this.setFilter(b.texture.filter.LINEAR_MIP),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT));a.nodeName==="IMG"&&this.update()}function q(a,f){if(!a)throw"PDF Texture Error: page is null.";var d=this,h=n.GLCore.gl,c=this.canvasSource=document.createElement("canvas"),g;c.mozOpaque=!0;c.width=f.width;c.height=
f.height;g=this.canvasContext=c.getContext("2d");g.save();g.fillStyle="rgb(255, 255, 255)";g.fillRect(0,0,c.width,c.height);g.restore();a.startRendering(g,function(){d.update()});this.texture=new n.Texture;this.updateFunction=f.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(c.width,c.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),h.texParameteri(h.TEXTURE_2D,
h.TEXTURE_WRAP_S,h.REPEAT),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function r(a,f,d){var h=n.GLCore.gl;this.texture=new n.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=f;this.canvas.height=d;this.pjs=new Processing(this.canvas,n.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=
this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE))}function s(f,d,h){var c=a.gl;this.width=d;this.height=h;this.srcTex=f;this.outTex=new n.RenderBuffer(d,
h);y(d,h);f=[1/d,1/h,0];this.outputBuffer=new n.RenderBuffer(d,h,!1);this.fsQuad=n.fsQuad.make(d,h);shaderNMap=new n.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",f);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(c.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)}function e(f,d,h){var c=a.gl;this.width=f;this.height=d;this.outTex=new n.RenderBuffer(f,d,h);this.texture=this.outTex.texture;var g=y(f,d);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(c.TEXTURE0);g?(this.setFilter(b.texture.filter.LINEAR),
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));this.dims=[f,d];this.depth=h?!0:!1}function g(a,b){this.scene=a;this.renderTex=new e(b?b.width:a.camera.width,b?b.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=n.GLCore,b=n.enums,c=n.undef,d=n.log;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var f=function(a,b){this.img_path=a;this.filter_type=b};f.prototype={getTexture:function(a,b){return new h(this.img_path,this.filter_type,a,b)}};var h=function(f,d,h,g,e){var v=
a.gl;this.tex_id=n.Textures.length;this.filterType=-1;this.onready=e;this.loaded=!1;n.Textures[this.tex_id]=v.createTexture();n.Textures_obj[this.tex_id]=this;if(f)typeof f==="string"?n.Images[this.tex_id]=new Image:typeof f==="object"&&f.nodeName==="IMG"&&(n.Images[this.tex_id]=f),n.Textures_ref[f]=this.tex_id;v.bindTexture(v.TEXTURE_2D,n.Textures[this.tex_id]);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.LINEAR);v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.LINEAR);if(f){var q=this.tex_id,
r=d!==c?d:a.default_filter,s=this;n.Images[this.tex_id].onload=function(){v.bindTexture(v.TEXTURE_2D,n.Textures[q]);v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!0);v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.NONE);var a=n.Images[q];v.texImage2D(v.TEXTURE_2D,0,v.RGBA,v.RGBA,v.UNSIGNED_BYTE,a);(a=y(a.width,a.height))?(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.REPEAT),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.REPEAT)):(v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,
v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE));if(n.Textures_obj[q].filterType===-1){if(a)r=b.texture.filter.LINEAR_MIP;else if(r===b.texture.filter.LINEAR_MIP)r=b.texture.filter.LINEAR;n.Textures_obj[q].filterType===-1&&n.Textures_obj[q].setFilter(r)}else n.Textures_obj[q].setFilter(n.Textures_obj[q].filterType);if(s.onready)s.onready();v.bindTexture(v.TEXTURE_2D,null);s.loaded=!0};if(h)n.Images[this.tex_id].deferredSrc=f,h.addImage(g,f,n.Images[this.tex_id]);else if(typeof f==="string")n.Images[this.tex_id].src=
f}this.active_unit=-1};h.prototype={setFilter:function(a){if(this.tex_id>-1){var f=n.GLCore.gl;f.bindTexture(f.TEXTURE_2D,n.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR)):a===b.texture.filter.LINEAR_MIP?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.generateMipmap(f.TEXTURE_2D)):a===
b.texture.filter.NEAREST?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D));this.filterType=a}},use:function(b){if(this.tex_id>-1)a.gl.activeTexture(b),a.gl.bindTexture(a.gl.TEXTURE_2D,n.Textures[this.tex_id]),this.active_unit=
b},clear:function(){if(this.tex_id>-1&&this.active_unit!==-1)a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1},destroy:function(){var a=n.GLCore.gl;if(this.tex_id>-1&&n.Textures[this.tex_id])a.deleteTexture(n.Textures[this.tex_id]),delete n.Textures_obj[this.tex_id],this.tex_id=-1}};z.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=n.GLCore.gl;a.bindTexture(a.TEXTURE_2D,n.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=n.GLCore.gl;a.bindTexture(a.TEXTURE_2D,n.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){var a=n.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,n.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var b=
a.gl,f=b.getParameter(b.VIEWPORT);this.outputBuffer.use();b.viewport(0,0,this.width,this.height);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.srcTex.use(b.TEXTURE0);n.fsQuad.render(this.shaderNorm,this.fsQuad);b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(f[0],f[1],f[2],f[3])}};e.prototype={begin:function(){var b=a.gl;this.dims=b.getParameter(b.VIEWPORT);this.outTex.use();b.viewport(0,0,this.width,this.height);this.depth?b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT)},
end:function(){var b=a.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:h,DeferredLoadTexture:f,CanvasTexture:z,PdfTexture:q,TextTexture:function(a,b){var f=b&&b.color||"#fff",d=b&&b.bgcolor,h=b&&b.font||"18pt Arial",g=b&&b.align||"start",e=b&&b.y||0,q=b&&b.width||c,n=b&&b.height||c,r,u=document.createElement("CANVAS"),
s=u.getContext("2d"),E=0,E=typeof a==="string"?1:a.length;s.font=h;var D=b&&b.lineHeight||s.measureText("OO").width,y;if(E===1)y=s.measureText(a).width;else for(r=y=0;r<E;++r){var I=s.measureText(a[r]).width;I>y&&(y=I)}u.width=q||y;u.height=n||D*E;if(d)s.fillStyle=d,s.fillRect(0,0,u.width,u.height);s.fillStyle=f;s.font=h;s.textAlign=g;s.textBaseline="top";if(E===1)f=b&&b.x||g==="center"?u.width/2:g==="right"?u.width:0,s.fillText(a,f,e);else for(r=0;r<E;++r)f=b&&b.x||g==="center"?u.width/2:g==="right"?
u.width:0,s.fillText(a[r],f,e+r*D);s.fill();this.use=z.prototype.use;this.clear=z.prototype.clear;this.update=z.prototype.update;z.apply(this,[u]);this.update();this.canvasSource=null},PJSTexture:r,NormalMapGen:s,RenderTexture:e,SceneRenderTexture:g}});
CubicVR.RegisterModule("Material",function(n){function y(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=n.get(a)||{},a.shader||null);s===null&&(s=new n.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
s._init_shader(s._vertex,s._fragment,!1));if(this.customShader&&!this.customShader._init_shader&&typeof this.customShader==="object")this.customShader=new n.CustomShader(this.customShader);this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==z?a.visible:!0;this.friction=a.friction!==z?a.friction:0.3;this.collision=a.visible!==z?a.collision:!0;this.opacity=a.opacity===z?1:
a.opacity;this.shininess=a.shininess===z?1:a.shininess;this.max_smooth=a.max_smooth===z?60:a.max_smooth;this.env_amount=a.env_amount===z?0.75:a.env_amount;this.morph=a.morph===z?!1:a.morph;this.color_map=a.colorMap===z?!1:a.colorMap;this.uvOffset=a.uvOffset===z?[0,0]:a.uvOffset;this.noFog=a.noFog===z?!1:a.noFog;if(a.textures)for(var c in a.textures)this.setTexture(a.textures[c],c)}var z=n.undef,q=n.GLCore,r=n.enums,s=null,e=[r.texture.map.REFLECT,r.texture.map.SPECULAR,r.texture.map.NORMAL,r.texture.map.BUMP],
g=[],a=["textureColor","textureEnvSphere","textureNormal","textureBump","textureReflect","textureSpecular","textureAmbient","textureAlpha","matrixModelView","matrixProjection","matrixObject","matrixNormal","vertexPosition","vertexNormal","vertexColor","vertexTexCoord","materialTexOffset","vertexMorphPosition","vertexMorphNormal","materialMorphWeight","lightDiffuse","lightSpecular","lightIntensity","lightDistance","lightPosition","lightDirection","lightCutOffAngle","lightShadowMap","lightProjectionMap",
"lightDepthClip","lightShadowMatrix","lightAmbient","materialDiffuse","materialColor","materialAmbient","materialSpecular","materialShininess","materialEnvironment","materialAlpha","postDepthInfo"];y.prototype={clone:function(){var a=new n.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,
collision:this.collision,name:this.name}),c;for(c in this.textures)this.textures.hasOwnProperty(c)&&a.setTexture(this.textures[c],c);return a},setVisibility:function(a){this.visible=a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,c){if(a&&(c=n.parseEnum(r.texture.map,c)||0,n.features.texturePerPixel||
e.indexOf(c)===-1))!a.use&&typeof a==="string"&&(a=n.Textures_ref[a]!==z?n.Textures_obj[n.Textures_ref[a]]:new n.Texture(a)),this.textures[c]=a},calcShaderMask:function(){var a=0;a+=typeof this.textures[r.texture.map.COLOR]==="object"?r.shader.map.COLOR:0;a+=typeof this.textures[r.texture.map.SPECULAR]==="object"?r.shader.map.SPECULAR:0;a+=typeof this.textures[r.texture.map.NORMAL]==="object"?r.shader.map.NORMAL:0;a+=typeof this.textures[r.texture.map.BUMP]==="object"?r.shader.map.BUMP:0;a+=typeof this.textures[r.texture.map.REFLECT]===
"object"?r.shader.map.REFLECT:0;a+=typeof this.textures[r.texture.map.ENVSPHERE]==="object"?r.shader.map.ENVSPHERE:0;a+=typeof this.textures[r.texture.map.AMBIENT]==="object"?r.shader.map.AMBIENT:0;a+=typeof this.textures[r.texture.map.ALPHA]==="object"?r.shader.map.ALPHA:0;a+=this.opacity!==1?r.shader.map.ALPHA:0;a+=this.color_map?r.shader.map.COLORMAP:0;if(this.opacity!==1)this.blendEnabled=!0;return a},getShaderHeader:function(a,c){return(c!==z?"#define LIGHT_COUNT "+c+"\n":"")+"#define TEXTURE_COLOR "+
(typeof this.textures[r.texture.map.COLOR]==="object"?1:0)+"\n#define TEXTURE_SPECULAR "+(typeof this.textures[r.texture.map.SPECULAR]==="object"?1:0)+"\n#define TEXTURE_NORMAL "+(typeof this.textures[r.texture.map.NORMAL]==="object"?1:0)+"\n#define TEXTURE_BUMP "+(typeof this.textures[r.texture.map.BUMP]==="object"?1:0)+"\n#define TEXTURE_REFLECT "+(typeof this.textures[r.texture.map.REFLECT]==="object"?1:0)+"\n#define TEXTURE_ENVSPHERE "+(typeof this.textures[r.texture.map.ENVSPHERE]==="object"?
1:0)+"\n#define TEXTURE_AMBIENT "+(typeof this.textures[r.texture.map.AMBIENT]==="object"?1:0)+"\n#define TEXTURE_ALPHA "+(typeof this.textures[r.texture.map.ALPHA]==="object"?1:0)+"\n#define MATERIAL_ALPHA "+(this.opacity!==1?1:0)+"\n#define LIGHT_IS_POINT "+(a===r.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===r.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===r.light.type.SPOT||a===r.light.type.SPOT_SHADOW||a===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+
(a===r.light.type.SPOT_SHADOW||a===r.light.type.SPOT_SHADOW_PROJECTOR||a===r.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===r.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(q.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===r.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===r.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(q.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+
(q.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(q.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(q.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(n.features.lightPerPixel?1:0)+"\n\n"},bindObject:function(a,c){var d=q.gl,f=c.vertexPosition,h=c.vertexTexCoord,o=c.vertexNormal,m=c.vertexColor;d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_points);d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(f);h!==null&&a.compiled.gl_uvs!==null&&h!==-1&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_uvs),
d.vertexAttribPointer(h,2,d.FLOAT,!1,0,0),d.enableVertexAttribArray(h));g.uv=h;o!==null&&a.compiled.gl_normals!==null&&o!==-1&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_normals),d.vertexAttribPointer(o,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(o));g.un=o;m!==null&&a.compiled.gl_colors!==null&&m!==-1&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_colors),d.vertexAttribPointer(m,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(m));g.uc=m;if(a.morphTarget)f=c.vertexMorphPosition,o=c.vertexMorphNormal,d.bindBuffer(d.ARRAY_BUFFER,
a.morphTarget.gl_points),d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(f),o!==null&&a.morphTarget.gl_normals!==null&&o!==-1&&(d.bindBuffer(d.ARRAY_BUFFER,a.morphTarget.gl_normals),d.vertexAttribPointer(o,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(o)),d.uniform1f(c.materialMorphWeight,a.morphWeight);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,c){var d=q.gl;g.uv!==z&&g.uv!==-1&&d.disableVertexAttribArray(g.uv);g.un!==z&&g.un!==-1&&d.disableVertexAttribArray(g.un);
g.uc!==z&&g.uc!==-1&&d.disableVertexAttribArray(g.uc);if(a.morphTarget&&c)up=c.vertexMorphPosition,d.disableVertexAttribArray(up),un=c.vertexMorphNormal,un!==null&&a.compiled.gl_normals!==null&&un!==-1&&d.disableVertexAttribArray(un)},use:function(b,c){var d,f=q.gl,h=this.textures,o=!0,c=c||0,b=b||0;this.shader[b]||(this.shader[b]=[]);var m=this.shader[b][c];d=this.customShader&&b===r.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();if(m&&this.opacity!==1&&this.blendEnabled!==!0)this.dirtyFlag=
!0;if(this.dirtyFlag===!0)m=null,this.dirtyFlag=!1;if(m)o=m!==s,m.use(),this.customShader&&!d&&this.customShader._doUpdate({material:this});else{var g=this.calcShaderMask(b);if(!this.customShader||d)n.ShaderPool[b][g]||(n.ShaderPool[b][g]=[]),m=n.ShaderPool[b][g][c];if(!m){var e=this.getShaderHeader(b,c),t=e+q.CoreShader_vs;e+=q.CoreShader_fs;this.customShader&&!d?this.customShader._initialized||(this.customShader._init_shader(t,e,a),m=this.customShader.getShader(),m.isCompiled()||(o=!1,m=s.getShader())):
(m=new n.Shader(t,e),m.isCompiled()||(o=!1,m=s.getShader()),n.ShaderPool[b][g][c]=m);d=0;if(b!==r.light.type.DEPTH_PACK){if(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)d+=c,b===r.light.type.SPOT_SHADOW_PROJECTOR&&(d+=c);typeof h[r.texture.map.COLOR]==="object"&&m.addInt("textureColor",d++);typeof h[r.texture.map.ENVSPHERE]==="object"&&m.addInt("textureEnvSphere",d++);typeof h[r.texture.map.NORMAL]==="object"&&m.addInt("textureNormal",d++);typeof h[r.texture.map.BUMP]===
"object"&&m.addInt("textureBump",d++);typeof h[r.texture.map.REFLECT]==="object"&&m.addInt("textureReflect",d++);typeof h[r.texture.map.SPECULAR]==="object"&&m.addInt("textureSpecular",d++);typeof h[r.texture.map.AMBIENT]==="object"&&m.addInt("textureAmbient",d++)}typeof h[r.texture.map.ALPHA]==="object"&&m.addInt("textureAlpha",d++);m.addMatrix("matrixModelView");m.addMatrix("matrixProjection");m.addMatrix("matrixObject");m.addMatrix("matrixNormal");m.addVertexArray("vertexPosition");m.addVertexArray("vertexNormal");
this.color_map&&m.addVertexArray("vertexColor");this.morph&&(m.addVertexArray("vertexMorphPosition"),m.addVertexArray("vertexMorphNormal"),m.addFloat("materialMorphWeight",0));for(d=0;d<c;d++)if(m.addVector("lightDiffuse["+d+"]"),m.addVector("lightSpecular["+d+"]"),m.addFloat("lightIntensity["+d+"]"),m.addFloat("lightDistance["+d+"]"),m.addVector("lightPosition["+d+"]"),m.addVector("lightDirection["+d+"]"),(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.SPOT)&&
m.addFloat("lightCutOffAngle["+d+"]"),b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)m.addInt("lightShadowMap["+d+"]"),b===r.light.type.SPOT_SHADOW_PROJECTOR&&m.addInt("lightProjectionMap["+d+"]"),m.addVector("lightDepthClip["+d+"]"),m.addMatrix("lightShadowMatrix["+d+"]");b!==r.light.type.DEPTH_PACK&&(m.addVector("lightAmbient"),m.addVector("materialDiffuse"),m.addVector("materialColor"),m.addVector("materialAmbient"),m.addVector("materialSpecular"),m.addFloat("materialShininess"),
m.addFloat("materialEnvironment"));m.addFloat("materialAlpha");(q.depth_alpha||b===r.light.type.DEPTH_PACK||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)&&m.addVector("postDepthInfo");m.addUVArray("vertexTexCoord");m.addVector("materialTexOffset");q.fog_enabled&&!this.noFog&&(m.addVector("fogColor",q.fogColor),m.addFloat("fogDensity",q.fogDensity),m.addFloat("fogNear",q.fogNear),m.addFloat("fogFar",q.fogFar))}this.shader[b][c]=m;m.use();m.materialTexOffset!=
-1&&f.uniform2fv(m.materialTexOffset,[0,0]);this.customShader&&this.customShader._doUpdate({material:this})}d=0;var v;if(b!==r.light.type.DEPTH_PACK){if(b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)d+=c,b===r.light.type.SPOT_SHADOW_PROJECTOR&&(d+=c);if(v=h[r.texture.map.COLOR])v.use(q.gl.TEXTURE0+d),d++;if(v=h[r.texture.map.ENVSPHERE])v.use(q.gl.TEXTURE0+d),d++,f.uniform1f(m.materialEnvironment,this.env_amount);if(v=h[r.texture.map.NORMAL])v.use(q.gl.TEXTURE0+
d),d++;if(v=h[r.texture.map.BUMP])v.use(q.gl.TEXTURE0+d),d++;if(v=h[r.texture.map.REFLECT])v.use(q.gl.TEXTURE0+d),d++;if(v=h[r.texture.map.SPECULAR])v.use(q.gl.TEXTURE0+d),d++;if(v=h[r.texture.map.AMBIENT])v.use(q.gl.TEXTURE0+d),d++}(v=h[r.texture.map.ALPHA])&&v.use(q.gl.TEXTURE0+d);q.fog_enabled&&!this.noFog&&(f.uniform3fv(m.fogColor,q.fogColor),f.uniform1f(m.fogDensity,q.fogDensity),f.uniform1f(m.fogNear,q.fogNear),f.uniform1f(m.fogFar,q.fogFar));b!==r.light.type.DEPTH_PACK?(f.uniform3fv(m.materialColor,
this.color),f.uniform3fv(m.materialDiffuse,this.diffuse),f.uniform3fv(m.materialAmbient,this.ambient),f.uniform3fv(m.materialSpecular,this.specular),f.uniform1f(m.materialShininess,this.shininess*128),f.uniform3fv(m.lightAmbient,n.globalAmbient),this.opacity!==1&&f.uniform1f(m.materialAlpha,this.opacity),(q.depth_alpha||b===r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR||b===r.light.type.AREA)&&f.uniform3fv(m.postDepthInfo,[q.depth_alpha_near,q.depth_alpha_far,0])):f.uniform3fv(m.postDepthInfo,
[q.shadow_near,q.shadow_far,0]);m.materialTexOffset&&f.uniform2fv(m.materialTexOffset,this.uvOffset);return o}};return{Material:y}});
CubicVR.RegisterModule("Mesh",function(n){function y(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function z(e){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;e=n.get(e)||
{};if(e instanceof n.Mesh)this.booleanAdd(e),e._clones=e._clones||1,e._clones++,this.name=e.name?e.name+"_copy"+e._clones:null;else{this.name=e.name||null;this.dynamic=e.dynamic||!1;if(e.material){var g=e.material;g.length?this.materials=g:typeof g==="object"&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new n.Material(g)))}e.points&&this.build(e);e.part?this.build(e.part):e.parts&&this.build(e.parts);if((this.primitives=e.primitives||e.primitive||null)&&!this.primitives.length||typeof this.primitives===
"string")this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var b=this.primitives[g];typeof b==="string"&&(b=n.get(b));var c=n.primitives[b.type];if(b.type&&c)this.booleanAdd(c(b));else if(b.type){s("Mesh error, primitive "+b.type+" is unknown.");var b="",d;for(d in n.primitives)n.primitives.hasOwnProperty(d)&&(b!==""&&(b+=", "),b+=d);s("Available primitive types are: "+b)}else s("Mesh error, primitive "+(g+1)+" lacks type.")}this.buildWireframe=
e.buildWireframe||e.wireframe||!!e.wireframeMaterial||e.triangulateWireframe||!1;this.triangulateWireframe=e.triangulateWireframe||null;this.wireframeMaterial=n.get(e.wireframeMaterial,n.Material)||null;this.wireframe=e.wireframe||!1;e.flipFaces&&this.faces.length&&this.flipFaces();(e.prepare||e.compile&&this.faces.length)&&this.prepare();(e.clean||e.compile&&this.faces.length&&!this.dynamic)&&this.clean();e.calcNormals&&!e.compile&&!e.prepare&&this.calcNormals()}}var q=n.undef,r=n.GLCore,s=n.log;
y.prototype={setUV:function(e,g){g!==q?this.uvs[g]=e:e.length!==2?this.uvs=e:this.uvs.push(e)},setColor:function(e,g){g!==q?this.point_colors[g]=e:typeof e[0]!=="number"?this.point_colors=e:this.point_colors.push(e)},flip:function(){for(var e=0,g=this.point_normals.length;e<g;e++)this.point_normals[e]=[-this.point_normals[e][0],-this.point_normals[e][1],-this.point_normals[e][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
z.prototype={setWireframe:function(e){this.wireframe=e},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(e){this.wireframeMaterial=e},build:function(e,g){var a,b;typeof e==="string"&&(e=n.get(e));e&&!e.length&&(e=[e]);var c=this.faces.length;g&&g.length&&this.points.concat(g);for(var d=0,f=e.length;d<f;d++){var h=e[d];a=h.material;b=h.points;var o=h.faces,m=h.uv,B=h.color,h=h.segment||null;h!==null&&this.setSegment(parseInt(h,10));if(b&&b.length&&(this.points=this.points.concat(b),
o&&c)){o=o.slice(0);b=0;for(h=o.length;b<h;b++)for(var x=o[b],t=0,v=o.length;t<v;t++)x[t]+=c}if(a)a.length?this.materials=a:typeof a==="object"&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new n.Material(a)));o&&o.length&&this.addFace(o);if(o&&m&&typeof m==="object"){h=null;if(m.length&&m.length===o.length)if(m.length===o.length){a=0;for(b=m.length;a<b;a++)this.faces[a+c].setUV(m[a])}else s("Mesh error in part, face count: "+o.length+", uv count:"+m.length);else h=m.apply?m:new n.UVMapper(m);
h&&h.apply(this,this.currentMaterial,this.currentSegment,c,this.faces.length-c)}if(o&&B&&typeof B==="object")if(B.length&&B.length===o.length){a=0;for(b=B.length;a<b;a++)this.faces[a+c].setColor(B[a]);this.materials[this.currentMaterial].colorMap=!0}else s("Mesh error in part, face count: "+o.length+", color count:"+B.length)}return this},showAllSegments:function(){for(var e in this.segment_state)this.segment_state.hasOwnProperty(e)&&(this.segment_state[e]=!0)},hideAllSegments:function(){for(var e in this.segment_state)this.segment_state.hasOwnProperty(e)&&
(this.segment_state[e]=!1)},setSegment:function(e,g){g!==q?this.segment_state[e]=g:this.currentSegment=e},addPoint:function(e){if(e.length!==3||typeof e[0]==="object")for(var g=0,a=e.length;g<a;g++)this.points.push(e[g]);else this.points.push(e);return this.points.length-1},getMaterialIndex:function(e){return this.materials.indexOf(e)},setFaceMaterial:function(e,g){var a;typeof e=="number"?a=e:(a=this.materials.indexOf(e),a===-1&&(this.materials.push(e),a=this.materials.length-1));if(g!==q){if(this.faces[g]!==
q)this.faces[g].material=a}else this.currentMaterial=a;return this},addFace:function(e,g,a,b){if(typeof e[0]!=="number"){g=0;for(a=e.length;g<a;g++)this.addFace(e[g])}else{g===q?(this.currentFace=this.faces.length,this.faces.push(new y)):(this.faces[g]===q&&(this.faces[g]=new y),this.currentFace=g);if(typeof e==="object")this.faces[this.currentFace].points=e;a!==q?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial;this.faces[this.currentFace].segment=
b!==q?b:this.currentSegment;return this.currentFace}},flipFaces:function(){for(var e=0,g=this.faces.length;e<g;e++)this.faces[e].flip()},triangulateQuads:function(){for(var e=0,g=this.faces.length;e<g;e++)if(this.faces[e].points.length===4){var a=this.faces.length;this.addFace([this.faces[e].points[2],this.faces[e].points[3],this.faces[e].points[0]],this.faces.length,this.faces[e].material,this.faces[e].segment);this.faces[e].points.pop();this.faces[a].normal=this.faces[e].normal.slice(0);this.faces[e].point_colors.length===
4&&(this.faces[a].setColor(this.faces[e].point_colors[2],0),this.faces[a].setColor(this.faces[e].point_colors[3],1),this.faces[a].setColor(this.faces[e].point_colors[0],2),this.faces[e].point_colors.pop());this.faces[e].uvs.length===4&&(this.faces[a].setUV(this.faces[e].uvs[2],0),this.faces[a].setUV(this.faces[e].uvs[3],1),this.faces[a].setUV(this.faces[e].uvs[0],2),this.faces[e].uvs.pop());this.faces[e].point_normals.length===4&&(this.faces[a].point_normals[0]=this.faces[e].point_normals[2],this.faces[a].point_normals[1]=
this.faces[e].point_normals[3],this.faces[a].point_normals[2]=this.faces[e].point_normals[0],this.faces[e].point_normals.pop())}return this},booleanAdd:function(e,g){var a=n.mat4,b=this.points.length,c,d,f,h;c=g;g=c===q?q:typeof c==="array"?c:typeof c==="object"?c.getResult?c.getResult():c.position||c.rotation||c.scale?n.mat4.transform(c.position,c.rotation,c.scale):q:void 0;if(e.wireframeMaterial)this.wireframeMaterial=e.wireframeMaterial;if(g!==q){d=g;c=0;for(f=e.points.length;c<f;c++)this.addPoint(a.vec3_multiply(e.points[c],
d))}else{c=0;for(f=e.points.length;c<f;c++)this.addPoint([e.points[c][0],e.points[c][1],e.points[c][2]])}a=[];c=0;for(f=e.materials.length;c<f;c++)d=this.materials.indexOf(e.materials[c]),d===-1?(this.materials.push(e.materials[c]),a[c]=this.materials.length-1):a[c]=d;c=0;for(f=e.faces.length;c<f;c++){var o=[];d=0;for(h=e.faces[c].points.length;d<h;d++)o.push(e.faces[c].points[d]+b);o=this.faces[this.addFace(o)];o.segment=e.faces[c].segment;o.material=a[e.faces[c].material];if(o.material===q)o.material=
0;d=0;for(h=e.faces[c].uvs.length;d<h;d++)o.uvs[d]=[e.faces[c].uvs[d][0],e.faces[c].uvs[d][1]];d=0;for(h=e.faces[c].point_normals.length;d<h;d++)o.point_normals[d]=[e.faces[c].point_normals[d][0],e.faces[c].point_normals[d][1],e.faces[c].point_normals[d][2]]}return this},calcFaceNormals:function(e,g){var a=n.vec3,b=n.triangle,c=0,d=this.faces.length,f,h=this.points,o;e&&(c=e);for(g&&(d=g+1);c<d;c++)f=this.faces[c],o=f.points,o.length<3?f.normal=[0,0,0]:a.normalize(b.normal(h[o[0]],h[o[1]],h[o[2]],
f.normal));return this},getMaterial:function(e){if(!isNaN(parseInt(e,10)))return this.materials[g];for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===e)return this.materials[g];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(e){this.instanceMaterials=e},calcNormals:function(e){var g=n.vec3,a=!1,b;this.dynamic&&(b=[],e=e||{});e!==q&&(b=[],a=!0);this.calcFaceNormals();var c,d,f,h,o=Array(this.points.length);c=0;for(h=o.length;c<h;c++)o[c]=
[];h=this.faces.length;for(c=0;c<h;c++){f=this.faces[c].points.length;for(d=0;d<f;d++)o[this.faces[c].points[d]].push([c,d])}c=0;for(h=this.points.length;c<h;c++){var m=o[c].length;for(d=0;d<m;d++){var B=1,x=o[c][d][0],t=o[c][d][1],v=this.materials.length?this.materials[this.faces[x].material].max_smooth:60,C=this.faces[x];a&&(b[x]===q&&(b[x]=[]),b[x][t]===q&&(b[x][t]=[]));var r=Array(3);r[0]=C.normal[0];r[1]=C.normal[1];r[2]=C.normal[2];if(v!==0)for(f=0;f<m;f++)if(d!==f){var s=o[c][f][0],w=this.faces[s],
u=g.angle(w.normal,C.normal);if(u!==u||u*(180/Math.PI)<=v)a&&b[x][t].push(s),r[0]+=w.normal[0],r[1]+=w.normal[1],r[2]+=w.normal[2],B++}r[0]/=B;r[1]/=B;r[2]/=B;this.faces[x].point_normals[t]=g.normalize(r)}}if(a){c=g=0;for(h=b.length;c<h;c++){d=0;for(f=b[c].length;d<f;d++)g+=b[c][d].length}if(!e.faceCount)e.faceCount=new Uint8Array(this.faces.length*3);if(!e.faceNorm)e.faceNorm=new Uint16Array(g);if(!e.faceNormIdx)e.faceNormIdx=new Uint16Array(this.faces.length);c=g=0;for(h=this.faces.length;c<h;c++)for(d=
0;d<3;d++)if(a=b[c][d],e.faceCount[c*3+d]=a?a.length:0,e.faceNormIdx[c]=g,a){f=0;for(a=a.length;f<a;f++)e.faceNorm[g++]=b[c][d][f]}else g++;this.normalMapRef=e}return this},recalcNormals:function(e,g){var a,b,c,d,f,h,o,m,B,x;if(e=e||this.normalMapRef){a=g.segments!==q?!0:!1;b=g.segments;this.calcFaceNormals();var t=0,v=0,n=0,r;if(a)for(var v=this.dynamicData.VBO.dynamicMap,s=e.faceNormIdx,w=0,u=b.length;w<u;w++)for(var z=v.segmentMap[b[w]],E=0,D=z.length;E<D;E++){a=z[E];B=this.faces[a];r=B.normal;
t=s[a];for(j=0;j<3;j++){m=B.point_normals[j];f=r[0];h=r[1];o=r[2];x=e.faceCount[a*3+j];c=0;for(iMax=x;c<iMax;c++)d=e.faceNorm[t+c],d=this.faces[d],d=d.normal,f+=d[0],h+=d[1],o+=d[2];x?(c=x+1,f/=c,h/=c,o/=c,c=Math.sqrt(f*f+h*h+o*o),f/=c,h/=c,o/=c,m[0]=f,m[1]=h,m[2]=o):n++}}else{a=0;for(b=this.faces.length;a<b;a++){B=this.faces[a];r=B.normal;for(j=0;j<3;j++){m=B.point_normals[j];f=r[0];h=r[1];o=r[2];x=e.faceCount[v++];c=0;for(iMax=x;c<iMax;c++)d=e.faceNorm[t++],d=this.faces[d],d=d.normal,f+=d[0],h+=
d[1],o+=d[2];x?(c=x+1,f/=c,h/=c,o/=c,c=Math.sqrt(f*f+h*h+o*o),f/=c,h/=c,o/=c,m[0]=f,m[1]=h,m[2]=o):n++}}}return this}},removeDoubles:function(e){var g=[],a=[],b,c,d,f;b=0;for(c=this.points.length;b<c;b++){var h=-1,o=this.points[b];d=0;for(f=g.length;d<f;d++)if(n.vec3.equal(o,g[d],e)){h=d;break}h!=-1?a[b]=h:(a[b]=g.length,g.push(this.points[b]))}this.points=g;b=0;for(c=this.faces.length;b<c;b++){e=this.faces[b];d=0;for(f=e.points.length;d<f;d++)e.points[d]=a[e.points[d]]}return this},buildEdges:function(){var e,
g,a,b,c=[],d=[];e=0;for(a=this.faces.length;e<a;e++){var f=this.faces[e];g=0;for(b=f.points.length;g<b;g++){var h,o,m;m=f.segment;matId=f.material;g?(o=f.points[g],h=f.points[g-1]):(o=f.points[g],h=f.points[b-1]);c[h]=c[h]||{};c[h][matId]=c[h][matId]||{};c[h][matId][m]=c[h][matId][m]||{};!c[h][matId][m][o]&&(!c[o]||!c[o][matId][m][h])&&d.push([matId,m,h,o])}}this.edges=d;return this},subdivide:function(e,g){var a=n.vec3,g=g===q?!0:g;e===q&&(e=1);if(e!==0){var b,c,d,f,h,o={},m=[],B=[],x=this.points.length,
t=this.faces.length,v=[],C=[],r=[],z=[];b=0;for(d=t;b<d;b++)if(h=this.faces[b],h.points&&(h.points.length===3||h.points.length===4)){var w=[0,0,0];c=0;for(f=h.points.length;c<f;c++){var u=this.points[h.points[c]];w[0]+=u[0];w[1]+=u[1];w[2]+=u[2]}w[0]/=f;w[1]/=f;w[2]/=f;v[b]=this.addPoint(w);if(h.uvs.length===h.points.length){w=[0,0];c=0;for(f=h.uvs.length;c<f;c++)u=h.uvs[c],w[0]+=u[0],w[1]+=u[1];w[0]/=f;w[1]/=f;C[b]=w}if(h.point_colors.length===h.points.length){w=[0,0,0];c=0;for(f=h.point_colors.length;c<
f;c++)u=h.point_colors[c],w[0]+=u[0],w[1]+=u[1],w[2]+=u[2];w[0]/=f;w[1]/=f;w[2]/=f;r[b]=w}if(h.point_normals.length===h.points.length){w=[0,0,0];c=0;for(f=h.point_normals.length;c<f;c++)u=h.point_normals[c],w[0]+=u[0],w[1]+=u[1],w[2]+=u[2];w[0]/=f;w[1]/=f;w[2]/=f;z[b]=w}}b=0;for(d=this.faces.length;b<d;b++){h=this.faces[b];c=0;for(f=h.points.length;c<f;c++){var F,E;c?(F=c,E=c-1):(F=c,E=f-1);u=h.points[F];w=h.points[E];o[w]=o[w]||{};m[w]=m[w]||[];m[w].push(b);o[w][u]={face:b,a:w,b:u,fpa:F,fpb:E}}}for(b in o)if(o.hasOwnProperty(b))for(c in o[b])if(o[b].hasOwnProperty(c)){d=
o[b][c];h=o[c][b];if(h===q){s("Mesh.subdivide error. Hole at face #"+d.face+", Edge:["+d.fpa+"->"+d.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}if(!d.edge_point)f=a.multiply(a.add(this.points[d.a],this.points[d.b]),0.5),g?(w=a.multiply(a.add(this.points[v[d.face]],this.points[v[h.face]]),0.5),d.edge_point=a.multiply(a.add(f,w),0.5)):d.edge_point=f,h.edge_point=d.edge_point,d.edge_avg=f,h.edge_avg=f,d.ep_idx=this.addPoint(d.edge_point),h.ep_idx=d.ep_idx;B[d.a]=B[d.a]||
[];B[d.a].push(d.edge_avg);f=this.faces[d.face].uvs;if(f.length)h=f[d.fpa],f=f[d.fpb],d.uv=[(h[0]+f[0])/2,(h[1]+f[1])/2];h=this.faces[d.face].point_colors;if(h.length)d.color=a.multiply(a.add(h[d.fpa],h[d.fpb]),0.5);h=this.faces[d.face].point_normals;if(h.length)d.normal=a.normalize(a.multiply(a.add(h[d.fpa],h[d.fpb]),0.5))}if(g){h=[];b=0;for(d=x;b<d;b++)if(w=[0,0,0],m[b]){c=0;for(f=m[b].length;c<f;c++)u=this.points[v[m[b][c]]],w[0]+=u[0],w[1]+=u[1],w[2]+=u[2];w[0]/=f;w[1]/=f;w[2]/=f;h[b]=w}w=[];
b=0;for(d=x;b<d;b++)if(u=[0,0,0],B[b]){c=0;for(f=B[b].length;c<f;c++)F=B[b][c],u[0]+=F[0],u[1]+=F[1],u[2]+=F[2];u[0]/=f;u[1]/=f;u[2]/=f;w[b]=u}b=0;for(d=x;b<d;b++)if(m[b])x=m[b].length,c=1/x,B=2/x,x=a.multiply(this.points[b],(x-3)/x),x=a.add(x,a.multiply(h[b],c)),x=a.add(x,a.multiply(w[b],B)),this.points[b]=x}for(b=0;b<t;b++)if(h=this.faces[b],!(h.points.length!==3&&h.points.length!==4))if(a=h.points.slice(0),m=h.uvs.slice(0),c=h.point_colors.slice(0),B=h.point_normals.slice(0),x=m.length===a.length,
d=c.length===a.length,f=B.length===a.length,h=h.material,a.length===3){this.setFaceMaterial(h);w=o[a[0]][a[1]];u=o[a[2]][a[0]];this.addFace([a[0],w.ep_idx,v[b],u.ep_idx],b);if(x)this.faces[b].uvs=[m[0],w.uv,C[b],u.uv];if(d)this.faces[b].point_colors=[c[0],w.color,r[b],u.color];if(f)this.faces[b].point_normals=[B[0],w.normal,z[b],u.normal];w=o[a[1]][a[2]];u=o[a[0]][a[1]];h=this.addFace([a[1],w.ep_idx,v[b],u.ep_idx]);if(x)this.faces[h].uvs=[m[1],w.uv,C[b],u.uv];if(d)this.faces[h].point_colors=[c[1],
w.color,r[b],u.color];if(f)this.faces[h].point_normals=[B[1],w.normal,z[b],u.normal];w=o[a[2]][a[0]];u=o[a[1]][a[2]];h=this.addFace([a[2],w.ep_idx,v[b],u.ep_idx]);if(x)this.faces[h].uvs=[m[2],w.uv,C[b],u.uv];if(d)this.faces[h].point_colors=[c[2],w.color,r[b],u.color];if(f)this.faces[h].point_normals=[B[2],w.normal,z[b],u.normal]}else{this.setFaceMaterial(h);w=o[a[0]][a[1]];u=o[a[3]][a[0]];this.addFace([a[0],w.ep_idx,v[b],u.ep_idx],b);if(x)this.faces[b].uvs=[m[0],w.uv,C[b],u.uv];if(d)this.faces[b].point_colors=
[c[0],w.color,r[b],u.color];if(f)this.faces[b].point_normals=[B[0],w.normal,z[b],u.normal];w=o[a[1]][a[2]];u=o[a[0]][a[1]];h=this.addFace([a[1],w.ep_idx,v[b],u.ep_idx]);if(x)this.faces[h].uvs=[m[1],w.uv,C[b],u.uv];if(d)this.faces[h].point_colors=[c[1],w.color,r[b],u.color];if(f)this.faces[h].point_normals=[B[1],w.normal,z[b],u.normal];w=o[a[2]][a[3]];u=o[a[1]][a[2]];h=this.addFace([a[2],w.ep_idx,v[b],u.ep_idx]);if(x)this.faces[h].uvs=[m[2],w.uv,C[b],u.uv];if(d)this.faces[h].point_colors=[c[2],w.color,
r[b],u.color];if(f)this.faces[h].point_normals=[B[2],w.normal,z[b],u.normal];w=o[a[3]][a[0]];u=o[a[2]][a[3]];h=this.addFace([a[3],w.ep_idx,v[b],u.ep_idx]);if(x)this.faces[h].uvs=[m[3],w.uv,C[b],u.uv];if(d)this.faces[h].point_colors=[c[3],w.color,r[b],u.color];if(f)this.faces[h].point_normals=[B[3],w.normal,z[b],u.normal]}e--;if(e!==0)this.subdivide(e,g);else return this}},removeInternals:function(){var e,g,a,b,c,d={},f=this.faces.length,h,o,m,B;e=0;for(a=this.faces.length;e<a;e++){c=this.faces[e];
g=0;for(b=c.points.length;g<b;g++)g?(m=g,B=g-1):(m=g,B=b-1),h=c.points[m],o=c.points[B],d[h]=d[h]||{},d[h][o]===q?d[h][o]=[e]:d[h][o].push(e)}a=function(a){return d[o][h].indexOf(a)!==-1};for(e=0;e<f;e++){c=this.faces[e];var x=null;g=0;for(b=c.points.length;g<b;g++)g?(m=g,B=g-1):(m=g,B=b-1),h=c.points[m],o=c.points[B],x=x?x.filter(a):d[o][h];x.length&&(this.faces.splice(e,1),f--,e--)}return this},prepare:function(e){e===q&&(e=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();
this.triangulateQuads().calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();e&&!this.dynamic&&this.clean();return this},clean:function(){var e,g;e=0;for(g=this.points.length;e<g;e++)delete this.points[e],this.points[e]=null;this.points=[];e=0;for(g=this.faces.length;e<g;e++)delete this.faces[e].points,delete this.faces[e].point_normals,delete this.faces[e].uvs,delete this.faces[e].normal,delete this.faces[e],this.faces[e]=null;this.faces=[];return this},
compileMap:function(e){var g=n.vec3,a=n.vec2;e===q&&(e=1.0E-5);var b={segments:[],bounds:[]},c=[],d,f,h,o,m,B,x,t;this.materials.length||this.materials.push(new n.Material);d=0;for(B=this.materials.length;d<B;d++)c[d]=[];d=0;for(B=this.faces.length;d<B;d++)if(this.faces[d].points.length===3)h=this.faces[d].material,o=this.faces[d].segment,c[h][o]===q&&(c[h][o]=[],b.segments.push(o)),c[h][o].push(d);var v=[],r=0,s=!1,z=!1,w=!1,u;d=0;for(B=c.length;d<B;d++)for(f in c[d])if(c[d].hasOwnProperty(f))for(h=
0;h<c[d][f].length;h++)u=c[d][f][h],s=s||this.faces[u].uvs.length!==0,z=z||this.faces[u].point_normals.length!==0,w=w||this.faces[u].point_colors.length!==0;if(s)for(d=0;d<this.faces.length;d++)if(!this.faces[d].uvs.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].uvs.push([0,0]);if(z)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_normals.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].point_normals.push([0,0,0]);if(w)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_colors.length)for(f=
0;f<this.faces[d].points.length;f++)this.faces[d].point_colors.push([0,0,0]);d=0;for(B=c.length;d<B;d++)for(f in c[d])if(c[d].hasOwnProperty(f)){h=0;for(x=c[d][f].length;h<x;h++){u=c[d][f][h];for(o=0;o<3;o++){var F=this.faces[u].points[o],E=-1;if(v[F]!==q){m=0;for(t=v[F].length;m<t;m++){var D=v[F][m][0],y=v[F][m][1],E=v[F][m][2];z&&(E=g.equal(this.faces[D].point_normals[y],this.faces[u].point_normals[o],e)?E:-1);s&&(E=a.equal(this.faces[D].uvs[y],this.faces[u].uvs[o],e)?E:-1);w&&(E=g.equal(this.faces[D].point_colors[y],
this.faces[u].point_colors[o],e)?E:-1)}}if(E!==-1){if(b.elements===q)b.elements=[];b.elements[d]===q&&(b.elements[d]=[]);b.elements[d][f]===q&&(b.elements[d][f]=[]);b.elements[d][f].push(E)}else{if(b.points===q)b.points=[];b.points.push(F);b.bounds.length===0?(b.bounds[0]=[this.points[F][0],this.points[F][1],this.points[F][2]],b.bounds[1]=[this.points[F][0],this.points[F][1],this.points[F][2]]):(this.points[F][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[F][0]),this.points[F][1]<b.bounds[0][1]&&
(b.bounds[0][1]=this.points[F][1]),this.points[F][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[F][2]),this.points[F][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[F][0]),this.points[F][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[F][1]),this.points[F][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[F][2]));if(z){if(b.normals===q)b.normals=[];b.normals.push([u,o])}if(w){if(b.colors===q)b.colors=[];b.colors.push([u,o])}if(s){if(b.uvs===q)b.uvs=[];b.uvs.push([u,o])}if(b.elements===q)b.elements=[];
b.elements[d]===q&&(b.elements[d]=[]);b.elements[d][f]===q&&(b.elements[d][f]=[]);b.elements[d][f].push(r);v[F]===q&&(v[F]=[]);v[F].push([u,o,r]);r++}}}}if(this.edges){b.line_elements=[];d=0;for(B=this.edges.length;d<B;d++)g=this.edges[d],h=g[0],o=g[1],e=g[2],g=g[3],b.line_elements[h]=b.line_elements[h]||[],b.line_elements[h][o]=b.line_elements[h][o]||[],b.line_elements[h][o].push(v[e][0][2]),b.line_elements[h][o].push(v[g][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(e,g,a,b,c,d,f,
h){if(typeof g=="object")g=g.element!==q?g.element:!0,a=g.vertex!==q?g.vertex:!0,d=g.color!==q?g.color:!0,b=g.normal!==q?g.normal:!0,c=g.uv!==q?g.uv:!0,f=g.lines!==q?g.lines:!!e.line_elements,h=g.dynamic!==q?g.dynamic:e.dynamic;else if(g===q&&(g=!0),a===q&&(a=!0),d===q&&(d=!0),b===q&&(b=!0),c===q&&(c=!0),f===q&&(f=!!e.line_elements),h===q)h=e.dynamic;var o={},m,B,x,t,v;if(h)t={points:new Int16Array(e.points.length),face_points:new Int16Array(e.points.length*2),segments:null},o.dynamicMap=t,o.dynamic=
!0;if(e.points&&a){m=e.points.length;o.vbo_points=new Float32Array(m*3);for(a=0;a<m;a++)B=e.points[a],o.vbo_points[a*3]=this.points[B][0],o.vbo_points[a*3+1]=this.points[B][1],o.vbo_points[a*3+2]=this.points[B][2],h&&(t.points[a]=B)}if(h){v=e.normals||e.colors||e.uvs;a=0;for(m=v.length;a<m;a++)B=v[a],t.face_points[a*2]=B[0],t.face_points[a*2+1]=B[1]}if(e.normals&&b){m=e.normals.length;o.vbo_normals=new Float32Array(m*3);for(a=b=0;a<m;a++)B=e.normals[a],o.vbo_normals[b++]=this.faces[B[0]].point_normals[B[1]][0],
o.vbo_normals[b++]=this.faces[B[0]].point_normals[B[1]][1],o.vbo_normals[b++]=this.faces[B[0]].point_normals[B[1]][2]}if(e.colors&&d){m=e.colors.length;o.vbo_colors=new Float32Array(m*3);for(a=b=0;a<m;a++)B=e.colors[a],o.vbo_colors[b++]=this.faces[B[0]].point_colors[B[1]][0],o.vbo_colors[b++]=this.faces[B[0]].point_colors[B[1]][1],o.vbo_colors[b++]=this.faces[B[0]].point_colors[B[1]][2]}if(e.uvs&&c){m=e.uvs.length;o.vbo_uvs=new Float32Array(m*2);for(a=b=0;a<m;a++)B=e.uvs[a],o.vbo_uvs[b++]=this.faces[B[0]].uvs[B[1]][0],
o.vbo_uvs[b++]=this.faces[B[0]].uvs[B[1]][1]}if(g){o.elements_ref=[];o.vbo_elements=[];a=0;for(m=e.elements.length;a<m;a++)for(x in o.elements_ref[a]=[],g=0,e.elements[a])if(e.elements[a].hasOwnProperty(x)){b=e.elements[a][x];c=0;for(d=b.length;c<d;c++)o.vbo_elements.push(b[c]);o.elements_ref[a][g]=[x|0,b.length|0];g++}o.vbo_elements=new Uint16Array(o.vbo_elements)}if(f){o.line_elements_ref=[];o.vbo_line_elements=[];a=0;for(m=e.line_elements.length;a<m;a++)for(x in o.line_elements_ref[a]=[],g=0,e.line_elements[a])if(e.line_elements[a].hasOwnProperty(x)){b=
e.line_elements[a][x];c=0;for(d=b.length;c<d;c++)o.vbo_line_elements.push(b[c]);o.line_elements_ref[a][g]=[x|0,b.length|0];g++}o.vbo_line_elements=new Uint16Array(o.vbo_line_elements)}o.segments=e.segments;o.bounds=e.bounds;if(h&&e.segments.length>1){e=[];v=t.points;a=0;for(m=v.length;a<m;a++)f=this.faces[t.face_points[a*2]].segment||0,e[f]===q&&(e[f]=[]),e[f].push(a);o.dynamicMap.segmentMap=e}return o},updateVBO:function(e,g){if(!e.dynamic)return!1;var a,b,c=e.dynamicMap,d=g.points&&!!e.vbo_points,
f=g.normals&&!!e.vbo_normals,h=g.uvs&&!!e.vbo_uvs,o=g.colors&&!!e.vbo_colors;b=g.segments;var m,B,x;if(g.segments!==q)for(var t=0,v=b.length;t<v;t++)for(var n=c.segmentMap[b[t]],r=0,s=n.length;r<s;r++)a=n[r],B=this.faces[c.face_points[a*2]],x=c.face_points[a*2+1],d&&(m=this.points[c.points[a]],e.vbo_points[a*3]=m[0],e.vbo_points[a*3+1]=m[1],e.vbo_points[a*3+2]=m[2]),f&&(m=B.point_normals[x],e.vbo_normals[a*3]=m[0],e.vbo_normals[a*3+1]=m[1],e.vbo_normals[a*3+2]=m[2]),o&&(m=B.point_colors[x],e.vbo_colors[a*
3]=m[0],e.vbo_colors[a*3+1]=m[1],e.vbo_colors[a*3+2]=m[2]),h&&(m=B.uvs[x],e.vbo_uvs[a*2]=m[0],e.vbo_uvs[a*2+1]=m[1]);else{a=0;for(b=c.points.length;a<b;a++)B=this.faces[c.face_points[a*2]],x=c.face_points[a*2+1],d&&(m=this.points[c.points[a]],e.vbo_points[a*3]=m[0],e.vbo_points[a*3+1]=m[1],e.vbo_points[a*3+2]=m[2]),f&&(m=B.point_normals[x],e.vbo_normals[a*3]=m[0],e.vbo_normals[a*3+1]=m[1],e.vbo_normals[a*3+2]=m[2]),o&&(m=B.point_colors[x],e.vbo_colors[a*3]=m[0],e.vbo_colors[a*3+1]=m[1],e.vbo_colors[a*
3+2]=m[2]),h&&(m=B.uvs[x],e.vbo_uvs[a*2]=m[0],e.vbo_uvs[a*2+1]=m[1])}return this},rebufferVBO:function(e,g,a){var b=r.gl;a.points&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_points),b.bufferData(b.ARRAY_BUFFER,e.vbo_points,b.DYNAMIC_DRAW));a.normals&&e.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_normals),b.bufferData(b.ARRAY_BUFFER,e.vbo_normals,b.DYNAMIC_DRAW));a.uvs&&e.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs),b.bufferData(b.ARRAY_BUFFER,e.vbo_uvs,b.DYNAMIC_DRAW));a.colors&&e.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,
g.gl_colors),b.bufferData(b.ARRAY_BUFFER,e.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(e,g){var a=r.gl,b={};g===q&&(g={});b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,e.vbo_points,a.STATIC_DRAW);e.vbo_normals?(b.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_normals),a.bufferData(a.ARRAY_BUFFER,e.vbo_normals,a.STATIC_DRAW)):b.gl_normals=g.gl_normals?g.gl_normals:null;e.vbo_uvs?
(b.gl_uvs=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_uvs),a.bufferData(a.ARRAY_BUFFER,e.vbo_uvs,a.STATIC_DRAW)):b.gl_uvs=g.gl_uvs?g.gl_uvs:null;e.vbo_colors?(b.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_colors),a.bufferData(a.ARRAY_BUFFER,e.vbo_colors,a.STATIC_DRAW)):b.gl_colors=g.gl_colors?g.gl_colors:null;!e.vbo_elements&&g.gl_elements?(b.gl_elements=g.gl_elements,b.elements_ref=g.elements_ref):(b.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_elements),
a.bufferData(a.ELEMENT_ARRAY_BUFFER,e.vbo_elements,a.STATIC_DRAW),b.elements_ref=e.elements_ref);!e.vbo_line_elements&&g.gl_line_elements?(b.gl_line_elements=g.gl_line_elements,b.line_elements_ref=g.line_elements_ref):(b.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,e.vbo_line_elements,a.STATIC_DRAW),b.line_elements_ref=e.line_elements_ref);b.segments=e.segments;b.bounds=e.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);
return b},update:function(e){var e=e||{},g=e.points||e.point||e.vertex||e.vertices||e.all||!0,a=e.uvs||e.uv||e.texture||e.all||!1,b=e.normals||e.normal||e.all||!0,c=e.colors||e.color||e.all||!1,e=e.segments||e.segment;e!==q&&e.length===q&&(e=[e]);if(!this.dynamic)return s("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals(q,{segments:e});g={points:g,uvs:a,normals:b,colors:c,segments:e};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,
this.dynamicData.buffer,g)},bindBuffer:function(e){if(this.originBuffer===null)this.originBuffer=e;this.compiled=e;this.segment_state=[];for(var g=0,a=e.segments.length;g<a;g++)this.segment_state[e.segments[g]]=!0;this.bb=e.bounds},compile:function(e){if(this.faces.length>0&&this.points.length>0){var e=this.compileVBO(this.compileMap(e)),g=this.bufferVBO(e);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,b=this.points.length;a<b;a++)this.sourcePoints[a]=this.points[a].slice(0);
this.dynamicData={VBO:e,buffer:g}}}return this},addMorphTarget:function(e){if(this.morphTargets===null)this.morphTargets=[];this.morphTargets.push(e)},setMorphSource:function(e){if(this.morphSourceIndex!==e)this.morphSourceIndex=e,this.bindBuffer(this.morphTargets[e])},setMorphTarget:function(e){if(this.morphTargetIndex!==e)this.morphTargetIndex=e,this.morphTarget=this.morphTargets[e]},setMorphWeight:function(e){this.morphWeight=e},morphTargetCount:function(){return this.morphTargets!==null?this.morphTargets.length:
0}};return{Mesh:z,Face:y}});
CubicVR.RegisterModule("UVMapper",function(n){function y(a){a=n.get(a)||{};this.rotation=a.rotation===z?[0,0,0]:a.rotation;this.scale=a.scale===z?[1,1,1]:a.scale;this.center=a.center===z?[0,0,0]:a.center;this.projection_mode=a.projectionMode===z?q.uv.projection.PLANAR:n.parseEnum(q.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===z?q.uv.axis.X:n.parseEnum(q.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===z?1:a.wrapW;this.wrap_h_count=a.wrapH===z?1:a.wrapH}var z=n.undef,
q=n.enums,r=2*Math.PI,s=Math.PI/2;q.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var e=function(a,b,c){return a===0&&c===0?0:c===0?a<0?s:-s:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c)},g=function(a,b,c){var d;a===0&&c===0?(d=0,a=b!==0?b<0?-s:s:0):(d=c===0?a<0?s:-s:c<0?-Math.atan(a/c)+Math.PI:-Math.atan(a/c),a=Math.sqrt(a*a+c*c),a=a===0?b<0?-s:s:Math.atan(b/a));return[d,a]};y.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,c,d,f){var h=n.mat4,o,m,B,x,t,v=new n.Transform,C=!1,A=null;if(this.center[0]||this.center[1]||this.center[2])v.translate(-this.center[0],-this.center[1],-this.center[2]),C=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
v.rotate(this.rotation[2],0,0,1),this.rotation[1]&&v.rotate(this.rotation[1],0,1,0),this.rotation[2]&&v.rotate(this.rotation[0],1,0,0),C=!0;C&&(A=v.getResult());typeof b==="object"&&(b=a.materials.indexOf(b));var v=0,M=a.faces.length;d&&(v=d);for(f&&(M=f+1);v<M;v++)if(a.faces[v].material===b&&!(c!==z&&a.faces[v].segment!==c)){var w,u,F;if(this.projection_mode===q.uv.projection.CUBIC||this.projection_mode===q.uv.projection.SKY)w=Math.abs(a.faces[v].normal[0]),u=Math.abs(a.faces[v].normal[1]),F=Math.abs(a.faces[v].normal[2]);
for(var d=[],f=0,E=a.faces[v].points.length;f<E;f++){m=a.faces[v].points[f];var D=a.faces[v].points[(f+1)%3],y=a.faces[v].points[(f+2)%3];o=a.points[m];var I=a.points[D],G=a.points[y],J;C&&(o=h.vec3_multiply(o,A));J=this.projection_mode;if(J===q.uv.projection.SKY)m=a.sky_mapping,w>=u&&w>=F&&(B=o[2]/this.scale[2]+this.scale[2]/2,x=-o[1]/this.scale[1]+this.scale[1]/2,a.faces[v].normal[0]<0?(B=(m[2][2]-m[2][0])*(1-B),x=1-(m[2][3]-m[2][1])*x,B+=m[2][0],x+=m[2][1]):(B*=m[3][2]-m[3][0],x=1-(m[3][3]-m[3][1])*
x,B+=m[3][0],x+=m[3][1])),u>=w&&u>=F&&(B=o[0]/this.scale[0]+this.scale[0]/2,x=-o[2]/this.scale[2]+this.scale[2]/2,a.faces[v].normal[1]<0?(B*=m[1][2]-m[1][0],x=1-(m[1][3]-m[1][1])*x,B+=m[1][0],x-=m[1][1]):(B*=m[0][2]-m[0][0],x=1-(m[0][3]-m[0][1])*x,B+=m[0][0],x-=m[0][1])),F>=w&&F>=u&&(B=o[0]/this.scale[0]+this.scale[0]/2,x=o[1]/this.scale[1]+this.scale[1]/2,a.faces[v].normal[2]<0?(B*=m[4][2]-m[4][0],x=1-(m[4][3]-m[4][1])*(1-x),B+=m[4][0],x-=m[4][1]):(B=(m[5][2]-m[5][0])*(1-B),x=1-(m[5][3]-m[5][1])*
(1-x),B+=m[5][0],x+=m[5][1])),a.faces[v].setUV([B,x],f);else if(J===q.uv.projection.CUBIC)w>=u&&w>=F&&(B=o[2]/this.scale[2]+0.5,x=o[1]/this.scale[1]+0.5),u>=w&&u>=F&&(B=-o[0]/this.scale[0]+0.5,x=o[2]/this.scale[2]+0.5),F>=w&&F>=u&&(B=-o[0]/this.scale[0]+0.5,x=o[1]/this.scale[1]+0.5),a.faces[v].normal[0]>0&&(B=-B),a.faces[v].normal[1]<0&&(B=-B),a.faces[v].normal[2]>0&&(B=-B),a.faces[v].setUV([B,x],f);else if(J===q.uv.projection.PLANAR)B=this.projection_axis===q.uv.axis.X?o[2]/this.scale[2]+0.5:-o[0]/
this.scale[0]+0.5,x=this.projection_axis===q.uv.axis.Y?o[2]/this.scale[2]+0.5:o[1]/this.scale[1]+0.5,a.faces[v].setUV([B,x],f);else{if(J===q.uv.projection.CYLINDRICAL)J=this.projection_axis,J===q.uv.axis.X?(t=e(o[2],o[0],-o[1]),x=-o[0]/this.scale[0]+0.5):J===q.uv.axis.Y?(t=e(-o[0],o[1],o[2]),x=-o[1]/this.scale[1]+0.5):J===q.uv.axis.Z&&(t=e(-o[0],o[2],-o[1]),x=-o[2]/this.scale[2]+0.5),t=1-t/r,this.wrap_w_count!==1&&(t*=this.wrap_w_count),o=t,m=x;else if(J===q.uv.projection.SPHERICAL){var H,L,K;J=this.projection_axis;
J===q.uv.axis.X?(H=d[m]?d[m]:g(o[2],o[0],-o[1]),d[m]||(d[m]=H),L=d[D]?d[D]:g(I[2],I[0],-I[1]),d[D]||(d[D]=L),K=d[y]?d[y]:g(G[2],G[0],-G[1]),d[y]||(d[y]=K)):J===q.uv.axis.Y?(H=d[m]?d[m]:g(o[0],-o[1],o[2]),d[m]||(d[m]=H),L=d[D]?d[D]:g(I[0],-I[1],I[2]),d[D]||(d[D]=L),K=d[y]?d[y]:g(G[0],-G[1],G[2]),d[y]||(d[y]=K)):J===q.uv.axis.Z&&(H=d[m]?d[m]:g(-o[0],o[2],-o[1]),d[m]||(d[m]=H),L=d[D]?d[D]:g(-I[0],I[2],-I[1]),d[D]||(d[D]=L),K=d[y]?d[y]:g(-G[0],G[2],-G[1]),d[y]||(d[y]=K));Math.abs(H[0]-L[0])>s&&Math.abs(H[0]-
K[0])>s&&(H[0]>L[0]&&H[0]>K[0]?H[0]-=r:H[0]+=r);Math.abs(H[1]-L[1])>s&&Math.abs(H[1]-K[1])>s&&(H[1]>L[1]&&H[1]>K[1]?H[1]-=r:H[1]+=r);t=1-H[0]/r;m=0.5-H[1]/Math.PI;this.wrap_w_count!==1&&(t*=this.wrap_w_count);this.wrap_h_count!==1&&(m*=this.wrap_h_count);o=t}else m=o=0;a.faces[v].setUV([o,m],f)}}}return this}};return{UVMapper:y}});
CubicVR.RegisterModule("Renderer",function(n){var y=n.undef;return{renderObject:function(z,q,r,s,e,g,a){var b=!1,e=e||!1,g=g||!1;if(z.compiled!==null){var c=0,d=n.GLCore.gl,f,h=s===y?0:s.length,o,m=0,B,x=null,t=z.instanceMaterials||z.materials,v=(a=(z.wireframe||a)&&z.compiled.line_elements_ref)?z.compiled.line_elements_ref:z.compiled.elements_ref,C=!1,A,M,w;d.depthFunc(d.LEQUAL);r===y&&(r=cubicvr_identity);for(var u=0,F=v.length;u<F;u++){var x=a&&z.wireframeMaterial?z.wireframeMaterial:t[u],E=0,
m=!1;if(x.opacity<1&&e)b=!0;else if(!(g&&x.opacity>=1)){x.opacity!==1?(d.enable(d.BLEND),d.depthMask(0),d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA)):(d.depthMask(1),d.disable(d.BLEND),d.blendFunc(d.ONE,d.ONE));for(var D=0,O=v[u].length;D<O;D++)if(B=v[u][D][0],m=!1,f=v[u][D][1],E+=f,x.visible){if(!z.segment_state[B])if(E>f){c+=f*2;E-=f;if(h){M=!1;for(A=0;A<h;){f=h-A;if(f>n.MAX_LIGHTS)f=n.MAX_LIGHTS;A>0&&!M&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),M=!0);o=s[A];w=o.light_type;
for(m=0;m<f;m++)if(s[m+A].light_type!=w){f=m;break}x.use(o.light_type,f);o=x.shader[o.light_type][f];d.uniformMatrix4fv(o.matrixModelView,!1,q.mvMatrix);d.uniformMatrix4fv(o.matrixProjection,!1,q.pMatrix);d.uniformMatrix4fv(o.matrixObject,!1,r);d.uniformMatrix3fv(o.matrixNormal,!1,q.nMatrix);C||(x.bindObject(z,o),C=o.vertexTexCoord!=-1,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements));for(m=0;m<f;m++)s[m+A].setupShader(o,m);a?d.drawElements(d.LINES,E,d.UNSIGNED_SHORT,c):d.drawElements(d.TRIANGLES,
E,d.UNSIGNED_SHORT,c);A+=f}M&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else x.use(0,0),d.uniformMatrix4fv(x.shader[0][0].matrixModelView,!1,q.mvMatrix),d.uniformMatrix4fv(x.shader[0][0].matrixProjection,!1,q.pMatrix),d.uniformMatrix4fv(x.shader[0][0].matrixObject,!1,r),d.uniformMatrix3fv(x.shader[0][0].matrixNormal,!1,q.nMatrix),C||(x.bindObject(z,x.shader[0][0]),C=x.shader[0][0].vertexTexCoord!=-1,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements)),a?d.drawElements(d.LINES,E,d.UNSIGNED_SHORT,
c):d.drawElements(d.TRIANGLES,E,d.UNSIGNED_SHORT,c);c+=E*2;E=0;m=!0}else c+=E*2,E=0}else c+=f*2,E-=f;if(!m&&z.segment_state[B]&&x.visible){if(h){M=!1;for(A=0;A<h;){f=h-A;if(f>n.MAX_LIGHTS)f=n.MAX_LIGHTS;A>0&&!M&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),M=!0);o=s[A];w=o.light_type;for(m=0;m<f;m++)if(s[m+A].light_type!=w){f=m;break}x.use(o.light_type,f);o=x.shader[o.light_type][f];d.uniformMatrix4fv(o.matrixModelView,!1,q.mvMatrix);d.uniformMatrix4fv(o.matrixProjection,!1,q.pMatrix);
d.uniformMatrix4fv(o.matrixObject,!1,r);d.uniformMatrix3fv(o.matrixNormal,!1,q.nMatrix);C||(x.bindObject(z,o),C=o.vertexTexCoord!=-1,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements));for(m=0;m<f;m++)s[m+A].setupShader(o,m);a?d.drawElements(d.LINES,E,d.UNSIGNED_SHORT,c):d.drawElements(d.TRIANGLES,E,d.UNSIGNED_SHORT,c);A+=f}M&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else x.use(0,0),d.uniformMatrix4fv(x.shader[0][0].matrixModelView,!1,q.mvMatrix),d.uniformMatrix4fv(x.shader[0][0].matrixProjection,
!1,q.pMatrix),d.uniformMatrix4fv(x.shader[0][0].matrixObject,!1,r),d.uniformMatrix3fv(x.shader[0][0].matrixNormal,!1,q.nMatrix),C||(x.bindObject(z,x.shader[0][0]),C=x.shader[0][0].vertexTexCoord!=-1,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,z.compiled.gl_line_elements)),a?d.drawElements(d.LINES,E,d.UNSIGNED_SHORT,c):d.drawElements(d.TRIANGLES,E,d.UNSIGNED_SHORT,c);c+=E*2}}}x&&o?x.clearObject(z,o):x.clearObject(z,null);d.depthMask(1);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return b}}}});
CubicVR.RegisterModule("Light",function(n){function y(e,g){var a=n.aabb,e=n.get(e)||{};if(e===r)e=q.light.type.POINT;if(g===r)g=q.light.method.DYNAMIC;typeof e=="object"?(this.light_type=e.type!==r?n.parseEnum(q.light.type,e.type):q.light.type.POINT,this.diffuse=e.diffuse!==r?e.diffuse:[1,1,1],this.specular=e.specular!==r?e.specular:[1,1,1],this.intensity=e.intensity!==r?e.intensity:1,this.position=e.position!==r?e.position:[0,0,0],this.direction=e.direction!==r?e.direction:[0,0,0],this.distance=
e.distance!==r?e.distance:this.light_type===q.light.type.AREA?30:10,this.cutoff=e.cutoff!==r?e.cutoff:60,this.map_res=e.map_res!==r?e.map_res:this.light_type===q.light.type.AREA?2048:512,this.map_res=e.mapRes!==r?e.mapRes:this.map_res,this.method=e.method!==r?n.parseEnum(q.light.method,e.method):g,this.areaCam=e.areaCam!==r?e.areaCam:null,this.areaCeiling=e.areaCeiling!==r?e.areaCeiling:40,this.areaFloor=e.areaFloor!==r?e.areaFloor:-40,this.areaAxis=e.areaAxis!==r?e.areaAxis:[1,1,0],this.projectorTex=
e.projector!==r?e.projector:null):(this.light_type=n.parseEnum(q.light.type,e),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===q.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===q.light.type.AREA?2048:512,this.method=n.parseEnum(q.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&typeof this.projectorTex===
"string"){var b=this.projectorTex;this.projectorTex=n.Textures_ref[b]!==r?n.Textures_obj[n.Textures_ref[b]]:new n.Texture(b)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=n.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];
(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA&&n.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var z=n.GLCore,q=n.enums,r=n.undef,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];q.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};y.prototype={setType:function(e){if(e===
q.light.type.AREA&&!n.features.lightShadows)this.dummyCam=new n.Camera,this.areaCam=new n.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,e=q.light.type.DIRECTIONAL;else if((e===q.light.type.SPOT_SHADOW||e===q.light.type.SPOT_SHADOW_PROJECTOR)&&!n.features.lightShadows)e=q.light.type.SPOT;this.light_type=e},setParent:function(e){this.parent=e},setMethod:function(e){this.method=e},setDiffuse:function(e){this.diffuse=e},setSpecular:function(e){this.specular=e},setIntensity:function(e){this.intensity=
e},setPosition:function(e){this.position=e},setDistance:function(e){this.distance=e},setCutoff:function(e){this.cutoff=e},prepare:function(e){var g=n.mat4,a=n.mat3,b=this.light_type;if(this.parent)if(b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR)b=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,e.nMatrix),this.lPos=g.vec3_multiply(this.position,g.multiply(e.mvMatrix,
this.parent.tMatrix));else{if(b===q.light.type.POINT)this.lPos=g.vec3_multiply(this.position,g.multiply(e.mvMatrix,this.parent.tMatrix))}else if(b===q.light.type.DIRECTIONAL)this.lDir=a.vec3_multiply(this.direction,e.nMatrix);else if(b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR)this.lDir=a.vec3_multiply(this.direction,e.nMatrix),this.lPos=g.vec3_multiply(this.position,e.mvMatrix);else if(b===q.light.type.POINT)this.lPos=g.vec3_multiply(this.position,
e.mvMatrix);else if(b===q.light.type.AREA)this.lDir=a.vec3_multiply(this.direction,e.nMatrix)},control:function(e,g,a){if(e===q.motion.POS)this.position[g]=a;else if(e===q.motion.INTENSITY)this.intensity=a},getAABB:function(){var e=n.vec3,g=n.aabb,a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=e.add(a[0],this.position);a[1]=e.add(a[1],this.position);return this.aabb=a},setDirection:function(e,g,a){var b=n.vec3;
if(typeof e==="object")this.setDirection(e[0],e[1],e[2]);else return this.direction=b.normalize([e,g,a]),this},lookat:function(e,g,a){var b=n.vec3;if(typeof e==="object")this.lookat(e[0],e[1],e[2]);else return this.direction=b.normalize(b.subtract([e,g,a],this.position)),this},setRotation:function(e,g,a){var b=n.mat4,c=n.vec3;if(typeof e==="object")this.setRotation(e[0],e[1],e[2]);else{var d=new n.Transform;d.rotate([-e,-g,-a]);d.pushMatrix();this.direction=c.normalize(b.vec3_multiply([1,0,0],d.getResult()));
this.rotation=[e,g,a];return this}},setupShader:function(e,g){var a=z.gl;a.uniform3fv(e.lightDiffuse[g],this.diffuse);a.uniform3fv(e.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(e.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(e.lightDirection[g],this.lDir);a.uniform1f(e.lightIntensity[g],this.intensity);a.uniform1f(e.lightDistance[g],this.distance);(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.SPOT)&&
a.uniform1f(e.lightCutOffAngle[g],this.cutoff);if(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA)this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(z.gl.TEXTURE0+g*2),a.uniform1i(e.lightShadowMap[g],g*2),this.projectorTex.use(z.gl.TEXTURE0+g*2+1),a.uniform1i(e.lightProjectionMap[g],g*2+1)):(this.shadowMapTex.texture.use(z.gl.TEXTURE0+g),a.uniform1i(e.lightShadowMap[g],g)),a.uniform3fv(e.lightDepthClip[g],
[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(e.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(e){if(n.features.lightShadows)this.map_res=e,this.shadowMapTex=new n.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(q.texture.filter.NEAREST),this.dummyCam=new n.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0},hasShadow:function(){return has_shadow},
setProjector:function(e){this.projectorTex=e},hasProjector:function(){return this.projectorTex!==null?!0:!1},shadowBegin:function(){var e=z.gl,g=n.mat4,a=n.mat3;this.shadowMapTex.use();e.viewport(0,0,this.map_res,this.map_res);e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT);this.light_type!==q.light.type.AREA?(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,
b);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+this.direction[2]*10,0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+this.direction[0]*10,this.position[1]+this.direction[1]*10,this.position[2]+
this.direction[2]*10,0,1,0);e.cullFace(e.FRONT)},shadowEnd:function(){var e=z.gl;e.bindFramebuffer(e.FRAMEBUFFER,null);e.cullFace(e.BACK);this.setupTexGen()},setupTexGen:function(){var e=n.mat4;this.spMatrix=e.multiply(s,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=e.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=e.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(e){this.areaAxis=e},updateAreaLight:function(){var e=n.vec3,g=this.areaCeiling-this.areaFloor;
this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=e.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=e.normalize(b);e.normalize(e.cross(b,[0,1,0]));var c=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);b=e.multiply(b,a);a=[Math.tan(this.areaAxis[1]*(Math.PI/180)),0,Math.tan(this.areaAxis[0]*(Math.PI/180))];c-=Math.atan2(a[0],a[2]);this.position=e.add(e.add(this.areaCam.position,
b),e.multiply(a,g));this.position[1]=this.areaCeiling;this.target=e.add(e.add(this.areaCam.position,b),e.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=e.normalize(e.subtract(this.target,this.position));this.dummyCam.rotation[2]=c*(180/Math.PI);e=this.dummyCam.nearclip;g=this.dummyCam.farclip*Math.abs(this.direction[1])*g;e=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);e=this.orthoBounds(this.position,
this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);e[1][1]>this.areaFloor&&(e=e[1][1]-this.areaFloor,g+=e/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=g;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(e,g,a,b,c,d){var b=n.vec3,f=b.normalize([c[0],c[4],c[8]]),h=b.normalize([c[1],c[5],c[9]]),c=b.normalize(b.cross(h,f)),o;o=a/2;a=[];g=b.multiply(f,g/2);f=b.multiply(h,
o);d=b.multiply(c,d);a[0]=b.add(b.subtract(e,g),b.add(f,d));a[1]=b.add(b.add(e,g),b.add(f,d));a[2]=b.subtract(b.subtract(e,g),b.add(f,d));a[3]=b.subtract(b.add(e,g),b.add(f,d));aabb1=a[0];aabb2=a[0];for(e=1;e<4;e++)aabb1[0]>a[e][0]&&(aabb1[0]=a[e][0]),aabb1[1]>a[e][1]&&(aabb1[1]=a[e][1]),aabb1[2]>a[e][2]&&(aabb1[2]=a[e][2]),aabb2[0]<a[e][0]&&(aabb2[0]=a[e][0]),aabb2[1]<a[e][1]&&(aabb2[1]=a[e][1]),aabb2[2]<a[e][2]&&(aabb2[2]=a[e][2]);return[aabb1,aabb2]}};return{Light:y}});
CubicVR.RegisterModule("Camera",function(n){function y(a,b,c,d,f){var h=n.mat4;this.frustum=new n.Frustum;typeof a=="object"?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==r?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==r?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,b=a.height?a.height:r,a=a.width?
a.width:r):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=c!==r?c:60,this.nearclip=d!==r?d:0.1,this.farclip=f!==r?f:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new n.Transform;this.manual=!1;this.setDimensions(a!==r?a:512,b!==r?b:512);this.mvMatrix=h.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}function z(a){this.position=
a!==r?a:[0,0,0]}function q(a,b,c){this.camPath=new n.Motion;this.targetPath=new n.Motion;this.start_position=a!==r?a:[8,8,8];this.target=b!==r?b:[0,0,0];this.bounds=c!==r?c:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var r=n.undef,s=n.enums,e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=0;y.prototype={trackTarget:function(a,
b,c){this.position=n.vec3.trackTarget(this.position,a,b,c)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return this.parent!==null&&this.mvMatrix&&this.parent.tMatrix?n.mat4.vec3_multiply(this.position,this.parent.tMatrix):this.position},setOrtho:function(a,b,c,d){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=c;this.ortho_view.top=d},control:function(a,b,
c){a===s.motion.ROT?this.rotation[b]=c:a===s.motion.POS?this.position[b]=c:a===s.motion.FOV?this.setFOV(c):a===s.motion.LENS?this.setLENS(c):a===s.motion.NEARCLIP?this.setClip(c,this.farclip):a===s.motion.FARCLIP&&this.setClip(this.nearclip,c)},makeFrustum:function(a,b,c,d,f,h){return[2*f/(b-a),0,0,0,0,2*f/(d-c),0,0,(b+a)/(b-a),(d+c)/(d-c),-(h+f)/(h-f),-1,0,0,-2*h*f/(h-f),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=n.mat4,b=n.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,
this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);if(!this.targeted&&this.mvMatrix)a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),
b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix);this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,c,d,f,h,o,m,g){var x=
n.mat4,t=n.mat3;if(typeof a=="object")this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0);else{this.mvMatrix=x.lookat(a,b,c,d,f,h,o,m,g);if(this.rotation[2])this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult();this.parent!==null&&x.multiply(this.mvMatrix.slice(0),x.inverse(this.parent.tMatrix),this.mvMatrix);this.calc_nmatrix?(this.nMatrix=x.inverse_mat3(this.mvMatrix),
t.transpose_inline(this.nMatrix)):this.nMatrix=e;this.frustum.extract(this,this.mvMatrix,this.pMatrix)}},unProject:function(a,b,c){var d=n.mat4,f=n.vec3,h=[0,0,this.width,this.height],a=d.vec4_multiply(d.vec4_multiply([(a-h[0])/h[2]*2-1,-((b-h[1])/h[3]*2-1),1,1],d.inverse(this.pMatrix)),d.inverse(this.mvMatrix)),a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];if(c!==r)return b=this.getParentedPosition(),f.add(b,f.multiply(f.normalize(f.subtract(a,b)),c));return a},project:function(a,b,c){var d=n.mat4,d=d.vec4_multiply(d.vec4_multiply([a,
b,c,1],this.mvMatrix),this.pMatrix);d[2]=n.vec3.length(n.vec3.subtract([a,b,c],this.position));return[(d[0]/d[3]+1)/2*this.width,(-d[1]/d[3]+1)/2*this.height,d[2]]}};z.prototype={control:function(a,b,c){a===s.motion.POS&&(this.position[b]=c)}};q.prototype={inBounds:function(a){var b=n.vec3;if(!(a[0]>this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var c=0,d=this.avoid_sphere.length;c<d;c++)if(b.length(a,
this.avoid_sphere[c][0])<this.avoid_sphere[c][1])return!1;return!0},findNextNode:function(a,b){var c=n.vec3,d=[0,0,0],f=[0,0,0],h=d=0,o=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=c.normalize(f),d=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,d=c.add(b.position,c.multiply(f,d)),o=this.inBounds(d),h++,h>30){d=b.position;break}while(!o);return d},run:function(a){this.current_time=a;if(this.path_time===0)this.path_time=this.current_time,this.camPath.setKey(s.motion.POS,
s.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,this.start_position[2]);for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var b=new z,c=new z;this.path_length&&this.camPath.apply(this.path_time-this.segment_time*2,b);this.camPath.apply(this.path_time-this.segment_time,c);b=this.findNextNode(b,c);this.camPath.setKey(s.motion.POS,
s.motion.X,this.path_time,b[0]);this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,b[1]);this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,b[2]);this.path_length++}b=new z;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:y,AutoCamera:q}});
CubicVR.RegisterModule("Motion",function(n){function y(){this.time=this.value=0;this.shape=s.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function z(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(s.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||s.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||s.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=s.envelope.behavior.CONSTANT}function q(a,b){this.controllers=[];this.yzflip=!1;if(typeof a==="object"){var h=CubicVR.get(a);this.env_init=CubicVR.get(h.envelope);this.key_init=CubicVR.get(h.key);for(var o in h)if(h.hasOwnProperty(o)&&!(o==="envelope"||o==="key")){var c=h[o],g=CubicVR.get(c.envelope),e;for(e in c)if(c.hasOwnProperty(e)&&!(e==="envelope"||e==="key")){var t=c[e];if(typeof t==="object")for(var v in t)this.setKey(o,v,e,t[v]),g&&this.setBehavior(o,v,
g)}}}else this.env_init=a,this.key_init=b}var r=n.undef,s=CubicVR.enums;s.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};s.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var e=function(a,b,h){var o=0,o=h-b;if(o===0)return[b,0];b=a-o*Math.floor((a-b)/o);o=-parseInt((b-a)/o+(b>a?0.5:-0.5),10);return[b,o]},g=function(a,b,h,o,c){var g,e;e=c*c;g=3*(b-
a);b=3*(h-b)-g;return(o-a-g-b)*e*c+b*e+g*c+a},a=function(b,f,h,o,c,e,x){var t,v;v=e+(x-e)*0.5;t=g(b,f,h,o,v);return Math.abs(c-t)>1.0E-4?(t>c?x=v:e=v,a(b,f,h,o,c,e,x)):v},b=function(a,b){var h,o,c,g;a.shape===s.envelope.shape.TCB?(h=(1-a.tension)*(1+a.continuity)*(1+a.bias),o=(1-a.tension)*(1-a.continuity)*(1-a.bias),c=b.value-a.value,a.prev?(g=(b.time-a.time)/(b.time-a.prev.time),h=g*(h*(a.value-a.prev.value)+o*c)):h=o*c):a.shape===s.envelope.shape.LINE?(c=b.value-a.value,a.prev?(g=(b.time-a.time)/
(b.time-a.prev.time),h=g*(a.value-a.prev.value+c)):h=c):a.shape===s.envelope.shape.BEZI||a.shape===s.envelope.shape.HERM?(h=a.param[1],a.prev&&(h*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===s.envelope.shape.BEZ2?(h=a.param[3]*(b.time-a.time),Math.abs(a.param[2])>1.0E-5?h/=a.param[2]:h*=1E5):h=0;return h},c=function(a,b){var h,c,m,g;b.shape===s.envelope.shape.LINE?(m=b.value-a.value,b.next?(g=(b.time-a.time)/(b.next.time-a.time),h=g*(b.next.value-b.value+m)):h=m):b.shape===s.envelope.shape.TCB?
(h=(1-b.tension)*(1-b.continuity)*(1+b.bias),c=(1-b.tension)*(1+b.continuity)*(1-b.bias),m=b.value-a.value,b.next?(g=(b.time-a.time)/(b.next.time-a.time),h=g*(c*(b.next.value-b.value)+h*m)):h*=m):b.shape===s.envelope.shape.HERM||b.shape===s.envelope.shape.BEZI?(h=b.param[0],b.next&&(h*=(b.time-a.time)/(b.next.time-a.time))):b.shape===s.envelope.shape.BEZ2?(h=b.param[1]*(b.time-a.time),Math.abs(b.param[0])>1.0E-5?h/=b.param[0]:h*=1E5):h=0;return h};z.prototype={setBehavior:function(a,b){this.in_behavior=
CubicVR.parseEnum(s.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,b)},empty:function(){return this.nKeys===0},addKey:function(a,b,h){var c=typeof a=="object"?a:h;b||(b=0);a||(a=0);c?(c=a,a=c.time,h=this.insertKey(a),h.value=c.value?c.value:b,h.time=c.time?c.time:a,h.shape=CubicVR.parseEnum(s.envelope.shape,c.shape)||s.envelope.shape.TCB,h.tension=c.tension?c.tension:0,h.continuity=c.continuity?c.continuity:0,h.bias=c.bias?c.bias:0,h.param=c.param?c.param:[0,0,0,0]):
(h=this.insertKey(a),h.value=b);return h},insertKey:function(a){var b=new y;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=b,this.nKeys++,b;for(var h=this.keys;h;){if(this.firstKey.time>a)this.firstKey=b;else if(this.lastKey.time<a)this.lastKey=b;if(h.time>b.time){b.prev=h.prev;if(b.prev)b.prev.next=b;b.next=h;b.next.prev=b;this.nKeys++;return b}else if(!h.next)return b.prev=h,h.next=b,this.nKeys++,b;h=h.next}return null},evaluate:function(d){var f,h,o,m,B,x=0;if(this.nKeys===
0)return 0;if(this.nKeys===1)return this.keys.value;h=this.firstKey;f=this.lastKey;if(d<h.time)if(m=this.in_behavior,m===s.envelope.behavior.RESET)return 0;else if(m===s.envelope.behavior.CONSTANT)return h.value;else if(m===s.envelope.behavior.REPEAT)m=e(d,h.time,f.time),d=m[0];else if(m===s.envelope.behavior.OCILLATE)m=e(d,h.time,f.time),d=m[0],m=m[1],m%2&&(d=f.time-h.time-d);else if(m===s.envelope.behavior.OFFSET)m=e(d,h.time,f.time),d=m[0],m=m[1],x=m*(f.value-h.value);else{if(m===s.envelope.behavior.LINEAR)return B=
b(h,h.next)/(h.next.time-h.time),B*(d-h.time)+h.value}else if(d>f.time)if(m=this.out_behavior,m===s.envelope.behavior.RESET)return 0;else if(m===s.envelope.behavior.CONSTANT)return f.value;else if(m===s.envelope.behavior.REPEAT)m=e(d,h.time,f.time),d=m[0];else if(m===s.envelope.behavior.OCILLATE)m=e(d,h.time,f.time),d=m[0],m=m[1],m%2&&(d=f.time-h.time-d);else if(m===s.envelope.behavior.OFFSET)m=e(d,h.time,f.time),d=m[0],m=m[1],x=m*(f.value-h.value);else if(m===s.envelope.behavior.LINEAR)return m=
c(f.prev,f)/(f.time-f.prev.time),m*(d-f.time)+f.value;if(this.lastKey0)if(d>this.lastKey0.time)f=this.lastKey0;else if(d<this.lastKey0.time)for(f=this.lastKey;d<f.time&&f.prev;)f=f.prev;else f=this.keys;else f=this.keys;for(;d>f.next.time;)f=f.next;h=f.next;this.lastKey0=f;if(d===f.time)return f.value+x;else if(d===h.time)return h.value+x;o=(d-f.time)/(h.time-f.time);m=h.shape;if(m===s.envelope.shape.TCB||m===s.envelope.shape.BEZI||m===s.envelope.shape.HERM){B=b(f,h);m=c(f,h);var t,v;v=o*o;t=o*v;
d=3*v-t-t;t-=v;d=[1-d,d,t-v+o,t];return d[0]*f.value+d[1]*h.value+d[2]*B+d[3]*m+x}else return m===s.envelope.shape.BEZ2?(d=a(f.time,f.shape===s.envelope.shape.BEZ2?f.time+f.param[2]:f.time+(h.time-f.time)/3,h.time+h.param[0],h.time,d,0,1),x=g(f.value,f.shape===s.envelope.shape.BEZ2?f.value+f.param[3]:f.value+f.param[1]/3,h.param[1]+h.value,h.value,d)+x):x=m===s.envelope.shape.LINE?f.value+o*(h.value-f.value)+x:m===s.envelope.shape.STEP?f.value+x:x,x}};q.prototype={clone:function(){var a=new n.Motion(this.env_init,
this.key_init),b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){a.controllers[b]===r&&(a.controllers[b]=[]);for(var h in this.controllers[b])if(this.controllers[b].hasOwnProperty(h)){var c=this.controllers[b][h],m=a.controllers[b][h]=new z({in_behavior:c.in_behavior,out_behavior:c.out_behavior});m.nKeys=c.nKeys;m.keys=c.keys;m.firstKey=c.firstKey;m.lastKey=c.lastKey}}return a},envelope:function(a,b){b=CubicVR.parseEnum(s.motion,b)||0;a=CubicVR.parseEnum(s.motion,a)||0;this.controllers[a]===
r&&(this.controllers[a]=[]);this.controllers[a][b]===r&&(this.controllers[a][b]=new z(this.env_init));return this.controllers[a][b]},evaluate:function(a){var b=[],h;for(h in this.controllers)if(this.controllers.hasOwnProperty(h)){b[h]=[];for(var c in this.controllers[h])this.controllers[h].hasOwnProperty(c)&&(b[h][c]=this.controllers[h][c].evaluate(a))}return b},apply:function(a,b){for(var h in this.controllers)if(this.controllers.hasOwnProperty(h)){var c=parseInt(h,10);if(this.yzflip&&c===s.motion.ROT){if(!this.q)this.q=
new CubicVR.Quaternion;var m=this.q,g=this.controllers[h][0].evaluate(a),e=this.controllers[h][1].evaluate(a),t=this.controllers[h][2].evaluate(a);m.fromEuler(g,t,-e);m=m.toEuler();b.control(c,0,m[0]);b.control(c,1,m[1]);b.control(c,2,m[2])}else for(var v in this.controllers[h])this.controllers[h].hasOwnProperty(v)&&b.control(c,parseInt(v,10),this.controllers[h][v].evaluate(a))}},setKey:function(a,b,h,c,m){b=CubicVR.parseEnum(s.motion,b)||0;a=CubicVR.parseEnum(s.motion,a)||0;return this.envelope(a,
b).addKey(h,c,m?m:this.key_init)},setArray:function(a,b,h,c){var m=[],a=CubicVR.parseEnum(s.motion,a)||0,g;for(g in h)if(h.hasOwnProperty(g)){var e=this.envelope(a,CubicVR.parseEnum(s.motion,g));m[g]=e.addKey(b,h[g],c?c:this.key_init)}return m},setBehavior:function(a,b,h,c){var g=this.envelope(a,b);typeof h==="object"&&(c=h,h=c.in_behavior||c.inBehavior||c.behavior,c=c.out_behavior||c.outBehavior||c.behavior);CubicVR.parseEnum(s.motion,b);CubicVR.parseEnum(s.motion,a);g.setBehavior(h,c)},setBehaviorArray:function(a,
b,h){var a=CubicVR.parseEnum(s.motion,a)||0,c=this.controllers[a],g;for(g in c)c.hasOwnProperty(g)&&this.envelope(a,CubicVR.parseEnum(s.motion,g)||0).setBehavior(b,h)}};return{Motion:q,Envelope:z,EnvelopeKey:y}});
CubicVR.RegisterModule("EventHandler",function(n){function y(g){g=CubicVR.parseEnum(s.event,g);if(g===r)return e("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1;if(!isNaN(parseInt(g,10))&&(g>=s.event.EVENT_MAX||g<0))return e("Unknown event ID passed: "+g),!1;return g}function z(g){g=g||{};this.name=g.name;g.id=y(g.id)||s.event.TICK;this.id=g.id;this.interval=g.interval||0;this.enabled=
g.enabled||!0;this.action=g.action||null;this.properties=g.properties||{};this.event_properties=g.event_properties||{};this.buffered=g.buffered||!1;this.weight=g.weight===r?-1:g.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function q(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}
var r=n.undef,s=CubicVR.enums,e=n.log;s.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};z.prototype={getName:function(){return this.name},setName:function(g){this.name=g},getSubject:function(){return this.subject},setSubject:function(g){this.subject=g},getId:function(){return this.id},setId:function(g){this.id=g},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},
enable:function(){this.setEnabled(!0)},setEnabled:function(g){if(g&&!this.enabled)this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1;this.enabled=g},isBuffered:function(){return this.buffered},setBuffered:function(g){this.buffered=g},setInterval:function(g){this.interval=g},getInterval:function(){return this.interval},setAction:function(g){this.action=g},getAction:function(){return this.action},getProperties:function(){return this.properties},
setProperties:function(g){this.properties=g},getProperty:function(g){return this.properties[g]},setProperty:function(g,a){this.properties[g]=a},setEventProperties:function(g){this.event_properties=g},getEventProperties:function(){return this.event_properties},getEventProperty:function(g){return this.event_properties[g]},setEventProperty:function(g,a){this.properties[g]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},
getSeconds:function(){return this.getTimeUpdated()},getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(g){this.t_rest=g},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(g){this.setRestInterval(g||0)},awake:function(){this.t_rest=0},update:function(g,a){if(!this.enabled)return!1;var b=0,c=!0;if(this.n_updates===0)this.t_updatecall=
this.t_update=g,b=1/60;else if(g!==this.t_update){if(!this.t_rest)this.t_last=g-this.t_update,this.t_update=g;b=g-this.t_updatecall;this.t_updatecall=g}else c=!1;if(this.t_rest>0){if(c&&(this.t_resting+=b,this.t_rest-=b,this.t_rest<0))this.t_rest=0}else{if(c){this.t_active+=this.t_last;if(!this.t_rest&&this.interval)this.t_rest=this.interval;this.n_updates++}this.callEvent(a);return!0}c&&this.n_updates++;return!1},callEvent:function(g){if(!this.action)return!1;return this.action(this,g)}};q.prototype=
{addEvent:function(g){g.callEvent||(g=new z(g));var a=g.getId();this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(g);this.listenerNames.indexOf(a)===-1&&this.listenerNames.push(a);return g},removeEvent:function(g){if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(g)==-1&&this.lockRemovals.push(g)}else{var a=this.events.indexOf(g);a!==-1&&(g=g.getId(),this.events.splice(a,1),this.listeners[g]--,
this.listeners[g]||(this.eventHandled[g]=!0,this.eventParameters[g]={},this.eventProperties[g]=[],this.eventPropertyCount[g]=0,a=this.listenerNames.indexOf(g),a>=0&&this.listenerNames.splice(a,1)))}},getProperties:function(g){this.eventParameters[g]=this.eventParameters[g]||{};return this.eventParameters[g]},setProperties:function(g,a){this.eventParameters[g]=a},getProperty:function(g,a){return this.getProperties(g)[a]},setProperty:function(g,a,b){this.getProperties(g)[a]=b},hasEvent:function(g){return!!this.listeners[g]},
triggerEvent:function(g,a){if(!this.listeners[g])return null;this.eventProperties[g]==r&&(this.eventProperties[g]=[]);var b=this.eventProperties[g];this.eventPropertyCount[g]===r&&(this.eventPropertyCount[g]=0);var c=this.eventPropertyCount[g];c>20&&console.log("Warning, event "+g+" count > 20: "+c);b[c]=a&&b?a:b[c]||{};this.eventPropertyCount[g]++;this.eventHandled[g]=!1;return b[c]},update:function(g){var a,b,c,d,f,h;if(this.hasEvent(s.event.TICK)&&this.eventPropertyCount[s.event.TICK]===0&&(a=
this.triggerEvent(s.event.TICK)))a.time=g,a.handler=this;this.lockState=!0;a=0;for(b=this.events.length;a<b;a++){f=this.events[a];h=f.getId();d=this.eventPropertyCount[h];var o=!1;c=!1;if(d){var m=this.eventProperties[h];if(f.isEnabled()){if(f.isBuffered()){if(m.length=d,f.setEventProperties(m),o=o||f.update(g,this),f.isChainBroken()){f.breakChain(!1);break}}else for(c=0;c<d;c++)if(f.setEventProperties(m[a]),o=o||f.update(g,this),f.isChainBroken()){f.breakChain(!1);break}c=!0}}if(o||!c)this.eventHandled[h]=
!0}a=0;for(b=this.listenerNames.length;a<b;a++)h=this.listenerNames[a],this.eventHandled[h]&&(this.eventPropertyCount[h]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(b=this.lockRemovals.length;a<b;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:z,EventHandler:q,registerEvent:function(g){g=g.toUpperCase();s.event[g]!==r?e("Error, event '"+g+"' is already registered."):(s.event[g]=s.event.ENUM_MAX,s.event.ENUM_MAX++)},validateEvent:y}});
CubicVR.RegisterModule("Scene",function(n){function y(a,b){return a.light_type-b.light_type}function z(f,c){var d=null,g;f!==s&&f!==null?f.compile?d={}:(d=n.get(f)||{},f=null):d={};this.morphWeight=d.morphWeight||0;this.morphSource=d.morphSource||-1;this.morphTarget=d.morphTarget||-1;this.position=d.position===s?[0,0,0]:d.position;this.rotation=d.rotation===s?[0,0,0]:d.rotation;this.scale=d.scale===s?[1,1,1]:d.scale;this.shadowCast=d.shadowCast===s?!0:d.shadowCast;this.wireframe=d.wireframe||!1;this.motion=
d.motion===s?null:n.get(d.motion,n.Motion)||null;this.obj=!d.mesh?f?n.get(f,n.Mesh):null:n.get(d.mesh,n.Mesh);this.name=d.name===s?c!==s?c:null:d.name;this.properties=n.get(d.properties)||{};this.parent=this.children=null;var e=d.children||d.child||d.sceneObject||d.sceneObjects;if(e){if(e&&!e.length||typeof e==="string")e=[e];if(e.length){d=0;for(g=e.length;d<g;d++)this.bindChild(n.get(e[d],n.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function q(a,b,c,g,e,x){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if(typeof a==="object"||typeof a==="string"){a=n.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+d;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((g=a.sceneObjects||a.sceneObject||a.objects)&&!g.length||typeof g==="string")g=[g];if(g&&g.length){b=0;for(c=g.length;b<c;b++)this.bindSceneObject(n.get(g[b],n.SceneObject))}if((g=a.lights||a.light)&&!g.length||typeof g==="string")g=[g];if(g&&g.length){b=0;for(c=g.length;b<c;b++)this.bindLight(n.get(g[b],n.Light))}if((g=a.cameras||
a.camera)&&!g.length||typeof g==="string")g=[g];if(g&&g.length){b=0;for(c=g.length;b<c;b++)this.bindCamera(n.get(g[b],n.Camera));this.camera=this.cameras[0]}if(!g)this.camera=new n.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip)}else this.skybox=null,this.octree=x,this.name="scene"+d,this.camera=new n.Camera(a,b,c,g,e),this.wireframe=!1;this.paused=!1;++d}function r(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var s=n.undef,e=n.enums,
g=n.GLCore,a=n.aabb,b=n.mat4,c=0;z.prototype={clone:function(){var a,b;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var c=new n.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(this.instanceMaterials!==null){c.instanceMaterials=
[];a=0;for(b=this.instanceMaterials.length;a<b;a++)c.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(this.children!==null){a=0;for(b=this.children.length;a<b;a++)c.bindChild(this.children[a].clone())}return c},evaluate:function(a){var b,c;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(this.children!==null){b=0;for(c=this.children.length;b<c;b++)this.children[b].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){if(!this.eventHandler)this.eventHandler=
new n.EventHandler;a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=
b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),c=0,d=b.length;c<d;c++)if(b[c].name==a)return b[c];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=
a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return this.obj.morphTargets!==null?this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){if(a){if(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(e.event.MATRIX_UPDATE)))a.triggerEvent(e.event.MATRIX_UPDATE).matrix=
this.tMatrix}else this.matrixLock=!1},doTransform:function(a){var c=n.vec3;if(!this.matrixLock&&(!c.equal(this.lposition,this.position)||!c.equal(this.lrotation,this.rotation)||!c.equal(this.lscale,this.scale)||a!==s))if(a!==s?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),this.scale[0]===1&&this.scale[1]===1&&this.scale[2]===
1||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(e.event.MOVE)))a=
a.triggerEvent(e.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale},adjust_octree:function(){var b=this.getAABB(),c=this.octree_aabb,d=b[0][0],g=b[0][1],e=b[0][2],x=b[1][0],t=b[1][1],v=b[1][2],q=c[0][0],n=c[0][1],r=c[0][2],w=c[1][0],u=c[1][1],c=c[1][2];if(this.octree_leaves.length>0&&(d<q||g<n||e<r||x>w||t>u||v>c)){for(d=0;d<this.octree_leaves.length;++d)this.octree_leaves[d].remove(this);
this.octree_leaves=[];this.static_lights=[];d=this.octree_common_root;this.octree_common_root=null;if(d!==null){for(;;)if(!d.contains_point(b[0])||!d.contains_point(b[1]))if(d._root!==s&&d._root!==null)d=d._root;else break;else break;a.reset(this.octree_aabb,this.position);d.insert(this)}}},bindChild:function(a){if(this.children===null)this.children=[];a.parent=this;this.children.push(a)},control:function(a,b,c){a===e.motion.POS?this.position[b]=c:a===e.motion.SCL?this.scale[b]=c:a===e.motion.ROT&&
(this.rotation[b]=c)},getAABB:function(){var a=n.mat4,b=n.vec3;if(this.dirty){var c=Array(8);this.doTransform();var d,g;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];d=this.obj.bb[0];g=this.obj.bb[1]}if(!this.obj||d===s||g===s)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var e=d;d=b.subtract(g,d);c[0]=[e[0],e[1],e[2]];c[1]=[e[0],e[1],e[2]+d[2]];c[2]=[e[0]+d[0],e[1],e[2]];c[3]=[e[0]+d[0],e[1],e[2]+d[2]];
c[4]=[e[0],e[1]+d[1],e[2]];c[5]=[e[0],e[1]+d[1],e[2]+d[2]];c[6]=[e[0]+d[0],e[1]+d[1],e[2]];c[7]=[e[0]+d[0],e[1]+d[1],e[2]+d[2]];e=a.vec3_multiply(c[0],this.tMatrix);d=[e[0],e[1],e[2]];g=[e[0],e[1],e[2]];for(b=1;b<8;++b)e=a.vec3_multiply(c[b],this.tMatrix),d[0]>e[0]&&(d[0]=e[0]),d[1]>e[1]&&(d[1]=e[1]),d[2]>e[2]&&(d[2]=e[2]),g[0]<e[0]&&(g[0]=e[0]),g[1]<e[1]&&(g[1]=e[1]),g[2]<e[2]&&(g[2]=e[2]);this.aabb[0]=d;this.aabb[1]=g;this.dirty=!1}return this.aabb}};var d=0;q.prototype={isWireframe:function(){return this.wireframe},
setWireframe:function(a){this.wireframe=a},attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var d=0,g=b.length;d<g;d++)this.bindLight(b[d]);b=this.sceneObjects;if(this.octree!==s){d=0;for(g=b.length;d<g;++d){var e=b[d];if(e.obj!==null){if(e.id<0)e.id=c,++c;this.sceneObjectsById[e.id]=e;a.reset(e.octree_aabb,e.position);this.octree.insert(e);(e.octree_common_root===void 0||e.octree_common_root===null)&&log("!!",e.name,"octree_common_root is null")}}}},setSkyBox:function(a){this.skybox=
a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,d,g){if(this.sceneObjects.indexOf(b)==-1){this.sceneObjects.push(b);d!==s&&d&&this.pickables.push(b);b.name!==null&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==s&&(g===s||g==="true")){if(b.id<0)b.id=c,++c;this.sceneObjectsById[b.id]=b;a.reset(b.octree_aabb,b.position);this.octree.insert(b)}if(b.children)for(var e=0,B=b.children.length;e<B;e++)this.bindSceneObject(b.children[e],d,g);return b}},removeLight:function(a){a=
this.lights.indexOf(a);a>=0&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState){if(!this.lockRemovals)this.lockRemovals=[];this.lockRemovals.indexOf(a)==-1&&this.lockRemovals.push(a)}else if(b=this.sceneObjects.indexOf(a),b>=0&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),b>=0&&this.pickables.splice(b,1),a.name!==null&&this.sceneObjectsByName[a.name]!==s&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}},
bindLight:function(a,b){this.lights.push(a);if(this.octree!==s&&(b===s||b==="true"))a.method===e.light.method.GLOBAL?this.global_lights.push(a):(a.method===e.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(y)},bindCamera:function(a){this.cameras.indexOf(a)===-1&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){typeof a!=="object"&&(a=this.getCamera(camName));this.cameras.indexOf(a)===-1&&(this.cameras.push(a),
this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof n.Light?this.bindLight(a):a instanceof n.SceneObject?this.bindSceneObject(a):a instanceof n.Camera?this.bindCamera(a):a instanceof n.Vehicle?a.bindToScene(this):a instanceof n.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof n.Light?this.removeLight(a):a instanceof n.SceneObject?this.removeSceneObject(a):a instanceof n.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},
setCamera:function(a){if(a)typeof a!=="object"&&(a=this.getCamera(a)),this.camera=a},getCamera:function(a){if(a===s)return this.camera;return this.camerasByName[a]},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&!this.sceneObjects[b].independentMotion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);if(this.camera.motion!==null){if(this.camera.targetSceneObject!==null)this.camera.target=this.camera.targetSceneObject.position;this.camera.motion.apply(a,
this.camera)}b=0;for(c=this.lights.length;b<c;b++){var d=this.lights[b];d.motion!==null&&d.motion.apply(a,d)}},prepareTransforms:function(a){var b,c;if(a){if(a.doTransform(),a.children){b=0;for(c=a.children.length;b<c;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(this.sceneObjects.length!==0){b=0;for(c=this.sceneObjects.length;b<c;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=g.gl;if(this.shadows_updated)return!1;else a||
this.doTransform(),this.shadows_updated=!0;if(n.features.lightShadows){for(var a=b.getParameter(b.FRAMEBUFFER_BINDING),c=!1,d=b.getParameter(b.VIEWPORT),B=0,q=this.lights.length;B<q;B++){var t=this.lights[B];if(t.light_type==e.light.type.SPOT_SHADOW||t.light_type==e.light.type.SPOT_SHADOW_PROJECTOR||t.light_type==e.light.type.AREA){var c=!0,v=[new n.Light(e.light.type.DEPTH_PACK)];if(t.light_type===e.light.type.AREA)t.areaCam=this.camera,t.updateAreaLight();g.shadow_near=t.dummyCam.nearclip;g.shadow_far=
t.dummyCam.farclip;t.shadowBegin();for(var r=0,s=this.sceneObjects.length;r<s;r++){var z=this.sceneObjects[r];z.parent||z.visible===!1||z.shadowCast===!1||this.renderSceneObject(z,t.dummyCam,v,!1,!0)}t.shadowEnd();a&&b.bindFramebuffer(b.FRAMEBUFFER,a)}}c&&b.viewport(d[0],d[1],d[2],d[3])}},updateCamera:function(){this.camera.manual===!1&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],
0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==s,b=0,c=this.sceneObjects.length;b<c;b++){var d=this.sceneObjects[b];if(d.parent===null&&(this.prepareTransforms(d),a&&(lights=[],d.dirty&&d.obj!==null&&d.adjust_octree(),!(d.visible===!1||a&&(d.ignore_octree||d.drawn_this_frame===!0||d.culled===!0))))){lights=d.dynamic_lights;
lights=lights.concat(d.static_lights);lights=lights.concat(this.global_lights);if(this.collect_stats)this.lights_rendered=Math.max(lights.length,this.lights_rendered),this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered;lights=lights.length===0?[g.emptyLight]:lights.sort(y);d.drawn_this_frame=!0}}},renderSceneObject:function(a,b,d,c,e,q,t){var v=!1,r=g.gl,c=c!==s&&c,e=e||!1,q=q||!1;if(a.visible&&a.obj){a.scale[0]<0&&(v=!v);a.scale[1]<0&&(v=!v);a.scale[2]<0&&(v=!v);v&&
r.cullFace(r.FRONT);var A=a.obj;if(A.morphTargets!==null&&(a.morphSource!==-1&&A.setMorphSource(a.morphSource),a.morphTarget!==-1&&A.setMorphTarget(a.morphTarget),a.morphWeight!==null))A.morphWeight=a.morphWeight;a.instanceMaterials&&A.bindInstanceMaterials(a.instanceMaterials);n.renderObject(A,b,a.tMatrix,d,e,q,this.isWireframe()||a.isWireframe())&&t&&t.push(a);a.instanceMaterials&&A.bindInstanceMaterials(null);v&&r.cullFace(r.BACK)}a=a.children;if(c&&a){c=0;for(v=a.length;c<v;c++)this.renderSceneObject(a[c],
b,d,!0,e,q,t)}},runEvents:function(a){var b,c;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(c=this.sceneObjects.length;b<c;b++){var d=this.sceneObjects[b];d.hasEvents()&&d.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(c=this.lockRemovals.length;b<c;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var c=g.gl,d;d=this.octree!==s;this.lights_rendered=
0;if(d)this.octree.reset_node_visibility(),this.octree.cleanup(),d=this.octree.get_frustum_hits(this.camera),this.lights_rendered=d.lights.length;this.doTransform();this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e;d=0;for(e=this.lights.length;d<e;d++)this.lights[d].prepare(this.camera);this.objects_rendered=0;var q=[],r=[],t=this.lights;d=0;for(e=this.sceneObjects.length;d<e;d++){var v=this.sceneObjects[d];v.visible===!1||v.parent!==null||this.renderSceneObject(v,this.camera,
t,!0,!0,!1,r)}d=0;for(e=r.length;d<e;d++)this.renderSceneObject(r[d],this.camera,t,!1,!1,!0);if(this.collect_stats)this.stats["objects.num_rendered"]=this.objects_rendered,this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=q,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length;if(this.skybox!==null&&this.skybox.ready===!0)c.cullFace(c.FRONT),d=this.camera.farclip*2/Math.sqrt(3),this.skybox.scene_object.position=
this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=[d,d,d],this.skybox.scene_object.doTransform(),n.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),c.cullFace(c.BACK);a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,b,d){var c=n.vec3,g=[],b=b.length===2?this.camera.unProject(b[0],
b[1]):c.add(a,b),e;for(e in this.pickables)if(this.pickables.hasOwnProperty(e)){var t=this.pickables[e];if(t.visible===!0){var v,q;q=t.getAABB();v=q[0];q=q[1];q[0]-v[0]<0.2&&(v[0]-=0.1,q[0]+=0.1);q[1]-v[1]<0.2&&(v[1]-=0.1,q[1]+=0.1);q[2]-v[2]<0.2&&(v[2]-=0.1,q[2]+=0.1);var r=c.multiply(c.add(v,q),0.5),s=c.getClosestTo(a,b,r),r=c.length(c.subtract(s,r));(s[0]>=v[0]&&s[0]<=q[0]?1:0)+(s[1]>=v[1]&&s[1]<=q[1]?1:0)+(s[2]>=v[2]&&s[2]<=q[2]?1:0)>=d&&g.push({dist:r,obj:t})}}g.length&&g.sort(function(a,b){if(a.dist==
b.dist)return 0;return a.dist<b.dist?-1:1});return g}};r.prototype={addMesh:function(a,b,d){this.meshBin[a]===s&&(this.meshBin[a]=[],this.meshBinPtr[a]===s&&(this.meshBinPtr[a]=0));this.meshMap[b]===s&&(this.meshMap[b]=d,this.meshBin[a].push(d))},addImage:function(a,b,d){this.imageBin[a]===s&&(this.imageBin[a]=[],this.imageBinPtr[a]===s&&(this.imageBinPtr[a]=0));this.imageMap[b]===s&&(this.imageMap[b]=d,this.imageBin[a].push(d))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},
rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];if(b<this.meshBin[a].length)return this.meshBinPtr[a]++,this.meshBin[a][b];return null},loadNextMesh:function(a){a=this.getNextMesh(a);if(a!==null)return a.compiled===null&&(a.triangulateQuads(),a.compile(),a.clean()),!0;return!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);
if(a!==null)a.src=a.deferredSrc},getNextImage:function(a){var b=this.imageBinPtr[a];if(b<this.imageBin[a].length)return this.imageBinPtr[a]++,this.imageBin[a][b];return null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:q,SceneObject:z,SkyBox:function(a){var b=a.texture,a=a.mapping,d=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/n.Images[d.texture.tex_id].width;if(d.mapping===null)d.mapping=
[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]];var a=new n.Material({name:"skybox",textures:{color:b},noFog:!0}),c=new n.Mesh;c.sky_mapping=d.mapping;n.primitives.box({mesh:c,size:1,material:a,uvmapper:{projectionMode:n.enums.uv.projection.SKY,scale:[1,1,1]}});c.prepare();d.scene_object=new n.SceneObject(c);d.ready=!0};if(b){if(typeof b==="string")b=new n.Texture(b,null,null,null,this.onready);else if(!b.loaded)b.onready=this.onready;this.texture=b;
if(a)this.mapping=a,this.onready()}},DeferredBin:r}});
CubicVR.RegisterModule("PostProcess",function(n){function y(a){if(a.shader_vertex===r)return null;if(a.shader_fragment===r)return null;this.outputMode=a.outputMode===r?e.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===r?null:a.onresize;this.onupdate=a.onupdate===r?null:a.onupdate;this.init=a.init===r?null:a.init;this.enabled=a.enabled===r?!0:a.enabled;this.outputDivisor=a.outputDivisor===r?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");this.init!==null&&this.init(this.shader)}function z(a,c,d){var f=s.gl;this.width=a;this.height=c;this.accum=d===r?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,c,!0);this.bufferA=new CubicVR.RenderBuffer(a,c,!1);this.bufferB=new CubicVR.RenderBuffer(a,
c,!1);this.bufferC=new CubicVR.RenderBuffer(a,c,!1);this.accumOpacity=1;this.accumIntensity=0.3;if(this.accum)this.accumBuffer=new CubicVR.RenderBuffer(a,c,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT),this.blur_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}});this.bufferA.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.bufferB.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,c)}function q(a,c,d){this.createBuffer(a,c,d)}var r=n.undef,s=n.GLCore,e=CubicVR.enums;e.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];z.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,c){var d=s.gl,f={},g=a/a,e=c/c;f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,g,0,g,e,0,e,0,0,g,e]);f.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
f.gl_points);d.bufferData(d.ARRAY_BUFFER,f.vbo_points,d.STATIC_DRAW);f.gl_uvs=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f.gl_uvs);d.bufferData(d.ARRAY_BUFFER,f.vbo_uvs,d.STATIC_DRAW);return f},destroyFSQuad:function(a){var c=s.gl;c.deleteBuffer(a.gl_points);c.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,c){var d=s.gl;a.use();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,c.gl_points);d.vertexAttribPointer(a.aVertex,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aVertex);
d.bindBuffer(d.ARRAY_BUFFER,c.gl_uvs);d.vertexAttribPointer(a.aTex,2,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aTex);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.drawArrays(d.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&b.outputDivisor!=1&&g[b.outputDivisor]===r){var c=this.width/b.outputDivisor|0,d=this.height/b.outputDivisor|0;g[b.outputDivisor]=new CubicVR.RenderBuffer(c,d,!1);a[b.outputDivisor]=
this.makeFSQuad(c,d)}},resize:function(b,c){var d=s.gl;this.width=b;this.height=c;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT));for(var f in g){var d=this.width/f|0,h=this.height/f|0;g[f].destroyBuffer();g[f].createBuffer(d,h,!1);this.destroyFSQuad(a[f]);a[f]=this.makeFSQuad(d,h)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;f=0;for(d=this.shaders.length;f<d;f++)if(this.shaders[f].shader.use(),this.shaders[f].shader.setVector("texel",this.vTexel),this.shaders[f].onresize!==null)this.shaders[f].onresize(this.shaders[f].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var c=s.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT))},end:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=s.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var c=0,d=0,f=this.shaders.length;d<f;d++){var h=this.shaders[d];if(h.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var o=h.outputMode;if(o===e.post.output.REPLACE)h.outputDivisor!==1?g[h.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(o===e.post.output.ADD||
o===e.post.output.BLEND)h.outputDivisor!==1?g[h.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);h.onupdate!==null&&(h.shader.use(),h.onupdate(h.shader));h.outputDivisor!==1?(b.viewport(0,0,g[h.outputDivisor].width,g[h.outputDivisor].height),this.renderFSQuad(h.shader,a[h.outputDivisor]),h.outputMode===e.post.output.REPLACE?(this.outputBuffer.use(),g[h.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(h.shader,this.fsQuad);o===e.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):o===e.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),h.outputDivisor!==1?g[h.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();c++}}c===0?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&this.accumOpacity!==1?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};q.prototype={createBuffer:function(a,
c,d){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(c,10);var a=this.sizeParam(a),c=this.sizeParam(c),f=s.gl;this.fbo=f.createFramebuffer();if(d)this.depth=f.createRenderbuffer();f.bindFramebuffer(f.FRAMEBUFFER,this.fbo);d&&(f.bindRenderbuffer(f.RENDERBUFFER,this.depth),navigator.appVersion.indexOf("Windows")!==-1?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,c),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depth)):
(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,c),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;f.bindTexture(f.TEXTURE_2D,n.Textures[this.texture.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texImage2D(f.TEXTURE_2D,
0,f.RGBA,a,c,0,f.RGBA,f.UNSIGNED_BYTE,null);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,n.Textures[this.texture.tex_id],0);f.bindFramebuffer(f.FRAMEBUFFER,null)},destroyBuffer:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(n.Textures[this.texture.tex_id]);n.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:q,PostProcessShader:y,PostProcessChain:z,fsQuad:{make:z.prototype.makeFSQuad,destroy:z.prototype.destroyFSQuad,render:z.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function n(n){this.texture=n.texture?n.texture:null;this.width=n.width?n.width:128;this.height=n.height?n.height:128;this.x=n.x?n.x:0;this.y=n.y?n.y:0;this.blend=n.blend?n.blend:!1;this.opacity=typeof n.opacity!=="undefined"?n.opacity:1;this.tint=n.tint?n.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function y(n){this.texture=n.texture?n.texture:null;this.width=n.width?n.width:128;this.height=n.height?n.height:128;
this.x=n.x?n.x:0;this.y=n.y?n.y:0;this.blend=n.blend?n.blend:!1;this.opacity=typeof n.opacity!=="undefined"?n.opacity:1;this.tint=n.tint?n.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}n.prototype={addSubview:function(n){this.childViews.push(n);n.superView=this},makePanel:function(n){return this.superView.makePanel(n)}};y.prototype={resize:function(n,q){this.width=n;this.height=q},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(n){n.setInt("srcTex",0);n.addVector("screen");n.addVector("position");n.addVector("tint");n.addVector("size")}})},addSubview:function(n){this.childViews.push(n);n.superView=this},removeSubview:function(n){n=this.childViews.indexOf(n);n>-1&&this.childViews.splice(n,
1)},makePanel:function(n){var q=CubicVR.GLCore.gl,r={};r.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);r.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);r.gl_points=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,r.gl_points);q.bufferData(q.ARRAY_BUFFER,r.vbo_points,q.STATIC_DRAW);r.gl_uvs=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,r.gl_uvs);q.bufferData(q.ARRAY_BUFFER,r.vbo_uvs,q.STATIC_DRAW);n.panel=r},renderPanel:function(n){if(!n.texture)return!1;n.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(n){if(n.texture){var q=CubicVR.GLCore.gl,r=n.offsetLeft,s=n.offsetTop;r||(r=0);s||(s=0);var e=this.shader.shader;e.use();e.setVector("screen",[this.width,this.height,0]);e.setVector("position",[n.x+r,n.y+s,0]);e.setVector("size",[n.width,n.height,0]);e.setVector("tint",n.tint);n.blend&&(q.enable(q.BLEND),q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA));n.texture.use(q.TEXTURE0);q.drawArrays(q.TRIANGLES,0,6);n.blend&&(q.disable(q.BLEND),q.blendFunc(q.ONE,q.ZERO))}},render:function(){var n=
CubicVR.GLCore.gl;n.disable(n.DEPTH_TEST);this.texture&&this.renderView(this);var q=[];this.offsetTop=this.offsetLeft=0;q.push(this);var r=this.shader.shader;r.use();n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);n.bindBuffer(n.ARRAY_BUFFER,this.panel.gl_points);n.vertexAttribPointer(r.uniforms.aVertex,3,n.FLOAT,!1,0,0);n.enableVertexAttribArray(r.uniforms.aVertex);n.bindBuffer(n.ARRAY_BUFFER,this.panel.gl_uvs);n.vertexAttribPointer(r.uniforms.aTex,2,n.FLOAT,!1,0,0);n.enableVertexAttribArray(r.uniforms.aTex);
for(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);q.length;){var s=q.pop();this.renderView(s);if(s.childViews.length)for(var e=s.childViews.length-1;e>=0;e--)s.childViews[e].offsetLeft=s.x+s.offsetLeft,s.childViews[e].offsetTop=s.y+s.offsetTop,q.push(s.childViews[e])}n.disableVertexAttribArray(r.uniforms.aTex);n.enable(n.DEPTH_TEST)}};return{Layout:y,View:n}});
CubicVR.RegisterModule("Primitives",function(n){function y(a,b,c,g,h,e){var q=n.mat4,r=n.vec3,s=[],w,u=[0,1,0],z=[1,0,0],E=[0,0,0],D=a.points.length,y,I,G;for(y=w=0;y<f;y+=f/c){if(w===c)break;z=[Math.cos(y),0,Math.sin(y)];I=0;for(G=b.length;I<G;I++)E=r.add(r.multiply(z,b[I][0]),r.multiply(u,b[I][1])),s[w]===d&&(s[w]=[]),s[w].push(E);w++}G=null;h!==d&&(G=h.getResult!==d?h.getResult():h);for(I=0;I<c;I++){h=0;for(w=b.length;h<w;h++)G?a.addPoint(q.vec3_multiply(s[I][h],G)):a.addPoint(s[I][h])}typeof g===
"string"&&(g=new n.Material(g));a.setFaceMaterial(g);for(h=0;h<c;h++){I=0;for(G=b.length-1;I<G;I++)q=I+b.length*h,s=I+b.length*((h+1)%c),r.equal(a.points[D+q],a.points[D+s])?a.addFace([D+q+1,D+s+1,D+s]):r.equal(a.points[D+q+1],a.points[D+s+1])?a.addFace([D+q,D+q+1,D+s]):a.addFace([D+q,D+q+1,D+s+1,D+s])}e!==d&&(b=null,e.apply!==d?b=e:e&&(b=new n.UVMapper(e)),b!==null&&(a.calcFaceNormals(),b.apply(a,g)))}function z(a,b,c,f,g){var h=n.mat4;b*=0.5;var e=a.points.length;typeof c==="string"&&(c=new n.Material(c));
a.setFaceMaterial(c);f!==d?(f=f.getResult!==d?f.getResult():f,a.addPoint([h.vec3_multiply([b,-b,0],f),h.vec3_multiply([b,b,0],f),h.vec3_multiply([-b,b,0],f),h.vec3_multiply([-b,-b,0],f)])):a.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);a.addFace([[e+0,e+1,e+2,e+3],[e+3,e+2,e+1,e+0]]);g!==d&&(h=null,g.apply!==d?h=g:g&&(h=new n.UVMapper(g)),h!==null&&(a.calcFaceNormals(),h.apply(a,c)))}function q(a,b,c,f,g){var h=n.mat4,e,q;typeof b==="object"?(e=b[0]/2,q=b[1]/2,b=b[2]/2):e=q=b/=2;var r=a.points.length;
typeof c==="string"&&(c=new n.Material(c));a.setFaceMaterial(c);f!==d?(f=f.getResult!==d?f.getResult():f,a.addPoint([h.vec3_multiply([e,-q,b],f),h.vec3_multiply([e,q,b],f),h.vec3_multiply([-e,q,b],f),h.vec3_multiply([-e,-q,b],f),h.vec3_multiply([e,-q,-b],f),h.vec3_multiply([e,q,-b],f),h.vec3_multiply([-e,q,-b],f),h.vec3_multiply([-e,-q,-b],f)])):a.addPoint([[e,-q,b],[e,q,b],[-e,q,b],[-e,-q,b],[e,-q,-b],[e,q,-b],[-e,q,-b],[-e,-q,-b]]);a.addFace([[r+0,r+1,r+2,r+3],[r+7,r+6,r+5,r+4],[r+4,r+5,r+1,r+0],
[r+5,r+6,r+2,r+1],[r+6,r+7,r+3,r+2],[r+7,r+4,r+0,r+3]]);g!==d&&(h=null,g.apply!==d?h=g:g&&(h=new n.UVMapper(g)),h!==null&&(a.calcFaceNormals(),h.apply(a,c)))}function r(a,b,c,d,g,h,e,q){var r=[];c-=b;b+=c/2;for(var s=f/g,u=0,z=0;z<=g;z++)r.push([b+Math.cos(u)*c,Math.sin(u)*c,0]),u+=s;n.genLatheObject(a,r,d,h,e,q)}function s(a,b,c,d,f,g,h){n.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],d,f,g,h)}function e(a,b,c,d,f,g,h){n.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],d,f,g,h)}
function g(a,b,c,d,f,g,e){var q=[],d=(d/=2)|0;c|=0;for(var r=Math.PI/d,s=-h,u=0;u<=d;u++)q.push([Math.cos(s)*b,Math.sin(s)*b,0]),s+=r;n.genLatheObject(a,q,c,f,g,e)}function a(a){typeof a==="string"&&(a=n.get(a,n.Material));if(a===d)return new n.Material;return a.use?a:typeof a==="object"?new n.Material(a):new n.Material}function b(a){if(a===d)return d;if(typeof a==="array")return a;if(typeof a==="object")return a.getResult?a.getResult():a.position||a.rotation||a.scale?n.mat4.transform(a.position,
a.rotation,a.scale):d}function c(a){typeof a==="string"&&(a=n.get(a));if(a===d)return d;return a.apply?a:typeof a==="object"?new n.UVMapper(a):d}var d=n.undef,f=2*Math.PI,h=Math.PI/2;return{genPlaneObject:z,genBoxObject:q,genLatheObject:y,genTorusObject:r,genConeObject:s,genCylinderObject:e,genSphereObject:g,primitives:{lathe:function(f){var g,h,e,t;if(f.points==d)return null;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);e=b(f.transform);t=c(f.uvmapper||f.uv);y(g,f.points,f.divisions!==
d?f.divisions:24,h,e,t);return g},box:function(f){var g,h,e,t;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);e=b(f.transform);t=c(f.uvmapper||f.uv);q(g,f.size!==d?f.size:1,h,e,t);return g},plane:function(f){var g,h,e,t;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);e=b(f.transform);t=c(f.uvmapper||f.uv);z(g,f.size!==d?f.size:1,h,e,t);return g},sphere:function(f){var h,e,q,t;h=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);e=a(f.material);q=b(f.transform);
t=c(f.uvmapper||f.uv);g(h,f.radius!==d?f.radius:1,f.lon!==d?f.lon:24,f.lat!==d?f.lat:24,e,q,t);return h},torus:function(f){var g,h,e,t;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);e=b(f.transform);t=c(f.uvmapper||f.uv);r(g,f.innerRadius!==d?f.innerRadius:0.75,f.outerRadius!==d?f.outerRadius:1,f.lon!==d?f.lon:24,f.lat!==d?f.lat:24,h,e,t);return g},cone:function(f){var g,h,e,t;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);e=b(f.transform);t=c(f.uvmapper||
f.uv);s(g,f.base!==d?f.base:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,h,e,t);return g},cylinder:function(f){var g,h,q,t;g=f.mesh!==d?f.mesh:new n.Mesh(f.name!==d?f.name:d);h=a(f.material);q=b(f.transform);t=c(f.uvmapper||f.uv);e(g,f.radius!==d?f.radius:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,h,q,t);return g}}}});
CubicVR.RegisterModule("COLLADA",function(n){function y(g,a){function b(a){if(!a.color)return!1;return(a=a.color)?d.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function c(a){var B;if(!a["float"])return!1;return B=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0,a=B}var d=n.util,f,h,o,m,r;r=typeof g=="object"?g:g.indexOf(".js")!=-1?d.getJSON(g):n.util.xml2badgerfish(d.getXML(g));var x,t,v,C,A,y,w,u,F,E,D,O=r;r=null;if(!O.COLLADA)throw Error(g+
" does not appear to be a valid COLLADA file.");O=O.COLLADA;r={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(O.asset){var I=O.asset.up_axis.$;if(I==="X_UP")r.up_axis=0;else if(I==="Y_UP")r.up_axis=1;else if(I==="Z_UP")r.up_axis=2}I=r.up_axis;if(O.library_images){if(O.library_images.image&&!O.library_images.image.length)O.library_images.image=[O.library_images.image];if(O.library_images.image.length){h=O.library_images.image;f=0;for(u=h.length;f<
u;f++){var G=h[f],J=G["@id"];C=G["@name"];G=G.init_from;if(G.$)G=G.$,a!==z&&G.lastIndexOf("/")!==-1&&(G=G.substr(G.lastIndexOf("/")+1)),a!==z&&G.lastIndexOf("\\")!==-1&&(G=G.substr(G.lastIndexOf("\\")+1)),r.images[J]={source:G,id:J,name:C}}}}var H,L,K,S,W;if(O.library_effects){var N=O.library_effects.effect;N&&!N.length&&(N=[N]);G=0;for(H=N.length;G<H;G++){u=N[G];C=u["@id"];m={};m.id=C;m.surfaces=[];m.samplers=[];(J=u.profile_COMMON.newparam)&&!J.length&&(J=[J]);if(J){h=0;for(f=J.length;h<f;h++){var Q=
J[h],P=Q["@sid"];if(Q.surface){if(m.surfaces[P]={},Q=Q.surface.init_from.$,typeof r.images[Q]==="object")m.surfaces[P].source=a+"/"+r.images[Q].source}else if(Q.sampler2D){m.samplers[P]={};m.samplers[P].source=Q.sampler2D.source.$;if(Q.sampler2D.minfilter)m.samplers[P].minfilter=Q.sampler2D.minfilter.$;if(Q.sampler2D.magfilter)m.samplers[P].magfiter=Q.sampler2D.magfilter.$}}}(h=u.profile_COMMON.technique)&&!h.length&&(h=[h]);m.material={textures_ref:[]};u=0;for(J=h.length;u<J;u++){f=h[u].blinn;if(!f)f=
h[u].phong;if(!f)f=h[u].lambert;if(f)for(w in f){var T=f[w],P=b(T),Q=c(T);T=T.texture?T.texture["@texture"]:!1;P!==!1&&P.length>3&&P.pop();if(w=="emission"){if(P!==!1)m.material.ambient=P}else if(w!="ambient")if(w=="diffuse"){if(P!==!1)m.material.color=P}else if(w=="specular"){if(P!==!1)m.material.specular=P}else if(w=="shininess"&&Q!==!1)m.material.shininess=Q;if(T!==!1)P=m.surfaces[m.samplers[T].source].source,w=="emission"?m.material.textures_ref.push({image:P,type:q.texture.map.AMBIENT}):w=="ambient"?
m.material.textures_ref.push({image:P,type:q.texture.map.AMBIENT}):w=="diffuse"?m.material.textures_ref.push({image:P,type:q.texture.map.COLOR}):w=="specular"?m.material.textures_ref.push({image:P,type:q.texture.map.SPECULAR}):w!="shininess"&&(w=="reflective"?m.material.textures_ref.push({image:P,type:q.texture.map.REFLECT}):w!="reflectivity"&&w=="transparent"&&m.material.textures_ref.push({image:P,type:q.texture.map.ALPHA}))}r.effects[C]=m}}}u=e.getAllOf(O,"instance_geometry");w=[];if(u.length){f=
0;for(h=u.length;f<h;f++)if(J=u[f],C=e.getAllOf(J,"instance_material"),C.length){D=0;for(y=C.length;D<y;D++)H=C[D],G=H["@symbol"],H=H["@target"].substr(1),w[J["@url"].substr(1)+":"+G]=H}}if((h=O.library_materials)&&h.material){(u=h.material)&&!u.length&&(u=[u]);h=0;for(f=u.length;h<f;h++)if(C=u[h],J=C["@id"],G=C["@name"],C=C.instance_effect)C=C["@url"].substr(1),r.materials.push({id:J,name:G,mat:r.effects[C].material})}h=O.library_geometries;var Y;if(h&&((C=h.geometry)&&!C.length&&(C=[C]),C.length)){G=
0;for(H=C.length;G<H;G++){var N={id:z,points:[],parts:[]},Z=C[G].mesh;if(Z){Y=C[G]["@id"];m=C[G]["@name"];(f=Z.source)&&!f.length&&(f=[f]);m=[];u=0;for(J=f.length;u<J;u++)if(P=f[u],h=P["@id"],Q=P["@name"],(T=P.float_array)&&(m[h]={id:h,name:Q,data:d.floatDelimArray(T.$?T.$:""," ")}),P=P.technique_common.accessor)if(m[h].count=P["@count"]|0,m[h].stride=P["@stride"]|0,m[h].count)m[h].data=d.repackArray(m[h].data,m[h].stride,m[h].count);h=Z.vertices;var R=T=Q=P=null,$=null;if(h&&(Q=h["@id"],(f=h.input)&&
!f.length&&(f=[f]),f)){v=0;for(L=f.length;v<L;v++)K=f[v],K["@semantic"]==="POSITION"&&(P=K["@source"].substr(1))}var U=Z.triangles;U&&!U.length&&(U=[U]);if(U){u=0;for(J=U.length;u<J;u++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};h=parseInt(U[u]["@count"],10);(f=U[u].input)&&!f.length&&(f=[f]);S=[];if(f.length){v=0;for(L=f.length;v<L;v++)K=f[v],A=parseInt(K["@offset"],10),o=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(o===Q&&(o=P),S[A]=0):K["@semantic"]==="NORMAL"?(T=o,m[T].count&&
(S[A]=1)):K["@semantic"]==="TEXCOORD"?($=o,m[$].count&&(S[A]=2)):K["@semantic"]==="COLOR"?(R=o,m[R].count&&(S[A]=3)):S[A]=4}v=S.length;f=Y+":"+U[u]["@material"];f===null?W.material=0:w[f]===z?(s("missing material ["+f+"]@"+Y+"?"),W.material=0):W.material=w[f];f=U[u].p;v=[];f&&(v=d.intDelimArray(f.$," "));if(v.length&&(f=v.length/S.length/3,f===h)){if(N.points.length===0)N.points=m[P].data;f=A=0;h=v.length;for(A=S.length;f<h;f+=A*3){x=[];t=[];o=[];K=[];for(D=0;D<A*3;D++)L=D%A,S[L]===0?t.push(v[f+D]):
S[L]===1?x.push(v[f+D]):S[L]===2?o.push(v[f+D]):S[L]===3&&K.push(v[f+D]);t.length&&(W.faces.push(t),x.length===3&&W.normals.push([e.fixuaxis(r.up_axis,m[T].data[x[0]]),e.fixuaxis(r.up_axis,m[T].data[x[1]]),e.fixuaxis(r.up_axis,m[T].data[x[2]])]),o.length===3&&W.texcoords.push([m[$].data[o[0]],m[$].data[o[1]],m[$].data[o[2]]]),K.length===3&&W.colors.push([m[R].data[K[0]],m[R].data[K[1]],m[R].data[K[2]]]))}}N.parts.push(W)}}U=Z.polylist;if(!U)U=Z.polygons;U&&!U.length&&(U=[U]);if(U){u=0;for(J=U.length;u<
J;u++){W={material:0,faces:[],normals:[],texcoords:[],colors:[]};D=parseInt(U[u]["@count"],10);(f=U[u].input)&&!f.length&&(f=[f]);S=[];if(f.length){v=0;for(L=f.length;v<L;v++)K=f[v],h=K["@offset"],h===null&&(h=K["@idx"]),A=parseInt(h,10),o=K["@source"].substr(1),K["@semantic"]==="VERTEX"?(o===Q&&(o=P),S[A]=0):K["@semantic"]==="NORMAL"?(T=o,S[A]=1):K["@semantic"]==="TEXCOORD"?($=o,S[A]=2):K["@semantic"]==="COLOR"?(R=o,S[A]=3):S[A]=4}h=U[u].vcount;Z=[];h&&(Z=d.intDelimArray(h.$," "));f=Y+":"+U[u]["@material"];
W.material=f===z?0:w[f];K=U[u].p;v=S.length;L=[];if(K.length>1&&!Z.length){h=0;for(f=K.length;h<f;h++)A=d.intDelimArray(K[h].$," "),Z[h]=parseInt(A.length/v,10),L=L.concat(A)}else K&&(L=d.intDelimArray(K.$," "));if(L.length)if(f=Z.length,f!==D)s("poly vcount data doesn't add up, skipping object load: "+f+" !== "+D);else{if(N.points.length===0)N.points=m[P].data;f=A=0;for(h=Z.length;f<h;f++){x=[];t=[];o=[];K=[];D=0;for(y=Z[f]*v;D<y;D++)S[D%v]===0?t.push(L[A]):S[D%v]===1?x.push(L[A]):S[D%v]===2?o.push(L[A]):
S[D%v]===3&&K.push(L[A]),A++;if(t.length){W.faces.push(t);if(x.length){D=[];y=0;for(t=x.length;y<t;y++)D.push(e.fixuaxis(r.up_axis,m[T].data[x[y]]));W.normals.push(D)}if(o.length){D=[];y=0;for(t=o.length;y<t;y++)D.push(m[$].data[o[y]]);W.texcoords.push(D)}if(K.length){D=[];y=0;for(t=K.length;y<t;y++)D.push(m[R].data[K[y]]);W.colors.push(D)}}}}N.parts.push(W)}}if(I!==1){f=0;for(h=N.points.length;f<h;f++)N.points[f]=e.fixuaxis(r.up_axis,N.points[f])}N.id=Y;r.meshes.push(N)}}}if(h=O.library_cameras){(C=
h.camera)&&!C.length&&(C=[C]);w=0;for(u=C.length;w<u;w++){h=C[w];G=h["@id"];H=J=f=0;if(h.optics&&h.optics.technique_common&&h.optics.technique_common.perspective)f=h.optics.technique_common.perspective.yfov,J=h.optics.technique_common.perspective.znear,H=h.optics.technique_common.perspective.zfar;var V;if(!f&&!J&&!H){(J=h.param)&&!J.length&&(J=[J]);f=0;for(h=J.length;f<h;f++)H=J[f].$,N=J[f]["@name"],N=="YFOV"?V=parseFloat(H):N=="ZNEAR"?F=parseFloat(H):N=="ZFAR"&&(E=parseFloat(H))}else V=f?parseFloat(f.$):
60,F=J?parseFloat(J.$):0.1,E=H?parseFloat(H.$):1E3;r.cameras.push({id:G,targeted:!1,fov:parseFloat(V),nearclip:parseFloat(F),farclip:parseFloat(E)})}}if(V=O.library_lights)if((V=V.light)&&!V.length&&(V=[V]),V){F=0;for(E=V.length;F<E;F++)if(f=V[F],w=(h=f.technique_common.point)?h:null,h=f["@id"],w!==null)f=(f=w.intensity)?parseFloat(f.$):1,u=(u=w.distance)?parseFloat(u.$):10,w=w.color,K=[1,1,1],w&&(K=d.floatDelimArray(w.$," ")),r.lights.push({id:h,name:h,type:q.light.type.POINT,method:q.light.method.STATIC,
diffuse:K,specular:[0,0,0],distance:u,intensity:f})}if(F=O.library_visual_scenes){V=null;(V=F.visual_scene)&&!V.length&&(V=[V]);F=0;for(E=V.length;F<E;F++){C=V[F];w={id:C["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]};u=[];var J=[],X;if(h=O.library_nodes){(H=h.node)&&!H.length&&(H=[H]);u=[];f=0;for(h=H.length;f<h;f++)G=H[f],mnodeId=G["@id"],u[X]=G;for(G=[C];G.length;){H=G.pop();if(H.node&&((D=H.node)&&!D.length&&(D=[D]),D)){f=0;for(h=D.length;f<h;f++)G.push(D[f])}if(H.instance_node){(N=
H.instance_node)&&!N.length&&(N=[N]);f=0;for(h=N.length;f<h;f++)if(m=N[f]["@url"].substr(1),u[m]){if(H.node&&H.node.length)H.node=[H.node];H.node?H.node.push(u[m]):H.node=[u[m]]}}}}for(G=[C];G.length;)if(H=G.pop(),H.node&&((D=H.node)&&!D.length&&(D=[D]),D)){f=0;for(h=D.length;f<h;f++)D[f].parentNode=H,J.push(D[f]),G.push(D[f])}if(J.length){C=0;for(G=J.length;C<G;C++){P=J[C];Q=P.instance_geometry;f=J[C].instance_light;h=J[C].instance_camera;X=P["@id"];H=P["@name"];N=e.cl_getInitalTransform(r.up_axis,
P);if(I===2)N.rotation=e.quaternionFilterZYYZ(N.rotation,h?[-90,0,0]:z);R=T=null;if(Q){Q&&!Q.length&&(Q=[Q]);f=0;for(h=Q.length;f<h;f++){m=Q[f]["@url"].substr(1);R={};R.name=(H?H:X)+(f?f:"");R.id=(X?X:H)+(f?f:"");R.meshId=Y;R.meshName=m;if(!T)R.position=N.position,R.rotation=N.rotation,R.scale=N.scale,R.matrix=N.matrix;w.sceneObjects.push(R);u[R.id]=!0;P.parentNode&&((m=P.parentNode["@id"])&&u[m]?w.parentMap.push({parent:m,child:R.id}):Q.length>1&&(T?u[T.id]&&w.parentMap.push({parent:T.id,child:R.id}):
(T=R,R={})))}}else h?(h=h["@url"].substr(1),w.cameras.push({name:H?H:X,id:H?H:X,source:h,position:N.position,rotation:N.rotation})):f?(h=f["@url"].substr(1),w.lights.push({name:H?H:X,id:H?H:X,source:h,position:N.position})):(R={position:N.position,rotation:N.rotation,scale:N.scale,matrix:N.matrix},R.name=H?H:X,R.id=X?X:H,w.sceneObjects.push(R),u[R.id]=!0,P.parentNode&&(m=P.parentNode["@id"])&&u[m]&&w.parentMap.push({parent:m,child:R.id}))}}r.scenes.push(w)}}if(Y=O.library_animations)if((X=Y.animation)&&
!X.length&&(X=[X]),X){I=0;for(V=X.length;I<V;I++){w=X[I];Y=w["@id"];r.animations[Y]={};r.animations[Y].sources=[];(u=w.source)&&!u.length&&(u=[u]);if(u.length){F=0;for(E=u.length;F<E;F++){f=u[F];h=f["@id"];N=f.technique_common;C=J=null;f.name_array?J=d.textDelimArray(f.name_array.$," "):f.Name_array?J=d.textDelimArray(f.Name_array.$," "):f.float_array&&(C=d.floatDelimArray(f.float_array.$," "));f=0;H="";G=1;if(N)f=N,N=f.accessor,f=parseInt(N["@count"],10),H=N["@source"].substr(1),(N=N["@stride"])&&
(G=parseInt(N,10));r.animations[Y].sources[h]={data:J?J:C,count:f,source:H,stride:G};if(G!==1)r.animations[Y].sources[h].data=d.repackArray(r.animations[Y].sources[h].data,G,f)}}(u=w.sampler)&&!u.length&&(u=[u]);if(u){r.animations[Y].samplers=[];F=0;for(E=u.length;F<E;F++)if(h=u[F],J=h["@id"],(f=h.input)&&!f.length&&(f=[f]),f){G=[];C=0;for(h=f.length;C<h;C++)K=f[C],G[K["@semantic"]]=K["@source"].substr(1);r.animations[Y].samplers[J]=G}}(F=w.channel)&&!F.length&&(F=[F]);if(F){r.animations[Y].channels=
[];w=0;for(u=F.length;w<u;w++)h=F[w],E=h["@source"].substr(1),h=h["@target"],J=h.split("/"),f=J[0],J=J[1].split("."),r.animations[Y].channels.push({source:E,target:h,targetName:f,paramName:J[0],typeName:J[1]})}}}if(O=O.scene)if(C=O.instance_visual_scene)O=C["@url"].substr(1),r.scene=O;return r}var z=n.undef,q=n.enums,r=n.GLCore,s=n.log,e={fixuaxis:function(g,a){if(g===0)return[a[1],a[0],a[2]];else if(g===1)return a;else if(g===2)return[a[0],a[2],-a[1]]},fixscaleaxis:function(g,a){if(g===0)return[a[1],
a[0],a[2]];else if(g===1)return a;else if(g===2)return[a[0],a[2],a[1]]},fixukaxis:function(g,a,b,c){if(a===q.motion.POS&&b===q.motion.Z&&g===q.motion.Z)return-c;return c},getAllOf:function(g,a){for(var b=[g],c=[],d,f,h,e;b.length;)for(f in d=b.pop(),d)if(d.hasOwnProperty(f)){if(f===a)if(d[f].length){h=0;for(e=d[f].length;h<e;h++)c.push(d[f][h])}else c.push(d[f]);if(typeof d[f]=="object")if(d[f].length){h=0;for(e=d[f].length;h<e;h++)b.push(d[f][h])}else b.push(d[f])}return c},quaternionFilterZYYZ:function(g,
a){var b=n.vec3,c=g,d=new n.Quaternion;a!==z&&(c=b.add(g,a));d.fromEuler(c[0],c[2],-c[1]);return d.toEuler()},cl_getInitalTransform:function(g,a){var b=n.util,c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d=a.translate,f=a.rotate,h=a.scale;if(a.matrix&&!d&&!f&&!h)return c;if(d&&d.$)c.position=e.fixuaxis(g,b.floatDelimArray(d.$," "));if(f)for(var d=0,o=f.length;d<o;d++){var m=f[d],r=m["@sid"],m=b.floatDelimArray(m.$," ");if(r=="rotateX"||r=="rotationX")c.rotation[0]=m[3];else if(r=="rotateY"||
r=="rotationY")c.rotation[1]=m[3];else if(r=="rotateZ"||r=="rotationZ")c.rotation[2]=m[3]}if(h)c.scale=e.fixscaleaxis(g,b.floatDelimArray(h.$," "));return c}};return{loadCollada:function(g,a,b){var a=y(g,a,b),c=a.up_axis,d=[],f,h,o,m,s,x,t,v;h=0;for(o=a.materials.length;h<o;h++){s=a.materials[h];t=new n.Material(s.mat);t.name=s.name||null;x=0;for(m=s.mat.textures_ref.length;x<m;x++){v=s.mat.textures_ref[x];var C=null,C=n.Textures_ref[v.image]===void 0?new n.Texture(v.image,r.default_filter,b,g):n.Textures_obj[n.Textures_ref[v.image]];
t.setTexture(C,v.type)}d[s.id]=t}x=[];h=0;for(o=a.meshes.length;h<o;h++){var C=a.meshes[h],A=new n.Mesh({name:C.id});A.points=C.points;var M=!1;t=0;for(v=C.parts.length;t<v;t++){var w=C.parts[t];w.material!==0&&((m=d[w.material])||(m=new n.Material({name:w.material})),A.setFaceMaterial(m));var u=w.normals.length?!0:!1,F=w.texcoords.length?!0:!1,E=w.colors.length?!0:!1;if(E)d[w.material].color_map=!0;m=0;for(s=w.faces.length;m<s;m++){var D=A.addFace(w.faces[m]);if(u)A.faces[D].point_normals=w.normals[m];
if(F)A.faces[D].uvs=w.texcoords[m];if(E)A.faces[D].point_colors=w.colors[m]}M|=u}A.faces.length&&(b?b.addMesh(g,g+":"+meshId,A):(M||A.calcNormals(),A.triangulateQuads(),A.compile()),x[C.id]=A)}o=[];g=0;for(m=a.cameras.length;g<m;g++)o[a.cameras[g].id]=a.cameras[g];C=[];m=0;for(s=a.lights.length;m<s;m++)C[a.lights[m].id]=a.lights[m];b={};d={};h={};g={};t=0;for(v=a.scenes.length;t<v;t++){A=a.scenes[t];M=new n.Scene;m=0;for(s=A.sceneObjects.length;m<s;m++)w=A.sceneObjects[m],u=new n.SceneObject(w),u.obj=
(x[w.meshName]?x[w.meshName]:x[w.meshId])||null,w.matrix&&u.setMatrix(w.matrix),b[w.id]=u,M.bindSceneObject(u);m=0;for(s=A.lights.length;m<s;m++)w=A.lights[m],u=new n.Light(C[w.source]),u.position=w.position,d[w.id]=u,M.bindLight(u);if(A.cameras.length)m=A.cameras[0],s=new n.Camera(o[m.source]),s.position=m.position,s.rotation=m.rotation,h[m.id]=s,M.camera=s;m=0;for(s=A.parentMap.length;m<s;m++)w=A.parentMap[m],b[w.parent].bindChild(b[w.child]);g[A.id]=M}for(var O in a.animations)if(a.animations.hasOwnProperty(O)&&
(x=a.animations[O],x.channels.length)){cCount=0;for(m=x.channels.length;cCount<m;cCount++){o=x.channels[cCount];w=x.samplers[o.source];s=x.sources[w.INPUT];t=x.sources[w.OUTPUT];v=x.sources[w.INTERPOLATION];var C=x.sources[w.IN_TANGENT],A=x.sources[w.OUT_TANGENT],M=w.IN_TANGENT!==z,w=w.OUT_TANGENT!==z,u=null,E=b[o.targetName],F=h[o.targetName],I=d[o.targetName];if(E){if(E.motion===null)E.motion=new n.Motion;u=E.motion}else if(F){if(F.motion===null)F.motion=new n.Motion;u=F.motion}else if(I){if(I.motion===
null)I.motion=new n.Motion;u=I.motion}if(u!==null){E=q.motion.POS;D=q.motion.X;if(c===2)u.yzflip=!0;f=o.paramName;if(f==="rotateX"||f==="rotationX")E=q.motion.ROT,D=q.motion.X;else if(f==="rotateY"||f==="rotationY")E=q.motion.ROT,D=q.motion.Y;else if(f==="rotateZ"||f==="rotationZ")E=q.motion.ROT,D=q.motion.Z;else if(f==="location"){E=q.motion.POS;if(o.typeName==="X")D=q.motion.X;if(o.typeName==="Y")D=q.motion.Y;if(o.typeName==="Z")D=q.motion.Z}else if(f==="translate"){E=q.motion.POS;if(o.typeName===
"X")D=q.motion.X;if(o.typeName==="Y")D=q.motion.Y;if(o.typeName==="Z")D=q.motion.Z}else if(f==="LENS")continue;else if(f==="FOV")E=q.motion.FOV,D=3;else if(f==="ZNEAR")E=q.motion.NEARCLIP,D=3;else if(f==="ZFAR")E=q.motion.FARCLIP,D=3;else if(f==="intensity")E=q.motion.INTENSITY,D=3;if(I&&E<3)I.method=q.light.method.DYNAMIC;mCount=0;for(o=s.data.length;mCount<o;mCount++)if(k=null,typeof t.data[mCount]==="object"){i=0;for(iMax=t.data[mCount].length;i<iMax;i++)if(I=i,c===2&&i===2?I=1:c===2&&i===1&&(I=
2),k=u.setKey(E,I,s.data[mCount],e.fixukaxis(a.up_axis,E,I,t.data[mCount][i])),v)if(f=v.data[mCount][i],f==="LINEAR")k.shape=q.envelope.shape.LINE;else if(f==="BEZIER")k.shape=!M&&!w?q.envelope.shape.LINEAR:q.envelope.shape.BEZI}else if(I=D,ofs=0,F&&E===q.motion.ROT&&c===2&&I===0&&(ofs=-90),E===q.motion.ROT?k=u.setKey(E,I,s.data[mCount],t.data[mCount]+ofs):(c===2&&D===2?I=1:c===2&&D===1&&(I=2),k=u.setKey(E,I,s.data[mCount],e.fixukaxis(a.up_axis,E,I,t.data[mCount]))),v)if(f=v.data[mCount],f==="LINEAR")k.shape=
q.envelope.shape.LINE;else if(f==="BEZIER")if(!M&&!w)k.shape=q.envelope.shape.LINEAR,k.continutity=1;else{k.shape=q.envelope.shape.BEZ2;f=C.data[mCount][0];var G,J=A.data[mCount][0];E===q.motion.ROT?(G=C.data[mCount][1],I=A.data[mCount][1],k.param[0]=f-k.time,k.param[1]=G-k.value+ofs,k.param[2]=J-k.time,k.param[3]=I-k.value+ofs):(G=e.fixukaxis(a.up_axis,E,I,C.data[mCount][1]),I=e.fixukaxis(a.up_axis,E,I,A.data[mCount][1]),k.param[0]=f-k.time,k.param[1]=G-k.value,k.param[2]=J-k.time,k.param[3]=I-k.value)}}}}O=
null;return O=a.scene?g[a.scene]:g.pop()},parseCollada:y}});
CubicVR.RegisterModule("GML",function(n){function y(n){var r=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(n!==z){var n=r.getXML(n),s=n.getElementsByTagName("header");if(!s.length)return null;var e=s[0],s=n.getElementsByTagName("environment");if(!s.length)return null;this.name=null;e=e.getElementsByTagName("name");if(e.length)this.name=r.collectTextNode(e[0]);e=s[0].getElementsByTagName("screenBounds");if(e.length)this.bounds=
[parseFloat(r.collectTextNode(e[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(e[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(e[0].getElementsByTagName("z")[0]))];e=s[0].getElementsByTagName("origin");if(e.length)this.origin=[parseFloat(r.collectTextNode(e[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(e[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(e[0].getElementsByTagName("z")[0]))];s=s[0].getElementsByTagName("up");if(s.length)this.upvector=
[parseFloat(r.collectTextNode(s[0].getElementsByTagName("x")[0])),parseFloat(r.collectTextNode(s[0].getElementsByTagName("y")[0])),parseFloat(r.collectTextNode(s[0].getElementsByTagName("z")[0]))];n=n.getElementsByTagName("drawing");s=0;for(e=n.length;s<e;s++)for(var g=n[s].getElementsByTagName("stroke"),a=0,b=0,c=0,d=0,f=0,h=g.length;f<h;f++){for(var o=g[f].getElementsByTagName("pt"),m=o.length,B=Array(m),x,t,v,C=0,A=m;C<A;C++)v=o[C],m=parseFloat(r.collectTextNode(v.getElementsByTagName("x")[0])),
x=parseFloat(r.collectTextNode(v.getElementsByTagName("y")[0])),t=parseFloat(r.collectTextNode(v.getElementsByTagName("z")[0])),v=parseFloat(r.collectTextNode(v.getElementsByTagName("time")[0])),this.upvector[0]===1?B[C]=[x!==x?0:x,m!==m?0:-m,t!==t?0:t,v]:this.upvector[1]===1?B[C]=[m!==m?0:m,x!==x?0:x,t!==t?0:t,v]:this.upvector[2]===1&&(B[C]=[m!==m?0:m,t!==t?0:-t,x!==x?0:x,v]),a<m&&(a=m),b<x&&(b=x),c<t&&(c=t),d<v&&(d=v);if(c>d){o=0;for(C=B.length;o<C;o++)m=B[o][3],B[o][3]=B[o][2],B[o][2]=m/this.bounds[2]}this.strokes[f]=
B}}}var z=n.undef;y.prototype={addStroke:function(n,r){var s=[];r===z&&(r=0.1);for(var e=0,g=n.length;e<g;e++){var a=[n[e][0],n[e][1],n[e][2]];this.manual_pos+=r;a.push(this.manual_pos);s.push(a)}this.strokes.push(s)},recenter:function(){var n=CubicVR.vec3,r=[0,0,0],s=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],e,g,a,b;a=0;for(b=this.strokes.length;a<b;a++){e=0;for(g=this.strokes[a].length;e<g;e++)r[0]>this.strokes[a][e][0]&&(r[0]=this.strokes[a][e][0]),r[1]>this.strokes[a][e][1]&&
(r[1]=this.strokes[a][e][1]),r[2]>this.strokes[a][e][2]&&(r[2]=this.strokes[a][e][2]),s[0]<this.strokes[a][e][0]&&(s[0]=this.strokes[a][e][0]),s[1]<this.strokes[a][e][1]&&(s[1]=this.strokes[a][e][1]),s[2]<this.strokes[a][e][2]&&(s[2]=this.strokes[a][e][2])}n=n.multiply(n.subtract(s,r),0.5);a=0;for(b=this.strokes.length;a<b;a++){e=0;for(g=this.strokes[a].length;e<g;e++)this.strokes[a][e][0]-=n[0],this.strokes[a][e][1]-=this.upvector[1]?n[1]:-n[1],this.strokes[a][e][2]-=n[2]}},generateObject:function(n,
r,s,e,g){var a=CubicVR.vec3;n===z&&(n=0);r===z&&(r=0);g===z&&(g=!1);e===z&&(e=0.02);s===z&&(s=0.015);for(var b=r!==0,c=0,d=0,f=new CubicVR.Mesh(this.name),h,o,m,B,x,t,v=0,C=this.strokes.length;v<C;v++){t=new CubicVR.Envelope;var A=new CubicVR.Envelope,y=new CubicVR.Envelope,w=this.strokes[v].length,u=0,F=[],E=[],D=0,O=this.strokes[v];for(x=0;x<w;x++){var I=O[x],G=t.addKey(I[3],I[0]),J=A.addKey(I[3],I[1]),H;H=g?y.addKey(I[3],I[2]):y.addKey(I[3],0);G.tension=0.5;J.tension=0.5;H.tension=0.5;x!==0?(h=
I[0]-h,o=I[1]-o,m=I[2]-m,B=I[3]-B,m=Math.sqrt(h*h+o*o+m*m),u+=m,F[x-1]=m,E[x-1]=B):D=I[3];h=I[0];o=I[1];m=I[2];B=I[3]}u=D;w=f.points.length;for(x=0;x<F.length;x++){D=E[x];O=u;I=u+D;for(G=D/Math.ceil(F[x]/e*3);O<I-G;O+=G){O===u&&(h=t.evaluate(O),o=A.evaluate(O),m=y.evaluate(O));var L,J=t.evaluate(O+G);H=A.evaluate(O+G);L=y.evaluate(O+G);var K;K=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([J-h,H-o,L-m]))),s/2);f.addPoint([h-K[0],-(o-K[1]),m-K[2]+(b?r/2:0)]);f.addPoint([h+K[0],-(o+K[1]),
m+K[2]+(b?r/2:0)]);h=J;o=H;m=L}u+=D}A=f.points.length;if(b){x=w;for(t=A;x<t;x++)f.addPoint([f.points[x][0],f.points[x][1],f.points[x][2]-(b?r/2:0)])}x=0;for(t=A-w;x<=t-4;x+=2)c%n===0&&d++,f.setSegment(d),y=[w+x,w+x+1,w+x+3,w+x+2],f.addFace(y),b&&(y=[y[3]+A-w,y[2]+A-w,y[1]+A-w,y[0]+A-w],f.addFace(y),y=[w+x,w+x+2,w+x+2+A-w,w+x+A-w],f.addFace(y),y=[w+x+1+A-w,w+x+3+A-w,w+x+3,w+x+1],f.addFace(y),x===0&&(y=[w+x+A-w,w+x+1+A-w,w+x+1,w+x],f.addFace(y)),x===t-4&&(y=[w+x+2,w+x+3,w+x+3+A-w,w+x+2+A-w],f.addFace(y))),
c++}f.calcFaceNormals();f.triangulateQuads();f.calcNormals();f.compile();return f}};return{GML:y}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(n){if(!n.src)throw"PDF Error: you must specify a src url for a PDF.";var y=n.src,z=n.callback||function(){},q,r=[],s=[];this.__defineGetter__("pages",function(){return q?q.numPages:0});this.getPage=function(e){var g=q.numPages,e=e<1?1:e,e=e>g?g:e;e-=1;return r[e]};this.getPageTexture=function(e,g,a){e=this.getPage(e);g=g||e.width;a=a||e.height;return new CubicVR.PdfTexture(e,{width:g,height:a})};getPdf({url:y,error:function(){console.log("PDF Error: error loading pdf `"+
y+"`")}},function(e){q=new PDFDoc(e);for(var e=1,g=q.numPages;e<=g;e++){var a=q.getPage(e);r.push(a);s.push(a)}z()})}}});
CubicVR.RegisterModule("Particles",function(n){function y(n,q,e,g,a,b,c){if(n){this.last_particle=this.particles=null;this.pTex=e!==z?e:null;this.vWidth=g;this.vHeight=a;this.alpha=b!==z?b:!1;this.alphaCut=c!==z?c:0;this.pfunc=function(a,b){var c=b-a.start_time;if(c<0)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];this.pgov!==null&&this.pgov(a,
b);return 1};this.pgov=null;this.hasColor=q===z?!1:q;e=this.pTex!==null;this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",e?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",e?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",e?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n");this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",e?"uniform sampler2D pMap;":"","varying vec4 color;",e?"varying vec2 screenPos;":"",e?"uniform vec3 screenDim;":"",e?"varying float pSize;":"","void main(void) {\nvec4 c = color;",e?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",e?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",e?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n");this.maxPoints=n;this.numParticles=0;this.arPoints=new Float32Array(n*3);this.glPoints=null;if(q)this.arColor=new Float32Array(n*3),this.glColor=null;this.shader_particle=new CubicVR.Shader(this.vs,this.fs);this.shader_particle.use();this.shader_particle.addVertexArray("aVertexPosition");
this.hasColor&&this.shader_particle.addVertexArray("aColor");this.shader_particle.addMatrix("uMVMatrix");this.shader_particle.addMatrix("uPMatrix");this.pTex!==null&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0]));this.genBuffer()}}var z=n.undef,q=n.GLCore;y.prototype={resizeView:function(n,q){this.vWidth=n;this.vHeight=q;this.pTex!==null&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,q,0]))},addParticle:function(n){this.last_particle===null?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var n=q.gl;this.glPoints=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW);if(this.hasColor)this.glColor=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW)},updatePoints:function(){var n=q.gl;n.bindBuffer(n.ARRAY_BUFFER,
this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW)},updateColors:function(){var n=q.gl;this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},draw:function(n,s,e){var g=q.gl;this.shader_particle.use();this.pTex!==null&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",n);this.shader_particle.setMatrix("uPMatrix",s);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(e!==z){this.numParticles=0;if(this.particles===null){g.disable(g.BLEND);return}for(var n=this.particles,s=null,a=0;n!==null;){var b=this.numParticles*
3,c=this.pfunc(n,e);if(c===1){if(this.arPoints[b]=n.pos[0],this.arPoints[b+1]=n.pos[1],this.arPoints[b+2]=n.pos[2],n.color!==null&&this.arColor!==z&&(this.arColor[b]=n.color[0],this.arColor[b+1]=n.color[1],this.arColor[b+2]=n.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else if(c===-1){if(s!==null)s.nextParticle=n.nextParticle}else c===0&&a++;s=n;n=n.nextParticle}if(!a)this.last_particle=this.particles=null;this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&
(g.enable(g.BLEND),g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:y,Particle:function(n,q,e,g,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(g!==z?g:[0,0,0]);this.accel=new Float32Array(a!==z?a:[0,0,
0]);this.start_time=q!==z?q:0;this.life_time=e!==z?e:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("HeightField",function(n){function y(q){q=q||{};q=n.get(q);this.size=q.size;this.material=q.material||new n.Material;this.divX=q.divX|0;this.divZ=q.divZ|0;this.obj=null;this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*this.divX:this.size,this.sizeZ=this.size)}var z=n.undef;n.enums.heightfield={};y.prototype={getMesh:function(){if(this.obj===null)this.obj=this.genMesh();return this.obj},setIndexedHeight:function(n,
r,s){obj.points[n+r*this.divX][1]=s},genMesh:function(){var q=new n.Mesh({dynamic:!0,buildWireframe:!0}),r,s;for(s=-(this.sizeZ/2);s<this.sizeZ/2;s+=this.sizeZ/this.divZ)for(r=-(this.sizeX/2);r<this.sizeX/2;r+=this.sizeX/this.divX)q.addPoint([r+this.sizeX/this.divX/2,0,s+this.sizeZ/this.divZ/2]);q.setFaceMaterial(this.material);for(s=0;s<this.divZ-1;s++)for(r=0;r<this.divX-1;r++)q.addFace([r+(s+1)*this.divX,r+1+s*this.divX,r+s*this.divX]),q.addFace([r+(s+1)*this.divX,r+1+(s+1)*this.divX,r+1+s*this.divX]);
return q},mapGen:function(n){var r=n.src||function(){return 0},s=n.startX||0,e=n.startZ||0,g=n.walkX,n=n.walkZ,a;if(s!==z&&e!==z&&g!==z&&n!==z){if(!(s>=this.divX)&&!(e>=this.divZ)&&(s+g>=this.divX&&(g=this.divX-1-s),e+n>=this.divZ&&(n=this.divZ-1-e),!(g<=0||n<=0))){a=s;for(g=s+g;a<g;a++)for(var b=e,c=e+n;b<c;b++){var d=a+b*this.divX,s=this.obj.points[d];s[1]=r(s[0],s[2],d)}}}else{a=0;for(g=this.obj.points.length;a<g;a++)s=this.obj.points[a],s[1]=r(s[0],s[2],a)}},getFaceAt:function(n,r){if(typeof n===
"object")return this.getFaceAt(n[0],n[2]);var s=this.sizeZ/2-this.sizeZ/this.divZ/2,e=parseInt(Math.floor((n+(this.sizeX/2-this.sizeX/this.divX/2))/this.sizeX*this.divX),10),s=parseInt(Math.floor((r+s)/this.sizeZ*this.divZ),10);if(e<0)return-1;if(e>=this.divX-1)return-1;if(s<0)return-1;if(s>=this.divZ-1)return-1;var e=parseInt(e+s*(this.divX-1),10)*2,s=parseInt(e+1,10),g=this.obj.points[this.obj.faces[e].points[0]];return Math.abs(r-g[2])/Math.abs(n-g[0])>=1?e:s},getHeightValue:function(q,r){var s=
n.triangle;if(typeof q==="object")return this.getHeightValue(q[0],q[2]);var e,g=this.getFaceAt(q,r);if(g===-1)return 0;e=this.obj.points[this.obj.faces[g].points[0]];var a=s.normal(this.obj.points[this.obj.faces[g].points[0]],this.obj.points[this.obj.faces[g].points[1]],this.obj.points[this.obj.faces[g].points[2]]),s=a[0],g=a[1],a=a[2];return(s*q+a*r+(-(s*e[0])-g*e[1]-a*e[2]))/-g}};return{HeightField:y}});
CubicVR.RegisterModule("Landscape",function(n){var y=n.undef,z=Math.PI/2;return{Landscape:n.extendClassGeneral(n.SceneObject,function(q,r,s,e){this.heightfield=new n.HeightField({size:q,divX:r,divZ:s,material:e});n.SceneObject.apply(this,[{mesh:this.heightfield.getMesh()}])},{setIndexedHeight:function(n,r,s){this.obj.points[n+r*this.divisions_w][1]=s},mapGen:function(n,r,s,e,g){this.heightfield.mapGen({src:n,startX:r,startZ:s,walkX:e,walkZ:g})},getFaceAt:function(n,r){return this.heightfield.getFaceAt([n,
0,r])},getHeightValue:function(n,r){return this.heightfield.getHeightValue([n,0,r])},orient:function(n,r,s,e,g,a){a===y&&(a=0);var b,c,d=[];b=s/2;var f=e/2;c=Math.sqrt(f*f+b*b);f=Math.atan2(f,b);g*=Math.PI/180;b=n+Math.sin(g)*a;a=r+Math.cos(g)*a;d[0]=this.getHeightValue([b+c*Math.cos(-f-z+g),0,a+c*-Math.sin(-f-z+g)]);d[1]=this.getHeightValue([b+c*Math.cos(f-z+g),0,a+c*-Math.sin(f-z+g)]);d[2]=this.getHeightValue([b+c*Math.cos(-f+z+g),0,a+c*-Math.sin(-f+z+g)]);d[3]=this.getHeightValue([b+c*Math.cos(f+
z+g),0,a+c*-Math.sin(f+z+g)]);c=-Math.atan2(d[1]-d[2],s);a=-Math.atan2(d[0]-d[1],e);c+=-Math.atan2(d[0]-d[3],s);a+=-Math.atan2(d[3]-d[2],e);c/=2;a/=2;return[[n,(d[2]+d[3]+d[1]+d[0])/4,r],[c*(180/Math.PI),g,a*(180/Math.PI)]]}})}});
CubicVR.RegisterModule("Octree",function(n){function y(a,c,d,f,g){var e=this._children=[];this._dirty=!1;e[0]=null;e[1]=null;e[2]=null;e[3]=null;e[4]=null;e[5]=null;e[6]=null;e[7]=null;this._child_index=g||-1;this._root=d||null;this._max_depth=c||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];c=this._bbox=[[0,0,0],[0,0,0]];d=n.aabb;d.reset(c,f);a/=2;d.engulf(c,[f[0]+a,f[1]+
a,f[2]+a]);d.engulf(c,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function z(){this.position=[0,0,0];this.visible=!1;this._object=null}function q(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;a<6;++a)this._planes[a]=[0,0,0,0]}var r=n.undef,s=n.plane,e=n.sphere,g=n.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,c,d){d=a.slice((d||c)+1||a.length);
a.length=c<0?a.length+c:c;return a.push.apply(a,d)};y.prototype.destroy=function(){var a,c,d;a=0;for(c=this._static_lights.length;a<c;++a)d=this._static_lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;a=0;for(c=this._lights.length;a<c;++a)d=this._lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(c=this._children.length;a<c;++a)this._children[a]!==null&&this._children[a].destroy();a=0;for(c=this._nodes.length;a<
c;++a)d=this._nodes[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null,d.dynamic_lights=[],d.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};y.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};y.prototype.remove=function(b){var c=!1,d=this._nodes.length,f;f=d-1;for(d=this._nodes.length;f>=0;--f)if(b===this._nodes[f]){a(this._nodes,f);this.dirty_lineage();c=!0;break}if(!c)for(f=d-1;f>=0;--f)if(b===this._lights[f]){a(this._lights,f);this.dirty_lineage();break}};y.prototype.dirty_lineage=function(){this._dirty=!0;this._root!==null&&
this._root.dirty_lineage()};y.prototype.cleanup=function(){for(var a=this._children.length,c=0,d=0;d<a;++d){var f=this._children[d];if(f!==null){var g=!0;f._dirty===!0&&(g=f.cleanup());g?++c:this._children[d]=null}}if(this._nodes.length===0&&this._static_lights.length===0&&this._lights.length===0&&(c===0||a===0))return!1;return!0};y.prototype.insert_light=function(a){this.insert(a,!0)};y.prototype.propagate_static_light=function(a){var c,d;c=0;for(d=this._nodes.length;c<d;++c)this._nodes[c].static_lights.indexOf(a)===
-1&&this._nodes[c].static_lights.push(a);for(c=0;c<8;++c)this._children[c]!==null&&this._children[c].propagate_static_light(a)};y.prototype.collect_static_lights=function(a){var c,d;c=0;for(d=this._static_lights.length;c<d;++c)a.static_lights.indexOf(this._static_lights[c])===-1&&a.static_lights.push(this._static_lights[c]);for(c=0;c<8;++c)this._children[c]!==null&&this._children[c].collect_static_lights(a)};y.prototype.insert=function(a,c){function d(a,b,c,d){var f,e;if(c)if(b.method===g.light.method.STATIC){a._static_lights.indexOf(b)===
-1&&a._static_lights.push(b);c=0;for(f=a._nodes.length;c<f;++c)a._nodes[c].static_lights.indexOf(b)===-1&&a._nodes[c].static_lights.push(b);for(e=a._root;e!==null;){c=0;for(l=e._nodes.length;c<l;++c)f=e._nodes[c],f.static_lights.indexOf(b)===-1&&f.static_lights.push(b);e=e._root}}else a._lights.indexOf(b)===-1&&a._lights.push(b);else{a._nodes.push(b);c=0;for(f=a._static_lights.length;c<f;++c)b.static_lights.indexOf(a._static_lights[c])===-1&&b.static_lights.push(a._static_lights[c]);for(e=a._root;e!==
null;){c=0;for(f=e._static_lights.length;c<f;++c){var h=e._static_lights[c];b.static_lights.indexOf(h)===-1&&b.static_lights.push(h)}e=e._root}}b.octree_leaves.push(a);b.octree_common_root=d;d=n.aabb;d.engulf(b.octree_aabb,a._bbox[0]);d.engulf(b.octree_aabb,a._bbox[1])}c===r&&(c=!1);if(this._root===null)a.octree_leaves=[],a.octree_common_root=null;if(this._max_depth===0)d(this,a,c,this._root);else{var f=this._position,e,o,m,q,s,t,v;o=a.getAABB();v=[o[0][0],o[0][1],o[0][2]];var C=[o[1][0],o[1][1],
o[1][2]];e=v[0]<f[0]&&v[1]<f[1]&&v[2]<f[2];o=C[0]>f[0]&&v[1]<f[1]&&v[2]<f[2];s=v[0]<f[0]&&C[1]>f[1]&&v[2]<f[2];t=C[0]>f[0]&&C[1]>f[1]&&v[2]<f[2];m=v[0]<f[0]&&v[1]<f[1]&&C[2]>f[2];q=C[0]>f[0]&&v[1]<f[1]&&C[2]>f[2];v=v[0]<f[0]&&C[1]>f[1]&&C[2]>f[2];f=C[0]>f[0]&&C[1]>f[1]&&C[2]>f[2];if(e&&o&&s&&t&&m&&q&&v&&f)d(this,a,c,this),c?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var C=0,A=this._static_lights.length;C<A;++C){if(a.static_lights===r)a.static_lights=
[];a.static_lights.indexOf(this._static_lights[C])===-1&&a.static_lights.push(this._static_lights[C])}var C=this._size/2,A=this._size/4,z=0,w=this._position[0],u=this._position[1],F=this._position[2];e&&(e=[w-A,u-A,F-A],this._children[g.octree.TOP_NW]===null&&(this._children[g.octree.TOP_NW]=new y(C,this._max_depth-1,this,e,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,c),++z);o&&(e=[w+A,u-A,F-A],this._children[g.octree.TOP_NE]===null&&(this._children[g.octree.TOP_NE]=new y(C,this._max_depth-
1,this,e,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,c),++z);s&&(e=[w-A,u+A,F-A],this._children[g.octree.BOTTOM_NW]===null&&(this._children[g.octree.BOTTOM_NW]=new y(C,this._max_depth-1,this,e,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,c),++z);t&&(e=[w+A,u+A,F-A],this._children[g.octree.BOTTOM_NE]===null&&(this._children[g.octree.BOTTOM_NE]=new y(C,this._max_depth-1,this,e,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,c),++z);m&&(e=[w-A,u-A,
F+A],this._children[g.octree.TOP_SW]===null&&(this._children[g.octree.TOP_SW]=new y(C,this._max_depth-1,this,e,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,c),++z);q&&(e=[w+A,u-A,F+A],this._children[g.octree.TOP_SE]===null&&(this._children[g.octree.TOP_SE]=new y(C,this._max_depth-1,this,e,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,c),++z);v&&(e=[w-A,u+A,F+A],this._children[g.octree.BOTTOM_SW]===null&&(this._children[g.octree.BOTTOM_SW]=new y(C,this._max_depth-1,this,
e,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,c),++z);f&&(e=[w+A,u+A,F+A],this._children[g.octree.BOTTOM_SE]===null&&(this._children[g.octree.BOTTOM_SE]=new y(C,this._max_depth-1,this,e,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,c),++z);if(z>1||a.octree_common_root===null)a.octree_common_root=this}}};y.prototype.draw_on_map=function(a,c,d){function f(a,b,f,d,m){var n=a<f?a:f,t=b<d?b:d,a=a<f?f-a:a-f,b=b<d?d-b:b-d;c.save();if(m!==void 0)c.fillStyle=m,c.fillRect(g+
n,e+t,a,b);c.strokeRect(g+n,e+t,a,b);c.restore()}var g=a.width/2,e=a.height/2,m,n,q,t,v,s,A;if(d===r||d==="map")c.save(),this._debug_visible!==!1?(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="#FF0000"):(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="rgba(0,0,0,0)"),c.beginPath(),v=this._size/2,m=this._position[0],n=this._position[2],c.moveTo(g+m-v,g+n-v),c.lineTo(g+m-v,g+n+v),c.lineTo(g+m+v,g+n+v),c.lineTo(g+m+v,g+n-v),c.stroke(),c.fill(),c.restore();if(d===r||d==="objects"){c.save();v=0;for(A=this._nodes.length;v<
A;++v)s=this._nodes[v],c.fillStyle="#5500FF",c.strokeStyle=s.visible===!0&&s.culled===!1?"#FFFFFF":"#000000",c.beginPath(),m=s.aabb[0][0],n=s.aabb[0][2],q=s.aabb[1][0]-m,t=s.aabb[1][2]-n,c.rect(g+m,e+n,q,t),c.stroke();c.restore()}if(d===r||d==="lights"){v=0;for(A=this._lights.length;v<A;++v)t=this._lights[v],c.fillStyle=t.culled===!1&&t.visible===!0?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FFFF00",c.beginPath(),s=t.distance,m=t.position[0],n=t.position[2],c.arc(g+m,e+
n,s,0,Math.PI*2,!0),c.closePath(),c.stroke(),c.fill(),c.beginPath(),m=t.aabb[0][0],n=t.aabb[0][2],q=t.aabb[1][0]-m,t=t.aabb[1][2]-n,c.rect(g+m,e+n,q,t),c.closePath(),c.stroke();v=0;for(A=this._static_lights.length;v<A;++v)t=this._static_lights[v],c.fillStyle=t.culled===!1&&t.visible===!0?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FF66BB",c.beginPath(),s=t.distance,m=t.position[0],n=t.position[2],c.arc(g+m,e+n,s,0,Math.PI*2,!0),c.closePath(),c.stroke(),c.fill(),c.beginPath(),
m=t.aabb[0][0],n=t.aabb[0][2],q=t.aabb[1][0]-m,t=t.aabb[1][2]-n,c.rect(g+m,e+n,q,t),c.closePath(),c.stroke()}if(d!="lights"&&d!="objects"&&d!="map"){c.save();m=this._nodes;v=0;for(t=m.length;v<t;++v)if(s=m[v],s.name==d){c.strokeStyle="#FFFF00";c.lineWidth=3;c.beginPath();m=s.aabb[0][0];n=s.aabb[0][2];q=s.aabb[1][0]-m;t=s.aabb[1][2]-n;c.rect(g+m,e+n,q,t);c.closePath();c.stroke();m=s.octree_aabb;c.strokeStyle="#0000FF";f(m[0][0],m[0][2],m[1][0],m[1][2]);c.lineWidth=1;if(s.common_root!==null)c.strokeStyle=
"#00FF00";break}c.lineWidth=1;c.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");c.fill();c.restore()}v=0;for(A=this._children.length;v<A;++v)this._children[v]!==null&&this._children[v].draw_on_map(a,c,d)};y.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=this._position[1]-this._size/2&&a[2]>=
this._position[2]-this._size/2};y.prototype.get_frustum_hits=function(a,c){var d={objects:[],lights:[]};if((c===r||c===!0)&&!this.contains_point(a.position)){if(e.intersects(a.frustum.sphere,this._sphere)===!1)return d;var f=a.frustum.contains_sphere(this._sphere);if(f===-1)return this._debug_visible=!1,d;else if(f===1)this._debug_visible=2,c=!1;else if(f===0)if(this._debug_visible=!0,f=a.frustum.contains_box(this._bbox),f===-1)return this._debug_visible=!1,d;else if(f===1)this._debug_visible=3,c=
!1}var g,o,f=0;for(g=this._nodes.length;f<g;++f)o=this._nodes[f],d.objects.push(o),o.dynamic_lights=[].concat(this._lights),o.was_culled=o.culled,o.culled=!1,o.drawn_this_frame=!1;this._debug_visible=this._lights.length>0?4:this._debug_visible;f=0;for(g=this._lights.length;f<g;++f)if(o=this._lights[f],o.visible===!0)d.lights.push(o),o.was_culled=o.culled,o.culled=!1;f=0;for(g=this._static_lights.length;f<g;++f)if(o=this._static_lights[f],o.visible===!0)o.culled=!1;for(f=0;f<8;++f)if(this._children[f]!==
null){g=this._children[f].get_frustum_hits(a,c);var m;o=0;for(m=g.objects.length;o<m;++o){d.objects.push(g.objects[o]);for(var n=g.objects[o].dynamic_lights,q=0,t=this._lights.length;q<t;++q)n.indexOf(this._lights[q])<0&&n.push(this._lights[q])}o=0;for(m=g.lights.length;o<m;++o)d.lights.indexOf(g.lights[o])<0&&d.lights.push(g.lights[o])}return d};y.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,c;a=0;for(c=this._nodes.length;a<c;++a)this._nodes[a].culled=!0;a=0;for(c=this._lights.length;a<
c;++a)this._lights[a].culled=!0;a=0;for(c=this._static_lights.length;a<c;++a)this._static_lights[a].culled=!0;a=0;for(c=this._children.length;a<c;++a)this._children[a]!==null&&this._children[a].reset_node_visibility()};z.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};z.prototype.attach=function(a){this._object=a};q.prototype.extract=function(a,c,d){var f=n.vec3;if(!(c===r||d===r)){var e=n.mat4.multiply(d,c),c=this._planes;c[g.frustum.plane.LEFT][0]=e[3]+e[0];c[g.frustum.plane.LEFT][1]=
e[7]+e[4];c[g.frustum.plane.LEFT][2]=e[11]+e[8];c[g.frustum.plane.LEFT][3]=e[15]+e[12];c[g.frustum.plane.RIGHT][0]=e[3]-e[0];c[g.frustum.plane.RIGHT][1]=e[7]-e[4];c[g.frustum.plane.RIGHT][2]=e[11]-e[8];c[g.frustum.plane.RIGHT][3]=e[15]-e[12];c[g.frustum.plane.TOP][0]=e[3]-e[1];c[g.frustum.plane.TOP][1]=e[7]-e[5];c[g.frustum.plane.TOP][2]=e[11]-e[9];c[g.frustum.plane.TOP][3]=e[15]-e[13];c[g.frustum.plane.BOTTOM][0]=e[3]+e[1];c[g.frustum.plane.BOTTOM][1]=e[7]+e[5];c[g.frustum.plane.BOTTOM][2]=e[11]+
e[9];c[g.frustum.plane.BOTTOM][3]=e[15]+e[13];c[g.frustum.plane.NEAR][0]=e[3]+e[2];c[g.frustum.plane.NEAR][1]=e[7]+e[6];c[g.frustum.plane.NEAR][2]=e[11]+e[10];c[g.frustum.plane.NEAR][3]=e[15]+e[14];c[g.frustum.plane.FAR][0]=e[3]-e[2];c[g.frustum.plane.FAR][1]=e[7]-e[6];c[g.frustum.plane.FAR][2]=e[11]-e[10];c[g.frustum.plane.FAR][3]=e[15]-e[14];for(var o=0;o<6;++o)s.normalize(c[o]);o=-c[g.frustum.plane.NEAR][3];c=c[g.frustum.plane.FAR][3]-o;d=c*(1/d[5]);d=f.subtract([0,0,o+c*0.5],[d,d,o+c]);d=f.length(d);
e=[e[3],e[9],e[10]];o=f.length(e);e=f.multiply(e,1/o);a=[a.position[0],a.position[1],a.position[2]];a=f.add(a,f.multiply(e,c*0.5));a=f.add(a,f.multiply(e,1));this.sphere=[a[0],a[1],a[2],d]}};q.prototype.contains_sphere=function(a){for(var c=n.vec3,d=this._planes,f=0;f<6;++f){var e=d[f],e=c.dot([e[0],e[1],e[2]],[a[0],a[1],a[2]])+e.d;this.last_in[f]=1;if(e<-a[3])return-1;if(Math.abs(e)<a[3])return 0}return 1};q.prototype.draw_on_map=function(a,c){var d=a.width/2,f=a.height/2;c.save();for(var e=this._planes,
g=[0,1,4,5],m=0,n=g.length;m<n;++m){var q=e[g[m]];c.strokeStyle="#FF00FF";if(m<this.last_in.length&&this.last_in[m])c.strokeStyle="#FFFF00";var t=-d,r=d,s=(-q[3]-q[0]*r)/q[2];c.moveTo(d+t,f+(-q[3]-q[0]*t)/q[2]);c.lineTo(d+r,f+s);c.stroke()}c.strokeStyle="#0000FF";c.beginPath();c.arc(d+this.sphere[0],f+this.sphere[2],this.sphere[3],0,Math.PI*2,!1);c.closePath();c.stroke();c.restore()};q.prototype.contains_box=function(a){var c=0,d=[];d[0]=a[0];d[1]=[a[0][0],a[0][1],a[1][2]];d[2]=[a[0][0],a[1][1],a[0][2]];
d[3]=[a[0][0],a[1][1],a[1][2]];d[4]=[a[1][0],a[0][1],a[0][2]];d[5]=[a[1][0],a[0][1],a[1][2]];d[6]=[a[1][0],a[1][1],a[0][2]];d[7]=a[1];for(var a=this._planes,f=0;f<6;++f){for(var e=8,g=1,m=0;m<8;++m)s.classifyPoint(a[f],d[m])===-1&&(g=0,--e);this.last_in[f]=g;if(e===0)return-1;c+=g}if(c===6)return 1;return 0};return{Frustum:q,Octree:y}});
CubicVR.RegisterModule("CVRXML",function(n){function y(a,d,f,e){var g=CubicVR.util,m=null,n=null;e.triangles&&(n=g.intDelimArray(b.getTextNode(e,"triangles")," "));if(n&&(e.segments&&(m=g.intDelimArray(b.getTextNode(e,"segments")," ")),m===null&&(m=[0,parseInt(n.length/3,10)]),e=0,a.setFaceMaterial(d),n.length)){p=0;for(pMax=m.length;p<pMax;p+=2){d=m[p+1]*3;a.setSegment(m[p]);j=e;for(jMax=e+d;j<jMax;j+=3)g=a.addFace([n[j],n[j+1],n[j+2]]),f&&a.faces[g].setUV([f[j],f[j+1],f[j+2]]);e+=d}}}function z(a){var d=
CubicVR.util,f=new CubicVR.UVMapper,e=null,o=null;if(a.type)switch(e=b.getTextNode(a,"type"),e){case "planar":f.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":f.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":f.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":f.projection_mode=g.uv.projection.CUBIC}if(!e)return null;e==="uv"&&a.uv&&(o=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":f.projection_axis=g.uv.axis.X;break;case "y":f.projection_axis=
g.uv.axis.Y;break;case "z":f.projection_axis=g.uv.axis.Z}if(a.center)f.center=d.floatDelimArray(b.getTextNode(a,"center"));if(a.rotation)f.rotation=d.floatDelimArray(b.getTextNode(a,"rotation"));if(a.scale)f.scale=d.floatDelimArray(b.getTextNode(a,"scale"));if(a.wrap_w)f.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w"));if(a.wrap_h)f.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h"));return e!==""&&e!=="uv"?f:o}function q(c,d){if(a[c]!==e)return a[c];var f=CubicVR.util,h,o,m,q;h=null;h=typeof c==
"object"?c:c.indexOf(".js")!=-1?f.getJSON(c):CubicVR.util.xml2badgerfish(f.getXML(c));if(h.root)h=h.root;if(h.properties)h=h.properties;f=new CubicVR.Mesh;h.points&&(m=b.getPoints(h,"points"))&&f.addPoint(m);var r=h.material;r&&!r.length&&(r=[r]);var t=[];if(r){h=0;for(m=r.length;h<m;h++){var v=r[h],s;s=v;var A=d,M=new CubicVR.Material({name:s.name?s.name.$:null});if(s.shininess)M.shininess=b.getFloatNode(s,"shininess",M.shininess)/100;M.opacity=b.getFloatNode(s,"alpha",M.opacity);M.max_smooth=b.getFloatNode(s,
"max_smooth",M.max_smooth);M.color=b.getFloatDelimNode(s,"color",M.color);M.ambient=b.getFloatDelimNode(s,"ambient",M.ambient);M.diffuse=b.getFloatDelimNode(s,"diffuse",M.diffuse);M.specular=b.getFloatDelimNode(s,"specular",M.specular);o=void 0;if(o=b.getTextNode(s,"texture"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.COLOR);if(o=b.getTextNode(s,"texture_luminosity"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:
new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.AMBIENT);if(o=b.getTextNode(s,"texture_normal"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.NORMAL);if(o=b.getTextNode(s,"texture_specular"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.SPECULAR);if(o=b.getTextNode(s,"texture_bump"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:
new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.BUMP);if(o=b.getTextNode(s,"texture_envsphere"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.ENVSPHERE);if(o=b.getTextNode(s,"texture_alpha"))o=(A?A:"")+o,tex=n.Textures_ref[o]!==e?n.Textures_obj[n.Textures_ref[o]]:new CubicVR.Texture(o),M.setTexture(tex,g.texture.map.ALPHA);s=M;var w=null;o=A=null;v.uvmapper&&((A=z(v.uvmapper))&&!A.length?t.push([A,s]):o=A);(M=v.part)&&
!M.length&&(M=[M]);if(M&&M.length){var u=null,F=null;o=0;for(q=M.length;o<q;o++){var E=M[o],u=null;if(w=E.uvmapper)if(u=z(w),v.triangles)F=w=f.faces.length,u&&!u.length?(y(f,s,null,E),F=f.faces.length-1,f.calcFaceNormals(w,F),u.apply(f,s,e,w,F)):u&&u.length?y(f,s,u,E):A&&!A.length&&(y(f,s,null,E),F=f.faces.length-1,f.calcFaceNormals(w,F),A.apply(f,s,e,w,F));if(E.procedural){(w=E.uvmapper)&&(u=z(w));var F=E.transform?b.getTransform(E.transform):e,w=e,E=E.procedural,D=b.getTextNode(E,"type");F&&(w=
new CubicVR.Transform,w.translate(F.position),w.pushMatrix(),w.rotate(F.rotation),w.pushMatrix(),w.scale(F.scale));A||(A=e);u={material:s,uvmapper:A||u};if(D==="box"||D==="cube")u.size=b.getFloatNode(E,"size"),f.booleanAdd(CubicVR.primitives.box(u),w);else if(D==="sphere")u.radius=b.getFloatNode(E,"radius"),u.lat=b.getIntNode(E,"lat"),u.lon=b.getIntNode(E,"lon"),f.booleanAdd(CubicVR.primitives.sphere(u),w);else if(D==="cone")u.base=b.getFloatNode(E,"base"),u.height=b.getFloatNode(E,"height"),u.lon=
b.getIntNode(E,"lon"),f.booleanAdd(CubicVR.primitives.cone(u),w);else if(D==="plane")u.size=b.getFloatNode(E,"size"),f.booleanAdd(CubicVR.primitives.plane(u),w);else if(D==="cylinder")u.radius=b.getFloatNode(E,"radius"),u.height=b.getFloatNode(E,"height"),u.lon=b.getIntNode(E,"lon"),f.booleanAdd(CubicVR.primitives.cylinder(u),w);else if(D==="torus")u.innerRadius=b.getFloatNode(E,"innerRadius"),u.outerRadius=b.getFloatNode(E,"outerRadius"),u.lat=b.getIntNode(E,"lat"),u.lon=b.getIntNode(E,"lon"),f.booleanAdd(CubicVR.primitives.torus(u),
w);else if(D==="lathe")u.points=b.getPoints(E,"p"),u.lon=b.getIntNode(E,"lon"),f.booleanAdd(CubicVR.primitives.lathe(u),w);else if(D==="polygon"){F=b.getPoints(E,"p");F=new CubicVR.Polygon(F);(D=E.cut)&&!D.length&&(D=[D]);if(D.length){o=0;for(m=D.length;o<q;o++)F.cut(new CubicVR.Polygon(b.getPoints(D[o])))}u.front=0;u.back=0;u.frontShift=0;u.backShift=0;u.frontDepth=0;u.backDepth=0;if(E.extrude){E=E.extrude;u.front=b.getFloatNode(E,"front",0);u.back=b.getFloatNode(E,"back",0);u.frontShift=b.getFloatNode(E,
"frontBevelShift",0);u.backShift=b.getFloatNode(E,"backBevelShift",0);u.frontDepth=b.getFloatNode(E,"frontBevelDepth",0);u.backDepth=b.getFloatNode(E,"backBevelDepth",0);u.depth=b.getFloatNode(E,"depth",0);u.shift=b.getFloatNode(E,"shift",0);u.bevel=b.getFloatNode(E,"bevel",0);if(u.depth&&!u.backDepth&&!u.frontDepth)u.front=-u.depth/2,u.back=u.depth/2;if(u.shift&&!u.backShift&&!u.frontShift)u.frontShift=u.shift,u.backShift=u.shift;if(u.bevel&&!u.backDepth&&!u.frontDepth)u.frontDepth=u.bevel,u.backDepth=
u.bevel}E=F.toExtrudedBeveledMesh(new CubicVR.Mesh,u);E.setFaceMaterial(u.material);f.booleanAdd(E,w)}}}}else y(f,s,o,v)}}f.triangulateQuads();f.calcNormals();h=0;for(m=t.length;h<m;h++)t[h][0].apply(f,t[h][1]);f.compile();return a[c]=f}function r(a){if(a===null)return!1;return a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function s(a,b,f){var h=CubicVR.util,o=[];o[0]=a.getElementsByTagName("x");o[1]=
a.getElementsByTagName("y");o[2]=a.getElementsByTagName("z");o[3]=a.getElementsByTagName("fov");var m,n,q,t,r,s;for(s in o)if(o.hasOwnProperty(s)&&o[s]!==e&&o[s].length){m=o[s][0].getElementsByTagName("time");n=o[s][0].getElementsByTagName("value");q=o[s][0].getElementsByTagName("in");t=o[s][0].getElementsByTagName("out");r=o[s][0].getElementsByTagName("tcb");var A=null,y=null,w=null,u=a=null;q.length&&(a=h.collectTextNode(q[0]));t.length&&(u=h.collectTextNode(t[0]));m.length&&(A=h.floatDelimArray(h.collectTextNode(m[0]),
" "));n.length&&(y=h.floatDelimArray(h.collectTextNode(n[0])," "));r.length&&(w=h.floatDelimArray(h.collectTextNode(r[0])," "));if(A!==null&&y!==null){m=0;for(n=A.length;m<n;m++)if(q=f.setKey(b,s,A[m],y[m]),w)q.tension=w[m*3],q.continuity=w[m*3+1],q.bias=w[m*3+2]}y=A=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":A=g.envelope.behavior.RESET;break;case "constant":A=g.envelope.behavior.CONSTANT;break;case "repeat":A=g.envelope.behavior.REPEAT;break;case "oscillate":A=g.envelope.behavior.OSCILLATE;
break;case "offset":A=g.envelope.behavior.OFFSET;break;case "linear":A=g.envelope.behavior.LINEAR}if(u)switch(u){case "reset":y=g.envelope.behavior.RESET;break;case "constant":y=g.envelope.behavior.CONSTANT;break;case "repeat":y=g.envelope.behavior.REPEAT;break;case "oscillate":y=g.envelope.behavior.OSCILLATE;break;case "offset":y=g.envelope.behavior.OFFSET;break;case "linear":y=g.envelope.behavior.LINEAR}f.setBehavior(b,s,A,y)}}var e=n.undef,g=CubicVR.enums,a=[],b={getPoints:function(a,d,f){a=d?
b.getTextNode(a,d):a.$;if(!a)return e;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var f={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e;postition=a.position;e=a.rotation;a=a.scale;if(e)f.rotation=b.floatDelimArray(e.$);if(a)f.scale=b.floatDelimArray(a.$);if(e||a)return f;return null},getTextNode:function(a,b,f){a=a[b];
if(!a)return f;a.length&&(a=a[0]);if(a.$)return a.$;return f},getFloatNode:function(a,d,f){if(a=b.getTextNode(a,d)){a=parseFloat(a);if(a!=a)return f;return a}return f},getIntNode:function(a,d,f){if(a=b.getTextNode(a,d)){a=parseInt(a,10);if(a!=a)return f;return a}return f},getFloatDelimNode:function(a,d,f,e){var g=CubicVR.util;if(a=b.getTextNode(a,d))return g.floatDelimArray(a,e);return f},getIntDelimNode:function(a,d,f,e){var g=CubicVR.util;if(a=b.getTextNode(a,d))return g.intDelimArray(a,e);return f}};
return{loadMesh:q,loadScene:function(a,b,f){var h=CubicVR.util;b===e&&(b="");f===e&&(f="");for(var o=new CubicVR.Mesh,m=h.getXML(a),a=new CubicVR.Scene,n=[],x=m.getElementsByTagName("sceneobjects"),t,v,C,A=0,y=x[0].childNodes.length;A<y;A++){var w=x[0].childNodes[A];if(w.tagName==="sceneobject"){var u="unnamed",z="",E="",o=w.getElementsByTagName("name");o.length&&(u=h.collectTextNode(o[0]));o=w.getElementsByTagName("parent");o.length&&(z=h.collectTextNode(o[0]));o=w.getElementsByTagName("model");
o.length&&(E=h.collectTextNode(o[0]));C=v=t=null;o=w.getElementsByTagName("position");o.length&&(t=o[0]);o=w.getElementsByTagName("rotation");o.length&&(v=o[0]);o=w.getElementsByTagName("scale");o.length&&(C=o[0]);o=null;E!==""&&(o=q(b+E,f));o=new CubicVR.SceneObject(o,u);if(r(t)){if(!o.motion)o.motion=new CubicVR.Motion;s(t,g.motion.POS,o.motion)}else if(t)o.position=h.floatDelimArray(h.collectTextNode(t));if(r(v)){if(!o.motion)o.motion=new CubicVR.Motion;s(v,g.motion.ROT,o.motion)}else o.rotation=
h.floatDelimArray(h.collectTextNode(v));if(r(C)){if(!o.motion)o.motion=new CubicVR.Motion;s(C,g.motion.SCL,o.motion)}else o.scale=h.floatDelimArray(h.collectTextNode(C));a.bindSceneObject(o);z!==""&&n.push([o,z])}}for(var D in n)n.hasOwnProperty(D)&&a.getSceneObject(n[D][1]).bindChild(n[D][0]);b=m.getElementsByTagName("camera");if(b.length){v=t=null;f="";o=b[0].getElementsByTagName("name");D=a.camera;m=null;if(o.length)f=o[0].firstChild.nodeValue;o=b[0].getElementsByTagName("target");if(o.length)f=
o[0].firstChild.nodeValue;if(f!=="")D.targetSceneObject=a.getSceneObject(f);o=b[0].getElementsByTagName("position");o.length&&(t=o[0]);o=b[0].getElementsByTagName("rotation");o.length&&(v=o[0]);o=b[0].getElementsByTagName("fov");o.length&&(m=o[0]);if(r(t)){if(!D.motion)D.motion=new CubicVR.Motion;s(t,g.motion.POS,D.motion)}else if(t)D.position=h.floatDelimArray(t.firstChild.nodeValue);if(r(v)){if(!D.motion)D.motion=new CubicVR.Motion;s(v,g.motion.ROT,D.motion)}else if(v)D.rotation=h.floatDelimArray(v.firstChild.nodeValue);
if(r(m)){if(!D.motion)D.motion=new CubicVR.Motion;s(m,g.motion.FOV,D.motion)}else if(m)D.fov=parseFloat(m.firstChild.nodeValue)}return a}}});
CubicVR.RegisterModule("Worker",function(n){function y(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){a.data.message!=="init"&&b.message(a.data)},!1)}function z(a){function b(a){setTimeout(function(){f.send("test",a)},1E3)}a&&b(a);var f=new y({message:b})}function q(a){function b(a){a=m.getURL(a);f.send("done",a.length)}var f;f=new y({message:function(a){b(a)}});a&&b(a)}function r(a){function b(a){a=
m.getURL(a);f.send("loaded",a)}var f,d;f=new y({message:function(a){if(a.message==="parse")d=new o,CubicVR.loadCollada("","",d,a.data),f.send("parsed");else if(a.message==="getMesh"){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());f.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function s(b){function f(b){var c=new a,e;for(e in b)b.hasOwnProperty(e)&&(c[e]=b[e]);b=c.triangulateQuads().compileVBO(c.compileMap());
d.send("done",b)}var d;d=new y({message:function(a){f(a)}});b&&f(b)}try{if(!window)self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}catch(e){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=n.undef,a=CubicVR.Mesh,b=CubicVR.Texture,c=CubicVR.Material,d=CubicVR.SceneObject,f=CubicVR.Motion,h=CubicVR.Envelope,o=CubicVR.DeferredBin,m=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");
this.message=a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,f){b.worker.postMessage({message:a,data:f})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function f(b){var d=
b.parsed||function(){},c={},e;b.url.match(/\.dae/)&&(e=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if(b.message==="loaded"){var b=(new DOMParser).parseFromString(b.data,"text/xml"),f=m.xml2badgerfish(b);console.log(b);e.send("parse",f)}else if(b.message==="getMesh"){var f=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(f[g]=b.data.mesh[g]);f.bindBuffer(f.bufferVBO(b.data.vbo));c.getMesh&&c.getMesh(f)}else b.message==="parsed"&&d()}}));this.getSceneObject=function(a,
b){e.send("getMesh",a);c.getMesh=b}}function e(a,b){for(var f in a)a.hasOwnProperty(f)&&(b[f]=a[f]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new f({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if(typeof settings==="string")delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(f){var h=f.scene,m=f.object,o=f.assetBase||"",n=g.createSceneFileManager({url:f.mesh,parsed:function(){m&&
n.getSceneObject(m,function(f){for(var f=e(f,new a),g=0,m=f.materials.length;g<m;++g){for(var n=e(f.materials[g],new c),t=0,q=n.textures.length;t<q;++t){var r=n.textures[g];n.textures[g]=new b(o+r.img_path,r.filter_type)}f.materials[g]=n}f=new d(f);h.bindSceneObject(f)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(e,m,o,n){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],w=[];q.onmessage=function(m){function q(a,b){for(var f in a)b[f]=a[f]}function r(a){if(a.motion){for(var b=a.motion.controllers,d=[],c=0,e=b.length;c<e;++c){var g=b[c];if(g){for(var m=[],o=0,n=g.length;o<n;++o){var t=g[o];if(t){var s=t.keys[0];if(t.keys.length>1)s.prev=null,s.next=t.keys[1],s=t.keys[1];for(var v=1,u=t.keys.length-1;v<u;++v)s.prev=t.keys[v-1],s.next=t.keys[v+1],s=t.keys[v+1];if(t.keys.length>1)s=t.keys[t.keys.length-1],s.prev=t.keys[t.keys.length-2],s.next=null;t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;s=new h;q(t,s);m[o]=s}else g[o]=null}d[c]=m}else b[c]=null}a.motion.controllers=d;b=new f;q(a.motion,b);a.motion=b}}function x(b){var f=new d;q(b,f);if(b.obj!==null){var c=w[b.obj.id];if(c===g)if(c=new a,q(b.obj,c),f.obj=c,w[b.obj.id]=c,n){if(c.points.length>0){n.addMesh(e,e+":"+c.id,c);for(var h=0,m=c.faces.length;h<m;++h){var o=c.faces[h],t=o.material;o.material=s[t]!==g?s[t]:0}}}else f.obj.triangulateQuads(),f.obj.calcNormals(),f.obj.compile(),
f.obj.clean();else f.obj=c}f.trans=new Transform;if(b.children&&b.children.length>0&&(f.children=[],b.children)){c=0;for(h=b.children.length;c<h;++c)m=x(b.children[c]),f.bindChild(m)}return f}var C;C=m.data.message;if(C=="materials"){var A=JSON.parse(m.data.data),m=0;for(C=A.length;m<C;++m){var y=new c(A[m].name),z=y.material_id;q(A[m],y);y.material_id=z;s[A[m].material_id]=z;for(var z=0,H=A[m].textures.length;z<H;++z){var L=A[m].textures[z];if(L){var K=Texture_ref[L.img_path];K===g?(L=new b(L.img_path,
L.filter_type,n,e),y.textures[z]=L):y.textures[z]=Textures_obj[K]}else y.textures[z]=0}}}else if(C=="scene"){A=JSON.parse(m.data.data);m=0;for(C=A.sceneObjects.length;m<C;++m){y=A.sceneObjects[m];y.obj!==null&&nop();if(y.reassembled===g)r(y),y.reassembled=!0;A.sceneObjects[m]=x(y)}y=new Scene;m=y.camera;C=m.transform;q(A.camera,m);q(A.camera.transform,C);r(m);y.camera=m;y.camera.transform=C;y.camera.frustum=new Frustum;m=0;for(C=A.sceneObjects.length;m<C;++m){z=A.sceneObjects[m];y.bindSceneObject(z);
try{z.getAABB()}catch(S){}}m=0;for(C=A.lights.length;m<C;++m)z=new Light,q(A.lights[m],z),z.trans=new Transform,r(z),y.bindLight(z);o(y)}else console.log("message from collada worker:",m.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:e,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:z,prepareMesh:s,file:q,sceneFile:r};self.addEventListener("message",function(b){if(b.data.message===
"init"){var f=b.data.data.type;if(f in a)new a[f](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(n){function y(a){var b=[],c=a.length;if(c<3)return null;var e=[],g;g=a.length;for(var n=0,t=g-1,q=0;q<g;t=q++)n+=a[t][0]*a[q][1]-a[q][0]*a[t][1];if(0<n*0.5)for(g=0;g<c;g++)e[g]=g;else for(g=0;g<c;g++)e[g]=c-1-g;q=2*c;n=0;for(g=c-1;c>2;){if(0>=q--)return null;var r=g;c<=r&&(r=0);g=r+1;c<=g&&(g=0);t=g+1;c<=t&&(t=0);var s;a:{s=a;var y=r,w=g,u=t,z=c,E=e,D=void 0,O=void 0,I=void 0,G=void 0,J=void 0,H=void 0,L=void 0,K=void 0,S=void 0,O=s[E[y]][0],I=s[E[y]][1],
G=s[E[w]][0],J=s[E[w]][1],H=s[E[u]][0],L=s[E[u]][1];if(d>(G-O)*(L-I)-(J-I)*(H-O))s=!1;else{for(D=0;D<z;D++)if(!(D==y||D==w||D==u)){var K=s[E[D]][0],S=s[E[D]][1],W=void 0,N=void 0,Q=void 0,P=void 0,T=void 0,Y=void 0,Z=void 0,R=void 0,$=void 0,U=void 0,V=void 0,X=void 0,W=Q=T=void 0,W=H-G,N=L-J,Q=O-H,P=I-L,T=G-O,Y=J-I,Z=K-O,R=S-I,$=K-G,U=S-J,V=K-H,X=S-L,W=W*U-N*$,T=T*R-Y*Z,Q=Q*X-P*V;if(W>=0&&Q>=0&&T>=0){s=!1;break a}}s=!0}}if(s){q=e[r];r=e[g];t=e[t];b.push(q);b.push(r);b.push(t);n++;t=g;for(q=g+1;q<
c;t++,q++)e[t]=e[q];c--;q=2*c}}return b}function z(a,b,d){d===c&&(d=0);var e;e=y(b);var g=CubicVR.util.repackArray(e,3,e.length/3),n=[],t=a.points.length;e=0;for(iMax=b.length;e<iMax;e++)n.push([b[e][0],b[e][1],d]);a.addPoint(n);e=0;for(iMax=g.length;e<iMax;e++)a.addFace([g[e][0]+t,g[e][1]+t,g[e][2]+t])}function q(a,b){var d=b[0]-a[0],c=b[1]-a[1];return Math.sqrt(d*d+c*c)}function r(a,b){var d,c,e=[],g=a.length,n=b.length,r=[];for(d=0;d<g;d++)for(c=0;c<n;c++){var s=q(a[d],b[c]);e.push([s,d,c])}e.sort(function(a,
b){return a[0]>b[0]});for(d=0;d<5;d++)for(c=0;c<e.length;c++)d!=c&&e[d][1]!=e[c][1]&&e[d][2]!=e[c][2]&&e[d][1]<e[c][1]&&e[d][2]<e[c][2]&&Math.abs(e[d][1]-e[c][1])<4&&Math.abs(e[d][2]-e[c][2])<4&&r.push([d,c]);r.sort(function(a,b){return e[a[0]][0]+e[a[1]][0]>e[b[0]][0]+e[b[1]][0]});if(r.length>10)r.length=10;c=[];for(d=0;d<r.length;d++)c.push([e[r[d][0]],e[r[d][1]]]);return c}function s(a,b){var d=r(a,b),c;if(!d.length)return null;c=d[0][0];var e=d[0][1],d=e[1]-c[1],e=e[2]-c[2],g=a.slice(c[1]),g=
g.concat(a.slice(0,c[1])),n=b.slice(c[2]),n=n.concat(b.slice(0,c[2])),q=[];for(c=d;c<g.length;c++)q.push(g[c]);q.push(g[0]);for(c=e;c<n.length;c++)q.push(n[c]);q.push(n[0]);var s=[];for(c=0;c<=d;c++)s.push(g[c]);for(c=0;c<=e;c++)s.push(n[c]);return[q,s]}function e(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,c){for(var d=[],e=0;e<a.length;e++){var g=[a[e][0]-b[0],a[e][1]-b[1]],n=Math.sqrt(g[0]*g[0]+g[1]*g[1])+c,g=Math.atan2(g[1],
g[0]);d[e]=[b[0]+Math.cos(g)*n,b[1]+Math.sin(g)*n]}return d}function a(a,b,c,d,e){var g,n=a.points.length;if(b.length!=c.length)return null;var q=b.length;for(g=0;g<q;g++)a.addPoint([b[g][0],b[g][1],d]);for(g=0;g<q;g++)a.addPoint([c[g][0],c[g][1],e]);for(g=0;g<q-1;g++)a.addFace([n+g,n+g+1,n+(g+q+1),n+(g+q)]);g=q-1;a.addFace([n+g,n,n+q,n+(g+q)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var c=n.undef,d=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},toMesh:function(a){if(this.points.length!==
0){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var c=this.cuts[b].points.slice(0),c=c.reverse(),c=s(this.result[0],c);this.result[0]=c[0];this.result.push(c[1])}for(b=0;b<this.result.length;b++)z(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(b,d,e){if(this.points.length!==0){var g,n;d===c&&(d=0);e===c&&(e=0);var q=d!=e;b||(b=new CubicVR.Mesh);this.result=[this.points];for(n=0;n<this.cuts.length;n++)g=this.cuts[n].points.slice(0),
g=g.reverse(),g=s(this.result[0],g),this.result[0]=g[0],this.result.push(g[1]);g=new CubicVR.Mesh;for(n=0;n<this.result.length;n++)z(g,this.result[n],e);b.booleanAdd(g);g.flipFaces();if(q)for(n=0;n<g.points.length;n++)g.points[n][2]=d;b.booleanAdd(g);if(q){a(b,this.points,this.points,d,e);for(n=0;n<this.cuts.length;n++)g=this.cuts[n].points.slice(0),g=g.reverse(),a(b,g,g,d,e)}b.removeDoubles();return b}},toExtrudedBeveledMesh:function(b,c,d,m,n,q,t){var r=[],C=[],y,M,w,u;if(this.points.length!==0){typeof c===
"object"&&(t=c,c=t.front||0,d=t.back||0,m=t.frontDepth||0,n=t.frontShift||0,q=t.backDepth||0,t=t.backShift||0);var F=c!==d,E=q!==0,D=m!==0;b||(b=new CubicVR.Mesh);D?(M=e(this.points),M=g(this.points,M,-n),this.result=[M.slice(0)]):this.result=[this.points.slice(0)];for(u=0;u<this.cuts.length;u++)w=e(this.cuts[u].points),w=g(this.cuts[u].points,w,n),w=w.reverse(),r.push(w),w=s(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);n=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)z(n,this.result[u],
c-m);n.flipFaces();b.booleanAdd(n);if(E||D){y=e(this.points);y=g(this.points,y,-t);this.result=[y.slice(0)];for(u=0;u<this.cuts.length;u++)w=e(this.cuts[u].points),w=g(this.cuts[u].points,w,t),w=w.reverse(),C.push(w),w=s(this.result[0],w),this.result[0]=w[0],this.result.push(w[1]);n=new CubicVR.Mesh;for(u=0;u<this.result.length;u++)z(n,this.result[u],d+q)}else{for(u=0;u<n.points.length;u++)n.points[u][2]=d;n.flipFaces()}b.booleanAdd(n);D&&a(b,M,this.points,c-m,c);F&&a(b,this.points,this.points,c,
d);E&&a(b,this.points,y,d,d+q);for(u=0;u<r.length;u++)w=this.cuts[u].points.slice(0).reverse(),D&&a(b,r[u],w,c-m,c),F&&a(b,w,w,c,d),E&&a(b,w,C[u],d,d+q);b.removeDoubles();return b}}};return{polygon:{triangulate2D:y,toMesh:z,findNearPair:function(a,b){for(var c=[0,0],d=q(a[0],b[0]),e=a.length,g=b.length,n=0;n<e;n++)for(var r=0;r<g;r++){var s=q(a[n],b[r]);s<d&&(c[0]=n,c[1]=r,d=s)}return c},subtract:s,addOffset:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var g=a[d];c.push([g[0]+b[0],g[1]+b[1]])}return c}},
Polygon:b}});
CubicVR.RegisterModule("ScenePhysics",function(n){function y(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function z(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function q(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function r(a){return new Ammo.btVector3(a[0],a[1],a[2])}function s(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function e(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=n.undef,b=n.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var c,d,f,h,o,m=function(a,b,c){var d;
if(!a.position&&a.sceneObject)d=a,a=a.sceneObject,b=d.properties,c=d.collision;d=n.get(d)||{};this.properties=new n.RigidProperties(b?n.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(r(this.init_position));this.transform.setRotation(s(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};m.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),y(this.linearVelocity,h),this.body.setLinearVelocity(h),y(this.angularVelocity,h),this.body.setAngularVelocity(h),n.vec3.equal([0,0,0],this.impulse)||(y(this.impulse,h),y(this.impulsePosition,o),this.body.applyImpulse(h,o)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(c),a=c.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=c.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();y(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;d.fromEuler(a[0],a[1],a[2]);a=[d.x,d.y,d.z,d.w];f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);f.setW(a[3]);this.body.getWorldTransform().setRotation(f);this.activate()}},resetMotion:function(){y(this.init_linearVelocity,
h);this.body.setLinearVelocity(h);y(this.init_angularVelocity,h);this.body.setAngularVelocity(h);n.vec3.equal([0,0,0],this.init_impulse)||(y(this.init_impulse,h),y(this.init_impulsePosition,o),this.body.applyImpulse(h,o))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var d=a.getShapes(),f,e,g,h,m,o,q,x=[],z=null;e=0;for(g=d.length;e<g;e++){f=d[e];z=null;if(f.type===b.collision.shape.BOX)z=new Ammo.btBoxShape(new Ammo.btVector3(f.size[0]/
2,f.size[1]/2,f.size[2]/2));else if(f.type===b.collision.shape.SPHERE)z=new Ammo.btSphereShape(f.radius);else if(f.type===b.collision.shape.CAPSULE)z=new Ammo.btCapsuleShape(f.radius,f.height);else if(f.type===b.collision.shape.CYLINDER)z=new Ammo.btCylinderShape(new Ammo.btVector3(f.size[0]/2,f.size[1]/2,f.size[2]/2));else if(f.type===b.collision.shape.CONE)z=new Ammo.btConeShape(f.radius,f.height);else if(f.type===b.collision.shape.MESH){q=f.mesh;z=new Ammo.btTriangleMesh;o=f.size;var B=new Ammo.btVector3(0,
0,0),G=new Ammo.btVector3(0,0,0),J=new Ammo.btVector3(0,0,0),H=q.getMaterials();h=0;for(m=q.faces.length;h<m;h++){var L=q.faces[h];H[L.material].collision&&L.points.length===3&&(B.setValue(q.points[L.points[0]][0]*o[0],q.points[L.points[0]][1]*o[1],q.points[L.points[0]][2]*o[2]),G.setValue(q.points[L.points[1]][0]*o[0],q.points[L.points[1]][1]*o[1],q.points[L.points[1]][2]*o[2]),J.setValue(q.points[L.points[2]][0]*o[0],q.points[L.points[2]][1]*o[1],q.points[L.points[2]][2]*o[2]),z.addTriangle(B,G,
J))}this.getMass()===0||this.getType()==b.physics.body.STATIC||this.getType()==b.physics.body.GHOST?(this.setMass(0),z=new Ammo.btBvhTriangleMeshShape(z,!0)):z=new Ammo.btConvexTriangleMeshShape(z,!0)}else if(f.type===b.collision.shape.CONVEX_HULL){q=f.mesh;o=f.size;B=new Ammo.btVector3(0,0,0);z=new Ammo.btConvexHullShape;h=0;for(m=q.points.length;h<m;h++)y([q.points[h][0]*o[0],q.points[h][1]*o[1],q.points[h][2]*o[2]],B),z.addPoint(B)}else if(f.type===b.collision.shape.HEIGHTFIELD){var G=B=q=o=0,
K;if(f.landscape&&!f.heightfield&&f.landscape instanceof n.HeightField)f.heightfield=f.landscape;else if(f.landscape&&f.landscape instanceof n.Landscape)o=f.landscape.heightfield.divX,B=f.landscape.heightfield.divZ,q=f.landscape.heightfield.sizeX,G=f.landscape.heightfield.sizeZ,K=f.landscape.heightfield.getMesh().points;if(f.heightfield&&f.heightfield instanceof n.HeightField)o=f.heightfield.divX,B=f.heightfield.divZ,q=f.heightfield.sizeX,G=f.heightfield.sizeZ,K=f.heightfield.getMesh().points;z=Ammo.allocate(K.length*
4,"float",Ammo.ALLOC_NORMAL);h=0;for(m=o*B;h<m;h++)Ammo.setValue(z+(h<<2),K[h][1],"float");z=new Ammo.btHeightfieldTerrainShape(o,B,z,1,-100,100,1,0,!1);z.setUseDiamondSubdivision(!0);h=new Ammo.btVector3(q/o,1,G/B);z.setLocalScaling(h)}z&&(f.margin!==0&&z.setMargin(f.margin),x.push({cShape:f,btShape:z}))}d=null;if(x.length===1)d=x[0].btShape;else if(x.length>1){c=new Ammo.btTransform;d=new Ammo.btCompoundShape(!1);e=0;for(g=x.length;e<g;e++)c.setIdentity(),c.setOrigin(r(x[e].cShape.position)),c.setRotation(s(x[e].cShape.rotation)),
d.addChildShape(c,x[e].btShape)}a.setResult(d);a=d}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(y(a,h),this.body.setAngularVelocity(h))},setGravity:function(a){this.gravity=a;this.body&&(y(a,h),this.body.setGravity(h))},getGravity:function(){if(this.gravity&&!this.body)return this.gravity;return e(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(y(a,h),this.body.setLinearVelocity(h))},applyImpulse:function(a,
b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!n.vec3.equal([0,0,0],a)&&(y(this.impulse,h),y(this.impulsePosition,o),this.body.applyImpulse(h,o))},applyForce:function(a,b){this.body&&!n.vec3.equal([0,0,0],a)&&(y(a,h),y(b,o),this.body.applyImpulse(h,o))},getAngularVelocity:function(){return e(this.body.getAngularVelocity())},getLinearVelocity:function(){return e(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),
this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),y(b,h),this.body.setAngularFactor(h))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a=n.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=
a;if(this.body||this.ghost)y(a,h),this.body&&this.body.getCenterOfMassTransform().setOrigin(h),this.ghost&&this.ghost.getWorldTransform().setOrigin(h)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);var a=new n.Quaternion;q(f,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)z(a,f),this.body&&this.body.getCenterOfMassTransform().setRotation(f),
this.ghost&&this.ghost.getWorldTransform().setRotation(f)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new n.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);q(f,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;f.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(f);
this.ghost&&this.body.getWorldTransform().setRotation(f)}};var B=function(c){c=c||{};this.ctype=n.parseEnum(b.physics.constraint,c.ctype)||b.physics.constraint.P2P;this.strength=c.strength||0.1;this.maxImpulse=c.maxImpulse||0;this.rigidBodyA=c.rigidBodyA||c.rigidBody||null;this.rigidBodyB=c.rigidBodyB||null;this.positionA=c.positionA||[0,0,0];this.positionB=c.positionB||c.position||[0,0,0];this.damping=c.damping!=a?c.damping:1;this.btConstraint=null;this.localPivotA=r(this.positionA);this.localPivotB=
r(this.positionB)};B.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;if(this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),
this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL))this.btConstraint=null}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},
getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(y(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);if(a===Ammo.NULL)return null;return{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:e(a.getPositionWorldOnA()),positionB:e(a.getPositionWorldOnB())}},
setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var x=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,
this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!c||!d)h=new Ammo.btVector3,o=new Ammo.btVector3,c=new Ammo.btTransform,d=new n.Quaternion,f=new Ammo.btQuaternion};x.prototype={addConstraint:function(a){var b=a.getConstraint();if(b)return this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0;return!1},
removeConstraint:function(a){if(a=a.getConstraint())return this.dynamicsWorld.removeConstraint(a),!0;return!1},setGravity:function(a){y(a,h);this.dynamicsWorld.setGravity(h)},bindSceneObject:function(a,b){var c=new n.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bind:function(a){a instanceof n.Vehicle?a.initBody(this):a instanceof n.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof n.RigidBody&&
this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)!==-1)return;this.ghostObjects.push(a);var c=a.getBody();a.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(c)}else{if(this.rigidObjects.indexOf(a)!==-1)return;this.rigidObjects.push(a);c=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(c);a.updateSceneObject(!0)}var d,f;if((d=
a.getSceneObject())&&(f=d.getEventHandler()))f.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),f.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(this.ghostObjects.indexOf(a)===-1)return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(this.rigidObjects.indexOf(a)===-1)return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var c,
d;if((c=a.getSceneObject())&&(d=c.getEventHandler()))d.hasEvent(b.event.CONTACT)&&this.contactObjects.indexOf(a)!==-1&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(b.event.COLLIDE)&&this.collisionObjects.indexOf(a)!==-1&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,f=this.rigidObjects.length;d<f;d++)this.rigidObjects[d].updateSceneObject()&&
c++;this.active_count=c},triggerEvents:function(){var a,c,d,f,e=this.dynamicsWorld;if(this.contactObjects.length){var h=e.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=e.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(n&&(f=n.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.self=n,d.other=
o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m);else if(o&&o.isStatic()&&(f=o.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m)}}e=this.collisionObjects.length;for(a=0;a<e;a++)if(n=this.collisionObjects[a],(f=n.getSceneObject())&&(c=f.getEventHandler())&&c.hasEvent(b.event.COLLIDE))if(d=c.getProperties(b.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=
d.alg||[],m&&m.length){h=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[a].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);d.mf[a].getPersistentManifold().getNumContacts()>0&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&(d=c.triggerEvent(b.event.COLLIDE)))d.collisions=
h}e=this.ghostObjects.length;for(a=0;a<e;a++)if(d=this.ghostObjects[a],f=d.getSceneObject())if((c=f.getEventHandler())&&c.hasEvent(b.event.CONTACT_GHOST))if(f=d.getBody(),h=f.getNumOverlappingObjects()){d=c.triggerEvent(b.event.CONTACT_GHOST);d.contacts=d.contacts||[];if(d.contacts.length>h)d.contacts.length=h;for(c=0;c<h;c++)m=Ammo.btRigidBody.prototype.upcast(f.getOverlappingObject(c)),d.contacts[c]=m._cvr_rigidbody||null}},reset:function(){for(var a=0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},
getRayHit:function(a,b,c,d){var f,a=r(a);f=r(b);c=c||!1;d=d||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!c||body.isKinematicObject()&&!d)))return c=body,d=b.get_m_hitPointWorld(),a=c.getCenterOfMassTransform().inverse().op_mul(d),(f=c._cvr_rigidbody)?(Ammo.destroy(b),{position:e(d),localPosition:e(a),rigidBody:f,ammoBody:c}):(Ammo.destroy(b),
{position:e(d),localPosition:e(a),rigidBody:null,ammoBody:c});Ammo.destroy(b)}};return{ScenePhysics:x,Constraint:B,RigidProperties:function(c){this.type=n.parseEnum(b.physics.body,c.type);this.mass=c.mass!==a?c.mass:this.type?1:0;this.size=c.size||[1,1,1];this.restitution=c.restitution||(this.type?0:1);this.friction=c.friction||1;if((this.collision=c.collision)&&!this.collision.getShapes)this.collision=new n.CollisionMap(this.collision);this.blocker=c.blocker||!1},RigidBody:m,vec3bt_copy:y,btvec3_copy:function(a,
b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:z,btquat_copy:q}});
CubicVR.RegisterModule("CollisionMap",function(n){var y=n.enums;y.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var z=function(n){this.shapes=[];this.result=null;if(n){n&&!n.length&&(n=[n]);for(var r=0,s=n.length;r<s;r++)this.addShape(n[r])}};z.prototype={addShape:function(q){q.type=n.parseEnum(y.collision.shape,q.type);q.position=q.position||[0,0,0];q.rotation=q.rotation||[0,0,0];q.size=q.size||[1,1,1];q.radius=q.radius||1;q.height=q.height||1;
q.margin=q.margin||0;q.mesh=q.mesh||null;this.shapes.push(q)},getShapes:function(){return this.shapes},setResult:function(n){this.result=n},getResult:function(){return this.result}};return{CollisionMap:z}});
CubicVR.RegisterModule("RigidVehicle",function(n){var y=n.undef,z=n.enums,q,r,s=function(e){var e=n.get(e)||{},a=e.mesh,b=e.collision;this.maxEngineForce=e.maxEngineForce||2E3;this.maxBreakingForce=e.maxBreakingForce||125;this.steeringClamp=e.steeringClamp||0.51;this.mass=e.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new n.CollisionMap(b);this.sceneObject=new n.SceneObject(this.bodyMesh);if(!q||!r)new Ammo.btVector3,new Ammo.btVector3,q=new Ammo.btTransform,r=new n.Quaternion,new Ammo.btQuaternion;if(e.wheels!=y){a=0;for(b=e.wheels.length;a<b;a++){var c=e.wheels[a];c instanceof n.VehicleWheel?this.addWheel(c):this.addWheel(new n.VehicleWheel(c))}}};s.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(e){this.body=
new n.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});n.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);n.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(e.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(z.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,b=0;b<this.wheels.length;b++)n.vec3bt_copy(this.wheels[b].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[b].getSuspensionRest(),this.wheels[b].getWheelRadius(),this.m_tuning,this.wheels[b].getSteering());e.dynamicsWorld.addVehicle(this.m_vehicle);e.bind(this.body);this.updateSuspension()},evaluate:function(){for(var e=this.m_vehicle.getNumWheels(),
a=0;a<e;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var b=this.m_vehicle.getWheelTransformWS(a),c=b.getOrigin();this.wheels[a].wheelObj.position[0]=c.x();this.wheels[a].wheelObj.position[1]=c.y();this.wheels[a].wheelObj.position[2]=c.z();b=b.getRotation();r.x=
b.x();r.y=b.y();r.z=b.z();r.w=b.w();b=r.toEuler();this.wheels[a].wheelObj.rotation[0]=b[0];this.wheels[a].wheelObj.rotation[1]=b[1];this.wheels[a].wheelObj.rotation[2]=b[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(e){if(this.body&&(this.body.isActive()||e))return this.body.getBody().getMotionState().getWorldTransform(q),e=q.getOrigin(),e.x!=e.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
e.x(),this.sceneObject.position[1]=e.y(),this.sceneObject.position[2]=e.z()),e=q.getRotation(),r.x=e.x(),r.y=e.y(),r.z=e.z(),r.w=e.w(),r.x!=r.x?console.log("rotation is NaN"):(e=r.toEuler(),this.sceneObject.rotation[0]=e[0],this.sceneObject.rotation[1]=e[1],this.sceneObject.rotation[2]=e[2]),!0},setEngineForce:function(e){this.gEngineForce=e;if(this.gEngineForce>this.maxEngineForce)this.gEngineForce=this.maxEngineForce;if(this.gEngineForce<-this.maxEngineForce)this.gEngineForce=-this.maxEngineForce},
getEngineForce:function(){return this.gEngineForce},incEngine:function(e){this.setEngineForce(this.getEngineForce()+e)},decEngine:function(e){this.setEngineForce(this.getEngineForce()-e)},setSteering:function(e){this.gVehicleSteering=e},getSteering:function(){return this.gVehicleSteering},incSteering:function(e){this.gVehicleSteering+=e;if(this.gVehicleSteering>this.steeringClamp)this.gVehicleSteering=this.steeringClamp;if(this.gVehicleSteering<-this.steeringClamp)this.gVehicleSteering=-this.steeringClamp},
setBrake:function(e){this.gBreakingForce=e},getWheelGroundPosition:function(e){return this.wheels[e].wheelObj.getWorldPosition()-[0,wheels[e].getWheelRadius(),0]},getWheelSkid:function(e){return this.m_vehicle.getWheelInfo(e).get_m_skidInfo()},getRigidGround:function(e){this.m_vehicle.getWheelInfo(e)},addWheel:function(e,a){if(a===y)a=this.wheels.length;this.wheels[a]=e},getWheel:function(e){return this.wheels[e]},bindToScene:function(e){for(var a=this.wheels.length,b=0;b<a;b++)e.bind(this.getWheelObj(b));
e.bind(this.getSceneObject())},getWheelObj:function(e){return this.getWheel(e).wheelObj},updateSuspension:function(){var e,a=this.m_vehicle.getNumWheels();for(e=0;e<a;e++){var b=this.m_vehicle.getWheelInfo(e);b.set_m_suspensionStiffness(this.wheels[e].getSuspensionStiffness());b.set_m_suspensionRestLength1(this.wheels[e].getSuspensionRest());b.set_m_wheelsDampingRelaxation(this.wheels[e].getDampingRelaxation());b.set_m_wheelsDampingCompression(this.wheels[e].getDampingCompression());b.set_m_frictionSlip(this.wheels[e].getFrictionSlip());
b.set_m_rollInfluence(this.wheels[e].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(e=0;e<a;e++)this.m_vehicle.updateWheelTransform(e,!0)}},getMass:function(){return this.mass},setMass:function(e){this.mass=e;this.body&&this.body.setMass(this.mass)}};var e=function(e){e=n.get(e)||{};this.wheelRef=new n.SceneObject;this.wheelObj=new n.SceneObject;this.wheelRef.scale=e.scale||[1,1,1];this.wheelRadius=e.radius||0;this.wheelWidth=e.width||0;e.mesh!=y&&this.setModel(e.mesh);
this.suspensionStiffness=e.suspensionStiffness||40;this.suspensionRest=e.suspensionRest||0.05;this.dampingRelaxation=e.dampingRelaxation||2.3;this.dampingCompression=e.dampingCompression||2.4;this.frictionSlip=e.frictionSlip||0.94;this.rollInfluence=e.rollInfluence||0.5;this.wheelPosition=e.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=e.steering||!1;this.braking=e.braking||!1;this.driving=e.driving||!1};e.prototype={setModel:function(e,a,b){this.wheelModel=e;this.wheelRadius=a||0;this.wheelWidth=
b||0;if(this.wheelRadius===0)this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2;if(this.wheelWidth===0)this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0];this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(e){this.suspensionStiffness=e},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(e){this.suspensionRest=
e},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(e){this.dampingRelaxation=e},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(e){this.dampingCompression=e},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(e){this.frictionSlip=e},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(e){this.rollInfluence=e},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(e){this.wheelRadius=e},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(e){this.wheelWidth=e},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(e){this.wheelRotation=e;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(e){this.wheelPosition=e;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(e){this.steering=
e},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(e){this.driving=e},isDriving:function(){return this.driving}};return{Vehicle:s,VehicleWheel:e}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
