try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(m,y,w,r,o){function s(a,c){if("object"!==typeof a)return n("enumerator validation failed, invalid type base object."),o;if(c===o)return o;if("number"===typeof c)return c;if("string"===typeof c){var f=parseInt(c,10);if(""!==c&&isFinite(f))return f;f=c.toUpperCase();f=a[f];if(f!==o)return f;n("enumerator validation failed, unknown enum value: "+c);var f="",d;for(d in a)a.hasOwnProperty(d)&&(""!==f&&(f+=", "),f+=d.toLowerCase());n("possible enum values are: "+f)}return o}var b="";try{for(var g=
y.querySelectorAll("script"),a=0,c=g.length;a<c;a++){var e=g[a].src.lastIndexOf("/CubicVR.js");-1<e&&(b=g[a].src.substr(0,e)+"/")}}catch(d){}var f=m.CubicVR={};f.contexts={};var n;try{n=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(h){n=r}var q={quality:{LOW:0,MEDIUM:1,HIGH:2}};m.cubicvr=q;var A={},v=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t=function(a){function c(a,f,d){var h=function(){};h.prototype=a.prototype;f.prototype=new h;for(var n in d)f.prototype[n]=
d[n];return f}var d=this,h;a&&(h=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return h}}));d.undef=o;d.nop=r;d.scriptLocation=b;d.GLCore=z;d.Textures=[];d.Textures_obj=[];d.Textures_ref=[];d.Images=[];d.ShaderPool=[];d.log=n;d.enums=f.enums;d.MAX_LIGHTS=6;d.extendClassGeneral=c;d.extendClass=function(a,f,d){return c(a,function(){a.apply(this);f.apply(this,arguments)},d)};d.features={};d.quality=f.enums.HIGH;var e={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},g={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},t={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};d.features=t;var z={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,
resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,c,h){var e,q=d.util,g=f.enums;if(c&&h){c=q.getScriptContents(c);h=q.getScriptContents(h)}else if(m.CubicVRShader.CubicVRCoreVS&&m.CubicVRShader.CubicVRCoreFS){c=m.CubicVRShader.CubicVRCoreVS;h=m.CubicVRShader.CubicVRCoreFS}else{c=q.getScriptContents(b+"CubicVR_Core.vs");h=q.getScriptContents(b+"CubicVR_Core.fs")}if(a===o){a=y.createElement("canvas");if(!e)try{e=a.getContext("experimental-webgl",{antialias:d.features.antiAlias})}catch(t){return null}z.gl=
e;if(z.fixed_size!==null){z.width=z.fixed_size[0];z.height=z.fixed_size[1];z.resizeElement(a,z.width,z.height)}else{z.addResizeable(a);if(z.canvasSizeFactor!==1&&a.getContext!==o){var q=w.round(m.innerWidth*z.canvasSizeFactor),v=w.round(m.innerHeight*z.canvasSizeFactor);z.resizeElement(a,q,v);a.style.top=m.innerHeight/2-v/2+"px";a.style.left=m.innerWidth/2-q/2+"px";a.style.position="absolute"}else z.resizeElement(a,m.innerWidth,m.innerHeight)}y.body.appendChild(a)}if(a.getContext!==o&&a.width!==o&&
a.height!==o){try{e||(e=a.getContext("experimental-webgl",{antialias:d.features.antiAlias}));e.viewport(0,0,a.width,a.height);z.canvas=a;z.width=a.width;z.height=a.height;e.clearColor(0,0,0,1);e.clearDepth(1);e.enable(e.DEPTH_TEST);e.depthFunc(e.LEQUAL)}catch(A){}if(!e)return null}else e=a;z.gl=e;z.CoreShader_vs=c;z.CoreShader_fs=h;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(c=f.enums.light.type.NULL;c<g.light.type.MAX;c++)d.ShaderPool[c]=[];h=new d.Texture;a=new d.Material;for(c=
0;c<g.texture.map.MAX;c++)c!==g.texture.map.BUMP&&a.setTexture(h,c);a.opacity=0.5;for(c=1;;){if(!a.use(g.light.type.POINT,c)||c===8){d.MAX_LIGHTS=c;break}c++}a=z.emptyLight=new d.Light(g.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;n("Calibrated maximum lights per pass to: "+c);for(c=g.light.type.NULL;c<g.light.type.MAX;c++)d.ShaderPool[c]=[];if(z.resizeList.length){m.addEventListener("resize",function(){d.GLCore.onResize()},false);z.resize_active=true}return e},
addResizeable:function(a){d.GLCore.resizeList.push(a)},onResize:function(){var a=m.innerWidth,c=m.innerHeight;if(z.fixed_size!==null){a=d.GLCore.fixed_size[0];c=d.GLCore.fixed_size[1]}for(var f=0,h=d.GLCore.resizeList.length;f<h;f++)z.resizeElement(d.GLCore.resizeList[f],a,c)},setFixedAspect:function(a){d.GLCore.fixed_aspect=a},setFixedSize:function(a,c){d.GLCore.fixed_size=[a,c]},getCanvas:function(){return d.GLCore.canvas},resizeElement:function(a,c,f){var h=z.gl;if(z.fixed_aspect!==0){var n=c*
(1/d.GLCore.fixed_aspect);if(n>f){n=f;c=f*d.GLCore.fixed_aspect}f=n}if(a.getContext!==o){a.width=c;a.height=f;if(!d.GLCore.fixed_size){a.style.left=(m.innerWidth/2-c/2|0)+"px";a.style.top=(m.innerHeight/2-f/2|0)+"px";a.style.position="absolute"}h.viewport(0,0,c,f)}else a.resize(c,f)},setDepthAlpha:function(a,c,f){z.depth_alpha=a;z.depth_alpha_near=c;z.depth_alpha_far=f},setDefaultFilter:function(a){z.default_filter=s(d.enums.texture.filter,a)},setSoftShadows:function(a){z.soft_shadow=a},setFog:function(a){z.fog_enabled=
a},setFogExp:function(a,c){z.fog_enabled=true;z.fogLinear=false;z.fogExp=true;z.fogColor=a;z.fogDensity=c},setNoise:function(a){z.fogNoise=a},setFogLinear:function(a,c,f){z.fog_enabled=true;z.fogExp=false;z.fogLinear=true;z.fogColor=a;z.fogNear=c;z.fogFar=f},setCanvasSizeFactor:function(a){z.canvasSizeFactor=a},setQuality:function(a){a=s(q.quality,a);if(a===q.quality.HIGH)d.features=t;else if(a===q.quality.MEDIUM)d.features=g;else if(a===q.quality.LOW)d.features=e;d.quality=a;return d.features},getQuality:function(){return d.features}},
F=function(a,c,f){for(var h,n=y.getElementsByTagName("script"),e=0;e<n.length;++e){var q=n[e];if(q.getAttribute("data-cubicvr")){var b=q.getAttribute("src");if(b){var g=new XMLHttpRequest;g.open("GET",b,false);g.send(null);if(g.status===200||g.status===0)q.text=g.responseText}}}if(typeof a==="object")if(a.getContext)h=a;else{h=a.canvas;c=a.vertexShader||c;f=a.fragmentShader||f}else if(a){a[0]=="#"&&(a=a.substr(1));h=y.getElementById(a)}for(var t in A){var a=A[t](d),v;for(v in a)a.hasOwnProperty(v)&&
(d[v]=a[v])}z.init(h,c,f);return z.gl};d.GLCore=z;d.init=F;d.start=function(a,c,f,h,n){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=o);f=f||"Sorry, your browser does not appear to support WebGL :-(";if(a=F(a,h,n)){c&&typeof c==="function"&&c(a,d.getCanvas());return a}if(!a){f&&typeof f==="function"?f():alert(f);return false}};d.addResizeable=z.addResizeable;d.setFixedAspect=z.setFixedAspect;d.setFixedSize=z.setFixedSize;d.setCanvasSizeFactor=z.setCanvasSizeFactor;d.getCanvas=z.getCanvas;d.enums=
q;d.IdentityMatrix=v;d.Textures=d.Textures;d.Textures_obj=d.Textures_obj;d.Images=d.Images;d.globalAmbient=[0.1,0.1,0.1];d.setGlobalAmbient=function(a){d.globalAmbient=a};d.setGlobalDepthAlpha=z.setDepthAlpha;d.setDefaultFilter=z.setDefaultFilter;d.setSoftShadows=z.setSoftShadows;d.setQuality=z.setQuality;d.getQuality=z.getQuality;d.RegisterModule=f.RegisterModule;d.getScriptLocation=f.getScriptLocation;d.setFogExp=z.setFogExp;d.setFogLinear=z.setFogLinear;d.setFogNoise=z.setFogNoise;d.parseEnum=
s};f.init=function(a,c,d){var h;a&&(a.context&&"string"===typeof a.context)&&(h=a.context);h=new t(h);if(h.context)return f.contexts[h.context]=h,h.init(a,c,d),h;m.CubicVR=f=h;h.init(a,c,d);return h.GLCore.gl};f.start=function(a,c,d,h,n){var e=new t;m.CubicVR=f=e;e.start(a,c,d,h,n);return e};f.RegisterModule=function(a,c){A[a]=c};f.getScriptLocation=function(){return b};f.enums=q})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(m){function y(a){return this.clearStack(a)}function w(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}var r=m.undef,o=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=Math.PI/2,b={length:function(a){var c=a[0],e=a[1],a=a[2];return Math.sqrt(c*c+e*e+a*a)},normalize:function(a){var c=a[0],e=a[1],d=a[2];
return(c=Math.sqrt(c*c+e*e+d*d))?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},angle:function(a,c){return Math.acos((a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])))},cross:function(a,c){return[a[1]*c[2]-c[1]*a[2],a[2]*c[0]-c[2]*a[0],a[0]*c[1]-c[0]*a[1]]},multiply:function(a,c){return[a[0]*c,a[1]*c,a[2]*c]},add:function(a,c){return[a[0]+c[0],a[1]+c[1],a[2]+c[2]]},subtract:function(a,c){return[a[0]-
c[0],a[1]-c[1],a[2]-c[2]]},equal:function(a,c,e){e===r&&(e=1.0E-7);return a===r&&c===r?!0:a===r||c===r?!1:Math.abs(a[0]-c[0])<e&&Math.abs(a[1]-c[1])<e&&Math.abs(a[2]-c[2])<e},moveViewRelative:function(a,c,e,d,f){var n=Math.atan2(d,e),c=Math.atan2(c[2]-a[2],c[0]-a[0]),e=Math.sqrt(e*e+d*d),n=c+n+s;return"object"===typeof f?[f[0]+e*Math.cos(n),f[1],f[2]+e*Math.sin(n)]:[a[0]+e*Math.cos(n),a[1],a[2]+e*Math.sin(n)]},trackTarget:function(a,c,e,d){var c=b.subtract(c,a),f=b.length(c),n;n=b.normalize(c);n=
b.multiply(n,e*(1/(1/(f-d))));f>d?a=b.add(a,n):f<d?(n=b.normalize(c),n=b.multiply(n,e*(1/(1/Math.abs(f-d)))),a=b.subtract(a,n)):a=[a[0],a[1]+n[2],a[2]];return a},getClosestTo:function(a,c,e){c=b.subtract(c,a);e=b.subtract(e,a);return b.add(b.multiply(c,b.dot(c,e)/b.dot(c,c)),a)},linePlaneIntersect:function(a,c,e,d){var f=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2],c=a[0]*(d[0]-e[0])+a[1]*(d[1]-e[1])+a[2]*(d[2]-e[2]);if(0.0010>Math.abs(c))return!1;a=-(f+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/c;return[e[0]+a*(d[0]-e[0]),
e[1]+a*(d[1]-e[1]),e[2]+a*(d[2]-e[2])]}},g={lookat:function(a,c,e,d,f,n,h,q,g){var v=[],t=[],D=[],t=[];v[0]=d-a;v[1]=f-c;v[2]=n-e;D[0]=h;D[1]=q;D[2]=g;v=b.normalize(v);t=b.cross(v,D);t=b.normalize(t);D=b.cross(t,v);t=[t[0],D[0],-v[0],0,t[1],D[1],-v[1],0,t[2],D[2],-v[2],0,0,0,0,1];d=new m.Transform(t);d.translate([-a,-c,-e]);return d.getResult()},multiply:function(a,c,e){e===r&&(e=[]);e[0]=a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12]*c[3];e[1]=a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13]*c[3];e[2]=a[2]*c[0]+a[6]*c[1]+
a[10]*c[2]+a[14]*c[3];e[3]=a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+a[15]*c[3];e[4]=a[0]*c[4]+a[4]*c[5]+a[8]*c[6]+a[12]*c[7];e[5]=a[1]*c[4]+a[5]*c[5]+a[9]*c[6]+a[13]*c[7];e[6]=a[2]*c[4]+a[6]*c[5]+a[10]*c[6]+a[14]*c[7];e[7]=a[3]*c[4]+a[7]*c[5]+a[11]*c[6]+a[15]*c[7];e[8]=a[0]*c[8]+a[4]*c[9]+a[8]*c[10]+a[12]*c[11];e[9]=a[1]*c[8]+a[5]*c[9]+a[9]*c[10]+a[13]*c[11];e[10]=a[2]*c[8]+a[6]*c[9]+a[10]*c[10]+a[14]*c[11];e[11]=a[3]*c[8]+a[7]*c[9]+a[11]*c[10]+a[15]*c[11];e[12]=a[0]*c[12]+a[4]*c[13]+a[8]*c[14]+a[12]*c[15];
e[13]=a[1]*c[12]+a[5]*c[13]+a[9]*c[14]+a[13]*c[15];e[14]=a[2]*c[12]+a[6]*c[13]+a[10]*c[14]+a[14]*c[15];e[15]=a[3]*c[12]+a[7]*c[13]+a[11]*c[14]+a[15]*c[15];return e},vec4_multiply:function(a,c,e){e===r&&(e=[]);e[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12]*a[3];e[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13]*a[3];e[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14]*a[3];e[3]=c[3]*a[0]+c[7]*a[1]+c[11]*a[2]+c[15]*a[3];return e},vec3_multiply:function(a,c,e){e===r&&(e=[]);e[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12];e[1]=c[1]*a[0]+
c[5]*a[1]+c[9]*a[2]+c[13];e[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14];return e},perspective:function(a,c,e,d){a=Math.tan(a*Math.PI/360);return[1/(a*c),0,0,0,0,1/a,0,0,0,0,-(d+e)/(d-e),-1,0,0,-(2*d*e)/(d-e),0]},ortho:function(a,c,e,d,f,n){return[2/(c-a),0,0,0,0,2/(d-e),0,0,0,0,-2/(n-f),0,-(a+c)/(c-a),-(d+e)/(d-e),-(n+f)/(n-f),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+
(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var c=[],e=a[0],d=a[1],f=a[2],n=a[4],h=a[5],q=a[6],b=a[8],g=a[9],a=a[10],t=a*h-q*g,D=-a*n+q*b,m=g*n-h*b,o=e*t+d*D+f*m;if(!o)return null;o=1/o;c[0]=t*o;c[1]=(-a*d+f*g)*o;c[2]=(q*d-f*h)*o;c[3]=D*o;c[4]=
(a*e-f*b)*o;c[5]=(-q*e+f*n)*o;c[6]=m*o;c[7]=(-g*e+d*b)*o;c[8]=(h*e-d*n)*o;return c},inverse:function(a,c){var e=a[0]*a[5]-a[1]*a[4],d=a[0]*a[6]-a[2]*a[4],f=a[0]*a[7]-a[3]*a[4],n=a[1]*a[6]-a[2]*a[5],h=a[1]*a[7]-a[3]*a[5],q=a[2]*a[7]-a[3]*a[6],b=a[8]*a[13]-a[9]*a[12],g=a[8]*a[14]-a[10]*a[12],t=a[8]*a[15]-a[11]*a[12],D=a[9]*a[14]-a[10]*a[13],m=a[9]*a[15]-a[11]*a[13],o=a[10]*a[15]-a[11]*a[14],s=e*o-d*m+f*D+n*t-h*g+q*b;return 0!==s?(c===r&&(c=[]),c[0]=0+a[5]*o-a[6]*m+a[7]*D,c[4]=0-a[4]*o+a[6]*t-a[7]*g,
c[8]=0+a[4]*m-a[5]*t+a[7]*b,c[12]=0-a[4]*D+a[5]*g-a[6]*b,c[1]=0-a[1]*o+a[2]*m-a[3]*D,c[5]=0+a[0]*o-a[2]*t+a[3]*g,c[9]=0-a[0]*m+a[1]*t-a[3]*b,c[13]=0+a[0]*D-a[1]*g+a[2]*b,c[2]=0+a[13]*q-a[14]*h+a[15]*n,c[6]=0-a[12]*q+a[14]*f-a[15]*d,c[10]=0+a[12]*h-a[13]*f+a[15]*e,c[14]=0-a[12]*n+a[13]*d-a[14]*e,c[3]=0-a[9]*q+a[10]*h-a[11]*n,c[7]=0+a[8]*q-a[10]*f+a[11]*d,c[11]=0-a[8]*h+a[9]*f-a[11]*e,c[15]=0+a[8]*n-a[9]*d+a[10]*e,e=1/s,c[0]*=e,c[1]*=e,c[2]*=e,c[3]*=e,c[4]*=e,c[5]*=e,c[6]*=e,c[7]*=e,c[8]*=e,c[9]*=e,
c[10]*=e,c[11]*=e,c[12]*=e,c[13]*=e,c[14]*=e,c[15]*=e,c):null},identity:function(a){if(a==r)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,c,e,d){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,c,e,1];if(d===r)return a;g.multiply(d.slice(0),a,d)},rotateAxis:function(a,c,e,d,f){var n=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),c=[a+c*c*(1-a),c*e*(1-a)-d*n,c*d*(1-a)+e*n,0,e*c*
(1-a)+d*n,a+e*e*(1-a),e*d*(1-a)-c*n,0,d*c*(1-a)-e*n,d*e*(1-a)+c*n,a+d*d*(1-a),0,0,0,0,1];if(f===r)return c;g.multiply(f.slice(0),c,f)},rotate:function(a,c,e,d){var f;d===r&&(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==e&&(f=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),g.multiply(d.slice(0),[e,f,0,0,-f,e,0,0,0,0,1,0,0,0,0,1],d));0!==c&&(f=Math.sin(c*(Math.PI/180)),e=Math.cos(c*(Math.PI/180)),g.multiply(d.slice(0),[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1],d));0!==a&&(f=Math.sin(a*(Math.PI/180)),e=Math.cos(a*
(Math.PI/180)),g.multiply(d.slice(0),[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1],d));return d},scale:function(a,c,e,d){if(d===r)return[a,0,0,0,0,c,0,0,0,0,e,0,0,0,0,1];g.multiply(d.slice(0),[a,0,0,0,0,c,0,0,0,0,e,0,0,0,0,1],d)},transform:function(a,c,e){var d=g.identity();a&&g.translate(a[0],a[1],a[2],d);c&&(0===c[0]&&0===c[1]&&0===c[2]||g.rotate(c[0],c[1],c[2],d));e&&(1===e[0]&&1===e[1]&&1===e[2]||g.scale(e[0],e[1],e[2],d));return d}};y.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,
0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=m.mat4;if(!this.c_stack)return this.m_stack[0];var c=o;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var e=this.valid;e<this.c_stack+1;e++)c=a.multiply(c,this.m_stack[e]),this.m_cache[e]=c;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},
pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:o;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==r?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,c,e){var d=m.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var f=this.getIdentity();f[12]=a;f[13]=c;f[14]=e;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],
f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,c,e){var d=m.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var f=this.getIdentity();f[0]=a;f[5]=c;f[10]=e;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,c,e,d){var f=m.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var n,h;if(c||
e||d)n=Math.sin(-a*(Math.PI/180)),h=Math.cos(-a*(Math.PI/180));c&&(a=this.getIdentity(),a[5]=h*c,a[9]=n*c,a[6]=-n*c,a[10]=h*c,this.m_stack[this.c_stack]=f.multiply(a,this.m_stack[this.c_stack]));e&&(c=this.getIdentity(),c[0]=h*e,c[8]=-n*e,c[2]=n*e,c[10]=h*e,this.m_stack[this.c_stack]=f.multiply(c,this.m_stack[this.c_stack]));d&&(e=this.getIdentity(),e[0]=h*d,e[4]=n*d,e[1]=-n*d,e[5]=h*d,this.m_stack[this.c_stack]=f.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;
return this}};w.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var c=1+a[0]+a[5]+a[10],e,d,f;1.0E-8<c?(e=2*Math.sqrt(c),c=(a[9]-a[6])/e,d=(a[2]-a[8])/e,f=(a[4]-a[1])/e,a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=2*Math.sqrt(1+a[0]-a[5]-a[10]),c=0.25*e,d=(a[4]+a[1])/e,f=(a[2]+a[8])/e,a=(a[9]-a[6])/e):a[5]>a[10]?(e=2*Math.sqrt(1+a[5]-a[0]-
a[10]),c=(a[4]+a[1])/e,d=0.25*e,f=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=2*Math.sqrt(1+a[10]-a[0]-a[5]),c=(a[2]+a[8])/e,d=(a[9]+a[6])/e,f=0.25*e,a=(a[4]-a[1])/e);this.x=c;this.y=d;this.z=f;this.w=a},fromEuler:function(a,c,e){var d=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),f=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),n=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),h=d*f,q=c*e;this.w=h*n-q*a;this.x=h*a+q*n;this.y=c*f*n+d*e*a;this.z=d*e*n-c*f*a},toEuler:function(){var a=this.w*
this.w,c=this.x*this.x,e=this.y*this.y,d=this.z*this.z,f=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-c-e+d+a),n=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),c-e-d+a);return[f,n,a]},multiply:function(a,c){c===r&&(c=a,a=this);return new w(a.x*c.w+a.w*c.x+a.y*c.z-a.z*c.y,a.y*c.w+a.w*c.y+a.z*c.x-a.x*c.z,a.z*c.w+a.w*c.z+a.x*c.y-a.y*c.x,a.w*c.w-a.x*c.x-a.y*c.y-a.z*c.z)}};return{vec2:{equal:function(a,c,e){e===r&&(e=1.0E-8);
return a===r&&c===r?!0:a===r||c===r?!1:Math.abs(a[0]-c[0])<e&&Math.abs(a[1]-c[1])<e}},vec3:b,mat3:{transpose_inline:function(a){var c=a[1],e=a[2],d=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=e;a[7]=d},vec3_multiply:function(a,c,e){e===r&&(e=[]);e[0]=c[0]*a[0]+c[3]*a[1]+c[6]*a[2];e[1]=c[1]*a[0]+c[4]*a[1]+c[7]*a[2];e[2]=c[2]*a[0]+c[5]*a[1]+c[8]*a[2];return e}},mat4:g,aabb:{engulf:function(a,c){a[0][0]>c[0]&&(a[0][0]=c[0]);a[0][1]>c[1]&&(a[0][1]=c[1]);a[0][2]>c[2]&&(a[0][2]=c[2]);a[1][0]<c[0]&&(a[1][0]=
c[0]);a[1][1]<c[1]&&(a[1][1]=c[1]);a[1][2]<c[2]&&(a[1][2]=c[2])},reset:function(a,c){void 0===c&&(c=[0,0,0]);a[0][0]=c[0];a[0][1]=c[1];a[0][2]=c[2];a[1][0]=c[0];a[1][1]=c[1];a[1][2]=c[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,c){var e=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3];return 0>e?-1:0<e?1:0},normalize:function(a){var c=Math.sqrt(a[0]*
a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c}},sphere:{intersects:function(a,c){var e=m.vec3.subtract([a[0],a[1],a[2]],[c[0],c[1],c[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),d=a[3]+c[3];return e*e<d*d?!0:!1}},triangle:{normal:function(a,c,e,d){d===r&&(d=[]);var f=a[0]-c[0],n=a[1]-c[1],a=a[2]-c[2],h=c[0]-e[0],q=c[1]-e[1],c=c[2]-e[2];d[0]=n*c-a*q;d[1]=a*h-f*c;d[2]=f*q-n*h;return d}},Transform:y,Quaternion:w}});
CubicVR.RegisterModule("Utility",function(m){var y=m.undef,w=m.log,r={},o={},s={multiSplit:function(b,g){for(var a=b.split(g[0]),c=1,e=g.length;c<e;c++)for(var d=g[c],f=0,n=a.length;f<n;f++){var h=a[f].trim().split(d),q=!0;if(1<h.length)for(var A=0;A<h.length;A++)""!==h[A].trim()&&(a.splice(f+A,0===A?1:0,h[A]),A&&n++,q=!1);else a[f]=a[f].trim().replace(d,""),""!==a[f]&&(q=!1);q&&(a.splice(f,1),n--,f--)}return a},getJSONScriptObj:function(b,g){if("string"===typeof b&&0<b.length&&"#"===b.charAt(0)){var a=
document.getElementById(b.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return b},getScriptContents:function(b){var g=document.getElementById(b),a="",c="";if(g){if(""!==g.src||g.attributes.srcUrl!==y)c=""!==g.src?g.src:g.attributes.srcUrl.value}else c=b;if(0!==c.length){if(b=new XMLHttpRequest,b.overrideMimeType&&b.overrideMimeType("application/json"),b.open("GET",c,!1),b.send(null),200===b.status||0===b.status)a=b.responseText}else for(c=g.firstChild;c;)3===c.nodeType&&(a+=c.textContent),
c=c.nextSibling;return a},xmlNeedsBadgerFish:function(b){for(b=[b];b.length;){var g=b.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,c=g.childNodes.length;a<c;a++)b.push(g.childNodes[a])}return!1},getFirstEntry:function(b){for(var g in b)if(b.hasOwnProperty(g))return b[g]},getURIFileType:function(b){function g(a){for(var c in e)if(e.hasOwnProperty(c)&&-1!==e[c].indexOf(a))return c;return y}var a=b.toLowerCase(),c=["_ext","ext"],e={json:["js","javascript","json"],xml:["xml"]};if(-1!==
a.indexOf("?")){var d=a.split("?"),a=d[0];if(d[1])for(var d=-1===d[1].indexOf("&")?[d[1]]:d[1].split("&"),f=0,n=d.length;f<n;f++){var h=d[f];if(-1!==h.indexOf("=")&&(h=h.split("="),-1!==c.indexOf(h[0]))){var q=g(h[1]);if(q)return q;w("Unable to determine extension type '"+h[1]+"' provided for URI: ["+b+"], falling back to filename part.")}}}return-1!==a.indexOf(".")?(b=a.split("."),g(b[b.length-1])):y},get:function(b,g){var a=null,c=null,e=null,g=g||null;if(b===y)return y;if(isFinite(b))return b;
"function"===typeof b&&(b=b(g));if("object"===typeof b)return g&&!(b instanceof g)?new g(b):b;if("string"==typeof b){if(-1!==b.indexOf("\n"))return b;"#"==b[0]&&(a=b.substr(1),(e=document.getElementById(a))&&(c=e.src||null));!e&&(!a&&!c&&b)&&(c=b)}if(e&&!c)return CubicVR.util.collectTextNode(e);if(c){var a=null,d=o[c]||null;if(!d){var f=s.getURIFileType(c);if(f===y&&!e)return c;"json"===f?d=CubicVR.util.getJSON(c):a="xml"===f?CubicVR.util.getXML(c):CubicVR.util.getURL(c);a&&a.childNodes?d=s.getFirstEntry(s.xml2json(a)):
a&&(d=a)}d&&o[c]===y&&(o[c]=d);if(g){if(r[c]&&r[c]instanceof g)return r[c];if(d)return r[c]=new g(d),r[c]}else if(d)return d;return c}a&&!e&&console.log("Unable to retrieve requested ID: '"+b+"'");return y},clearCache:function(){r={};o={}},getURL:function(b){try{var g=new XMLHttpRequest;g.open("GET",b,!1);g.send(null);if(200===g.status||0===g.status){if(g.responseText.length)return g.responseText;if(g.responseXML)return g.responseXML}}catch(a){alert(b+" failed to load.")}return null},getXML:function(b){try{var g=
new XMLHttpRequest;g.open("GET",b,!1);g.overrideMimeType("application/xml");g.send(null);if(200===g.status||0===g.status)return g.responseXML}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},getJSON:function(b){try{var g=new XMLHttpRequest;g.open("GET",b,!1);g.overrideMimeType("application/json");g.send(null);if(200===g.status||0===g.status)return eval("("+g.responseText+")")}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},repackArray:function(b,g,
a){b.length!==parseInt(g,10)*parseInt(a,10)&&w("array repack error, data size !== stride*count: data.length="+b.length+" stride="+g+" count="+a);for(var a=[],c=0,e=0,d=b.length;e<d;e++){var f=e%g;0===f&&(a[c]=[]);a[c][f]=b[e];f===g-1&&c++}return a},collectTextNode:function(b){if(!b)return"";for(var g="",b=b.childNodes,a=0,c=b.length;a<c;a++)g+=b[a].nodeValue;return g},floatDelimArray:function(b,g){"\n"!=g&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(g?g:","),c=0,e=a.length;c<
e;c++)a[c]=parseFloat(a[c]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(b,g){"\n"!=g&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(g?g:","),c=0,e=a.length;c<e;c++)a[c]=parseInt(a[c],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(b,g){"\n"!=g&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(g?g:","),c=0,e=a.length;c<e;c++)a[c]=a[c];return a},xmlstring2json:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,c=[],e=[],d={},f=d,n=0,h=b.length;n<h;n++){var q=b[n];if(!(g.test(q)||""===q)&&!/<\?\s?xml[^>]*>/.test(q))if(/<.*?>/.test(q)){a=q.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]&&(q=a.split(" "),a=q[0],q=q.slice(1).join(" "),c.push(a),e.push(d),d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:(d[a]||(d[a]={}),d=d[a]),d instanceof Array&&(d.push({}),d=d[d.length-1]),"/"===a.substr(a.length-1)||"/"===q.substr(q.length-1)))a="/"+a;if("/"===a[0]){a=
a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;c.pop();d=e.length?e[e.length-1]:null;e.pop()}}else{var A=e[e.length-1][a];A instanceof Array?(A.pop(),A.push(s.parseNumeric(q))):e[e.length-1][a]=s.parseNumeric(q)}}return f},xmlstring2badgerfish:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,c=[],e=[],d={},f=d,n=0,h=b.length;n<h;n++)if(a=b[n],!(g.test(a)||""===a)&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=
a.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]){var q=a.split(" ");a=q[0];q=q.slice(1).join(" ");c.push(a);e.push(d);d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:d[a]||(d[a]={});d=d[a];d instanceof Array&&(d.push({}),d=d[d.length-1]);if("/"===a.substr(a.length-1)||"/"===q.substr(q.length-1))a="/"+a;for(var q=s.multiSplit(q,"= "),A="",v=0;v<q.length;v++){var t=q[v];"/"===t[t.length-1]&&(t=t.substr(0,t.length-1));if(1===v%2){if("'"===t[0]||'"'===t[0]){for(var D=t[0],t=t.substr(1);t[t.length-1]!==D&&q.length+
1<v;)t+=q.splice(v+1,1);t[t.length-1]===D&&(t=t.substr(0,t.length-1))}d["@"+A]=t}else A=t}}if("/"===a[0]){a=a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+c[c.length-1]),!1;c.pop();d=e.length?e[e.length-1]:null;e.pop()}}else d.$=a;return f},xml2badgerfish:function(b){var g={},a=[],c,e,d,f,n,h=/^\s+|\s+$/g;b.jsonParent=g;for(a.push(b);a.length;){e=a.pop();var q=null;d=e.jsonParent;b=0;for(c=e.childNodes.length;b<c;b++)f=e.childNodes[b],n=f.tagName,n!==y&&
(q=q||{},q[n]=q[n]||0,q[n]++);if(e.attributes&&e.attributes.length){b=0;for(c=e.attributes.length;b<c;b++)f=e.attributes[b],d["@"+f.name]=f.value}b=0;for(c=e.childNodes.length;b<c;b++)f=e.childNodes[b],n=f.tagName,1===f.nodeType?(1<q[n]?(d[n]=d[n]||[],d[n].push({}),f.jsonParent=d[n][d[n].length-1]):(d[n]=d[n]||{},f.jsonParent=d[n]),a.push(f)):3===f.nodeType&&""!==f.nodeValue.replace(h,"")&&(d.$=d.$||"",d.$+=f.nodeValue)}return g},isTextNode:function(b){for(var b=b.childNodes,g=0,a=b.length;g<a;g++)if(3!==
b[g].nodeType||b[g].childNodes.length)return!1;return!0},parseNumeric:function(b){var g=null,a,g=b.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===g)return g;if((-1!==g.indexOf(" ")||-1!==g.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=g.split(" ");
b=0;for(a=g.length;b<a;b++)g[b]=s.floatDelimArray(g[b],",");return g}}else{g=g.split(" ");b=0;for(a=g.length;b<a;b++)g[b]=s.intDelimArray(g[b],",");return g}else return s.floatDelimArray(g,",");else return s.floatDelimArray(g," ");else return s.intDelimArray(g,",");else return s.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);return!isNaN(a)?/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10):b},xml2json:function(b){var g={},a=[],c,e,d,f,n;b.jsonParent=g;for(a.push(b);a.length;){e=a.pop();var h=
null;d=e.jsonParent;b=0;for(c=e.childNodes.length;b<c;b++)f=e.childNodes[b],n=f.tagName,n!==y&&(h=h||{},h[n]=h[n]||0,h[n]++);b=0;for(c=e.childNodes.length;b<c;b++){f=e.childNodes[b];n=f.tagName;var q=s.isTextNode(f);1===f.nodeType&&(1<h[n]?(d[n]=d[n]||[],q?d[n].push(s.parseNumeric(s.collectTextNode(f))):(d[n].push({}),f.jsonParent=d[n][d[n].length-1])):q?d[n]=s.parseNumeric(s.collectTextNode(f)):(d[n]=d[n]||{},f.jsonParent=d[n]),q||a.push(f))}}return g}};return{util:s,get:s.get,clearCache:s.clearCache}});
CubicVR.RegisterModule("Shader",function(m){function y(d,f){var n=m.util,h,e,g,v,t=o.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==d.indexOf("\n")?(g=d,h=a(o.gl,d,"x-shader/x-vertex")):(h=c(o.gl,d),null===h&&(g=n.getURL(d),h=a(o.gl,g,"x-shader/x-vertex")));t.getShaderParameter(h,t.COMPILE_STATUS)||(this.vertexLog=t.getShaderInfoLog(h),this.success=!1);-1!==f.indexOf("\n")?(v=f,e=a(o.gl,f,"x-shader/x-fragment")):(e=c(o.gl,
f),null===e&&(v=n.getURL(f),e=a(o.gl,v,"x-shader/x-fragment")));t.getShaderParameter(e,t.COMPILE_STATUS)||(this.fragmentLog=t.getShaderInfoLog(e),this.success=!1);this.success?(this.shader=t.createProgram(),t.attachShader(this.shader,h),t.attachShader(this.shader,e),t.linkProgram(this.shader),o.gl.getProgramParameter(this.shader,t.LINK_STATUS)||(b("Error linking shader:\n"+t.getProgramInfoLog(this.shader)),this.success=!1)):(h=n.multiSplit(this.vertexLog,";\n"),n=n.multiSplit(this.fragmentLog,";\n"),
h.length&&this.dumpErrors(h,g),n.length&&this.dumpErrors(n,v))}function w(a){this._update=a.update||null;this._init=a.init||null;this._vertex=m.get(a.vertex)||null;this._fragment=m.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var r=m.undef,o=m.GLCore,s=m.enums,b=m.log,g=m.util;s.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,c,n){if("x-shader/x-fragment"===n)n=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===n)n=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(n,c);a.compileShader(n);return n},c=function(a,c){var n=document.getElementById(c);if(!n)return null;for(var h="",e=n.firstChild;e;)3===e.nodeType&&(h+=e.textContent),
e=e.nextSibling;if("x-shader/x-fragment"===n.type)n=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===n.type)n=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(n,h);a.compileShader(n);return n};y.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,c,e){for(var e=(e||"Error on line")+" ",c=c.split("\n"),h=0,q=a.length;h<q;h++){var b=a[h];if(0===b.indexOf("ERROR: ")){var b=b.substr(7).trim(),g=b.substr(0,b.indexOf(" ")),b=b.substr(g.length),g=g.split(":"),
g=parseInt(g[1],10);console.log(g+"> "+c[g-1]);console.log(e+g+", :"+b)}}},bindSelf:function(a){var c,e,h;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),e=c[0],c=c[1].split("."),c=c[1],this[h]===r&&(this[h]=[]),this[h][e]===r&&(this[h][e]={}),this[h][e][c]=this.uniforms[a]):(c=a.split("."),h=c[0],c=c[1],this[h]===r&&(this[h]={}),this[h][c]=this.uniforms[a]):-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),e=c[0],this[h]===r&&(this[h]=[]),this[h][e]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==r&&this.setMatrix(a,c);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
c!==r&&this.setVector(a,c);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==r&&this.setFloat(a,c);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=o.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,c){this.use();this.uniforms[a]=o.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==r&&this.setInt(a,c);this.bindSelf(a);return this.uniforms[a]},use:function(){o.gl.useProgram(this.shader)},setMatrix:function(a,c){var e=this.uniforms[a];if(null!==e){var h=c.length;16===h?o.gl.uniformMatrix4fv(e,!1,c):9===h?o.gl.uniformMatrix3fv(e,!1,c):4===
h&&o.gl.uniformMatrix2fv(e,!1,c)}},setInt:function(a,c){var e=this.uniforms[a];null!==e&&o.gl.uniform1i(e,c)},setFloat:function(a,c){var e=this.uniforms[a];null!==e&&o.gl.uniform1f(e,c)},setVector:function(a,c){var e=this.uniforms[a];if(null!==e){var h=c.length;3==h?o.gl.uniform3fv(e,c):2==h?o.gl.uniform2fv(e,c):o.gl.uniform4fv(e,c)}},clearArray:function(a){var c=o.gl,a=this.uniforms[a];null!==a&&c.disableVertexAttribArray(a)},bindArray:function(a,c){var e=o.gl,h=this.uniforms[a];if(null!==h){var q=
this.uniform_type[a];q===s.shader.uniform.ARRAY_VERTEX?(e.bindBuffer(e.ARRAY_BUFFER,c),e.vertexAttribPointer(h,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h)):q===s.shader.uniform.ARRAY_UV?(e.bindBuffer(e.ARRAY_BUFFER,c),e.vertexAttribPointer(h,2,e.FLOAT,!1,0,0)):q===s.shader.uniform.ARRAY_FLOAT&&(e.bindBuffer(e.ARRAY_BUFFER,c),e.vertexAttribPointer(h,1,e.FLOAT,!1,0,0))}}};var e={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var c={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var e=a[i];0===e.indexOf("#define")&&(e=e.split(" "),2<e.length&&(c[e[1]]=e.slice(2).join(" ")))}return c},replaceAll:function(a,c,e,h){var e=e||"",h=h||"",q;for(q in c)if(c.hasOwnProperty(q))for(var b=e+q+h;-1!==a.indexOf(b);)a=a.replace(b,e+c[q]+h);return a},getShaderInfo:function(a,c){var n,h,
q,b,v,t,D=["uniform","attribute","varying"],m=[],o={};t={};var s;c===r&&(c="");a=e.tidyScript(a);c=e.tidyScript(c);o.v_define=e.getDefines(a);o.f_define=e.getDefines(c);a=e.replaceAll(a,o.v_define,"[","]");c=e.replaceAll(c,o.f_define,"[","]");s=g.multiSplit(a+"\n"+c,"\n;");var u=[];b=q=-1;n=0;for(h=s.length;n<h;n++)v=s[n],-1===q&&0===v.indexOf("struct")?q=n:-1===b&&(-1!==q&&-1!==v.indexOf("}"))&&(b=n+1),-1!==q&&-1!==b&&(v=s.slice(q,b).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),u.push({start:q,end:b,struct:v.split("\n")}),b=q=-1);n=0;for(h=u.length;n<h;n++){var x=u[n].struct,w=null;q=0;for(b=x.length;q<b;q++)v=x[q].split(" "),1>=v.length||("struct"==v[0]?(w=v[1],t[w]={}):w&&(t[w][v[1]]=v[0]))}o.struct=t;n=0;for(h=D.length;n<h;n++)o[D[n]]=[];n=0;for(h=s.length;n<h;n++){v=s[n];q=0;for(b=D.length;q<b;q++)if(u=D[q],0===v.indexOf(u)&&(t=v.split(" "),3===t.length&&t[0]==u&&-1===m.indexOf(t[2])))if(m.push(t[2]),-1!==t[2].indexOf("[")){var x=t[2].split("["),
w=x[1].replace("]",""),z=parseInt(w,10);z===z&&(w=z);o[u].push({name:x[0],type:t[1],isArray:!0,len:w})}else o[u].push({name:t[2],type:t[1]})}return o},genShaderVarList:function(a,c){var e=a[c],h=[],q,b,g,t,D,m;if(!e)return[];q=0;for(b=e.length;q<b;q++){var o=e[q];if(a.struct[o.type]){var r=a.struct[o.type];if(r&&o.isArray){g=0;for(t=o.len;g<t;g++)for(m in D=o.name+"["+g+"]",r)r.hasOwnProperty(m)&&h.push({location:D+"."+m,type:r[m],basename:o.name})}else for(m in r)h.push({location:o.name+"."+m,type:r[m],
basename:o.name})}else if(o.isArray){g=0;for(t=o.len;g<t;g++)D=o.name+"["+g+"]",h.push({location:D,type:o.type,basename:o.name})}else h.push({location:o.name,type:o.type,basename:o.name})}return h},getShaderVars:function(a){var c={};c.uniform=e.genShaderVarList(a,"uniform");c.attribute=e.genShaderVarList(a,"attribute");return c}};w.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,c,n,h,q){n=n||[];a=m.util.get(a);c=m.util.get(c);q=q||"#define customShader_splice";if(h=h===r?this._vertex||this._fragment:h)h=a.indexOf(q),q=c.indexOf(q),-1!==h&&this._vertex&&(a=a.substr(0,h)+this._vertex),-1!==q&&this._fragment&&(c=c.substr(0,q)+this._fragment);this._shader=new m.Shader(a,c);this._shaderInfo=e.getShaderInfo(a,c);this._shaderVars=e.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",n);this._appendShaderVars(this._shaderVars,"attribute",n);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,c,e){for(var a=function(a,c){return function(f,d){d!==r&&(t.activeTexture(t.TEXTURE0+f),t.bindTexture(o.gl.TEXTURE_2D,m.Textures[d.tex_id]));c.value=f;a.update(c)}},h=0,q=this._shaderVars[c].length;h<q;h++){var b=this._shaderVars[c][h],g=b.location;if(-1===e.indexOf(b.basename)&&(b=b.type,"vec3"===b?"attribute"===c?this._shader.addVertexArray(g):
this._shader.addVector(g):"vec2"===b?"attribute"===c?this._shader.addUVArray(g):this._shader.addVector(g):"float"===b?"attribute"===c?this._shader.addFloatArray(g):this._shader.addFloat(g):"sampler2D"===b||"int"===b?this._shader.addInt(g):("mat4"===b||"mat3"===b||"mat2"===b)&&this._shader.addMatrix(g),g=this._bindSelf(g),"sampler2D"==b&&g)){var t=o.gl;g.set=a(this,g)}}},_bindSelf:function(a){var c,e,h,q;if(null!==this._shader.uniforms[a]){var b=function(a,c){return function(f){c.value=f;a.update(c)}};
-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),e=c[0],c=c[1].split("."),c=c[1],this[h]===r&&(this[h]=[]),this[h][e]===r&&(this[h][e]={}),q={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[h][e][c]=q):(c=a.split("."),h=c[0],c=c[1],this[h]===r&&(this[h]={}),q={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[h][c]=q):-1!==a.indexOf("[")?(c=a.split("["),h=c[0],c=c[1].split("]"),e=c[0],this[h]===
r&&(this[h]=[]),q={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[h][e]=q):(q={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=q);this._bindings.push(q);q&&(q.set=b(this,q));return q}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var c=0,e=this._bindings.length;c<e;c++)this.update(this._bindings[c],a)},update:function(a){if(this._initialized){var c=o.gl,e=a.value,h=a.location;
null!==h&&(a.type===s.shader.uniform.MATRIX?(a=e.length,16===a?c.uniformMatrix4fv(h,!1,e):9===a?c.uniformMatrix3fv(h,!1,e):4===a&&c.uniformMatrix2fv(h,!1,e)):a.type===s.shader.uniform.INT?c.uniform1i(h,e):a.type===s.shader.uniform.VECTOR?(a=e.length,3===a?c.uniform3fv(h,e):2===a?c.uniform2fv(h,e):c.uniform4fv(h,e)):a.type===s.shader.uniform.FLOAT?c.uniform1f(h,e):a.type===s.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,e),c.vertexAttribPointer(h,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(h)):
a.type===s.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,e),c.vertexAttribPointer(h,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(h)):a.type===s.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,e),c.vertexAttribPointer(h,1,c.FLOAT,!1,0,0),c.enableVertexAttribArray(h)))}}};return{Shader:y,shader_util:e,CustomShader:w}});
CubicVR.RegisterModule("MainLoop",function(m){function y(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function w(){null!==m.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(w),m.GLCore.mainloop.interval())}function r(a,c,e){window.requestAnimationFrame===s&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==m.GLCore.mainloop&&(!window.requestAnimationFrame&&m.GLCore.mainloop&&clearInterval(m.GLCore.mainloop.interval),m.GLCore.mainloop=null);if(null===a)m.GLCore.mainloop=null;else{this.renderList=[];var d=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],f=new y;f.start();this.timer=f;this.func=a;this.doclear=c!==s?c:!0;m.GLCore.mainloop=this;g.resizeList.length&&!m.GLCore.resize_active&&(window.addEventListener("resize",
function(){m.GLCore.onResize()},!1),m.GLCore.resize_active=!0);c=function(){return function(){var c=m.GLCore.gl;f.update();m.GLCore.mainloop.doclear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);a(f,m.GLCore.gl);var h=d[d.length-1],e=h.scenes;h.update&&h.update(f,c);if(e){c=0;for(h=e.length;c<h;++c){var b=e[c];if(!b.paused){b.update&&b.update(f,m.GLCore.gl);b.render()}}}}}();e?this.loopFunc=c:window.requestAnimationFrame?(this.interval=c,window.requestAnimationFrame(w)):this.interval=setInterval(c,
20)}}function o(a,c,e){this.canvas=a;this.camera=c;this.mpos=[0,0];this.mdown=!1;var d=this;this.mEvents={};this.keyState=[];for(var f in b.keyboard)this.keyState[f]=!1;this.onMouseDown=function(){return function(a){d.mdown=!0;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseDown&&d.mEvents.mouseDown(d,d.mpos,d.keyState)}}();this.onMouseUp=function(){return function(a){d.mdown=!1;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseUp&&d.mEvents.mouseUp(d,
d.mpos,d.keyState)}}();this.onMouseMove=function(){return function(a){var c=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];c[0]=a[0]-d.mpos[0];c[1]=a[1]-d.mpos[1];d.mpos=a;d.mEvents.mouseMove&&d.mEvents.mouseMove(d,d.mpos,c,d.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;d.mEvents.mouseWheel&&d.mEvents.mouseWheel(d,d.mpos,a,d.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,c=null;d.mEvents.keyPress?
(c=d.mEvents.keyPress(d,d.mpos,a,d.keyState),d.keyState[a]=c!==s?!!c:!0):d.keyState[a]=!0;d.keyState[a]&&d.mEvents.keyDown&&(c=d.mEvents.keyDown(d,d.mpos,a,d.keyState),d.keyState[a]=c!==s?!!c:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;d.mEvents.keyUp&&d.mEvents.keyUp(d,d.mpos,a,d.keyState);d.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,c,f){a.mdown&&a.orbitView(f)},mouseWheel:function(a,c,f){a.zoomView(f)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
!1!==e&&this.setEvents(e===s?this.eventDefaults:e);this.bind()}var s=m.undef,b=m.enums,g=m.GLCore;b.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};y.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(1E3*a|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};r.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var c=0;c<a.scenes.length;++c)a.scenes[c].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],c=0;c<a.scenes.length;++c)a.scenes[c].disable();1<this.renderStack.length&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var c=renderStack[renderStack.length-1],e,d=0,f=c.scenes.length;d<f;++d)if(c.scenes[d].scene.name===a){e=
c.scenes[d];break}return e},resumeScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var c=renderStack[renderStack.length-1];"string"===typeof a&&(a=this.getScene(a));var e=c.scenes.indexOf(a);-1<e&&c.scenes.splice(e,1);return a},runOnce:function(){this.loopFunc()}};o.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents=
{};for(var c in a)this.bindEvent(c,a[c])},orbitView:function(a){var c=m.vec3,e=c.subtract(this.camera.target,this.camera.position),e=c.length(e);this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0);this.camera.position[1]+=e*a[1]/300;this.camera.position=c.add(this.camera.target,c.multiply(c.normalize(c.subtract(this.camera.position,this.camera.target)),e))},panView:function(a,c){var e=m.vec3;c||(c=!1);var d=e.subtract(this.camera.target,this.camera.position),
d=e.length(d),f=this.camera.position;c?this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,-d*a[1]/300):(this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0),this.camera.position[1]+=d*a[1]/300);d=e.subtract(this.camera.position,f);this.camera.target=e.add(this.camera.target,d)},zoomView:function(a,c,e){var d=m.vec3,f=d.subtract(this.camera.target,this.camera.position),f=d.length(f),f=f-a/1E3;c||(c=0.1);e||(e=1E3);f<
c&&(f=c);f>e&&(f=e);this.camera.position=d.add(this.camera.target,d.multiply(d.normalize(d.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(a,c){this.mEvents[a]=c===s?this.eventDefaults[a]:c},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:y,MainLoop:r,MouseViewController:o,setMainLoop:function(a){m.GLCore.mainloop=a},keyboard:b.keyboard}});
CubicVR.RegisterModule("Texture",function(m){function y(a,c){if(1===a||1===c)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==c)for(;0===c%2;)c/=2;return 1<a||1<c?!1:!0}function w(a){var f=m.GLCore.gl;if("CANVAS"===a.nodeName||"IMG"===a.nodeName||"VIDEO"===a.nodeName)this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(void 0===a.width||void 0===a.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=
a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new m.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var e=this.canvasSource;(!e.height||!e.width)&&d("Warning - CanvasTexture input has no initial width and height, edges clamped.");!e.height||!e.width||!y(e.width,e.height)?(this.setFilter(c.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,
f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)):(this.setFilter(c.texture.filter.LINEAR_MIP),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT));"IMG"===a.nodeName&&this.update()}function r(a,f){if(!a)throw"PDF Texture Error: page is null.";var d=this,e=m.GLCore.gl,n=this.canvasSource=document.createElement("canvas"),b;n.mozOpaque=!0;n.width=f.width;n.height=f.height;b=this.canvasContext=
n.getContext("2d");b.save();b.fillStyle="rgb(255, 255, 255)";b.fillRect(0,0,n.width,n.height);b.restore();a.startRendering(b,function(){d.update()});this.texture=new m.Texture;this.updateFunction=f.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(n.width,n.height)?(this.setFilter(c.texture.filter.LINEAR_MIP),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))}function o(a,f,d){var e=m.GLCore.gl;this.texture=new m.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=f;this.canvas.height=d;this.pjs=new Processing(this.canvas,m.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;
this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(this.canvas.width,this.canvas.height)?this.setFilter(c.texture.filter.LINEAR_MIP):(this.setFilter(c.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))}function s(f,d,e){var n=a.gl;this.width=d;this.height=e;this.srcTex=f;this.outTex=new m.RenderBuffer(d,e);y(d,e);f=[1/d,1/
e,0];this.outputBuffer=new m.RenderBuffer(d,e,!1);this.fsQuad=m.fsQuad.make(d,e);shaderNMap=new m.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",f);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(n.TEXTURE0);this.setFilter(c.texture.filter.LINEAR);
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)}function b(f,d,e){var n=a.gl;this.width=f;this.height=d;this.outTex=new m.RenderBuffer(f,d,e);this.texture=this.outTex.texture;var b=y(f,d);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(n.TEXTURE0);b?(this.setFilter(c.texture.filter.LINEAR),
n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.REPEAT),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE));this.dims=[f,d];this.depth=e?!0:!1}function g(a,c){this.scene=a;this.renderTex=new b(c?c.width:a.camera.width,c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=m.GLCore,c=m.enums,e=m.undef,d=m.log;c.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var f=function(a,c){this.img_path=a;this.filter_type=c};f.prototype={getTexture:function(a,c){return new n(this.img_path,this.filter_type,a,c)}};var n=function(f,d,n,b,g){var D=
a.gl;this.tex_id=m.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;m.Textures[this.tex_id]=D.createTexture();m.Textures_obj[this.tex_id]=this;f&&("string"===typeof f?m.Images[this.tex_id]=new Image:"object"===typeof f&&"IMG"===f.nodeName&&(m.Images[this.tex_id]=f),m.Textures_ref[f]=this.tex_id);D.bindTexture(D.TEXTURE_2D,m.Textures[this.tex_id]);D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MAG_FILTER,D.LINEAR);D.texParameteri(D.TEXTURE_2D,D.TEXTURE_MIN_FILTER,D.LINEAR);if(f){var o=this.tex_id,
r=d!==e?d:a.default_filter,s=this;m.Images[this.tex_id].onload=function(){D.bindTexture(D.TEXTURE_2D,m.Textures[o]);D.pixelStorei(D.UNPACK_FLIP_Y_WEBGL,true);D.pixelStorei(D.UNPACK_COLORSPACE_CONVERSION_WEBGL,D.NONE);var a=m.Images[o];D.texImage2D(D.TEXTURE_2D,0,D.RGBA,D.RGBA,D.UNSIGNED_BYTE,a);if(a=y(a.width,a.height)){D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.REPEAT);D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.REPEAT)}else{D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_S,D.CLAMP_TO_EDGE);
D.texParameteri(D.TEXTURE_2D,D.TEXTURE_WRAP_T,D.CLAMP_TO_EDGE)}if(m.Textures_obj[o].filterType===-1){if(a)r=c.texture.filter.LINEAR_MIP;else if(r===c.texture.filter.LINEAR_MIP)r=c.texture.filter.LINEAR;m.Textures_obj[o].filterType===-1&&m.Textures_obj[o].setFilter(r)}else m.Textures_obj[o].setFilter(m.Textures_obj[o].filterType);if(s.onready)s.onready();D.bindTexture(D.TEXTURE_2D,null);s.loaded=true};n?(m.Images[this.tex_id].deferredSrc=f,n.addImage(b,f,m.Images[this.tex_id])):"string"===typeof f&&
(m.Images[this.tex_id].src=f)}this.active_unit=-1};n.prototype={setFilter:function(a){if(-1<this.tex_id){var f=m.GLCore.gl;f.bindTexture(f.TEXTURE_2D,m.Textures[this.tex_id]);a===c.texture.filter.LINEAR?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR)):a===c.texture.filter.LINEAR_MIP?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.generateMipmap(f.TEXTURE_2D)):
a===c.texture.filter.NEAREST?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST)):a===c.texture.filter.NEAREST_MIP&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D));this.filterType=a}},use:function(c){-1<this.tex_id&&(a.gl.activeTexture(c),a.gl.bindTexture(a.gl.TEXTURE_2D,m.Textures[this.tex_id]),this.active_unit=
c)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=m.GLCore.gl;-1<this.tex_id&&m.Textures[this.tex_id]&&(a.deleteTexture(m.Textures[this.tex_id]),delete m.Textures_obj[this.tex_id],this.tex_id=-1)}};w.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=m.GLCore.gl;a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};o.prototype={update:function(){var a=m.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,m.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var c=
a.gl,f=c.getParameter(c.VIEWPORT);this.outputBuffer.use();c.viewport(0,0,this.width,this.height);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.srcTex.use(c.TEXTURE0);m.fsQuad.render(this.shaderNorm,this.fsQuad);c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(f[0],f[1],f[2],f[3])}};b.prototype={begin:function(){var c=a.gl;this.dims=c.getParameter(c.VIEWPORT);this.outTex.use();c.viewport(0,0,this.width,this.height);this.depth?c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT)},
end:function(){var c=a.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:n,DeferredLoadTexture:f,CanvasTexture:w,PdfTexture:r,TextTexture:function(a,c){var f=c&&c.color||"#fff",d=c&&c.bgcolor,n=c&&c.font||"18pt Arial",b=c&&c.align||"start",g=c&&c.y||0,o=c&&c.width||e,m=c&&c.height||e,r,x=document.createElement("CANVAS"),
s=x.getContext("2d"),z=0,z="string"===typeof a?1:a.length;s.font=n;var F=c&&c.lineHeight||s.measureText("OO").width,y;if(1===z)y=s.measureText(a).width;else for(r=y=0;r<z;++r){var G=s.measureText(a[r]).width;G>y&&(y=G)}x.width=o||y;x.height=m||F*z;d&&(s.fillStyle=d,s.fillRect(0,0,x.width,x.height));s.fillStyle=f;s.font=n;s.textAlign=b;s.textBaseline="top";if(1===z)f=c&&c.x||"center"===b?x.width/2:"right"===b?x.width:0,s.fillText(a,f,g);else for(r=0;r<z;++r)f=c&&c.x||"center"===b?x.width/2:"right"===
b?x.width:0,s.fillText(a[r],f,g+r*F);s.fill();this.use=w.prototype.use;this.clear=w.prototype.clear;this.update=w.prototype.update;w.apply(this,[x]);this.update();this.canvasSource=null},PJSTexture:o,NormalMapGen:s,RenderTexture:b,SceneRenderTexture:g}});
CubicVR.RegisterModule("DrawBufferTexture",function(m){var y=m.GLCore,w=m.enums;w.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var r=function(o){o=o||{};this.operation=m.parseEnum(w.draw.op,o.operation||o.op)||w.draw.op.REPLACE;this.brushType=m.parseEnum(w.draw.brush,o.brushType)||w.draw.brush.SINE;this.brushSize=o.size||5;this.color=o.color||[255,255,255,255]};r.prototype={setOperation:function(o){this.operation=m.parseEnum(w.draw.op,o)},getOperation:function(){return this.operation},
setBrushType:function(o){this.brushType=m.parseEnum(w.draw.brush,o)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(o){this.brushSize=o},getSize:function(){return this.brushSize},setColor:function(o){this.color=o},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:m.extendClassGeneral(m.Texture,function(o){o=o||{};m.Texture.apply(this,[o.image,o.filter,o.deferred_bin,o.binId,o.readyFunc]);this.width=o.width||0;this.height=o.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=o.brush||new r;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(o){this.brush=o},getBrush:function(){return this.brush},
draw:function(o,m,b){var g=this.brush||b,b=g.getOperation(),a=g.getSize(),c=g.getBrushType(),g=g.getColor();this.drawBuffer.push([o,m,b,a,c,g])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var o=this.drawBuffer.pop();this.drawFunc(o[0],o[1],o[2],o[3],o[4],o[5])}return!0},drawFunc:function(o,m,b,g,a,c){for(var e=this.imageBuffer,d=this.width,f=this.height,n=parseInt(Math.floor(o),10)-g;n<parseInt(Math.ceil(o),10)+g;n++)for(var h=n-o,q,A=parseInt(Math.floor(m),
10)-g;A<parseInt(Math.ceil(m),10)+g;A++)if(!(0>=n||n>=d||0>=A||A>=f)){q=A-m;var v;0===a&&(v=(1-Math.sqrt(h*h+q*q)/g)/2);q=4*(A*d+n);0===b?0>v&&(v=0):1===b?0>v&&(v=0):2===b&&(v=-v,0<v&&(v=0));var t=Math.floor(e[q]*(1-v)+c[0]*v),D=Math.floor(e[q+1]*(1-v)+c[1]*v),r=Math.floor(e[q+2]*(1-v)+c[2]*v),B=Math.floor(e[q+3]*(1-v)+c[3]*v);255<t?t=255:0>t&&(t=0);255<D?D=255:0>D&&(D=0);255<r?r=255:0>r&&(r=0);255<B?B=255:0>B&&(B=0);e[q]=t;e[q+1]=D;e[q+2]=r;e[q+3]=B}},update:function(){var o=y.gl;this.flush();o.bindTexture(o.TEXTURE_2D,
m.Textures[this.tex_id]);o.texImage2D(o.TEXTURE_2D,0,o.RGBA,this.width,this.height,0,o.RGBA,o.UNSIGNED_BYTE,this.imageBuffer)}}),DrawBufferBrush:r}});
CubicVR.RegisterModule("Material",function(m){function y(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=m.get(a)||{},a.shader||null);null===s&&(s=new m.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
s._init_shader(s._vertex,s._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new m.CustomShader(this.customShader));this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==w?a.visible:!0;this.friction=a.friction!==w?a.friction:0.3;this.collision=a.visible!==w?a.collision:!0;this.opacity=a.opacity===w?
1:a.opacity;this.shininess=a.shininess===w?1:a.shininess;this.max_smooth=a.max_smooth===w?60:a.max_smooth;this.env_amount=a.env_amount===w?0.75:a.env_amount;this.morph=a.morph===w?!1:a.morph;this.color_map=a.colorMap===w?!1:a.colorMap;this.uvOffset=a.uvOffset===w?[0,0]:a.uvOffset;this.noFog=a.noFog===w?!1:a.noFog;if(a.textures)for(var e in a.textures)this.setTexture(a.textures[e],e)}var w=m.undef,r=m.GLCore,o=m.enums,s=null,b=[o.texture.map.REFLECT,o.texture.map.SPECULAR,o.texture.map.NORMAL,o.texture.map.BUMP],
g=[],a="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
y.prototype={clone:function(){var a=new m.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,name:this.name}),e;for(e in this.textures)this.textures.hasOwnProperty(e)&&a.setTexture(this.textures[e],e);return a},setVisibility:function(a){this.visible=
a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,e){if(a&&(e=m.parseEnum(o.texture.map,e)||0,m.features.texturePerPixel||-1===b.indexOf(e)))!a.use&&"string"===typeof a&&(a=m.Textures_ref[a]!==w?m.Textures_obj[m.Textures_ref[a]]:new m.Texture(a)),this.textures[e]=a},calcShaderMask:function(){var a;a=0+("object"===
typeof this.textures[o.texture.map.COLOR]?o.shader.map.COLOR:0);a+="object"===typeof this.textures[o.texture.map.SPECULAR]?o.shader.map.SPECULAR:0;a+="object"===typeof this.textures[o.texture.map.NORMAL]?o.shader.map.NORMAL:0;a+="object"===typeof this.textures[o.texture.map.BUMP]?o.shader.map.BUMP:0;a+="object"===typeof this.textures[o.texture.map.REFLECT]?o.shader.map.REFLECT:0;a+="object"===typeof this.textures[o.texture.map.ENVSPHERE]?o.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[o.texture.map.AMBIENT]?
o.shader.map.AMBIENT:0;a+="object"===typeof this.textures[o.texture.map.ALPHA]?o.shader.map.ALPHA:0;a+=1!==this.opacity?o.shader.map.ALPHA:0;a+=this.color_map?o.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return a},getShaderHeader:function(a,e){return(e!==w?"#define LIGHT_COUNT "+e+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[o.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[o.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+
("object"===typeof this.textures[o.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[o.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[o.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[o.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[o.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[o.texture.map.ALPHA]?1:
0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===o.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===o.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===o.light.type.SPOT||a===o.light.type.SPOT_SHADOW||a===o.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===o.light.type.SPOT_SHADOW||a===o.light.type.SPOT_SHADOW_PROJECTOR||a===o.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===o.light.type.SPOT_SHADOW_PROJECTOR?
1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(r.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===o.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===o.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(r.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(r.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(r.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(r.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(m.features.lightPerPixel?
1:0)+"\n\n"},bindObject:function(a,e){var d=r.gl,f=e.vertexPosition,n=e.vertexTexCoord,h=e.vertexNormal,b=e.vertexColor;d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_points);d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(f);null!==n&&(null!==a.compiled.gl_uvs&&-1!==n)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_uvs),d.vertexAttribPointer(n,2,d.FLOAT,!1,0,0),d.enableVertexAttribArray(n));g.uv=n;null!==h&&(null!==a.compiled.gl_normals&&-1!==h)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_normals),
d.vertexAttribPointer(h,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(h));g.un=h;null!==b&&(null!==a.compiled.gl_colors&&-1!==b)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_colors),d.vertexAttribPointer(b,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(b));g.uc=b;a.morphTarget&&(f=e.vertexMorphPosition,h=e.vertexMorphNormal,d.bindBuffer(d.ARRAY_BUFFER,a.morphTarget.gl_points),d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(f),null!==h&&(null!==a.morphTarget.gl_normals&&-1!==h)&&(d.bindBuffer(d.ARRAY_BUFFER,
a.morphTarget.gl_normals),d.vertexAttribPointer(h,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(h)),d.uniform1f(e.materialMorphWeight,a.morphWeight));d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,e){var d=r.gl;g.uv!==w&&-1!==g.uv&&d.disableVertexAttribArray(g.uv);g.un!==w&&-1!==g.un&&d.disableVertexAttribArray(g.un);g.uc!==w&&-1!==g.uc&&d.disableVertexAttribArray(g.uc);a.morphTarget&&e&&(up=e.vertexMorphPosition,d.disableVertexAttribArray(up),un=e.vertexMorphNormal,
null!==un&&(null!==a.compiled.gl_normals&&-1!==un)&&d.disableVertexAttribArray(un))},use:function(c,e){var d,f=r.gl,n=this.textures,h=!0,e=e||0,c=c||0;this.shader[c]||(this.shader[c]=[]);var b=this.shader[c][e],g=this.customShader&&c===o.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();b&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(b=null,this.dirtyFlag=!1);if(b)h=b!==s,b.use();else{d=this.calcShaderMask(c);if(!this.customShader||g)m.ShaderPool[c][d]||
(m.ShaderPool[c][d]=[]),b=m.ShaderPool[c][d][e];if(!b){var v=this.getShaderHeader(c,e),t=v+r.CoreShader_vs,v=v+r.CoreShader_fs;this.customShader&&!g?this.customShader._initialized||(this.customShader._init_shader(t,v,a),b=this.customShader.getShader(),b.isCompiled()||(h=!1,b=s.getShader())):(b=new m.Shader(t,v),b.isCompiled()||(h=!1,b=s.getShader()),m.ShaderPool[c][d][e]=b);d=0;if(c!==o.light.type.DEPTH_PACK){if(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)d+=
e,c===o.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);"object"===typeof n[o.texture.map.COLOR]&&b.addInt("textureColor",d++);"object"===typeof n[o.texture.map.ENVSPHERE]&&b.addInt("textureEnvSphere",d++);"object"===typeof n[o.texture.map.NORMAL]&&b.addInt("textureNormal",d++);"object"===typeof n[o.texture.map.BUMP]&&b.addInt("textureBump",d++);"object"===typeof n[o.texture.map.REFLECT]&&b.addInt("textureReflect",d++);"object"===typeof n[o.texture.map.SPECULAR]&&b.addInt("textureSpecular",d++);"object"===
typeof n[o.texture.map.AMBIENT]&&b.addInt("textureAmbient",d++)}"object"===typeof n[o.texture.map.ALPHA]&&b.addInt("textureAlpha",d++);b.addMatrix("matrixModelView");b.addMatrix("matrixProjection");b.addMatrix("matrixObject");b.addMatrix("matrixNormal");b.addVertexArray("vertexPosition");b.addVertexArray("vertexNormal");this.color_map&&b.addVertexArray("vertexColor");this.morph&&(b.addVertexArray("vertexMorphPosition"),b.addVertexArray("vertexMorphNormal"),b.addFloat("materialMorphWeight",0));for(d=
0;d<e;d++)if(b.addVector("lightDiffuse["+d+"]"),b.addVector("lightSpecular["+d+"]"),b.addFloat("lightIntensity["+d+"]"),b.addFloat("lightDistance["+d+"]"),b.addVector("lightPosition["+d+"]"),b.addVector("lightDirection["+d+"]"),(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.SPOT)&&b.addFloat("lightCutOffAngle["+d+"]"),c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)b.addInt("lightShadowMap["+d+"]"),c===o.light.type.SPOT_SHADOW_PROJECTOR&&
b.addInt("lightProjectionMap["+d+"]"),b.addVector("lightDepthClip["+d+"]"),b.addMatrix("lightShadowMatrix["+d+"]");c!==o.light.type.DEPTH_PACK&&(b.addVector("lightAmbient"),b.addVector("materialDiffuse"),b.addVector("materialColor"),b.addVector("materialAmbient"),b.addVector("materialSpecular"),b.addFloat("materialShininess"),b.addFloat("materialEnvironment"));b.addFloat("materialAlpha");(r.depth_alpha||c===o.light.type.DEPTH_PACK||c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||
c===o.light.type.AREA)&&b.addVector("postDepthInfo");b.addUVArray("vertexTexCoord");b.addVector("materialTexOffset");r.fog_enabled&&!this.noFog&&(b.addVector("fogColor",r.fogColor),b.addFloat("fogDensity",r.fogDensity),b.addFloat("fogNear",r.fogNear),b.addFloat("fogFar",r.fogFar))}this.shader[c][e]=b;b.use();-1!=b.materialTexOffset&&f.uniform2fv(b.materialTexOffset,[0,0])}d=0;if(c!==o.light.type.DEPTH_PACK){if(c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)d+=
e,c===o.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);if(t=n[o.texture.map.COLOR])t.use(r.gl.TEXTURE0+d),d++;if(t=n[o.texture.map.ENVSPHERE])t.use(r.gl.TEXTURE0+d),d++,f.uniform1f(b.materialEnvironment,this.env_amount);if(t=n[o.texture.map.NORMAL])t.use(r.gl.TEXTURE0+d),d++;if(t=n[o.texture.map.BUMP])t.use(r.gl.TEXTURE0+d),d++;if(t=n[o.texture.map.REFLECT])t.use(r.gl.TEXTURE0+d),d++;if(t=n[o.texture.map.SPECULAR])t.use(r.gl.TEXTURE0+d),d++;if(t=n[o.texture.map.AMBIENT])t.use(r.gl.TEXTURE0+d),d++}if(t=
n[o.texture.map.ALPHA])t.use(r.gl.TEXTURE0+d),d++;r.fog_enabled&&!this.noFog&&(f.uniform3fv(b.fogColor,r.fogColor),f.uniform1f(b.fogDensity,r.fogDensity),f.uniform1f(b.fogNear,r.fogNear),f.uniform1f(b.fogFar,r.fogFar));c!==o.light.type.DEPTH_PACK?(f.uniform3fv(b.materialColor,this.color),f.uniform3fv(b.materialDiffuse,this.diffuse),f.uniform3fv(b.materialAmbient,this.ambient),f.uniform3fv(b.materialSpecular,this.specular),f.uniform1f(b.materialShininess,128*this.shininess),f.uniform3fv(b.lightAmbient,
m.globalAmbient),1!==this.opacity&&f.uniform1f(b.materialAlpha,this.opacity),(r.depth_alpha||c===o.light.type.SPOT_SHADOW||c===o.light.type.SPOT_SHADOW_PROJECTOR||c===o.light.type.AREA)&&f.uniform3fv(b.postDepthInfo,[r.depth_alpha_near,r.depth_alpha_far,0])):f.uniform3fv(b.postDepthInfo,[r.shadow_near,r.shadow_far,0]);b.materialTexOffset&&f.uniform2fv(b.materialTexOffset,this.uvOffset);this.customShader&&(c!==o.light.type.DEPTH_PACK||c===o.light.type.DEPTH_PACK&&!g)&&this.customShader._doUpdate({material:this,
textureIndex:d});return h}};return{Material:y}});
CubicVR.RegisterModule("Mesh",function(m){function y(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function w(b){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;b=m.get(b)||
{};if(b instanceof m.Mesh)this.booleanAdd(b),b._clones=b._clones||1,b._clones++,this.name=b.name?b.name+"_copy"+b._clones:null;else{this.name=b.name||null;this.dynamic=b.dynamic||!1;if(b.material){var g=b.material;g.length?this.materials=g:"object"===typeof g&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new m.Material(g)))}b.points&&this.build(b);b.part?this.build(b.part):b.parts&&this.build(b.parts);if((this.primitives=b.primitives||b.primitive||null)&&!this.primitives.length||"string"===
typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var c=this.primitives[g];"string"===typeof c&&(c=m.get(c));var e=m.primitives[c.type];if(c.type&&e)this.booleanAdd(e(c));else if(c.type){s("Mesh error, primitive "+c.type+" is unknown.");var c="",d;for(d in m.primitives)m.primitives.hasOwnProperty(d)&&(""!==c&&(c+=", "),c+=d);s("Available primitive types are: "+c)}else s("Mesh error, primitive "+(g+1)+" lacks type.")}this.buildWireframe=
b.buildWireframe||b.wireframe||!!b.wireframeMaterial||b.triangulateWireframe||!1;this.triangulateWireframe=b.triangulateWireframe||null;this.wireframeMaterial=m.get(b.wireframeMaterial,m.Material)||null;this.wireframe=b.wireframe||!1;b.flipFaces&&this.faces.length&&this.flipFaces();(b.prepare||b.compile&&this.faces.length)&&this.prepare();(b.clean||b.compile&&this.faces.length&&!this.dynamic)&&this.clean();b.calcNormals&&(!b.compile&&!b.prepare)&&this.calcNormals()}}var r=m.undef,o=m.GLCore,s=m.log;
y.prototype={setUV:function(b,g){g!==r?this.uvs[g]=b:2!==b.length?this.uvs=b:this.uvs.push(b)},setColor:function(b,g){g!==r?this.point_colors[g]=b:"number"!==typeof b[0]?this.point_colors=b:this.point_colors.push(b)},flip:function(){for(var b=0,g=this.point_normals.length;b<g;b++)this.point_normals[b]=[-this.point_normals[b][0],-this.point_normals[b][1],-this.point_normals[b][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
w.prototype={setWireframe:function(b){this.wireframe=b},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(b){this.wireframeMaterial=b},build:function(b,g){var a,c;"string"===typeof b&&(b=m.get(b));b&&!b.length&&(b=[b]);var e=this.faces.length;g&&g.length&&this.points.concat(g);for(var d=0,f=b.length;d<f;d++){var n=b[d];a=n.material;c=n.points;var h=n.faces,q=n.uv,A=n.color,n=n.segment||null;null!==n&&this.setSegment(parseInt(n,10));if(c&&c.length&&(this.points=this.points.concat(c),
h&&e)){h=h.slice(0);c=0;for(n=h.length;c<n;c++)for(var v=h[c],t=0,D=h.length;t<D;t++)v[t]+=e}a&&(a.length?this.materials=a:"object"===typeof a&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new m.Material(a))));h&&h.length&&this.addFace(h);if(h&&q&&"object"===typeof q){n=null;if(q.length&&q.length===h.length)if(q.length===h.length){a=0;for(c=q.length;a<c;a++)this.faces[a+e].setUV(q[a])}else s("Mesh error in part, face count: "+h.length+", uv count:"+q.length);else n=q.apply?q:new m.UVMapper(q);
n&&n.apply(this,this.currentMaterial,this.currentSegment,e,this.faces.length-e)}if(h&&A&&"object"===typeof A)if(A.length&&A.length===h.length){a=0;for(c=A.length;a<c;a++)this.faces[a+e].setColor(A[a]);this.materials[this.currentMaterial].colorMap=!0}else s("Mesh error in part, face count: "+h.length+", color count:"+A.length)}return this},showAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&(this.segment_state[b]=!0)},hideAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&
(this.segment_state[b]=!1)},setSegment:function(b,g){g!==r?this.segment_state[b]=g:this.currentSegment=b},addPoint:function(b){if(3!==b.length||"object"===typeof b[0])for(var g=0,a=b.length;g<a;g++)this.points.push(b[g]);else this.points.push(b);return this.points.length-1},getMaterialIndex:function(b){return this.materials.indexOf(b)},setFaceMaterial:function(b,g){var a;"number"==typeof b?a=b:(a=this.materials.indexOf(b),-1===a&&(this.materials.push(b),a=this.materials.length-1));g!==r?this.faces[g]!==
r&&(this.faces[g].material=a):this.currentMaterial=a;return this},addFace:function(b,g,a,c){if("number"!==typeof b[0]){g=0;for(a=b.length;g<a;g++)this.addFace(b[g])}else return g===r?(this.currentFace=this.faces.length,this.faces.push(new y)):(this.faces[g]===r&&(this.faces[g]=new y),this.currentFace=g),"object"===typeof b&&(this.faces[this.currentFace].points=b),a!==r?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=
c!==r?c:this.currentSegment,this.currentFace},flipFaces:function(){for(var b=0,g=this.faces.length;b<g;b++)this.faces[b].flip()},triangulateQuads:function(){for(var b=0,g=this.faces.length;b<g;b++)if(4===this.faces[b].points.length){var a=this.faces.length;this.addFace([this.faces[b].points[2],this.faces[b].points[3],this.faces[b].points[0]],this.faces.length,this.faces[b].material,this.faces[b].segment);this.faces[b].points.pop();this.faces[a].normal=this.faces[b].normal.slice(0);4===this.faces[b].point_colors.length&&
(this.faces[a].setColor(this.faces[b].point_colors[2],0),this.faces[a].setColor(this.faces[b].point_colors[3],1),this.faces[a].setColor(this.faces[b].point_colors[0],2),this.faces[b].point_colors.pop());4===this.faces[b].uvs.length&&(this.faces[a].setUV(this.faces[b].uvs[2],0),this.faces[a].setUV(this.faces[b].uvs[3],1),this.faces[a].setUV(this.faces[b].uvs[0],2),this.faces[b].uvs.pop());4===this.faces[b].point_normals.length&&(this.faces[a].point_normals[0]=this.faces[b].point_normals[2],this.faces[a].point_normals[1]=
this.faces[b].point_normals[3],this.faces[a].point_normals[2]=this.faces[b].point_normals[0],this.faces[b].point_normals.pop())}return this},booleanAdd:function(b,g){var a=m.mat4,c=this.points.length,e,d,f,n;e=g;g=e===r?r:"array"===typeof e?e:"object"===typeof e?e.getResult?e.getResult():e.position||e.rotation||e.scale?m.mat4.transform(e.position,e.rotation,e.scale):r:void 0;b.wireframeMaterial&&(this.wireframeMaterial=b.wireframeMaterial);if(g!==r){d=g;e=0;for(f=b.points.length;e<f;e++)this.addPoint(a.vec3_multiply(b.points[e],
d))}else{e=0;for(f=b.points.length;e<f;e++)this.addPoint([b.points[e][0],b.points[e][1],b.points[e][2]])}a=[];e=0;for(f=b.materials.length;e<f;e++)d=this.materials.indexOf(b.materials[e]),-1===d?(this.materials.push(b.materials[e]),a[e]=this.materials.length-1):a[e]=d;e=0;for(f=b.faces.length;e<f;e++){var h=[];d=0;for(n=b.faces[e].points.length;d<n;d++)h.push(b.faces[e].points[d]+c);h=this.faces[this.addFace(h)];h.segment=b.faces[e].segment;h.material=a[b.faces[e].material];h.material===r&&(h.material=
0);d=0;for(n=b.faces[e].uvs.length;d<n;d++)h.uvs[d]=[b.faces[e].uvs[d][0],b.faces[e].uvs[d][1]];d=0;for(n=b.faces[e].point_normals.length;d<n;d++)h.point_normals[d]=[b.faces[e].point_normals[d][0],b.faces[e].point_normals[d][1],b.faces[e].point_normals[d][2]]}return this},calcFaceNormals:function(b,g){var a=m.vec3,c=m.triangle,e=0,d=this.faces.length,f,n=this.points,h;b&&(e=b);for(g&&(d=g+1);e<d;e++)f=this.faces[e],h=f.points,3>h.length?f.normal=[0,0,0]:a.normalize(c.normal(n[h[0]],n[h[1]],n[h[2]],
f.normal));return this},getMaterial:function(b){if(!isNaN(parseInt(b,10)))return this.materials[g];for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===b)return this.materials[g];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(b){this.instanceMaterials=b},calcNormals:function(b){var g=m.vec3,a=!1,c;this.dynamic&&(c=[],b=b||{});b!==r&&(c=[],a=!0);this.calcFaceNormals();var e,d,f,n,h=Array(this.points.length);e=0;for(n=h.length;e<n;e++)h[e]=
[];n=this.faces.length;for(e=0;e<n;e++){f=this.faces[e].points.length;for(d=0;d<f;d++)h[this.faces[e].points[d]].push([e,d])}e=0;for(n=this.points.length;e<n;e++){var q=h[e].length;for(d=0;d<q;d++){var A=1,v=h[e][d][0],t=h[e][d][1],D=this.materials.length?this.materials[this.faces[v].material].max_smooth:60,o=this.faces[v];a&&(c[v]===r&&(c[v]=[]),c[v][t]===r&&(c[v][t]=[]));var s=Array(3);s[0]=o.normal[0];s[1]=o.normal[1];s[2]=o.normal[2];if(0!==D)for(f=0;f<q;f++)if(d!==f){var w=h[e][f][0],u=this.faces[w],
x=g.angle(u.normal,o.normal);if(x!==x||x*(180/Math.PI)<=D)a&&c[v][t].push(w),s[0]+=u.normal[0],s[1]+=u.normal[1],s[2]+=u.normal[2],A++}s[0]/=A;s[1]/=A;s[2]/=A;this.faces[v].point_normals[t]=g.normalize(s)}}if(a){e=g=0;for(n=c.length;e<n;e++){d=0;for(f=c[e].length;d<f;d++)g+=c[e][d].length}b.faceCount||(b.faceCount=new Uint8Array(3*this.faces.length));b.faceNorm||(b.faceNorm=new Uint16Array(g));b.faceNormIdx||(b.faceNormIdx=new Uint16Array(this.faces.length));e=g=0;for(n=this.faces.length;e<n;e++)for(d=
0;3>d;d++)if(a=c[e][d],b.faceCount[3*e+d]=a?a.length:0,b.faceNormIdx[e]=g,a){f=0;for(a=a.length;f<a;f++)b.faceNorm[g++]=c[e][d][f]}else g++;this.normalMapRef=b}return this},recalcNormals:function(b,g){var a,c,e,d,f,n,h,q,A,v;if(b=b||this.normalMapRef){a=g.segments!==r?!0:!1;c=g.segments;this.calcFaceNormals();var t=0,o=0,m=0,s;if(a)for(var o=this.dynamicData.VBO.dynamicMap,w=b.faceNormIdx,u=0,x=c.length;u<x;u++)for(var E=o.segmentMap[c[u]],z=0,y=E.length;z<y;z++){a=E[z];A=this.faces[a];s=A.normal;
t=w[a];for(j=0;3>j;j++){q=A.point_normals[j];f=s[0];n=s[1];h=s[2];v=b.faceCount[3*a+j];e=0;for(iMax=v;e<iMax;e++)d=b.faceNorm[t+e],d=this.faces[d],d=d.normal,f+=d[0],n+=d[1],h+=d[2];v?(e=v+1,f/=e,n/=e,h/=e,e=Math.sqrt(f*f+n*n+h*h),f/=e,n/=e,h/=e,q[0]=f,q[1]=n,q[2]=h):m++}}else{a=0;for(c=this.faces.length;a<c;a++){A=this.faces[a];s=A.normal;for(j=0;3>j;j++){q=A.point_normals[j];f=s[0];n=s[1];h=s[2];v=b.faceCount[o++];e=0;for(iMax=v;e<iMax;e++)d=b.faceNorm[t++],d=this.faces[d],d=d.normal,f+=d[0],n+=
d[1],h+=d[2];v?(e=v+1,f/=e,n/=e,h/=e,e=Math.sqrt(f*f+n*n+h*h),f/=e,n/=e,h/=e,q[0]=f,q[1]=n,q[2]=h):m++}}}return this}},removeDoubles:function(b){var g=[],a=[],c,e,d,f;c=0;for(e=this.points.length;c<e;c++){var n=-1,h=this.points[c];d=0;for(f=g.length;d<f;d++)if(m.vec3.equal(h,g[d],b)){n=d;break}-1!=n?a[c]=n:(a[c]=g.length,g.push(this.points[c]))}this.points=g;c=0;for(e=this.faces.length;c<e;c++){b=this.faces[c];d=0;for(f=b.points.length;d<f;d++)b.points[d]=a[b.points[d]]}return this},buildEdges:function(){var b,
g,a,c,e=[],d=[];b=0;for(a=this.faces.length;b<a;b++){var f=this.faces[b];g=0;for(c=f.points.length;g<c;g++){var n,h,q;q=f.segment;matId=f.material;g?(h=f.points[g],n=f.points[g-1]):(h=f.points[g],n=f.points[c-1]);e[n]=e[n]||{};e[n][matId]=e[n][matId]||{};e[n][matId][q]=e[n][matId][q]||{};!e[n][matId][q][h]&&(!e[h]||!e[h][matId][q][n])&&d.push([matId,q,n,h])}}this.edges=d;return this},subdivide:function(b,g){var a=m.vec3,g=g===r?!0:g;b===r&&(b=1);if(0!==b){var c,e,d,f,n,h={},q=[],A=[],v=this.points.length,
t=this.faces.length,o=[],C=[],B=[],w=[];c=0;for(d=t;c<d;c++)if(n=this.faces[c],n.points&&(3===n.points.length||4===n.points.length)){var u=[0,0,0];e=0;for(f=n.points.length;e<f;e++){var x=this.points[n.points[e]];u[0]+=x[0];u[1]+=x[1];u[2]+=x[2]}u[0]/=f;u[1]/=f;u[2]/=f;o[c]=this.addPoint(u);if(n.uvs.length===n.points.length){u=[0,0];e=0;for(f=n.uvs.length;e<f;e++)x=n.uvs[e],u[0]+=x[0],u[1]+=x[1];u[0]/=f;u[1]/=f;C[c]=u}if(n.point_colors.length===n.points.length){u=[0,0,0];e=0;for(f=n.point_colors.length;e<
f;e++)x=n.point_colors[e],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;B[c]=u}if(n.point_normals.length===n.points.length){u=[0,0,0];e=0;for(f=n.point_normals.length;e<f;e++)x=n.point_normals[e],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;w[c]=u}}c=0;for(d=this.faces.length;c<d;c++){n=this.faces[c];e=0;for(f=n.points.length;e<f;e++){var E,z;e?(E=e,z=e-1):(E=e,z=f-1);x=n.points[E];u=n.points[z];h[u]=h[u]||{};q[u]=q[u]||[];q[u].push(c);h[u][x]={face:c,a:u,b:x,fpa:E,fpb:z}}}for(c in h)if(h.hasOwnProperty(c))for(e in h[c])if(h[c].hasOwnProperty(e)){d=
h[c][e];n=h[e][c];if(n===r){s("Mesh.subdivide error. Hole at face #"+d.face+", Edge:["+d.fpa+"->"+d.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}d.edge_point||(f=a.multiply(a.add(this.points[d.a],this.points[d.b]),0.5),g?(u=a.multiply(a.add(this.points[o[d.face]],this.points[o[n.face]]),0.5),d.edge_point=a.multiply(a.add(f,u),0.5)):d.edge_point=f,n.edge_point=d.edge_point,d.edge_avg=f,n.edge_avg=f,d.ep_idx=this.addPoint(d.edge_point),n.ep_idx=d.ep_idx);A[d.a]=A[d.a]||
[];A[d.a].push(d.edge_avg);f=this.faces[d.face].uvs;f.length&&(n=f[d.fpa],f=f[d.fpb],d.uv=[(n[0]+f[0])/2,(n[1]+f[1])/2]);n=this.faces[d.face].point_colors;n.length&&(d.color=a.multiply(a.add(n[d.fpa],n[d.fpb]),0.5));n=this.faces[d.face].point_normals;n.length&&(d.normal=a.normalize(a.multiply(a.add(n[d.fpa],n[d.fpb]),0.5)))}if(g){n=[];c=0;for(d=v;c<d;c++)if(u=[0,0,0],q[c]){e=0;for(f=q[c].length;e<f;e++)x=this.points[o[q[c][e]]],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=f;u[1]/=f;u[2]/=f;n[c]=u}u=[];
c=0;for(d=v;c<d;c++)if(x=[0,0,0],A[c]){e=0;for(f=A[c].length;e<f;e++)E=A[c][e],x[0]+=E[0],x[1]+=E[1],x[2]+=E[2];x[0]/=f;x[1]/=f;x[2]/=f;u[c]=x}c=0;for(d=v;c<d;c++)q[c]&&(v=q[c].length,e=1/v,A=2/v,v=a.multiply(this.points[c],(v-3)/v),v=a.add(v,a.multiply(n[c],e)),v=a.add(v,a.multiply(u[c],A)),this.points[c]=v)}for(c=0;c<t;c++)if(n=this.faces[c],!(3!==n.points.length&&4!==n.points.length))if(a=n.points.slice(0),q=n.uvs.slice(0),e=n.point_colors.slice(0),A=n.point_normals.slice(0),v=q.length===a.length,
d=e.length===a.length,f=A.length===a.length,n=n.material,3===a.length){if(this.setFaceMaterial(n),u=h[a[0]][a[1]],x=h[a[2]][a[0]],this.addFace([a[0],u.ep_idx,o[c],x.ep_idx],c),v&&(this.faces[c].uvs=[q[0],u.uv,C[c],x.uv]),d&&(this.faces[c].point_colors=[e[0],u.color,B[c],x.color]),f&&(this.faces[c].point_normals=[A[0],u.normal,w[c],x.normal]),u=h[a[1]][a[2]],x=h[a[0]][a[1]],n=this.addFace([a[1],u.ep_idx,o[c],x.ep_idx]),v&&(this.faces[n].uvs=[q[1],u.uv,C[c],x.uv]),d&&(this.faces[n].point_colors=[e[1],
u.color,B[c],x.color]),f&&(this.faces[n].point_normals=[A[1],u.normal,w[c],x.normal]),u=h[a[2]][a[0]],x=h[a[1]][a[2]],n=this.addFace([a[2],u.ep_idx,o[c],x.ep_idx]),v&&(this.faces[n].uvs=[q[2],u.uv,C[c],x.uv]),d&&(this.faces[n].point_colors=[e[2],u.color,B[c],x.color]),f)this.faces[n].point_normals=[A[2],u.normal,w[c],x.normal]}else if(this.setFaceMaterial(n),u=h[a[0]][a[1]],x=h[a[3]][a[0]],this.addFace([a[0],u.ep_idx,o[c],x.ep_idx],c),v&&(this.faces[c].uvs=[q[0],u.uv,C[c],x.uv]),d&&(this.faces[c].point_colors=
[e[0],u.color,B[c],x.color]),f&&(this.faces[c].point_normals=[A[0],u.normal,w[c],x.normal]),u=h[a[1]][a[2]],x=h[a[0]][a[1]],n=this.addFace([a[1],u.ep_idx,o[c],x.ep_idx]),v&&(this.faces[n].uvs=[q[1],u.uv,C[c],x.uv]),d&&(this.faces[n].point_colors=[e[1],u.color,B[c],x.color]),f&&(this.faces[n].point_normals=[A[1],u.normal,w[c],x.normal]),u=h[a[2]][a[3]],x=h[a[1]][a[2]],n=this.addFace([a[2],u.ep_idx,o[c],x.ep_idx]),v&&(this.faces[n].uvs=[q[2],u.uv,C[c],x.uv]),d&&(this.faces[n].point_colors=[e[2],u.color,
B[c],x.color]),f&&(this.faces[n].point_normals=[A[2],u.normal,w[c],x.normal]),u=h[a[3]][a[0]],x=h[a[2]][a[3]],n=this.addFace([a[3],u.ep_idx,o[c],x.ep_idx]),v&&(this.faces[n].uvs=[q[3],u.uv,C[c],x.uv]),d&&(this.faces[n].point_colors=[e[3],u.color,B[c],x.color]),f)this.faces[n].point_normals=[A[3],u.normal,w[c],x.normal];b--;if(0!==b)this.subdivide(b,g);else return this}},removeInternals:function(){var b,g,a,c,e,d={},f=this.faces.length,n,h,q,A;b=0;for(a=this.faces.length;b<a;b++){e=this.faces[b];g=
0;for(c=e.points.length;g<c;g++)g?(q=g,A=g-1):(q=g,A=c-1),n=e.points[q],h=e.points[A],d[n]=d[n]||{},d[n][h]===r?d[n][h]=[b]:d[n][h].push(b)}a=function(a){return-1!==d[h][n].indexOf(a)};for(b=0;b<f;b++){e=this.faces[b];var v=null;g=0;for(c=e.points.length;g<c;g++)g?(q=g,A=g-1):(q=g,A=c-1),n=e.points[q],h=e.points[A],v=v?v.filter(a):d[h][n];v.length&&(this.faces.splice(b,1),f--,b--)}return this},prepare:function(b){b===r&&(b=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();
this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();b&&!this.dynamic&&this.clean();return this},clean:function(){var b,g;b=0;for(g=this.points.length;b<g;b++)delete this.points[b],this.points[b]=null;this.points=[];b=0;for(g=this.faces.length;b<g;b++)delete this.faces[b].points,delete this.faces[b].point_normals,delete this.faces[b].uvs,delete this.faces[b].normal,delete this.faces[b],this.faces[b]=null;this.faces=[];return this},compileMap:function(b){var g=m.vec3,a=
m.vec2;b===r&&(b=1.0E-5);var c={segments:[],bounds:[]},e=[],d,f,n,h,q,A,v,t;this.materials.length||this.materials.push(new m.Material);d=0;for(A=this.materials.length;d<A;d++)e[d]=[];d=0;for(A=this.faces.length;d<A;d++)3===this.faces[d].points.length&&(n=this.faces[d].material,h=this.faces[d].segment,e[n][h]===r&&(e[n][h]=[],c.segments.push(h)),e[n][h].push(d));var o=[],C=0,s=!1,w=!1,u=!1,x;d=0;for(A=e.length;d<A;d++)for(f in e[d])if(e[d].hasOwnProperty(f))for(n=0;n<e[d][f].length;n++)x=e[d][f][n],
s=s||0!==this.faces[x].uvs.length,w=w||0!==this.faces[x].point_normals.length,u=u||0!==this.faces[x].point_colors.length;if(s)for(d=0;d<this.faces.length;d++)if(!this.faces[d].uvs.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].uvs.push([0,0]);if(w)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_normals.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].point_normals.push([0,0,0]);if(u)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_colors.length)for(f=0;f<
this.faces[d].points.length;f++)this.faces[d].point_colors.push([0,0,0]);d=0;for(A=e.length;d<A;d++)for(f in e[d])if(e[d].hasOwnProperty(f)){n=0;for(v=e[d][f].length;n<v;n++){x=e[d][f][n];for(h=0;3>h;h++){var E=this.faces[x].points[h],z=-1;if(o[E]!==r){q=0;for(t=o[E].length;q<t;q++){var y=o[E][q][0],H=o[E][q][1],z=o[E][q][2];w&&(z=g.equal(this.faces[y].point_normals[H],this.faces[x].point_normals[h],b)?z:-1);s&&(z=a.equal(this.faces[y].uvs[H],this.faces[x].uvs[h],b)?z:-1);u&&(z=g.equal(this.faces[y].point_colors[H],
this.faces[x].point_colors[h],b)?z:-1)}}-1!==z?(c.elements===r&&(c.elements=[]),c.elements[d]===r&&(c.elements[d]=[]),c.elements[d][f]===r&&(c.elements[d][f]=[]),c.elements[d][f].push(z)):(c.points===r&&(c.points=[]),c.points.push(E),0===c.bounds.length?(c.bounds[0]=[this.points[E][0],this.points[E][1],this.points[E][2]],c.bounds[1]=[this.points[E][0],this.points[E][1],this.points[E][2]]):(this.points[E][0]<c.bounds[0][0]&&(c.bounds[0][0]=this.points[E][0]),this.points[E][1]<c.bounds[0][1]&&(c.bounds[0][1]=
this.points[E][1]),this.points[E][2]<c.bounds[0][2]&&(c.bounds[0][2]=this.points[E][2]),this.points[E][0]>c.bounds[1][0]&&(c.bounds[1][0]=this.points[E][0]),this.points[E][1]>c.bounds[1][1]&&(c.bounds[1][1]=this.points[E][1]),this.points[E][2]>c.bounds[1][2]&&(c.bounds[1][2]=this.points[E][2])),w&&(c.normals===r&&(c.normals=[]),c.normals.push([x,h])),u&&(c.colors===r&&(c.colors=[]),c.colors.push([x,h])),s&&(c.uvs===r&&(c.uvs=[]),c.uvs.push([x,h])),c.elements===r&&(c.elements=[]),c.elements[d]===r&&
(c.elements[d]=[]),c.elements[d][f]===r&&(c.elements[d][f]=[]),c.elements[d][f].push(C),o[E]===r&&(o[E]=[]),o[E].push([x,h,C]),C++)}}}if(this.edges){c.line_elements=[];d=0;for(A=this.edges.length;d<A;d++)g=this.edges[d],n=g[0],h=g[1],b=g[2],g=g[3],c.line_elements[n]=c.line_elements[n]||[],c.line_elements[n][h]=c.line_elements[n][h]||[],c.line_elements[n][h].push(o[b][0][2]),c.line_elements[n][h].push(o[g][0][2])}c.dynamic=this.dynamic;return c},compileVBO:function(b,g,a,c,e,d,f,n){"object"==typeof g?
(g=g.element!==r?g.element:!0,a=g.vertex!==r?g.vertex:!0,d=g.color!==r?g.color:!0,c=g.normal!==r?g.normal:!0,e=g.uv!==r?g.uv:!0,f=g.lines!==r?g.lines:!!b.line_elements,n=g.dynamic!==r?g.dynamic:b.dynamic):(g===r&&(g=!0),a===r&&(a=!0),d===r&&(d=!0),c===r&&(c=!0),e===r&&(e=!0),f===r&&(f=!!b.line_elements),n===r&&(n=b.dynamic));var h={},q,A,v,t,o;n&&(t={points:new Int16Array(b.points.length),face_points:new Int16Array(2*b.points.length),segments:null},h.dynamicMap=t,h.dynamic=!0);if(b.points&&a){q=b.points.length;
h.vbo_points=new Float32Array(3*q);for(a=0;a<q;a++)A=b.points[a],h.vbo_points[3*a]=this.points[A][0],h.vbo_points[3*a+1]=this.points[A][1],h.vbo_points[3*a+2]=this.points[A][2],n&&(t.points[a]=A)}if(n){o=b.normals||b.colors||b.uvs;a=0;for(q=o.length;a<q;a++)A=o[a],t.face_points[2*a]=A[0],t.face_points[2*a+1]=A[1]}if(b.normals&&c){q=b.normals.length;h.vbo_normals=new Float32Array(3*q);for(a=c=0;a<q;a++)A=b.normals[a],h.vbo_normals[c++]=this.faces[A[0]].point_normals[A[1]][0],h.vbo_normals[c++]=this.faces[A[0]].point_normals[A[1]][1],
h.vbo_normals[c++]=this.faces[A[0]].point_normals[A[1]][2]}if(b.colors&&d){q=b.colors.length;h.vbo_colors=new Float32Array(3*q);for(a=c=0;a<q;a++)A=b.colors[a],h.vbo_colors[c++]=this.faces[A[0]].point_colors[A[1]][0],h.vbo_colors[c++]=this.faces[A[0]].point_colors[A[1]][1],h.vbo_colors[c++]=this.faces[A[0]].point_colors[A[1]][2]}if(b.uvs&&e){q=b.uvs.length;h.vbo_uvs=new Float32Array(2*q);for(a=c=0;a<q;a++)A=b.uvs[a],h.vbo_uvs[c++]=this.faces[A[0]].uvs[A[1]][0],h.vbo_uvs[c++]=this.faces[A[0]].uvs[A[1]][1]}if(g){h.elements_ref=
[];h.vbo_elements=[];a=0;for(q=b.elements.length;a<q;a++)for(v in h.elements_ref[a]=[],g=0,b.elements[a])if(b.elements[a].hasOwnProperty(v)){c=b.elements[a][v];e=0;for(d=c.length;e<d;e++)h.vbo_elements.push(c[e]);h.elements_ref[a][g]=[v|0,c.length|0];g++}h.vbo_elements=new Uint16Array(h.vbo_elements)}if(f){h.line_elements_ref=[];h.vbo_line_elements=[];a=0;for(q=b.line_elements.length;a<q;a++)for(v in h.line_elements_ref[a]=[],g=0,b.line_elements[a])if(b.line_elements[a].hasOwnProperty(v)){c=b.line_elements[a][v];
e=0;for(d=c.length;e<d;e++)h.vbo_line_elements.push(c[e]);h.line_elements_ref[a][g]=[v|0,c.length|0];g++}h.vbo_line_elements=new Uint16Array(h.vbo_line_elements)}h.segments=b.segments;h.bounds=b.bounds;if(n&&1<b.segments.length){b=[];o=t.points;a=0;for(q=o.length;a<q;a++)f=this.faces[t.face_points[2*a]].segment||0,b[f]===r&&(b[f]=[]),b[f].push(a);h.dynamicMap.segmentMap=b}return h},updateVBO:function(b,g){if(!b.dynamic)return!1;var a,c,e=b.dynamicMap,d=g.points&&!!b.vbo_points,f=g.normals&&!!b.vbo_normals,
n=g.uvs&&!!b.vbo_uvs,h=g.colors&&!!b.vbo_colors;c=g.segments;var q,A,v;if(g.segments!==r)for(var t=0,o=c.length;t<o;t++)for(var m=e.segmentMap[c[t]],s=0,w=m.length;s<w;s++){if(a=m[s],A=this.faces[e.face_points[2*a]],v=e.face_points[2*a+1],d&&(q=this.points[e.points[a]],b.vbo_points[3*a]=q[0],b.vbo_points[3*a+1]=q[1],b.vbo_points[3*a+2]=q[2]),f&&(q=A.point_normals[v],b.vbo_normals[3*a]=q[0],b.vbo_normals[3*a+1]=q[1],b.vbo_normals[3*a+2]=q[2]),h&&(q=A.point_colors[v],b.vbo_colors[3*a]=q[0],b.vbo_colors[3*
a+1]=q[1],b.vbo_colors[3*a+2]=q[2]),n)q=A.uvs[v],b.vbo_uvs[2*a]=q[0],b.vbo_uvs[2*a+1]=q[1]}else{a=0;for(c=e.points.length;a<c;a++)if(A=this.faces[e.face_points[2*a]],v=e.face_points[2*a+1],d&&(q=this.points[e.points[a]],b.vbo_points[3*a]=q[0],b.vbo_points[3*a+1]=q[1],b.vbo_points[3*a+2]=q[2]),f&&(q=A.point_normals[v],b.vbo_normals[3*a]=q[0],b.vbo_normals[3*a+1]=q[1],b.vbo_normals[3*a+2]=q[2]),h&&(q=A.point_colors[v],b.vbo_colors[3*a]=q[0],b.vbo_colors[3*a+1]=q[1],b.vbo_colors[3*a+2]=q[2]),n)q=A.uvs[v],
b.vbo_uvs[2*a]=q[0],b.vbo_uvs[2*a+1]=q[1]}return this},rebufferVBO:function(b,g,a){var c=o.gl;a.points&&(c.bindBuffer(c.ARRAY_BUFFER,g.gl_points),c.bufferData(c.ARRAY_BUFFER,b.vbo_points,c.DYNAMIC_DRAW));a.normals&&b.vbo_normals&&(c.bindBuffer(c.ARRAY_BUFFER,g.gl_normals),c.bufferData(c.ARRAY_BUFFER,b.vbo_normals,c.DYNAMIC_DRAW));a.uvs&&b.vbo_uvs&&(c.bindBuffer(c.ARRAY_BUFFER,g.gl_uvs),c.bufferData(c.ARRAY_BUFFER,b.vbo_uvs,c.DYNAMIC_DRAW));a.colors&&b.vbo_colors&&(c.bindBuffer(c.ARRAY_BUFFER,g.gl_colors),
c.bufferData(c.ARRAY_BUFFER,b.vbo_colors,c.DYNAMIC_DRAW));c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(b,g){var a=o.gl,c={};g===r&&(g={});c.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.gl_points);a.bufferData(a.ARRAY_BUFFER,b.vbo_points,a.STATIC_DRAW);b.vbo_normals?(c.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_normals),a.bufferData(a.ARRAY_BUFFER,b.vbo_normals,a.STATIC_DRAW)):c.gl_normals=g.gl_normals?g.gl_normals:null;b.vbo_uvs?(c.gl_uvs=
a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_uvs),a.bufferData(a.ARRAY_BUFFER,b.vbo_uvs,a.STATIC_DRAW)):c.gl_uvs=g.gl_uvs?g.gl_uvs:null;b.vbo_colors?(c.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_colors),a.bufferData(a.ARRAY_BUFFER,b.vbo_colors,a.STATIC_DRAW)):c.gl_colors=g.gl_colors?g.gl_colors:null;!b.vbo_elements&&g.gl_elements?(c.gl_elements=g.gl_elements,c.elements_ref=g.elements_ref):(c.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,
b.vbo_elements,a.STATIC_DRAW),c.elements_ref=b.elements_ref);!b.vbo_line_elements&&g.gl_line_elements?(c.gl_line_elements=g.gl_line_elements,c.line_elements_ref=g.line_elements_ref):(c.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,b.vbo_line_elements,a.STATIC_DRAW),c.line_elements_ref=b.line_elements_ref);c.segments=b.segments;c.bounds=b.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return c},update:function(b){var b=
b||{},g=b.points||b.point||b.vertex||b.vertices||b.all||!0,a=b.uvs||b.uv||b.texture||b.all||!1,c=b.normals||b.normal||b.all||!0,e=b.colors||b.color||b.all||!1,b=b.segments||b.segment;b!==r&&b.length===r&&(b=[b]);if(!this.dynamic)return s("Mesh not defined as dynamic, cannot update."),!1;c&&this.normalMapRef&&this.recalcNormals(r,{segments:b});g={points:g,uvs:a,normals:c,colors:e,segments:b};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,g)},bindBuffer:function(b){null===
this.originBuffer&&(this.originBuffer=b);this.compiled=b;this.segment_state=[];for(var g=0,a=b.segments.length;g<a;g++)this.segment_state[b.segments[g]]=!0;this.bb=b.bounds},compile:function(b){if(0<this.faces.length&&0<this.points.length){var b=this.compileVBO(this.compileMap(b)),g=this.bufferVBO(b);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,c=this.points.length;a<c;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:b,buffer:g}}}return this},addMorphTarget:function(b){null===
this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(b)},setMorphSource:function(b){this.morphSourceIndex!==b&&(this.morphSourceIndex=b,this.bindBuffer(this.morphTargets[b]))},setMorphTarget:function(b){this.morphTargetIndex!==b&&(this.morphTargetIndex=b,this.morphTarget=this.morphTargets[b])},setMorphWeight:function(b){this.morphWeight=b},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:w,Face:y}});
CubicVR.RegisterModule("UVMapper",function(m){function y(a){a=m.get(a)||{};this.rotation=a.rotation===w?[0,0,0]:a.rotation;this.scale=a.scale===w?[1,1,1]:a.scale;this.center=a.center===w?[0,0,0]:a.center;this.projection_mode=a.projectionMode===w?r.uv.projection.PLANAR:m.parseEnum(r.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===w?r.uv.axis.X:m.parseEnum(r.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===w?1:a.wrapW;this.wrap_h_count=a.wrapH===w?1:a.wrapH}var w=m.undef,
r=m.enums,o=2*Math.PI,s=Math.PI/2;r.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var b=function(a,c,e){return 0===a&&0===e?0:0===e?0>a?s:-s:0>e?-Math.atan(a/e)+Math.PI:-Math.atan(a/e)},g=function(a,c,e){var d;0===a&&0===e?(d=0,a=0!==c?0>c?-s:s:0):(d=0===e?0>a?s:-s:0>e?-Math.atan(a/e)+Math.PI:-Math.atan(a/e),a=Math.sqrt(a*a+e*e),a=0===a?0>c?-s:s:Math.atan(c/a));return[d,a]};y.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,c,e,d,f){var n=m.mat4,h,q,A,v,t,D=new m.Transform,C=!1,B=null;if(this.center[0]||this.center[1]||this.center[2])D.translate(-this.center[0],-this.center[1],-this.center[2]),C=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
D.rotate(this.rotation[2],0,0,1),this.rotation[1]&&D.rotate(this.rotation[1],0,1,0),this.rotation[2]&&D.rotate(this.rotation[0],1,0,0),C=!0;C&&(B=D.getResult());"object"===typeof c&&(c=a.materials.indexOf(c));var D=0,I=a.faces.length;d&&(D=d);for(f&&(I=f+1);D<I;D++)if(a.faces[D].material===c&&!(e!==w&&a.faces[D].segment!==e)){var u,x,E;if(this.projection_mode===r.uv.projection.CUBIC||this.projection_mode===r.uv.projection.SKY)u=Math.abs(a.faces[D].normal[0]),x=Math.abs(a.faces[D].normal[1]),E=Math.abs(a.faces[D].normal[2]);
for(var d=[],f=0,z=a.faces[D].points.length;f<z;f++){q=a.faces[D].points[f];var y=a.faces[D].points[(f+1)%3],H=a.faces[D].points[(f+2)%3];h=a.points[q];var G=a.points[y],J=a.points[H],L;C&&(h=n.vec3_multiply(h,B));L=this.projection_mode;if(L===r.uv.projection.SKY)q=a.sky_mapping,u>=x&&u>=E&&(A=h[2]/this.scale[2]+this.scale[2]/2,v=-h[1]/this.scale[1]+this.scale[1]/2,0>a.faces[D].normal[0]?(A=(q[2][2]-q[2][0])*(1-A),v=1-(q[2][3]-q[2][1])*v,A+=q[2][0],v+=q[2][1]):(A*=q[3][2]-q[3][0],v=1-(q[3][3]-q[3][1])*
v,A+=q[3][0],v+=q[3][1])),x>=u&&x>=E&&(A=h[0]/this.scale[0]+this.scale[0]/2,v=-h[2]/this.scale[2]+this.scale[2]/2,0>a.faces[D].normal[1]?(A*=q[1][2]-q[1][0],v=1-(q[1][3]-q[1][1])*v,A+=q[1][0],v-=q[1][1]):(A*=q[0][2]-q[0][0],v=1-(q[0][3]-q[0][1])*v,A+=q[0][0],v-=q[0][1])),E>=u&&E>=x&&(A=h[0]/this.scale[0]+this.scale[0]/2,v=h[1]/this.scale[1]+this.scale[1]/2,0>a.faces[D].normal[2]?(A*=q[4][2]-q[4][0],v=1-(q[4][3]-q[4][1])*(1-v),A+=q[4][0],v-=q[4][1]):(A=(q[5][2]-q[5][0])*(1-A),v=1-(q[5][3]-q[5][1])*
(1-v),A+=q[5][0],v+=q[5][1])),a.faces[D].setUV([A,v],f);else if(L===r.uv.projection.CUBIC)u>=x&&u>=E&&(A=h[2]/this.scale[2]+0.5,v=h[1]/this.scale[1]+0.5),x>=u&&x>=E&&(A=-h[0]/this.scale[0]+0.5,v=h[2]/this.scale[2]+0.5),E>=u&&E>=x&&(A=-h[0]/this.scale[0]+0.5,v=h[1]/this.scale[1]+0.5),0<a.faces[D].normal[0]&&(A=-A),0>a.faces[D].normal[1]&&(A=-A),0<a.faces[D].normal[2]&&(A=-A),a.faces[D].setUV([A,v],f);else if(L===r.uv.projection.PLANAR)A=this.projection_axis===r.uv.axis.X?h[2]/this.scale[2]+0.5:-h[0]/
this.scale[0]+0.5,v=this.projection_axis===r.uv.axis.Y?h[2]/this.scale[2]+0.5:h[1]/this.scale[1]+0.5,a.faces[D].setUV([A,v],f);else{if(L===r.uv.projection.CYLINDRICAL)L=this.projection_axis,L===r.uv.axis.X?(t=b(h[2],h[0],-h[1]),v=-h[0]/this.scale[0]+0.5):L===r.uv.axis.Y?(t=b(-h[0],h[1],h[2]),v=-h[1]/this.scale[1]+0.5):L===r.uv.axis.Z&&(t=b(-h[0],h[2],-h[1]),v=-h[2]/this.scale[2]+0.5),t=1-t/o,1!==this.wrap_w_count&&(t*=this.wrap_w_count),h=t,q=v;else if(L===r.uv.projection.SPHERICAL){var M,K,N;L=this.projection_axis;
L===r.uv.axis.X?(M=d[q]?d[q]:g(h[2],h[0],-h[1]),d[q]||(d[q]=M),K=d[y]?d[y]:g(G[2],G[0],-G[1]),d[y]||(d[y]=K),N=d[H]?d[H]:g(J[2],J[0],-J[1]),d[H]||(d[H]=N)):L===r.uv.axis.Y?(M=d[q]?d[q]:g(h[0],-h[1],h[2]),d[q]||(d[q]=M),K=d[y]?d[y]:g(G[0],-G[1],G[2]),d[y]||(d[y]=K),N=d[H]?d[H]:g(J[0],-J[1],J[2]),d[H]||(d[H]=N)):L===r.uv.axis.Z&&(M=d[q]?d[q]:g(-h[0],h[2],-h[1]),d[q]||(d[q]=M),K=d[y]?d[y]:g(-G[0],G[2],-G[1]),d[y]||(d[y]=K),N=d[H]?d[H]:g(-J[0],J[2],-J[1]),d[H]||(d[H]=N));Math.abs(M[0]-K[0])>s&&Math.abs(M[0]-
N[0])>s&&(M[0]=M[0]>K[0]&&M[0]>N[0]?M[0]-o:M[0]+o);Math.abs(M[1]-K[1])>s&&Math.abs(M[1]-N[1])>s&&(M[1]=M[1]>K[1]&&M[1]>N[1]?M[1]-o:M[1]+o);t=1-M[0]/o;q=0.5-M[1]/Math.PI;1!==this.wrap_w_count&&(t*=this.wrap_w_count);1!==this.wrap_h_count&&(q*=this.wrap_h_count);h=t}else q=h=0;a.faces[D].setUV([h,q],f)}}}return this}};return{UVMapper:y}});
CubicVR.RegisterModule("Renderer",function(m){var y=m.undef;return{renderObject:function(w,r,o,s,b,g,a){var c=!1,b=b||!1,g=g||!1;if(null!==w.compiled){var e=0,d=m.GLCore.gl,f,n=s===y?0:s.length,h,q=0,A,v=null,t=w.instanceMaterials||w.materials,D=(a=(w.wireframe||a)&&w.compiled.line_elements_ref)?w.compiled.line_elements_ref:w.compiled.elements_ref,C=!1,B,I,u;d.depthFunc(d.LEQUAL);o===y&&(o=cubicvr_identity);for(var x=0,E=D.length;x<E;x++){var v=a&&w.wireframeMaterial?w.wireframeMaterial:t[x],z=0,
q=!1;if(1>v.opacity&&b)c=!0;else if(!(g&&1<=v.opacity)){1!==v.opacity?(d.enable(d.BLEND),d.depthMask(0),d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA)):(d.depthMask(1),d.disable(d.BLEND),d.blendFunc(d.ONE,d.ONE));for(var F=0,H=D[x].length;F<H;F++)if(A=D[x][F][0],q=!1,f=D[x][F][1],z+=f,v.visible){if(!w.segment_state[A])if(z>f){e+=2*f;z-=f;if(n){I=!1;for(B=0;B<n;){f=n-B;f>m.MAX_LIGHTS&&(f=m.MAX_LIGHTS);0<B&&!I&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),I=!0);h=s[B];u=h.light_type;
for(q=0;q<f;q++)if(s[q+B].light_type!=u){f=q;break}v.use(h.light_type,f);h=v.shader[h.light_type][f];d.uniformMatrix4fv(h.matrixModelView,!1,r.mvMatrix);d.uniformMatrix4fv(h.matrixProjection,!1,r.pMatrix);d.uniformMatrix4fv(h.matrixObject,!1,o);d.uniformMatrix3fv(h.matrixNormal,!1,r.nMatrix);C||(v.bindObject(w,h),C=-1!=h.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(q=0;q<f;q++)s[q+B].setupShader(h,q);a?d.drawElements(d.LINES,z,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,
z,d.UNSIGNED_SHORT,e);B+=f}I&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else v.use(0,0),d.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,r.mvMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixProjection,!1,r.pMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,o),d.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,r.nMatrix),C||(v.bindObject(w,v.shader[0][0]),C=-1!=v.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?d.drawElements(d.LINES,z,d.UNSIGNED_SHORT,
e):d.drawElements(d.TRIANGLES,z,d.UNSIGNED_SHORT,e);e+=2*z;z=0;q=!0}else e+=2*z,z=0}else e+=2*f,z-=f;if(!q&&w.segment_state[A]&&v.visible){if(n){I=!1;for(B=0;B<n;){f=n-B;f>m.MAX_LIGHTS&&(f=m.MAX_LIGHTS);0<B&&!I&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),I=!0);h=s[B];u=h.light_type;for(q=0;q<f;q++)if(s[q+B].light_type!=u){f=q;break}v.use(h.light_type,f);h=v.shader[h.light_type][f];d.uniformMatrix4fv(h.matrixModelView,!1,r.mvMatrix);d.uniformMatrix4fv(h.matrixProjection,!1,r.pMatrix);
d.uniformMatrix4fv(h.matrixObject,!1,o);d.uniformMatrix3fv(h.matrixNormal,!1,r.nMatrix);C||(v.bindObject(w,h),C=-1!=h.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(q=0;q<f;q++)s[q+B].setupShader(h,q);a?d.drawElements(d.LINES,z,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,z,d.UNSIGNED_SHORT,e);B+=f}I&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else v.use(0,0),d.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,r.mvMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixProjection,
!1,r.pMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,o),d.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,r.nMatrix),C||(v.bindObject(w,v.shader[0][0]),C=-1!=v.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?d.drawElements(d.LINES,z,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,z,d.UNSIGNED_SHORT,e);e+=2*z}}}v&&h?v.clearObject(w,h):v.clearObject(w,null);d.depthMask(1);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return c}}}});
CubicVR.RegisterModule("Light",function(m){function y(b,g){var a=m.aabb,b=m.get(b)||{};b===o&&(b=r.light.type.POINT);g===o&&(g=r.light.method.DYNAMIC);"object"==typeof b?(this.light_type=b.type!==o?m.parseEnum(r.light.type,b.type):r.light.type.POINT,this.diffuse=b.diffuse!==o?b.diffuse:[1,1,1],this.specular=b.specular!==o?b.specular:[1,1,1],this.intensity=b.intensity!==o?b.intensity:1,this.position=b.position!==o?b.position:[0,0,0],this.direction=b.direction!==o?b.direction:[0,0,0],this.distance=
b.distance!==o?b.distance:this.light_type===r.light.type.AREA?30:10,this.cutoff=b.cutoff!==o?b.cutoff:60,this.map_res=b.map_res!==o?b.map_res:this.light_type===r.light.type.AREA?2048:512,this.map_res=b.mapRes!==o?b.mapRes:this.map_res,this.method=b.method!==o?m.parseEnum(r.light.method,b.method):g,this.areaCam=b.areaCam!==o?b.areaCam:null,this.areaCeiling=b.areaCeiling!==o?b.areaCeiling:40,this.areaFloor=b.areaFloor!==o?b.areaFloor:-40,this.areaAxis=b.areaAxis!==o?b.areaAxis:[1,1,0],this.projectorTex=
b.projector!==o?b.projector:null):(this.light_type=m.parseEnum(r.light.type,b),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===r.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===r.light.type.AREA?2048:512,this.method=m.parseEnum(r.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&"string"===typeof this.projectorTex){var c=
this.projectorTex;this.projectorTex=m.Textures_ref[c]!==o?m.Textures_obj[m.Textures_ref[c]]:new m.Texture(c)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=m.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===
r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA&&m.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var w=m.GLCore,r=m.enums,o=m.undef,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];r.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};y.prototype={get x(){return this.position[0]},set x(b){this.position[0]=
b},get y(){return this.position[1]},set y(b){this.position[1]=b},get z(){return this.position[2]},set z(b){this.position[2]=b},get rotX(){return this.rotation[0]},set rotX(b){this.rotation[0]=b},get rotY(){return this.rotation[1]},set rotY(b){this.rotation[1]=b},get rotZ(){return this.rotation[2]},set rotZ(b){this.rotation[2]=b},get dirX(){return this.direction[0]},set dirX(b){this.direction[0]=b},get dirY(){return this.direction[1]},set dirY(b){this.direction[1]=b},get dirZ(){return this.direction[2]},
set dirZ(b){this.direction[2]=b},get pos(){return this.position.slice(0)},set pos(b){this.position=b.slice(0)},get rot(){return this.rotation.slice(0)},set rot(b){this.rotation=b.slice(0)},get dir(){return this.direction.slice(0)},set dir(b){this.direction=vec3.normalize(b.slice(0))},setType:function(b){if(b===r.light.type.AREA&&!m.features.lightShadows)this.dummyCam=new m.Camera,this.areaCam=new m.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,b=r.light.type.DIRECTIONAL;else if((b===
r.light.type.SPOT_SHADOW||b===r.light.type.SPOT_SHADOW_PROJECTOR)&&!m.features.lightShadows)b=r.light.type.SPOT;this.light_type=b},setParent:function(b){this.parent=b},setMethod:function(b){this.method=b},setDiffuse:function(b){this.diffuse=b},setSpecular:function(b){this.specular=b},setIntensity:function(b){this.intensity=b},setPosition:function(b){this.position=b},setDistance:function(b){this.distance=b},setCutoff:function(b){this.cutoff=b},prepare:function(b){var g=m.mat4,a=m.mat3,c=this.light_type;
this.parent?c===r.light.type.SPOT||c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR?(c=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(c),this.lDir=a.vec3_multiply(this.direction,c),this.lDir=a.vec3_multiply(this.lDir,b.nMatrix),this.lPos=g.vec3_multiply(this.position,g.multiply(b.mvMatrix,this.parent.tMatrix))):c===r.light.type.POINT&&(this.lPos=g.vec3_multiply(this.position,g.multiply(b.mvMatrix,this.parent.tMatrix))):c===r.light.type.DIRECTIONAL?this.lDir=a.vec3_multiply(this.direction,
b.nMatrix):c===r.light.type.SPOT||c===r.light.type.SPOT_SHADOW||c===r.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=a.vec3_multiply(this.direction,b.nMatrix),this.lPos=g.vec3_multiply(this.position,b.mvMatrix)):c===r.light.type.POINT?this.lPos=g.vec3_multiply(this.position,b.mvMatrix):c===r.light.type.AREA&&(this.lDir=a.vec3_multiply(this.direction,b.nMatrix))},control:function(b,g,a){b===r.motion.POS?this.position[g]=a:b===r.motion.INTENSITY&&(this.intensity=a)},getAABB:function(){var b=m.vec3,g=m.aabb,
a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=b.add(a[0],this.position);a[1]=b.add(a[1],this.position);return this.aabb=a},setDirection:function(b,g,a){var c=m.vec3;if("object"===typeof b)this.setDirection(b[0],b[1],b[2]);else return this.direction=c.normalize([b,g,a]),this},lookat:function(b,g,a){var c=m.vec3;if("object"===typeof b)this.lookat(b[0],b[1],b[2]);else return this.direction=c.normalize(c.subtract([b,
g,a],this.position)),this},setRotation:function(b,g,a){var c=m.mat4,e=m.vec3;if("object"===typeof b)this.setRotation(b[0],b[1],b[2]);else{var d=new m.Transform;d.rotate([-b,-g,-a]);d.pushMatrix();this.direction=e.normalize(c.vec3_multiply([1,0,0],d.getResult()));this.rotation=[b,g,a];return this}},setupShader:function(b,g){var a=w.gl;a.uniform3fv(b.lightDiffuse[g],this.diffuse);a.uniform3fv(b.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(b.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(b.lightDirection[g],
this.lDir);a.uniform1f(b.lightIntensity[g],this.intensity);a.uniform1f(b.lightDistance[g],this.distance);(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.SPOT)&&a.uniform1f(b.lightCutOffAngle[g],this.cutoff);if(this.light_type===r.light.type.SPOT_SHADOW||this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===r.light.type.AREA)this.light_type===r.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(w.gl.TEXTURE0+
2*g),a.uniform1i(b.lightShadowMap[g],2*g),this.projectorTex.use(w.gl.TEXTURE0+2*g+1),a.uniform1i(b.lightProjectionMap[g],2*g+1)):(this.shadowMapTex.texture.use(w.gl.TEXTURE0+g),a.uniform1i(b.lightShadowMap[g],g)),a.uniform3fv(b.lightDepthClip[g],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(b.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(b){m.features.lightShadows&&(this.map_res=b,this.shadowMapTex=new m.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(r.texture.filter.NEAREST),
this.dummyCam=new m.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(b){this.projectorTex=b},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var b=w.gl,g=m.mat4,a=m.mat3;this.shadowMapTex.use();b.viewport(0,0,this.map_res,this.map_res);b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT);this.light_type!==r.light.type.AREA?
(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var c=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(c);a.vec3_multiply(this.direction,c);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),
g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);b.cullFace(b.FRONT)},shadowEnd:function(){var b=w.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.cullFace(b.BACK);this.setupTexGen()},setupTexGen:function(){var b=m.mat4;this.spMatrix=b.multiply(s,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=
b.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=b.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(b){this.areaAxis=b},updateAreaLight:function(){var b=m.vec3,g=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),c=b.subtract(this.areaCam.target,this.areaCam.position);c[1]=0;c=b.normalize(c);b.normalize(b.cross(c,[0,1,0]));var e=-Math.atan2(c[2],c[0]),a=this.distance/2*Math.abs(a)-
this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);var c=b.multiply(c,a),a=this.areaAxis[1]*(Math.PI/180),d=Math.tan(this.areaAxis[0]*(Math.PI/180)),a=[Math.tan(a),0,d],e=e-Math.atan2(a[0],a[2]);this.position=b.add(b.add(this.areaCam.position,c),b.multiply(a,g));this.position[1]=this.areaCeiling;this.target=b.add(b.add(this.areaCam.position,c),b.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=b.normalize(b.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/
Math.PI);b=this.dummyCam.farclip*Math.abs(this.direction[1])*g;g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);g[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);g[1][1]>this.areaFloor&&(g=g[1][1]-this.areaFloor,b+=g/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=
b;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(b,g,a,c,e,d){var c=m.vec3,f=c.normalize([e[0],e[4],e[8]]),n=c.normalize([e[1],e[5],e[9]]),e=c.normalize(c.cross(n,f)),h;h=a/2;a=[];g=c.multiply(f,g/2);f=c.multiply(n,h);d=c.multiply(e,d);a[0]=c.add(c.subtract(b,g),c.add(f,d));a[1]=c.add(c.add(b,g),c.add(f,d));a[2]=c.subtract(c.subtract(b,g),c.add(f,d));a[3]=c.subtract(c.add(b,g),c.add(f,d));aabb1=a[0];aabb2=a[0];for(b=1;4>b;b++)aabb1[0]>
a[b][0]&&(aabb1[0]=a[b][0]),aabb1[1]>a[b][1]&&(aabb1[1]=a[b][1]),aabb1[2]>a[b][2]&&(aabb1[2]=a[b][2]),aabb2[0]<a[b][0]&&(aabb2[0]=a[b][0]),aabb2[1]<a[b][1]&&(aabb2[1]=a[b][1]),aabb2[2]<a[b][2]&&(aabb2[2]=a[b][2]);return[aabb1,aabb2]}};return{Light:y}});
CubicVR.RegisterModule("Camera",function(m){function y(a,c,e,d,f){var b=m.mat4;this.frustum=new m.Frustum;"object"==typeof a?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==o?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==o?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,c=a.height?a.height:o,a=a.width?
a.width:o):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==o?e:60,this.nearclip=d!==o?d:0.1,this.farclip=f!==o?f:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new m.Transform;this.manual=!1;this.setDimensions(a!==o?a:512,c!==o?c:512);this.mvMatrix=b.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}function w(a){this.position=
a!==o?a:[0,0,0]}function r(a,c,e){this.camPath=new m.Motion;this.targetPath=new m.Motion;this.start_position=a!==o?a:[8,8,8];this.target=c!==o?c:[0,0,0];this.bounds=e!==o?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var o=m.undef,s=m.enums,b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=0;y.prototype={get x(){return this.position[0]},
set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get targetX(){return this.target[0]},set targetX(a){this.target[0]=a},get targetY(){return this.target[1]},set targetY(a){this.target[1]=a},get targetZ(){return this.target[2]},
set targetZ(a){this.target[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},trackTarget:function(a,c,e){this.position=m.vec3.trackTarget(this.position,a,c,e)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?m.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(a,c,e,d){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=c;this.ortho_view.bottom=e;this.ortho_view.top=d},control:function(a,c,e){a===s.motion.ROT?this.rotation[c]=e:a===s.motion.POS?this.position[c]=e:a===s.motion.FOV?this.setFOV(e):a===s.motion.LENS?this.setLENS(e):a===s.motion.NEARCLIP?this.setClip(e,this.farclip):a===s.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,c,e,d,f,b){return[2*f/(c-a),0,0,0,0,2*f/
(d-e),0,0,(c+a)/(c-a),(d+e)/(d-e),-(b+f)/(b-f),-1,0,0,-2*b*f/(b-f),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=m.mat4,c=m.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),c.transpose_inline(this.nMatrix)):a.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,c){this.nearclip=a;this.farclip=c;this.calcProjection()},setDimensions:function(a,c){this.width=a;this.height=c;this.aspect=a/c;this.calcProjection()},
resize:function(a,c){this.setDimensions(a,c)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,c,e,d,f,n,h,g,o){var v=m.mat4,t=m.mat3;"object"==typeof a?this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0):(this.mvMatrix=v.lookat(a,c,e,d,f,n,h,g,o),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),
this.mvMatrix=this.transform.getResult()),null!==this.parent&&v.multiply(this.mvMatrix.slice(0),v.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=v.inverse_mat3(this.mvMatrix),t.transpose_inline(this.nMatrix)):this.nMatrix=b,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(a,c,e){var d=m.mat4,f=m.vec3,b=[0,0,this.width,this.height],a=d.vec4_multiply(d.vec4_multiply([2*((a-b[0])/b[2])-1,-(2*((c-b[1])/b[3])-1),1,1],d.inverse(this.pMatrix)),d.inverse(this.mvMatrix)),
a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];return e!==o?(c=this.getParentedPosition(),f.add(c,f.multiply(f.normalize(f.subtract(a,c)),e))):a},project:function(a,c,e){var d=m.mat4,d=d.vec4_multiply(d.vec4_multiply([a,c,e,1],this.mvMatrix),this.pMatrix);d[2]=m.vec3.length(m.vec3.subtract([a,c,e],this.position));return[(d[0]/d[3]+1)/2*this.width,(-d[1]/d[3]+1)/2*this.height,d[2]]}};w.prototype={control:function(a,c,e){a===s.motion.POS&&(this.position[c]=e)}};r.prototype={inBounds:function(a){var c=m.vec3;if(!(a[0]>
this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,d=this.avoid_sphere.length;e<d;e++)if(c.length(a,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,c){var e=m.vec3,d=[0,0,0],f=[0,0,0],b=d=0,h=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=e.normalize(f),d=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,
d=e.add(c.position,e.multiply(f,d)),h=this.inBounds(d),b++,30<b){d=c.position;break}while(!h);return d},run:function(a){this.current_time=a;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(s.motion.POS,s.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,this.start_position[2]));for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=
this.segment_time;var c=new w,e=new w;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,c);this.camPath.apply(this.path_time-this.segment_time,e);c=this.findNextNode(c,e);this.camPath.setKey(s.motion.POS,s.motion.X,this.path_time,c[0]);this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,c[1]);this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,c[2]);this.path_length++}c=new w;this.camPath.apply(a,c);return c.position},addSafeBound:function(a,c){this.safe_bb.push([a,
c])},addAvoidSphere:function(a,c){this.avoid_sphere.push([a,c])}};return{Camera:y,AutoCamera:r}});
CubicVR.RegisterModule("Motion",function(m){function y(){this.time=this.value=0;this.shape=s.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function w(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(s.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||s.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||s.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=s.envelope.behavior.CONSTANT}function r(a,c){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var e=CubicVR.get(a);this.env_init=CubicVR.get(e.envelope);this.key_init=CubicVR.get(e.key);for(var h in e)if(e.hasOwnProperty(h)&&!("envelope"===h||"key"===h)){var b=e[h],g=CubicVR.get(b.envelope),v;for(v in b)if(b.hasOwnProperty(v)&&!("envelope"===v||"key"===v)){var t=b[v];if("object"===typeof t)for(var o in t)this.setKey(h,o,v,t[o]),g&&this.setBehavior(h,o,
g)}}}else this.env_init=a,this.key_init=c}var o=m.undef,s=CubicVR.enums;s.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};s.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var b=function(a,c,e){var b=0,b=e-c;if(0===b)return[c,0];c=a-b*Math.floor((a-c)/b);b=-parseInt((c-a)/b+(c>a?0.5:-0.5),10);return[c,b]},g=function(a,c,e,b,g){var o,v;v=g*g;o=3*(c-
a);c=3*(e-c)-o;return(b-a-o-c)*v*g+c*v+o*g+a},a=function(c,f,e,b,q,o,v){var t,m;m=o+0.5*(v-o);t=g(c,f,e,b,m);return 1.0E-4<Math.abs(q-t)?(t>q?v=m:o=m,a(c,f,e,b,q,o,v)):m},c=function(a,c){var e,b,g,o;a.shape===s.envelope.shape.TCB?(e=(1-a.tension)*(1+a.continuity)*(1+a.bias),b=(1-a.tension)*(1-a.continuity)*(1-a.bias),g=c.value-a.value,a.prev?(o=(c.time-a.time)/(c.time-a.prev.time),e=o*(e*(a.value-a.prev.value)+b*g)):e=b*g):a.shape===s.envelope.shape.LINE?(g=c.value-a.value,a.prev?(o=(c.time-a.time)/
(c.time-a.prev.time),e=o*(a.value-a.prev.value+g)):e=g):a.shape===s.envelope.shape.BEZI||a.shape===s.envelope.shape.HERM?(e=a.param[1],a.prev&&(e*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===s.envelope.shape.BEZ2?(e=a.param[3]*(c.time-a.time),e=1.0E-5<Math.abs(a.param[2])?e/a.param[2]:1E5*e):e=0;return e},e=function(a,c){var e,b,g,o;c.shape===s.envelope.shape.LINE?(g=c.value-a.value,c.next?(o=(c.time-a.time)/(c.next.time-a.time),e=o*(c.next.value-c.value+g)):e=g):c.shape===s.envelope.shape.TCB?
(e=(1-c.tension)*(1-c.continuity)*(1+c.bias),b=(1-c.tension)*(1+c.continuity)*(1-c.bias),g=c.value-a.value,c.next?(o=(c.time-a.time)/(c.next.time-a.time),e=o*(b*(c.next.value-c.value)+e*g)):e*=g):c.shape===s.envelope.shape.HERM||c.shape===s.envelope.shape.BEZI?(e=c.param[0],c.next&&(e*=(c.time-a.time)/(c.next.time-a.time))):c.shape===s.envelope.shape.BEZ2?(e=c.param[1]*(c.time-a.time),e=1.0E-5<Math.abs(c.param[0])?e/c.param[0]:1E5*e):e=0;return e};w.prototype={setBehavior:function(a,c){this.in_behavior=
CubicVR.parseEnum(s.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,c)},empty:function(){return 0===this.nKeys},addKey:function(a,c,e){var b="object"==typeof a?a:e;c||(c=0);a||(a=0);b?(b=a,a=b.time,e=this.insertKey(a),e.value=b.value?b.value:c,e.time=b.time?b.time:a,e.shape=CubicVR.parseEnum(s.envelope.shape,b.shape)||s.envelope.shape.TCB,e.tension=b.tension?b.tension:0,e.continuity=b.continuity?b.continuity:0,e.bias=b.bias?b.bias:0,e.param=b.param?b.param:[0,0,0,0]):
(e=this.insertKey(a),e.value=c);return e},insertKey:function(a){var c=new y;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=c,this.nKeys++,c;for(var e=this.keys;e;){this.firstKey.time>a?this.firstKey=c:this.lastKey.time<a&&(this.lastKey=c);if(e.time>c.time)return c.prev=e.prev,c.prev&&(c.prev.next=c),c.next=e,c.next.prev=c,this.nKeys++,c;if(!e.next)return c.prev=e,e.next=c,this.nKeys++,c;e=e.next}return null},evaluate:function(d){var f,n,h,q,o,v=0;if(0===this.nKeys)return 0;if(1===
this.nKeys)return this.keys.value;n=this.firstKey;f=this.lastKey;if(d<n.time){q=this.in_behavior;if(q===s.envelope.behavior.RESET)return 0;if(q===s.envelope.behavior.CONSTANT)return n.value;if(q===s.envelope.behavior.REPEAT)q=b(d,n.time,f.time),d=q[0];else if(q===s.envelope.behavior.OCILLATE)q=b(d,n.time,f.time),d=q[0],q=q[1],q%2&&(d=f.time-n.time-d);else if(q===s.envelope.behavior.OFFSET)q=b(d,n.time,f.time),d=q[0],q=q[1],v=q*(f.value-n.value);else if(q===s.envelope.behavior.LINEAR)return o=c(n,
n.next)/(n.next.time-n.time),o*(d-n.time)+n.value}else if(d>f.time){q=this.out_behavior;if(q===s.envelope.behavior.RESET)return 0;if(q===s.envelope.behavior.CONSTANT)return f.value;if(q===s.envelope.behavior.REPEAT)q=b(d,n.time,f.time),d=q[0];else if(q===s.envelope.behavior.OCILLATE)q=b(d,n.time,f.time),d=q[0],q=q[1],q%2&&(d=f.time-n.time-d);else if(q===s.envelope.behavior.OFFSET)q=b(d,n.time,f.time),d=q[0],q=q[1],v=q*(f.value-n.value);else if(q===s.envelope.behavior.LINEAR)return q=e(f.prev,f)/(f.time-
f.prev.time),q*(d-f.time)+f.value}if(this.lastKey0)if(d>this.lastKey0.time)f=this.lastKey0;else if(d<this.lastKey0.time)for(f=this.lastKey;d<f.time&&f.prev;)f=f.prev;else f=this.keys;else f=this.keys;for(;d>f.next.time;)f=f.next;n=f.next;this.lastKey0=f;if(d===f.time)return f.value+v;if(d===n.time)return n.value+v;h=(d-f.time)/(n.time-f.time);q=n.shape;if(q===s.envelope.shape.TCB||q===s.envelope.shape.BEZI||q===s.envelope.shape.HERM){o=c(f,n);q=e(f,n);var t,m;m=h*h;t=h*m;d=3*m-t-t;t-=m;d=[1-d,d,t-
m+h,t];return d[0]*f.value+d[1]*n.value+d[2]*o+d[3]*q+v}return q===s.envelope.shape.BEZ2?(d=a(f.time,f.shape===s.envelope.shape.BEZ2?f.time+f.param[2]:f.time+(n.time-f.time)/3,n.time+n.param[0],n.time,d,0,1),g(f.value,f.shape===s.envelope.shape.BEZ2?f.value+f.param[3]:f.value+f.param[1]/3,n.param[1]+n.value,n.value,d)+v):q===s.envelope.shape.LINE?f.value+h*(n.value-f.value)+v:q===s.envelope.shape.STEP?f.value+v:v}};r.prototype={clone:function(){var a=new m.Motion(this.env_init,this.key_init),c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){a.controllers[c]===
o&&(a.controllers[c]=[]);for(var e in this.controllers[c])if(this.controllers[c].hasOwnProperty(e)){var b=this.controllers[c][e],g=a.controllers[c][e]=new w({in_behavior:b.in_behavior,out_behavior:b.out_behavior});g.nKeys=b.nKeys;g.keys=b.keys;g.firstKey=b.firstKey;g.lastKey=b.lastKey}}return a},envelope:function(a,c){c=CubicVR.parseEnum(s.motion,c)||0;a=CubicVR.parseEnum(s.motion,a)||0;this.controllers[a]===o&&(this.controllers[a]=[]);this.controllers[a][c]===o&&(this.controllers[a][c]=new w(this.env_init));
return this.controllers[a][c]},evaluate:function(a){var c=[],e;for(e in this.controllers)if(this.controllers.hasOwnProperty(e)){c[e]=[];for(var b in this.controllers[e])this.controllers[e].hasOwnProperty(b)&&(c[e][b]=this.controllers[e][b].evaluate(a))}return c},apply:function(a,c){for(var e in this.controllers)if(this.controllers.hasOwnProperty(e)){var b=parseInt(e,10);if(this.yzflip&&b===s.motion.ROT){this.q||(this.q=new CubicVR.Quaternion);var g=this.q,o=this.controllers[e][0].evaluate(a),v=this.controllers[e][1].evaluate(a),
t=this.controllers[e][2].evaluate(a);g.fromEuler(o,t,-v);g=g.toEuler();c.control(b,0,g[0]);c.control(b,1,g[1]);c.control(b,2,g[2])}else for(var m in this.controllers[e])this.controllers[e].hasOwnProperty(m)&&c.control(b,parseInt(m,10),this.controllers[e][m].evaluate(a))}},setKey:function(a,c,e,b,g){c=CubicVR.parseEnum(s.motion,c)||0;a=CubicVR.parseEnum(s.motion,a)||0;return this.envelope(a,c).addKey(e,b,g?g:this.key_init)},setArray:function(a,c,e,b){var g=[],a=CubicVR.parseEnum(s.motion,a)||0,o;for(o in e)if(e.hasOwnProperty(o)){var v=
this.envelope(a,CubicVR.parseEnum(s.motion,o));g[o]=v.addKey(c,e[o],b?b:this.key_init)}return g},setBehavior:function(a,c,e,b){var g=this.envelope(a,c);"object"===typeof e&&(b=e,e=b.in_behavior||b.inBehavior||b.behavior,b=b.out_behavior||b.outBehavior||b.behavior);CubicVR.parseEnum(s.motion,c);CubicVR.parseEnum(s.motion,a);g.setBehavior(e,b)},setBehaviorArray:function(a,c,e){var a=CubicVR.parseEnum(s.motion,a)||0,b=this.controllers[a],g;for(g in b)b.hasOwnProperty(g)&&this.envelope(a,CubicVR.parseEnum(s.motion,
g)||0).setBehavior(c,e)}};return{Motion:r,Envelope:w,EnvelopeKey:y}});
CubicVR.RegisterModule("EventHandler",function(m){function y(g){g=CubicVR.parseEnum(s.event,g);return g===o?(b("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(g,10))&&(g>=s.event.EVENT_MAX||0>g)?(b("Unknown event ID passed: "+g),!1):g}function w(b){b=b||{};this.name=b.name;b.id=y(b.id)||s.event.TICK;this.id=b.id;this.interval=b.interval||0;this.enabled=b.enabled||
!0;this.action=b.action||null;this.properties=b.properties||{};this.event_properties=b.event_properties||{};this.buffered=b.buffered||!1;this.weight=b.weight===o?-1:b.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function r(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var o=m.undef,
s=CubicVR.enums,b=m.log;s.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};w.prototype={getName:function(){return this.name},setName:function(b){this.name=b},getSubject:function(){return this.subject},setSubject:function(b){this.subject=b},getId:function(){return this.id},setId:function(b){this.id=b},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(b){b&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=b},isBuffered:function(){return this.buffered},setBuffered:function(b){this.buffered=b},setInterval:function(b){this.interval=b},getInterval:function(){return this.interval},setAction:function(b){this.action=b},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(b){this.properties=
b},getProperty:function(b){return this.properties[b]},setProperty:function(b,a){this.properties[b]=a},setEventProperties:function(b){this.event_properties=b},getEventProperties:function(){return this.event_properties},getEventProperty:function(b){return this.event_properties[b]},setEventProperty:function(b,a){this.properties[b]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(b){this.t_rest=b},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(b){this.setRestInterval(b||0)},awake:function(){this.t_rest=0},update:function(b,a){if(!this.enabled)return!1;var c=0,e=!0;0===this.n_updates?(this.t_updatecall=this.t_update=b,c=1/60):b!==this.t_update?
(this.t_rest||(this.t_last=b-this.t_update,this.t_update=b),c=b-this.t_updatecall,this.t_updatecall=b):e=!1;if(0<this.t_rest)e&&(this.t_resting+=c,this.t_rest-=c,0>this.t_rest&&(this.t_rest=0));else return e&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(a),!0;e&&this.n_updates++;return!1},callEvent:function(b){return!this.action?!1:this.action(this,b)}};r.prototype={addEvent:function(b){b.callEvent||(b=new w(b));var a=b.getId();
this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(b);-1===this.listenerNames.indexOf(a)&&this.listenerNames.push(a);return b},removeEvent:function(b){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(b)&&this.lockRemovals.push(b);else{var a=this.events.indexOf(b);-1!==a&&(b=b.getId(),this.events.splice(a,1),this.listeners[b]--,this.listeners[b]||(this.eventHandled[b]=!0,this.eventParameters[b]=
{},this.eventProperties[b]=[],this.eventPropertyCount[b]=0,a=this.listenerNames.indexOf(b),0<=a&&this.listenerNames.splice(a,1)))}},getProperties:function(b){this.eventParameters[b]=this.eventParameters[b]||{};return this.eventParameters[b]},setProperties:function(b,a){this.eventParameters[b]=a},getProperty:function(b,a){return this.getProperties(b)[a]},setProperty:function(b,a,c){this.getProperties(b)[a]=c},hasEvent:function(b){return!!this.listeners[b]},triggerEvent:function(b,a){if(!this.listeners[b])return null;
this.eventProperties[b]==o&&(this.eventProperties[b]=[]);var c=this.eventProperties[b];this.eventPropertyCount[b]===o&&(this.eventPropertyCount[b]=0);var e=this.eventPropertyCount[b];20<e&&console.log("Warning, event "+b+" count > 20: "+e);c[e]=a&&c?a:c[e]||{};this.eventPropertyCount[b]++;this.eventHandled[b]=!1;return c[e]},update:function(b){var a,c,e,d,f,n;if(this.hasEvent(s.event.TICK)&&0===this.eventPropertyCount[s.event.TICK]&&(a=this.triggerEvent(s.event.TICK)))a.time=b,a.handler=this;this.lockState=
!0;a=0;for(c=this.events.length;a<c;a++){f=this.events[a];n=f.getId();d=this.eventPropertyCount[n];var h=!1;e=!1;if(d){var q=this.eventProperties[n];if(f.isEnabled()){if(f.isBuffered()){if(q.length=d,f.setEventProperties(q),h=h||f.update(b,this),f.isChainBroken()){f.breakChain(!1);break}}else for(e=0;e<d;e++)if(f.setEventProperties(q[a]),h=h||f.update(b,this),f.isChainBroken()){f.breakChain(!1);break}e=!0}}if(h||!e)this.eventHandled[n]=!0}a=0;for(c=this.listenerNames.length;a<c;a++)n=this.listenerNames[a],
this.eventHandled[n]&&(this.eventPropertyCount[n]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(c=this.lockRemovals.length;a<c;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:w,EventHandler:r,registerEvent:function(g){g=g.toUpperCase();s.event[g]!==o?b("Error, event '"+g+"' is already registered."):(s.event[g]=s.event.ENUM_MAX,s.event.ENUM_MAX++)},validateEvent:y}});
CubicVR.RegisterModule("Scene",function(m){function y(a,c){return a.light_type-c.light_type}function w(f,e){var b=null,d;f!==s&&null!==f?f.compile?b={}:(b=m.get(f)||{},f=null):b={};this.morphWeight=b.morphWeight||0;this.morphSource=b.morphSource||-1;this.morphTarget=b.morphTarget||-1;this.position=b.position===s?[0,0,0]:b.position;this.rotation=b.rotation===s?[0,0,0]:b.rotation;this.scale=b.scale===s?[1,1,1]:b.scale;this.shadowCast=b.shadowCast===s?!0:b.shadowCast;this.wireframe=b.wireframe||!1;this.motion=
b.motion===s?null:m.get(b.motion,m.Motion)||null;this.obj=!b.mesh?f?m.get(f,m.Mesh):null:m.get(b.mesh,m.Mesh);this.name=b.name===s?e!==s?e:null:b.name;this.properties=m.get(b.properties)||{};this.parent=this.children=null;var g=b.children||b.child||b.sceneObject||b.sceneObjects;if(g){if(g&&!g.length||"string"===typeof g)g=[g];if(g.length){b=0;for(d=g.length;b<d;b++)this.bindChild(m.get(g[b],m.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=c.identity();this.tMatrix=c.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function r(a,c,e,b,g,o){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=m.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+d;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
c=a.setup&&a.setup(this)||{};this.update=c.update||this.update;this.enable=c.enable||this.enable;this.disable=c.disable||this.disable;this.destroy=c.destroy||this.destroy;if((b=a.sceneObjects||a.sceneObject||a.objects)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(e=b.length;c<e;c++)this.bindSceneObject(m.get(b[c],m.SceneObject))}if((b=a.lights||a.light)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(e=b.length;c<e;c++)this.bindLight(m.get(b[c],m.Light))}if((b=a.cameras||
a.camera)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(e=b.length;c<e;c++)this.bindCamera(m.get(b[c],m.Camera));this.camera=this.cameras[0]}b||(this.camera=new m.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip))}else this.skybox=null,this.octree=o,this.name="scene"+d,this.camera=new m.Camera(a,c,e,b,g),this.wireframe=!1;this.paused=!1;++d}function o(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var s=m.undef,b=m.enums,
g=m.GLCore,a=m.aabb,c=m.mat4,e=0;w.prototype={get x(){return this.position[0]},set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=
a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},get sclX(){return this.scale[0]},set sclX(a){this.scale[0]=a},get sclY(){return this.scale[1]},set sclY(a){this.scale[1]=a},get sclZ(){return this.scale[2]},set sclZ(a){this.scale[2]=a},get scl(){return this.scale.slice(0)},set scl(a){this.scale=a.slice(0)},clone:function(){var a,c;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var e=new m.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),
rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){e.instanceMaterials=[];a=0;for(c=this.instanceMaterials.length;a<c;a++)e.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(null!==this.children){a=0;for(c=this.children.length;a<c;a++)e.bindChild(this.children[a].clone())}return e},
evaluate:function(a){var c,e;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(null!==this.children){c=0;for(e=this.children.length;c<e;c++)this.children[c].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){this.eventHandler||(this.eventHandler=new m.EventHandler);a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},
getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,c){this.properties[a]=c},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,c=this.obj.materials.length;a<c;a++)this.instanceMaterials[a]=
this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var c=this.getInstanceMaterials(),e=0,b=c.length;e<b;e++)if(c[e].name==a)return c[e];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?
this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MATRIX_UPDATE)&&(a.triggerEvent(b.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(a){var e=m.vec3;if(!this.matrixLock&&(!e.equal(this.lposition,this.position)||!e.equal(this.lrotation,this.rotation)||!e.equal(this.lscale,
this.scale)||a!==s))a!==s?this.tMatrix=a.slice(0):c.identity(this.tMatrix),c.identity(this.lMatrix),c.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),c.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||c.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),c.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],
this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MOVE)&&(a=a.triggerEvent(b.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale))},adjust_octree:function(){var c=
this.getAABB(),e=this.octree_aabb,b=c[0][0],d=c[0][1],g=c[0][2],o=c[1][0],t=c[1][1],m=c[1][2],r=e[0][0],w=e[0][1],I=e[0][2],u=e[1][0],x=e[1][1],e=e[1][2];if(0<this.octree_leaves.length&&(b<r||d<w||g<I||o>u||t>x||m>e)){for(b=0;b<this.octree_leaves.length;++b)this.octree_leaves[b].remove(this);this.octree_leaves=[];this.static_lights=[];b=this.octree_common_root;this.octree_common_root=null;if(null!==b){for(;;)if(!b.contains_point(c[0])||!b.contains_point(c[1]))if(b._root!==s&&null!==b._root)b=b._root;
else break;else break;a.reset(this.octree_aabb,this.position);b.insert(this)}}},bindChild:function(a){null===this.children&&(this.children=[]);a.parent=this;this.children.push(a)},control:function(a,c,e){a===b.motion.POS?this.position[c]=e:a===b.motion.SCL?this.scale[c]=e:a===b.motion.ROT&&(this.rotation[c]=e)},getAABB:function(){var a=m.mat4,c=m.vec3;if(this.dirty){var e=Array(8);this.doTransform();var b,d;if(this.obj){if(!this.obj.bb)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,
1],this.position)];b=this.obj.bb[0];d=this.obj.bb[1]}if(!this.obj||b===s||d===s)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,1],this.position)];var g=b;b=c.subtract(d,b);e[0]=[g[0],g[1],g[2]];e[1]=[g[0],g[1],g[2]+b[2]];e[2]=[g[0]+b[0],g[1],g[2]];e[3]=[g[0]+b[0],g[1],g[2]+b[2]];e[4]=[g[0],g[1]+b[1],g[2]];e[5]=[g[0],g[1]+b[1],g[2]+b[2]];e[6]=[g[0]+b[0],g[1]+b[1],g[2]];e[7]=[g[0]+b[0],g[1]+b[1],g[2]+b[2]];g=a.vec3_multiply(e[0],this.tMatrix);b=[g[0],g[1],g[2]];d=[g[0],g[1],g[2]];for(c=
1;8>c;++c)g=a.vec3_multiply(e[c],this.tMatrix),b[0]>g[0]&&(b[0]=g[0]),b[1]>g[1]&&(b[1]=g[1]),b[2]>g[2]&&(b[2]=g[2]),d[0]<g[0]&&(d[0]=g[0]),d[1]<g[1]&&(d[1]=g[1]),d[2]<g[2]&&(d[2]=g[2]);this.aabb[0]=b;this.aabb[1]=d;this.dirty=!1}return this.aabb}};var d=0;r.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(c){this.octree=c;c.init&&c.init(this);c=this.lights;this.lights=[];for(var b=0,d=c.length;b<d;b++)this.bindLight(c[b]);c=
this.sceneObjects;if(this.octree!==s){b=0;for(d=c.length;b<d;++b){var g=c[b];null!==g.obj&&(0>g.id&&(g.id=e,++e),this.sceneObjectsById[g.id]=g,a.reset(g.octree_aabb,g.position),this.octree.insert(g),(void 0===g.octree_common_root||null===g.octree_common_root)&&log("!!",g.name,"octree_common_root is null"))}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(c,b,d){if(-1==this.sceneObjects.indexOf(c)){this.sceneObjects.push(c);
b!==s&&b&&this.pickables.push(c);null!==c.name&&(this.sceneObjectsByName[c.name]=c);if(this.octree!==s&&(d===s||"true"===d))0>c.id&&(c.id=e,++e),this.sceneObjectsById[c.id]=c,a.reset(c.octree_aabb,c.position),this.octree.insert(c);if(c.children)for(var g=0,o=c.children.length;g<o;g++)this.bindSceneObject(c.children[g],b,d);return c}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var c;if(this.lockState)this.lockRemovals||(this.lockRemovals=
[]),-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a);else if(c=this.sceneObjects.indexOf(a),0<=c&&this.sceneObjects.splice(c,1),c=this.pickables.indexOf(a),0<=c&&this.pickables.splice(c,1),null!==a.name&&this.sceneObjectsByName[a.name]!==s&&delete this.sceneObjectsByName[a.name],a.children){c=0;for(var e=a.children.length;c<e;c++)this.removeSceneObject(a.children[c])}},bindLight:function(a,c){this.lights.push(a);if(this.octree!==s&&(c===s||"true"===c))a.method===b.light.method.GLOBAL?this.global_lights.push(a):
(a.method===b.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(y)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof m.Light?this.bindLight(a):a instanceof m.SceneObject?this.bindSceneObject(a):
a instanceof m.Camera?this.bindCamera(a):a instanceof m.Vehicle?a.bindToScene(this):a instanceof m.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof m.Light?this.removeLight(a):a instanceof m.SceneObject?this.removeSceneObject(a):a instanceof m.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){a&&("object"!==typeof a&&(a=this.getCamera(a)),this.camera=a)},getCamera:function(a){return a===s?
this.camera:this.camerasByName[a]},evaluate:function(a){var c,e;c=0;for(e=this.sceneObjects.length;c<e;c++)this.sceneObjects[c].motion&&!this.sceneObjects[c].independentMotion&&this.sceneObjects[c].motion.apply(a,this.sceneObjects[c]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(a,this.camera));c=0;for(e=this.lights.length;c<e;c++){var b=this.lights[c];null!==b.motion&&b.motion.apply(a,b)}},prepareTransforms:function(a){var c,
e;if(a){if(a.doTransform(),a.children){c=0;for(e=a.children.length;c<e;c++)a.children[c].doTransform(a.tMatrix),this.prepareTransforms(a.children[c])}}else if(0!==this.sceneObjects.length){c=0;for(e=this.sceneObjects.length;c<e;++c)this.prepareTransforms(this.sceneObjects[c])}},updateShadows:function(a){var c=g.gl;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(m.features.lightShadows){for(var a=c.getParameter(c.FRAMEBUFFER_BINDING),e=!1,d=c.getParameter(c.VIEWPORT),
o=0,v=this.lights.length;o<v;o++){var t=this.lights[o];if(t.light_type==b.light.type.SPOT_SHADOW||t.light_type==b.light.type.SPOT_SHADOW_PROJECTOR||t.light_type==b.light.type.AREA){var e=!0,r=[new m.Light(b.light.type.DEPTH_PACK)];t.light_type===b.light.type.AREA&&(t.areaCam=this.camera,t.updateAreaLight());g.shadow_near=t.dummyCam.nearclip;g.shadow_far=t.dummyCam.farclip;t.shadowBegin();for(var C=0,s=this.sceneObjects.length;C<s;C++){var w=this.sceneObjects[C];w.parent||!1===w.visible||!1===w.shadowCast||
this.renderSceneObject(w,t.dummyCam,r,!1,!0)}t.shadowEnd();a&&c.bindFramebuffer(c.FRAMEBUFFER,a)}}e&&c.viewport(d[0],d[1],d[2],d[3])}},updateCamera:function(){!1===this.camera.manual&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,c){this.camera&&
this.camera.setDimensions(a,c)},doTransform:function(){for(var a=this.octree!==s,c=0,e=this.sceneObjects.length;c<e;c++){var b=this.sceneObjects[c];null===b.parent&&(this.prepareTransforms(b),a&&(lights=[],b.dirty&&null!==b.obj&&b.adjust_octree(),!1===b.visible||a&&(b.ignore_octree||!0===b.drawn_this_frame||!0===b.culled)||(lights=b.dynamic_lights,lights=lights.concat(b.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(this.lights_rendered=Math.max(lights.length,this.lights_rendered),
this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered),lights=0===lights.length?[g.emptyLight]:lights.sort(y),b.drawn_this_frame=!0)))}},renderSceneObject:function(a,c,e,b,d,o,t){var r=!1,C=g.gl,b=b!==s&&b,d=d||!1,o=o||!1;if(a.visible&&a.obj){0>a.scale[0]&&(r=!r);0>a.scale[1]&&(r=!r);0>a.scale[2]&&(r=!r);r&&C.cullFace(C.FRONT);var w=a.obj;null!==w.morphTargets&&(-1!==a.morphSource&&w.setMorphSource(a.morphSource),-1!==a.morphTarget&&w.setMorphTarget(a.morphTarget),null!==
a.morphWeight&&(w.morphWeight=a.morphWeight));a.instanceMaterials&&w.bindInstanceMaterials(a.instanceMaterials);m.renderObject(w,c,a.tMatrix,e,d,o,this.isWireframe()||a.isWireframe())&&t&&t.push(a);a.instanceMaterials&&w.bindInstanceMaterials(null);r&&C.cullFace(C.BACK)}a=a.children;if(b&&a){b=0;for(r=a.length;b<r;b++)this.renderSceneObject(a[b],c,e,!0,d,o,t)}},runEvents:function(a){var c,e;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());c=0;for(e=this.sceneObjects.length;c<e;c++){var b=this.sceneObjects[c];
b.hasEvents()&&b.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){c=0;for(e=this.lockRemovals.length;c<e;c++)this.removeSceneObject(this.lockRemovals[c])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var e=g.gl,b;b=this.octree!==s;this.lights_rendered=0;b&&(this.octree.reset_node_visibility(),this.octree.cleanup(),b=this.octree.get_frustum_hits(this.camera),this.lights_rendered=b.lights.length);this.doTransform();
this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var d;b=0;for(d=this.lights.length;b<d;b++)this.lights[b].prepare(this.camera);this.objects_rendered=0;var o=[],v=[],t=this.lights;b=0;for(d=this.sceneObjects.length;b<d;b++){var r=this.sceneObjects[b];!1===r.visible||null!==r.parent||this.renderSceneObject(r,this.camera,t,!0,!0,!1,v)}b=0;for(d=v.length;b<d;b++)this.renderSceneObject(v[b],this.camera,t,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,
this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=o,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(e.cullFace(e.FRONT),b=2*this.camera.farclip/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?c.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=
[b,b,b],this.skybox.scene_object.doTransform(),m.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),e.cullFace(e.BACK));a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,c,b){var e=m.vec3,d=[],c=2===c.length?this.camera.unProject(c[0],c[1]):e.add(a,c),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var t=this.pickables[g];if(!0===t.visible){var o,r;r=t.getAABB();o=r[0];r=r[1];0.2>r[0]-o[0]&&(o[0]-=
0.1,r[0]+=0.1);0.2>r[1]-o[1]&&(o[1]-=0.1,r[1]+=0.1);0.2>r[2]-o[2]&&(o[2]-=0.1,r[2]+=0.1);var s=e.multiply(e.add(o,r),0.5),w=e.getClosestTo(a,c,s),s=e.length(e.subtract(w,s));(w[0]>=o[0]&&w[0]<=r[0]?1:0)+(w[1]>=o[1]&&w[1]<=r[1]?1:0)+(w[2]>=o[2]&&w[2]<=r[2]?1:0)>=b&&d.push({dist:s,obj:t})}}d.length&&d.sort(function(a,c){return a.dist==c.dist?0:a.dist<c.dist?-1:1});return d}};o.prototype={addMesh:function(a,c,b){this.meshBin[a]===s&&(this.meshBin[a]=[],this.meshBinPtr[a]===s&&(this.meshBinPtr[a]=0));
this.meshMap[c]===s&&(this.meshMap[c]=b,this.meshBin[a].push(b))},addImage:function(a,c,b){this.imageBin[a]===s&&(this.imageBin[a]=[],this.imageBinPtr[a]===s&&(this.imageBinPtr[a]=0));this.imageMap[c]===s&&(this.imageMap[c]=b,this.imageBin[a].push(b))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var c=this.meshBinPtr[a];return c<this.meshBin[a].length?
(this.meshBinPtr[a]++,this.meshBin[a][c]):null},loadNextMesh:function(a){a=this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);null!==a&&(a.src=a.deferredSrc)},getNextImage:function(a){var c=this.imageBinPtr[a];return c<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][c]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===
this.imageBin[a].length}};return{Scene:r,SceneObject:w,SkyBox:function(a){var c=a.texture,a=a.mapping,b=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){c.onready=null;var a=1/m.Images[b.texture.tex_id].width;null===b.mapping&&(b.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]]);var a=new m.Material({name:"skybox",textures:{color:c},noFog:!0}),e=new m.Mesh;e.sky_mapping=b.mapping;m.primitives.box({mesh:e,size:1,material:a,
uvmapper:{projectionMode:m.enums.uv.projection.SKY,scale:[1,1,1]}});e.prepare();b.scene_object=new m.SceneObject(e);b.ready=!0};if(c&&("string"===typeof c?c=new m.Texture(c,null,null,null,this.onready):c.loaded||(c.onready=this.onready),this.texture=c,a))this.mapping=a,this.onready()},DeferredBin:o}});
CubicVR.RegisterModule("PostProcess",function(m){function y(a){if(a.shader_vertex===o||a.shader_fragment===o)return null;this.outputMode=a.outputMode===o?b.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===o?null:a.onresize;this.onupdate=a.onupdate===o?null:a.onupdate;this.init=a.init===o?null:a.init;this.enabled=a.enabled===o?!0:a.enabled;this.outputDivisor=a.outputDivisor===o?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function w(a,b,d){var f=s.gl;this.width=a;this.height=b;this.accum=d===o?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,b,!0);this.bufferA=new CubicVR.RenderBuffer(a,b,!1);this.bufferB=new CubicVR.RenderBuffer(a,
b,!1);this.bufferC=new CubicVR.RenderBuffer(a,b,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(a,b,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT),this.blur_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.bufferB.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,b)}function r(a,b,d){this.createBuffer(a,b,d)}var o=m.undef,s=m.GLCore,b=CubicVR.enums;b.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];w.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,b){var d=s.gl,f={},g=a/a,h=b/b;f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,g,0,g,h,0,h,0,0,g,h]);f.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,
f.gl_points);d.bufferData(d.ARRAY_BUFFER,f.vbo_points,d.STATIC_DRAW);f.gl_uvs=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,f.gl_uvs);d.bufferData(d.ARRAY_BUFFER,f.vbo_uvs,d.STATIC_DRAW);return f},destroyFSQuad:function(a){var b=s.gl;b.deleteBuffer(a.gl_points);b.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,b){var d=s.gl;a.use();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,b.gl_points);d.vertexAttribPointer(a.aVertex,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aVertex);
d.bindBuffer(d.ARRAY_BUFFER,b.gl_uvs);d.vertexAttribPointer(a.aTex,2,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aTex);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.drawArrays(d.TRIANGLES,0,6)},addShader:function(c){this.shaders[this.shaders.length]=c;c.shader.use();c.shader.setVector("texel",this.vTexel);if(c.outputDivisor&&1!=c.outputDivisor&&g[c.outputDivisor]===o){var b=this.width/c.outputDivisor|0,d=this.height/c.outputDivisor|0;g[c.outputDivisor]=new CubicVR.RenderBuffer(b,d,!1);a[c.outputDivisor]=
this.makeFSQuad(b,d)}},resize:function(c,b){var d=s.gl;this.width=c;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT));for(var f in g){var d=this.width/f|0,n=this.height/f|0;g[f].destroyBuffer();g[f].createBuffer(d,n,!1);this.destroyFSQuad(a[f]);a[f]=this.makeFSQuad(d,n)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;f=0;for(d=this.shaders.length;f<d;f++)if(this.shaders[f].shader.use(),this.shaders[f].shader.setVector("texel",this.vTexel),null!==this.shaders[f].onresize)this.shaders[f].onresize(this.shaders[f].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var b=s.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT))},end:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var c=s.gl;this.captureBuffer.texture.use(c.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(c.TEXTURE0);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,d=0,f=this.shaders.length;d<f;d++){var n=this.shaders[d];if(n.enabled){this.swap();this.inputBuffer.texture.use(c.TEXTURE0);var h=n.outputMode;if(h===b.post.output.REPLACE)1!==n.outputDivisor?g[n.outputDivisor].use():this.outputBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);else if(h===b.post.output.ADD||
h===b.post.output.BLEND)1!==n.outputDivisor?g[n.outputDivisor].use():this.bufferC.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);null!==n.onupdate&&(n.shader.use(),n.onupdate(n.shader));1!==n.outputDivisor?(c.viewport(0,0,g[n.outputDivisor].width,g[n.outputDivisor].height),this.renderFSQuad(n.shader,a[n.outputDivisor]),n.outputMode===b.post.output.REPLACE?(this.outputBuffer.use(),g[n.outputDivisor].texture.use(c.TEXTURE0),c.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):c.viewport(0,0,this.width,this.height)):this.renderFSQuad(n.shader,this.fsQuad);h===b.post.output.BLEND?(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(c.TEXTURE0),1!==n.outputDivisor?g[n.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND)):h===b.post.output.ADD&&(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),
c.blendFunc(c.ONE,c.ONE),1!==n.outputDivisor?g[n.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND));this.end();e++}}0===e?this.captureBuffer.texture.use(c.TEXTURE0):this.outputBuffer.texture.use(c.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),c.disable(c.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(c.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),c.disable(c.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};r.prototype={createBuffer:function(a,
b,d){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),f=s.gl;this.fbo=f.createFramebuffer();d&&(this.depth=f.createRenderbuffer());f.bindFramebuffer(f.FRAMEBUFFER,this.fbo);d&&(f.bindRenderbuffer(f.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,b),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depth)):
(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,b),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;f.bindTexture(f.TEXTURE_2D,m.Textures[this.texture.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texImage2D(f.TEXTURE_2D,
0,f.RGBA,a,b,0,f.RGBA,f.UNSIGNED_BYTE,null);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,m.Textures[this.texture.tex_id],0);f.bindFramebuffer(f.FRAMEBUFFER,null)},destroyBuffer:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(m.Textures[this.texture.tex_id]);m.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:r,PostProcessShader:y,PostProcessChain:w,fsQuad:{make:w.prototype.makeFSQuad,destroy:w.prototype.destroyFSQuad,render:w.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function m(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity="undefined"!==typeof m.opacity?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function y(m){this.texture=m.texture?m.texture:null;this.width=m.width?m.width:128;this.height=m.height?m.height:128;
this.x=m.x?m.x:0;this.y=m.y?m.y:0;this.blend=m.blend?m.blend:!1;this.opacity="undefined"!==typeof m.opacity?m.opacity:1;this.tint=m.tint?m.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}m.prototype={addSubview:function(m){this.childViews.push(m);m.superView=this},makePanel:function(m){return this.superView.makePanel(m)}};y.prototype={resize:function(m,r){this.width=m;this.height=r},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(m){m.setInt("srcTex",0);m.addVector("screen");m.addVector("position");m.addVector("tint");m.addVector("size")}})},addSubview:function(m){this.childViews.push(m);m.superView=this},removeSubview:function(m){m=this.childViews.indexOf(m);-1<m&&this.childViews.splice(m,
1)},makePanel:function(m){var r=CubicVR.GLCore.gl,o={};o.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);o.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);o.gl_points=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,o.gl_points);r.bufferData(r.ARRAY_BUFFER,o.vbo_points,r.STATIC_DRAW);o.gl_uvs=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,o.gl_uvs);r.bufferData(r.ARRAY_BUFFER,o.vbo_uvs,r.STATIC_DRAW);m.panel=o},renderPanel:function(m){if(!m.texture)return!1;m.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(m){if(m.texture){var r=CubicVR.GLCore.gl,o=m.offsetLeft,s=m.offsetTop;o||(o=0);s||(s=0);var b=this.shader.shader;b.use();b.setVector("screen",[this.width,this.height,0]);b.setVector("position",[m.x+o,m.y+s,0]);b.setVector("size",[m.width,m.height,0]);b.setVector("tint",m.tint);m.blend&&(r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA));m.texture.use(r.TEXTURE0);r.drawArrays(r.TRIANGLES,0,6);m.blend&&(r.disable(r.BLEND),r.blendFunc(r.ONE,r.ZERO))}},render:function(){var m=
CubicVR.GLCore.gl;m.disable(m.DEPTH_TEST);this.texture&&this.renderView(this);var r=[];this.offsetTop=this.offsetLeft=0;r.push(this);var o=this.shader.shader;o.use();m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_points);m.vertexAttribPointer(o.uniforms.aVertex,3,m.FLOAT,!1,0,0);m.enableVertexAttribArray(o.uniforms.aVertex);m.bindBuffer(m.ARRAY_BUFFER,this.panel.gl_uvs);m.vertexAttribPointer(o.uniforms.aTex,2,m.FLOAT,!1,0,0);m.enableVertexAttribArray(o.uniforms.aTex);
for(m.bindBuffer(m.ELEMENT_ARRAY_BUFFER,null);r.length;){var s=r.pop();this.renderView(s);if(s.childViews.length)for(var b=s.childViews.length-1;0<=b;b--)s.childViews[b].offsetLeft=s.x+s.offsetLeft,s.childViews[b].offsetTop=s.y+s.offsetTop,r.push(s.childViews[b])}m.disableVertexAttribArray(o.uniforms.aTex);m.enable(m.DEPTH_TEST)}};return{Layout:y,View:m}});
CubicVR.RegisterModule("Primitives",function(m){function y(a,c,b,e,g,n){var o=m.mat4,r=m.vec3,s=[],u,x=[0,1,0],w=[1,0,0],z=[0,0,0],y=a.points.length,H,G,J;for(H=u=0;H<f&&u!==b;H+=f/b){w=[Math.cos(H),0,Math.sin(H)];G=0;for(J=c.length;G<J;G++)z=r.add(r.multiply(w,c[G][0]),r.multiply(x,c[G][1])),s[u]===d&&(s[u]=[]),s[u].push(z);u++}J=null;g!==d&&(J=g.getResult!==d?g.getResult():g);for(G=0;G<b;G++){g=0;for(u=c.length;g<u;g++)J?a.addPoint(o.vec3_multiply(s[G][g],J)):a.addPoint(s[G][g])}"string"===typeof e&&
(e=new m.Material(e));a.setFaceMaterial(e);for(g=0;g<b;g++){G=0;for(J=c.length-1;G<J;G++)o=G+c.length*g,s=G+c.length*((g+1)%b),r.equal(a.points[y+o],a.points[y+s])?a.addFace([y+o+1,y+s+1,y+s]):r.equal(a.points[y+o+1],a.points[y+s+1])?a.addFace([y+o,y+o+1,y+s]):a.addFace([y+o,y+o+1,y+s+1,y+s])}n!==d&&(c=null,n.apply!==d?c=n:n&&(c=new m.UVMapper(n)),null!==c&&(a.calcFaceNormals(),c.apply(a,e)))}function w(a,c,b,e,f){var g=m.mat4,c=0.5*c,n=a.points.length;"string"===typeof b&&(b=new m.Material(b));a.setFaceMaterial(b);
e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([g.vec3_multiply([c,-c,0],e),g.vec3_multiply([c,c,0],e),g.vec3_multiply([-c,c,0],e),g.vec3_multiply([-c,-c,0],e)])):a.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);a.addFace([[n+0,n+1,n+2,n+3],[n+3,n+2,n+1,n+0]]);f!==d&&(g=null,f.apply!==d?g=f:f&&(g=new m.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function r(a,c,b,e,f){var g=m.mat4,n,o;"object"===typeof c?(n=c[0]/2,o=c[1]/2,c=c[2]/2):n=o=c/=2;var r=a.points.length;"string"===typeof b&&
(b=new m.Material(b));a.setFaceMaterial(b);e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([g.vec3_multiply([n,-o,c],e),g.vec3_multiply([n,o,c],e),g.vec3_multiply([-n,o,c],e),g.vec3_multiply([-n,-o,c],e),g.vec3_multiply([n,-o,-c],e),g.vec3_multiply([n,o,-c],e),g.vec3_multiply([-n,o,-c],e),g.vec3_multiply([-n,-o,-c],e)])):a.addPoint([[n,-o,c],[n,o,c],[-n,o,c],[-n,-o,c],[n,-o,-c],[n,o,-c],[-n,o,-c],[-n,-o,-c]]);a.addFace([[r+0,r+1,r+2,r+3],[r+7,r+6,r+5,r+4],[r+4,r+5,r+1,r+0],[r+5,r+6,r+2,r+1],[r+
6,r+7,r+3,r+2],[r+7,r+4,r+0,r+3]]);f!==d&&(g=null,f.apply!==d?g=f:f&&(g=new m.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function o(a,c,b,e,d,g,n,o){for(var r=[],b=b-c,c=c+b/2,u=f/d,s=0,w=0;w<=d;w++)r.push([c+Math.cos(s)*b,Math.sin(s)*b,0]),s+=u;m.genLatheObject(a,r,e,g,n,o)}function s(a,c,b,e,d,f,g){m.genLatheObject(a,[[0,-b/2,0],[c/2,-b/2,0],[0,b/2,0]],e,d,f,g)}function b(a,c,b,e,d,f,g){m.genLatheObject(a,[[0,-b/2,0],[c,-b/2,0],[c,b/2,0],[0,b/2,0]],e,d,f,g)}function g(a,c,b,e,d,
f,g){for(var o=[],e=(e/=2)|0,b=b|0,r=Math.PI/e,s=-n,x=0;x<=e;x++)o.push([Math.cos(s)*c,Math.sin(s)*c,0]),s+=r;m.genLatheObject(a,o,b,d,f,g)}function a(a){"string"===typeof a&&(a=m.get(a,m.Material));return a===d?new m.Material:a.use?a:"object"===typeof a?new m.Material(a):new m.Material}function c(a){if(a===d)return d;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?a.getResult():a.position||a.rotation||a.scale?m.mat4.transform(a.position,a.rotation,a.scale):d}function e(a){"string"===
typeof a&&(a=m.get(a));return a===d?d:a.apply?a:"object"===typeof a?new m.UVMapper(a):d}var d=m.undef,f=2*Math.PI,n=Math.PI/2;return{genPlaneObject:w,genBoxObject:r,genLatheObject:y,genTorusObject:o,genConeObject:s,genCylinderObject:b,genSphereObject:g,primitives:{lathe:function(b){var f,g,n,t;if(b.points==d)return null;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);g=a(b.material);n=c(b.transform);t=e(b.uvmapper||b.uv);y(f,b.points,b.divisions!==d?b.divisions:24,g,n,t);return f},box:function(b){var f,
g,n,t;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);g=a(b.material);n=c(b.transform);t=e(b.uvmapper||b.uv);r(f,b.size!==d?b.size:1,g,n,t);return f},plane:function(b){var f,g,n,t;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);g=a(b.material);n=c(b.transform);t=e(b.uvmapper||b.uv);w(f,b.size!==d?b.size:1,g,n,t);return f},sphere:function(b){var f,n,o,t;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);n=a(b.material);o=c(b.transform);t=e(b.uvmapper||b.uv);g(f,b.radius!==d?b.radius:1,b.lon!==
d?b.lon:24,b.lat!==d?b.lat:24,n,o,t);return f},torus:function(b){var f,g,n,t;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);g=a(b.material);n=c(b.transform);t=e(b.uvmapper||b.uv);o(f,b.innerRadius!==d?b.innerRadius:0.75,b.outerRadius!==d?b.outerRadius:1,b.lon!==d?b.lon:24,b.lat!==d?b.lat:24,g,n,t);return f},cone:function(b){var f,g,n,t;f=b.mesh!==d?b.mesh:new m.Mesh(b.name!==d?b.name:d);g=a(b.material);n=c(b.transform);t=e(b.uvmapper||b.uv);s(f,b.base!==d?b.base:1,b.height!==d?b.height:1,b.lon!==
d?b.lon:24,g,n,t);return f},cylinder:function(f){var g,n,o,t;g=f.mesh!==d?f.mesh:new m.Mesh(f.name!==d?f.name:d);n=a(f.material);o=c(f.transform);t=e(f.uvmapper||f.uv);b(g,f.radius!==d?f.radius:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,n,o,t);return g}}}});
CubicVR.RegisterModule("COLLADA",function(m){function y(g,a){function c(a){return!a.color?!1:(a=a.color)?d.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function e(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var d=m.util,f,n,h,q,o,v;v="object"==typeof g?g:-1!=g.indexOf(".js")?d.getJSON(g):m.util.xml2badgerfish(d.getXML(g));var t,D,C,B,y,u,x,E,z,F,H,G,J,L,M,K,N,Y,ca,U,na,Q=v;v=null;if(!Q.COLLADA)throw Error(g+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,O={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var La=Q.asset.up_axis.$;"X_UP"===La?O.up_axis=0:"Y_UP"===La?O.up_axis=1:"Z_UP"===La&&(O.up_axis=2)}var gb=O.up_axis;if(Q.library_images&&(Q.library_images.image&&!Q.library_images.image.length&&(Q.library_images.image=[Q.library_images.image]),Q.library_images.image.length))for(var hb=Q.library_images.image,Ma=0,pb=hb.length;Ma<pb;Ma++){var Na=hb[Ma],ib=Na["@id"],Gc=
Na["@name"],Zb=Na.init_from;if(Zb.$){var ra=Zb.$;a!==w&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));a!==w&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));O.images[ib]={source:ra,id:ib,name:Gc}}}var jb,qb,$b,V,Oa,ka,Pa,da,P,W,S,Da,ga,Qa,Ra,Z,aa;if(Q.library_effects){var Sa=Q.library_effects.effect;Sa&&!Sa.length&&(Sa=[Sa]);qb=0;for($b=Sa.length;qb<$b;qb++){var Cb=Sa[qb];jb=Cb["@id"];var T={};T.id=jb;T.surfaces=[];T.samplers=[];(da=Cb.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da){Y=0;for(ca=da.length;Y<ca;Y++){var sa=da[Y],Ta=sa["@sid"];if(sa.surface){T.surfaces[Ta]={};var ac=sa.surface.init_from.$;"object"===typeof O.images[ac]&&(T.surfaces[Ta].source=a+"/"+O.images[ac].source)}else if(sa.sampler2D&&(T.samplers[Ta]={},T.samplers[Ta].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(T.samplers[Ta].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))T.samplers[Ta].magfiter=sa.sampler2D.magfilter.$}}var va=Cb.profile_COMMON.technique;
va&&!va.length&&(va=[va]);T.material={textures_ref:[]};V=0;for(Oa=va.length;V<Oa;V++){f=va[V].blinn;f||(f=va[V].phong);f||(f=va[V].lambert);if(f)for(var ea in f){var rb=f[ea],ta=c(rb),bc=e(rb),cc=!rb.texture?!1:rb.texture["@texture"];!1!==ta&&3<ta.length&&ta.pop();"emission"==ea?!1!==ta&&(T.material.ambient=ta):"ambient"!=ea&&("diffuse"==ea?!1!==ta&&(T.material.color=ta):"specular"==ea?!1!==ta&&(T.material.specular=ta):"shininess"==ea&&!1!==bc&&(T.material.shininess=bc));if(!1!==cc){var Ua=T.surfaces[T.samplers[cc].source].source;
"emission"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.AMBIENT}):"ambient"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.AMBIENT}):"diffuse"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.COLOR}):"specular"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?T.material.textures_ref.push({image:Ua,type:r.texture.map.REFLECT}):"reflectivity"!=ea&&"transparent"==ea&&T.material.textures_ref.push({image:Ua,
type:r.texture.map.ALPHA}))}}O.effects[jb]=T}}}var Db=b.getAllOf(Q,"instance_geometry"),sb=[];if(Db.length){u=0;for(E=Db.length;u<E;u++){var dc=Db[u],Eb=b.getAllOf(dc,"instance_material");if(Eb.length){U=0;for(na=Eb.length;U<na;U++){var ec=Eb[U],Hc=ec["@symbol"],Ic=ec["@target"].substr(1);sb[dc["@url"].substr(1)+":"+Hc]=Ic}}}}var Fb=Q.library_materials;if(Fb&&Fb.material){var Va=Fb.material;Va&&!Va.length&&(Va=[Va]);F=0;for(H=Va.length;F<H;F++){var Gb=Va[F],Jc=Gb["@id"],Kc=Gb["@name"],fc=Gb.instance_effect;
fc&&(jb=fc["@url"].substr(1),O.materials.push({id:Jc,name:Kc,mat:O.effects[jb].material}))}}var gc=Q.library_geometries,Wa;if(gc){var ua=gc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Lc=ua.length;kb<Lc;kb++){var ma={id:w,points:[],parts:[]},Xa=ua[kb].mesh;if(Xa){Wa=ua[kb]["@id"];o=ua[kb]["@name"];var Ya=Xa.source;Ya&&!Ya.length&&(Ya=[Ya]);for(var R=[],Hb=0,Mc=Ya.length;Hb<Mc;Hb++){var tb=Ya[Hb];n=tb["@id"];var Nc=tb["@name"],Ib=tb.float_array;Ib&&(R[n]={id:n,name:Nc,data:d.floatDelimArray(Ib.$?
Ib.$:""," ")});var Jb=tb.technique_common.accessor;Jb&&(R[n].count=Jb["@count"]|0,R[n].stride=Jb["@stride"]|0,R[n].count&&(R[n].data=d.repackArray(R[n].data,R[n].stride,R[n].count)))}var Kb=Xa.vertices,lb=null,Lb=null,Ea=null,Fa=null,Ga=null;if(Kb&&(Lb=Kb["@id"],(P=Kb.input)&&!P.length&&(P=[P]),P)){ka=0;for(Pa=P.length;ka<Pa;ka++)W=P[ka],"POSITION"===W["@semantic"]&&(lb=W["@source"].substr(1))}var oa=Xa.triangles;oa&&!oa.length&&(oa=[oa]);if(oa){V=0;for(Oa=oa.length;V<Oa;V++){aa={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Oc=parseInt(oa[V]["@count"],10);(P=oa[V].input)&&!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Pa=P.length;ka<Pa;ka++)W=P[ka],Z=parseInt(W["@offset"],10),q=W["@source"].substr(1),"VERTEX"===W["@semantic"]?(q===Lb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,R[Ea].count&&(S[Z]=1)):"TEXCOORD"===W["@semantic"]?(Ga=q,R[Ga].count&&(S[Z]=2)):"COLOR"===W["@semantic"]?(Fa=q,R[Fa].count&&(S[Z]=3)):S[Z]=4}B=S.length;h=Wa+":"+oa[V]["@material"];null===h?aa.material=
0:sb[h]===w?(s("missing material ["+h+"]@"+Wa+"?"),aa.material=0):aa.material=sb[h];var hc=oa[V].p,wa=[];hc&&(wa=d.intDelimArray(hc.$," "));if(wa.length&&(y=wa.length/S.length/3,y===Oc)){0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;E=wa.length;for(z=S.length;u<E;u+=3*z){t=[];D=[];C=[];ha=[];for(U=0;U<3*z;U++){var ub=U%z;0===S[ub]?D.push(wa[u+U]):1===S[ub]?t.push(wa[u+U]):2===S[ub]?C.push(wa[u+U]):3===S[ub]&&ha.push(wa[u+U])}D.length&&(aa.faces.push(D),3===t.length&&aa.normals.push([b.fixuaxis(O.up_axis,
R[Ea].data[t[0]]),b.fixuaxis(O.up_axis,R[Ea].data[t[1]]),b.fixuaxis(O.up_axis,R[Ea].data[t[2]])]),3===C.length&&aa.texcoords.push([R[Ga].data[C[0]],R[Ga].data[C[1]],R[Ga].data[C[2]]]),3===ha.length&&aa.colors.push([R[Fa].data[ha[0]],R[Fa].data[ha[1]],R[Fa].data[ha[2]]]))}}ma.parts.push(aa)}}var ia=Xa.polylist;ia||(ia=Xa.polygons);ia&&!ia.length&&(ia=[ia]);if(ia){V=0;for(Oa=ia.length;V<Oa;V++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var ic=parseInt(ia[V]["@count"],10);(P=ia[V].input)&&
!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Pa=P.length;ka<Pa;ka++){W=P[ka];var Mb=W["@offset"];null===Mb&&(Mb=W["@idx"]);Z=parseInt(Mb,10);q=W["@source"].substr(1);"VERTEX"===W["@semantic"]?(q===Lb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,S[Z]=1):"TEXCOORD"===W["@semantic"]?(Ga=q,S[Z]=2):"COLOR"===W["@semantic"]?(Fa=q,S[Z]=3):S[Z]=4}}var jc=ia[V].vcount,Za=[];jc&&(Za=d.intDelimArray(jc.$," "));h=Wa+":"+ia[V]["@material"];aa.material=h===w?0:sb[h];var mb=ia[V].p;B=S.length;var xa=[];if(1<
mb.length&&!Za.length){Y=0;for(ca=mb.length;Y<ca;Y++){var kc=d.intDelimArray(mb[Y].$," ");Za[Y]=parseInt(kc.length/B,10);xa=xa.concat(kc)}}else mb&&(xa=d.intDelimArray(mb.$," "));if(xa.length)if(y=Za.length,y!==ic)s("poly vcount data doesn't add up, skipping object load: "+y+" !== "+ic);else{0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;for(E=Za.length;u<E;u++){t=[];D=[];C=[];ha=[];U=0;for(na=Za[u]*B;U<na;U++)0===S[U%B]?D.push(xa[Z]):1===S[U%B]?t.push(xa[Z]):2===S[U%B]?C.push(xa[Z]):3===S[U%
B]&&ha.push(xa[Z]),Z++;var $a;if(D.length){aa.faces.push(D);if(t.length){$=[];G=0;for(J=t.length;G<J;G++)$.push(b.fixuaxis(O.up_axis,R[Ea].data[t[G]]));aa.normals.push($)}if(C.length){$a=[];G=0;for(J=C.length;G<J;G++)$a.push(R[Ga].data[C[G]]);aa.texcoords.push($a)}if(ha.length){$a=[];G=0;for(J=ha.length;G<J;G++)$a.push(R[Fa].data[ha[G]]);aa.colors.push($a)}}}}ma.parts.push(aa)}}if(1!==gb){u=0;for(E=ma.points.length;u<E;u++)ma.points[u]=b.fixuaxis(O.up_axis,ma.points[u])}ma.id=Wa;O.meshes.push(ma)}}}var lc=
Q.library_cameras;if(lc){(Qa=lc.camera)&&!Qa.length&&(Qa=[Qa]);L=0;for(M=Qa.length;L<M;L++){ga=Qa[L];var Pc=ga["@id"],vb=0,wb=0,xb=0;ga.optics&&(ga.optics.technique_common&&ga.optics.technique_common.perspective)&&(vb=ga.optics.technique_common.perspective.yfov,wb=ga.optics.technique_common.perspective.znear,xb=ga.optics.technique_common.perspective.zfar);var Nb,Ob,Pb;if(!vb&&!wb&&!xb){(da=ga.param)&&!da.length&&(da=[da]);u=0;for(E=da.length;u<E;u++){var Qb=da[u].$,Rb=da[u]["@name"];"YFOV"==Rb?Nb=
parseFloat(Qb):"ZNEAR"==Rb?Ob=parseFloat(Qb):"ZFAR"==Rb&&(Pb=parseFloat(Qb))}}else Nb=vb?parseFloat(vb.$):60,Ob=wb?parseFloat(wb.$):0.1,Pb=xb?parseFloat(xb.$):1E3;O.cameras.push({id:Pc,targeted:!1,fov:parseFloat(Nb),nearclip:parseFloat(Ob),farclip:parseFloat(Pb)})}}var mc=Q.library_lights,ab;if(mc){var Ha=mc.light;Ha&&!Ha.length&&(Ha=[Ha]);if(Ha)for(var Sb=0,Qc=Ha.length;Sb<Qc;Sb++){ab=Ha[Sb];var nc=ab.technique_common.point,yb=nc?nc:null,oc=ab["@id"];if(null!==yb){var pc=yb.intensity,Rc=pc?parseFloat(pc.$):
1,qc=yb.distance,Sc=qc?parseFloat(qc.$):10,rc=yb.color,ha=[1,1,1];rc&&(ha=d.floatDelimArray(rc.$," "));O.lights.push({id:oc,name:oc,type:r.light.type.POINT,method:r.light.method.STATIC,diffuse:ha,specular:[0,0,0],distance:Sc,intensity:Rc})}}}var sc=Q.library_visual_scenes;if(sc){var bb=null;(bb=sc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Tb=0,Tc=bb.length;Tb<Tc;Tb++){Ra=bb[Tb];var ya={id:Ra["@id"],sceneObjects:[],cameras:[],lights:[],parentMap:[]},pa=[],cb=[],za,Ub,la,ba,$,tc=Q.library_nodes;
if(tc){var db=tc.node;db&&!db.length&&(db=[db]);pa=[];u=0;for(E=db.length;u<E;u++)Ub=db[u],mnodeId=Ub["@id"],pa[la]=Ub;for(za=[Ra];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(E=$.length;u<E;u++)za.push($[u])}if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);u=0;for(E=eb.length;u<E;u++){var Vb=eb[u]["@url"].substr(1);pa[Vb]&&(ba.node&&ba.node.length&&(ba.node=[ba.node]),ba.node?ba.node.push(pa[Vb]):ba.node=[pa[Vb]])}}}}for(za=[Ra];za.length;)if(ba=
za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(E=$.length;u<E;u++)$[u].parentNode=ba,cb.push($[u]),za.push($[u])}if(cb.length)for(var nb=0,Uc=cb.length;nb<Uc;nb++){var Aa=cb[nb],Ba=Aa.instance_geometry;ab=cb[nb].instance_light;ga=cb[nb].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ja=b.cl_getInitalTransform(O.up_axis,Aa);2===gb&&(ja.rotation=b.quaternionFilterZYYZ(ja.rotation,ga?[-90,0,0]:w));var ob=null,X=null,fb;if(Ba){Ba&&!Ba.length&&(Ba=[Ba]);u=0;for(E=Ba.length;u<E;u++)if(o=
Ba[u]["@url"].substr(1),X={},X.name=(fa?fa:la)+(u?u:""),X.id=(la?la:fa)+(u?u:""),X.meshId=Wa,X.meshName=o,ob||(X.position=ja.position,X.rotation=ja.rotation,X.scale=ja.scale,X.matrix=ja.matrix),ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode)(fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:X.id}):1<Ba.length&&(ob?pa[ob.id]&&ya.parentMap.push({parent:ob.id,child:X.id}):(ob=X,X={}))}else if(ga){var Vc=ga["@url"].substr(1);ya.cameras.push({name:fa?fa:la,id:fa?fa:la,source:Vc,position:ja.position,
rotation:ja.rotation})}else if(ab){var Wc=ab["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Wc,position:ja.position})}else X={position:ja.position,rotation:ja.rotation,scale:ja.scale,matrix:ja.matrix},X.name=fa?fa:la,X.id=la?la:fa,ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:X.id})}O.scenes.push(ya)}}var uc=Q.library_animations,qa;if(uc){var Ia=uc.animation;Ia&&!Ia.length&&(Ia=[Ia]);if(Ia)for(var Wb=0,
Xc=Ia.length;Wb<Xc;Wb++){var zb=Ia[Wb];qa=zb["@id"];O.animations[qa]={};O.animations[qa].sources=[];var Ja=zb.source;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja.length){K=0;for(N=Ja.length;K<N;K++){var Ca=Ja[K];n=Ca["@id"];var vc=Ca.technique_common,Ab=null,wc=null;Ca.name_array?Ab=d.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Ab=d.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(wc=d.floatDelimArray(Ca.float_array.$," "));var Xb=0,xc="",Bb=1;if(vc){f=vc;var Yb=f.accessor,Xb=parseInt(Yb["@count"],10),
xc=Yb["@source"].substr(1),yc=Yb["@stride"];yc&&(Bb=parseInt(yc,10))}O.animations[qa].sources[n]={data:Ab?Ab:wc,count:Xb,source:xc,stride:Bb};1!==Bb&&(O.animations[qa].sources[n].data=d.repackArray(O.animations[qa].sources[n].data,Bb,Xb))}}(Da=zb.sampler)&&!Da.length&&(Da=[Da]);if(Da){O.animations[qa].samplers=[];K=0;for(N=Da.length;K<N;K++){var zc=Da[K],Yc=zc["@id"];(P=zc.input)&&!P.length&&(P=[P]);if(P){var Ac=[];x=0;for(E=P.length;x<E;x++)W=P[x],Ac[W["@semantic"]]=W["@source"].substr(1);O.animations[qa].samplers[Yc]=
Ac}}}var Ka=zb.channel;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka){O.animations[qa].channels=[];L=0;for(M=Ka.length;L<M;L++){var Bc=Ka[L],Zc=Bc["@source"].substr(1),Cc=Bc["@target"],Dc=Cc.split("/"),$c=Dc[0],Ec=Dc[1].split(".");O.animations[qa].channels.push({source:Zc,target:Cc,targetName:$c,paramName:Ec[0],typeName:Ec[1]})}}}}var Fc=Q.scene;if(Fc&&(Ra=Fc.instance_visual_scene)){var ad=Ra["@url"].substr(1);O.scene=ad}return O}var w=m.undef,r=m.enums,o=m.GLCore,s=m.log,b={fixuaxis:function(b,a){if(0===b)return[a[1],
a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],-a[1]]},fixscaleaxis:function(b,a){if(0===b)return[a[1],a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],a[1]]},fixukaxis:function(b,a,c,e){return a===r.motion.POS&&c===r.motion.Z&&b===r.motion.Z?-e:e},getAllOf:function(b,a){for(var c=[b],e=[],d,f,n,h;c.length;)for(f in d=c.pop(),d)if(d.hasOwnProperty(f)){if(f===a)if(d[f].length){n=0;for(h=d[f].length;n<h;n++)e.push(d[f][n])}else e.push(d[f]);if("object"==typeof d[f])if(d[f].length){n=0;
for(h=d[f].length;n<h;n++)c.push(d[f][n])}else c.push(d[f])}return e},quaternionFilterZYYZ:function(b,a){var c=m.vec3,e=b,d=new m.Quaternion;a!==w&&(e=c.add(b,a));d.fromEuler(e[0],e[2],-e[1]);return d.toEuler()},cl_getInitalTransform:function(g,a){var c=m.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d=a.translate,f=a.rotate,n=a.scale;if(a.matrix&&!d&&!f&&!n)return e;d&&d.$&&(e.position=b.fixuaxis(g,c.floatDelimArray(d.$," ")));if(f)for(var d=0,h=f.length;d<h;d++){var q=f[d],o=q["@sid"],
q=c.floatDelimArray(q.$," ");if("rotateX"==o||"rotationX"==o)e.rotation[0]=q[3];else if("rotateY"==o||"rotationY"==o)e.rotation[1]=q[3];else if("rotateZ"==o||"rotationZ"==o)e.rotation[2]=q[3]}n&&(e.scale=b.fixscaleaxis(g,c.floatDelimArray(n.$," ")));return e}};return{loadCollada:function(g,a,c){var a=y(g,a,c),e=a.up_axis,d=[],f,n,h,q,s,v,t,D;n=0;for(h=a.materials.length;n<h;n++){s=a.materials[n];t=new m.Material(s.mat);t.name=s.name||null;v=0;for(q=s.mat.textures_ref.length;v<q;v++){D=s.mat.textures_ref[v];
var C=null,C=void 0===m.Textures_ref[D.image]?new m.Texture(D.image,o.default_filter,c,g):m.Textures_obj[m.Textures_ref[D.image]];t.setTexture(C,D.type)}d[s.id]=t}v=[];n=0;for(h=a.meshes.length;n<h;n++){var C=a.meshes[n],B=new m.Mesh({name:C.id});B.points=C.points;var I=!1;t=0;for(D=C.parts.length;t<D;t++){var u=C.parts[t];0!==u.material&&((q=d[u.material])||(q=new m.Material({name:u.material})),B.setFaceMaterial(q));var x=u.normals.length?!0:!1,E=u.texcoords.length?!0:!1,z=u.colors.length?!0:!1;
z&&(d[u.material].color_map=!0);q=0;for(s=u.faces.length;q<s;q++){var F=B.addFace(u.faces[q]);x&&(B.faces[F].point_normals=u.normals[q]);E&&(B.faces[F].uvs=u.texcoords[q]);z&&(B.faces[F].point_colors=u.colors[q])}I|=x}B.faces.length&&(c?c.addMesh(g,g+":"+meshId,B):(I||B.calcNormals(),B.triangulateQuads(),B.compile()),v[C.id]=B)}h=[];g=0;for(q=a.cameras.length;g<q;g++)h[a.cameras[g].id]=a.cameras[g];C=[];q=0;for(s=a.lights.length;q<s;q++)C[a.lights[q].id]=a.lights[q];c={};d={};n={};g={};t=0;for(D=
a.scenes.length;t<D;t++){B=a.scenes[t];I=new m.Scene;q=0;for(s=B.sceneObjects.length;q<s;q++)u=B.sceneObjects[q],x=new m.SceneObject(u),x.obj=(v[u.meshName]?v[u.meshName]:v[u.meshId])||null,u.matrix&&x.setMatrix(u.matrix),c[u.id]=x,I.bindSceneObject(x);q=0;for(s=B.lights.length;q<s;q++)u=B.lights[q],x=new m.Light(C[u.source]),x.position=u.position,d[u.id]=x,I.bindLight(x);B.cameras.length&&(q=B.cameras[0],s=new m.Camera(h[q.source]),s.position=q.position,s.rotation=q.rotation,n[q.id]=s,I.camera=s);
q=0;for(s=B.parentMap.length;q<s;q++)u=B.parentMap[q],c[u.parent].bindChild(c[u.child]);g[B.id]=I}for(var H in a.animations)if(a.animations.hasOwnProperty(H)&&(v=a.animations[H],v.channels.length)){cCount=0;for(q=v.channels.length;cCount<q;cCount++){h=v.channels[cCount];u=v.samplers[h.source];s=v.sources[u.INPUT];t=v.sources[u.OUTPUT];D=v.sources[u.INTERPOLATION];var C=v.sources[u.IN_TANGENT],B=v.sources[u.OUT_TANGENT],I=u.IN_TANGENT!==w,u=u.OUT_TANGENT!==w,x=null,z=c[h.targetName],E=n[h.targetName],
G=d[h.targetName];z?(null===z.motion&&(z.motion=new m.Motion),x=z.motion):E?(null===E.motion&&(E.motion=new m.Motion),x=E.motion):G&&(null===G.motion&&(G.motion=new m.Motion),x=G.motion);if(null!==x){z=r.motion.POS;F=r.motion.X;2===e&&(x.yzflip=!0);f=h.paramName;if("rotateX"===f||"rotationX"===f)z=r.motion.ROT,F=r.motion.X;else if("rotateY"===f||"rotationY"===f)z=r.motion.ROT,F=r.motion.Y;else if("rotateZ"===f||"rotationZ"===f)z=r.motion.ROT,F=r.motion.Z;else if("location"===f){if(z=r.motion.POS,
"X"===h.typeName&&(F=r.motion.X),"Y"===h.typeName&&(F=r.motion.Y),"Z"===h.typeName)F=r.motion.Z}else if("translate"===f){if(z=r.motion.POS,"X"===h.typeName&&(F=r.motion.X),"Y"===h.typeName&&(F=r.motion.Y),"Z"===h.typeName)F=r.motion.Z}else if("LENS"===f)continue;else"FOV"===f?(z=r.motion.FOV,F=3):"ZNEAR"===f?(z=r.motion.NEARCLIP,F=3):"ZFAR"===f?(z=r.motion.FARCLIP,F=3):"intensity"===f&&(z=r.motion.INTENSITY,F=3);G&&3>z&&(G.method=r.light.method.DYNAMIC);mCount=0;for(h=s.data.length;mCount<h;mCount++)if(k=
null,"object"===typeof t.data[mCount]){i=0;for(iMax=t.data[mCount].length;i<iMax;i++)G=i,2===e&&2===i?G=1:2===e&&1===i&&(G=2),k=x.setKey(z,G,s.data[mCount],b.fixukaxis(a.up_axis,z,G,t.data[mCount][i])),D&&(f=D.data[mCount][i],"LINEAR"===f?k.shape=r.envelope.shape.LINE:"BEZIER"===f&&(k.shape=!I&&!u?r.envelope.shape.LINEAR:r.envelope.shape.BEZI))}else if(G=F,ofs=0,E&&z===r.motion.ROT&&2===e&&0===G&&(ofs=-90),z===r.motion.ROT?k=x.setKey(z,G,s.data[mCount],t.data[mCount]+ofs):(2===e&&2===F?G=1:2===e&&
1===F&&(G=2),k=x.setKey(z,G,s.data[mCount],b.fixukaxis(a.up_axis,z,G,t.data[mCount]))),D)if(f=D.data[mCount],"LINEAR"===f)k.shape=r.envelope.shape.LINE;else if("BEZIER"===f)if(!I&&!u)k.shape=r.envelope.shape.LINEAR,k.continutity=1;else{k.shape=r.envelope.shape.BEZ2;f=C.data[mCount][0];var J,L=B.data[mCount][0];z===r.motion.ROT?(J=C.data[mCount][1],G=B.data[mCount][1],k.param[0]=f-k.time,k.param[1]=J-k.value+ofs,k.param[2]=L-k.time,k.param[3]=G-k.value+ofs):(J=b.fixukaxis(a.up_axis,z,G,C.data[mCount][1]),
G=b.fixukaxis(a.up_axis,z,G,B.data[mCount][1]),k.param[0]=f-k.time,k.param[1]=J-k.value,k.param[2]=L-k.time,k.param[3]=G-k.value)}}}}H=null;return H=a.scene?g[a.scene]:g.pop()},parseCollada:y}});
CubicVR.RegisterModule("GML",function(m){function y(m){var o=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==w){var m=o.getXML(m),s=m.getElementsByTagName("header");if(!s.length)return null;var b=s[0],s=m.getElementsByTagName("environment");if(!s.length)return null;this.name=null;b=b.getElementsByTagName("name");b.length&&(this.name=o.collectTextNode(b[0]));b=s[0].getElementsByTagName("screenBounds");b.length&&
(this.bounds=[parseFloat(o.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(b[0].getElementsByTagName("z")[0]))]);b=s[0].getElementsByTagName("origin");b.length&&(this.origin=[parseFloat(o.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(b[0].getElementsByTagName("z")[0]))]);s=s[0].getElementsByTagName("up");
s.length&&(this.upvector=[parseFloat(o.collectTextNode(s[0].getElementsByTagName("x")[0])),parseFloat(o.collectTextNode(s[0].getElementsByTagName("y")[0])),parseFloat(o.collectTextNode(s[0].getElementsByTagName("z")[0]))]);m=m.getElementsByTagName("drawing");s=0;for(b=m.length;s<b;s++)for(var g=m[s].getElementsByTagName("stroke"),a=0,c=0,e=0,d=0,f=0,n=g.length;f<n;f++){for(var h=g[f].getElementsByTagName("pt"),q=h.length,A=Array(q),v,t,D,C=0,B=q;C<B;C++)D=h[C],q=parseFloat(o.collectTextNode(D.getElementsByTagName("x")[0])),
v=parseFloat(o.collectTextNode(D.getElementsByTagName("y")[0])),t=parseFloat(o.collectTextNode(D.getElementsByTagName("z")[0])),D=parseFloat(o.collectTextNode(D.getElementsByTagName("time")[0])),1===this.upvector[0]?A[C]=[v!==v?0:v,q!==q?0:-q,t!==t?0:t,D]:1===this.upvector[1]?A[C]=[q!==q?0:q,v!==v?0:v,t!==t?0:t,D]:1===this.upvector[2]&&(A[C]=[q!==q?0:q,t!==t?0:-t,v!==v?0:v,D]),a<q&&(a=q),c<v&&(c=v),e<t&&(e=t),d<D&&(d=D);if(e>d){h=0;for(C=A.length;h<C;h++)q=A[h][3],A[h][3]=A[h][2],A[h][2]=q/this.bounds[2]}this.strokes[f]=
A}}}var w=m.undef;y.prototype={addStroke:function(m,o){var s=[];o===w&&(o=0.1);for(var b=0,g=m.length;b<g;b++){var a=[m[b][0],m[b][1],m[b][2]];this.manual_pos+=o;a.push(this.manual_pos);s.push(a)}this.strokes.push(s)},recenter:function(){var m=CubicVR.vec3,o=[0,0,0],s=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],b,g,a,c;a=0;for(c=this.strokes.length;a<c;a++){b=0;for(g=this.strokes[a].length;b<g;b++)o[0]>this.strokes[a][b][0]&&(o[0]=this.strokes[a][b][0]),o[1]>this.strokes[a][b][1]&&
(o[1]=this.strokes[a][b][1]),o[2]>this.strokes[a][b][2]&&(o[2]=this.strokes[a][b][2]),s[0]<this.strokes[a][b][0]&&(s[0]=this.strokes[a][b][0]),s[1]<this.strokes[a][b][1]&&(s[1]=this.strokes[a][b][1]),s[2]<this.strokes[a][b][2]&&(s[2]=this.strokes[a][b][2])}m=m.multiply(m.subtract(s,o),0.5);a=0;for(c=this.strokes.length;a<c;a++){b=0;for(g=this.strokes[a].length;b<g;b++)this.strokes[a][b][0]-=m[0],this.strokes[a][b][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[a][b][2]-=m[2]}},generateObject:function(m,
o,s,b,g){var a=CubicVR.vec3;m===w&&(m=0);o===w&&(o=0);g===w&&(g=!1);b===w&&(b=0.02);s===w&&(s=0.015);for(var c=0!==o,e=0,d=0,f=new CubicVR.Mesh(this.name),n,h,q,A,v,t,D=0,C=this.strokes.length;D<C;D++){t=new CubicVR.Envelope;var B=new CubicVR.Envelope,y=new CubicVR.Envelope,u=this.strokes[D].length,x=[],E=[],z=0,F=this.strokes[D];for(v=0;v<u;v++){var H=F[v],G=t.addKey(H[3],H[0]),J=B.addKey(H[3],H[1]),L;L=g?y.addKey(H[3],H[2]):y.addKey(H[3],0);G.tension=0.5;J.tension=0.5;L.tension=0.5;0!==v?(n=H[0]-
n,h=H[1]-h,q=H[2]-q,A=H[3]-A,q=Math.sqrt(n*n+h*h+q*q),x[v-1]=q,E[v-1]=A):z=H[3];n=H[0];h=H[1];q=H[2];A=H[3]}u=f.points.length;for(v=0;v<x.length;v++){F=E[v];J=Math.ceil(3*(x[v]/b));H=z;G=z+F;for(J=F/J;H<G-J;H+=J){H===z&&(n=t.evaluate(H),h=B.evaluate(H),q=y.evaluate(H));var M,K;L=t.evaluate(H+J);M=B.evaluate(H+J);K=y.evaluate(H+J);var N=L-n,Y=M-h,ca=K-q;Math.sqrt(N*N+Y*Y+ca*ca);N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([N,Y,ca]))),s/2);f.addPoint([n-N[0],-(h-N[1]),q-N[2]+(c?o/2:
0)]);f.addPoint([n+N[0],-(h+N[1]),q+N[2]+(c?o/2:0)]);n=L;h=M;q=K}z+=F}B=f.points.length;if(c){v=u;for(t=B;v<t;v++)f.addPoint([f.points[v][0],f.points[v][1],f.points[v][2]-(c?o/2:0)])}v=0;for(t=B-u;v<=t-4;v+=2){0===e%m&&d++;f.setSegment(d);y=[u+v,u+v+1,u+v+3,u+v+2];f.addFace(y);if(c&&(y=[y[3]+B-u,y[2]+B-u,y[1]+B-u,y[0]+B-u],f.addFace(y),y=[u+v,u+v+2,u+v+2+B-u,u+v+B-u],f.addFace(y),y=[u+v+1+B-u,u+v+3+B-u,u+v+3,u+v+1],f.addFace(y),0===v&&(y=[u+v+B-u,u+v+1+B-u,u+v+1,u+v],f.addFace(y)),v===t-4))y=[u+v+
2,u+v+3,u+v+3+B-u,u+v+2+B-u],f.addFace(y);e++}}f.calcFaceNormals();f.triangulateQuads();f.calcNormals();f.compile();return f}};return{GML:y}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(m){if(!m.src)throw"PDF Error: you must specify a src url for a PDF.";var y=m.src,w=m.callback||function(){},r,o=[],s=[];this.__defineGetter__("pages",function(){return r?r.numPages:0});this.getPage=function(b){var g=r.numPages,b=1>b?1:b;return o[(b>g?g:b)-1]};this.getPageTexture=function(b,g,a){b=this.getPage(b);g=g||b.width;a=a||b.height;return new CubicVR.PdfTexture(b,{width:g,height:a})};getPdf({url:y,error:function(){console.log("PDF Error: error loading pdf `"+
y+"`")}},function(b){r=new PDFDoc(b);for(var b=1,g=r.numPages;b<=g;b++){var a=r.getPage(b);o.push(a);s.push(a)}w()})}}});
CubicVR.RegisterModule("Particles",function(m){function y(o,m,b,g,a,c,e){o&&(this.last_particle=this.particles=null,this.pTex=b!==w?b:null,this.vWidth=g,this.vHeight=a,this.alpha=c!==w?c:!1,this.alphaCut=e!==w?e:0,this.pfunc=function(a,c){var b=c-a.start_time;if(0>b)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];null!==this.pgov&&this.pgov(a,
c);return 1},this.pgov=null,this.hasColor=m===w?!1:m,b=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",b?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",b?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",b?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",b?"uniform sampler2D pMap;":"","varying vec4 color;",b?"varying vec2 screenPos;":"",b?"uniform vec3 screenDim;":"",b?"varying float pSize;":"","void main(void) {\nvec4 c = color;",b?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",b?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",b?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=o,this.numParticles=0,this.arPoints=new Float32Array(3*o),this.glPoints=null,m&&(this.arColor=new Float32Array(3*o),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition"),
this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0])),this.genBuffer())}var w=m.undef,r=m.GLCore;y.prototype={resizeView:function(o,m){this.vWidth=o;this.vHeight=m;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[o,m,0]))},addParticle:function(o){null===this.last_particle?this.particles=o:this.last_particle.nextParticle=o;this.last_particle=o},genBuffer:function(){var o=r.gl;this.glPoints=o.createBuffer();o.bindBuffer(o.ARRAY_BUFFER,this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW);this.hasColor&&(this.glColor=o.createBuffer(),o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},updatePoints:function(){var o=r.gl;o.bindBuffer(o.ARRAY_BUFFER,
this.glPoints);o.bufferData(o.ARRAY_BUFFER,this.arPoints,o.DYNAMIC_DRAW)},updateColors:function(){var o=r.gl;this.hasColor&&(o.bindBuffer(o.ARRAY_BUFFER,this.glColor),o.bufferData(o.ARRAY_BUFFER,this.arColor,o.DYNAMIC_DRAW))},draw:function(o,m,b){var g=r.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",o);this.shader_particle.setMatrix("uPMatrix",m);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(b!==w){this.numParticles=0;if(null===this.particles){g.disable(g.BLEND);return}for(var o=this.particles,m=null,a=0;null!==o;){var c=3*this.numParticles,
e=this.pfunc(o,b);if(1===e){if(this.arPoints[c]=o.pos[0],this.arPoints[c+1]=o.pos[1],this.arPoints[c+2]=o.pos[2],null!==o.color&&this.arColor!==w&&(this.arColor[c]=o.color[0],this.arColor[c+1]=o.color[1],this.arColor[c+2]=o.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else-1===e?null!==m&&(m.nextParticle=o.nextParticle):0===e&&a++;m=o;o=o.nextParticle}a||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(g.enable(g.BLEND),
g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:y,Particle:function(o,m,b,g,a){this.startpos=new Float32Array(o);this.pos=new Float32Array(o);this.velocity=new Float32Array(g!==w?g:[0,0,0]);this.accel=new Float32Array(a!==w?a:[0,0,0]);this.start_time=
m!==w?m:0;this.life_time=b!==w?b:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("HeightField",function(m){var y=m.undef,w=m.enums;w.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var r=function(b){b=b||{};this.operation=m.parseEnum(w.draw.op,b.operation||b.op)||w.draw.op.REPLACE;this.brushType=m.parseEnum(w.draw.brush,b.brushType)||w.draw.brush.SINE;this.brushSize=b.size||5;this.strength=b.strength||1};r.prototype={setOperation:function(b){this.operation=m.parseEnum(w.draw.op,b)},getOperation:function(){return this.operation},setBrushType:function(b){this.brushType=
m.parseEnum(w.draw.brush,b)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(b){this.brushSize=b},getSize:function(){return this.brushSize},setStrength:function(b){this.strength=b},getStrength:function(){return this.strength}};var o=function(b){b=b||{};this.divX=b.divX||null;this.divZ=b.divZ||null;this.size=b.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,
this.divZ,this.size)};o.prototype={initBuffer:function(b,g,a){this.hfBuffer=new ArrayBuffer(4*b*g);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=b||null;this.divZ=g||null;this.size=a||null;this.divX>this.divZ?(this.sizeX=a,this.sizeZ=a/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?a/this.divZ*this.divX:a,this.sizeZ=a);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX},setBrush:function(b){this.brush=b},getBrush:function(){return this.brush},
draw:function(b,g,a){var c=this.brush||a,a=c.getOperation(),e=c.getSize(),d=c.getBrushType(),c=c.getStrength();this.drawBuffer.push([b,g,a,e,d,c])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var b=this.drawBuffer.pop();this.drawFunc(b[0],b[1],b[2],b[3],b[4],b[5])}return!0},needsFlush:function(){return 0!==this.drawBuffer.length},drawFunc:function(b,g,a,c,e,d){for(var a=this.hfFloatBuffer,e=this.divX,f=this.divZ,c=c/this.cellSize,n=this.sizeZ/2-this.sizeZ/this.divZ/
2,b=b+(this.sizeX/2-this.sizeX/this.divX/2),b=b/this.cellSize,g=(g+n)/this.cellSize,n=parseInt(Math.floor(b-c),10),h=parseInt(Math.ceil(b+c),10);n<h;n++)for(var q=n-b,o=parseInt(Math.floor(g-c),10),m=parseInt(Math.ceil(g+c),10);o<m;o++)if(!(0>=n||n>=e||0>=o||o>=f)){var t=o-g,t=d*((1-Math.sqrt(q*q+t*t)/c)/2);0>t&&0<=d&&(t=0);0<t&&0>=d&&(t=0);a[o*e+n]+=t}},getUint8Buffer:function(){return this.hfUInt8Buffer},getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},
getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(b){var b=b||{},g=b.value||0,a=b.src||b.func||null,c=b.startX||0,e=b.startZ||0,d=b.walkX,f=b.walkZ,b=this.hfFloatBuffer,n,h=this.sizeX/2-this.sizeX/this.divX/2,q=this.sizeZ/2-this.sizeZ/this.divZ/2;if(c!==y&&e!==y&&d!==y&&f!==y){if(!(c>=this.divX)&&!(e>=this.divZ)&&(c+d>=this.divX&&(d=this.divX-
1-c),e+f>=this.divZ&&(f=this.divZ-1-e),!(0>=d||0>=f))){n=c;for(c+=d;n<c;n++)for(var d=e,o=e+f;d<o;d++){var m=n+d*this.divX;b[m]=null===a?g:a(this.cellSize*n-h,this.cellSize*d-q,m)}}}else{n=0;for(c=this.hfFloatBuffer.length;n<c;n++)null===a?b[n]=g:(e=a(n%this.divX*this.cellSize-h,Math.floor(n/this.divX)*this.cellSize-q,n),b[n]=e)}},getIndicesAt:function(b,g){if("object"===typeof b)return this.getFaceAt(b[0],b[2]);var a=this.sizeX/2-this.sizeX/this.divX/2,c=this.sizeZ/2-this.sizeZ/this.divZ/2,e=parseInt(Math.floor((b+
a)/this.sizeX*this.divX),10),d=parseInt(Math.floor((g+c)/this.sizeZ*this.divZ),10);if(0>e||e>=this.divX-1||0>d||d>=this.divZ-1)return-1;if(1<=Math.abs(g-c-(e*this.cellSize-c))/Math.abs(b-a-(d*this.cellSize-c)))return a=[e+(d+1)*this.divX,e+1+d*this.divX,e+d*this.divX],[e,d,a,0];a=[e+(d+1)*this.divX,e+1+(d+1)*this.divX,e+1+d*this.divX];return[e,d,a,1]},getHeightValue:function(b,g){var a=m.triangle;if("object"===typeof b)return this.getHeightValue(b[0],b[2]);var c=this.getIndicesAt(b,g);if(-1===c)return 0;
var e=c[2],d=c[0]*this.cellSize-(this.sizeX/2-this.sizeX/this.divX/2),f=c[1]*this.cellSize-(this.sizeZ/2-this.sizeZ/this.divZ/2),n;n=0===c[3]?a.normal([d,this.hfFloatBuffer[e[0]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[1]],f],[d,this.hfFloatBuffer[e[2]],f]):a.normal([d,this.hfFloatBuffer[e[0]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[1]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[2]],f]);a=n[0];c=n[1];n=n[2];e=[d,this.hfFloatBuffer[e[0]],f+this.cellSize];return(a*
b+n*g+(-(a*e[0])-c*e[1]-n*e[2]))/-c}};var s=m.extendClassGeneral(m.Mesh,function(b){b=b||{};b.dynamic=!0;b.buildWireframe=!0;this.material=b.material;this._update=m.Mesh.prototype.update;m.Mesh.apply(this,[b]);this.hField=b.hField||null;this.divX=b.divX||null;this.divZ=b.divZ||null;this.viewX=b.viewX||0;this.viewZ=b.viewZ||0;this.ofsX=b.ofsX||0;this.ofsZ=b.ofsZ||0;this.genHeightfieldMesh()},{setIndexedHeight:function(b,g,a){this.points[b+g*this.divX][1]=a},genHeightfieldMesh:function(){var b,g,a=
this.divX,c=this.divZ;b=this.hField.getCellSize();var e=b*this.divX,d=b*this.divZ;0!==this.points.length&&this.clean();for(g=-(d/2);g<d/2;g+=d/c)for(b=-(e/2);b<e/2;b+=e/a)this.addPoint([b+e/a/2+this.ofsX,0,g+d/c/2+this.ofsZ]);this.setFaceMaterial(this.material);for(b=0;b<c-1;b++)for(e=0;e<a-1;e++)this.addFace([e+(b+1)*a,e+1+b*a,e+b*a]),this.addFace([e+(b+1)*a,e+1+(b+1)*a,e+1+b*a])},update:function(){var b=this.viewX||0,g=this.viewZ||0,a=this.divX,c=this.divZ,e=this.hField.getDivX();this.hField.getDivZ();
for(var d=this.hField.getFloat32Buffer(),f=g,c=g+c;f<c;f++)for(var n=b,h=b+a;n<h;n++)this.points[(f-g)*a+(n-b)][1]=d[f*e+n];this._update()}});return{HeightField:o,HeightFieldBrush:r,HeightFieldMesh:s}});
CubicVR.RegisterModule("Landscape",function(m){var y=m.undef,w=Math.PI/2;return{Landscape:m.extendClassGeneral(m.SceneObject,function(r,o,s,b){this.hField=new m.HeightField({size:r,divX:o,divZ:s});this.hfMesh=new m.HeightFieldMesh({hField:this.hField,size:r,divX:o,divZ:s,material:b});this.hfMesh.prepare();m.SceneObject.apply(this,[{mesh:this.hfMesh,shadowCast:!1}])},{getHeightField:function(){return this.hField},mapGen:function(m,o,s,b,g){this.hField.setRect({src:m,startX:o,startZ:s,walkX:b,walkZ:g});
this.hfMesh.update()},getFaceAt:function(m,o){return this.hField.getFaceAt([m,0,o])},getHeightValue:function(m,o){return this.hField.getHeightValue([m,0,o])},orient:function(m,o,s,b,g,a){a===y&&(a=0);var c,e,d=[];c=s/2;var f=b/2;e=Math.sqrt(f*f+c*c);f=Math.atan2(f,c);g*=Math.PI/180;c=m+Math.sin(g)*a;a=o+Math.cos(g)*a;d[0]=this.getHeightValue([c+e*Math.cos(-f-w+g),0,a+e*-Math.sin(-f-w+g)]);d[1]=this.getHeightValue([c+e*Math.cos(f-w+g),0,a+e*-Math.sin(f-w+g)]);d[2]=this.getHeightValue([c+e*Math.cos(-f+
w+g),0,a+e*-Math.sin(-f+w+g)]);d[3]=this.getHeightValue([c+e*Math.cos(f+w+g),0,a+e*-Math.sin(f+w+g)]);e=-Math.atan2(d[1]-d[2],s);a=-Math.atan2(d[0]-d[1],b);e+=-Math.atan2(d[0]-d[3],s);a+=-Math.atan2(d[3]-d[2],b);return[[m,(d[2]+d[3]+d[1]+d[0])/4,o],[e/2*(180/Math.PI),g,a/2*(180/Math.PI)]]}})}});
CubicVR.RegisterModule("SpatMaterial",function(m){var y=m.undef,w;return{SpatMaterial:m.extendClassGeneral(m.Material,function(r){r=r||{};w||(w=new m.Texture);this.spats=r.spats||[w,w,w,w,w];this.sourceTex=r.sourceTexture||w;var o=this.spats,s=this.sourceTex,b;for(b in o){var g=o[b];"string"===typeof g&&(o[b]=m.Textures_ref[g]!==y?m.Textures_obj[m.Textures_ref[g]]:new m.Texture(g))}this.spatShader=new m.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",
fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec4 spatSource = texture2D(spatImage,texCoord);\nvec2 spatTexCoord = texCoord*10.0;\nvec4 color = texture2D(spat0,spatTexCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(a,c){var b=c.textureIndex;a.spatImage.set(b++,s);o[0]&&a.spat0.set(b++,o[0]);o[1]&&a.spat1.set(b++,o[1]);o[2]&&a.spat2.set(b++,o[2]);o[3]&&a.spat3.set(b++,o[3]);o[4]&&a.spat4.set(b++,o[4])}});r.shader=this.spatShader;m.Material.apply(this,[r])},{setSpats:function(m){this.spats=m},getSpats:function(){return this.spats},setSource:function(){}})}});
CubicVR.RegisterModule("Octree",function(m){function y(a,b,d,f,g){var h=this._children=[];this._dirty=!1;h[0]=null;h[1]=null;h[2]=null;h[3]=null;h[4]=null;h[5]=null;h[6]=null;h[7]=null;this._child_index=g||-1;this._root=d||null;this._max_depth=b||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];d=m.aabb;d.reset(b,f);a/=2;d.engulf(b,[f[0]+a,f[1]+
a,f[2]+a]);d.engulf(b,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function w(){this.position=[0,0,0];this.visible=!1;this._object=null}function r(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var o=m.undef,s=m.plane,b=m.sphere,g=m.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,b,d){d=a.slice((d||b)+1||a.length);
a.length=0>b?a.length+b:b;return a.push.apply(a,d)};y.prototype.destroy=function(){var a,b,d;a=0;for(b=this._static_lights.length;a<b;++a)d=this._static_lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)d=this._lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].destroy();a=0;for(b=this._nodes.length;a<
b;++a)d=this._nodes[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null,d.dynamic_lights=[],d.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};y.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};y.prototype.remove=function(c){var b=!1,d=this._nodes.length,f;f=d-1;for(d=this._nodes.length;0<=f;--f)if(c===this._nodes[f]){a(this._nodes,f);this.dirty_lineage();b=!0;break}if(!b)for(f=d-1;0<=f;--f)if(c===this._lights[f]){a(this._lights,f);this.dirty_lineage();break}};y.prototype.dirty_lineage=function(){this._dirty=!0;null!==this._root&&
this._root.dirty_lineage()};y.prototype.cleanup=function(){for(var a=this._children.length,b=0,d=0;d<a;++d){var f=this._children[d];if(null!==f){var g=!0;!0===f._dirty&&(g=f.cleanup());g?++b:this._children[d]=null}}return 0===this._nodes.length&&(0===this._static_lights.length&&0===this._lights.length)&&(0===b||0===a)?!1:!0};y.prototype.insert_light=function(a){this.insert(a,!0)};y.prototype.propagate_static_light=function(a){var b,d;b=0;for(d=this._nodes.length;b<d;++b)-1===this._nodes[b].static_lights.indexOf(a)&&
this._nodes[b].static_lights.push(a);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].propagate_static_light(a)};y.prototype.collect_static_lights=function(a){var b,d;b=0;for(d=this._static_lights.length;b<d;++b)-1===a.static_lights.indexOf(this._static_lights[b])&&a.static_lights.push(this._static_lights[b]);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].collect_static_lights(a)};y.prototype.insert=function(a,b){function d(a,c,b,e){var d,f;if(b)if(c.method===g.light.method.STATIC){-1===
a._static_lights.indexOf(c)&&a._static_lights.push(c);b=0;for(d=a._nodes.length;b<d;++b)-1===a._nodes[b].static_lights.indexOf(c)&&a._nodes[b].static_lights.push(c);for(f=a._root;null!==f;){b=0;for(l=f._nodes.length;b<l;++b)d=f._nodes[b],-1===d.static_lights.indexOf(c)&&d.static_lights.push(c);f=f._root}}else-1===a._lights.indexOf(c)&&a._lights.push(c);else{a._nodes.push(c);b=0;for(d=a._static_lights.length;b<d;++b)-1===c.static_lights.indexOf(a._static_lights[b])&&c.static_lights.push(a._static_lights[b]);
for(f=a._root;null!==f;){b=0;for(d=f._static_lights.length;b<d;++b){var n=f._static_lights[b];-1===c.static_lights.indexOf(n)&&c.static_lights.push(n)}f=f._root}}c.octree_leaves.push(a);c.octree_common_root=e;e=m.aabb;e.engulf(c.octree_aabb,a._bbox[0]);e.engulf(c.octree_aabb,a._bbox[1])}b===o&&(b=!1);null===this._root&&(a.octree_leaves=[],a.octree_common_root=null);if(0===this._max_depth)d(this,a,b,this._root);else{var f=this._position,n,h,q,r,v,t,s;h=a.getAABB();s=[h[0][0],h[0][1],h[0][2]];var C=
[h[1][0],h[1][1],h[1][2]];n=s[0]<f[0]&&s[1]<f[1]&&s[2]<f[2];h=C[0]>f[0]&&s[1]<f[1]&&s[2]<f[2];v=s[0]<f[0]&&C[1]>f[1]&&s[2]<f[2];t=C[0]>f[0]&&C[1]>f[1]&&s[2]<f[2];q=s[0]<f[0]&&s[1]<f[1]&&C[2]>f[2];r=C[0]>f[0]&&s[1]<f[1]&&C[2]>f[2];s=s[0]<f[0]&&C[1]>f[1]&&C[2]>f[2];f=C[0]>f[0]&&C[1]>f[1]&&C[2]>f[2];if(n&&h&&v&&t&&q&&r&&s&&f)d(this,a,b,this),b?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var C=0,B=this._static_lights.length;C<B;++C)a.static_lights===
o&&(a.static_lights=[]),-1===a.static_lights.indexOf(this._static_lights[C])&&a.static_lights.push(this._static_lights[C]);var C=this._size/2,B=this._size/4,w=0,u=this._position[0],x=this._position[1],E=this._position[2];n&&(n=[u-B,x-B,E-B],null===this._children[g.octree.TOP_NW]&&(this._children[g.octree.TOP_NW]=new y(C,this._max_depth-1,this,n,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,b),++w);h&&(n=[u+B,x-B,E-B],null===this._children[g.octree.TOP_NE]&&(this._children[g.octree.TOP_NE]=
new y(C,this._max_depth-1,this,n,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,b),++w);v&&(n=[u-B,x+B,E-B],null===this._children[g.octree.BOTTOM_NW]&&(this._children[g.octree.BOTTOM_NW]=new y(C,this._max_depth-1,this,n,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,b),++w);t&&(n=[u+B,x+B,E-B],null===this._children[g.octree.BOTTOM_NE]&&(this._children[g.octree.BOTTOM_NE]=new y(C,this._max_depth-1,this,n,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,
b),++w);q&&(n=[u-B,x-B,E+B],null===this._children[g.octree.TOP_SW]&&(this._children[g.octree.TOP_SW]=new y(C,this._max_depth-1,this,n,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,b),++w);r&&(n=[u+B,x-B,E+B],null===this._children[g.octree.TOP_SE]&&(this._children[g.octree.TOP_SE]=new y(C,this._max_depth-1,this,n,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,b),++w);s&&(n=[u-B,x+B,E+B],null===this._children[g.octree.BOTTOM_SW]&&(this._children[g.octree.BOTTOM_SW]=new y(C,
this._max_depth-1,this,n,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,b),++w);f&&(n=[u+B,x+B,E+B],null===this._children[g.octree.BOTTOM_SE]&&(this._children[g.octree.BOTTOM_SE]=new y(C,this._max_depth-1,this,n,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,b),++w);if(1<w||null===a.octree_common_root)a.octree_common_root=this}}};y.prototype.draw_on_map=function(a,b,d){function f(a,c,d,f,m){var q=a<d?a:d,t=c<f?c:f,a=a<d?d-a:a-d,c=c<f?f-c:c-f;b.save();void 0!==m&&
(b.fillStyle=m,b.fillRect(g+q,h+t,a,c));b.strokeRect(g+q,h+t,a,c);b.restore()}var g=a.width/2,h=a.height/2,q,m,r,t,s,C,B;if(d===o||"map"===d)b.save(),!1!==this._debug_visible?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),s=this._size/2,q=this._position[0],m=this._position[2],b.moveTo(g+q-s,g+m-s),b.lineTo(g+q-s,g+m+s),b.lineTo(g+q+s,g+m+s),b.lineTo(g+q+s,g+m-s),b.stroke(),b.fill(),b.restore();if(d===o||"objects"===d){b.save();
s=0;for(B=this._nodes.length;s<B;++s)C=this._nodes[s],b.fillStyle="#5500FF",b.strokeStyle=!0===C.visible&&!1===C.culled?"#FFFFFF":"#000000",b.beginPath(),q=C.aabb[0][0],m=C.aabb[0][2],r=C.aabb[1][0]-q,t=C.aabb[1][2]-m,b.rect(g+q,h+m,r,t),b.stroke();b.restore()}if(d===o||"lights"===d){s=0;for(B=this._lights.length;s<B;++s)t=this._lights[s],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),C=t.distance,q=t.position[0],
m=t.position[2],b.arc(g+q,h+m,C,0,2*Math.PI,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),q=t.aabb[0][0],m=t.aabb[0][2],r=t.aabb[1][0]-q,t=t.aabb[1][2]-m,b.rect(g+q,h+m,r,t),b.closePath(),b.stroke();s=0;for(B=this._static_lights.length;s<B;++s)t=this._static_lights[s],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),C=t.distance,q=t.position[0],m=t.position[2],b.arc(g+q,h+m,C,0,2*Math.PI,!0),b.closePath(),
b.stroke(),b.fill(),b.beginPath(),q=t.aabb[0][0],m=t.aabb[0][2],r=t.aabb[1][0]-q,t=t.aabb[1][2]-m,b.rect(g+q,h+m,r,t),b.closePath(),b.stroke()}if("lights"!=d&&"objects"!=d&&"map"!=d){b.save();q=this._nodes;s=0;for(t=q.length;s<t;++s)if(C=q[s],C.name==d){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();q=C.aabb[0][0];m=C.aabb[0][2];r=C.aabb[1][0]-q;t=C.aabb[1][2]-m;b.rect(g+q,h+m,r,t);b.closePath();b.stroke();q=C.octree_aabb;b.strokeStyle="#0000FF";f(q[0][0],q[0][2],q[1][0],q[1][2]);b.lineWidth=
1;null!==C.common_root&&(b.strokeStyle="#00FF00");break}b.lineWidth=1;b.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}s=0;for(B=this._children.length;s<B;++s)null!==this._children[s]&&this._children[s].draw_on_map(a,b,d)};y.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};y.prototype.get_frustum_hits=function(a,e){var d={objects:[],lights:[]};if((e===o||!0===e)&&!this.contains_point(a.position)){if(!1===b.intersects(a.frustum.sphere,this._sphere))return d;var f=a.frustum.contains_sphere(this._sphere);if(-1===f)return this._debug_visible=!1,d;if(1===f)this._debug_visible=2,e=!1;else if(0===f){this._debug_visible=!0;f=a.frustum.contains_box(this._bbox);if(-1===f)return this._debug_visible=!1,d;1===
f&&(this._debug_visible=3,e=!1)}}var g,h,f=0;for(g=this._nodes.length;f<g;++f)h=this._nodes[f],d.objects.push(h),h.dynamic_lights=[].concat(this._lights),h.was_culled=h.culled,h.culled=!1,h.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;f=0;for(g=this._lights.length;f<g;++f)h=this._lights[f],!0===h.visible&&(d.lights.push(h),h.was_culled=h.culled,h.culled=!1);f=0;for(g=this._static_lights.length;f<g;++f)h=this._static_lights[f],!0===h.visible&&(h.culled=!1);for(f=
0;8>f;++f)if(null!==this._children[f]){g=this._children[f].get_frustum_hits(a,e);var m;h=0;for(m=g.objects.length;h<m;++h){d.objects.push(g.objects[h]);for(var r=g.objects[h].dynamic_lights,s=0,t=this._lights.length;s<t;++s)0>r.indexOf(this._lights[s])&&r.push(this._lights[s])}h=0;for(m=g.lights.length;h<m;++h)0>d.lights.indexOf(g.lights[h])&&d.lights.push(g.lights[h])}return d};y.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=
!0;a=0;for(b=this._lights.length;a<b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};w.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};w.prototype.attach=function(a){this._object=a};r.prototype.extract=function(a,b,d){var f=m.mat4,n=m.vec3;if(!(b===o||d===o)){f=f.multiply(d,b);b=this._planes;b[g.frustum.plane.LEFT][0]=
f[3]+f[0];b[g.frustum.plane.LEFT][1]=f[7]+f[4];b[g.frustum.plane.LEFT][2]=f[11]+f[8];b[g.frustum.plane.LEFT][3]=f[15]+f[12];b[g.frustum.plane.RIGHT][0]=f[3]-f[0];b[g.frustum.plane.RIGHT][1]=f[7]-f[4];b[g.frustum.plane.RIGHT][2]=f[11]-f[8];b[g.frustum.plane.RIGHT][3]=f[15]-f[12];b[g.frustum.plane.TOP][0]=f[3]-f[1];b[g.frustum.plane.TOP][1]=f[7]-f[5];b[g.frustum.plane.TOP][2]=f[11]-f[9];b[g.frustum.plane.TOP][3]=f[15]-f[13];b[g.frustum.plane.BOTTOM][0]=f[3]+f[1];b[g.frustum.plane.BOTTOM][1]=f[7]+f[5];
b[g.frustum.plane.BOTTOM][2]=f[11]+f[9];b[g.frustum.plane.BOTTOM][3]=f[15]+f[13];b[g.frustum.plane.NEAR][0]=f[3]+f[2];b[g.frustum.plane.NEAR][1]=f[7]+f[6];b[g.frustum.plane.NEAR][2]=f[11]+f[10];b[g.frustum.plane.NEAR][3]=f[15]+f[14];b[g.frustum.plane.FAR][0]=f[3]-f[2];b[g.frustum.plane.FAR][1]=f[7]-f[6];b[g.frustum.plane.FAR][2]=f[11]-f[10];b[g.frustum.plane.FAR][3]=f[15]-f[14];for(var h=0;6>h;++h)s.normalize(b[h]);h=-b[g.frustum.plane.NEAR][3];b=b[g.frustum.plane.FAR][3]-h;d=b*(1/d[5]);d=n.subtract([0,
0,h+0.5*b],[d,d,h+b]);d=n.length(d);f=[f[3],f[9],f[10]];h=n.length(f);f=n.multiply(f,1/h);a=[a.position[0],a.position[1],a.position[2]];a=n.add(a,n.multiply(f,0.5*b));a=n.add(a,n.multiply(f,1));this.sphere=[a[0],a[1],a[2],d]}};r.prototype.contains_sphere=function(a){for(var b=m.vec3,d=this._planes,f=0;6>f;++f){var g=d[f],g=b.dot([g[0],g[1],g[2]],[a[0],a[1],a[2]])+g.d;this.last_in[f]=1;if(g<-a[3])return-1;if(Math.abs(g)<a[3])return 0}return 1};r.prototype.draw_on_map=function(a,b){var d=a.width/2,
f=a.height/2;b.save();for(var g=this._planes,h=[0,1,4,5],m=0,o=h.length;m<o;++m){var r=g[h[m]];b.strokeStyle="#FF00FF";m<this.last_in.length&&this.last_in[m]&&(b.strokeStyle="#FFFF00");var t=-d,s=d,C=(-r[3]-r[0]*s)/r[2];b.moveTo(d+t,f+(-r[3]-r[0]*t)/r[2]);b.lineTo(d+s,f+C);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(d+this.sphere[0],f+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);b.closePath();b.stroke();b.restore()};r.prototype.contains_box=function(a){var b=0,d=[];d[0]=a[0];d[1]=[a[0][0],
a[0][1],a[1][2]];d[2]=[a[0][0],a[1][1],a[0][2]];d[3]=[a[0][0],a[1][1],a[1][2]];d[4]=[a[1][0],a[0][1],a[0][2]];d[5]=[a[1][0],a[0][1],a[1][2]];d[6]=[a[1][0],a[1][1],a[0][2]];d[7]=a[1];for(var a=this._planes,f=0;6>f;++f){for(var g=8,h=1,m=0;8>m;++m)-1===s.classifyPoint(a[f],d[m])&&(h=0,--g);this.last_in[f]=h;if(0===g)return-1;b+=h}return 6===b?1:0};return{Frustum:r,Octree:y}});
CubicVR.RegisterModule("CVRXML",function(m){function y(a,b,f,g){var h=CubicVR.util,m=null,o=null;g.triangles&&(o=h.intDelimArray(c.getTextNode(g,"triangles")," "));if(o&&(g.segments&&(m=h.intDelimArray(c.getTextNode(g,"segments")," ")),null===m&&(m=[0,parseInt(o.length/3,10)]),g=0,a.setFaceMaterial(b),o.length)){p=0;for(pMax=m.length;p<pMax;p+=2){b=3*m[p+1];a.setSegment(m[p]);j=g;for(jMax=g+b;j<jMax;j+=3)h=a.addFace([o[j],o[j+1],o[j+2]]),f&&a.faces[h].setUV([f[j],f[j+1],f[j+2]]);g+=b}}}function w(a){var b=
CubicVR.util,f=new CubicVR.UVMapper,n=null,h=null;if(a.type)switch(n=c.getTextNode(a,"type"),n){case "planar":f.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":f.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":f.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":f.projection_mode=g.uv.projection.CUBIC}if(!n)return null;"uv"===n&&a.uv&&(h=c.getPoints(a,"uv"));if(a.axis)switch(c.getTextNode(a,"axis")){case "x":f.projection_axis=g.uv.axis.X;break;case "y":f.projection_axis=
g.uv.axis.Y;break;case "z":f.projection_axis=g.uv.axis.Z}a.center&&(f.center=b.floatDelimArray(c.getTextNode(a,"center")));a.rotation&&(f.rotation=b.floatDelimArray(c.getTextNode(a,"rotation")));a.scale&&(f.scale=b.floatDelimArray(c.getTextNode(a,"scale")));a.wrap_w&&(f.wrap_w_count=parseFloat(c.getTextNode(a,"wrap_w")));a.wrap_h&&(f.wrap_h_count=parseFloat(c.getTextNode(a,"wrap_h")));return""!==n&&"uv"!==n?f:h}function r(e,d){if(a[e]!==b)return a[e];var f=CubicVR.util,n,h,o,r;n=null;n="object"==
typeof e?e:-1!=e.indexOf(".js")?f.getJSON(e):CubicVR.util.xml2badgerfish(f.getXML(e));n.root&&(n=n.root);n.properties&&(n=n.properties);f=new CubicVR.Mesh;n.points&&(o=c.getPoints(n,"points"))&&f.addPoint(o);var s=n.material;s&&!s.length&&(s=[s]);var t=[];if(s){n=0;for(o=s.length;n<o;n++){var D=s[n],C;C=D;var B=d,I=new CubicVR.Material({name:C.name?C.name.$:null});C.shininess&&(I.shininess=c.getFloatNode(C,"shininess",I.shininess)/100);I.opacity=c.getFloatNode(C,"alpha",I.opacity);I.max_smooth=c.getFloatNode(C,
"max_smooth",I.max_smooth);I.color=c.getFloatDelimNode(C,"color",I.color);I.ambient=c.getFloatDelimNode(C,"ambient",I.ambient);I.diffuse=c.getFloatDelimNode(C,"diffuse",I.diffuse);I.specular=c.getFloatDelimNode(C,"specular",I.specular);h=void 0;if(h=c.getTextNode(C,"texture"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.COLOR);if(h=c.getTextNode(C,"texture_luminosity"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:
new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.AMBIENT);if(h=c.getTextNode(C,"texture_normal"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.NORMAL);if(h=c.getTextNode(C,"texture_specular"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.SPECULAR);if(h=c.getTextNode(C,"texture_bump"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:
new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.BUMP);if(h=c.getTextNode(C,"texture_envsphere"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.ENVSPHERE);if(h=c.getTextNode(C,"texture_alpha"))h=(B?B:"")+h,tex=m.Textures_ref[h]!==b?m.Textures_obj[m.Textures_ref[h]]:new CubicVR.Texture(h),I.setTexture(tex,g.texture.map.ALPHA);C=I;var u=null;h=B=null;D.uvmapper&&((B=w(D.uvmapper))&&!B.length?t.push([B,C]):h=B);(I=D.part)&&
!I.length&&(I=[I]);if(I&&I.length){var x=null,E=null;h=0;for(r=I.length;h<r;h++){var z=I[h],x=null;if(u=z.uvmapper)x=w(u),D.triangles&&(E=u=f.faces.length,x&&!x.length?(y(f,C,null,z),E=f.faces.length-1,f.calcFaceNormals(u,E),x.apply(f,C,b,u,E)):x&&x.length?y(f,C,x,z):B&&!B.length&&(y(f,C,null,z),E=f.faces.length-1,f.calcFaceNormals(u,E),B.apply(f,C,b,u,E)));if(z.procedural){(u=z.uvmapper)&&(x=w(u));var E=z.transform?c.getTransform(z.transform):b,u=b,z=z.procedural,F=c.getTextNode(z,"type");E&&(u=
new CubicVR.Transform,u.translate(E.position),u.pushMatrix(),u.rotate(E.rotation),u.pushMatrix(),u.scale(E.scale));B||(B=b);x={material:C,uvmapper:B||x};if("box"===F||"cube"===F)x.size=c.getFloatNode(z,"size"),f.booleanAdd(CubicVR.primitives.box(x),u);else if("sphere"===F)x.radius=c.getFloatNode(z,"radius"),x.lat=c.getIntNode(z,"lat"),x.lon=c.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.sphere(x),u);else if("cone"===F)x.base=c.getFloatNode(z,"base"),x.height=c.getFloatNode(z,"height"),x.lon=
c.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.cone(x),u);else if("plane"===F)x.size=c.getFloatNode(z,"size"),f.booleanAdd(CubicVR.primitives.plane(x),u);else if("cylinder"===F)x.radius=c.getFloatNode(z,"radius"),x.height=c.getFloatNode(z,"height"),x.lon=c.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.cylinder(x),u);else if("torus"===F)x.innerRadius=c.getFloatNode(z,"innerRadius"),x.outerRadius=c.getFloatNode(z,"outerRadius"),x.lat=c.getIntNode(z,"lat"),x.lon=c.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.torus(x),
u);else if("lathe"===F)x.points=c.getPoints(z,"p"),x.lon=c.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.lathe(x),u);else if("polygon"===F){E=c.getPoints(z,"p");E=new CubicVR.Polygon(E);(F=z.cut)&&!F.length&&(F=[F]);if(F.length){h=0;for(o=F.length;h<r;h++)E.cut(new CubicVR.Polygon(c.getPoints(F[h])))}x.front=0;x.back=0;x.frontShift=0;x.backShift=0;x.frontDepth=0;x.backDepth=0;if(z.extrude&&(z=z.extrude,x.front=c.getFloatNode(z,"front",0),x.back=c.getFloatNode(z,"back",0),x.frontShift=c.getFloatNode(z,
"frontBevelShift",0),x.backShift=c.getFloatNode(z,"backBevelShift",0),x.frontDepth=c.getFloatNode(z,"frontBevelDepth",0),x.backDepth=c.getFloatNode(z,"backBevelDepth",0),x.depth=c.getFloatNode(z,"depth",0),x.shift=c.getFloatNode(z,"shift",0),x.bevel=c.getFloatNode(z,"bevel",0),x.depth&&(!x.backDepth&&!x.frontDepth)&&(x.front=-x.depth/2,x.back=x.depth/2),x.shift&&(!x.backShift&&!x.frontShift)&&(x.frontShift=x.shift,x.backShift=x.shift),x.bevel&&!x.backDepth&&!x.frontDepth))x.frontDepth=x.bevel,x.backDepth=
x.bevel;z=E.toExtrudedBeveledMesh(new CubicVR.Mesh,x);z.setFaceMaterial(x.material);f.booleanAdd(z,u)}}}}else y(f,C,h,D)}}f.triangulateQuads();f.calcNormals();n=0;for(o=t.length;n<o;n++)t[n][0].apply(f,t[n][1]);f.compile();return a[e]=f}function o(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function s(a,c,f){var n=CubicVR.util,h=[];h[0]=a.getElementsByTagName("x");h[1]=a.getElementsByTagName("y");
h[2]=a.getElementsByTagName("z");h[3]=a.getElementsByTagName("fov");var m,o,r,t,s,C;for(C in h)if(h.hasOwnProperty(C)&&h[C]!==b&&h[C].length){m=h[C][0].getElementsByTagName("time");o=h[C][0].getElementsByTagName("value");r=h[C][0].getElementsByTagName("in");t=h[C][0].getElementsByTagName("out");s=h[C][0].getElementsByTagName("tcb");var B=null,w=null,u=null,x=a=null;r.length&&(a=n.collectTextNode(r[0]));t.length&&(x=n.collectTextNode(t[0]));m.length&&(B=n.floatDelimArray(n.collectTextNode(m[0])," "));
o.length&&(w=n.floatDelimArray(n.collectTextNode(o[0])," "));s.length&&(u=n.floatDelimArray(n.collectTextNode(s[0])," "));if(null!==B&&null!==w){m=0;for(o=B.length;m<o;m++)r=f.setKey(c,C,B[m],w[m]),u&&(r.tension=u[3*m],r.continuity=u[3*m+1],r.bias=u[3*m+2])}w=B=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":B=g.envelope.behavior.RESET;break;case "constant":B=g.envelope.behavior.CONSTANT;break;case "repeat":B=g.envelope.behavior.REPEAT;break;case "oscillate":B=g.envelope.behavior.OSCILLATE;
break;case "offset":B=g.envelope.behavior.OFFSET;break;case "linear":B=g.envelope.behavior.LINEAR}if(x)switch(x){case "reset":w=g.envelope.behavior.RESET;break;case "constant":w=g.envelope.behavior.CONSTANT;break;case "repeat":w=g.envelope.behavior.REPEAT;break;case "oscillate":w=g.envelope.behavior.OSCILLATE;break;case "offset":w=g.envelope.behavior.OFFSET;break;case "linear":w=g.envelope.behavior.LINEAR}f.setBehavior(c,C,B,w)}}var b=m.undef,g=CubicVR.enums,a=[],c={getPoints:function(a,d,f){a=d?
c.getTextNode(a,d):a.$;if(!a)return b;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var c=CubicVR.util;if(!a)return null;var b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},g;postition=a.position;g=a.rotation;a=a.scale;g&&(b.rotation=c.floatDelimArray(g.$));a&&(b.scale=c.floatDelimArray(a.$));return g||a?b:null},getTextNode:function(a,c,b){a=a[c];if(!a)return b;
a.length&&(a=a[0]);return a.$?a.$:b},getFloatNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseFloat(a),a!=a?f:a):f},getIntNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseInt(a,10),a!=a?f:a):f},getFloatDelimNode:function(a,b,f,g){var h=CubicVR.util;return(a=c.getTextNode(a,b))?h.floatDelimArray(a,g):f},getIntDelimNode:function(a,b,f,g){var h=CubicVR.util;return(a=c.getTextNode(a,b))?h.intDelimArray(a,g):f}};return{loadMesh:r,loadScene:function(a,c,f){var n=CubicVR.util;c===b&&(c=
"");f===b&&(f="");for(var h=new CubicVR.Mesh,m=n.getXML(a),a=new CubicVR.Scene,A=[],v=m.getElementsByTagName("sceneobjects"),t,D,C,w=0,y=v[0].childNodes.length;w<y;w++){var u=v[0].childNodes[w];if("sceneobject"===u.tagName){var x="unnamed",E="",z="",h=u.getElementsByTagName("name");h.length&&(x=n.collectTextNode(h[0]));h=u.getElementsByTagName("parent");h.length&&(E=n.collectTextNode(h[0]));h=u.getElementsByTagName("model");h.length&&(z=n.collectTextNode(h[0]));C=D=t=null;h=u.getElementsByTagName("position");
h.length&&(t=h[0]);h=u.getElementsByTagName("rotation");h.length&&(D=h[0]);h=u.getElementsByTagName("scale");h.length&&(C=h[0]);h=null;""!==z&&(h=r(c+z,f));h=new CubicVR.SceneObject(h,x);o(t)?(h.motion||(h.motion=new CubicVR.Motion),s(t,g.motion.POS,h.motion)):t&&(h.position=n.floatDelimArray(n.collectTextNode(t)));o(D)?(h.motion||(h.motion=new CubicVR.Motion),s(D,g.motion.ROT,h.motion)):h.rotation=n.floatDelimArray(n.collectTextNode(D));o(C)?(h.motion||(h.motion=new CubicVR.Motion),s(C,g.motion.SCL,
h.motion)):h.scale=n.floatDelimArray(n.collectTextNode(C));a.bindSceneObject(h);""!==E&&A.push([h,E])}}for(var F in A)A.hasOwnProperty(F)&&a.getSceneObject(A[F][1]).bindChild(A[F][0]);c=m.getElementsByTagName("camera");c.length&&((D=t=null,f="",h=c[0].getElementsByTagName("name"),F=a.camera,m=null,h.length&&(f=h[0].firstChild.nodeValue),h=c[0].getElementsByTagName("target"),h.length&&(f=h[0].firstChild.nodeValue),""!==f&&(F.targetSceneObject=a.getSceneObject(f)),h=c[0].getElementsByTagName("position"),
h.length&&(t=h[0]),h=c[0].getElementsByTagName("rotation"),h.length&&(D=h[0]),h=c[0].getElementsByTagName("fov"),h.length&&(m=h[0]),o(t)?(F.motion||(F.motion=new CubicVR.Motion),s(t,g.motion.POS,F.motion)):t&&(F.position=n.floatDelimArray(t.firstChild.nodeValue)),o(D)?(F.motion||(F.motion=new CubicVR.Motion),s(D,g.motion.ROT,F.motion)):D&&(F.rotation=n.floatDelimArray(D.firstChild.nodeValue)),o(m))?(F.motion||(F.motion=new CubicVR.Motion),s(m,g.motion.FOV,F.motion)):m&&(F.fov=parseFloat(m.firstChild.nodeValue)));
return a}}});
CubicVR.RegisterModule("Worker",function(m){function y(a){var c=this;this.message=a.message||function(){};this.send=function(a,c){postMessage({message:a,data:c})};self.addEventListener("message",function(a){"init"!==a.data.message&&c.message(a.data)},!1)}function w(a){function c(a){setTimeout(function(){b.send("test",a)},1E3)}a&&c(a);var b=new y({message:c})}function r(a){function c(a){a=q.getURL(a);b.send("done",a.length)}var b;b=new y({message:function(a){c(a)}});a&&c(a)}function o(a){function c(a){a=q.getURL(a);
b.send("loaded",a)}var b,d;b=new y({message:function(a){if("parse"===a.message)d=new h,CubicVR.loadCollada("","",d,a.data),b.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var c=a.triangulateQuads().compileVBO(a.compileMap());b.send("getMesh",{mesh:a,vbo:c})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&c(a)}function s(c){function b(c){var e=new a,f;for(f in c)c.hasOwnProperty(f)&&(e[f]=c[f]);c=e.triangulateQuads().compileVBO(e.compileMap());d.send("done",
c)}var d;d=new y({message:function(a){b(a)}});c&&b(c)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(b){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=m.undef,a=CubicVR.Mesh,c=CubicVR.Texture,e=CubicVR.Material,d=CubicVR.SceneObject,f=CubicVR.Motion,n=CubicVR.Envelope,h=CubicVR.DeferredBin,q=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var c=this;this.worker.onmessage=function(a){c.message(a.data)};this.worker.onerror=function(a){c.error(a)};this.init=function(a){c.send("init",{type:c.type,data:a})};this.send=function(a,b){c.worker.postMessage({message:a,data:b})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&c.init(a.data)},ResourcePool:function(){function b(c){var d=c.parsed||
function(){},e={},f;c.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:c.url,message:function(c){if("loaded"===c.message){var c=(new DOMParser).parseFromString(c.data,"text/xml"),b=q.xml2badgerfish(c);console.log(c);f.send("parse",b)}else if("getMesh"===c.message){var b=new a,g;for(g in c.data.mesh)c.data.mesh.hasOwnProperty(g)&&(b[g]=c.data.mesh[g]);b.bindBuffer(b.bufferVBO(c.data.vbo));e.getMesh&&e.getMesh(b)}else"parsed"===c.message&&d()}}));this.getSceneObject=function(a,c){f.send("getMesh",
a);e.getMesh=c}}function f(a,c){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}var g=this,h={};this.createSceneFileManager=function(a){var c=new b({url:a.url,parsed:a.parsed});return h[a.url]=c};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete h[settings];else for(var c in h)h[c]===a&&delete h[c]};this.createSceneObjectFromMesh=function(b){var h=b.scene,n=b.object,m=b.assetBase||"",o=g.createSceneFileManager({url:b.mesh,parsed:function(){n&&o.getSceneObject(n,
function(b){for(var b=f(b,new a),g=0,n=b.materials.length;g<n;++g){for(var o=f(b.materials[g],new e),t=0,q=o.textures.length;t<q;++t){var r=o.textures[g];o.textures[g]=new c(m+r.img_path,r.filter_type)}b.materials[g]=o}b=new d(b);h.bindSceneObject(b)})}})};this.loadFile=function(a,c){c=c||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){c(a.data)}})}},loadColladaWorker:function(b,h,m,o){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],u=[];q.onmessage=function(h){function q(a,c){for(var b in a)c[b]=a[b]}function r(a){if(a.motion){for(var c=a.motion.controllers,b=[],d=0,e=c.length;d<e;++d){var g=c[d];if(g){for(var h=[],m=0,o=g.length;m<o;++m){var t=g[m];if(t){var s=t.keys[0];1<t.keys.length&&(s.prev=null,s.next=t.keys[1],s=t.keys[1]);for(var v=1,u=t.keys.length-1;v<u;++v)s.prev=t.keys[v-1],s.next=t.keys[v+1],s=t.keys[v+1];1<t.keys.length&&(s=t.keys[t.keys.length-1],s.prev=t.keys[t.keys.length-2],s.next=null);t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;s=new n;q(t,s);h[m]=s}else g[m]=null}b[d]=h}else c[d]=null}a.motion.controllers=b;c=new f;q(a.motion,c);a.motion=c}}function v(c){var e=new d;q(c,e);if(null!==c.obj){var f=u[c.obj.id];if(f===g)if(f=new a,q(c.obj,f),e.obj=f,u[c.obj.id]=f,o){if(0<f.points.length){o.addMesh(b,b+":"+f.id,f);for(var h=0,n=f.faces.length;h<n;++h){var m=f.faces[h],t=m.material;m.material=s[t]!==g?s[t]:0}}}else e.obj.triangulateQuads(),e.obj.calcNormals(),e.obj.compile(),
e.obj.clean();else e.obj=f}e.trans=new Transform;if(c.children&&0<c.children.length&&(e.children=[],c.children)){f=0;for(h=c.children.length;f<h;++f)n=v(c.children[f]),e.bindChild(n)}return e}var C;C=h.data.message;if("materials"==C){var w=JSON.parse(h.data.data),h=0;for(C=w.length;h<C;++h){var B=new e(w[h].name),y=B.material_id;q(w[h],B);B.material_id=y;s[w[h].material_id]=y;for(var y=0,M=w[h].textures.length;y<M;++y){var K=w[h].textures[y];if(K){var N=Texture_ref[K.img_path];N===g?(K=new c(K.img_path,
K.filter_type,o,b),B.textures[y]=K):B.textures[y]=Textures_obj[N]}else B.textures[y]=0}}}else if("scene"==C){w=JSON.parse(h.data.data);h=0;for(C=w.sceneObjects.length;h<C;++h)B=w.sceneObjects[h],null!==B.obj&&nop(),B.reassembled===g&&(r(B),B.reassembled=!0),w.sceneObjects[h]=v(B);B=new Scene;h=B.camera;C=h.transform;q(w.camera,h);q(w.camera.transform,C);r(h);B.camera=h;B.camera.transform=C;B.camera.frustum=new Frustum;h=0;for(C=w.sceneObjects.length;h<C;++h){y=w.sceneObjects[h];B.bindSceneObject(y);
try{y.getAABB()}catch(Y){}}h=0;for(C=w.lights.length;h<C;++h)y=new Light,q(w.lights[h],y),y.trans=new Transform,r(y),B.bindLight(y);m(B)}else console.log("message from collada worker:",h.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:b,prefix:h,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:w,prepareMesh:s,file:r,sceneFile:o};self.addEventListener("message",function(c){if("init"===
c.data.message){var b=c.data.data.type;if(b in a)new a[b](c.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(m){function y(a){var c=[],b=a.length;if(3>b)return null;var e=[],g;g=a.length;for(var m=0,o=g-1,r=0;r<g;o=r++)m+=a[o][0]*a[r][1]-a[r][0]*a[o][1];if(0<0.5*m)for(g=0;g<b;g++)e[g]=g;else for(g=0;g<b;g++)e[g]=b-1-g;r=2*b;m=0;for(g=b-1;2<b;){if(0>=r--)return null;var s=g;b<=s&&(s=0);g=s+1;b<=g&&(g=0);o=g+1;b<=o&&(o=0);var w;a:{w=a;var y=s,u=g,x=o,E=b,z=e,F=void 0,H=void 0,G=void 0,J=void 0,L=void 0,M=void 0,K=void 0,N=void 0,Y=void 0,H=w[z[y]][0],G=w[z[y]][1],
J=w[z[u]][0],L=w[z[u]][1],M=w[z[x]][0],K=w[z[x]][1];if(d>(J-H)*(K-G)-(L-G)*(M-H))w=!1;else{for(F=0;F<E;F++)if(!(F==y||F==u||F==x)){var N=w[z[F]][0],Y=w[z[F]][1],ca=void 0,U=void 0,na=void 0,Q=void 0,O=void 0,La=void 0,gb=void 0,hb=void 0,Ma=void 0,pb=void 0,Na=void 0,ib=void 0,ca=na=O=void 0,ca=M-J,U=K-L,na=H-M,Q=G-K,O=J-H,La=L-G,gb=N-H,hb=Y-G,Ma=N-J,pb=Y-L,Na=N-M,ib=Y-K,ca=ca*pb-U*Ma,O=O*hb-La*gb,na=na*ib-Q*Na;if(0<=ca&&0<=na&&0<=O){w=!1;break a}}w=!0}}if(w){r=e[s];s=e[g];o=e[o];c.push(r);c.push(s);
c.push(o);m++;o=g;for(r=g+1;r<b;o++,r++)e[o]=e[r];b--;r=2*b}}return c}function w(a,c,b){b===e&&(b=0);var d;d=y(c);var g=CubicVR.util.repackArray(d,3,d.length/3),m=[],o=a.points.length;d=0;for(iMax=c.length;d<iMax;d++)m.push([c[d][0],c[d][1],b]);a.addPoint(m);d=0;for(iMax=g.length;d<iMax;d++)a.addFace([g[d][0]+o,g[d][1]+o,g[d][2]+o])}function r(a,c){var b=c[0]-a[0],d=c[1]-a[1];return Math.sqrt(b*b+d*d)}function o(a,c){var b,d,e=[],g=a.length,m=c.length,o=[];for(b=0;b<g;b++)for(d=0;d<m;d++){var s=r(a[b],
c[d]);e.push([s,b,d])}e.sort(function(a,c){return a[0]>c[0]});for(b=0;5>b;b++)for(d=0;d<e.length;d++)b!=d&&e[b][1]!=e[d][1]&&e[b][2]!=e[d][2]&&e[b][1]<e[d][1]&&e[b][2]<e[d][2]&&4>Math.abs(e[b][1]-e[d][1])&&4>Math.abs(e[b][2]-e[d][2])&&o.push([b,d]);o.sort(function(a,c){return e[a[0]][0]+e[a[1]][0]>e[c[0]][0]+e[c[1]][0]});10<o.length&&(o.length=10);d=[];for(b=0;b<o.length;b++)d.push([e[o[b][0]],e[o[b][1]]]);return d}function s(a,c){var b=o(a,c),d;if(!b.length)return null;d=b[0][0];var e=b[0][1],b=
e[1]-d[1],e=e[2]-d[2],g=a.slice(d[1]),g=g.concat(a.slice(0,d[1])),m=c.slice(d[2]),m=m.concat(c.slice(0,d[2])),r=[];for(d=b;d<g.length;d++)r.push(g[d]);r.push(g[0]);for(d=e;d<m.length;d++)r.push(m[d]);r.push(m[0]);var s=[];for(d=0;d<=b;d++)s.push(g[d]);for(d=0;d<=e;d++)s.push(m[d]);return[r,s]}function b(a){for(var c=[0,0],b=0;b<a.length;b++)c[0]+=a[b][0],c[1]+=a[b][1];c[0]/=a.length;c[1]/=a.length;return c}function g(a,c,b){for(var d=[],e=0;e<a.length;e++){var g=[a[e][0]-c[0],a[e][1]-c[1]],m=Math.sqrt(g[0]*
g[0]+g[1]*g[1])+b,g=Math.atan2(g[1],g[0]);d[e]=[c[0]+Math.cos(g)*m,c[1]+Math.sin(g)*m]}return d}function a(a,c,b,d,e){var g,m=a.points.length;if(c.length!=b.length)return null;var o=c.length;for(g=0;g<o;g++)a.addPoint([c[g][0],c[g][1],d]);for(g=0;g<o;g++)a.addPoint([b[g][0],b[g][1],e]);for(g=0;g<o-1;g++)a.addFace([m+g,m+g+1,m+(g+o+1),m+(g+o)]);g=o-1;a.addFace([m+g,m,m+o,m+(g+o)])}function c(a){this.points=a;this.cuts=[];this.result=[]}var e=m.undef,d=1.0E-10;c.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var c;a||(a=new CubicVR.Mesh);this.result=[this.points];for(c=0;c<this.cuts.length;c++){var b=this.cuts[c].points.slice(0),b=b.reverse(),b=s(this.result[0],b);this.result[0]=b[0];this.result.push(b[1])}for(c=0;c<this.result.length;c++)w(a,this.result[c]);a.removeDoubles();return a}},toExtrudedMesh:function(c,b,d){if(0!==this.points.length){var g,m;b===e&&(b=0);d===e&&(d=0);var o=b!=d;c||(c=new CubicVR.Mesh);this.result=[this.points];for(m=0;m<this.cuts.length;m++)g=
this.cuts[m].points.slice(0),g=g.reverse(),g=s(this.result[0],g),this.result[0]=g[0],this.result.push(g[1]);g=new CubicVR.Mesh;for(m=0;m<this.result.length;m++)w(g,this.result[m],d);c.booleanAdd(g);g.flipFaces();if(o)for(m=0;m<g.points.length;m++)g.points[m][2]=b;c.booleanAdd(g);if(o){a(c,this.points,this.points,b,d);for(m=0;m<this.cuts.length;m++)g=this.cuts[m].points.slice(0),g=g.reverse(),a(c,g,g,b,d)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(c,d,e,m,o,r,t){var D=[],C=[],y,I,
u,x;if(0!==this.points.length){"object"===typeof d&&(t=d,d=t.front||0,e=t.back||0,m=t.frontDepth||0,o=t.frontShift||0,r=t.backDepth||0,t=t.backShift||0);var E=d!==e,z=0!==r,F=0!==m;c||(c=new CubicVR.Mesh);F?(I=b(this.points),I=g(this.points,I,-o),this.result=[I.slice(0)]):this.result=[this.points.slice(0)];for(x=0;x<this.cuts.length;x++)u=b(this.cuts[x].points),u=g(this.cuts[x].points,u,o),u=u.reverse(),D.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);o=new CubicVR.Mesh;
for(x=0;x<this.result.length;x++)w(o,this.result[x],d-m);o.flipFaces();c.booleanAdd(o);if(z||F){y=b(this.points);y=g(this.points,y,-t);this.result=[y.slice(0)];for(x=0;x<this.cuts.length;x++)u=b(this.cuts[x].points),u=g(this.cuts[x].points,u,t),u=u.reverse(),C.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);o=new CubicVR.Mesh;for(x=0;x<this.result.length;x++)w(o,this.result[x],e+r)}else{for(x=0;x<o.points.length;x++)o.points[x][2]=e;o.flipFaces()}c.booleanAdd(o);F&&a(c,I,
this.points,d-m,d);E&&a(c,this.points,this.points,d,e);z&&a(c,this.points,y,e,e+r);for(x=0;x<D.length;x++)u=this.cuts[x].points.slice(0).reverse(),F&&a(c,D[x],u,d-m,d),E&&a(c,u,u,d,e),z&&a(c,u,C[x],e,e+r);c.removeDoubles();return c}}};return{polygon:{triangulate2D:y,toMesh:w,findNearPair:function(a,c){for(var b=[0,0],d=r(a[0],c[0]),e=a.length,g=c.length,m=0;m<e;m++)for(var o=0;o<g;o++){var s=r(a[m],c[o]);s<d&&(b[0]=m,b[1]=o,d=s)}return b},subtract:s,addOffset:function(a,c){for(var b=[],d=0,e=a.length;d<
e;d++){var g=a[d];b.push([g[0]+c[0],g[1]+c[1]])}return b}},Polygon:c}});
CubicVR.RegisterModule("ScenePhysics",function(m){function y(a,c){c.setX(a[0]);c.setY(a[1]);c.setZ(a[2])}function w(a,c){c.setX(a.x);c.setY(a.y);c.setZ(a.z);c.setW(a.w)}function r(a,c){c.x=a.x();c.y=a.y();c.z=a.z();c.w=a.w()}function o(a){return new Ammo.btVector3(a[0],a[1],a[2])}function s(a){var c=new Ammo.btQuaternion;c.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return c}function b(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=m.undef,c=m.enums;
c.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var e,d,f,n,h,q=function(a,c,b){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,c=d.properties,b=d.collision);d=m.get(d)||{};this.properties=new m.RigidProperties(c?m.get(c):{collision:b});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(o(this.init_position));this.transform.setRotation(s(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};q.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===c.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),y(this.linearVelocity,n),this.body.setLinearVelocity(n),y(this.angularVelocity,n),this.body.setAngularVelocity(n),m.vec3.equal([0,0,0],this.impulse)||(y(this.impulse,n),y(this.impulsePosition,h),this.body.applyImpulse(n,h)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();y(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;d.fromEuler(a[0],a[1],a[2]);a=[d.x,d.y,d.z,d.w];f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);f.setW(a[3]);this.body.getWorldTransform().setRotation(f);this.activate()}},resetMotion:function(){y(this.init_linearVelocity,
n);this.body.setLinearVelocity(n);y(this.init_angularVelocity,n);this.body.setAngularVelocity(n);m.vec3.equal([0,0,0],this.init_impulse)||(y(this.init_impulse,n),y(this.init_impulsePosition,h),this.body.applyImpulse(n,h))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var b=a.getShapes(),d,g,f,h,n,r,q,v=[],w=null;g=0;for(f=b.length;g<f;g++){d=b[g];w=null;if(d.type===c.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(d.size[0]/
2,d.size[1]/2,d.size[2]/2));else if(d.type===c.collision.shape.SPHERE)w=new Ammo.btSphereShape(d.radius);else if(d.type===c.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(d.radius,d.height);else if(d.type===c.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(d.size[0]/2,d.size[1]/2,d.size[2]/2));else if(d.type===c.collision.shape.CONE)w=new Ammo.btConeShape(d.radius,d.height);else if(d.type===c.collision.shape.MESH){q=d.mesh;w=new Ammo.btTriangleMesh;r=d.size;var A=new Ammo.btVector3(0,
0,0),J=new Ammo.btVector3(0,0,0),L=new Ammo.btVector3(0,0,0),M=q.getMaterials();h=0;for(n=q.faces.length;h<n;h++){var K=q.faces[h];M[K.material].collision&&3===K.points.length&&(A.setValue(q.points[K.points[0]][0]*r[0],q.points[K.points[0]][1]*r[1],q.points[K.points[0]][2]*r[2]),J.setValue(q.points[K.points[1]][0]*r[0],q.points[K.points[1]][1]*r[1],q.points[K.points[1]][2]*r[2]),L.setValue(q.points[K.points[2]][0]*r[0],q.points[K.points[2]][1]*r[1],q.points[K.points[2]][2]*r[2]),w.addTriangle(A,J,
L))}0===this.getMass()||this.getType()==c.physics.body.STATIC||this.getType()==c.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(d.type===c.collision.shape.CONVEX_HULL){q=d.mesh;r=d.size;A=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;h=0;for(n=q.points.length;h<n;h++)y([q.points[h][0]*r[0],q.points[h][1]*r[1],q.points[h][2]*r[2]],A),w.addPoint(A)}else if(d.type===c.collision.shape.HEIGHTFIELD){var J=A=q=r=0,
N;d.landscape&&!d.getHeightField&&d.landscape instanceof m.HeightField?d.heightfield=d.landscape:d.landscape&&d.landscape instanceof m.Landscape&&(r=d.landscape.getHeightField().getDivX(),A=d.landscape.getHeightField().getDivZ(),q=d.landscape.getHeightField().getSizeX(),J=d.landscape.getHeightField().getSizeZ(),N=d.landscape.getMesh().points);d.heightfield&&d.heightfield instanceof m.HeightField&&(r=d.heightfield.getDivX(),A=d.heightfield.getDivZ(),q=d.heightfield.getSizeX(),J=d.heightfield.getSizeZ(),
N=d.getMesh().points);w=Ammo.allocate(4*N.length,"float",Ammo.ALLOC_NORMAL);h=0;for(n=r*A;h<n;h++)Ammo.setValue(w+(h<<2),N[h][1],"float");w=new Ammo.btHeightfieldTerrainShape(r,A,w,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);h=new Ammo.btVector3(q/r,1,J/A);w.setLocalScaling(h)}w&&(0!==d.margin&&w.setMargin(d.margin),v.push({cShape:d,btShape:w}))}b=null;if(1===v.length)b=v[0].btShape;else if(1<v.length){e=new Ammo.btTransform;b=new Ammo.btCompoundShape(!1);g=0;for(f=v.length;g<f;g++)e.setIdentity(),
e.setOrigin(o(v[g].cShape.position)),e.setRotation(s(v[g].cShape.rotation)),b.addChildShape(e,v[g].btShape)}a.setResult(b);a=b}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(y(a,n),this.body.setAngularVelocity(n))},setGravity:function(a){this.gravity=a;this.body&&(y(a,n),this.body.setGravity(n))},getGravity:function(){return this.gravity&&!this.body?this.gravity:b(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&
(y(a,n),this.body.setLinearVelocity(n))},applyImpulse:function(a,c){this.impulse=a||[0,0,0];this.impulsePosition=c||[0,0,0];this.body&&!m.vec3.equal([0,0,0],a)&&(y(this.impulse,n),y(this.impulsePosition,h),this.body.applyImpulse(n,h))},applyForce:function(a,c){this.body&&!m.vec3.equal([0,0,0],a)&&(y(a,n),y(c,h),this.body.applyImpulse(n,h))},getAngularVelocity:function(){return b(this.body.getAngularVelocity())},getLinearVelocity:function(){return b(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=
a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(c.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(c){this.body&&c!==a&&(c.length||(c=[c,c,c]),y(c,n),this.body.setAngularFactor(n))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==c.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=
a=m.parseEnum(c.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)y(a,n),this.body&&this.body.getCenterOfMassTransform().setOrigin(n),this.ghost&&this.ghost.getWorldTransform().setOrigin(n)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);var a=new m.Quaternion;r(f,a);
return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)w(a,f),this.body&&this.body.getCenterOfMassTransform().setRotation(f),this.ghost&&this.ghost.getWorldTransform().setRotation(f)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new m.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);r(f,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;f.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(f);this.ghost&&this.body.getWorldTransform().setRotation(f)}};var A=function(b){b=b||{};this.ctype=m.parseEnum(c.physics.constraint,b.ctype)||c.physics.constraint.P2P;this.strength=b.strength||0.1;this.maxImpulse=b.maxImpulse||0;this.rigidBodyA=b.rigidBodyA||b.rigidBody||null;this.rigidBodyB=b.rigidBodyB||null;this.positionA=b.positionA||
[0,0,0];this.positionB=b.positionB||b.position||[0,0,0];this.damping=b.damping!=a?b.damping:1;this.btConstraint=null;this.localPivotA=o(this.positionA);this.localPivotB=o(this.positionB)};A.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===c.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(y(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),
friction:a.get_m_combinedFriction(),positionA:b(a.getPositionWorldOnA()),positionB:b(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var v=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;
this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!d)n=new Ammo.btVector3,h=new Ammo.btVector3,e=new Ammo.btTransform,d=new m.Quaternion,f=new Ammo.btQuaternion};v.prototype={addConstraint:function(a){var c=
a.getConstraint();return c?(this.dynamicsWorld.addConstraint(c),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){y(a,n);this.dynamicsWorld.setGravity(n)},bindSceneObject:function(a,c){var b=new m.RigidBody(a,c);this.rigidObjects.push(b);b.getBody();b.activate();this.dynamicsWorld.addRigidBody(b.getBody());b.updateSceneObject(!0);return b},bind:function(a){a instanceof m.Vehicle?a.initBody(this):
a instanceof m.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof m.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var b=a.getBody();a.properties.blocker||b.setCollisionFlags(b.getCollisionFlags()+c.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(b)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);b=
a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(c.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(c.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;
this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var b,d;if((b=a.getSceneObject())&&(d=b.getEventHandler()))d.hasEvent(c.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(c.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
c){this.dynamicsWorld.stepSimulation(a,c||2);for(var b=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&b++;this.active_count=b},triggerEvents:function(){var a,b,d,e,f=this.dynamicsWorld;if(this.contactObjects.length){var h=f.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=f.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(n&&(e=n.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m);else if(o&&o.isStatic()&&(e=o.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m)}}f=this.collisionObjects.length;for(a=0;a<f;a++)if(n=this.collisionObjects[a],(e=n.getSceneObject())&&
(b=e.getEventHandler())&&b.hasEvent(c.event.COLLIDE))if(d=b.getProperties(c.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){h=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],r=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,r));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,r));d.alg[a].processCollision(n,r,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&
(d=b.triggerEvent(c.event.COLLIDE)))d.collisions=h}f=this.ghostObjects.length;for(a=0;a<f;a++)if(d=this.ghostObjects[a],e=d.getSceneObject())if((b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT_GHOST))if(e=d.getBody(),h=e.getNumOverlappingObjects()){d=b.triggerEvent(c.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=h);for(b=0;b<h;b++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(b)),d.contacts[b]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,c=this.rigidObjects.length;a<c;a++)this.rigidObjects[a].reset()},getRayHit:function(a,c,d,e){var g,a=o(a);g=o(c);d=d||!1;e=e||!1;c=new Ammo.ClosestRayResultCallback(a,g);this.dynamicsWorld.rayTest(a,g,c);if(c.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(c.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=c.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(g=d._cvr_rigidbody)return Ammo.destroy(c),{position:b(e),
localPosition:b(a),rigidBody:g,ammoBody:d};Ammo.destroy(c);return{position:b(e),localPosition:b(a),rigidBody:null,ammoBody:d}}Ammo.destroy(c)}};return{ScenePhysics:v,Constraint:A,RigidProperties:function(b){this.type=m.parseEnum(c.physics.body,b.type);this.mass=b.mass!==a?b.mass:this.type?1:0;this.size=b.size||[1,1,1];this.restitution=b.restitution||(this.type?0:1);this.friction=b.friction||1;if((this.collision=b.collision)&&!this.collision.getShapes)this.collision=new m.CollisionMap(this.collision);
this.blocker=b.blocker||!1},RigidBody:q,vec3bt_copy:y,btvec3_copy:function(a,c){c[0]=a.x();c[1]=a.y();c[2]=a.z()},quatbt_copy:w,btquat_copy:r}});
CubicVR.RegisterModule("CollisionMap",function(m){var y=m.enums;y.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var w=function(m){this.shapes=[];this.result=null;if(m){m&&!m.length&&(m=[m]);for(var o=0,s=m.length;o<s;o++)this.addShape(m[o])}};w.prototype={addShape:function(r){r.type=m.parseEnum(y.collision.shape,r.type);r.position=r.position||[0,0,0];r.rotation=r.rotation||[0,0,0];r.size=r.size||[1,1,1];r.radius=r.radius||1;r.height=r.height||1;
r.margin=r.margin||0;r.mesh=r.mesh||null;this.shapes.push(r)},getShapes:function(){return this.shapes},setResult:function(m){this.result=m},getResult:function(){return this.result}};return{CollisionMap:w}});
CubicVR.RegisterModule("RigidVehicle",function(m){var y=m.undef,w=m.enums,r,o,s=function(b){var b=m.get(b)||{},a=b.mesh,c=b.collision;this.maxEngineForce=b.maxEngineForce||2E3;this.maxBreakingForce=b.maxBreakingForce||125;this.steeringClamp=b.steeringClamp||0.51;this.mass=b.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new m.CollisionMap(c);this.sceneObject=new m.SceneObject(this.bodyMesh);if(!r||!o)new Ammo.btVector3,new Ammo.btVector3,r=new Ammo.btTransform,o=new m.Quaternion,new Ammo.btQuaternion;if(b.wheels!=y){a=0;for(c=b.wheels.length;a<c;a++){var e=b.wheels[a];e instanceof m.VehicleWheel?this.addWheel(e):this.addWheel(new m.VehicleWheel(e))}}};s.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(b){this.body=
new m.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});m.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);m.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(b.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(w.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,c=0;c<this.wheels.length;c++)m.vec3bt_copy(this.wheels[c].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[c].getSuspensionRest(),this.wheels[c].getWheelRadius(),this.m_tuning,this.wheels[c].getSteering());b.dynamicsWorld.addVehicle(this.m_vehicle);b.bind(this.body);this.updateSuspension()},evaluate:function(){for(var b=this.m_vehicle.getNumWheels(),
a=0;a<b;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var c=this.m_vehicle.getWheelTransformWS(a),e=c.getOrigin();this.wheels[a].wheelObj.position[0]=e.x();this.wheels[a].wheelObj.position[1]=e.y();this.wheels[a].wheelObj.position[2]=e.z();c=c.getRotation();o.x=
c.x();o.y=c.y();o.z=c.z();o.w=c.w();c=o.toEuler();this.wheels[a].wheelObj.rotation[0]=c[0];this.wheels[a].wheelObj.rotation[1]=c[1];this.wheels[a].wheelObj.rotation[2]=c[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(b){if(this.body&&(this.body.isActive()||b))return this.body.getBody().getMotionState().getWorldTransform(r),b=r.getOrigin(),b.x!=b.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
b.x(),this.sceneObject.position[1]=b.y(),this.sceneObject.position[2]=b.z()),b=r.getRotation(),o.x=b.x(),o.y=b.y(),o.z=b.z(),o.w=b.w(),o.x!=o.x?console.log("rotation is NaN"):(b=o.toEuler(),this.sceneObject.rotation[0]=b[0],this.sceneObject.rotation[1]=b[1],this.sceneObject.rotation[2]=b[2]),!0},setEngineForce:function(b){this.gEngineForce=b;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(b){this.setEngineForce(this.getEngineForce()+b)},decEngine:function(b){this.setEngineForce(this.getEngineForce()-b)},setSteering:function(b){this.gVehicleSteering=b},getSteering:function(){return this.gVehicleSteering},incSteering:function(b){this.gVehicleSteering+=b;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(b){this.gBreakingForce=b},getWheelGroundPosition:function(b){return this.wheels[b].wheelObj.getWorldPosition()-[0,wheels[b].getWheelRadius(),0]},getWheelSkid:function(b){return this.m_vehicle.getWheelInfo(b).get_m_skidInfo()},getRigidGround:function(b){this.m_vehicle.getWheelInfo(b)},addWheel:function(b,a){a===y&&(a=this.wheels.length);this.wheels[a]=b},getWheel:function(b){return this.wheels[b]},bindToScene:function(b){for(var a=this.wheels.length,c=0;c<a;c++)b.bind(this.getWheelObj(c));
b.bind(this.getSceneObject())},getWheelObj:function(b){return this.getWheel(b).wheelObj},updateSuspension:function(){var b,a=this.m_vehicle.getNumWheels();for(b=0;b<a;b++){var c=this.m_vehicle.getWheelInfo(b);c.set_m_suspensionStiffness(this.wheels[b].getSuspensionStiffness());c.set_m_suspensionRestLength1(this.wheels[b].getSuspensionRest());c.set_m_wheelsDampingRelaxation(this.wheels[b].getDampingRelaxation());c.set_m_wheelsDampingCompression(this.wheels[b].getDampingCompression());c.set_m_frictionSlip(this.wheels[b].getFrictionSlip());
c.set_m_rollInfluence(this.wheels[b].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(b=0;b<a;b++)this.m_vehicle.updateWheelTransform(b,!0)}},getMass:function(){return this.mass},setMass:function(b){this.mass=b;this.body&&this.body.setMass(this.mass)}};var b=function(b){b=m.get(b)||{};this.wheelRef=new m.SceneObject;this.wheelObj=new m.SceneObject;this.wheelRef.scale=b.scale||[1,1,1];this.wheelRadius=b.radius||0;this.wheelWidth=b.width||0;b.mesh!=y&&this.setModel(b.mesh);
this.suspensionStiffness=b.suspensionStiffness||40;this.suspensionRest=b.suspensionRest||0.05;this.dampingRelaxation=b.dampingRelaxation||2.3;this.dampingCompression=b.dampingCompression||2.4;this.frictionSlip=b.frictionSlip||0.94;this.rollInfluence=b.rollInfluence||0.5;this.wheelPosition=b.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=b.steering||!1;this.braking=b.braking||!1;this.driving=b.driving||!1};b.prototype={setModel:function(b,a,c){this.wheelModel=b;this.wheelRadius=a||0;this.wheelWidth=
c||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(b){this.suspensionStiffness=b},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(b){this.suspensionRest=
b},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(b){this.dampingRelaxation=b},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(b){this.dampingCompression=b},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(b){this.frictionSlip=b},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(b){this.rollInfluence=b},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(b){this.wheelRadius=b},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(b){this.wheelWidth=b},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(b){this.wheelRotation=b;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(b){this.wheelPosition=b;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(b){this.steering=
b},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(b){this.driving=b},isDriving:function(){return this.driving}};return{Vehicle:s,VehicleWheel:b}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
