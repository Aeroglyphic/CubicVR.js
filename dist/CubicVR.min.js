try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(h,y,w,q,n){function s(a,c){if("object"!==typeof a)return o("enumerator validation failed, invalid type base object."),n;if(c===n)return n;if("number"===typeof c)return c;if("string"===typeof c){var g=parseInt(c,10);if(""!==c&&isFinite(g))return g;g=c.toUpperCase();g=a[g];if(g!==n)return g;o("enumerator validation failed, unknown enum value: "+c);var g="",e;for(e in a)a.hasOwnProperty(e)&&(""!==g&&(g+=", "),g+=e.toLowerCase());o("possible enum values are: "+g)}return n}var b="";try{for(var f=
y.querySelectorAll("script"),a=0,c=f.length;a<c;a++){var d=f[a].src.lastIndexOf("/CubicVR.js");-1<d&&(b=f[a].src.substr(0,d)+"/")}}catch(e){}var g=h.CubicVR={};g.contexts={};var o;try{o=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(m){o=q}var r={quality:{LOW:0,MEDIUM:1,HIGH:2}};h.cubicvr=r;var B={},v=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t=function(a){function c(a,g,e){var m=function(){};m.prototype=a.prototype;g.prototype=new m;for(var o in e)g.prototype[o]=
e[o];return g}var e=this,m;a&&(m=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return m}}));e.undef=n;e.nop=q;e.scriptLocation=b;e.GLCore=z;e.Textures=[];e.Textures_obj=[];e.Textures_ref=[];e.Images=[];e.ShaderPool=[];e.log=o;e.enums=g.enums;e.MAX_LIGHTS=6;e.extendClassGeneral=c;e.extendClass=function(a,g,e){return c(a,function(){a.apply(this);g.apply(this,arguments)},e)};e.features={};e.quality=g.enums.HIGH;var d={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},f={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},t={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};e.features=t;var z={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,
resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,c,m){var d,r=e.util,f=g.enums;if(c&&m){c=r.getScriptContents(c);m=r.getScriptContents(m)}else if(h.CubicVRShader.CubicVRCoreVS&&h.CubicVRShader.CubicVRCoreFS){c=h.CubicVRShader.CubicVRCoreVS;m=h.CubicVRShader.CubicVRCoreFS}else{c=r.getScriptContents(b+"CubicVR_Core.vs");m=r.getScriptContents(b+"CubicVR_Core.fs")}if(a===n){a=y.createElement("canvas");if(!d)try{d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias})}catch(t){return null}z.gl=
d;if(z.fixed_size!==null){z.width=z.fixed_size[0];z.height=z.fixed_size[1];z.resizeElement(a,z.width,z.height)}else{z.addResizeable(a);if(z.canvasSizeFactor!==1&&a.getContext!==n){var r=w.round(h.innerWidth*z.canvasSizeFactor),v=w.round(h.innerHeight*z.canvasSizeFactor);z.resizeElement(a,r,v);a.style.top=h.innerHeight/2-v/2+"px";a.style.left=h.innerWidth/2-r/2+"px";a.style.position="absolute"}else z.resizeElement(a,h.innerWidth,h.innerHeight)}y.body.appendChild(a)}if(a.getContext!==n&&a.width!==n&&
a.height!==n){try{d||(d=a.getContext("experimental-webgl",{antialias:e.features.antiAlias}));d.viewport(0,0,a.width,a.height);z.canvas=a;z.width=a.width;z.height=a.height;d.clearColor(0,0,0,1);d.clearDepth(1);d.enable(d.DEPTH_TEST);d.depthFunc(d.LEQUAL)}catch(B){}if(!d)return null}else d=a;z.gl=d;z.CoreShader_vs=c;z.CoreShader_fs=m;d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);for(c=g.enums.light.type.NULL;c<f.light.type.MAX;c++)e.ShaderPool[c]=[];m=new e.Texture;a=new e.Material;for(c=
0;c<f.texture.map.MAX;c++)c!==f.texture.map.BUMP&&a.setTexture(m,c);a.opacity=0.5;for(c=1;;){if(!a.use(f.light.type.POINT,c)||c===8){e.MAX_LIGHTS=c;break}c++}a=z.emptyLight=new e.Light(f.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;o("Calibrated maximum lights per pass to: "+c);for(c=f.light.type.NULL;c<f.light.type.MAX;c++)e.ShaderPool[c]=[];if(z.resizeList.length){h.addEventListener("resize",function(){e.GLCore.onResize()},false);z.resize_active=true}return d},
addResizeable:function(a){e.GLCore.resizeList.push(a)},onResize:function(){var a=h.innerWidth,c=h.innerHeight;if(z.fixed_size!==null){a=e.GLCore.fixed_size[0];c=e.GLCore.fixed_size[1]}for(var g=0,m=e.GLCore.resizeList.length;g<m;g++)z.resizeElement(e.GLCore.resizeList[g],a,c)},setFixedAspect:function(a){e.GLCore.fixed_aspect=a},setFixedSize:function(a,c){e.GLCore.fixed_size=[a,c]},getCanvas:function(){return e.GLCore.canvas},resizeElement:function(a,c,g){var m=z.gl;if(z.fixed_aspect!==0){var o=c*
(1/e.GLCore.fixed_aspect);if(o>g){o=g;c=g*e.GLCore.fixed_aspect}g=o}if(a.getContext!==n){a.width=c;a.height=g;if(!e.GLCore.fixed_size){a.style.left=(h.innerWidth/2-c/2|0)+"px";a.style.top=(h.innerHeight/2-g/2|0)+"px";a.style.position="absolute"}m.viewport(0,0,c,g)}else a.resize(c,g)},setDepthAlpha:function(a,c,g){z.depth_alpha=a;z.depth_alpha_near=c;z.depth_alpha_far=g},setDefaultFilter:function(a){z.default_filter=s(e.enums.texture.filter,a)},setSoftShadows:function(a){z.soft_shadow=a},setFog:function(a){z.fog_enabled=
a},setFogExp:function(a,c){z.fog_enabled=true;z.fogLinear=false;z.fogExp=true;z.fogColor=a;z.fogDensity=c},setNoise:function(a){z.fogNoise=a},setFogLinear:function(a,c,g){z.fog_enabled=true;z.fogExp=false;z.fogLinear=true;z.fogColor=a;z.fogNear=c;z.fogFar=g},setCanvasSizeFactor:function(a){z.canvasSizeFactor=a},setQuality:function(a){a=s(r.quality,a);if(a===r.quality.HIGH)e.features=t;else if(a===r.quality.MEDIUM)e.features=f;else if(a===r.quality.LOW)e.features=d;e.quality=a;return e.features},getQuality:function(){return e.features}},
F=function(a,c,g){for(var m,o=y.getElementsByTagName("script"),d=0;d<o.length;++d){var r=o[d];if(r.getAttribute("data-cubicvr")){var b=r.getAttribute("src");if(b){var f=new XMLHttpRequest;f.open("GET",b,false);f.send(null);if(f.status===200||f.status===0)r.text=f.responseText}}}if(typeof a==="object")if(a.getContext)m=a;else{m=a.canvas;c=a.vertexShader||c;g=a.fragmentShader||g}else if(a){a[0]=="#"&&(a=a.substr(1));m=y.getElementById(a)}for(var t in B){var a=B[t](e),v;for(v in a)a.hasOwnProperty(v)&&
(e[v]=a[v])}z.init(m,c,g);return z.gl};e.GLCore=z;e.init=F;e.start=function(a,c,g,m,o){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=n);g=g||"Sorry, your browser does not appear to support WebGL :-(";if(a=F(a,m,o)){c&&typeof c==="function"&&c(a,e.getCanvas());return a}if(!a){g&&typeof g==="function"?g():alert(g);return false}};e.addResizeable=z.addResizeable;e.setFixedAspect=z.setFixedAspect;e.setFixedSize=z.setFixedSize;e.setCanvasSizeFactor=z.setCanvasSizeFactor;e.getCanvas=z.getCanvas;e.enums=
r;e.IdentityMatrix=v;e.Textures=e.Textures;e.Textures_obj=e.Textures_obj;e.Images=e.Images;e.globalAmbient=[0.1,0.1,0.1];e.setGlobalAmbient=function(a){e.globalAmbient=a};e.setGlobalDepthAlpha=z.setDepthAlpha;e.setDefaultFilter=z.setDefaultFilter;e.setSoftShadows=z.setSoftShadows;e.setQuality=z.setQuality;e.getQuality=z.getQuality;e.RegisterModule=g.RegisterModule;e.getScriptLocation=g.getScriptLocation;e.setFogExp=z.setFogExp;e.setFogLinear=z.setFogLinear;e.setFogNoise=z.setFogNoise;e.parseEnum=
s};g.init=function(a,c,e){var m;a&&(a.context&&"string"===typeof a.context)&&(m=a.context);m=new t(m);if(m.context)return g.contexts[m.context]=m,m.init(a,c,e),m;h.CubicVR=g=m;m.init(a,c,e);return m.GLCore.gl};g.start=function(a,c,e,m,o){var d=new t;h.CubicVR=g=d;d.start(a,c,e,m,o);return d};g.RegisterModule=function(a,c){B[a]=c};g.getScriptLocation=function(){return b};g.enums=r})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(h){function y(a){return this.clearStack(a)}function w(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}var q=h.undef,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],s=Math.PI/2,b={length:function(a){var c=a[0],d=a[1],a=a[2];return Math.sqrt(c*c+d*d+a*a)},normalize:function(a){var c=a[0],d=a[1],e=a[2];
return(c=Math.sqrt(c*c+d*d+e*e))?[a[0]/c,a[1]/c,a[2]/c]:[0,0,0]},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},angle:function(a,c){return Math.acos((a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(c[0]*c[0]+c[1]*c[1]+c[2]*c[2])))},cross:function(a,c){return[a[1]*c[2]-c[1]*a[2],a[2]*c[0]-c[2]*a[0],a[0]*c[1]-c[0]*a[1]]},multiply:function(a,c){return[a[0]*c,a[1]*c,a[2]*c]},add:function(a,c){return[a[0]+c[0],a[1]+c[1],a[2]+c[2]]},subtract:function(a,c){return[a[0]-
c[0],a[1]-c[1],a[2]-c[2]]},equal:function(a,c,d){d===q&&(d=1.0E-7);return a===q&&c===q?!0:a===q||c===q?!1:Math.abs(a[0]-c[0])<d&&Math.abs(a[1]-c[1])<d&&Math.abs(a[2]-c[2])<d},moveViewRelative:function(a,c,d,e,g){var o=Math.atan2(e,d),c=Math.atan2(c[2]-a[2],c[0]-a[0]),d=Math.sqrt(d*d+e*e),o=c+o+s;return"object"===typeof g?[g[0]+d*Math.cos(o),g[1],g[2]+d*Math.sin(o)]:[a[0]+d*Math.cos(o),a[1],a[2]+d*Math.sin(o)]},trackTarget:function(a,c,d,e){var c=b.subtract(c,a),g=b.length(c),o;o=b.normalize(c);o=
b.multiply(o,d*(1/(1/(g-e))));g>e?a=b.add(a,o):g<e?(o=b.normalize(c),o=b.multiply(o,d*(1/(1/Math.abs(g-e)))),a=b.subtract(a,o)):a=[a[0],a[1]+o[2],a[2]];return a},getClosestTo:function(a,c,d){c=b.subtract(c,a);d=b.subtract(d,a);return b.add(b.multiply(c,b.dot(c,d)/b.dot(c,c)),a)},linePlaneIntersect:function(a,c,d,e){var g=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2],c=a[0]*(e[0]-d[0])+a[1]*(e[1]-d[1])+a[2]*(e[2]-d[2]);if(0.0010>Math.abs(c))return!1;a=-(g+a[0]*d[0]+a[1]*d[1]+a[2]*d[2])/c;return[d[0]+a*(e[0]-d[0]),
d[1]+a*(e[1]-d[1]),d[2]+a*(e[2]-d[2])]}},f={lookat:function(a,c,d,e,g,o,m,r,f){var v=[],t=[],A=[],t=[];v[0]=e-a;v[1]=g-c;v[2]=o-d;A[0]=m;A[1]=r;A[2]=f;v=b.normalize(v);t=b.cross(v,A);t=b.normalize(t);A=b.cross(t,v);t=[t[0],A[0],-v[0],0,t[1],A[1],-v[1],0,t[2],A[2],-v[2],0,0,0,0,1];e=new h.Transform(t);e.translate([-a,-c,-d]);return e.getResult()},multiply:function(a,c,d){d===q&&(d=[]);d[0]=a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12]*c[3];d[1]=a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13]*c[3];d[2]=a[2]*c[0]+a[6]*c[1]+
a[10]*c[2]+a[14]*c[3];d[3]=a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+a[15]*c[3];d[4]=a[0]*c[4]+a[4]*c[5]+a[8]*c[6]+a[12]*c[7];d[5]=a[1]*c[4]+a[5]*c[5]+a[9]*c[6]+a[13]*c[7];d[6]=a[2]*c[4]+a[6]*c[5]+a[10]*c[6]+a[14]*c[7];d[7]=a[3]*c[4]+a[7]*c[5]+a[11]*c[6]+a[15]*c[7];d[8]=a[0]*c[8]+a[4]*c[9]+a[8]*c[10]+a[12]*c[11];d[9]=a[1]*c[8]+a[5]*c[9]+a[9]*c[10]+a[13]*c[11];d[10]=a[2]*c[8]+a[6]*c[9]+a[10]*c[10]+a[14]*c[11];d[11]=a[3]*c[8]+a[7]*c[9]+a[11]*c[10]+a[15]*c[11];d[12]=a[0]*c[12]+a[4]*c[13]+a[8]*c[14]+a[12]*c[15];
d[13]=a[1]*c[12]+a[5]*c[13]+a[9]*c[14]+a[13]*c[15];d[14]=a[2]*c[12]+a[6]*c[13]+a[10]*c[14]+a[14]*c[15];d[15]=a[3]*c[12]+a[7]*c[13]+a[11]*c[14]+a[15]*c[15];return d},vec4_multiply:function(a,c,d){d===q&&(d=[]);d[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12]*a[3];d[1]=c[1]*a[0]+c[5]*a[1]+c[9]*a[2]+c[13]*a[3];d[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14]*a[3];d[3]=c[3]*a[0]+c[7]*a[1]+c[11]*a[2]+c[15]*a[3];return d},vec3_multiply:function(a,c,d){d===q&&(d=[]);d[0]=c[0]*a[0]+c[4]*a[1]+c[8]*a[2]+c[12];d[1]=c[1]*a[0]+
c[5]*a[1]+c[9]*a[2]+c[13];d[2]=c[2]*a[0]+c[6]*a[1]+c[10]*a[2]+c[14];return d},perspective:function(a,c,d,e){a=Math.tan(a*Math.PI/360);return[1/(a*c),0,0,0,0,1/a,0,0,0,0,-(e+d)/(e-d),-1,0,0,-(2*e*d)/(e-d),0]},ortho:function(a,c,d,e,g,o){return[2/(c-a),0,0,0,0,2/(e-d),0,0,0,0,-2/(o-g),0,-(a+c)/(c-a),-(e+d)/(e-d),-(o+g)/(o-g),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+
(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var c=[],d=a[0],e=a[1],g=a[2],o=a[4],m=a[5],r=a[6],b=a[8],f=a[9],a=a[10],t=a*m-r*f,A=-a*o+r*b,h=f*o-m*b,q=d*t+e*A+g*h;if(!q)return null;q=1/q;c[0]=t*q;c[1]=(-a*e+g*f)*q;c[2]=(r*e-g*m)*q;c[3]=A*q;c[4]=
(a*d-g*b)*q;c[5]=(-r*d+g*o)*q;c[6]=h*q;c[7]=(-f*d+e*b)*q;c[8]=(m*d-e*o)*q;return c},inverse:function(a,c){var d=a[0]*a[5]-a[1]*a[4],e=a[0]*a[6]-a[2]*a[4],g=a[0]*a[7]-a[3]*a[4],o=a[1]*a[6]-a[2]*a[5],m=a[1]*a[7]-a[3]*a[5],r=a[2]*a[7]-a[3]*a[6],b=a[8]*a[13]-a[9]*a[12],f=a[8]*a[14]-a[10]*a[12],t=a[8]*a[15]-a[11]*a[12],A=a[9]*a[14]-a[10]*a[13],h=a[9]*a[15]-a[11]*a[13],n=a[10]*a[15]-a[11]*a[14],s=d*n-e*h+g*A+o*t-m*f+r*b;return 0!==s?(c===q&&(c=[]),c[0]=0+a[5]*n-a[6]*h+a[7]*A,c[4]=0-a[4]*n+a[6]*t-a[7]*f,
c[8]=0+a[4]*h-a[5]*t+a[7]*b,c[12]=0-a[4]*A+a[5]*f-a[6]*b,c[1]=0-a[1]*n+a[2]*h-a[3]*A,c[5]=0+a[0]*n-a[2]*t+a[3]*f,c[9]=0-a[0]*h+a[1]*t-a[3]*b,c[13]=0+a[0]*A-a[1]*f+a[2]*b,c[2]=0+a[13]*r-a[14]*m+a[15]*o,c[6]=0-a[12]*r+a[14]*g-a[15]*e,c[10]=0+a[12]*m-a[13]*g+a[15]*d,c[14]=0-a[12]*o+a[13]*e-a[14]*d,c[3]=0-a[9]*r+a[10]*m-a[11]*o,c[7]=0+a[8]*r-a[10]*g+a[11]*e,c[11]=0-a[8]*m+a[9]*g-a[11]*d,c[15]=0+a[8]*o-a[9]*e+a[10]*d,d=1/s,c[0]*=d,c[1]*=d,c[2]*=d,c[3]*=d,c[4]*=d,c[5]*=d,c[6]*=d,c[7]*=d,c[8]*=d,c[9]*=d,
c[10]*=d,c[11]*=d,c[12]*=d,c[13]*=d,c[14]*=d,c[15]*=d,c):null},identity:function(a){if(a==q)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,c,d,e){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1];if(e===q)return a;f.multiply(e.slice(0),a,e)},rotateAxis:function(a,c,d,e,g){var o=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),c=[a+c*c*(1-a),c*d*(1-a)-e*o,c*e*(1-a)+d*o,0,d*c*
(1-a)+e*o,a+d*d*(1-a),d*e*(1-a)-c*o,0,e*c*(1-a)-d*o,e*d*(1-a)+c*o,a+e*e*(1-a),0,0,0,0,1];if(g===q)return c;f.multiply(g.slice(0),c,g)},rotate:function(a,c,d,e){var g;e===q&&(e=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==d&&(g=Math.sin(d*(Math.PI/180)),d=Math.cos(d*(Math.PI/180)),f.multiply(e.slice(0),[d,g,0,0,-g,d,0,0,0,0,1,0,0,0,0,1],e));0!==c&&(g=Math.sin(c*(Math.PI/180)),d=Math.cos(c*(Math.PI/180)),f.multiply(e.slice(0),[d,0,-g,0,0,1,0,0,g,0,d,0,0,0,0,1],e));0!==a&&(g=Math.sin(a*(Math.PI/180)),d=Math.cos(a*
(Math.PI/180)),f.multiply(e.slice(0),[1,0,0,0,0,d,g,0,0,-g,d,0,0,0,0,1],e));return e},scale:function(a,c,d,e){if(e===q)return[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1];f.multiply(e.slice(0),[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1],e)},transform:function(a,c,d){var e=f.identity();a&&f.translate(a[0],a[1],a[2],e);c&&(0===c[0]&&0===c[1]&&0===c[2]||f.rotate(c[0],c[1],c[2],e));d&&(1===d[0]&&1===d[1]&&1===d[2]||f.scale(d[0],d[1],d[2],e));return e}};y.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,
0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=h.mat4;if(!this.c_stack)return this.m_stack[0];var c=n;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var d=this.valid;d<this.c_stack+1;d++)c=a.multiply(c,this.m_stack[d]),this.m_cache[d]=c;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},
pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:n;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==q?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,c,d){var e=h.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var g=this.getIdentity();g[12]=a;g[13]=c;g[14]=d;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],
g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,c,d){var e=h.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var g=this.getIdentity();g[0]=a;g[5]=c;g[10]=d;this.m_stack[this.c_stack]=e.multiply(this.m_stack[this.c_stack],g);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,c,d,e){var g=h.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var o,m;if(c||
d||e)o=Math.sin(-a*(Math.PI/180)),m=Math.cos(-a*(Math.PI/180));c&&(a=this.getIdentity(),a[5]=m*c,a[9]=o*c,a[6]=-o*c,a[10]=m*c,this.m_stack[this.c_stack]=g.multiply(a,this.m_stack[this.c_stack]));d&&(c=this.getIdentity(),c[0]=m*d,c[8]=-o*d,c[2]=o*d,c[10]=m*d,this.m_stack[this.c_stack]=g.multiply(c,this.m_stack[this.c_stack]));e&&(d=this.getIdentity(),d[0]=m*e,d[4]=o*e,d[1]=-o*e,d[5]=m*e,this.m_stack[this.c_stack]=g.multiply(d,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;
return this}};w.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var c=1+a[0]+a[5]+a[10],d,e,g;1.0E-8<c?(d=2*Math.sqrt(c),c=(a[9]-a[6])/d,e=(a[2]-a[8])/d,g=(a[4]-a[1])/d,a=0.25*d):a[0]>a[5]&&a[0]>a[10]?(d=2*Math.sqrt(1+a[0]-a[5]-a[10]),c=0.25*d,e=(a[4]+a[1])/d,g=(a[2]+a[8])/d,a=(a[9]-a[6])/d):a[5]>a[10]?(d=2*Math.sqrt(1+a[5]-a[0]-
a[10]),c=(a[4]+a[1])/d,e=0.25*d,g=(a[9]+a[6])/d,a=(a[2]-a[8])/d):(d=2*Math.sqrt(1+a[10]-a[0]-a[5]),c=(a[2]+a[8])/d,e=(a[9]+a[6])/d,g=0.25*d,a=(a[4]-a[1])/d);this.x=c;this.y=e;this.z=g;this.w=a},fromEuler:function(a,c,d){var e=Math.cos(Math.PI/180*c/2),c=Math.sin(Math.PI/180*c/2),g=Math.cos(Math.PI/180*d/2),d=Math.sin(Math.PI/180*d/2),o=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),m=e*g,r=c*d;this.w=m*o-r*a;this.x=m*a+r*o;this.y=c*g*o+e*d*a;this.z=e*d*o-c*g*a},toEuler:function(){var a=this.w*
this.w,c=this.x*this.x,d=this.y*this.y,e=this.z*this.z,g=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-c-d+e+a),o=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),c-d-e+a);return[g,o,a]},multiply:function(a,c){c===q&&(c=a,a=this);return new w(a.x*c.w+a.w*c.x+a.y*c.z-a.z*c.y,a.y*c.w+a.w*c.y+a.z*c.x-a.x*c.z,a.z*c.w+a.w*c.z+a.x*c.y-a.y*c.x,a.w*c.w-a.x*c.x-a.y*c.y-a.z*c.z)}};return{vec2:{equal:function(a,c,d){d===q&&(d=1.0E-8);
return a===q&&c===q?!0:a===q||c===q?!1:Math.abs(a[0]-c[0])<d&&Math.abs(a[1]-c[1])<d}},vec3:b,mat3:{transpose_inline:function(a){var c=a[1],d=a[2],e=a[5];a[1]=a[3];a[2]=a[6];a[3]=c;a[5]=a[7];a[6]=d;a[7]=e},vec3_multiply:function(a,c,d){d===q&&(d=[]);d[0]=c[0]*a[0]+c[3]*a[1]+c[6]*a[2];d[1]=c[1]*a[0]+c[4]*a[1]+c[7]*a[2];d[2]=c[2]*a[0]+c[5]*a[1]+c[8]*a[2];return d}},mat4:f,aabb:{engulf:function(a,c){a[0][0]>c[0]&&(a[0][0]=c[0]);a[0][1]>c[1]&&(a[0][1]=c[1]);a[0][2]>c[2]&&(a[0][2]=c[2]);a[1][0]<c[0]&&(a[1][0]=
c[0]);a[1][1]<c[1]&&(a[1][1]=c[1]);a[1][2]<c[2]&&(a[1][2]=c[2])},reset:function(a,c){void 0===c&&(c=[0,0,0]);a[0][0]=c[0];a[0][1]=c[1];a[0][2]=c[2];a[1][0]=c[0];a[1][1]=c[1];a[1][2]=c[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,c){var d=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3];return 0>d?-1:0<d?1:0},normalize:function(a){var c=Math.sqrt(a[0]*
a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=c;a[1]/=c;a[2]/=c;a[3]/=c}},sphere:{intersects:function(a,c){var d=h.vec3.subtract([a[0],a[1],a[2]],[c[0],c[1],c[2]]),d=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]),e=a[3]+c[3];return d*d<e*e?!0:!1}},triangle:{normal:function(a,c,d,e){e===q&&(e=[]);var g=a[0]-c[0],o=a[1]-c[1],a=a[2]-c[2],m=c[0]-d[0],r=c[1]-d[1],c=c[2]-d[2];e[0]=o*c-a*r;e[1]=a*m-g*c;e[2]=g*r-o*m;return e}},Transform:y,Quaternion:w}});
CubicVR.RegisterModule("Utility",function(h){var y=h.undef,w=h.log,q={},n={},s={multiSplit:function(b,f){for(var a=b.split(f[0]),c=1,d=f.length;c<d;c++)for(var e=f[c],g=0,o=a.length;g<o;g++){var m=a[g].trim().split(e),r=!0;if(1<m.length)for(var B=0;B<m.length;B++)""!==m[B].trim()&&(a.splice(g+B,0===B?1:0,m[B]),B&&o++,r=!1);else a[g]=a[g].trim().replace(e,""),""!==a[g]&&(r=!1);r&&(a.splice(g,1),o--,g--)}return a},getJSONScriptObj:function(b,f){if("string"===typeof b&&0<b.length&&"#"===b.charAt(0)){var a=
document.getElementById(b.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),f&&f(a),a}return b},getScriptContents:function(b){var f=document.getElementById(b),a="",c="";if(f){if(""!==f.src||f.attributes.srcUrl!==y)c=""!==f.src?f.src:f.attributes.srcUrl.value}else c=b;if(0!==c.length){if(b=new XMLHttpRequest,b.overrideMimeType&&b.overrideMimeType("application/json"),b.open("GET",c,!1),b.send(null),200===b.status||0===b.status)a=b.responseText}else for(c=f.firstChild;c;)3===c.nodeType&&(a+=c.textContent),
c=c.nextSibling;return a},xmlNeedsBadgerFish:function(b){for(b=[b];b.length;){var f=b.pop();if(f.attributes&&f.attributes.length)return!0;for(var a=0,c=f.childNodes.length;a<c;a++)b.push(f.childNodes[a])}return!1},getFirstEntry:function(b){for(var f in b)if(b.hasOwnProperty(f))return b[f]},getURIFileType:function(b){function f(a){for(var c in d)if(d.hasOwnProperty(c)&&-1!==d[c].indexOf(a))return c;return y}var a=b.toLowerCase(),c=["_ext","ext"],d={json:["js","javascript","json"],xml:["xml"]};if(-1!==
a.indexOf("?")){var e=a.split("?"),a=e[0];if(e[1])for(var e=-1===e[1].indexOf("&")?[e[1]]:e[1].split("&"),g=0,o=e.length;g<o;g++){var m=e[g];if(-1!==m.indexOf("=")&&(m=m.split("="),-1!==c.indexOf(m[0]))){var r=f(m[1]);if(r)return r;w("Unable to determine extension type '"+m[1]+"' provided for URI: ["+b+"], falling back to filename part.")}}}return-1!==a.indexOf(".")?(b=a.split("."),f(b[b.length-1])):y},get:function(b,f){var a=null,c=null,d=null,f=f||null;if(b===y)return y;if(isFinite(b))return b;
"function"===typeof b&&(b=b(f));if("object"===typeof b)return f&&!(b instanceof f)?new f(b):b;if("string"==typeof b){if(-1!==b.indexOf("\n"))return b;"#"==b[0]&&(a=b.substr(1),(d=document.getElementById(a))&&(c=d.src||null));!d&&(!a&&!c&&b)&&(c=b)}if(d&&!c)return CubicVR.util.collectTextNode(d);if(c){var a=null,e=n[c]||null;if(!e){var g=s.getURIFileType(c);if(g===y&&!d)return c;"json"===g?e=CubicVR.util.getJSON(c):a="xml"===g?CubicVR.util.getXML(c):CubicVR.util.getURL(c);a&&a.childNodes?e=s.getFirstEntry(s.xml2json(a)):
a&&(e=a)}e&&n[c]===y&&(n[c]=e);if(f){if(q[c]&&q[c]instanceof f)return q[c];if(e)return q[c]=new f(e),q[c]}else if(e)return e;return c}a&&!d&&console.log("Unable to retrieve requested ID: '"+b+"'");return y},clearCache:function(){q={};n={}},getURL:function(b){try{var f=new XMLHttpRequest;f.open("GET",b,!1);f.send(null);if(200===f.status||0===f.status){if(f.responseText.length)return f.responseText;if(f.responseXML)return f.responseXML}}catch(a){alert(b+" failed to load.")}return null},getXML:function(b){try{var f=
new XMLHttpRequest;f.open("GET",b,!1);f.overrideMimeType("application/xml");f.send(null);if(200===f.status||0===f.status)return f.responseXML}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},getJSON:function(b){try{var f=new XMLHttpRequest;f.open("GET",b,!1);f.overrideMimeType("application/json");f.send(null);if(200===f.status||0===f.status)return eval("("+f.responseText+")")}catch(a){try{alert(b+" failed to load.")}catch(c){throw a;}}return null},repackArray:function(b,f,
a){b.length!==parseInt(f,10)*parseInt(a,10)&&w("array repack error, data size !== stride*count: data.length="+b.length+" stride="+f+" count="+a);for(var a=[],c=0,d=0,e=b.length;d<e;d++){var g=d%f;0===g&&(a[c]=[]);a[c][g]=b[d];g===f-1&&c++}return a},collectTextNode:function(b){if(!b)return"";for(var f="",b=b.childNodes,a=0,c=b.length;a<c;a++)f+=b[a].nodeValue;return f},floatDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<
d;c++)a[c]=parseFloat(a[c]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<d;c++)a[c]=parseInt(a[c],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(b,f){"\n"!=f&&(b=b.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=b.split(f?f:","),c=0,d=a.length;c<d;c++)a[c]=a[c];return a},xmlstring2json:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,a,c=[],d=[],e={},g=e,o=0,m=b.length;o<m;o++){var r=b[o];if(!(f.test(r)||""===r)&&!/<\?\s?xml[^>]*>/.test(r))if(/<.*?>/.test(r)){a=r.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]&&(r=a.split(" "),a=r[0],r=r.slice(1).join(" "),c.push(a),d.push(e),e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:(e[a]||(e[a]={}),e=e[a]),e instanceof Array&&(e.push({}),e=e[e.length-1]),"/"===a.substr(a.length-1)||"/"===r.substr(r.length-1)))a="/"+a;if("/"===a[0]){a=
a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;c.pop();e=d.length?d[d.length-1]:null;d.pop()}}else{var B=d[d.length-1][a];B instanceof Array?(B.pop(),B.push(s.parseNumeric(r))):d[d.length-1][a]=s.parseNumeric(r)}}return g},xmlstring2badgerfish:function(b){for(var b=b.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),f=/^\s+$/gm,a,c=[],d=[],e={},g=e,o=0,m=b.length;o<m;o++)if(a=b[o],!(f.test(a)||""===a)&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=
a.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]){var r=a.split(" ");a=r[0];r=r.slice(1).join(" ");c.push(a);d.push(e);e[a]&&!(e[a]instanceof Array)?e[a]=[e[a]]:e[a]||(e[a]={});e=e[a];e instanceof Array&&(e.push({}),e=e[e.length-1]);if("/"===a.substr(a.length-1)||"/"===r.substr(r.length-1))a="/"+a;for(var r=s.multiSplit(r,"= "),B="",v=0;v<r.length;v++){var t=r[v];"/"===t[t.length-1]&&(t=t.substr(0,t.length-1));if(1===v%2){if("'"===t[0]||'"'===t[0]){for(var A=t[0],t=t.substr(1);t[t.length-1]!==A&&r.length+
1<v;)t+=r.splice(v+1,1);t[t.length-1]===A&&(t=t.substr(0,t.length-1))}e["@"+B]=t}else B=t}}if("/"===a[0]){a=a.substr(1);if(c.length&&c[c.length-1]!==a)return console.log("Unmatched tag, aborting: "+c[c.length-1]),!1;c.pop();e=d.length?d[d.length-1]:null;d.pop()}}else e.$=a;return g},xml2badgerfish:function(b){var f={},a=[],c,d,e,g,o,m=/^\s+|\s+$/g;b.jsonParent=f;for(a.push(b);a.length;){d=a.pop();var r=null;e=d.jsonParent;b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],o=g.tagName,o!==y&&
(r=r||{},r[o]=r[o]||0,r[o]++);if(d.attributes&&d.attributes.length){b=0;for(c=d.attributes.length;b<c;b++)g=d.attributes[b],e["@"+g.name]=g.value}b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],o=g.tagName,1===g.nodeType?(1<r[o]?(e[o]=e[o]||[],e[o].push({}),g.jsonParent=e[o][e[o].length-1]):(e[o]=e[o]||{},g.jsonParent=e[o]),a.push(g)):3===g.nodeType&&""!==g.nodeValue.replace(m,"")&&(e.$=e.$||"",e.$+=g.nodeValue)}return f},isTextNode:function(b){for(var b=b.childNodes,f=0,a=b.length;f<a;f++)if(3!==
b[f].nodeType||b[f].childNodes.length)return!1;return!0},parseNumeric:function(b){var f=null,a,f=b.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===f)return f;if((-1!==f.indexOf(" ")||-1!==f.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(f))if(/[^0-9\-\+]+/g.test(f))if(/[^0-9\- ]+/g.test(f))if(/[^0-9\-,]+/g.test(f))if(/[^0-9\.e\-\+ ]+/g.test(f))if(/[^0-9\.,e\+\-]+/g.test(f))if(/[^0-9,\-\+ ]+/g.test(f)){if(!/[^0-9\.,e\-\+ ]+/g.test(f)){f=f.split(" ");
b=0;for(a=f.length;b<a;b++)f[b]=s.floatDelimArray(f[b],",");return f}}else{f=f.split(" ");b=0;for(a=f.length;b<a;b++)f[b]=s.intDelimArray(f[b],",");return f}else return s.floatDelimArray(f,",");else return s.floatDelimArray(f," ");else return s.intDelimArray(f,",");else return s.intDelimArray(f," ");else return parseInt(f,10);a=parseFloat(f);return!isNaN(a)?/[^0-9\-\+]+/g.test(f)?a:parseInt(f,10):b},xml2json:function(b){var f={},a=[],c,d,e,g,o;b.jsonParent=f;for(a.push(b);a.length;){d=a.pop();var m=
null;e=d.jsonParent;b=0;for(c=d.childNodes.length;b<c;b++)g=d.childNodes[b],o=g.tagName,o!==y&&(m=m||{},m[o]=m[o]||0,m[o]++);b=0;for(c=d.childNodes.length;b<c;b++){g=d.childNodes[b];o=g.tagName;var r=s.isTextNode(g);1===g.nodeType&&(1<m[o]?(e[o]=e[o]||[],r?e[o].push(s.parseNumeric(s.collectTextNode(g))):(e[o].push({}),g.jsonParent=e[o][e[o].length-1])):r?e[o]=s.parseNumeric(s.collectTextNode(g)):(e[o]=e[o]||{},g.jsonParent=e[o]),r||a.push(g))}}return f}};return{util:s,get:s.get,clearCache:s.clearCache}});
CubicVR.RegisterModule("Shader",function(h){function y(e,g){var o=h.util,m,d,f,v,t=n.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==e.indexOf("\n")?(f=e,m=a(n.gl,e,"x-shader/x-vertex")):(m=c(n.gl,e),null===m&&(f=o.getURL(e),m=a(n.gl,f,"x-shader/x-vertex")));t.getShaderParameter(m,t.COMPILE_STATUS)||(this.vertexLog=t.getShaderInfoLog(m),this.success=!1);-1!==g.indexOf("\n")?(v=g,d=a(n.gl,g,"x-shader/x-fragment")):(d=c(n.gl,
g),null===d&&(v=o.getURL(g),d=a(n.gl,v,"x-shader/x-fragment")));t.getShaderParameter(d,t.COMPILE_STATUS)||(this.fragmentLog=t.getShaderInfoLog(d),this.success=!1);this.success?(this.shader=t.createProgram(),t.attachShader(this.shader,m),t.attachShader(this.shader,d),t.linkProgram(this.shader),n.gl.getProgramParameter(this.shader,t.LINK_STATUS)||(b("Error linking shader:\n"+t.getProgramInfoLog(this.shader)),this.success=!1)):(m=o.multiSplit(this.vertexLog,";\n"),o=o.multiSplit(this.fragmentLog,";\n"),
m.length&&this.dumpErrors(m,f),o.length&&this.dumpErrors(o,v))}function w(a){this._update=a.update||null;this._init=a.init||null;this._vertex=h.get(a.vertex)||null;this._fragment=h.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var q=h.undef,n=h.GLCore,s=h.enums,b=h.log,f=h.util;s.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,c,d){if("x-shader/x-fragment"===d)d=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===d)d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,c);a.compileShader(d);return d},c=function(a,c){var d=document.getElementById(c);if(!d)return null;for(var m="",r=d.firstChild;r;)3===r.nodeType&&(m+=r.textContent),
r=r.nextSibling;if("x-shader/x-fragment"===d.type)d=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===d.type)d=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(d,m);a.compileShader(d);return d};y.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,c,d){for(var d=(d||"Error on line")+" ",c=c.split("\n"),m=0,r=a.length;m<r;m++){var b=a[m];if(0===b.indexOf("ERROR: ")){var b=b.substr(7).trim(),f=b.substr(0,b.indexOf(" ")),b=b.substr(f.length),f=f.split(":"),
f=parseInt(f[1],10);console.log(f+"> "+c[f-1]);console.log(d+f+", :"+b)}}},bindSelf:function(a){var c,d,m;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),m=c[0],c=c[1].split("]"),d=c[0],c=c[1].split("."),c=c[1],this[m]===q&&(this[m]=[]),this[m][d]===q&&(this[m][d]={}),this[m][d][c]=this.uniforms[a]):(c=a.split("."),m=c[0],c=c[1],this[m]===q&&(this[m]={}),this[m][c]=this.uniforms[a]):-1!==a.indexOf("[")?(c=a.split("["),m=c[0],c=c[1].split("]"),d=c[0],this[m]===q&&(this[m]=[]),this[m][d]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,c){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setMatrix(a,c);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,c){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
c!==q&&this.setVector(a,c);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,c){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setFloat(a,c);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,c){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=s.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);c!==q&&this.setInt(a,c);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,c){var d=this.uniforms[a];if(null!==d){var m=c.length;16===m?n.gl.uniformMatrix4fv(d,!1,c):9===m?n.gl.uniformMatrix3fv(d,!1,c):4===
m&&n.gl.uniformMatrix2fv(d,!1,c)}},setInt:function(a,c){var d=this.uniforms[a];null!==d&&n.gl.uniform1i(d,c)},setFloat:function(a,c){var d=this.uniforms[a];null!==d&&n.gl.uniform1f(d,c)},setVector:function(a,c){var d=this.uniforms[a];if(null!==d){var m=c.length;3==m?n.gl.uniform3fv(d,c):2==m?n.gl.uniform2fv(d,c):n.gl.uniform4fv(d,c)}},clearArray:function(a){var c=n.gl,a=this.uniforms[a];null!==a&&c.disableVertexAttribArray(a)},bindArray:function(a,c){var d=n.gl,m=this.uniforms[a];if(null!==m){var r=
this.uniform_type[a];r===s.shader.uniform.ARRAY_VERTEX?(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(m,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(m)):r===s.shader.uniform.ARRAY_UV?(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(m,2,d.FLOAT,!1,0,0)):r===s.shader.uniform.ARRAY_FLOAT&&(d.bindBuffer(d.ARRAY_BUFFER,c),d.vertexAttribPointer(m,1,d.FLOAT,!1,0,0))}}};var d={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var c={},a=f.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var d=a[i];0===d.indexOf("#define")&&(d=d.split(" "),2<d.length&&(c[d[1]]=d.slice(2).join(" ")))}return c},replaceAll:function(a,c,d,m){var d=d||"",m=m||"",r;for(r in c)if(c.hasOwnProperty(r))for(var b=d+r+m;-1!==a.indexOf(b);)a=a.replace(b,d+c[r]+m);return a},getShaderInfo:function(a,c){var o,m,
r,b,v,t,A=["uniform","attribute","varying"],h=[],n={};t={};var s;c===q&&(c="");a=d.tidyScript(a);c=d.tidyScript(c);n.v_define=d.getDefines(a);n.f_define=d.getDefines(c);a=d.replaceAll(a,n.v_define,"[","]");c=d.replaceAll(c,n.f_define,"[","]");s=f.multiSplit(a+"\n"+c,"\n;");var u=[];b=r=-1;o=0;for(m=s.length;o<m;o++)v=s[o],-1===r&&0===v.indexOf("struct")?r=o:-1===b&&(-1!==r&&-1!==v.indexOf("}"))&&(b=o+1),-1!==r&&-1!==b&&(v=s.slice(r,b).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),u.push({start:r,end:b,struct:v.split("\n")}),b=r=-1);o=0;for(m=u.length;o<m;o++){var x=u[o].struct,w=null;r=0;for(b=x.length;r<b;r++)v=x[r].split(" "),1>=v.length||("struct"==v[0]?(w=v[1],t[w]={}):w&&(t[w][v[1]]=v[0]))}n.struct=t;o=0;for(m=A.length;o<m;o++)n[A[o]]=[];o=0;for(m=s.length;o<m;o++){v=s[o];r=0;for(b=A.length;r<b;r++)if(u=A[r],0===v.indexOf(u)&&(t=v.split(" "),3===t.length&&t[0]==u&&-1===h.indexOf(t[2])))if(h.push(t[2]),-1!==t[2].indexOf("[")){var x=t[2].split("["),
w=x[1].replace("]",""),z=parseInt(w,10);z===z&&(w=z);n[u].push({name:x[0],type:t[1],isArray:!0,len:w})}else n[u].push({name:t[2],type:t[1]})}return n},genShaderVarList:function(a,c){var d=a[c],m=[],r,b,f,t,A,h;if(!d)return[];r=0;for(b=d.length;r<b;r++){var n=d[r];if(a.struct[n.type]){var q=a.struct[n.type];if(q&&n.isArray){f=0;for(t=n.len;f<t;f++)for(h in A=n.name+"["+f+"]",q)q.hasOwnProperty(h)&&m.push({location:A+"."+h,type:q[h],basename:n.name})}else for(h in q)m.push({location:n.name+"."+h,type:q[h],
basename:n.name})}else if(n.isArray){f=0;for(t=n.len;f<t;f++)A=n.name+"["+f+"]",m.push({location:A,type:n.type,basename:n.name})}else m.push({location:n.name,type:n.type,basename:n.name})}return m},getShaderVars:function(a){var c={};c.uniform=d.genShaderVarList(a,"uniform");c.attribute=d.genShaderVarList(a,"attribute");return c}};w.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,c,o,m,r){o=o||[];a=h.util.get(a);c=h.util.get(c);r=r||"#define customShader_splice";if(m=m===q?this._vertex||this._fragment:m)m=a.indexOf(r),r=c.indexOf(r),-1!==m&&this._vertex&&(a=a.substr(0,m)+this._vertex),-1!==r&&this._fragment&&(c=c.substr(0,r)+this._fragment);this._shader=new h.Shader(a,c);this._shaderInfo=d.getShaderInfo(a,c);this._shaderVars=d.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",o);this._appendShaderVars(this._shaderVars,"attribute",o);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,c,d){for(var a=function(a,c){return function(g,e){e!==q&&(t.activeTexture(t.TEXTURE0+g),t.bindTexture(n.gl.TEXTURE_2D,h.Textures[e.tex_id]));c.value=g;a.update(c)}},m=0,r=this._shaderVars[c].length;m<r;m++){var b=this._shaderVars[c][m],f=b.location;if(-1===d.indexOf(b.basename)&&(b=b.type,"vec3"===b?"attribute"===c?this._shader.addVertexArray(f):
this._shader.addVector(f):"vec2"===b?"attribute"===c?this._shader.addUVArray(f):this._shader.addVector(f):"float"===b?"attribute"===c?this._shader.addFloatArray(f):this._shader.addFloat(f):"sampler2D"===b||"int"===b?this._shader.addInt(f):("mat4"===b||"mat3"===b||"mat2"===b)&&this._shader.addMatrix(f),f=this._bindSelf(f),"sampler2D"==b&&f)){var t=n.gl;f.set=a(this,f)}}},_bindSelf:function(a){var c,d,m,r;if(null!==this._shader.uniforms[a]){var b=function(a,c){return function(g){c.value=g;a.update(c)}};
-1!==a.indexOf(".")?-1!==a.indexOf("[")?(c=a.split("["),m=c[0],c=c[1].split("]"),d=c[0],c=c[1].split("."),c=c[1],this[m]===q&&(this[m]=[]),this[m][d]===q&&(this[m][d]={}),r={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[m][d][c]=r):(c=a.split("."),m=c[0],c=c[1],this[m]===q&&(this[m]={}),r={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[m][c]=r):-1!==a.indexOf("[")?(c=a.split("["),m=c[0],c=c[1].split("]"),d=c[0],this[m]===
q&&(this[m]=[]),r={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[m][d]=r):(r={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=r);this._bindings.push(r);r&&(r.set=b(this,r));return r}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var c=0,d=this._bindings.length;c<d;c++)this.update(this._bindings[c],a)},update:function(a){if(this._initialized){var c=n.gl,d=a.value,m=a.location;
null!==m&&(a.type===s.shader.uniform.MATRIX?(a=d.length,16===a?c.uniformMatrix4fv(m,!1,d):9===a?c.uniformMatrix3fv(m,!1,d):4===a&&c.uniformMatrix2fv(m,!1,d)):a.type===s.shader.uniform.INT?c.uniform1i(m,d):a.type===s.shader.uniform.VECTOR?(a=d.length,3===a?c.uniform3fv(m,d):2===a?c.uniform2fv(m,d):c.uniform4fv(m,d)):a.type===s.shader.uniform.FLOAT?c.uniform1f(m,d):a.type===s.shader.uniform.ARRAY_VERTEX?(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(m,3,c.FLOAT,!1,0,0),c.enableVertexAttribArray(m)):
a.type===s.shader.uniform.ARRAY_UV?(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(m,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(m)):a.type===s.shader.uniform.ARRAY_FLOAT&&(c.bindBuffer(c.ARRAY_BUFFER,d),c.vertexAttribPointer(m,1,c.FLOAT,!1,0,0),c.enableVertexAttribArray(m)))}}};return{Shader:y,shader_util:d,CustomShader:w}});
CubicVR.RegisterModule("MainLoop",function(h){function y(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function w(){null!==h.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(w),h.GLCore.mainloop.interval())}function q(a,c,d){window.requestAnimationFrame===s&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==h.GLCore.mainloop&&(!window.requestAnimationFrame&&h.GLCore.mainloop&&clearInterval(h.GLCore.mainloop.interval),h.GLCore.mainloop=null);if(null===a)h.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],g=new y;g.start();this.timer=g;this.func=a;this.doclear=c!==s?c:!0;h.GLCore.mainloop=this;f.resizeList.length&&!h.GLCore.resize_active&&(window.addEventListener("resize",
function(){h.GLCore.onResize()},!1),h.GLCore.resize_active=!0);c=function(){return function(){var c=h.GLCore.gl;g.update();h.GLCore.mainloop.doclear&&c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT);a(g,h.GLCore.gl);var m=e[e.length-1],d=m.scenes;m.update&&m.update(g,c);if(d){c=0;for(m=d.length;c<m;++c){var b=d[c];if(!b.paused){b.update&&b.update(g,h.GLCore.gl);b.render()}}}}}();d?this.loopFunc=c:window.requestAnimationFrame?(this.interval=c,window.requestAnimationFrame(w)):this.interval=setInterval(c,
20)}}function n(a,c,d){this.canvas=a;this.camera=c;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var g in b.keyboard)this.keyState[g]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,
e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var c=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];c[0]=a[0]-e.mpos[0];c[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,c,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,c=null;e.mEvents.keyPress?
(c=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=c!==s?!!c:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(c=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=c!==s?!!c:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,c,g){a.mdown&&a.orbitView(g)},mouseWheel:function(a,c,g){a.zoomView(g)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
!1!==d&&this.setEvents(d===s?this.eventDefaults:d);this.bind()}var s=h.undef,b=h.enums,f=h.GLCore;b.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};y.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(1E3*a|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};q.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var c=0;c<a.scenes.length;++c)a.scenes[c].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],c=0;c<a.scenes.length;++c)a.scenes[c].disable();1<this.renderStack.length&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var c=renderStack[renderStack.length-1],d,e=0,g=c.scenes.length;e<g;++e)if(c.scenes[e].scene.name===a){d=
c.scenes[e];break}return d},resumeScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var c=renderStack[renderStack.length-1];"string"===typeof a&&(a=this.getScene(a));var d=c.scenes.indexOf(a);-1<d&&c.scenes.splice(d,1);return a},runOnce:function(){this.loopFunc()}};n.prototype={isKeyPressed:function(a){return this.keyState[a]},setEvents:function(a){this.mEvents=
{};for(var c in a)this.bindEvent(c,a[c])},orbitView:function(a){var c=h.vec3,d=c.subtract(this.camera.target,this.camera.position),d=c.length(d);this.camera.position=c.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0);this.camera.position[1]+=d*a[1]/300;this.camera.position=c.add(this.camera.target,c.multiply(c.normalize(c.subtract(this.camera.position,this.camera.target)),d))},panView:function(a,c){var d=h.vec3;c||(c=!1);var e=d.subtract(this.camera.target,this.camera.position),
e=d.length(e),g=this.camera.position;c?this.camera.position=d.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,-e*a[1]/300):(this.camera.position=d.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0),this.camera.position[1]+=e*a[1]/300);e=d.subtract(this.camera.position,g);this.camera.target=d.add(this.camera.target,e)},zoomView:function(a,c,d){var e=h.vec3,g=e.subtract(this.camera.target,this.camera.position),g=e.length(g),g=g-a/1E3;c||(c=0.1);d||(d=1E3);g<
c&&(g=c);g>d&&(g=d);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),g))},bindEvent:function(a,c){this.mEvents[a]=c===s?this.eventDefaults[a]:c},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:y,MainLoop:q,MouseViewController:n,setMainLoop:function(a){h.GLCore.mainloop=a},keyboard:b.keyboard}});
CubicVR.RegisterModule("Texture",function(h){function y(a,c){if(1===a||1===c)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==c)for(;0===c%2;)c/=2;return 1<a||1<c?!1:!0}function w(a){var g=h.GLCore.gl;if("CANVAS"===a.nodeName||"IMG"===a.nodeName||"VIDEO"===a.nodeName)this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(void 0===a.width||void 0===a.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=
a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new h.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var d=this.canvasSource;(!d.height||!d.width)&&e("Warning - CanvasTexture input has no initial width and height, edges clamped.");!d.height||!d.width||!y(d.width,d.height)?(this.setFilter(c.texture.filter.LINEAR),g.texParameteri(g.TEXTURE_2D,
g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE)):(this.setFilter(c.texture.filter.LINEAR_MIP),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.REPEAT),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.REPEAT));"IMG"===a.nodeName&&this.update()}function q(a,g){if(!a)throw"PDF Texture Error: page is null.";var e=this,d=h.GLCore.gl,b=this.canvasSource=document.createElement("canvas"),o;b.mozOpaque=!0;b.width=g.width;b.height=g.height;o=this.canvasContext=
b.getContext("2d");o.save();o.fillStyle="rgb(255, 255, 255)";o.fillRect(0,0,b.width,b.height);o.restore();a.startRendering(o,function(){e.update()});this.texture=new h.Texture;this.updateFunction=g.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(b.width,b.height)?(this.setFilter(c.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function n(a,g,e){var d=h.GLCore.gl;this.texture=new h.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=g;this.canvas.height=e;this.pjs=new Processing(this.canvas,h.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;
this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(this.canvas.width,this.canvas.height)?this.setFilter(c.texture.filter.LINEAR_MIP):(this.setFilter(c.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function s(g,e,d){var b=a.gl;this.width=e;this.height=d;this.srcTex=g;this.outTex=new h.RenderBuffer(e,d);y(e,d);g=[1/e,1/
d,0];this.outputBuffer=new h.RenderBuffer(e,d,!1);this.fsQuad=h.fsQuad.make(e,d);shaderNMap=new h.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",g);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(b.TEXTURE0);this.setFilter(c.texture.filter.LINEAR);
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)}function b(g,e,d){var b=a.gl;this.width=g;this.height=e;this.outTex=new h.RenderBuffer(g,e,d);this.texture=this.outTex.texture;var o=y(g,e);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(b.TEXTURE0);o?(this.setFilter(c.texture.filter.LINEAR),
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT)):(this.setFilter(c.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE));this.dims=[g,e];this.depth=d?!0:!1}function f(a,c){this.scene=a;this.renderTex=new b(c?c.width:a.camera.width,c?c.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=h.GLCore,c=h.enums,d=h.undef,e=h.log;c.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var g=function(a,c){this.img_path=a;this.filter_type=c};g.prototype={getTexture:function(a,c){return new o(this.img_path,this.filter_type,a,c)}};var o=function(g,e,b,o,f){var A=
a.gl;this.tex_id=h.Textures.length;this.filterType=-1;this.onready=f;this.loaded=!1;h.Textures[this.tex_id]=A.createTexture();h.Textures_obj[this.tex_id]=this;g&&("string"===typeof g?h.Images[this.tex_id]=new Image:"object"===typeof g&&"IMG"===g.nodeName&&(h.Images[this.tex_id]=g),h.Textures_ref[g]=this.tex_id);A.bindTexture(A.TEXTURE_2D,h.Textures[this.tex_id]);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.LINEAR);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.LINEAR);if(g){var n=this.tex_id,
q=e!==d?e:a.default_filter,s=this;h.Images[this.tex_id].onload=function(){A.bindTexture(A.TEXTURE_2D,h.Textures[n]);A.pixelStorei(A.UNPACK_FLIP_Y_WEBGL,true);A.pixelStorei(A.UNPACK_COLORSPACE_CONVERSION_WEBGL,A.NONE);var a=h.Images[n];A.texImage2D(A.TEXTURE_2D,0,A.RGBA,A.RGBA,A.UNSIGNED_BYTE,a);if(a=y(a.width,a.height)){A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.REPEAT);A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.REPEAT)}else{A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE);
A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE)}if(h.Textures_obj[n].filterType===-1){if(a)q=c.texture.filter.LINEAR_MIP;else if(q===c.texture.filter.LINEAR_MIP)q=c.texture.filter.LINEAR;h.Textures_obj[n].filterType===-1&&h.Textures_obj[n].setFilter(q)}else h.Textures_obj[n].setFilter(h.Textures_obj[n].filterType);if(s.onready)s.onready();A.bindTexture(A.TEXTURE_2D,null);s.loaded=true};b?(h.Images[this.tex_id].deferredSrc=g,b.addImage(o,g,h.Images[this.tex_id])):"string"===typeof g&&
(h.Images[this.tex_id].src=g)}this.active_unit=-1};o.prototype={setFilter:function(a){if(-1<this.tex_id){var g=h.GLCore.gl;g.bindTexture(g.TEXTURE_2D,h.Textures[this.tex_id]);a===c.texture.filter.LINEAR?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR)):a===c.texture.filter.LINEAR_MIP?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR_MIPMAP_NEAREST),g.generateMipmap(g.TEXTURE_2D)):
a===c.texture.filter.NEAREST?(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST)):a===c.texture.filter.NEAREST_MIP&&(g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST_MIPMAP_LINEAR),g.generateMipmap(g.TEXTURE_2D));this.filterType=a}},use:function(c){-1<this.tex_id&&(a.gl.activeTexture(c),a.gl.bindTexture(a.gl.TEXTURE_2D,h.Textures[this.tex_id]),this.active_unit=
c)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=h.GLCore.gl;-1<this.tex_id&&h.Textures[this.tex_id]&&(a.deleteTexture(h.Textures[this.tex_id]),delete h.Textures_obj[this.tex_id],this.tex_id=-1)}};w.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=h.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===c.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};s.prototype={update:function(){var c=
a.gl,g=c.getParameter(c.VIEWPORT);this.outputBuffer.use();c.viewport(0,0,this.width,this.height);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.srcTex.use(c.TEXTURE0);h.fsQuad.render(this.shaderNorm,this.fsQuad);c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(g[0],g[1],g[2],g[3])}};b.prototype={begin:function(){var c=a.gl;this.dims=c.getParameter(c.VIEWPORT);this.outTex.use();c.viewport(0,0,this.width,this.height);this.depth?c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT)},
end:function(){var c=a.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};f.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:o,DeferredLoadTexture:g,CanvasTexture:w,PdfTexture:q,TextTexture:function(a,c){var g=c&&c.color||"#fff",e=c&&c.bgcolor,b=c&&c.font||"18pt Arial",o=c&&c.align||"start",f=c&&c.y||0,n=c&&c.width||d,q=c&&c.height||d,h,s=document.createElement("CANVAS"),
E=s.getContext("2d"),z=0,z="string"===typeof a?1:a.length;E.font=b;var y=c&&c.lineHeight||E.measureText("OO").width,H;if(1===z)H=E.measureText(a).width;else for(h=H=0;h<z;++h){var G=E.measureText(a[h]).width;G>H&&(H=G)}s.width=n||H;s.height=q||y*z;e&&(E.fillStyle=e,E.fillRect(0,0,s.width,s.height));E.fillStyle=g;E.font=b;E.textAlign=o;E.textBaseline="top";if(1===z)g=c&&c.x||"center"===o?s.width/2:"right"===o?s.width:0,E.fillText(a,g,f);else for(h=0;h<z;++h)g=c&&c.x||"center"===o?s.width/2:"right"===
o?s.width:0,E.fillText(a[h],g,f+h*y);E.fill();this.use=w.prototype.use;this.clear=w.prototype.clear;this.update=w.prototype.update;w.apply(this,[s]);this.update();this.canvasSource=null},PJSTexture:n,NormalMapGen:s,RenderTexture:b,SceneRenderTexture:f}});
CubicVR.RegisterModule("DrawBufferTexture",function(h){var y=h.GLCore,w=h.enums;w.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var q=function(n){n=n||{};this.operation=h.parseEnum(w.draw.op,n.operation||n.op)||w.draw.op.REPLACE;this.brushType=h.parseEnum(w.draw.brush,n.brushType)||w.draw.brush.SINE;this.brushSize=n.size||5;this.color=n.color||[255,255,255,255]};q.prototype={setOperation:function(n){this.operation=h.parseEnum(w.draw.op,n)},getOperation:function(){return this.operation},
setBrushType:function(n){this.brushType=h.parseEnum(w.draw.brush,n)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(n){this.brushSize=n},getSize:function(){return this.brushSize},setColor:function(n){this.color=n},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:h.extendClassGeneral(h.Texture,function(n){n=n||{};h.Texture.apply(this,[n.image,n.filter,n.deferred_bin,n.binId,n.readyFunc]);this.width=n.width||0;this.height=n.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=n.brush||new q;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(n){this.brush=n},getBrush:function(){return this.brush},
draw:function(n,h,b){var f=b||this.brush,b=f.getOperation(),a=f.getSize(),c=f.getBrushType(),f=f.getColor();this.drawBuffer.push([n,h,b,a,c,f])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var n=this.drawBuffer.pop();this.drawFunc(n[0],n[1],n[2],n[3],n[4],n[5])}return!0},drawFunc:function(n,h,b,f,a,c){for(var d=this.imageBuffer,e=this.width,g=this.height,o=parseInt(Math.floor(n),10)-f;o<parseInt(Math.ceil(n),10)+f;o++)for(var m=o-n,r,B=parseInt(Math.floor(h),
10)-f;B<parseInt(Math.ceil(h),10)+f;B++)if(!(0>=o||o>=e||0>=B||B>=g)){r=B-h;var v;0===a&&(v=(1-Math.sqrt(m*m+r*r)/f)/2);r=4*(B*e+o);0===b?0>v&&(v=0):1===b?0>v&&(v=0):2===b&&(v=-v,0<v&&(v=0));var t=Math.floor(d[r]*(1-v)+c[0]*v),A=Math.floor(d[r+1]*(1-v)+c[1]*v),q=Math.floor(d[r+2]*(1-v)+c[2]*v),C=Math.floor(d[r+3]*(1-v)+c[3]*v);255<t?t=255:0>t&&(t=0);255<A?A=255:0>A&&(A=0);255<q?q=255:0>q&&(q=0);255<C?C=255:0>C&&(C=0);d[r]=t;d[r+1]=A;d[r+2]=q;d[r+3]=C}},update:function(){var n=y.gl;this.flush();n.bindTexture(n.TEXTURE_2D,
h.Textures[this.tex_id]);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,this.imageBuffer)}}),DrawBufferBrush:q}});
CubicVR.RegisterModule("Material",function(h){function y(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=h.get(a)||{},a.shader||null);null===s&&(s=new h.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
s._init_shader(s._vertex,s._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new h.CustomShader(this.customShader));this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==w?a.visible:!0;this.friction=a.friction!==w?a.friction:0.3;this.collision=a.visible!==w?a.collision:!0;this.opacity=a.opacity===w?
1:a.opacity;this.shininess=a.shininess===w?1:a.shininess;this.max_smooth=a.max_smooth===w?60:a.max_smooth;this.env_amount=a.env_amount===w?0.75:a.env_amount;this.morph=a.morph===w?!1:a.morph;this.color_map=a.colorMap===w?!1:a.colorMap;this.uvOffset=a.uvOffset===w?[0,0]:a.uvOffset;this.noFog=a.noFog===w?!1:a.noFog;if(a.textures)for(var d in a.textures)this.setTexture(a.textures[d],d)}var w=h.undef,q=h.GLCore,n=h.enums,s=null,b=[n.texture.map.REFLECT,n.texture.map.SPECULAR,n.texture.map.NORMAL,n.texture.map.BUMP],
f=[],a="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
y.prototype={clone:function(){var a=new h.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,name:this.name}),d;for(d in this.textures)this.textures.hasOwnProperty(d)&&a.setTexture(this.textures[d],d);return a},setVisibility:function(a){this.visible=
a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,d){if(a&&(d=h.parseEnum(n.texture.map,d)||0,h.features.texturePerPixel||-1===b.indexOf(d)))!a.use&&"string"===typeof a&&(a=h.Textures_ref[a]!==w?h.Textures_obj[h.Textures_ref[a]]:new h.Texture(a)),this.textures[d]=a},calcShaderMask:function(){var a;a=0+("object"===
typeof this.textures[n.texture.map.COLOR]?n.shader.map.COLOR:0);a+="object"===typeof this.textures[n.texture.map.SPECULAR]?n.shader.map.SPECULAR:0;a+="object"===typeof this.textures[n.texture.map.NORMAL]?n.shader.map.NORMAL:0;a+="object"===typeof this.textures[n.texture.map.BUMP]?n.shader.map.BUMP:0;a+="object"===typeof this.textures[n.texture.map.REFLECT]?n.shader.map.REFLECT:0;a+="object"===typeof this.textures[n.texture.map.ENVSPHERE]?n.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[n.texture.map.AMBIENT]?
n.shader.map.AMBIENT:0;a+="object"===typeof this.textures[n.texture.map.ALPHA]?n.shader.map.ALPHA:0;a+=1!==this.opacity?n.shader.map.ALPHA:0;a+=this.color_map?n.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return a},getShaderHeader:function(a,d){return(d!==w?"#define LIGHT_COUNT "+d+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[n.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[n.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+
("object"===typeof this.textures[n.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[n.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[n.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[n.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[n.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[n.texture.map.ALPHA]?1:
0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===n.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===n.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===n.light.type.SPOT||a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR||a===n.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===n.light.type.SPOT_SHADOW_PROJECTOR?
1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(q.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===n.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===n.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(q.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(q.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(q.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(q.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(h.features.lightPerPixel?
1:0)+"\n\n"},bindObject:function(a,d){var e=q.gl,g=d.vertexPosition,b=d.vertexTexCoord,m=d.vertexNormal,r=d.vertexColor;e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_points);e.vertexAttribPointer(g,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(g);null!==b&&(null!==a.compiled.gl_uvs&&-1!==b)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_uvs),e.vertexAttribPointer(b,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(b));f.uv=b;null!==m&&(null!==a.compiled.gl_normals&&-1!==m)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_normals),
e.vertexAttribPointer(m,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(m));f.un=m;null!==r&&(null!==a.compiled.gl_colors&&-1!==r)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_colors),e.vertexAttribPointer(r,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(r));f.uc=r;a.morphTarget&&(g=d.vertexMorphPosition,m=d.vertexMorphNormal,e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_points),e.vertexAttribPointer(g,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(g),null!==m&&(null!==a.morphTarget.gl_normals&&-1!==m)&&(e.bindBuffer(e.ARRAY_BUFFER,
a.morphTarget.gl_normals),e.vertexAttribPointer(m,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(m)),e.uniform1f(d.materialMorphWeight,a.morphWeight));e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,d){var e=q.gl;f.uv!==w&&-1!==f.uv&&e.disableVertexAttribArray(f.uv);f.un!==w&&-1!==f.un&&e.disableVertexAttribArray(f.un);f.uc!==w&&-1!==f.uc&&e.disableVertexAttribArray(f.uc);a.morphTarget&&d&&(up=d.vertexMorphPosition,e.disableVertexAttribArray(up),un=d.vertexMorphNormal,
null!==un&&(null!==a.compiled.gl_normals&&-1!==un)&&e.disableVertexAttribArray(un))},use:function(c,d){var e,g=q.gl,b=this.textures,m=!0,d=d||0,c=c||0;this.shader[c]||(this.shader[c]=[]);var f=this.shader[c][d],B=this.customShader&&c===n.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();f&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(f=null,this.dirtyFlag=!1);if(f)m=f!==s,f.use();else{e=this.calcShaderMask(c);if(!this.customShader||B)h.ShaderPool[c][e]||
(h.ShaderPool[c][e]=[]),f=h.ShaderPool[c][e][d];if(!f){var v=this.getShaderHeader(c,d),t=v+q.CoreShader_vs,v=v+q.CoreShader_fs;this.customShader&&!B?this.customShader._initialized||(this.customShader._init_shader(t,v,a),f=this.customShader.getShader(),f.isCompiled()||(m=!1,f=s.getShader())):(f=new h.Shader(t,v),f.isCompiled()||(m=!1,f=s.getShader()),h.ShaderPool[c][e][d]=f);e=0;if(c!==n.light.type.DEPTH_PACK){if(c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||c===n.light.type.AREA)e+=
d,c===n.light.type.SPOT_SHADOW_PROJECTOR&&(e+=d);"object"===typeof b[n.texture.map.COLOR]&&f.addInt("textureColor",e++);"object"===typeof b[n.texture.map.ENVSPHERE]&&f.addInt("textureEnvSphere",e++);"object"===typeof b[n.texture.map.NORMAL]&&f.addInt("textureNormal",e++);"object"===typeof b[n.texture.map.BUMP]&&f.addInt("textureBump",e++);"object"===typeof b[n.texture.map.REFLECT]&&f.addInt("textureReflect",e++);"object"===typeof b[n.texture.map.SPECULAR]&&f.addInt("textureSpecular",e++);"object"===
typeof b[n.texture.map.AMBIENT]&&f.addInt("textureAmbient",e++)}"object"===typeof b[n.texture.map.ALPHA]&&f.addInt("textureAlpha",e++);f.addMatrix("matrixModelView");f.addMatrix("matrixProjection");f.addMatrix("matrixObject");f.addMatrix("matrixNormal");f.addVertexArray("vertexPosition");f.addVertexArray("vertexNormal");this.color_map&&f.addVertexArray("vertexColor");this.morph&&(f.addVertexArray("vertexMorphPosition"),f.addVertexArray("vertexMorphNormal"),f.addFloat("materialMorphWeight",0));for(e=
0;e<d;e++)if(f.addVector("lightDiffuse["+e+"]"),f.addVector("lightSpecular["+e+"]"),f.addFloat("lightIntensity["+e+"]"),f.addFloat("lightDistance["+e+"]"),f.addVector("lightPosition["+e+"]"),f.addVector("lightDirection["+e+"]"),(c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||c===n.light.type.SPOT)&&f.addFloat("lightCutOffAngle["+e+"]"),c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||c===n.light.type.AREA)f.addInt("lightShadowMap["+e+"]"),c===n.light.type.SPOT_SHADOW_PROJECTOR&&
f.addInt("lightProjectionMap["+e+"]"),f.addVector("lightDepthClip["+e+"]"),f.addMatrix("lightShadowMatrix["+e+"]");c!==n.light.type.DEPTH_PACK&&(f.addVector("lightAmbient"),f.addVector("materialDiffuse"),f.addVector("materialColor"),f.addVector("materialAmbient"),f.addVector("materialSpecular"),f.addFloat("materialShininess"),f.addFloat("materialEnvironment"));f.addFloat("materialAlpha");(q.depth_alpha||c===n.light.type.DEPTH_PACK||c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||
c===n.light.type.AREA)&&f.addVector("postDepthInfo");f.addUVArray("vertexTexCoord");f.addVector("materialTexOffset");q.fog_enabled&&!this.noFog&&(f.addVector("fogColor",q.fogColor),f.addFloat("fogDensity",q.fogDensity),f.addFloat("fogNear",q.fogNear),f.addFloat("fogFar",q.fogFar))}this.shader[c][d]=f;f.use();-1!=f.materialTexOffset&&g.uniform2fv(f.materialTexOffset,[0,0])}e=0;if(c!==n.light.type.DEPTH_PACK){if(c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||c===n.light.type.AREA)e+=
d,c===n.light.type.SPOT_SHADOW_PROJECTOR&&(e+=d);if(t=b[n.texture.map.COLOR])t.use(q.gl.TEXTURE0+e),e++;if(t=b[n.texture.map.ENVSPHERE])t.use(q.gl.TEXTURE0+e),e++,g.uniform1f(f.materialEnvironment,this.env_amount);if(t=b[n.texture.map.NORMAL])t.use(q.gl.TEXTURE0+e),e++;if(t=b[n.texture.map.BUMP])t.use(q.gl.TEXTURE0+e),e++;if(t=b[n.texture.map.REFLECT])t.use(q.gl.TEXTURE0+e),e++;if(t=b[n.texture.map.SPECULAR])t.use(q.gl.TEXTURE0+e),e++;if(t=b[n.texture.map.AMBIENT])t.use(q.gl.TEXTURE0+e),e++}if(t=
b[n.texture.map.ALPHA])t.use(q.gl.TEXTURE0+e),e++;q.fog_enabled&&!this.noFog&&(g.uniform3fv(f.fogColor,q.fogColor),g.uniform1f(f.fogDensity,q.fogDensity),g.uniform1f(f.fogNear,q.fogNear),g.uniform1f(f.fogFar,q.fogFar));c!==n.light.type.DEPTH_PACK?(g.uniform3fv(f.materialColor,this.color),g.uniform3fv(f.materialDiffuse,this.diffuse),g.uniform3fv(f.materialAmbient,this.ambient),g.uniform3fv(f.materialSpecular,this.specular),g.uniform1f(f.materialShininess,128*this.shininess),g.uniform3fv(f.lightAmbient,
h.globalAmbient),1!==this.opacity&&g.uniform1f(f.materialAlpha,this.opacity),(q.depth_alpha||c===n.light.type.SPOT_SHADOW||c===n.light.type.SPOT_SHADOW_PROJECTOR||c===n.light.type.AREA)&&g.uniform3fv(f.postDepthInfo,[q.depth_alpha_near,q.depth_alpha_far,0])):g.uniform3fv(f.postDepthInfo,[q.shadow_near,q.shadow_far,0]);f.materialTexOffset&&g.uniform2fv(f.materialTexOffset,this.uvOffset);this.customShader&&(c!==n.light.type.DEPTH_PACK||c===n.light.type.DEPTH_PACK&&!B)&&this.customShader._doUpdate({material:this,
textureIndex:e});return m}};return{Material:y}});
CubicVR.RegisterModule("Mesh",function(h){function y(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function w(b){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;b=h.get(b)||
{};if(b instanceof h.Mesh)this.booleanAdd(b),b._clones=b._clones||1,b._clones++,this.name=b.name?b.name+"_copy"+b._clones:null;else{this.name=b.name||null;this.dynamic=b.dynamic||!1;if(b.material){var f=b.material;f.length?this.materials=f:"object"===typeof f&&(f.use?this.setFaceMaterial(f):this.setFaceMaterial(new h.Material(f)))}b.points&&this.build(b);b.part?this.build(b.part):b.parts&&this.build(b.parts);if((this.primitives=b.primitives||b.primitive||null)&&!this.primitives.length||"string"===
typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var f=0,a=this.primitives.length;f<a;f++){var c=this.primitives[f];"string"===typeof c&&(c=h.get(c));var d=h.primitives[c.type];if(c.type&&d)this.booleanAdd(d(c));else if(c.type){s("Mesh error, primitive "+c.type+" is unknown.");var c="",e;for(e in h.primitives)h.primitives.hasOwnProperty(e)&&(""!==c&&(c+=", "),c+=e);s("Available primitive types are: "+c)}else s("Mesh error, primitive "+(f+1)+" lacks type.")}this.buildWireframe=
b.buildWireframe||b.wireframe||!!b.wireframeMaterial||b.triangulateWireframe||!1;this.triangulateWireframe=b.triangulateWireframe||null;this.wireframeMaterial=h.get(b.wireframeMaterial,h.Material)||null;this.wireframe=b.wireframe||!1;b.flipFaces&&this.faces.length&&this.flipFaces();(b.prepare||b.compile&&this.faces.length)&&this.prepare();(b.clean||b.compile&&this.faces.length&&!this.dynamic)&&this.clean();b.calcNormals&&(!b.compile&&!b.prepare)&&this.calcNormals()}}var q=h.undef,n=h.GLCore,s=h.log;
y.prototype={setUV:function(b,f){f!==q?this.uvs[f]=b:2!==b.length?this.uvs=b:this.uvs.push(b)},setColor:function(b,f){f!==q?this.point_colors[f]=b:"number"!==typeof b[0]?this.point_colors=b:this.point_colors.push(b)},flip:function(){for(var b=0,f=this.point_normals.length;b<f;b++)this.point_normals[b]=[-this.point_normals[b][0],-this.point_normals[b][1],-this.point_normals[b][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
w.prototype={setWireframe:function(b){this.wireframe=b},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(b){this.wireframeMaterial=b},build:function(b,f){var a,c;"string"===typeof b&&(b=h.get(b));b&&!b.length&&(b=[b]);var d=this.faces.length;f&&f.length&&this.points.concat(f);for(var e=0,g=b.length;e<g;e++){var o=b[e];a=o.material;c=o.points;var m=o.faces,r=o.uv,B=o.color,o=o.segment||null;null!==o&&this.setSegment(parseInt(o,10));if(c&&c.length&&(this.points=this.points.concat(c),
m&&d)){m=m.slice(0);c=0;for(o=m.length;c<o;c++)for(var v=m[c],t=0,n=m.length;t<n;t++)v[t]+=d}a&&(a.length?this.materials=a:"object"===typeof a&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new h.Material(a))));m&&m.length&&this.addFace(m);if(m&&r&&"object"===typeof r){o=null;if(r.length&&r.length===m.length)if(r.length===m.length){a=0;for(c=r.length;a<c;a++)this.faces[a+d].setUV(r[a])}else s("Mesh error in part, face count: "+m.length+", uv count:"+r.length);else o=r.apply?r:new h.UVMapper(r);
o&&o.apply(this,this.currentMaterial,this.currentSegment,d,this.faces.length-d)}if(m&&B&&"object"===typeof B)if(B.length&&B.length===m.length){a=0;for(c=B.length;a<c;a++)this.faces[a+d].setColor(B[a]);this.materials[this.currentMaterial].colorMap=!0}else s("Mesh error in part, face count: "+m.length+", color count:"+B.length)}return this},showAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&(this.segment_state[b]=!0)},hideAllSegments:function(){for(var b in this.segment_state)this.segment_state.hasOwnProperty(b)&&
(this.segment_state[b]=!1)},setSegment:function(b,f){f!==q?this.segment_state[b]=f:this.currentSegment=b},addPoint:function(b){if(3!==b.length||"object"===typeof b[0])for(var f=0,a=b.length;f<a;f++)this.points.push(b[f]);else this.points.push(b);return this.points.length-1},getMaterialIndex:function(b){return this.materials.indexOf(b)},setFaceMaterial:function(b,f){var a;"number"==typeof b?a=b:(a=this.materials.indexOf(b),-1===a&&(this.materials.push(b),a=this.materials.length-1));f!==q?this.faces[f]!==
q&&(this.faces[f].material=a):this.currentMaterial=a;return this},addFace:function(b,f,a,c){if("number"!==typeof b[0]){f=0;for(a=b.length;f<a;f++)this.addFace(b[f])}else return f===q?(this.currentFace=this.faces.length,this.faces.push(new y)):(this.faces[f]===q&&(this.faces[f]=new y),this.currentFace=f),"object"===typeof b&&(this.faces[this.currentFace].points=b),a!==q?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=
c!==q?c:this.currentSegment,this.currentFace},flipFaces:function(){for(var b=0,f=this.faces.length;b<f;b++)this.faces[b].flip()},triangulateQuads:function(){for(var b=0,f=this.faces.length;b<f;b++)if(4===this.faces[b].points.length){var a=this.faces.length;this.addFace([this.faces[b].points[2],this.faces[b].points[3],this.faces[b].points[0]],this.faces.length,this.faces[b].material,this.faces[b].segment);this.faces[b].points.pop();this.faces[a].normal=this.faces[b].normal.slice(0);4===this.faces[b].point_colors.length&&
(this.faces[a].setColor(this.faces[b].point_colors[2],0),this.faces[a].setColor(this.faces[b].point_colors[3],1),this.faces[a].setColor(this.faces[b].point_colors[0],2),this.faces[b].point_colors.pop());4===this.faces[b].uvs.length&&(this.faces[a].setUV(this.faces[b].uvs[2],0),this.faces[a].setUV(this.faces[b].uvs[3],1),this.faces[a].setUV(this.faces[b].uvs[0],2),this.faces[b].uvs.pop());4===this.faces[b].point_normals.length&&(this.faces[a].point_normals[0]=this.faces[b].point_normals[2],this.faces[a].point_normals[1]=
this.faces[b].point_normals[3],this.faces[a].point_normals[2]=this.faces[b].point_normals[0],this.faces[b].point_normals.pop())}return this},booleanAdd:function(b,f){var a=h.mat4,c=this.points.length,d,e,g,o;d=f;f=d===q?q:"array"===typeof d?d:"object"===typeof d?d.getResult?d.getResult():d.position||d.rotation||d.scale?h.mat4.transform(d.position,d.rotation,d.scale):q:void 0;b.wireframeMaterial&&(this.wireframeMaterial=b.wireframeMaterial);if(f!==q){e=f;d=0;for(g=b.points.length;d<g;d++)this.addPoint(a.vec3_multiply(b.points[d],
e))}else{d=0;for(g=b.points.length;d<g;d++)this.addPoint([b.points[d][0],b.points[d][1],b.points[d][2]])}a=[];d=0;for(g=b.materials.length;d<g;d++)e=this.materials.indexOf(b.materials[d]),-1===e?(this.materials.push(b.materials[d]),a[d]=this.materials.length-1):a[d]=e;d=0;for(g=b.faces.length;d<g;d++){var m=[];e=0;for(o=b.faces[d].points.length;e<o;e++)m.push(b.faces[d].points[e]+c);m=this.faces[this.addFace(m)];m.segment=b.faces[d].segment;m.material=a[b.faces[d].material];m.material===q&&(m.material=
0);e=0;for(o=b.faces[d].uvs.length;e<o;e++)m.uvs[e]=[b.faces[d].uvs[e][0],b.faces[d].uvs[e][1]];e=0;for(o=b.faces[d].point_normals.length;e<o;e++)m.point_normals[e]=[b.faces[d].point_normals[e][0],b.faces[d].point_normals[e][1],b.faces[d].point_normals[e][2]]}return this},calcFaceNormals:function(b,f){var a=h.vec3,c=h.triangle,d=0,e=this.faces.length,g,o=this.points,m;b&&(d=b);for(f&&(e=f+1);d<e;d++)g=this.faces[d],m=g.points,3>m.length?g.normal=[0,0,0]:a.normalize(c.normal(o[m[0]],o[m[1]],o[m[2]],
g.normal));return this},getMaterial:function(b){if(!isNaN(parseInt(b,10)))return this.materials[f];for(var f=0,a=this.materials.length;f<a;f++)if(this.materials[f].name===b)return this.materials[f];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(b){this.instanceMaterials=b},calcNormals:function(b){var f=h.vec3,a=!1,c;this.dynamic&&(c=[],b=b||{});b!==q&&(c=[],a=!0);this.calcFaceNormals();var d,e,g,o,m=Array(this.points.length);d=0;for(o=m.length;d<o;d++)m[d]=
[];o=this.faces.length;for(d=0;d<o;d++){g=this.faces[d].points.length;for(e=0;e<g;e++)m[this.faces[d].points[e]].push([d,e])}d=0;for(o=this.points.length;d<o;d++){var r=m[d].length;for(e=0;e<r;e++){var B=1,v=m[d][e][0],t=m[d][e][1],n=this.materials.length?this.materials[this.faces[v].material].max_smooth:60,D=this.faces[v];a&&(c[v]===q&&(c[v]=[]),c[v][t]===q&&(c[v][t]=[]));var s=Array(3);s[0]=D.normal[0];s[1]=D.normal[1];s[2]=D.normal[2];if(0!==n)for(g=0;g<r;g++)if(e!==g){var w=m[d][g][0],u=this.faces[w],
x=f.angle(u.normal,D.normal);if(x!==x||x*(180/Math.PI)<=n)a&&c[v][t].push(w),s[0]+=u.normal[0],s[1]+=u.normal[1],s[2]+=u.normal[2],B++}s[0]/=B;s[1]/=B;s[2]/=B;this.faces[v].point_normals[t]=f.normalize(s)}}if(a){d=f=0;for(o=c.length;d<o;d++){e=0;for(g=c[d].length;e<g;e++)f+=c[d][e].length}b.faceCount||(b.faceCount=new Uint8Array(3*this.faces.length));b.faceNorm||(b.faceNorm=new Uint16Array(f));b.faceNormIdx||(b.faceNormIdx=new Uint16Array(this.faces.length));d=f=0;for(o=this.faces.length;d<o;d++)for(e=
0;3>e;e++)if(a=c[d][e],b.faceCount[3*d+e]=a?a.length:0,b.faceNormIdx[d]=f,a){g=0;for(a=a.length;g<a;g++)b.faceNorm[f++]=c[d][e][g]}else f++;this.normalMapRef=b}return this},recalcNormals:function(b,f){var a,c,d,e,g,o,m,r,B,v;if(b=b||this.normalMapRef){a=f.segments!==q?!0:!1;c=f.segments;this.calcFaceNormals();var t=0,n=0,h=0,s;if(a)for(var n=this.dynamicData.VBO.dynamicMap,w=b.faceNormIdx,u=0,x=c.length;u<x;u++)for(var E=n.segmentMap[c[u]],z=0,y=E.length;z<y;z++){a=E[z];B=this.faces[a];s=B.normal;
t=w[a];for(j=0;3>j;j++){r=B.point_normals[j];g=s[0];o=s[1];m=s[2];v=b.faceCount[3*a+j];d=0;for(iMax=v;d<iMax;d++)e=b.faceNorm[t+d],e=this.faces[e],e=e.normal,g+=e[0],o+=e[1],m+=e[2];v?(d=v+1,g/=d,o/=d,m/=d,d=Math.sqrt(g*g+o*o+m*m),g/=d,o/=d,m/=d,r[0]=g,r[1]=o,r[2]=m):h++}}else{a=0;for(c=this.faces.length;a<c;a++){B=this.faces[a];s=B.normal;for(j=0;3>j;j++){r=B.point_normals[j];g=s[0];o=s[1];m=s[2];v=b.faceCount[n++];d=0;for(iMax=v;d<iMax;d++)e=b.faceNorm[t++],e=this.faces[e],e=e.normal,g+=e[0],o+=
e[1],m+=e[2];v?(d=v+1,g/=d,o/=d,m/=d,d=Math.sqrt(g*g+o*o+m*m),g/=d,o/=d,m/=d,r[0]=g,r[1]=o,r[2]=m):h++}}}return this}},removeDoubles:function(b){var f=[],a=[],c,d,e,g;c=0;for(d=this.points.length;c<d;c++){var o=-1,m=this.points[c];e=0;for(g=f.length;e<g;e++)if(h.vec3.equal(m,f[e],b)){o=e;break}-1!=o?a[c]=o:(a[c]=f.length,f.push(this.points[c]))}this.points=f;c=0;for(d=this.faces.length;c<d;c++){b=this.faces[c];e=0;for(g=b.points.length;e<g;e++)b.points[e]=a[b.points[e]]}return this},buildEdges:function(){var b,
f,a,c,d=[],e=[];b=0;for(a=this.faces.length;b<a;b++){var g=this.faces[b];f=0;for(c=g.points.length;f<c;f++){var o,m,r;r=g.segment;matId=g.material;f?(m=g.points[f],o=g.points[f-1]):(m=g.points[f],o=g.points[c-1]);d[o]=d[o]||{};d[o][matId]=d[o][matId]||{};d[o][matId][r]=d[o][matId][r]||{};!d[o][matId][r][m]&&(!d[m]||!d[m][matId][r][o])&&e.push([matId,r,o,m])}}this.edges=e;return this},subdivide:function(b,f){var a=h.vec3,f=f===q?!0:f;b===q&&(b=1);if(0!==b){var c,d,e,g,o,m={},r=[],B=[],v=this.points.length,
t=this.faces.length,n=[],D=[],C=[],w=[];c=0;for(e=t;c<e;c++)if(o=this.faces[c],o.points&&(3===o.points.length||4===o.points.length)){var u=[0,0,0];d=0;for(g=o.points.length;d<g;d++){var x=this.points[o.points[d]];u[0]+=x[0];u[1]+=x[1];u[2]+=x[2]}u[0]/=g;u[1]/=g;u[2]/=g;n[c]=this.addPoint(u);if(o.uvs.length===o.points.length){u=[0,0];d=0;for(g=o.uvs.length;d<g;d++)x=o.uvs[d],u[0]+=x[0],u[1]+=x[1];u[0]/=g;u[1]/=g;D[c]=u}if(o.point_colors.length===o.points.length){u=[0,0,0];d=0;for(g=o.point_colors.length;d<
g;d++)x=o.point_colors[d],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=g;u[1]/=g;u[2]/=g;C[c]=u}if(o.point_normals.length===o.points.length){u=[0,0,0];d=0;for(g=o.point_normals.length;d<g;d++)x=o.point_normals[d],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=g;u[1]/=g;u[2]/=g;w[c]=u}}c=0;for(e=this.faces.length;c<e;c++){o=this.faces[c];d=0;for(g=o.points.length;d<g;d++){var E,z;d?(E=d,z=d-1):(E=d,z=g-1);x=o.points[E];u=o.points[z];m[u]=m[u]||{};r[u]=r[u]||[];r[u].push(c);m[u][x]={face:c,a:u,b:x,fpa:E,fpb:z}}}for(c in m)if(m.hasOwnProperty(c))for(d in m[c])if(m[c].hasOwnProperty(d)){e=
m[c][d];o=m[d][c];if(o===q){s("Mesh.subdivide error. Hole at face #"+e.face+", Edge:["+e.fpa+"->"+e.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}e.edge_point||(g=a.multiply(a.add(this.points[e.a],this.points[e.b]),0.5),f?(u=a.multiply(a.add(this.points[n[e.face]],this.points[n[o.face]]),0.5),e.edge_point=a.multiply(a.add(g,u),0.5)):e.edge_point=g,o.edge_point=e.edge_point,e.edge_avg=g,o.edge_avg=g,e.ep_idx=this.addPoint(e.edge_point),o.ep_idx=e.ep_idx);B[e.a]=B[e.a]||
[];B[e.a].push(e.edge_avg);g=this.faces[e.face].uvs;g.length&&(o=g[e.fpa],g=g[e.fpb],e.uv=[(o[0]+g[0])/2,(o[1]+g[1])/2]);o=this.faces[e.face].point_colors;o.length&&(e.color=a.multiply(a.add(o[e.fpa],o[e.fpb]),0.5));o=this.faces[e.face].point_normals;o.length&&(e.normal=a.normalize(a.multiply(a.add(o[e.fpa],o[e.fpb]),0.5)))}if(f){o=[];c=0;for(e=v;c<e;c++)if(u=[0,0,0],r[c]){d=0;for(g=r[c].length;d<g;d++)x=this.points[n[r[c][d]]],u[0]+=x[0],u[1]+=x[1],u[2]+=x[2];u[0]/=g;u[1]/=g;u[2]/=g;o[c]=u}u=[];
c=0;for(e=v;c<e;c++)if(x=[0,0,0],B[c]){d=0;for(g=B[c].length;d<g;d++)E=B[c][d],x[0]+=E[0],x[1]+=E[1],x[2]+=E[2];x[0]/=g;x[1]/=g;x[2]/=g;u[c]=x}c=0;for(e=v;c<e;c++)r[c]&&(v=r[c].length,d=1/v,B=2/v,v=a.multiply(this.points[c],(v-3)/v),v=a.add(v,a.multiply(o[c],d)),v=a.add(v,a.multiply(u[c],B)),this.points[c]=v)}for(c=0;c<t;c++)if(o=this.faces[c],!(3!==o.points.length&&4!==o.points.length))if(a=o.points.slice(0),r=o.uvs.slice(0),d=o.point_colors.slice(0),B=o.point_normals.slice(0),v=r.length===a.length,
e=d.length===a.length,g=B.length===a.length,o=o.material,3===a.length){if(this.setFaceMaterial(o),u=m[a[0]][a[1]],x=m[a[2]][a[0]],this.addFace([a[0],u.ep_idx,n[c],x.ep_idx],c),v&&(this.faces[c].uvs=[r[0],u.uv,D[c],x.uv]),e&&(this.faces[c].point_colors=[d[0],u.color,C[c],x.color]),g&&(this.faces[c].point_normals=[B[0],u.normal,w[c],x.normal]),u=m[a[1]][a[2]],x=m[a[0]][a[1]],o=this.addFace([a[1],u.ep_idx,n[c],x.ep_idx]),v&&(this.faces[o].uvs=[r[1],u.uv,D[c],x.uv]),e&&(this.faces[o].point_colors=[d[1],
u.color,C[c],x.color]),g&&(this.faces[o].point_normals=[B[1],u.normal,w[c],x.normal]),u=m[a[2]][a[0]],x=m[a[1]][a[2]],o=this.addFace([a[2],u.ep_idx,n[c],x.ep_idx]),v&&(this.faces[o].uvs=[r[2],u.uv,D[c],x.uv]),e&&(this.faces[o].point_colors=[d[2],u.color,C[c],x.color]),g)this.faces[o].point_normals=[B[2],u.normal,w[c],x.normal]}else if(this.setFaceMaterial(o),u=m[a[0]][a[1]],x=m[a[3]][a[0]],this.addFace([a[0],u.ep_idx,n[c],x.ep_idx],c),v&&(this.faces[c].uvs=[r[0],u.uv,D[c],x.uv]),e&&(this.faces[c].point_colors=
[d[0],u.color,C[c],x.color]),g&&(this.faces[c].point_normals=[B[0],u.normal,w[c],x.normal]),u=m[a[1]][a[2]],x=m[a[0]][a[1]],o=this.addFace([a[1],u.ep_idx,n[c],x.ep_idx]),v&&(this.faces[o].uvs=[r[1],u.uv,D[c],x.uv]),e&&(this.faces[o].point_colors=[d[1],u.color,C[c],x.color]),g&&(this.faces[o].point_normals=[B[1],u.normal,w[c],x.normal]),u=m[a[2]][a[3]],x=m[a[1]][a[2]],o=this.addFace([a[2],u.ep_idx,n[c],x.ep_idx]),v&&(this.faces[o].uvs=[r[2],u.uv,D[c],x.uv]),e&&(this.faces[o].point_colors=[d[2],u.color,
C[c],x.color]),g&&(this.faces[o].point_normals=[B[2],u.normal,w[c],x.normal]),u=m[a[3]][a[0]],x=m[a[2]][a[3]],o=this.addFace([a[3],u.ep_idx,n[c],x.ep_idx]),v&&(this.faces[o].uvs=[r[3],u.uv,D[c],x.uv]),e&&(this.faces[o].point_colors=[d[3],u.color,C[c],x.color]),g)this.faces[o].point_normals=[B[3],u.normal,w[c],x.normal];b--;if(0!==b)this.subdivide(b,f);else return this}},removeInternals:function(){var b,f,a,c,d,e={},g=this.faces.length,o,m,r,B;b=0;for(a=this.faces.length;b<a;b++){d=this.faces[b];f=
0;for(c=d.points.length;f<c;f++)f?(r=f,B=f-1):(r=f,B=c-1),o=d.points[r],m=d.points[B],e[o]=e[o]||{},e[o][m]===q?e[o][m]=[b]:e[o][m].push(b)}a=function(a){return-1!==e[m][o].indexOf(a)};for(b=0;b<g;b++){d=this.faces[b];var v=null;f=0;for(c=d.points.length;f<c;f++)f?(r=f,B=f-1):(r=f,B=c-1),o=d.points[r],m=d.points[B],v=v?v.filter(a):e[m][o];v.length&&(this.faces.splice(b,1),g--,b--)}return this},prepare:function(b){b===q&&(b=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();
this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();b&&!this.dynamic&&this.clean();return this},clean:function(){var b,f;b=0;for(f=this.points.length;b<f;b++)delete this.points[b],this.points[b]=null;this.points=[];b=0;for(f=this.faces.length;b<f;b++)delete this.faces[b].points,delete this.faces[b].point_normals,delete this.faces[b].uvs,delete this.faces[b].normal,delete this.faces[b],this.faces[b]=null;this.faces=[];return this},compileMap:function(b){var f=h.vec3,a=
h.vec2;b===q&&(b=1.0E-5);var c={segments:[],bounds:[]},d=[],e,g,o,m,r,B,v,t;this.materials.length||this.materials.push(new h.Material);e=0;for(B=this.materials.length;e<B;e++)d[e]=[];e=0;for(B=this.faces.length;e<B;e++)3===this.faces[e].points.length&&(o=this.faces[e].material,m=this.faces[e].segment,d[o][m]===q&&(d[o][m]=[],c.segments.push(m)),d[o][m].push(e));var n=[],D=0,s=!1,w=!1,u=!1,x;e=0;for(B=d.length;e<B;e++)for(g in d[e])if(d[e].hasOwnProperty(g))for(o=0;o<d[e][g].length;o++)x=d[e][g][o],
s=s||0!==this.faces[x].uvs.length,w=w||0!==this.faces[x].point_normals.length,u=u||0!==this.faces[x].point_colors.length;if(s)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].uvs.push([0,0]);if(w)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(g=0;g<this.faces[e].points.length;g++)this.faces[e].point_normals.push([0,0,0]);if(u)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(g=0;g<
this.faces[e].points.length;g++)this.faces[e].point_colors.push([0,0,0]);e=0;for(B=d.length;e<B;e++)for(g in d[e])if(d[e].hasOwnProperty(g)){o=0;for(v=d[e][g].length;o<v;o++){x=d[e][g][o];for(m=0;3>m;m++){var E=this.faces[x].points[m],z=-1;if(n[E]!==q){r=0;for(t=n[E].length;r<t;r++){var y=n[E][r][0],H=n[E][r][1],z=n[E][r][2];w&&(z=f.equal(this.faces[y].point_normals[H],this.faces[x].point_normals[m],b)?z:-1);s&&(z=a.equal(this.faces[y].uvs[H],this.faces[x].uvs[m],b)?z:-1);u&&(z=f.equal(this.faces[y].point_colors[H],
this.faces[x].point_colors[m],b)?z:-1)}}-1!==z?(c.elements===q&&(c.elements=[]),c.elements[e]===q&&(c.elements[e]=[]),c.elements[e][g]===q&&(c.elements[e][g]=[]),c.elements[e][g].push(z)):(c.points===q&&(c.points=[]),c.points.push(E),0===c.bounds.length?(c.bounds[0]=[this.points[E][0],this.points[E][1],this.points[E][2]],c.bounds[1]=[this.points[E][0],this.points[E][1],this.points[E][2]]):(this.points[E][0]<c.bounds[0][0]&&(c.bounds[0][0]=this.points[E][0]),this.points[E][1]<c.bounds[0][1]&&(c.bounds[0][1]=
this.points[E][1]),this.points[E][2]<c.bounds[0][2]&&(c.bounds[0][2]=this.points[E][2]),this.points[E][0]>c.bounds[1][0]&&(c.bounds[1][0]=this.points[E][0]),this.points[E][1]>c.bounds[1][1]&&(c.bounds[1][1]=this.points[E][1]),this.points[E][2]>c.bounds[1][2]&&(c.bounds[1][2]=this.points[E][2])),w&&(c.normals===q&&(c.normals=[]),c.normals.push([x,m])),u&&(c.colors===q&&(c.colors=[]),c.colors.push([x,m])),s&&(c.uvs===q&&(c.uvs=[]),c.uvs.push([x,m])),c.elements===q&&(c.elements=[]),c.elements[e]===q&&
(c.elements[e]=[]),c.elements[e][g]===q&&(c.elements[e][g]=[]),c.elements[e][g].push(D),n[E]===q&&(n[E]=[]),n[E].push([x,m,D]),D++)}}}if(this.edges){c.line_elements=[];e=0;for(B=this.edges.length;e<B;e++)f=this.edges[e],o=f[0],m=f[1],b=f[2],f=f[3],c.line_elements[o]=c.line_elements[o]||[],c.line_elements[o][m]=c.line_elements[o][m]||[],c.line_elements[o][m].push(n[b][0][2]),c.line_elements[o][m].push(n[f][0][2])}c.dynamic=this.dynamic;return c},compileVBO:function(b,f,a,c,d,e,g,o){"object"==typeof f?
(f=f.element!==q?f.element:!0,a=f.vertex!==q?f.vertex:!0,e=f.color!==q?f.color:!0,c=f.normal!==q?f.normal:!0,d=f.uv!==q?f.uv:!0,g=f.lines!==q?f.lines:!!b.line_elements,o=f.dynamic!==q?f.dynamic:b.dynamic):(f===q&&(f=!0),a===q&&(a=!0),e===q&&(e=!0),c===q&&(c=!0),d===q&&(d=!0),g===q&&(g=!!b.line_elements),o===q&&(o=b.dynamic));var m={},r,B,v,t,n;o&&(t={points:new Int16Array(b.points.length),face_points:new Int16Array(2*b.points.length),segments:null},m.dynamicMap=t,m.dynamic=!0);if(b.points&&a){r=b.points.length;
m.vbo_points=new Float32Array(3*r);for(a=0;a<r;a++)B=b.points[a],m.vbo_points[3*a]=this.points[B][0],m.vbo_points[3*a+1]=this.points[B][1],m.vbo_points[3*a+2]=this.points[B][2],o&&(t.points[a]=B)}if(o){n=b.normals||b.colors||b.uvs;a=0;for(r=n.length;a<r;a++)B=n[a],t.face_points[2*a]=B[0],t.face_points[2*a+1]=B[1]}if(b.normals&&c){r=b.normals.length;m.vbo_normals=new Float32Array(3*r);for(a=c=0;a<r;a++)B=b.normals[a],m.vbo_normals[c++]=this.faces[B[0]].point_normals[B[1]][0],m.vbo_normals[c++]=this.faces[B[0]].point_normals[B[1]][1],
m.vbo_normals[c++]=this.faces[B[0]].point_normals[B[1]][2]}if(b.colors&&e){r=b.colors.length;m.vbo_colors=new Float32Array(3*r);for(a=c=0;a<r;a++)B=b.colors[a],m.vbo_colors[c++]=this.faces[B[0]].point_colors[B[1]][0],m.vbo_colors[c++]=this.faces[B[0]].point_colors[B[1]][1],m.vbo_colors[c++]=this.faces[B[0]].point_colors[B[1]][2]}if(b.uvs&&d){r=b.uvs.length;m.vbo_uvs=new Float32Array(2*r);for(a=c=0;a<r;a++)B=b.uvs[a],m.vbo_uvs[c++]=this.faces[B[0]].uvs[B[1]][0],m.vbo_uvs[c++]=this.faces[B[0]].uvs[B[1]][1]}if(f){m.elements_ref=
[];m.vbo_elements=[];a=0;for(r=b.elements.length;a<r;a++)for(v in m.elements_ref[a]=[],f=0,b.elements[a])if(b.elements[a].hasOwnProperty(v)){c=b.elements[a][v];d=0;for(e=c.length;d<e;d++)m.vbo_elements.push(c[d]);m.elements_ref[a][f]=[v|0,c.length|0];f++}m.vbo_elements=new Uint16Array(m.vbo_elements)}if(g){m.line_elements_ref=[];m.vbo_line_elements=[];a=0;for(r=b.line_elements.length;a<r;a++)for(v in m.line_elements_ref[a]=[],f=0,b.line_elements[a])if(b.line_elements[a].hasOwnProperty(v)){c=b.line_elements[a][v];
d=0;for(e=c.length;d<e;d++)m.vbo_line_elements.push(c[d]);m.line_elements_ref[a][f]=[v|0,c.length|0];f++}m.vbo_line_elements=new Uint16Array(m.vbo_line_elements)}m.segments=b.segments;m.bounds=b.bounds;if(o&&1<b.segments.length){b=[];n=t.points;a=0;for(r=n.length;a<r;a++)g=this.faces[t.face_points[2*a]].segment||0,b[g]===q&&(b[g]=[]),b[g].push(a);m.dynamicMap.segmentMap=b}return m},updateVBO:function(b,f){if(!b.dynamic)return!1;var a,c,d=b.dynamicMap,e=f.points&&!!b.vbo_points,g=f.normals&&!!b.vbo_normals,
o=f.uvs&&!!b.vbo_uvs,m=f.colors&&!!b.vbo_colors;c=f.segments;var r,B,v;if(f.segments!==q)for(var t=0,n=c.length;t<n;t++)for(var h=d.segmentMap[c[t]],s=0,w=h.length;s<w;s++){if(a=h[s],B=this.faces[d.face_points[2*a]],v=d.face_points[2*a+1],e&&(r=this.points[d.points[a]],b.vbo_points[3*a]=r[0],b.vbo_points[3*a+1]=r[1],b.vbo_points[3*a+2]=r[2]),g&&(r=B.point_normals[v],b.vbo_normals[3*a]=r[0],b.vbo_normals[3*a+1]=r[1],b.vbo_normals[3*a+2]=r[2]),m&&(r=B.point_colors[v],b.vbo_colors[3*a]=r[0],b.vbo_colors[3*
a+1]=r[1],b.vbo_colors[3*a+2]=r[2]),o)r=B.uvs[v],b.vbo_uvs[2*a]=r[0],b.vbo_uvs[2*a+1]=r[1]}else{a=0;for(c=d.points.length;a<c;a++)if(B=this.faces[d.face_points[2*a]],v=d.face_points[2*a+1],e&&(r=this.points[d.points[a]],b.vbo_points[3*a]=r[0],b.vbo_points[3*a+1]=r[1],b.vbo_points[3*a+2]=r[2]),g&&(r=B.point_normals[v],b.vbo_normals[3*a]=r[0],b.vbo_normals[3*a+1]=r[1],b.vbo_normals[3*a+2]=r[2]),m&&(r=B.point_colors[v],b.vbo_colors[3*a]=r[0],b.vbo_colors[3*a+1]=r[1],b.vbo_colors[3*a+2]=r[2]),o)r=B.uvs[v],
b.vbo_uvs[2*a]=r[0],b.vbo_uvs[2*a+1]=r[1]}return this},rebufferVBO:function(b,f,a){var c=n.gl;a.points&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_points),c.bufferData(c.ARRAY_BUFFER,b.vbo_points,c.DYNAMIC_DRAW));a.normals&&b.vbo_normals&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_normals),c.bufferData(c.ARRAY_BUFFER,b.vbo_normals,c.DYNAMIC_DRAW));a.uvs&&b.vbo_uvs&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_uvs),c.bufferData(c.ARRAY_BUFFER,b.vbo_uvs,c.DYNAMIC_DRAW));a.colors&&b.vbo_colors&&(c.bindBuffer(c.ARRAY_BUFFER,f.gl_colors),
c.bufferData(c.ARRAY_BUFFER,b.vbo_colors,c.DYNAMIC_DRAW));c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(b,f){var a=n.gl,c={};f===q&&(f={});c.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c.gl_points);a.bufferData(a.ARRAY_BUFFER,b.vbo_points,a.STATIC_DRAW);b.vbo_normals?(c.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_normals),a.bufferData(a.ARRAY_BUFFER,b.vbo_normals,a.STATIC_DRAW)):c.gl_normals=f.gl_normals?f.gl_normals:null;b.vbo_uvs?(c.gl_uvs=
a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_uvs),a.bufferData(a.ARRAY_BUFFER,b.vbo_uvs,a.STATIC_DRAW)):c.gl_uvs=f.gl_uvs?f.gl_uvs:null;b.vbo_colors?(c.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,c.gl_colors),a.bufferData(a.ARRAY_BUFFER,b.vbo_colors,a.STATIC_DRAW)):c.gl_colors=f.gl_colors?f.gl_colors:null;!b.vbo_elements&&f.gl_elements?(c.gl_elements=f.gl_elements,c.elements_ref=f.elements_ref):(c.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,
b.vbo_elements,a.STATIC_DRAW),c.elements_ref=b.elements_ref);!b.vbo_line_elements&&f.gl_line_elements?(c.gl_line_elements=f.gl_line_elements,c.line_elements_ref=f.line_elements_ref):(c.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,c.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,b.vbo_line_elements,a.STATIC_DRAW),c.line_elements_ref=b.line_elements_ref);c.segments=b.segments;c.bounds=b.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return c},update:function(b){var b=
b||{},f=b.points||b.point||b.vertex||b.vertices||b.all||!0,a=b.uvs||b.uv||b.texture||b.all||!1,c=b.normals||b.normal||b.all||!0,d=b.colors||b.color||b.all||!1,b=b.segments||b.segment;b!==q&&b.length===q&&(b=[b]);if(!this.dynamic)return s("Mesh not defined as dynamic, cannot update."),!1;c&&this.normalMapRef&&this.recalcNormals(q,{segments:b});f={points:f,uvs:a,normals:c,colors:d,segments:b};this.updateVBO(this.dynamicData.VBO,f);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,f)},bindBuffer:function(b){null===
this.originBuffer&&(this.originBuffer=b);this.compiled=b;this.segment_state=[];for(var f=0,a=b.segments.length;f<a;f++)this.segment_state[b.segments[f]]=!0;this.bb=b.bounds},compile:function(b){if(0<this.faces.length&&0<this.points.length){var b=this.compileVBO(this.compileMap(b)),f=this.bufferVBO(b);this.bindBuffer(f);if(this.dynamic){this.sourcePoints=[];for(var a=0,c=this.points.length;a<c;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:b,buffer:f}}}return this},addMorphTarget:function(b){null===
this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(b)},setMorphSource:function(b){this.morphSourceIndex!==b&&(this.morphSourceIndex=b,this.bindBuffer(this.morphTargets[b]))},setMorphTarget:function(b){this.morphTargetIndex!==b&&(this.morphTargetIndex=b,this.morphTarget=this.morphTargets[b])},setMorphWeight:function(b){this.morphWeight=b},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:w,Face:y}});
CubicVR.RegisterModule("UVMapper",function(h){function y(a){a=h.get(a)||{};this.rotation=a.rotation===w?[0,0,0]:a.rotation;this.scale=a.scale===w?[1,1,1]:a.scale;this.center=a.center===w?[0,0,0]:a.center;this.projection_mode=a.projectionMode===w?q.uv.projection.PLANAR:h.parseEnum(q.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===w?q.uv.axis.X:h.parseEnum(q.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===w?1:a.wrapW;this.wrap_h_count=a.wrapH===w?1:a.wrapH}var w=h.undef,
q=h.enums,n=2*Math.PI,s=Math.PI/2;q.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var b=function(a,c,d){return 0===a&&0===d?0:0===d?0>a?s:-s:0>d?-Math.atan(a/d)+Math.PI:-Math.atan(a/d)},f=function(a,c,d){var e;0===a&&0===d?(e=0,a=0!==c?0>c?-s:s:0):(e=0===d?0>a?s:-s:0>d?-Math.atan(a/d)+Math.PI:-Math.atan(a/d),a=Math.sqrt(a*a+d*d),a=0===a?0>c?-s:s:Math.atan(c/a));return[e,a]};y.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,c,d,e,g){var o=h.mat4,m,r,B,v,t,A=new h.Transform,D=!1,C=null;if(this.center[0]||this.center[1]||this.center[2])A.translate(-this.center[0],-this.center[1],-this.center[2]),D=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
A.rotate(this.rotation[2],0,0,1),this.rotation[1]&&A.rotate(this.rotation[1],0,1,0),this.rotation[2]&&A.rotate(this.rotation[0],1,0,0),D=!0;D&&(C=A.getResult());"object"===typeof c&&(c=a.materials.indexOf(c));var A=0,I=a.faces.length;e&&(A=e);for(g&&(I=g+1);A<I;A++)if(a.faces[A].material===c&&!(d!==w&&a.faces[A].segment!==d)){var u,x,E;if(this.projection_mode===q.uv.projection.CUBIC||this.projection_mode===q.uv.projection.SKY)u=Math.abs(a.faces[A].normal[0]),x=Math.abs(a.faces[A].normal[1]),E=Math.abs(a.faces[A].normal[2]);
for(var e=[],g=0,z=a.faces[A].points.length;g<z;g++){r=a.faces[A].points[g];var y=a.faces[A].points[(g+1)%3],H=a.faces[A].points[(g+2)%3];m=a.points[r];var G=a.points[y],J=a.points[H],L;D&&(m=o.vec3_multiply(m,C));L=this.projection_mode;if(L===q.uv.projection.SKY)r=a.sky_mapping,u>=x&&u>=E&&(B=m[2]/this.scale[2]+this.scale[2]/2,v=-m[1]/this.scale[1]+this.scale[1]/2,0>a.faces[A].normal[0]?(B=(r[2][2]-r[2][0])*(1-B),v=1-(r[2][3]-r[2][1])*v,B+=r[2][0],v+=r[2][1]):(B*=r[3][2]-r[3][0],v=1-(r[3][3]-r[3][1])*
v,B+=r[3][0],v+=r[3][1])),x>=u&&x>=E&&(B=m[0]/this.scale[0]+this.scale[0]/2,v=-m[2]/this.scale[2]+this.scale[2]/2,0>a.faces[A].normal[1]?(B*=r[1][2]-r[1][0],v=1-(r[1][3]-r[1][1])*v,B+=r[1][0],v-=r[1][1]):(B*=r[0][2]-r[0][0],v=1-(r[0][3]-r[0][1])*v,B+=r[0][0],v-=r[0][1])),E>=u&&E>=x&&(B=m[0]/this.scale[0]+this.scale[0]/2,v=m[1]/this.scale[1]+this.scale[1]/2,0>a.faces[A].normal[2]?(B*=r[4][2]-r[4][0],v=1-(r[4][3]-r[4][1])*(1-v),B+=r[4][0],v-=r[4][1]):(B=(r[5][2]-r[5][0])*(1-B),v=1-(r[5][3]-r[5][1])*
(1-v),B+=r[5][0],v+=r[5][1])),a.faces[A].setUV([B,v],g);else if(L===q.uv.projection.CUBIC)u>=x&&u>=E&&(B=m[2]/this.scale[2]+0.5,v=m[1]/this.scale[1]+0.5),x>=u&&x>=E&&(B=-m[0]/this.scale[0]+0.5,v=m[2]/this.scale[2]+0.5),E>=u&&E>=x&&(B=-m[0]/this.scale[0]+0.5,v=m[1]/this.scale[1]+0.5),0<a.faces[A].normal[0]&&(B=-B),0>a.faces[A].normal[1]&&(B=-B),0<a.faces[A].normal[2]&&(B=-B),a.faces[A].setUV([B,v],g);else if(L===q.uv.projection.PLANAR)B=this.projection_axis===q.uv.axis.X?m[2]/this.scale[2]+0.5:-m[0]/
this.scale[0]+0.5,v=this.projection_axis===q.uv.axis.Y?m[2]/this.scale[2]+0.5:m[1]/this.scale[1]+0.5,a.faces[A].setUV([B,v],g);else{if(L===q.uv.projection.CYLINDRICAL)L=this.projection_axis,L===q.uv.axis.X?(t=b(m[2],m[0],-m[1]),v=-m[0]/this.scale[0]+0.5):L===q.uv.axis.Y?(t=b(-m[0],m[1],m[2]),v=-m[1]/this.scale[1]+0.5):L===q.uv.axis.Z&&(t=b(-m[0],m[2],-m[1]),v=-m[2]/this.scale[2]+0.5),t=1-t/n,1!==this.wrap_w_count&&(t*=this.wrap_w_count),m=t,r=v;else if(L===q.uv.projection.SPHERICAL){var M,K,N;L=this.projection_axis;
L===q.uv.axis.X?(M=e[r]?e[r]:f(m[2],m[0],-m[1]),e[r]||(e[r]=M),K=e[y]?e[y]:f(G[2],G[0],-G[1]),e[y]||(e[y]=K),N=e[H]?e[H]:f(J[2],J[0],-J[1]),e[H]||(e[H]=N)):L===q.uv.axis.Y?(M=e[r]?e[r]:f(m[0],-m[1],m[2]),e[r]||(e[r]=M),K=e[y]?e[y]:f(G[0],-G[1],G[2]),e[y]||(e[y]=K),N=e[H]?e[H]:f(J[0],-J[1],J[2]),e[H]||(e[H]=N)):L===q.uv.axis.Z&&(M=e[r]?e[r]:f(-m[0],m[2],-m[1]),e[r]||(e[r]=M),K=e[y]?e[y]:f(-G[0],G[2],-G[1]),e[y]||(e[y]=K),N=e[H]?e[H]:f(-J[0],J[2],-J[1]),e[H]||(e[H]=N));Math.abs(M[0]-K[0])>s&&Math.abs(M[0]-
N[0])>s&&(M[0]=M[0]>K[0]&&M[0]>N[0]?M[0]-n:M[0]+n);Math.abs(M[1]-K[1])>s&&Math.abs(M[1]-N[1])>s&&(M[1]=M[1]>K[1]&&M[1]>N[1]?M[1]-n:M[1]+n);t=1-M[0]/n;r=0.5-M[1]/Math.PI;1!==this.wrap_w_count&&(t*=this.wrap_w_count);1!==this.wrap_h_count&&(r*=this.wrap_h_count);m=t}else r=m=0;a.faces[A].setUV([m,r],g)}}}return this}};return{UVMapper:y}});
CubicVR.RegisterModule("Renderer",function(h){var y=h.undef;return{renderObject:function(w,q,n,s,b,f,a){var c=!1,b=b||!1,f=f||!1;if(null!==w.compiled){var d=0,e=h.GLCore.gl,g,o=s===y?0:s.length,m,r=0,B,v=null,t=w.instanceMaterials||w.materials,A=(a=(w.wireframe||a)&&w.compiled.line_elements_ref)?w.compiled.line_elements_ref:w.compiled.elements_ref,D=!1,C,I,u;e.depthFunc(e.LEQUAL);n===y&&(n=cubicvr_identity);for(var x=0,E=A.length;x<E;x++){var v=a&&w.wireframeMaterial?w.wireframeMaterial:t[x],z=0,
r=!1;if(1>v.opacity&&b)c=!0;else if(!(f&&1<=v.opacity)){1!==v.opacity?(e.enable(e.BLEND),e.depthMask(0),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.depthMask(1),e.disable(e.BLEND),e.blendFunc(e.ONE,e.ONE));for(var F=0,H=A[x].length;F<H;F++)if(B=A[x][F][0],r=!1,g=A[x][F][1],z+=g,v.visible){if(!w.segment_state[B])if(z>g){d+=2*g;z-=g;if(o){I=!1;for(C=0;C<o;){g=o-C;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<C&&!I&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),I=!0);m=s[C];u=m.light_type;
for(r=0;r<g;r++)if(s[r+C].light_type!=u){g=r;break}v.use(m.light_type,g);m=v.shader[m.light_type][g];e.uniformMatrix4fv(m.matrixModelView,!1,q.mvMatrix);e.uniformMatrix4fv(m.matrixProjection,!1,q.pMatrix);e.uniformMatrix4fv(m.matrixObject,!1,n);e.uniformMatrix3fv(m.matrixNormal,!1,q.nMatrix);D||(v.bindObject(w,m),D=-1!=m.vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(r=0;r<g;r++)s[r+C].setupShader(m,r);a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,
z,e.UNSIGNED_SHORT,d);C+=g}I&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else v.use(0,0),e.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,q.mvMatrix),e.uniformMatrix4fv(v.shader[0][0].matrixProjection,!1,q.pMatrix),e.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,n),e.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,q.nMatrix),D||(v.bindObject(w,v.shader[0][0]),D=-1!=v.shader[0][0].vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,
d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);d+=2*z;z=0;r=!0}else d+=2*z,z=0}else d+=2*g,z-=g;if(!r&&w.segment_state[B]&&v.visible){if(o){I=!1;for(C=0;C<o;){g=o-C;g>h.MAX_LIGHTS&&(g=h.MAX_LIGHTS);0<C&&!I&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),I=!0);m=s[C];u=m.light_type;for(r=0;r<g;r++)if(s[r+C].light_type!=u){g=r;break}v.use(m.light_type,g);m=v.shader[m.light_type][g];e.uniformMatrix4fv(m.matrixModelView,!1,q.mvMatrix);e.uniformMatrix4fv(m.matrixProjection,!1,q.pMatrix);
e.uniformMatrix4fv(m.matrixObject,!1,n);e.uniformMatrix3fv(m.matrixNormal,!1,q.nMatrix);D||(v.bindObject(w,m),D=-1!=m.vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(r=0;r<g;r++)s[r+C].setupShader(m,r);a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);C+=g}I&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else v.use(0,0),e.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,q.mvMatrix),e.uniformMatrix4fv(v.shader[0][0].matrixProjection,
!1,q.pMatrix),e.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,n),e.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,q.nMatrix),D||(v.bindObject(w,v.shader[0][0]),D=-1!=v.shader[0][0].vertexTexCoord,a&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,d):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,d);d+=2*z}}}v&&m?v.clearObject(w,m):v.clearObject(w,null);e.depthMask(1);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}}}});
CubicVR.RegisterModule("Light",function(h){function y(b,f){var a=h.aabb,b=h.get(b)||{};b===n&&(b=q.light.type.POINT);f===n&&(f=q.light.method.DYNAMIC);"object"==typeof b?(this.light_type=b.type!==n?h.parseEnum(q.light.type,b.type):q.light.type.POINT,this.diffuse=b.diffuse!==n?b.diffuse:[1,1,1],this.specular=b.specular!==n?b.specular:[1,1,1],this.intensity=b.intensity!==n?b.intensity:1,this.position=b.position!==n?b.position:[0,0,0],this.direction=b.direction!==n?b.direction:[0,0,0],this.distance=
b.distance!==n?b.distance:this.light_type===q.light.type.AREA?30:10,this.cutoff=b.cutoff!==n?b.cutoff:60,this.map_res=b.map_res!==n?b.map_res:this.light_type===q.light.type.AREA?2048:512,this.map_res=b.mapRes!==n?b.mapRes:this.map_res,this.method=b.method!==n?h.parseEnum(q.light.method,b.method):f,this.areaCam=b.areaCam!==n?b.areaCam:null,this.areaCeiling=b.areaCeiling!==n?b.areaCeiling:40,this.areaFloor=b.areaFloor!==n?b.areaFloor:-40,this.areaAxis=b.areaAxis!==n?b.areaAxis:[1,1,0],this.projectorTex=
b.projector!==n?b.projector:null):(this.light_type=h.parseEnum(q.light.type,b),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===q.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===q.light.type.AREA?2048:512,this.method=h.parseEnum(q.light.method,f),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&"string"===typeof this.projectorTex){var c=
this.projectorTex;this.projectorTex=h.Textures_ref[c]!==n?h.Textures_obj[h.Textures_ref[c]]:new h.Texture(c)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=h.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===
q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA&&h.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var w=h.GLCore,q=h.enums,n=h.undef,s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];q.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};y.prototype={get x(){return this.position[0]},set x(b){this.position[0]=
b},get y(){return this.position[1]},set y(b){this.position[1]=b},get z(){return this.position[2]},set z(b){this.position[2]=b},get rotX(){return this.rotation[0]},set rotX(b){this.rotation[0]=b},get rotY(){return this.rotation[1]},set rotY(b){this.rotation[1]=b},get rotZ(){return this.rotation[2]},set rotZ(b){this.rotation[2]=b},get dirX(){return this.direction[0]},set dirX(b){this.direction[0]=b},get dirY(){return this.direction[1]},set dirY(b){this.direction[1]=b},get dirZ(){return this.direction[2]},
set dirZ(b){this.direction[2]=b},get pos(){return this.position.slice(0)},set pos(b){this.position=b.slice(0)},get rot(){return this.rotation.slice(0)},set rot(b){this.rotation=b.slice(0)},get dir(){return this.direction.slice(0)},set dir(b){this.direction=vec3.normalize(b.slice(0))},setType:function(b){if(b===q.light.type.AREA&&!h.features.lightShadows)this.dummyCam=new h.Camera,this.areaCam=new h.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,b=q.light.type.DIRECTIONAL;else if((b===
q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR)&&!h.features.lightShadows)b=q.light.type.SPOT;this.light_type=b},setParent:function(b){this.parent=b},setMethod:function(b){this.method=b},setDiffuse:function(b){this.diffuse=b},setSpecular:function(b){this.specular=b},setIntensity:function(b){this.intensity=b},setPosition:function(b){this.position=b},setDistance:function(b){this.distance=b},setCutoff:function(b){this.cutoff=b},prepare:function(b){var f=h.mat4,a=h.mat3,c=this.light_type;
this.parent?c===q.light.type.SPOT||c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR?(c=f.inverse_mat3(this.parent.tMatrix),a.transpose_inline(c),this.lDir=a.vec3_multiply(this.direction,c),this.lDir=a.vec3_multiply(this.lDir,b.nMatrix),this.lPos=f.vec3_multiply(this.position,f.multiply(b.mvMatrix,this.parent.tMatrix))):c===q.light.type.POINT&&(this.lPos=f.vec3_multiply(this.position,f.multiply(b.mvMatrix,this.parent.tMatrix))):c===q.light.type.DIRECTIONAL?this.lDir=a.vec3_multiply(this.direction,
b.nMatrix):c===q.light.type.SPOT||c===q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=a.vec3_multiply(this.direction,b.nMatrix),this.lPos=f.vec3_multiply(this.position,b.mvMatrix)):c===q.light.type.POINT?this.lPos=f.vec3_multiply(this.position,b.mvMatrix):c===q.light.type.AREA&&(this.lDir=a.vec3_multiply(this.direction,b.nMatrix))},control:function(b,f,a){b===q.motion.POS?this.position[f]=a:b===q.motion.INTENSITY&&(this.intensity=a)},getAABB:function(){var b=h.vec3,f=h.aabb,
a=[[0,0,0],[0,0,0]];f.engulf(a,[this.distance,this.distance,this.distance]);f.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=b.add(a[0],this.position);a[1]=b.add(a[1],this.position);return this.aabb=a},setDirection:function(b,f,a){var c=h.vec3;if("object"===typeof b)this.setDirection(b[0],b[1],b[2]);else return this.direction=c.normalize([b,f,a]),this},lookat:function(b,f,a){var c=h.vec3;if("object"===typeof b)this.lookat(b[0],b[1],b[2]);else return this.direction=c.normalize(c.subtract([b,
f,a],this.position)),this},setRotation:function(b,f,a){var c=h.mat4,d=h.vec3;if("object"===typeof b)this.setRotation(b[0],b[1],b[2]);else{var e=new h.Transform;e.rotate([-b,-f,-a]);e.pushMatrix();this.direction=d.normalize(c.vec3_multiply([1,0,0],e.getResult()));this.rotation=[b,f,a];return this}},setupShader:function(b,f){var a=w.gl;a.uniform3fv(b.lightDiffuse[f],this.diffuse);a.uniform3fv(b.lightSpecular[f],this.specular);this.lPos&&a.uniform3fv(b.lightPosition[f],this.lPos);this.lDir&&a.uniform3fv(b.lightDirection[f],
this.lDir);a.uniform1f(b.lightIntensity[f],this.intensity);a.uniform1f(b.lightDistance[f],this.distance);(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.SPOT)&&a.uniform1f(b.lightCutOffAngle[f],this.cutoff);if(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA)this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(w.gl.TEXTURE0+
2*f),a.uniform1i(b.lightShadowMap[f],2*f),this.projectorTex.use(w.gl.TEXTURE0+2*f+1),a.uniform1i(b.lightProjectionMap[f],2*f+1)):(this.shadowMapTex.texture.use(w.gl.TEXTURE0+f),a.uniform1i(b.lightShadowMap[f],f)),a.uniform3fv(b.lightDepthClip[f],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(b.lightShadowMatrix[f],!1,this.spMatrix)},setShadow:function(b){h.features.lightShadows&&(this.map_res=b,this.shadowMapTex=new h.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(q.texture.filter.NEAREST),
this.dummyCam=new h.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(b){this.projectorTex=b},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var b=w.gl,f=h.mat4,a=h.mat3;this.shadowMapTex.use();b.viewport(0,0,this.map_res,this.map_res);b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT);this.light_type!==q.light.type.AREA?
(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var c=f.inverse_mat3(this.parent.tMatrix);a.transpose_inline(c);a.vec3_multiply(this.direction,c);f.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);f.multiply(this.dummyCam.mvMatrix.slice(0),
f.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);b.cullFace(b.FRONT)},shadowEnd:function(){var b=w.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.cullFace(b.BACK);this.setupTexGen()},setupTexGen:function(){var b=h.mat4;this.spMatrix=b.multiply(s,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=
b.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=b.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(b){this.areaAxis=b},updateAreaLight:function(){var b=h.vec3,f=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),c=b.subtract(this.areaCam.target,this.areaCam.position);c[1]=0;c=b.normalize(c);b.normalize(b.cross(c,[0,1,0]));var d=-Math.atan2(c[2],c[0]),a=this.distance/2*Math.abs(a)-
this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);var c=b.multiply(c,a),a=this.areaAxis[1]*(Math.PI/180),e=Math.tan(this.areaAxis[0]*(Math.PI/180)),a=[Math.tan(a),0,e],d=d-Math.atan2(a[0],a[2]);this.position=b.add(b.add(this.areaCam.position,c),b.multiply(a,f));this.position[1]=this.areaCeiling;this.target=b.add(b.add(this.areaCam.position,c),b.multiply(a,-f));this.target[1]=this.areaFloor;this.direction=b.normalize(b.subtract(this.target,this.position));this.dummyCam.rotation[2]=d*(180/
Math.PI);b=this.dummyCam.farclip*Math.abs(this.direction[1])*f;f=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);f[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);f=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);f[1][1]>this.areaFloor&&(f=f[1][1]-this.areaFloor,b+=f/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=
b;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(b,f,a,c,d,e){var c=h.vec3,g=c.normalize([d[0],d[4],d[8]]),o=c.normalize([d[1],d[5],d[9]]),d=c.normalize(c.cross(o,g)),m;m=a/2;a=[];f=c.multiply(g,f/2);g=c.multiply(o,m);e=c.multiply(d,e);a[0]=c.add(c.subtract(b,f),c.add(g,e));a[1]=c.add(c.add(b,f),c.add(g,e));a[2]=c.subtract(c.subtract(b,f),c.add(g,e));a[3]=c.subtract(c.add(b,f),c.add(g,e));aabb1=a[0];aabb2=a[0];for(b=1;4>b;b++)aabb1[0]>
a[b][0]&&(aabb1[0]=a[b][0]),aabb1[1]>a[b][1]&&(aabb1[1]=a[b][1]),aabb1[2]>a[b][2]&&(aabb1[2]=a[b][2]),aabb2[0]<a[b][0]&&(aabb2[0]=a[b][0]),aabb2[1]<a[b][1]&&(aabb2[1]=a[b][1]),aabb2[2]<a[b][2]&&(aabb2[2]=a[b][2]);return[aabb1,aabb2]}};return{Light:y}});
CubicVR.RegisterModule("Camera",function(h){function y(a,c,d,e,g){var b=h.mat4;this.frustum=new h.Frustum;"object"==typeof a?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==n?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==n?a.calcNormalMatrix:!0,this.name=a.name||"camera"+f,c=a.height?a.height:n,a=a.width?
a.width:n):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=d!==n?d:60,this.nearclip=e!==n?e:0.1,this.farclip=g!==n?g:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+f);this.motion=this.targetSceneObject=null;this.transform=new h.Transform;this.manual=!1;this.setDimensions(a!==n?a:512,c!==n?c:512);this.mvMatrix=b.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++f}function w(a){this.position=
a!==n?a:[0,0,0]}function q(a,c,d){this.camPath=new h.Motion;this.targetPath=new h.Motion;this.start_position=a!==n?a:[8,8,8];this.target=c!==n?c:[0,0,0];this.bounds=d!==n?d:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var n=h.undef,s=h.enums,b=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],f=0;y.prototype={get x(){return this.position[0]},
set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get targetX(){return this.target[0]},set targetX(a){this.target[0]=a},get targetY(){return this.target[1]},set targetY(a){this.target[1]=a},get targetZ(){return this.target[2]},
set targetZ(a){this.target[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},trackTarget:function(a,c,d){this.position=h.vec3.trackTarget(this.position,a,c,d)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?h.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(a,c,d,e){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=c;this.ortho_view.bottom=d;this.ortho_view.top=e},control:function(a,c,d){a===s.motion.ROT?this.rotation[c]=d:a===s.motion.POS?this.position[c]=d:a===s.motion.FOV?this.setFOV(d):a===s.motion.LENS?this.setLENS(d):a===s.motion.NEARCLIP?this.setClip(d,this.farclip):a===s.motion.FARCLIP&&this.setClip(this.nearclip,d)},makeFrustum:function(a,c,d,e,g,b){return[2*g/(c-a),0,0,0,0,2*g/
(e-d),0,0,(c+a)/(c-a),(e+d)/(e-d),-(b+g)/(b-g),-1,0,0,-2*b*g/(b-g),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=h.mat4,c=h.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),c.transpose_inline(this.nMatrix)):a.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,c){this.nearclip=a;this.farclip=c;this.calcProjection()},setDimensions:function(a,c){this.width=a;this.height=c;this.aspect=a/c;this.calcProjection()},
resize:function(a,c){this.setDimensions(a,c)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,c,d,e,g,f,m,r,B){var v=h.mat4,t=h.mat3;"object"==typeof a?this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0):(this.mvMatrix=v.lookat(a,c,d,e,g,f,m,r,B),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),
this.mvMatrix=this.transform.getResult()),null!==this.parent&&v.multiply(this.mvMatrix.slice(0),v.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=v.inverse_mat3(this.mvMatrix),t.transpose_inline(this.nMatrix)):this.nMatrix=b,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(a,c,d){var e=h.mat4,g=h.vec3,b=[0,0,this.width,this.height],a=e.vec4_multiply(e.vec4_multiply([2*((a-b[0])/b[2])-1,-(2*((c-b[1])/b[3])-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),
a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];return d!==n?(c=this.getParentedPosition(),g.add(c,g.multiply(g.normalize(g.subtract(a,c)),d))):a},project:function(a,c,d){var e=h.mat4,e=e.vec4_multiply(e.vec4_multiply([a,c,d,1],this.mvMatrix),this.pMatrix);e[2]=h.vec3.length(h.vec3.subtract([a,c,d],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};w.prototype={control:function(a,c,d){a===s.motion.POS&&(this.position[c]=d)}};q.prototype={inBounds:function(a){var c=h.vec3;if(!(a[0]>
this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var d=0,e=this.avoid_sphere.length;d<e;d++)if(c.length(a,this.avoid_sphere[d][0])<this.avoid_sphere[d][1])return!1;return!0},findNextNode:function(a,c){var d=h.vec3,e=[0,0,0],g=[0,0,0],b=e=0,m=!1;do if(g[0]=Math.random()-0.5,g[1]=Math.random()-0.5,g[2]=Math.random()-0.5,g=d.normalize(g),e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,
e=d.add(c.position,d.multiply(g,e)),m=this.inBounds(e),b++,30<b){e=c.position;break}while(!m);return e},run:function(a){this.current_time=a;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(s.motion.POS,s.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,this.start_position[2]));for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=
this.segment_time;var c=new w,d=new w;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,c);this.camPath.apply(this.path_time-this.segment_time,d);c=this.findNextNode(c,d);this.camPath.setKey(s.motion.POS,s.motion.X,this.path_time,c[0]);this.camPath.setKey(s.motion.POS,s.motion.Y,this.path_time,c[1]);this.camPath.setKey(s.motion.POS,s.motion.Z,this.path_time,c[2]);this.path_length++}c=new w;this.camPath.apply(a,c);return c.position},addSafeBound:function(a,c){this.safe_bb.push([a,
c])},addAvoidSphere:function(a,c){this.avoid_sphere.push([a,c])}};return{Camera:y,AutoCamera:q}});
CubicVR.RegisterModule("Motion",function(h){function y(){this.time=this.value=0;this.shape=s.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function w(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(s.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||s.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||s.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=s.envelope.behavior.CONSTANT}function q(a,c){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var d=CubicVR.get(a);this.env_init=CubicVR.get(d.envelope);this.key_init=CubicVR.get(d.key);for(var m in d)if(d.hasOwnProperty(m)&&!("envelope"===m||"key"===m)){var b=d[m],f=CubicVR.get(b.envelope),v;for(v in b)if(b.hasOwnProperty(v)&&!("envelope"===v||"key"===v)){var t=b[v];if("object"===typeof t)for(var n in t)this.setKey(m,n,v,t[n]),f&&this.setBehavior(m,n,
f)}}}else this.env_init=a,this.key_init=c}var n=h.undef,s=CubicVR.enums;s.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};s.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var b=function(a,c,d){var m=0,m=d-c;if(0===m)return[c,0];c=a-m*Math.floor((a-c)/m);m=-parseInt((c-a)/m+(c>a?0.5:-0.5),10);return[c,m]},f=function(a,c,d,m,b){var f,v;v=b*b;f=3*(c-
a);c=3*(d-c)-f;return(m-a-f-c)*v*b+c*v+f*b+a},a=function(c,g,d,b,r,n,v){var t,h;h=n+0.5*(v-n);t=f(c,g,d,b,h);return 1.0E-4<Math.abs(r-t)?(t>r?v=h:n=h,a(c,g,d,b,r,n,v)):h},c=function(a,c){var d,b,f,n;a.shape===s.envelope.shape.TCB?(d=(1-a.tension)*(1+a.continuity)*(1+a.bias),b=(1-a.tension)*(1-a.continuity)*(1-a.bias),f=c.value-a.value,a.prev?(n=(c.time-a.time)/(c.time-a.prev.time),d=n*(d*(a.value-a.prev.value)+b*f)):d=b*f):a.shape===s.envelope.shape.LINE?(f=c.value-a.value,a.prev?(n=(c.time-a.time)/
(c.time-a.prev.time),d=n*(a.value-a.prev.value+f)):d=f):a.shape===s.envelope.shape.BEZI||a.shape===s.envelope.shape.HERM?(d=a.param[1],a.prev&&(d*=(c.time-a.time)/(c.time-a.prev.time))):a.shape===s.envelope.shape.BEZ2?(d=a.param[3]*(c.time-a.time),d=1.0E-5<Math.abs(a.param[2])?d/a.param[2]:1E5*d):d=0;return d},d=function(a,c){var d,b,f,n;c.shape===s.envelope.shape.LINE?(f=c.value-a.value,c.next?(n=(c.time-a.time)/(c.next.time-a.time),d=n*(c.next.value-c.value+f)):d=f):c.shape===s.envelope.shape.TCB?
(d=(1-c.tension)*(1-c.continuity)*(1+c.bias),b=(1-c.tension)*(1+c.continuity)*(1-c.bias),f=c.value-a.value,c.next?(n=(c.time-a.time)/(c.next.time-a.time),d=n*(b*(c.next.value-c.value)+d*f)):d*=f):c.shape===s.envelope.shape.HERM||c.shape===s.envelope.shape.BEZI?(d=c.param[0],c.next&&(d*=(c.time-a.time)/(c.next.time-a.time))):c.shape===s.envelope.shape.BEZ2?(d=c.param[1]*(c.time-a.time),d=1.0E-5<Math.abs(c.param[0])?d/c.param[0]:1E5*d):d=0;return d};w.prototype={setBehavior:function(a,c){this.in_behavior=
CubicVR.parseEnum(s.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(s.envelope.behavior,c)},empty:function(){return 0===this.nKeys},addKey:function(a,c,d){var b="object"==typeof a?a:d;c||(c=0);a||(a=0);b?(b=a,a=b.time,d=this.insertKey(a),d.value=b.value?b.value:c,d.time=b.time?b.time:a,d.shape=CubicVR.parseEnum(s.envelope.shape,b.shape)||s.envelope.shape.TCB,d.tension=b.tension?b.tension:0,d.continuity=b.continuity?b.continuity:0,d.bias=b.bias?b.bias:0,d.param=b.param?b.param:[0,0,0,0]):
(d=this.insertKey(a),d.value=c);return d},insertKey:function(a){var c=new y;c.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=c,this.nKeys++,c;for(var d=this.keys;d;){this.firstKey.time>a?this.firstKey=c:this.lastKey.time<a&&(this.lastKey=c);if(d.time>c.time)return c.prev=d.prev,c.prev&&(c.prev.next=c),c.next=d,c.next.prev=c,this.nKeys++,c;if(!d.next)return c.prev=d,d.next=c,this.nKeys++,c;d=d.next}return null},evaluate:function(e){var g,o,m,r,n,v=0;if(0===this.nKeys)return 0;if(1===
this.nKeys)return this.keys.value;o=this.firstKey;g=this.lastKey;if(e<o.time){r=this.in_behavior;if(r===s.envelope.behavior.RESET)return 0;if(r===s.envelope.behavior.CONSTANT)return o.value;if(r===s.envelope.behavior.REPEAT)r=b(e,o.time,g.time),e=r[0];else if(r===s.envelope.behavior.OCILLATE)r=b(e,o.time,g.time),e=r[0],r=r[1],r%2&&(e=g.time-o.time-e);else if(r===s.envelope.behavior.OFFSET)r=b(e,o.time,g.time),e=r[0],r=r[1],v=r*(g.value-o.value);else if(r===s.envelope.behavior.LINEAR)return n=c(o,
o.next)/(o.next.time-o.time),n*(e-o.time)+o.value}else if(e>g.time){r=this.out_behavior;if(r===s.envelope.behavior.RESET)return 0;if(r===s.envelope.behavior.CONSTANT)return g.value;if(r===s.envelope.behavior.REPEAT)r=b(e,o.time,g.time),e=r[0];else if(r===s.envelope.behavior.OCILLATE)r=b(e,o.time,g.time),e=r[0],r=r[1],r%2&&(e=g.time-o.time-e);else if(r===s.envelope.behavior.OFFSET)r=b(e,o.time,g.time),e=r[0],r=r[1],v=r*(g.value-o.value);else if(r===s.envelope.behavior.LINEAR)return r=d(g.prev,g)/(g.time-
g.prev.time),r*(e-g.time)+g.value}if(this.lastKey0)if(e>this.lastKey0.time)g=this.lastKey0;else if(e<this.lastKey0.time)for(g=this.lastKey;e<g.time&&g.prev;)g=g.prev;else g=this.keys;else g=this.keys;for(;e>g.next.time;)g=g.next;o=g.next;this.lastKey0=g;if(e===g.time)return g.value+v;if(e===o.time)return o.value+v;m=(e-g.time)/(o.time-g.time);r=o.shape;if(r===s.envelope.shape.TCB||r===s.envelope.shape.BEZI||r===s.envelope.shape.HERM){n=c(g,o);r=d(g,o);var t,h;h=m*m;t=m*h;e=3*h-t-t;t-=h;e=[1-e,e,t-
h+m,t];return e[0]*g.value+e[1]*o.value+e[2]*n+e[3]*r+v}return r===s.envelope.shape.BEZ2?(e=a(g.time,g.shape===s.envelope.shape.BEZ2?g.time+g.param[2]:g.time+(o.time-g.time)/3,o.time+o.param[0],o.time,e,0,1),f(g.value,g.shape===s.envelope.shape.BEZ2?g.value+g.param[3]:g.value+g.param[1]/3,o.param[1]+o.value,o.value,e)+v):r===s.envelope.shape.LINE?g.value+m*(o.value-g.value)+v:r===s.envelope.shape.STEP?g.value+v:v}};q.prototype={clone:function(){var a=new h.Motion(this.env_init,this.key_init),c;for(c in this.controllers)if(this.controllers.hasOwnProperty(c)){a.controllers[c]===
n&&(a.controllers[c]=[]);for(var d in this.controllers[c])if(this.controllers[c].hasOwnProperty(d)){var b=this.controllers[c][d],f=a.controllers[c][d]=new w({in_behavior:b.in_behavior,out_behavior:b.out_behavior});f.nKeys=b.nKeys;f.keys=b.keys;f.firstKey=b.firstKey;f.lastKey=b.lastKey}}return a},envelope:function(a,c){c=CubicVR.parseEnum(s.motion,c)||0;a=CubicVR.parseEnum(s.motion,a)||0;this.controllers[a]===n&&(this.controllers[a]=[]);this.controllers[a][c]===n&&(this.controllers[a][c]=new w(this.env_init));
return this.controllers[a][c]},evaluate:function(a){var c=[],d;for(d in this.controllers)if(this.controllers.hasOwnProperty(d)){c[d]=[];for(var b in this.controllers[d])this.controllers[d].hasOwnProperty(b)&&(c[d][b]=this.controllers[d][b].evaluate(a))}return c},apply:function(a,c){for(var d in this.controllers)if(this.controllers.hasOwnProperty(d)){var b=parseInt(d,10);if(this.yzflip&&b===s.motion.ROT){this.q||(this.q=new CubicVR.Quaternion);var f=this.q,n=this.controllers[d][0].evaluate(a),v=this.controllers[d][1].evaluate(a),
t=this.controllers[d][2].evaluate(a);f.fromEuler(n,t,-v);f=f.toEuler();c.control(b,0,f[0]);c.control(b,1,f[1]);c.control(b,2,f[2])}else for(var h in this.controllers[d])this.controllers[d].hasOwnProperty(h)&&c.control(b,parseInt(h,10),this.controllers[d][h].evaluate(a))}},setKey:function(a,c,d,b,f){c=CubicVR.parseEnum(s.motion,c)||0;a=CubicVR.parseEnum(s.motion,a)||0;return this.envelope(a,c).addKey(d,b,f?f:this.key_init)},setArray:function(a,c,d,b){var f=[],a=CubicVR.parseEnum(s.motion,a)||0,n;for(n in d)if(d.hasOwnProperty(n)){var v=
this.envelope(a,CubicVR.parseEnum(s.motion,n));f[n]=v.addKey(c,d[n],b?b:this.key_init)}return f},setBehavior:function(a,c,d,b){var f=this.envelope(a,c);"object"===typeof d&&(b=d,d=b.in_behavior||b.inBehavior||b.behavior,b=b.out_behavior||b.outBehavior||b.behavior);CubicVR.parseEnum(s.motion,c);CubicVR.parseEnum(s.motion,a);f.setBehavior(d,b)},setBehaviorArray:function(a,c,d){var a=CubicVR.parseEnum(s.motion,a)||0,b=this.controllers[a],f;for(f in b)b.hasOwnProperty(f)&&this.envelope(a,CubicVR.parseEnum(s.motion,
f)||0).setBehavior(c,d)}};return{Motion:q,Envelope:w,EnvelopeKey:y}});
CubicVR.RegisterModule("EventHandler",function(h){function y(f){f=CubicVR.parseEnum(s.event,f);return f===n?(b("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(f,10))&&(f>=s.event.EVENT_MAX||0>f)?(b("Unknown event ID passed: "+f),!1):f}function w(b){b=b||{};this.name=b.name;b.id=y(b.id)||s.event.TICK;this.id=b.id;this.interval=b.interval||0;this.enabled=b.enabled||
!0;this.action=b.action||null;this.properties=b.properties||{};this.event_properties=b.event_properties||{};this.buffered=b.buffered||!1;this.weight=b.weight===n?-1:b.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function q(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var n=h.undef,
s=CubicVR.enums,b=h.log;s.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};w.prototype={getName:function(){return this.name},setName:function(b){this.name=b},getSubject:function(){return this.subject},setSubject:function(b){this.subject=b},getId:function(){return this.id},setId:function(b){this.id=b},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(b){b&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=b},isBuffered:function(){return this.buffered},setBuffered:function(b){this.buffered=b},setInterval:function(b){this.interval=b},getInterval:function(){return this.interval},setAction:function(b){this.action=b},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(b){this.properties=
b},getProperty:function(b){return this.properties[b]},setProperty:function(b,a){this.properties[b]=a},setEventProperties:function(b){this.event_properties=b},getEventProperties:function(){return this.event_properties},getEventProperty:function(b){return this.event_properties[b]},setEventProperty:function(b,a){this.properties[b]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(b){this.t_rest=b},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(b){this.setRestInterval(b||0)},awake:function(){this.t_rest=0},update:function(b,a){if(!this.enabled)return!1;var c=0,d=!0;0===this.n_updates?(this.t_updatecall=this.t_update=b,c=1/60):b!==this.t_update?
(this.t_rest||(this.t_last=b-this.t_update,this.t_update=b),c=b-this.t_updatecall,this.t_updatecall=b):d=!1;if(0<this.t_rest)d&&(this.t_resting+=c,this.t_rest-=c,0>this.t_rest&&(this.t_rest=0));else return d&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(a),!0;d&&this.n_updates++;return!1},callEvent:function(b){return!this.action?!1:this.action(this,b)}};q.prototype={addEvent:function(b){b.callEvent||(b=new w(b));var a=b.getId();
this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(b);-1===this.listenerNames.indexOf(a)&&this.listenerNames.push(a);return b},removeEvent:function(b){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(b)&&this.lockRemovals.push(b);else{var a=this.events.indexOf(b);-1!==a&&(b=b.getId(),this.events.splice(a,1),this.listeners[b]--,this.listeners[b]||(this.eventHandled[b]=!0,this.eventParameters[b]=
{},this.eventProperties[b]=[],this.eventPropertyCount[b]=0,a=this.listenerNames.indexOf(b),0<=a&&this.listenerNames.splice(a,1)))}},getProperties:function(b){this.eventParameters[b]=this.eventParameters[b]||{};return this.eventParameters[b]},setProperties:function(b,a){this.eventParameters[b]=a},getProperty:function(b,a){return this.getProperties(b)[a]},setProperty:function(b,a,c){this.getProperties(b)[a]=c},hasEvent:function(b){return!!this.listeners[b]},triggerEvent:function(b,a){if(!this.listeners[b])return null;
this.eventProperties[b]==n&&(this.eventProperties[b]=[]);var c=this.eventProperties[b];this.eventPropertyCount[b]===n&&(this.eventPropertyCount[b]=0);var d=this.eventPropertyCount[b];20<d&&console.log("Warning, event "+b+" count > 20: "+d);c[d]=a&&c?a:c[d]||{};this.eventPropertyCount[b]++;this.eventHandled[b]=!1;return c[d]},update:function(b){var a,c,d,e,g,o;if(this.hasEvent(s.event.TICK)&&0===this.eventPropertyCount[s.event.TICK]&&(a=this.triggerEvent(s.event.TICK)))a.time=b,a.handler=this;this.lockState=
!0;a=0;for(c=this.events.length;a<c;a++){g=this.events[a];o=g.getId();e=this.eventPropertyCount[o];var m=!1;d=!1;if(e){var r=this.eventProperties[o];if(g.isEnabled()){if(g.isBuffered()){if(r.length=e,g.setEventProperties(r),m=m||g.update(b,this),g.isChainBroken()){g.breakChain(!1);break}}else for(d=0;d<e;d++)if(g.setEventProperties(r[a]),m=m||g.update(b,this),g.isChainBroken()){g.breakChain(!1);break}d=!0}}if(m||!d)this.eventHandled[o]=!0}a=0;for(c=this.listenerNames.length;a<c;a++)o=this.listenerNames[a],
this.eventHandled[o]&&(this.eventPropertyCount[o]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(c=this.lockRemovals.length;a<c;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:w,EventHandler:q,registerEvent:function(f){f=f.toUpperCase();s.event[f]!==n?b("Error, event '"+f+"' is already registered."):(s.event[f]=s.event.ENUM_MAX,s.event.ENUM_MAX++)},validateEvent:y}});
CubicVR.RegisterModule("Scene",function(h){function y(a,c){return a.light_type-c.light_type}function w(g,d){var b=null,e;g!==s&&null!==g?g.compile?b={}:(b=h.get(g)||{},g=null):b={};this.morphWeight=b.morphWeight||0;this.morphSource=b.morphSource||-1;this.morphTarget=b.morphTarget||-1;this.position=b.position===s?[0,0,0]:b.position;this.rotation=b.rotation===s?[0,0,0]:b.rotation;this.scale=b.scale===s?[1,1,1]:b.scale;this.shadowCast=b.shadowCast===s?!0:b.shadowCast;this.wireframe=b.wireframe||!1;this.motion=
b.motion===s?null:h.get(b.motion,h.Motion)||null;this.obj=!b.mesh?g?h.get(g,h.Mesh):null:h.get(b.mesh,h.Mesh);this.name=b.name===s?d!==s?d:null:b.name;this.properties=h.get(b.properties)||{};this.parent=this.children=null;var f=b.children||b.child||b.sceneObject||b.sceneObjects;if(f){if(f&&!f.length||"string"===typeof f)f=[f];if(f.length){b=0;for(e=f.length;b<e;b++)this.bindChild(h.get(f[b],h.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=c.identity();this.tMatrix=c.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function q(a,c,d,b,f,n){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=h.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+e;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
c=a.setup&&a.setup(this)||{};this.update=c.update||this.update;this.enable=c.enable||this.enable;this.disable=c.disable||this.disable;this.destroy=c.destroy||this.destroy;if((b=a.sceneObjects||a.sceneObject||a.objects)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindSceneObject(h.get(b[c],h.SceneObject))}if((b=a.lights||a.light)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindLight(h.get(b[c],h.Light))}if((b=a.cameras||
a.camera)&&!b.length||"string"===typeof b)b=[b];if(b&&b.length){c=0;for(d=b.length;c<d;c++)this.bindCamera(h.get(b[c],h.Camera));this.camera=this.cameras[0]}b||(this.camera=new h.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip))}else this.skybox=null,this.octree=n,this.name="scene"+e,this.camera=new h.Camera(a,c,d,b,f),this.wireframe=!1;this.paused=!1;++e}function n(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var s=h.undef,b=h.enums,
f=h.GLCore,a=h.aabb,c=h.mat4,d=0;w.prototype={get x(){return this.position[0]},set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=
a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},get sclX(){return this.scale[0]},set sclX(a){this.scale[0]=a},get sclY(){return this.scale[1]},set sclY(a){this.scale[1]=a},get sclZ(){return this.scale[2]},set sclZ(a){this.scale[2]=a},get scl(){return this.scale.slice(0)},set scl(a){this.scale=a.slice(0)},clone:function(){var a,c;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var d=new h.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),
rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){d.instanceMaterials=[];a=0;for(c=this.instanceMaterials.length;a<c;a++)d.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(null!==this.children){a=0;for(c=this.children.length;a<c;a++)d.bindChild(this.children[a].clone())}return d},
evaluate:function(a){var c,d;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(null!==this.children){c=0;for(d=this.children.length;c<d;c++)this.children[c].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){this.eventHandler||(this.eventHandler=new h.EventHandler);a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},
getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,c){this.properties[a]=c},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,c=this.obj.materials.length;a<c;a++)this.instanceMaterials[a]=
this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var c=this.getInstanceMaterials(),d=0,b=c.length;d<b;d++)if(c[d].name==a)return c[d];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?
this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MATRIX_UPDATE)&&(a.triggerEvent(b.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(a){var d=h.vec3;if(!this.matrixLock&&(!d.equal(this.lposition,this.position)||!d.equal(this.lrotation,this.rotation)||!d.equal(this.lscale,
this.scale)||a!==s))a!==s?this.tMatrix=a.slice(0):c.identity(this.tMatrix),c.identity(this.lMatrix),c.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),c.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||c.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),c.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],
this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(b.event.MOVE)&&(a=a.triggerEvent(b.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale))},adjust_octree:function(){var c=
this.getAABB(),d=this.octree_aabb,b=c[0][0],e=c[0][1],f=c[0][2],n=c[1][0],t=c[1][1],h=c[1][2],q=d[0][0],w=d[0][1],I=d[0][2],u=d[1][0],x=d[1][1],d=d[1][2];if(0<this.octree_leaves.length&&(b<q||e<w||f<I||n>u||t>x||h>d)){for(b=0;b<this.octree_leaves.length;++b)this.octree_leaves[b].remove(this);this.octree_leaves=[];this.static_lights=[];b=this.octree_common_root;this.octree_common_root=null;if(null!==b){for(;;)if(!b.contains_point(c[0])||!b.contains_point(c[1]))if(b._root!==s&&null!==b._root)b=b._root;
else break;else break;a.reset(this.octree_aabb,this.position);b.insert(this)}}},bindChild:function(a){null===this.children&&(this.children=[]);a.parent=this;this.children.push(a)},control:function(a,c,d){a===b.motion.POS?this.position[c]=d:a===b.motion.SCL?this.scale[c]=d:a===b.motion.ROT&&(this.rotation[c]=d)},getAABB:function(){var a=h.mat4,c=h.vec3;if(this.dirty){var d=Array(8);this.doTransform();var b,e;if(this.obj){if(!this.obj.bb)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,
1],this.position)];b=this.obj.bb[0];e=this.obj.bb[1]}if(!this.obj||b===s||e===s)return this.aabb=[c.add([-1,-1,-1],this.position),c.add([1,1,1],this.position)];var f=b;b=c.subtract(e,b);d[0]=[f[0],f[1],f[2]];d[1]=[f[0],f[1],f[2]+b[2]];d[2]=[f[0]+b[0],f[1],f[2]];d[3]=[f[0]+b[0],f[1],f[2]+b[2]];d[4]=[f[0],f[1]+b[1],f[2]];d[5]=[f[0],f[1]+b[1],f[2]+b[2]];d[6]=[f[0]+b[0],f[1]+b[1],f[2]];d[7]=[f[0]+b[0],f[1]+b[1],f[2]+b[2]];f=a.vec3_multiply(d[0],this.tMatrix);b=[f[0],f[1],f[2]];e=[f[0],f[1],f[2]];for(c=
1;8>c;++c)f=a.vec3_multiply(d[c],this.tMatrix),b[0]>f[0]&&(b[0]=f[0]),b[1]>f[1]&&(b[1]=f[1]),b[2]>f[2]&&(b[2]=f[2]),e[0]<f[0]&&(e[0]=f[0]),e[1]<f[1]&&(e[1]=f[1]),e[2]<f[2]&&(e[2]=f[2]);this.aabb[0]=b;this.aabb[1]=e;this.dirty=!1}return this.aabb}};var e=0;q.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(c){this.octree=c;c.init&&c.init(this);c=this.lights;this.lights=[];for(var b=0,e=c.length;b<e;b++)this.bindLight(c[b]);c=
this.sceneObjects;if(this.octree!==s){b=0;for(e=c.length;b<e;++b){var f=c[b];null!==f.obj&&(0>f.id&&(f.id=d,++d),this.sceneObjectsById[f.id]=f,a.reset(f.octree_aabb,f.position),this.octree.insert(f),(void 0===f.octree_common_root||null===f.octree_common_root)&&log("!!",f.name,"octree_common_root is null"))}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(c,b,e){if(-1==this.sceneObjects.indexOf(c)){this.sceneObjects.push(c);
b!==s&&b&&this.pickables.push(c);null!==c.name&&(this.sceneObjectsByName[c.name]=c);if(this.octree!==s&&(e===s||"true"===e))0>c.id&&(c.id=d,++d),this.sceneObjectsById[c.id]=c,a.reset(c.octree_aabb,c.position),this.octree.insert(c);if(c.children)for(var f=0,n=c.children.length;f<n;f++)this.bindSceneObject(c.children[f],b,e);return c}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var c;if(this.lockState)this.lockRemovals||(this.lockRemovals=
[]),-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a);else if(c=this.sceneObjects.indexOf(a),0<=c&&this.sceneObjects.splice(c,1),c=this.pickables.indexOf(a),0<=c&&this.pickables.splice(c,1),null!==a.name&&this.sceneObjectsByName[a.name]!==s&&delete this.sceneObjectsByName[a.name],a.children){c=0;for(var d=a.children.length;c<d;c++)this.removeSceneObject(a.children[c])}},bindLight:function(a,c){this.lights.push(a);if(this.octree!==s&&(c===s||"true"===c))a.method===b.light.method.GLOBAL?this.global_lights.push(a):
(a.method===b.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(y)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof h.Light?this.bindLight(a):a instanceof h.SceneObject?this.bindSceneObject(a):
a instanceof h.Camera?this.bindCamera(a):a instanceof h.Vehicle?a.bindToScene(this):a instanceof h.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof h.Light?this.removeLight(a):a instanceof h.SceneObject?this.removeSceneObject(a):a instanceof h.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){a&&("object"!==typeof a&&(a=this.getCamera(a)),this.camera=a)},getCamera:function(a){return a===s?
this.camera:this.camerasByName[a]},evaluate:function(a){var c,d;c=0;for(d=this.sceneObjects.length;c<d;c++)this.sceneObjects[c].motion&&!this.sceneObjects[c].independentMotion&&this.sceneObjects[c].motion.apply(a,this.sceneObjects[c]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(a,this.camera));c=0;for(d=this.lights.length;c<d;c++){var b=this.lights[c];null!==b.motion&&b.motion.apply(a,b)}},prepareTransforms:function(a){var c,
d;if(a){if(a.doTransform(),a.children){c=0;for(d=a.children.length;c<d;c++)a.children[c].doTransform(a.tMatrix),this.prepareTransforms(a.children[c])}}else if(0!==this.sceneObjects.length){c=0;for(d=this.sceneObjects.length;c<d;++c)this.prepareTransforms(this.sceneObjects[c])}},updateShadows:function(a){var c=f.gl;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(h.features.lightShadows){for(var a=c.getParameter(c.FRAMEBUFFER_BINDING),d=!1,e=c.getParameter(c.VIEWPORT),
n=0,v=this.lights.length;n<v;n++){var t=this.lights[n];if(t.light_type==b.light.type.SPOT_SHADOW||t.light_type==b.light.type.SPOT_SHADOW_PROJECTOR||t.light_type==b.light.type.AREA){var d=!0,q=[new h.Light(b.light.type.DEPTH_PACK)];t.light_type===b.light.type.AREA&&(t.areaCam=this.camera,t.updateAreaLight());f.shadow_near=t.dummyCam.nearclip;f.shadow_far=t.dummyCam.farclip;t.shadowBegin();for(var s=0,w=this.sceneObjects.length;s<w;s++){var I=this.sceneObjects[s];I.parent||!1===I.visible||!1===I.shadowCast||
this.renderSceneObject(I,t.dummyCam,q,!1,!0)}t.shadowEnd();a&&c.bindFramebuffer(c.FRAMEBUFFER,a)}}d&&c.viewport(e[0],e[1],e[2],e[3])}},updateCamera:function(){!1===this.camera.manual&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());f.depth_alpha_near=this.camera.nearclip;f.depth_alpha_far=this.camera.farclip},resize:function(a,c){this.camera&&
this.camera.setDimensions(a,c)},doTransform:function(){for(var a=this.octree!==s,c=0,d=this.sceneObjects.length;c<d;c++){var b=this.sceneObjects[c];null===b.parent&&(this.prepareTransforms(b),a&&(lights=[],b.dirty&&null!==b.obj&&b.adjust_octree(),!1===b.visible||a&&(b.ignore_octree||!0===b.drawn_this_frame||!0===b.culled)||(lights=b.dynamic_lights,lights=lights.concat(b.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(this.lights_rendered=Math.max(lights.length,this.lights_rendered),
this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered),lights=0===lights.length?[f.emptyLight]:lights.sort(y),b.drawn_this_frame=!0)))}},renderSceneObject:function(a,c,d,b,e,n,t){var q=!1,D=f.gl,b=b!==s&&b,e=e||!1,n=n||!1;if(a.visible&&a.obj){0>a.scale[0]&&(q=!q);0>a.scale[1]&&(q=!q);0>a.scale[2]&&(q=!q);q&&D.cullFace(D.FRONT);var w=a.obj;null!==w.morphTargets&&(-1!==a.morphSource&&w.setMorphSource(a.morphSource),-1!==a.morphTarget&&w.setMorphTarget(a.morphTarget),null!==
a.morphWeight&&(w.morphWeight=a.morphWeight));a.instanceMaterials&&w.bindInstanceMaterials(a.instanceMaterials);h.renderObject(w,c,a.tMatrix,d,e,n,this.isWireframe()||a.isWireframe())&&t&&t.push(a);a.instanceMaterials&&w.bindInstanceMaterials(null);q&&D.cullFace(D.BACK)}a=a.children;if(b&&a){b=0;for(q=a.length;b<q;b++)this.renderSceneObject(a[b],c,d,!0,e,n,t)}},runEvents:function(a){var c,d;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());c=0;for(d=this.sceneObjects.length;c<d;c++){var b=this.sceneObjects[c];
b.hasEvents()&&b.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){c=0;for(d=this.lockRemovals.length;c<d;c++)this.removeSceneObject(this.lockRemovals[c])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var d=f.gl,b;b=this.octree!==s;this.lights_rendered=0;b&&(this.octree.reset_node_visibility(),this.octree.cleanup(),b=this.octree.get_frustum_hits(this.camera),this.lights_rendered=b.lights.length);this.doTransform();
this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var e;b=0;for(e=this.lights.length;b<e;b++)this.lights[b].prepare(this.camera);this.objects_rendered=0;var n=[],v=[],t=this.lights;b=0;for(e=this.sceneObjects.length;b<e;b++){var q=this.sceneObjects[b];!1===q.visible||null!==q.parent||this.renderSceneObject(q,this.camera,t,!0,!0,!1,v)}b=0;for(e=v.length;b<e;b++)this.renderSceneObject(v[b],this.camera,t,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,
this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=n,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(d.cullFace(d.FRONT),b=2*this.camera.farclip/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?c.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=
[b,b,b],this.skybox.scene_object.doTransform(),h.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),d.cullFace(d.BACK));a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,c,d){var b=h.vec3,e=[],c=2===c.length?this.camera.unProject(c[0],c[1]):b.add(a,c),f;for(f in this.pickables)if(this.pickables.hasOwnProperty(f)){var t=this.pickables[f];if(!0===t.visible){var n,q;q=t.getAABB();n=q[0];q=q[1];0.2>q[0]-n[0]&&(n[0]-=
0.1,q[0]+=0.1);0.2>q[1]-n[1]&&(n[1]-=0.1,q[1]+=0.1);0.2>q[2]-n[2]&&(n[2]-=0.1,q[2]+=0.1);var s=b.multiply(b.add(n,q),0.5),w=b.getClosestTo(a,c,s),s=b.length(b.subtract(w,s));(w[0]>=n[0]&&w[0]<=q[0]?1:0)+(w[1]>=n[1]&&w[1]<=q[1]?1:0)+(w[2]>=n[2]&&w[2]<=q[2]?1:0)>=d&&e.push({dist:s,obj:t})}}e.length&&e.sort(function(a,c){return a.dist==c.dist?0:a.dist<c.dist?-1:1});return e}};n.prototype={addMesh:function(a,c,d){this.meshBin[a]===s&&(this.meshBin[a]=[],this.meshBinPtr[a]===s&&(this.meshBinPtr[a]=0));
this.meshMap[c]===s&&(this.meshMap[c]=d,this.meshBin[a].push(d))},addImage:function(a,c,d){this.imageBin[a]===s&&(this.imageBin[a]=[],this.imageBinPtr[a]===s&&(this.imageBinPtr[a]=0));this.imageMap[c]===s&&(this.imageMap[c]=d,this.imageBin[a].push(d))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var c=this.meshBinPtr[a];return c<this.meshBin[a].length?
(this.meshBinPtr[a]++,this.meshBin[a][c]):null},loadNextMesh:function(a){a=this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);null!==a&&(a.src=a.deferredSrc)},getNextImage:function(a){var c=this.imageBinPtr[a];return c<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][c]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===
this.imageBin[a].length}};return{Scene:q,SceneObject:w,SkyBox:function(a){var c=a.texture,a=a.mapping,d=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){c.onready=null;var a=1/h.Images[d.texture.tex_id].width;null===d.mapping&&(d.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]]);var a=new h.Material({name:"skybox",textures:{color:c},noFog:!0}),b=new h.Mesh;b.sky_mapping=d.mapping;h.primitives.box({mesh:b,size:1,material:a,
uvmapper:{projectionMode:h.enums.uv.projection.SKY,scale:[1,1,1]}});b.prepare();d.scene_object=new h.SceneObject(b);d.ready=!0};if(c&&("string"===typeof c?c=new h.Texture(c,null,null,null,this.onready):c.loaded||(c.onready=this.onready),this.texture=c,a))this.mapping=a,this.onready()},DeferredBin:n}});
CubicVR.RegisterModule("PostProcess",function(h){function y(a){if(a.shader_vertex===n||a.shader_fragment===n)return null;this.outputMode=a.outputMode===n?b.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===n?null:a.onresize;this.onupdate=a.onupdate===n?null:a.onupdate;this.init=a.init===n?null:a.init;this.enabled=a.enabled===n?!0:a.enabled;this.outputDivisor=a.outputDivisor===n?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function w(a,d,b){var g=s.gl;this.width=a;this.height=d;this.accum=b===n?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,d,!0);this.bufferA=new CubicVR.RenderBuffer(a,d,!1);this.bufferB=new CubicVR.RenderBuffer(a,
d,!1);this.bufferC=new CubicVR.RenderBuffer(a,d,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(a,d,!1),this.accumBuffer.use(),g.clearColor(0,0,0,1),g.clear(g.COLOR_BUFFER_BIT),this.blur_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.bufferB.use();g.clearColor(0,0,0,1);g.clear(g.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,d)}function q(a,d,b){this.createBuffer(a,d,b)}var n=h.undef,s=h.GLCore,b=CubicVR.enums;b.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var f=[],a=[];w.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,d){var b=s.gl,g={},f=a/a,m=d/d;g.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);g.vbo_uvs=new Float32Array([0,0,f,0,f,m,0,m,0,0,f,m]);g.gl_points=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,
g.gl_points);b.bufferData(b.ARRAY_BUFFER,g.vbo_points,b.STATIC_DRAW);g.gl_uvs=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs);b.bufferData(b.ARRAY_BUFFER,g.vbo_uvs,b.STATIC_DRAW);return g},destroyFSQuad:function(a){var d=s.gl;d.deleteBuffer(a.gl_points);d.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,d){var b=s.gl;a.use();b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);b.bindBuffer(b.ARRAY_BUFFER,d.gl_points);b.vertexAttribPointer(a.aVertex,3,b.FLOAT,!1,0,0);b.enableVertexAttribArray(a.aVertex);
b.bindBuffer(b.ARRAY_BUFFER,d.gl_uvs);b.vertexAttribPointer(a.aTex,2,b.FLOAT,!1,0,0);b.enableVertexAttribArray(a.aTex);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);b.drawArrays(b.TRIANGLES,0,6)},addShader:function(c){this.shaders[this.shaders.length]=c;c.shader.use();c.shader.setVector("texel",this.vTexel);if(c.outputDivisor&&1!=c.outputDivisor&&f[c.outputDivisor]===n){var d=this.width/c.outputDivisor|0,b=this.height/c.outputDivisor|0;f[c.outputDivisor]=new CubicVR.RenderBuffer(d,b,!1);a[c.outputDivisor]=
this.makeFSQuad(d,b)}},resize:function(c,b){var e=s.gl;this.width=c;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var g in f){var e=this.width/g|0,o=this.height/g|0;f[g].destroyBuffer();f[g].createBuffer(e,o,!1);this.destroyFSQuad(a[g]);a[g]=this.makeFSQuad(e,o)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;g=0;for(e=this.shaders.length;g<e;g++)if(this.shaders[g].shader.use(),this.shaders[g].shader.setVector("texel",this.vTexel),null!==this.shaders[g].onresize)this.shaders[g].onresize(this.shaders[g].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var b=s.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT))},end:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var c=s.gl;this.captureBuffer.texture.use(c.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(c.TEXTURE0);c.clearColor(0,0,0,1);c.clear(c.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var d=0,e=0,g=this.shaders.length;e<g;e++){var o=this.shaders[e];if(o.enabled){this.swap();this.inputBuffer.texture.use(c.TEXTURE0);var m=o.outputMode;if(m===b.post.output.REPLACE)1!==o.outputDivisor?f[o.outputDivisor].use():this.outputBuffer.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);else if(m===b.post.output.ADD||
m===b.post.output.BLEND)1!==o.outputDivisor?f[o.outputDivisor].use():this.bufferC.use(),c.clearColor(0,0,0,1),c.clear(c.COLOR_BUFFER_BIT);null!==o.onupdate&&(o.shader.use(),o.onupdate(o.shader));1!==o.outputDivisor?(c.viewport(0,0,f[o.outputDivisor].width,f[o.outputDivisor].height),this.renderFSQuad(o.shader,a[o.outputDivisor]),o.outputMode===b.post.output.REPLACE?(this.outputBuffer.use(),f[o.outputDivisor].texture.use(c.TEXTURE0),c.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):c.viewport(0,0,this.width,this.height)):this.renderFSQuad(o.shader,this.fsQuad);m===b.post.output.BLEND?(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.ONE,c.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(c.TEXTURE0),1!==o.outputDivisor?f[o.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND)):m===b.post.output.ADD&&(this.swap(),this.outputBuffer.use(),c.enable(c.BLEND),
c.blendFunc(c.ONE,c.ONE),1!==o.outputDivisor?f[o.outputDivisor].texture.use(c.TEXTURE0):this.bufferC.texture.use(c.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.disable(c.BLEND));this.end();d++}}0===d?this.captureBuffer.texture.use(c.TEXTURE0):this.outputBuffer.texture.use(c.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),c.disable(c.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(c.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),c.disable(c.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};q.prototype={createBuffer:function(a,
b,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),g=s.gl;this.fbo=g.createFramebuffer();e&&(this.depth=g.createRenderbuffer());g.bindFramebuffer(g.FRAMEBUFFER,this.fbo);e&&(g.bindRenderbuffer(g.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_COMPONENT16,a,b),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,this.depth)):
(g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_STENCIL,a,b),g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_STENCIL_ATTACHMENT,g.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;g.bindTexture(g.TEXTURE_2D,h.Textures[this.texture.tex_id]);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE);g.texImage2D(g.TEXTURE_2D,
0,g.RGBA,a,b,0,g.RGBA,g.UNSIGNED_BYTE,null);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,h.Textures[this.texture.tex_id],0);g.bindFramebuffer(g.FRAMEBUFFER,null)},destroyBuffer:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(h.Textures[this.texture.tex_id]);h.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=s.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:q,PostProcessShader:y,PostProcessChain:w,fsQuad:{make:w.prototype.makeFSQuad,destroy:w.prototype.destroyFSQuad,render:w.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function h(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function y(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;
this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}h.prototype={addSubview:function(h){this.childViews.push(h);h.superView=this},makePanel:function(h){return this.superView.makePanel(h)}};y.prototype={resize:function(h,q){this.width=h;this.height=q},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(h){h.setInt("srcTex",0);h.addVector("screen");h.addVector("position");h.addVector("tint");h.addVector("size")}})},addSubview:function(h){this.childViews.push(h);h.superView=this},removeSubview:function(h){h=this.childViews.indexOf(h);-1<h&&this.childViews.splice(h,
1)},makePanel:function(h){var q=CubicVR.GLCore.gl,n={};n.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);n.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);n.gl_points=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,n.gl_points);q.bufferData(q.ARRAY_BUFFER,n.vbo_points,q.STATIC_DRAW);n.gl_uvs=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,n.gl_uvs);q.bufferData(q.ARRAY_BUFFER,n.vbo_uvs,q.STATIC_DRAW);h.panel=n},renderPanel:function(h){if(!h.texture)return!1;h.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(h){if(h.texture){var q=CubicVR.GLCore.gl,n=h.offsetLeft,s=h.offsetTop;n||(n=0);s||(s=0);var b=this.shader.shader;b.use();b.setVector("screen",[this.width,this.height,0]);b.setVector("position",[h.x+n,h.y+s,0]);b.setVector("size",[h.width,h.height,0]);b.setVector("tint",h.tint);h.blend&&(q.enable(q.BLEND),q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA));h.texture.use(q.TEXTURE0);q.drawArrays(q.TRIANGLES,0,6);h.blend&&(q.disable(q.BLEND),q.blendFunc(q.ONE,q.ZERO))}},render:function(){var h=
CubicVR.GLCore.gl;h.disable(h.DEPTH_TEST);this.texture&&this.renderView(this);var q=[];this.offsetTop=this.offsetLeft=0;q.push(this);var n=this.shader.shader;n.use();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_points);h.vertexAttribPointer(n.uniforms.aVertex,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(n.uniforms.aVertex);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_uvs);h.vertexAttribPointer(n.uniforms.aTex,2,h.FLOAT,!1,0,0);h.enableVertexAttribArray(n.uniforms.aTex);
for(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);q.length;){var s=q.pop();this.renderView(s);if(s.childViews.length)for(var b=s.childViews.length-1;0<=b;b--)s.childViews[b].offsetLeft=s.x+s.offsetLeft,s.childViews[b].offsetTop=s.y+s.offsetTop,q.push(s.childViews[b])}h.disableVertexAttribArray(n.uniforms.aTex);h.enable(h.DEPTH_TEST)}};return{Layout:y,View:h}});
CubicVR.RegisterModule("Primitives",function(h){function y(a,c,b,d,f,o){var n=h.mat4,q=h.vec3,s=[],u,x=[0,1,0],w=[1,0,0],z=[0,0,0],y=a.points.length,H,G,J;for(H=u=0;H<g&&u!==b;H+=g/b){w=[Math.cos(H),0,Math.sin(H)];G=0;for(J=c.length;G<J;G++)z=q.add(q.multiply(w,c[G][0]),q.multiply(x,c[G][1])),s[u]===e&&(s[u]=[]),s[u].push(z);u++}J=null;f!==e&&(J=f.getResult!==e?f.getResult():f);for(G=0;G<b;G++){f=0;for(u=c.length;f<u;f++)J?a.addPoint(n.vec3_multiply(s[G][f],J)):a.addPoint(s[G][f])}"string"===typeof d&&
(d=new h.Material(d));a.setFaceMaterial(d);for(f=0;f<b;f++){G=0;for(J=c.length-1;G<J;G++)n=G+c.length*f,s=G+c.length*((f+1)%b),q.equal(a.points[y+n],a.points[y+s])?a.addFace([y+n+1,y+s+1,y+s]):q.equal(a.points[y+n+1],a.points[y+s+1])?a.addFace([y+n,y+n+1,y+s]):a.addFace([y+n,y+n+1,y+s+1,y+s])}o!==e&&(c=null,o.apply!==e?c=o:o&&(c=new h.UVMapper(o)),null!==c&&(a.calcFaceNormals(),c.apply(a,d)))}function w(a,c,b,d,f){var g=h.mat4,c=0.5*c,o=a.points.length;"string"===typeof b&&(b=new h.Material(b));a.setFaceMaterial(b);
d!==e?(d=d.getResult!==e?d.getResult():d,a.addPoint([g.vec3_multiply([c,-c,0],d),g.vec3_multiply([c,c,0],d),g.vec3_multiply([-c,c,0],d),g.vec3_multiply([-c,-c,0],d)])):a.addPoint([[c,-c,0],[c,c,0],[-c,c,0],[-c,-c,0]]);a.addFace([[o+0,o+1,o+2,o+3],[o+3,o+2,o+1,o+0]]);f!==e&&(g=null,f.apply!==e?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function q(a,c,b,d,f){var g=h.mat4,o,n;"object"===typeof c?(o=c[0]/2,n=c[1]/2,c=c[2]/2):o=n=c/=2;var q=a.points.length;"string"===typeof b&&
(b=new h.Material(b));a.setFaceMaterial(b);d!==e?(d=d.getResult!==e?d.getResult():d,a.addPoint([g.vec3_multiply([o,-n,c],d),g.vec3_multiply([o,n,c],d),g.vec3_multiply([-o,n,c],d),g.vec3_multiply([-o,-n,c],d),g.vec3_multiply([o,-n,-c],d),g.vec3_multiply([o,n,-c],d),g.vec3_multiply([-o,n,-c],d),g.vec3_multiply([-o,-n,-c],d)])):a.addPoint([[o,-n,c],[o,n,c],[-o,n,c],[-o,-n,c],[o,-n,-c],[o,n,-c],[-o,n,-c],[-o,-n,-c]]);a.addFace([[q+0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+
6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);f!==e&&(g=null,f.apply!==e?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,b)))}function n(a,c,b,d,e,f,o,n){for(var q=[],b=b-c,c=c+b/2,s=g/e,x=0,w=0;w<=e;w++)q.push([c+Math.cos(x)*b,Math.sin(x)*b,0]),x+=s;h.genLatheObject(a,q,d,f,o,n)}function s(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c/2,-b/2,0],[0,b/2,0]],d,e,g,f)}function b(a,c,b,d,e,g,f){h.genLatheObject(a,[[0,-b/2,0],[c,-b/2,0],[c,b/2,0],[0,b/2,0]],d,e,g,f)}function f(a,c,b,d,e,
g,f){for(var n=[],d=(d/=2)|0,b=b|0,q=Math.PI/d,s=-o,x=0;x<=d;x++)n.push([Math.cos(s)*c,Math.sin(s)*c,0]),s+=q;h.genLatheObject(a,n,b,e,g,f)}function a(a){"string"===typeof a&&(a=h.get(a,h.Material));return a===e?new h.Material:a.use?a:"object"===typeof a?new h.Material(a):new h.Material}function c(a){if(a===e)return e;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?a.getResult():a.position||a.rotation||a.scale?h.mat4.transform(a.position,a.rotation,a.scale):e}function d(a){"string"===
typeof a&&(a=h.get(a));return a===e?e:a.apply?a:"object"===typeof a?new h.UVMapper(a):e}var e=h.undef,g=2*Math.PI,o=Math.PI/2;return{genPlaneObject:w,genBoxObject:q,genLatheObject:y,genTorusObject:n,genConeObject:s,genCylinderObject:b,genSphereObject:f,primitives:{lathe:function(b){var g,f,o,t;if(b.points==e)return null;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);o=c(b.transform);t=d(b.uvmapper||b.uv);y(g,b.points,b.divisions!==e?b.divisions:24,f,o,t);return g},box:function(b){var g,
f,o,t;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);o=c(b.transform);t=d(b.uvmapper||b.uv);q(g,b.size!==e?b.size:1,f,o,t);return g},plane:function(b){var g,f,o,t;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);o=c(b.transform);t=d(b.uvmapper||b.uv);w(g,b.size!==e?b.size:1,f,o,t);return g},sphere:function(b){var g,o,n,t;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);o=a(b.material);n=c(b.transform);t=d(b.uvmapper||b.uv);f(g,b.radius!==e?b.radius:1,b.lon!==
e?b.lon:24,b.lat!==e?b.lat:24,o,n,t);return g},torus:function(b){var g,f,o,t;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);o=c(b.transform);t=d(b.uvmapper||b.uv);n(g,b.innerRadius!==e?b.innerRadius:0.75,b.outerRadius!==e?b.outerRadius:1,b.lon!==e?b.lon:24,b.lat!==e?b.lat:24,f,o,t);return g},cone:function(b){var g,f,o,t;g=b.mesh!==e?b.mesh:new h.Mesh(b.name!==e?b.name:e);f=a(b.material);o=c(b.transform);t=d(b.uvmapper||b.uv);s(g,b.base!==e?b.base:1,b.height!==e?b.height:1,b.lon!==
e?b.lon:24,f,o,t);return g},cylinder:function(g){var f,o,n,t;f=g.mesh!==e?g.mesh:new h.Mesh(g.name!==e?g.name:e);o=a(g.material);n=c(g.transform);t=d(g.uvmapper||g.uv);b(f,g.radius!==e?g.radius:1,g.height!==e?g.height:1,g.lon!==e?g.lon:24,o,n,t);return f}}}});
CubicVR.RegisterModule("COLLADA",function(h){function y(f,a){function c(a){return!a.color?!1:(a=a.color)?e.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function d(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var e=h.util,g,o,m,r,n,v;v="object"==typeof f?f:-1!=f.indexOf(".js")?e.getJSON(f):h.util.xml2badgerfish(e.getXML(f));var t,A,D,C,y,u,x,E,z,F,H,G,J,L,M,K,N,S,ca,V,na,Q=v;v=null;if(!Q.COLLADA)throw Error(f+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,O={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var Ma=Q.asset.up_axis.$;"X_UP"===Ma?O.up_axis=0:"Y_UP"===Ma?O.up_axis=1:"Z_UP"===Ma&&(O.up_axis=2)}var gb=O.up_axis;if(Q.library_images&&(Q.library_images.image&&!Q.library_images.image.length&&(Q.library_images.image=[Q.library_images.image]),Q.library_images.image.length))for(var hb=Q.library_images.image,Na=0,qb=hb.length;Na<qb;Na++){var Oa=hb[Na],ib=Oa["@id"],Ic=
Oa["@name"],$b=Oa.init_from;if($b.$){var ra=$b.$;a!==w&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));a!==w&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));O.images[ib]={source:ra,id:ib,name:Ic}}}var jb,rb,ac,W,Pa,ka,Qa,da,P,X,T,Da,ha,Ra,Sa,Z,aa;if(Q.library_effects){var Ta=Q.library_effects.effect;Ta&&!Ta.length&&(Ta=[Ta]);rb=0;for(ac=Ta.length;rb<ac;rb++){var Db=Ta[rb];jb=Db["@id"];var U={};U.id=jb;U.surfaces=[];U.samplers=[];(da=Db.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da){S=0;for(ca=da.length;S<ca;S++){var sa=da[S],Ua=sa["@sid"];if(sa.surface){U.surfaces[Ua]={};var bc=sa.surface.init_from.$;"object"===typeof O.images[bc]&&(U.surfaces[Ua].source=a+"/"+O.images[bc].source)}else if(sa.sampler2D&&(U.samplers[Ua]={},U.samplers[Ua].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(U.samplers[Ua].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))U.samplers[Ua].magfiter=sa.sampler2D.magfilter.$}}var va=Db.profile_COMMON.technique;
va&&!va.length&&(va=[va]);U.material={textures_ref:[]};W=0;for(Pa=va.length;W<Pa;W++){g=va[W].blinn;g||(g=va[W].phong);g||(g=va[W].lambert);if(g)for(var ea in g){var sb=g[ea],ta=c(sb),cc=d(sb),dc=!sb.texture?!1:sb.texture["@texture"];!1!==ta&&3<ta.length&&ta.pop();"emission"==ea?!1!==ta&&(U.material.ambient=ta):"ambient"!=ea&&("diffuse"==ea?!1!==ta&&(U.material.color=ta):"specular"==ea?!1!==ta&&(U.material.specular=ta):"shininess"==ea&&!1!==cc&&(U.material.shininess=cc));if(!1!==dc){var Va=U.surfaces[U.samplers[dc].source].source;
"emission"==ea?U.material.textures_ref.push({image:Va,type:q.texture.map.AMBIENT}):"ambient"==ea?U.material.textures_ref.push({image:Va,type:q.texture.map.AMBIENT}):"diffuse"==ea?U.material.textures_ref.push({image:Va,type:q.texture.map.COLOR}):"specular"==ea?U.material.textures_ref.push({image:Va,type:q.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?U.material.textures_ref.push({image:Va,type:q.texture.map.REFLECT}):"reflectivity"!=ea&&"transparent"==ea&&U.material.textures_ref.push({image:Va,
type:q.texture.map.ALPHA}))}}O.effects[jb]=U}}}var Eb=b.getAllOf(Q,"instance_geometry"),tb=[];if(Eb.length){u=0;for(E=Eb.length;u<E;u++){var ec=Eb[u],Fb=b.getAllOf(ec,"instance_material");if(Fb.length){V=0;for(na=Fb.length;V<na;V++){var fc=Fb[V],Jc=fc["@symbol"],Kc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Jc]=Kc}}}}var Gb=Q.library_materials;if(Gb&&Gb.material){var Wa=Gb.material;Wa&&!Wa.length&&(Wa=[Wa]);F=0;for(H=Wa.length;F<H;F++){var Hb=Wa[F],Lc=Hb["@id"],Mc=Hb["@name"],gc=Hb.instance_effect;
gc&&(jb=gc["@url"].substr(1),O.materials.push({id:Lc,name:Mc,mat:O.effects[jb].material}))}}var hc=Q.library_geometries,Xa;if(hc){var ua=hc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Nc=ua.length;kb<Nc;kb++){var ma={id:w,points:[],parts:[]},Ya=ua[kb].mesh;if(Ya){Xa=ua[kb]["@id"];n=ua[kb]["@name"];var Za=Ya.source;Za&&!Za.length&&(Za=[Za]);for(var R=[],Ib=0,Oc=Za.length;Ib<Oc;Ib++){var ub=Za[Ib];o=ub["@id"];var Pc=ub["@name"],Jb=ub.float_array;Jb&&(R[o]={id:o,name:Pc,data:e.floatDelimArray(Jb.$?
Jb.$:""," ")});var Kb=ub.technique_common.accessor;Kb&&(R[o].count=Kb["@count"]|0,R[o].stride=Kb["@stride"]|0,R[o].count&&(R[o].data=e.repackArray(R[o].data,R[o].stride,R[o].count)))}var Lb=Ya.vertices,lb=null,Mb=null,Ea=null,Fa=null,Ga=null;if(Lb&&(Mb=Lb["@id"],(P=Lb.input)&&!P.length&&(P=[P]),P)){ka=0;for(Qa=P.length;ka<Qa;ka++)X=P[ka],"POSITION"===X["@semantic"]&&(lb=X["@source"].substr(1))}var oa=Ya.triangles;oa&&!oa.length&&(oa=[oa]);if(oa){W=0;for(Pa=oa.length;W<Pa;W++){aa={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Qc=parseInt(oa[W]["@count"],10);(P=oa[W].input)&&!P.length&&(P=[P]);T=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++)X=P[ka],Z=parseInt(X["@offset"],10),r=X["@source"].substr(1),"VERTEX"===X["@semantic"]?(r===Mb&&(r=lb),T[Z]=0):"NORMAL"===X["@semantic"]?(Ea=r,R[Ea].count&&(T[Z]=1)):"TEXCOORD"===X["@semantic"]?(Ga=r,R[Ga].count&&(T[Z]=2)):"COLOR"===X["@semantic"]?(Fa=r,R[Fa].count&&(T[Z]=3)):T[Z]=4}C=T.length;m=Xa+":"+oa[W]["@material"];null===m?aa.material=
0:tb[m]===w?(s("missing material ["+m+"]@"+Xa+"?"),aa.material=0):aa.material=tb[m];var ic=oa[W].p,wa=[];ic&&(wa=e.intDelimArray(ic.$," "));if(wa.length&&(y=wa.length/T.length/3,y===Qc)){0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;E=wa.length;for(z=T.length;u<E;u+=3*z){t=[];A=[];D=[];ia=[];for(V=0;V<3*z;V++){var vb=V%z;0===T[vb]?A.push(wa[u+V]):1===T[vb]?t.push(wa[u+V]):2===T[vb]?D.push(wa[u+V]):3===T[vb]&&ia.push(wa[u+V])}A.length&&(aa.faces.push(A),3===t.length&&aa.normals.push([b.fixuaxis(O.up_axis,
R[Ea].data[t[0]]),b.fixuaxis(O.up_axis,R[Ea].data[t[1]]),b.fixuaxis(O.up_axis,R[Ea].data[t[2]])]),3===D.length&&aa.texcoords.push([R[Ga].data[D[0]],R[Ga].data[D[1]],R[Ga].data[D[2]]]),3===ia.length&&aa.colors.push([R[Fa].data[ia[0]],R[Fa].data[ia[1]],R[Fa].data[ia[2]]]))}}ma.parts.push(aa)}}var ja=Ya.polylist;ja||(ja=Ya.polygons);ja&&!ja.length&&(ja=[ja]);if(ja){W=0;for(Pa=ja.length;W<Pa;W++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ja[W]["@count"],10);(P=ja[W].input)&&
!P.length&&(P=[P]);T=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++){X=P[ka];var Nb=X["@offset"];null===Nb&&(Nb=X["@idx"]);Z=parseInt(Nb,10);r=X["@source"].substr(1);"VERTEX"===X["@semantic"]?(r===Mb&&(r=lb),T[Z]=0):"NORMAL"===X["@semantic"]?(Ea=r,T[Z]=1):"TEXCOORD"===X["@semantic"]?(Ga=r,T[Z]=2):"COLOR"===X["@semantic"]?(Fa=r,T[Z]=3):T[Z]=4}}var kc=ja[W].vcount,$a=[];kc&&($a=e.intDelimArray(kc.$," "));m=Xa+":"+ja[W]["@material"];aa.material=m===w?0:tb[m];var mb=ja[W].p;C=T.length;var xa=[];if(1<
mb.length&&!$a.length){S=0;for(ca=mb.length;S<ca;S++){var lc=e.intDelimArray(mb[S].$," ");$a[S]=parseInt(lc.length/C,10);xa=xa.concat(lc)}}else mb&&(xa=e.intDelimArray(mb.$," "));if(xa.length)if(y=$a.length,y!==jc)s("poly vcount data doesn't add up, skipping object load: "+y+" !== "+jc);else{0===ma.points.length&&(ma.points=R[lb].data);u=Z=0;for(E=$a.length;u<E;u++){t=[];A=[];D=[];ia=[];V=0;for(na=$a[u]*C;V<na;V++)0===T[V%C]?A.push(xa[Z]):1===T[V%C]?t.push(xa[Z]):2===T[V%C]?D.push(xa[Z]):3===T[V%
C]&&ia.push(xa[Z]),Z++;var ab;if(A.length){aa.faces.push(A);if(t.length){$=[];G=0;for(J=t.length;G<J;G++)$.push(b.fixuaxis(O.up_axis,R[Ea].data[t[G]]));aa.normals.push($)}if(D.length){ab=[];G=0;for(J=D.length;G<J;G++)ab.push(R[Ga].data[D[G]]);aa.texcoords.push(ab)}if(ia.length){ab=[];G=0;for(J=ia.length;G<J;G++)ab.push(R[Fa].data[ia[G]]);aa.colors.push(ab)}}}}ma.parts.push(aa)}}if(1!==gb){u=0;for(E=ma.points.length;u<E;u++)ma.points[u]=b.fixuaxis(O.up_axis,ma.points[u])}ma.id=Xa;O.meshes.push(ma)}}}var mc=
Q.library_cameras;if(mc){(Ra=mc.camera)&&!Ra.length&&(Ra=[Ra]);L=0;for(M=Ra.length;L<M;L++){ha=Ra[L];var Rc=ha["@id"],wb=0,xb=0,yb=0;ha.optics&&(ha.optics.technique_common&&ha.optics.technique_common.perspective)&&(wb=ha.optics.technique_common.perspective.yfov,xb=ha.optics.technique_common.perspective.znear,yb=ha.optics.technique_common.perspective.zfar);var Ob,Pb,Qb;if(!wb&&!xb&&!yb){(da=ha.param)&&!da.length&&(da=[da]);u=0;for(E=da.length;u<E;u++){var Rb=da[u].$,Sb=da[u]["@name"];"YFOV"==Sb?Ob=
parseFloat(Rb):"ZNEAR"==Sb?Pb=parseFloat(Rb):"ZFAR"==Sb&&(Qb=parseFloat(Rb))}}else Ob=wb?parseFloat(wb.$):60,Pb=xb?parseFloat(xb.$):0.1,Qb=yb?parseFloat(yb.$):1E3;O.cameras.push({id:Rc,targeted:!1,fov:parseFloat(Ob),nearclip:parseFloat(Pb),farclip:parseFloat(Qb)})}}var nc=Q.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Tb=0,Sc=Ia.length;Tb<Sc;Tb++){Ha=Ia[Tb];var pc,nb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=
zb;nb=Ha.technique_common[zb];break}if(nb){var Tc=oc[pc]||"point",qc=Ha["@id"],rc=nb.intensity,Uc=rc?parseFloat(rc.$):1,sc=nb.distance,Vc=sc?parseFloat(sc.$):10,tc=nb.color,ia=[1,1,1];tc&&(ia=e.floatDelimArray(tc.$," "));O.lights.push({id:qc,name:qc,type:Tc,method:q.light.method.STATIC,diffuse:ia,specular:[0,0,0],distance:Vc,intensity:Uc})}}}var uc=Q.library_visual_scenes;if(uc){var bb=null;(bb=uc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Ub=0,Wc=bb.length;Ub<Wc;Ub++){Sa=bb[Ub];var ya={id:Sa["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]},pa=[],cb=[],za,Vb,la,ba,$,vc=Q.library_nodes;if(vc){var db=vc.node;db&&!db.length&&(db=[db]);pa=[];u=0;for(E=db.length;u<E;u++)Vb=db[u],mnodeId=Vb["@id"],pa[la]=Vb;for(za=[Sa];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(E=$.length;u<E;u++)za.push($[u])}if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);u=0;for(E=eb.length;u<E;u++){var Wb=eb[u]["@url"].substr(1);pa[Wb]&&(ba.node&&ba.node.length&&
(ba.node=[ba.node]),ba.node?ba.node.push(pa[Wb]):ba.node=[pa[Wb]])}}}}for(za=[Sa];za.length;)if(ba=za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){u=0;for(E=$.length;u<E;u++)$[u].parentNode=ba,cb.push($[u]),za.push($[u])}if(cb.length)for(var ob=0,Xc=cb.length;ob<Xc;ob++){var Aa=cb[ob],Ba=Aa.instance_geometry;Ha=cb[ob].instance_light;ha=cb[ob].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ga=b.cl_getInitalTransform(O.up_axis,Aa);2===gb&&(ga.rotation=b.quaternionFilterZYYZ(ga.rotation,ha?[-90,
0,0]:w));var pb=null,Y=null,fb;if(Ba){Ba&&!Ba.length&&(Ba=[Ba]);u=0;for(E=Ba.length;u<E;u++)if(n=Ba[u]["@url"].substr(1),Y={},Y.name=(fa?fa:la)+(u?u:""),Y.id=(la?la:fa)+(u?u:""),Y.meshId=Xa,Y.meshName=n,pb||(Y.position=ga.position,Y.rotation=ga.rotation,Y.scale=ga.scale,Y.matrix=ga.matrix),ya.sceneObjects.push(Y),pa[Y.id]=!0,Aa.parentNode)(fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:Y.id}):1<Ba.length&&(pb?pa[pb.id]&&ya.parentMap.push({parent:pb.id,child:Y.id}):(pb=Y,Y={}))}else if(ha){var Yc=
ha["@url"].substr(1);ya.cameras.push({name:fa?fa:la,id:fa?fa:la,source:Yc,position:ga.position,rotation:ga.rotation})}else if(Ha){var Zc=Ha["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Zc,position:ga.position,rotation:ga.rotation||[0,0,0]})}else Y={position:ga.position,rotation:ga.rotation,scale:ga.scale,matrix:ga.matrix},Y.name=fa?fa:la,Y.id=la?la:fa,ya.sceneObjects.push(Y),pa[Y.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:Y.id})}O.scenes.push(ya)}}var wc=
Q.library_animations,qa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Xb=0,$c=Ja.length;Xb<$c;Xb++){var Ab=Ja[Xb];qa=Ab["@id"];O.animations[qa]={};O.animations[qa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){K=0;for(N=Ka.length;K<N;K++){var Ca=Ka[K];o=Ca["@id"];var xc=Ca.technique_common,Bb=null,yc=null;Ca.name_array?Bb=e.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Bb=e.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(yc=e.floatDelimArray(Ca.float_array.$,
" "));var Yb=0,zc="",Cb=1;if(xc){g=xc;var Zb=g.accessor,Yb=parseInt(Zb["@count"],10),zc=Zb["@source"].substr(1),Ac=Zb["@stride"];Ac&&(Cb=parseInt(Ac,10))}O.animations[qa].sources[o]={data:Bb?Bb:yc,count:Yb,source:zc,stride:Cb};1!==Cb&&(O.animations[qa].sources[o].data=e.repackArray(O.animations[qa].sources[o].data,Cb,Yb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){O.animations[qa].samplers=[];K=0;for(N=Da.length;K<N;K++){var Bc=Da[K],ad=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=
[];x=0;for(E=P.length;x<E;x++)X=P[x],Cc[X["@semantic"]]=X["@source"].substr(1);O.animations[qa].samplers[ad]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){O.animations[qa].channels=[];L=0;for(M=La.length;L<M;L++){var Dc=La[L],bd=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),cd=Fc[0],Gc=Fc[1].split(".");O.animations[qa].channels.push({source:bd,target:Ec,targetName:cd,paramName:Gc[0],typeName:Gc[1]})}}}}var Hc=Q.scene;if(Hc&&(Sa=Hc.instance_visual_scene)){var dd=Sa["@url"].substr(1);
O.scene=dd}return O}var w=h.undef,q=h.enums,n=h.GLCore,s=h.log,b={fixuaxis:function(b,a){if(0===b)return[a[1],a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],-a[1]]},fixscaleaxis:function(b,a){if(0===b)return[a[1],a[0],a[2]];if(1===b)return a;if(2===b)return[a[0],a[2],a[1]]},fixukaxis:function(b,a,c,d){return a===q.motion.POS&&c===q.motion.Z&&b===q.motion.Z?-d:d},getAllOf:function(b,a){for(var c=[b],d=[],e,g,o,m;c.length;)for(g in e=c.pop(),e)if(e.hasOwnProperty(g)){if(g===a)if(e[g].length){o=
0;for(m=e[g].length;o<m;o++)d.push(e[g][o])}else d.push(e[g]);if("object"==typeof e[g])if(e[g].length){o=0;for(m=e[g].length;o<m;o++)c.push(e[g][o])}else c.push(e[g])}return d},quaternionFilterZYYZ:function(b,a){var c=h.vec3,d=b,e=new h.Quaternion;a!==w&&(d=c.add(b,a));e.fromEuler(d[0],d[2],-d[1]);return e.toEuler()},cl_getInitalTransform:function(f,a){var c=h.util,d={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=a.translate,g=a.rotate,o=a.scale;if(a.matrix&&!e&&!g&&!o)return d;e&&e.$&&(d.position=
b.fixuaxis(f,c.floatDelimArray(e.$," ")));if(g)for(var e=0,m=g.length;e<m;e++){var r=g[e],n=r["@sid"],r=c.floatDelimArray(r.$," ");if("rotateX"==n||"rotationX"==n)d.rotation[0]=r[3];else if("rotateY"==n||"rotationY"==n)d.rotation[1]=r[3];else if("rotateZ"==n||"rotationZ"==n)d.rotation[2]=r[3]}o&&(d.scale=b.fixscaleaxis(f,c.floatDelimArray(o.$," ")));return d}};return{loadCollada:function(f,a,c){var a=y(f,a,c),d=a.up_axis,e=[],g,o,m,r,s,v,t,A;o=0;for(m=a.materials.length;o<m;o++){s=a.materials[o];
t=new h.Material(s.mat);t.name=s.name||null;v=0;for(r=s.mat.textures_ref.length;v<r;v++){A=s.mat.textures_ref[v];var D=null,D=void 0===h.Textures_ref[A.image]?new h.Texture(A.image,n.default_filter,c,f):h.Textures_obj[h.Textures_ref[A.image]];t.setTexture(D,A.type)}e[s.id]=t}v=[];o=0;for(m=a.meshes.length;o<m;o++){var D=a.meshes[o],C=new h.Mesh({name:D.id});C.points=D.points;var I=!1;t=0;for(A=D.parts.length;t<A;t++){var u=D.parts[t];0!==u.material&&((r=e[u.material])||(r=new h.Material({name:u.material})),
C.setFaceMaterial(r));var x=u.normals.length?!0:!1,E=u.texcoords.length?!0:!1,z=u.colors.length?!0:!1;z&&(e[u.material].color_map=!0);r=0;for(s=u.faces.length;r<s;r++){var F=C.addFace(u.faces[r]);x&&(C.faces[F].point_normals=u.normals[r]);E&&(C.faces[F].uvs=u.texcoords[r]);z&&(C.faces[F].point_colors=u.colors[r])}I|=x}C.faces.length&&(c?c.addMesh(f,f+":"+meshId,C):(I||C.calcNormals(),C.triangulateQuads(),C.compile()),v[D.id]=C)}m=[];f=0;for(r=a.cameras.length;f<r;f++)m[a.cameras[f].id]=a.cameras[f];
D=[];r=0;for(s=a.lights.length;r<s;r++)D[a.lights[r].id]=a.lights[r];c={};e={};o={};f={};t=0;for(A=a.scenes.length;t<A;t++){C=a.scenes[t];I=new h.Scene;r=0;for(s=C.sceneObjects.length;r<s;r++)u=C.sceneObjects[r],x=new h.SceneObject(u),x.obj=(v[u.meshName]?v[u.meshName]:v[u.meshId])||null,u.matrix&&x.setMatrix(u.matrix),c[u.id]=x,I.bindSceneObject(x);r=0;for(s=C.lights.length;r<s;r++)u=C.lights[r],x=new h.Light(D[u.source]),x.position=u.position,x.rotation=u.rotation,e[u.id]=x,I.bindLight(x);C.cameras.length&&
(r=C.cameras[0],s=new h.Camera(m[r.source]),s.position=r.position,s.rotation=r.rotation,o[r.id]=s,I.camera=s);r=0;for(s=C.parentMap.length;r<s;r++)u=C.parentMap[r],c[u.parent].bindChild(c[u.child]);f[C.id]=I}for(var H in a.animations)if(a.animations.hasOwnProperty(H)&&(v=a.animations[H],v.channels.length)){cCount=0;for(r=v.channels.length;cCount<r;cCount++){m=v.channels[cCount];u=v.samplers[m.source];s=v.sources[u.INPUT];t=v.sources[u.OUTPUT];A=v.sources[u.INTERPOLATION];var D=v.sources[u.IN_TANGENT],
C=v.sources[u.OUT_TANGENT],I=u.IN_TANGENT!==w,u=u.OUT_TANGENT!==w,x=null,z=c[m.targetName],E=o[m.targetName],G=e[m.targetName];z?(null===z.motion&&(z.motion=new h.Motion),x=z.motion):E?(null===E.motion&&(E.motion=new h.Motion),x=E.motion):G&&(null===G.motion&&(G.motion=new h.Motion),x=G.motion);if(null!==x){z=q.motion.POS;F=q.motion.X;2===d&&(x.yzflip=!0);g=m.paramName;if("rotateX"===g||"rotationX"===g)z=q.motion.ROT,F=q.motion.X;else if("rotateY"===g||"rotationY"===g)z=q.motion.ROT,F=q.motion.Y;
else if("rotateZ"===g||"rotationZ"===g)z=q.motion.ROT,F=q.motion.Z;else if("location"===g){if(z=q.motion.POS,"X"===m.typeName&&(F=q.motion.X),"Y"===m.typeName&&(F=q.motion.Y),"Z"===m.typeName)F=q.motion.Z}else if("translate"===g){if(z=q.motion.POS,"X"===m.typeName&&(F=q.motion.X),"Y"===m.typeName&&(F=q.motion.Y),"Z"===m.typeName)F=q.motion.Z}else if("LENS"===g)continue;else"FOV"===g?(z=q.motion.FOV,F=3):"ZNEAR"===g?(z=q.motion.NEARCLIP,F=3):"ZFAR"===g?(z=q.motion.FARCLIP,F=3):"intensity"===g&&(z=
q.motion.INTENSITY,F=3);G&&3>z&&(G.method=q.light.method.DYNAMIC);mCount=0;for(m=s.data.length;mCount<m;mCount++)if(k=null,"object"===typeof t.data[mCount]){i=0;for(iMax=t.data[mCount].length;i<iMax;i++)G=i,2===d&&2===i?G=1:2===d&&1===i&&(G=2),k=x.setKey(z,G,s.data[mCount],b.fixukaxis(a.up_axis,z,G,t.data[mCount][i])),A&&(g=A.data[mCount][i],"LINEAR"===g?k.shape=q.envelope.shape.LINE:"BEZIER"===g&&(k.shape=!I&&!u?q.envelope.shape.LINEAR:q.envelope.shape.BEZI))}else if(G=F,ofs=0,E&&z===q.motion.ROT&&
2===d&&0===G&&(ofs=-90),z===q.motion.ROT?k=x.setKey(z,G,s.data[mCount],t.data[mCount]+ofs):(2===d&&2===F?G=1:2===d&&1===F&&(G=2),k=x.setKey(z,G,s.data[mCount],b.fixukaxis(a.up_axis,z,G,t.data[mCount]))),A)if(g=A.data[mCount],"LINEAR"===g)k.shape=q.envelope.shape.LINE;else if("BEZIER"===g)if(!I&&!u)k.shape=q.envelope.shape.LINEAR,k.continutity=1;else{k.shape=q.envelope.shape.BEZ2;g=D.data[mCount][0];var J,L=C.data[mCount][0];z===q.motion.ROT?(J=D.data[mCount][1],G=C.data[mCount][1],k.param[0]=g-k.time,
k.param[1]=J-k.value+ofs,k.param[2]=L-k.time,k.param[3]=G-k.value+ofs):(J=b.fixukaxis(a.up_axis,z,G,D.data[mCount][1]),G=b.fixukaxis(a.up_axis,z,G,C.data[mCount][1]),k.param[0]=g-k.time,k.param[1]=J-k.value,k.param[2]=L-k.time,k.param[3]=G-k.value)}}}}H=null;return H=a.scene?f[a.scene]:f.pop()},parseCollada:y}});
CubicVR.RegisterModule("GML",function(h){function y(h){var n=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(h!==w){var h=n.getXML(h),s=h.getElementsByTagName("header");if(!s.length)return null;var b=s[0],s=h.getElementsByTagName("environment");if(!s.length)return null;this.name=null;b=b.getElementsByTagName("name");b.length&&(this.name=n.collectTextNode(b[0]));b=s[0].getElementsByTagName("screenBounds");b.length&&
(this.bounds=[parseFloat(n.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(b[0].getElementsByTagName("z")[0]))]);b=s[0].getElementsByTagName("origin");b.length&&(this.origin=[parseFloat(n.collectTextNode(b[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(b[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(b[0].getElementsByTagName("z")[0]))]);s=s[0].getElementsByTagName("up");
s.length&&(this.upvector=[parseFloat(n.collectTextNode(s[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(s[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(s[0].getElementsByTagName("z")[0]))]);h=h.getElementsByTagName("drawing");s=0;for(b=h.length;s<b;s++)for(var f=h[s].getElementsByTagName("stroke"),a=0,c=0,d=0,e=0,g=0,o=f.length;g<o;g++){for(var m=f[g].getElementsByTagName("pt"),r=m.length,B=Array(r),v,t,A,D=0,C=r;D<C;D++)A=m[D],r=parseFloat(n.collectTextNode(A.getElementsByTagName("x")[0])),
v=parseFloat(n.collectTextNode(A.getElementsByTagName("y")[0])),t=parseFloat(n.collectTextNode(A.getElementsByTagName("z")[0])),A=parseFloat(n.collectTextNode(A.getElementsByTagName("time")[0])),1===this.upvector[0]?B[D]=[v!==v?0:v,r!==r?0:-r,t!==t?0:t,A]:1===this.upvector[1]?B[D]=[r!==r?0:r,v!==v?0:v,t!==t?0:t,A]:1===this.upvector[2]&&(B[D]=[r!==r?0:r,t!==t?0:-t,v!==v?0:v,A]),a<r&&(a=r),c<v&&(c=v),d<t&&(d=t),e<A&&(e=A);if(d>e){m=0;for(D=B.length;m<D;m++)r=B[m][3],B[m][3]=B[m][2],B[m][2]=r/this.bounds[2]}this.strokes[g]=
B}}}var w=h.undef;y.prototype={addStroke:function(h,n){var s=[];n===w&&(n=0.1);for(var b=0,f=h.length;b<f;b++){var a=[h[b][0],h[b][1],h[b][2]];this.manual_pos+=n;a.push(this.manual_pos);s.push(a)}this.strokes.push(s)},recenter:function(){var h=CubicVR.vec3,n=[0,0,0],s=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],b,f,a,c;a=0;for(c=this.strokes.length;a<c;a++){b=0;for(f=this.strokes[a].length;b<f;b++)n[0]>this.strokes[a][b][0]&&(n[0]=this.strokes[a][b][0]),n[1]>this.strokes[a][b][1]&&
(n[1]=this.strokes[a][b][1]),n[2]>this.strokes[a][b][2]&&(n[2]=this.strokes[a][b][2]),s[0]<this.strokes[a][b][0]&&(s[0]=this.strokes[a][b][0]),s[1]<this.strokes[a][b][1]&&(s[1]=this.strokes[a][b][1]),s[2]<this.strokes[a][b][2]&&(s[2]=this.strokes[a][b][2])}h=h.multiply(h.subtract(s,n),0.5);a=0;for(c=this.strokes.length;a<c;a++){b=0;for(f=this.strokes[a].length;b<f;b++)this.strokes[a][b][0]-=h[0],this.strokes[a][b][1]-=this.upvector[1]?h[1]:-h[1],this.strokes[a][b][2]-=h[2]}},generateObject:function(h,
n,s,b,f){var a=CubicVR.vec3;h===w&&(h=0);n===w&&(n=0);f===w&&(f=!1);b===w&&(b=0.02);s===w&&(s=0.015);for(var c=0!==n,d=0,e=0,g=new CubicVR.Mesh(this.name),o,m,r,B,v,t,A=0,D=this.strokes.length;A<D;A++){t=new CubicVR.Envelope;var C=new CubicVR.Envelope,y=new CubicVR.Envelope,u=this.strokes[A].length,x=[],E=[],z=0,F=this.strokes[A];for(v=0;v<u;v++){var H=F[v],G=t.addKey(H[3],H[0]),J=C.addKey(H[3],H[1]),L;L=f?y.addKey(H[3],H[2]):y.addKey(H[3],0);G.tension=0.5;J.tension=0.5;L.tension=0.5;0!==v?(o=H[0]-
o,m=H[1]-m,r=H[2]-r,B=H[3]-B,r=Math.sqrt(o*o+m*m+r*r),x[v-1]=r,E[v-1]=B):z=H[3];o=H[0];m=H[1];r=H[2];B=H[3]}u=g.points.length;for(v=0;v<x.length;v++){F=E[v];J=Math.ceil(3*(x[v]/b));H=z;G=z+F;for(J=F/J;H<G-J;H+=J){H===z&&(o=t.evaluate(H),m=C.evaluate(H),r=y.evaluate(H));var M,K;L=t.evaluate(H+J);M=C.evaluate(H+J);K=y.evaluate(H+J);var N=L-o,S=M-m,ca=K-r;Math.sqrt(N*N+S*S+ca*ca);N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([N,S,ca]))),s/2);g.addPoint([o-N[0],-(m-N[1]),r-N[2]+(c?n/2:
0)]);g.addPoint([o+N[0],-(m+N[1]),r+N[2]+(c?n/2:0)]);o=L;m=M;r=K}z+=F}C=g.points.length;if(c){v=u;for(t=C;v<t;v++)g.addPoint([g.points[v][0],g.points[v][1],g.points[v][2]-(c?n/2:0)])}v=0;for(t=C-u;v<=t-4;v+=2){0===d%h&&e++;g.setSegment(e);y=[u+v,u+v+1,u+v+3,u+v+2];g.addFace(y);if(c&&(y=[y[3]+C-u,y[2]+C-u,y[1]+C-u,y[0]+C-u],g.addFace(y),y=[u+v,u+v+2,u+v+2+C-u,u+v+C-u],g.addFace(y),y=[u+v+1+C-u,u+v+3+C-u,u+v+3,u+v+1],g.addFace(y),0===v&&(y=[u+v+C-u,u+v+1+C-u,u+v+1,u+v],g.addFace(y)),v===t-4))y=[u+v+
2,u+v+3,u+v+3+C-u,u+v+2+C-u],g.addFace(y);d++}}g.calcFaceNormals();g.triangulateQuads();g.calcNormals();g.compile();return g}};return{GML:y}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(h){if(!h.src)throw"PDF Error: you must specify a src url for a PDF.";var y=h.src,w=h.callback||function(){},q,n=[],s=[];this.__defineGetter__("pages",function(){return q?q.numPages:0});this.getPage=function(b){var f=q.numPages,b=1>b?1:b;return n[(b>f?f:b)-1]};this.getPageTexture=function(b,f,a){b=this.getPage(b);f=f||b.width;a=a||b.height;return new CubicVR.PdfTexture(b,{width:f,height:a})};getPdf({url:y,error:function(){console.log("PDF Error: error loading pdf `"+
y+"`")}},function(b){q=new PDFDoc(b);for(var b=1,f=q.numPages;b<=f;b++){var a=q.getPage(b);n.push(a);s.push(a)}w()})}}});
CubicVR.RegisterModule("Particles",function(h){function y(n,h,b,f,a,c,d){n&&(this.last_particle=this.particles=null,this.pTex=b!==w?b:null,this.vWidth=f,this.vHeight=a,this.alpha=c!==w?c:!1,this.alphaCut=d!==w?d:0,this.pfunc=function(a,c){var b=c-a.start_time;if(0>b)return 0;if(b>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+b*a.velocity[0]+b*b*a.accel[0];a.pos[1]=a.startpos[1]+b*a.velocity[1]+b*b*a.accel[1];a.pos[2]=a.startpos[2]+b*a.velocity[2]+b*b*a.accel[2];null!==this.pgov&&this.pgov(a,
c);return 1},this.pgov=null,this.hasColor=h===w?!1:h,b=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",b?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",b?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",b?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",b?"uniform sampler2D pMap;":"","varying vec4 color;",b?"varying vec2 screenPos;":"",b?"uniform vec3 screenDim;":"",b?"varying float pSize;":"","void main(void) {\nvec4 c = color;",b?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",b?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",b?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=n,this.numParticles=0,this.arPoints=new Float32Array(3*n),this.glPoints=null,h&&(this.arColor=new Float32Array(3*n),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition"),
this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[f,a,0])),this.genBuffer())}var w=h.undef,q=h.GLCore;y.prototype={resizeView:function(n,h){this.vWidth=n;this.vHeight=h;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,h,0]))},addParticle:function(n){null===this.last_particle?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var n=q.gl;this.glPoints=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW);this.hasColor&&(this.glColor=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},updatePoints:function(){var n=q.gl;n.bindBuffer(n.ARRAY_BUFFER,
this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW)},updateColors:function(){var n=q.gl;this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},draw:function(n,h,b){var f=q.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(f.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",n);this.shader_particle.setMatrix("uPMatrix",h);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);f.bindBuffer(f.ARRAY_BUFFER,this.glPoints);
f.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,f.FLOAT,!1,0,0);f.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(f.bindBuffer(f.ARRAY_BUFFER,this.glColor),f.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(b!==w){this.numParticles=0;if(null===this.particles){f.disable(f.BLEND);return}for(var n=this.particles,h=null,a=0;null!==n;){var c=3*this.numParticles,
d=this.pfunc(n,b);if(1===d){if(this.arPoints[c]=n.pos[0],this.arPoints[c+1]=n.pos[1],this.arPoints[c+2]=n.pos[2],null!==n.color&&this.arColor!==w&&(this.arColor[c]=n.color[0],this.arColor[c+1]=n.color[1],this.arColor[c+2]=n.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else-1===d?null!==h&&(h.nextParticle=n.nextParticle):0===d&&a++;h=n;n=n.nextParticle}a||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(f.enable(f.BLEND),
f.enable(f.DEPTH_TEST),f.depthMask(0),f.blendFunc(f.ONE,f.ONE_MINUS_SRC_COLOR));f.drawArrays(f.POINTS,0,this.numParticles);this.alpha&&(f.disable(f.BLEND),f.depthMask(1),f.blendFunc(f.ONE,f.ONE));this.hasColor&&f.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:y,Particle:function(n,h,b,f,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(f!==w?f:[0,0,0]);this.accel=new Float32Array(a!==w?a:[0,0,0]);this.start_time=
h!==w?h:0;this.life_time=b!==w?b:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("HeightField",function(h){var y=h.undef,w=h.enums;w.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var q=function(b){b=b||{};this.operation=h.parseEnum(w.draw.op,b.operation||b.op)||w.draw.op.REPLACE;this.brushType=h.parseEnum(w.draw.brush,b.brushType)||w.draw.brush.SINE;this.brushSize=b.size||5;this.strength=b.strength||1};q.prototype={setOperation:function(b){this.operation=h.parseEnum(w.draw.op,b)},getOperation:function(){return this.operation},setBrushType:function(b){this.brushType=
h.parseEnum(w.draw.brush,b)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(b){this.brushSize=b},getSize:function(){return this.brushSize},setStrength:function(b){this.strength=b},getStrength:function(){return this.strength}};var n=function(b){b=b||{};this.divX=b.divX||null;this.divZ=b.divZ||null;this.size=b.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,
this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};n.prototype={initBuffer:function(b,f,a){this.hfBuffer=new ArrayBuffer(4*b*f);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=b||null;this.divZ=f||null;this.size=a||null;this.divX>this.divZ?(this.sizeX=a,this.sizeZ=a/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?a/this.divZ*this.divX:a,this.sizeZ=a);this.drawBuffer=[];this.cellSize=this.sizeX/
this.divX},setBrush:function(b){this.brush=b},getBrush:function(){return this.brush},draw:function(b,f,a){var c=this.brush||a,a=c.getOperation(),d=c.getSize(),e=c.getBrushType(),c=c.getStrength();if(this.areaBuffered){var g=b-d,o=f-d,m=b+d,r=f+d;g<this.drawArea.startX&&(this.drawArea.startX=g);o<this.drawArea.startZ&&(this.drawArea.startZ=o);m>this.drawArea.endX&&(this.drawArea.endX=m);m>this.drawArea.endX&&(this.drawArea.endZ=r)}else this.drawArea={startX:b-d,startZ:f-d,endX:b+d,endZ:f+d},this.areaBuffered=
!0;this.drawBuffer.push([b,f,a,d,e,c])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var b=this.drawBuffer.pop();this.drawFunc(b[0],b[1],b[2],b[3],b[4],b[5])}return!0},needsFlush:function(){return 0!==this.drawBuffer.length},drawFunc:function(b,f,a,c,d,e){for(var a=this.hfFloatBuffer,d=this.divX,g=this.divZ,c=c/this.cellSize,o=this.sizeZ/2-this.sizeZ/
this.divZ/2,b=b+(this.sizeX/2-this.sizeX/this.divX/2),b=b/this.cellSize,f=(f+o)/this.cellSize,o=parseInt(Math.floor(b-c),10),m=parseInt(Math.ceil(b+c),10);o<m;o++)for(var r=o-b,h=parseInt(Math.floor(f-c),10),n=parseInt(Math.ceil(f+c),10);h<n;h++)if(!(0>=o||o>=d||0>=h||h>=g)){var t=h-f,t=e*((1-Math.sqrt(r*r+t*t)/c)/2);0>t&&0<=e&&(t=0);0<t&&0>=e&&(t=0);a[h*d+o]+=t}},getUint8Buffer:function(){return this.hfUInt8Buffer},getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},
getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(b){var b=b||{},f=b.value||0,a=b.src||b.func||null,c=b.startX||0,d=b.startZ||0,e=b.walkX,g=b.walkZ,b=this.hfFloatBuffer,o,m=this.sizeX/2-this.sizeX/this.divX/2,r=this.sizeZ/2-this.sizeZ/this.divZ/2;if(c!==y&&d!==y&&e!==y&&g!==y){if(!(c>=this.divX)&&!(d>=this.divZ)&&(c+e>=this.divX&&(e=this.divX-
1-c),d+g>=this.divZ&&(g=this.divZ-1-d),!(0>=e||0>=g))){o=c;for(c+=e;o<c;o++)for(var e=d,h=d+g;e<h;e++){var n=o+e*this.divX;b[n]=null===a?f:a(this.cellSize*o-m,this.cellSize*e-r,n)}}}else{o=0;for(c=this.hfFloatBuffer.length;o<c;o++)null===a?b[o]=f:(d=a(o%this.divX*this.cellSize-m,Math.floor(o/this.divX)*this.cellSize-r,o),b[o]=d)}},getIndicesAt:function(b,f){if("object"===typeof b)return this.getIndicesAt(b[0],b[2]);var a=this.sizeX/2-this.sizeX/this.divX/2,c=this.sizeZ/2-this.sizeZ/this.divZ/2,d=
parseInt(Math.floor((b+a)/this.sizeX*this.divX),10),e=parseInt(Math.floor((f+c)/this.sizeZ*this.divZ),10);if(0>d||d>=this.divX-1||0>e||e>=this.divZ-1)return-1;if(1<=Math.abs(f-c-(d*this.cellSize-c))/Math.abs(b-a-(e*this.cellSize-c)))return a=[d+(e+1)*this.divX,d+1+e*this.divX,d+e*this.divX],[d,e,a,0];a=[d+(e+1)*this.divX,d+1+(e+1)*this.divX,d+1+e*this.divX];return[d,e,a,1]},getHeightValue:function(b,f){var a=h.triangle;if("object"===typeof b)return this.getHeightValue(b[0],b[2]);var c=this.getIndicesAt(b,
f);if(-1===c)return 0;var d=c[2],e=c[0]*this.cellSize-(this.sizeX/2-this.sizeX/this.divX/2),g=c[1]*this.cellSize-(this.sizeZ/2-this.sizeZ/this.divZ/2),o;o=0===c[3]?a.normal([e,this.hfFloatBuffer[d[0]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[1]],g],[e,this.hfFloatBuffer[d[2]],g]):a.normal([e,this.hfFloatBuffer[d[0]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[1]],g+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[d[2]],g]);a=o[0];c=o[1];o=o[2];d=[e,this.hfFloatBuffer[d[0]],
g+this.cellSize];return(a*b+o*f+(-(a*d[0])-c*d[1]-o*d[2]))/-c}};var s=h.extendClassGeneral(h.Mesh,function(b){b=b||{};b.dynamic=!0;b.buildWireframe=!0;this.material=b.material;this._update=h.Mesh.prototype.update;h.Mesh.apply(this,[b]);this.hField=b.hField||null;this.divX=b.divX||null;this.divZ=b.divZ||null;this.viewX=b.viewX||0;this.viewZ=b.viewZ||0;this.ofsX=b.ofsX||0;this.ofsZ=b.ofsZ||0;this.edgeX=b.edgeX||0;this.edgeZ=b.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(b,
f,a){this.points[b+f*this.divX][1]=a},genHeightfieldMesh:function(){var b,f,a=this.divX+this.edgeX,c=this.divZ+this.edgeZ,d=this.hField.getCellSize(),e=d*this.divX;b=d*this.divZ;0!==this.points.length&&this.clean();var g=-(b/2);for(f=0;f<c;f++){var o=-(e/2);for(b=0;b<a;b++)this.addPoint([o+this.ofsX,0,g+this.ofsZ]),o+=d;g+=d}this.setFaceMaterial(this.material);b=-1/(a-1);f=1/(c-1);for(e=g=0;e<c-1;e++){o=1;for(d=0;d<a-1;d++)f1=this.addFace([d+(e+1)*a,d+1+e*a,d+e*a]),f2=this.addFace([d+(e+1)*a,d+1+
(e+1)*a,d+1+e*a]),this.faces[f1].uvs=[[o,g+f],[o+b,g],[o,g]],this.faces[f2].uvs=[[o,g+f],[o+b,g+f],[o+b,g]],o+=b;g+=f}},recalcNormals:function(b){var f;if(b=b||this.normalMapRef){var b=this.divX+this.edgeX,a=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(f=0;f<this.points.length;f++)this.normalBuffer.push([0,1,0]);var c=0;for(f=0;f<a-1;f++)for(k=0;k<b-1;k++)this.faces[c++].point_normals=[this.normalBuffer[k+(f+1)*b],this.normalBuffer[k+1+f*b],this.normalBuffer[k+f*b]],this.faces[c++].point_normals=
[this.normalBuffer[k+(f+1)*b],this.normalBuffer[k+1+(f+1)*b],this.normalBuffer[k+1+f*b]]}a=this.hField;c=a.getFloat32Buffer();f=this.viewX||0;var d=(this.viewZ||0)*a.getDivX()+f;for(f=0;f<this.points.length;f++){var e=f%b,g=Math.floor(f/b),o=d+e+(g-1)*a.getDivX(),m=d+e+(g+1)*a.getDivX(),r=d+(e+1)+g*a.getDivX(),n=d+(e-1)+g*a.getDivX(),e=d+e+g*a.getDivX(),o=c[o],m=c[m],r=c[r],n=c[n],e=c[e];o===y&&(o=e);m===y&&(m=e);r===y&&(r=e);n===y&&(n=e);n=h.vec3.normalize([(r-e+(e-n))/2,2,(o-e+(e-m))/2]);this.normalBuffer[f][0]=
n[0];this.normalBuffer[f][1]=n[1];this.normalBuffer[f][2]=n[2]}return this}},update:function(){var b=this.viewX||0,f=this.viewZ||0,a=this.divX+this.edgeX,c=this.divZ+this.edgeZ,d=this.hField.getDivX();this.hField.getDivZ();for(var e=this.hField.getFloat32Buffer(),g=f,c=f+c;g<c;g++)for(var o=b,m=b+a;o<m;o++)this.points[(g-f)*a+(o-b)][1]=e[g*d+o];this._update()}});return{HeightField:n,HeightFieldBrush:q,HeightFieldMesh:s}});
CubicVR.RegisterModule("Landscape",function(h){var y=h.undef,w=Math.PI/2;return{Landscape:h.extendClassGeneral(h.SceneObject,function(){if(1<arguments.length)this.hField=new h.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new h.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3]}),this.hfMesh.prepare(),h.SceneObject.apply(this,[{mesh:this.hfMesh,shadowCast:!1}]);else{var q=arguments[0]||{};this.size=q.size||
128;this.divX=q.divX||128;this.divZ=q.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=q.tileX||this.divX;this.tileZ=q.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new h.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/
this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=q.spatResolution||1024;this.spats=q.spats||[];h.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var n=q=0,s=0;s<this.divZ;s+=this.tileZ){for(var b=q=0;b<this.divX;b+=this.tileX){var f=new CubicVR.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),a=b+1!=this.tileX?1:0,c=s+1!=this.tileZ?1:0,d=new CubicVR.SpatMaterial({color:[1,1,1],specular:[0.05,0.05,0.05],spats:this.spats,sourceTexture:f}),a=new h.HeightFieldMesh({hField:this.hField,
size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:b,viewZ:s,edgeX:a,edgeZ:c,material:d});a.prepare();c=new h.SceneObject({mesh:a});c.position[0]=-(this.sizeX/2)+this.tileSize*q+this.tileSize/2;c.position[2]=-(this.sizeZ/2)+this.tileSize*n+this.tileSize/2;this.bindChild(c);this.tiles.push(c);this.tileMeshes.push(a);this.tileMaterials.push(d);this.tileSpats.push(f);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);q++}n++}}},{update:function(){var h,n;this.hField.needsFlush()&&this.hField.flush();
h=this.hField.getDrawArea();if(!1!==h){var s=this.getTileAt(h.startX-this.cellSize,h.startZ-this.cellSize,h.endX-h.startX+this.cellSize,h.endZ-h.startZ,this.cellSize);!1!==s&&s.length===y&&(s=[s]);h=0;for(n=s.length;h<n;h++)this.tileChanged[s[h]]=!0;this.hField.clearDrawArea()}h=0;for(n=this.tiles.length;h<n;h++)if(this.tileChanged[h]&&(this.tileMeshes[h].update(),this.tileChanged[h]=!1),this.tileSpatChanged[h])this.tileSpats[h].update(),this.tileSpatChanged[h]=!1},getHeightField:function(){return this.hField},
mapGen:function(h,n,s,b,f){this.hField.setRect({src:h,startX:n,startZ:s,walkX:b,walkZ:f});this.hfMesh.update()},getFaceAt:function(h,n){return this.hField.getFaceAt([h,0,n])},getHeightValue:function(h,n){return this.hField.getHeightValue([h,0,n])},orient:function(h,n,s,b,f,a){a===y&&(a=0);var c,d,e=[];c=s/2;var g=b/2;d=Math.sqrt(g*g+c*c);g=Math.atan2(g,c);f*=Math.PI/180;c=h+Math.sin(f)*a;a=n+Math.cos(f)*a;e[0]=this.getHeightValue([c+d*Math.cos(-g-w+f),0,a+d*-Math.sin(-g-w+f)]);e[1]=this.getHeightValue([c+
d*Math.cos(g-w+f),0,a+d*-Math.sin(g-w+f)]);e[2]=this.getHeightValue([c+d*Math.cos(-g+w+f),0,a+d*-Math.sin(-g+w+f)]);e[3]=this.getHeightValue([c+d*Math.cos(g+w+f),0,a+d*-Math.sin(g+w+f)]);d=-Math.atan2(e[1]-e[2],s);a=-Math.atan2(e[0]-e[1],b);d+=-Math.atan2(e[0]-e[3],s);a+=-Math.atan2(e[3]-e[2],b);return[[h,(e[2]+e[3]+e[1]+e[0])/4,n],[d/2*(180/Math.PI),f,a/2*(180/Math.PI)]]},getTileAt:function(h,n,s,b){var s=s||0,b=b||0,f=Math.floor(this.divX/this.tileX),a=Math.floor((h+this.sizeX/2)/(this.tileX*this.tileSize)*
this.tileX),c=Math.floor((n+this.sizeZ/2)/(this.tileZ*this.tileSize)*this.tileZ),d=0;if(0===s&&0===b)return d=parseInt(a+c*f,10);h=Math.floor((h+s+this.sizeX/2)/(this.tileX*this.tileSize)*this.tileX);n=Math.floor((n+b+this.sizeZ/2)/(this.tileZ*this.tileSize)*this.tileZ);for(b=[];c<=n;c++)for(s=a;s<=h;s++)d=c*(this.divX/this.tileX)+s,0<=d&&d<this.tiles.length&&b.push(d);return b},getSpatLocation:function(h,n,s){if(s===y)h=(1-(h/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%
this.spatResolution,n=(1-(n/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divZ/this.tileZ)%this.spatResolution;else var b=this.divX/this.tileX,f=-this.sizeZ/2+Math.floor(s/b)*this.tileSize,h=(1-(h-(-this.sizeX/2+s%b*this.tileSize))/this.tileSize)*this.spatResolution,n=(1-(n-f)/this.tileSize)*this.spatResolution;return{x:h,z:n}},drawSpat:function(h,n,s){var b=s.getSize()*(this.size/this.spatResolution),f=h-b/2,a=n-b/2,b=this.getTileAt(f,a,h+b/2-f,n+b/2-a);!1!==b&&b.length===y&&(b=
[b]);if(!1!==b){f=0;for(a=b.length;f<a;f++){var c=b[f],d=this.getSpatLocation(h,n,c);0<=c&&c<this.tileSpats.length&&(this.tileSpats[c].draw(d.x,d.z,s),this.tileSpatChanged[c]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(h){var y=h.undef,w;return{SpatMaterial:h.extendClassGeneral(h.Material,function(q){q=q||{};w||(w=new h.Texture);this.spats=q.spats||[w,w,w,w,w];this.sourceTex=q.sourceTexture||w;var n=this.spats,s;for(s in n){var b=n[s];"string"===typeof b&&(n[s]=h.Textures_ref[b]!==y?h.Textures_obj[h.Textures_ref[b]]:new h.Texture(b))}this.spatOffset=q.spatOffset||[1,0,1];this.spatResolution=q.spatResolution||[1,0,1];this.spatShader=new h.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",
fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.z);\nif (spatSourceCoord.s<=0.01) {\n   spatSourceCoord.s=0.01;\n}\nif (spatSourceCoord.t>=0.99) {\n   spatSourceCoord.t=0.99;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(b){return function(a,c){var d=c.textureIndex;a.spatImage.set(d++,b.sourceTex);a.spatOffset.set(b.spatOffset);n[0]&&a.spat0.set(d++,n[0]);n[1]&&a.spat1.set(d++,n[1]);n[2]&&a.spat2.set(d++,n[2]);n[3]&&a.spat3.set(d++,n[3]);n[4]&&a.spat4.set(d++,n[4])}}(this)});q.shader=this.spatShader;h.Material.apply(this,[q])},{setSpats:function(h){this.spats=h},getSpats:function(){return this.spats},setSource:function(h){this.sourceTexture=h}})}});
CubicVR.RegisterModule("Octree",function(h){function y(a,b,e,g,f){var m=this._children=[];this._dirty=!1;m[0]=null;m[1]=null;m[2]=null;m[3]=null;m[4]=null;m[5]=null;m[6]=null;m[7]=null;this._child_index=f||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;g=this._position=g||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[g[0],g[1],g[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=h.aabb;e.reset(b,g);a/=2;e.engulf(b,[g[0]+a,g[1]+
a,g[2]+a]);e.engulf(b,[g[0]-a,g[1]-a,g[2]-a]);this._debug_visible=!1}function w(){this.position=[0,0,0];this.visible=!1;this._object=null}function q(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var n=h.undef,s=h.plane,b=h.sphere,f=h.enums;f.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};f.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,b,e){e=a.slice((e||b)+1||a.length);
a.length=0>b?a.length+b:b;return a.push.apply(a,e)};y.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].destroy();a=0;for(b=this._nodes.length;a<
b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};y.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};y.prototype.remove=function(c){var b=!1,e=this._nodes.length,g;g=e-1;for(e=this._nodes.length;0<=g;--g)if(c===this._nodes[g]){a(this._nodes,g);this.dirty_lineage();b=!0;break}if(!b)for(g=e-1;0<=g;--g)if(c===this._lights[g]){a(this._lights,g);this.dirty_lineage();break}};y.prototype.dirty_lineage=function(){this._dirty=!0;null!==this._root&&
this._root.dirty_lineage()};y.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var g=this._children[e];if(null!==g){var f=!0;!0===g._dirty&&(f=g.cleanup());f?++b:this._children[e]=null}}return 0===this._nodes.length&&(0===this._static_lights.length&&0===this._lights.length)&&(0===b||0===a)?!1:!0};y.prototype.insert_light=function(a){this.insert(a,!0)};y.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<e;++b)-1===this._nodes[b].static_lights.indexOf(a)&&
this._nodes[b].static_lights.push(a);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].propagate_static_light(a)};y.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)-1===a.static_lights.indexOf(this._static_lights[b])&&a.static_lights.push(this._static_lights[b]);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].collect_static_lights(a)};y.prototype.insert=function(a,b){function e(a,c,b,d){var e,g;if(b)if(c.method===f.light.method.STATIC){-1===
a._static_lights.indexOf(c)&&a._static_lights.push(c);b=0;for(e=a._nodes.length;b<e;++b)-1===a._nodes[b].static_lights.indexOf(c)&&a._nodes[b].static_lights.push(c);for(g=a._root;null!==g;){b=0;for(l=g._nodes.length;b<l;++b)e=g._nodes[b],-1===e.static_lights.indexOf(c)&&e.static_lights.push(c);g=g._root}}else-1===a._lights.indexOf(c)&&a._lights.push(c);else{a._nodes.push(c);b=0;for(e=a._static_lights.length;b<e;++b)-1===c.static_lights.indexOf(a._static_lights[b])&&c.static_lights.push(a._static_lights[b]);
for(g=a._root;null!==g;){b=0;for(e=g._static_lights.length;b<e;++b){var m=g._static_lights[b];-1===c.static_lights.indexOf(m)&&c.static_lights.push(m)}g=g._root}}c.octree_leaves.push(a);c.octree_common_root=d;d=h.aabb;d.engulf(c.octree_aabb,a._bbox[0]);d.engulf(c.octree_aabb,a._bbox[1])}b===n&&(b=!1);null===this._root&&(a.octree_leaves=[],a.octree_common_root=null);if(0===this._max_depth)e(this,a,b,this._root);else{var g=this._position,o,m,r,q,v,t,s;m=a.getAABB();s=[m[0][0],m[0][1],m[0][2]];var D=
[m[1][0],m[1][1],m[1][2]];o=s[0]<g[0]&&s[1]<g[1]&&s[2]<g[2];m=D[0]>g[0]&&s[1]<g[1]&&s[2]<g[2];v=s[0]<g[0]&&D[1]>g[1]&&s[2]<g[2];t=D[0]>g[0]&&D[1]>g[1]&&s[2]<g[2];r=s[0]<g[0]&&s[1]<g[1]&&D[2]>g[2];q=D[0]>g[0]&&s[1]<g[1]&&D[2]>g[2];s=s[0]<g[0]&&D[1]>g[1]&&D[2]>g[2];g=D[0]>g[0]&&D[1]>g[1]&&D[2]>g[2];if(o&&m&&v&&t&&r&&q&&s&&g)e(this,a,b,this),b?a.method==f.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var D=0,C=this._static_lights.length;D<C;++D)a.static_lights===
n&&(a.static_lights=[]),-1===a.static_lights.indexOf(this._static_lights[D])&&a.static_lights.push(this._static_lights[D]);var D=this._size/2,C=this._size/4,w=0,u=this._position[0],x=this._position[1],E=this._position[2];o&&(o=[u-C,x-C,E-C],null===this._children[f.octree.TOP_NW]&&(this._children[f.octree.TOP_NW]=new y(D,this._max_depth-1,this,o,f.octree.TOP_NW)),this._children[f.octree.TOP_NW].insert(a,b),++w);m&&(o=[u+C,x-C,E-C],null===this._children[f.octree.TOP_NE]&&(this._children[f.octree.TOP_NE]=
new y(D,this._max_depth-1,this,o,f.octree.TOP_NE)),this._children[f.octree.TOP_NE].insert(a,b),++w);v&&(o=[u-C,x+C,E-C],null===this._children[f.octree.BOTTOM_NW]&&(this._children[f.octree.BOTTOM_NW]=new y(D,this._max_depth-1,this,o,f.octree.BOTTOM_NW)),this._children[f.octree.BOTTOM_NW].insert(a,b),++w);t&&(o=[u+C,x+C,E-C],null===this._children[f.octree.BOTTOM_NE]&&(this._children[f.octree.BOTTOM_NE]=new y(D,this._max_depth-1,this,o,f.octree.BOTTOM_NE)),this._children[f.octree.BOTTOM_NE].insert(a,
b),++w);r&&(o=[u-C,x-C,E+C],null===this._children[f.octree.TOP_SW]&&(this._children[f.octree.TOP_SW]=new y(D,this._max_depth-1,this,o,f.octree.TOP_SW)),this._children[f.octree.TOP_SW].insert(a,b),++w);q&&(o=[u+C,x-C,E+C],null===this._children[f.octree.TOP_SE]&&(this._children[f.octree.TOP_SE]=new y(D,this._max_depth-1,this,o,f.octree.TOP_SE)),this._children[f.octree.TOP_SE].insert(a,b),++w);s&&(o=[u-C,x+C,E+C],null===this._children[f.octree.BOTTOM_SW]&&(this._children[f.octree.BOTTOM_SW]=new y(D,
this._max_depth-1,this,o,f.octree.BOTTOM_SW)),this._children[f.octree.BOTTOM_SW].insert(a,b),++w);g&&(o=[u+C,x+C,E+C],null===this._children[f.octree.BOTTOM_SE]&&(this._children[f.octree.BOTTOM_SE]=new y(D,this._max_depth-1,this,o,f.octree.BOTTOM_SE)),this._children[f.octree.BOTTOM_SE].insert(a,b),++w);if(1<w||null===a.octree_common_root)a.octree_common_root=this}}};y.prototype.draw_on_map=function(a,b,e){function g(a,c,e,g,h){var n=a<e?a:e,t=c<g?c:g,a=a<e?e-a:a-e,c=c<g?g-c:c-g;b.save();void 0!==h&&
(b.fillStyle=h,b.fillRect(f+n,m+t,a,c));b.strokeRect(f+n,m+t,a,c);b.restore()}var f=a.width/2,m=a.height/2,h,q,s,t,A,D,C;if(e===n||"map"===e)b.save(),!1!==this._debug_visible?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),A=this._size/2,h=this._position[0],q=this._position[2],b.moveTo(f+h-A,f+q-A),b.lineTo(f+h-A,f+q+A),b.lineTo(f+h+A,f+q+A),b.lineTo(f+h+A,f+q-A),b.stroke(),b.fill(),b.restore();if(e===n||"objects"===e){b.save();
A=0;for(C=this._nodes.length;A<C;++A)D=this._nodes[A],b.fillStyle="#5500FF",b.strokeStyle=!0===D.visible&&!1===D.culled?"#FFFFFF":"#000000",b.beginPath(),h=D.aabb[0][0],q=D.aabb[0][2],s=D.aabb[1][0]-h,t=D.aabb[1][2]-q,b.rect(f+h,m+q,s,t),b.stroke();b.restore()}if(e===n||"lights"===e){A=0;for(C=this._lights.length;A<C;++A)t=this._lights[A],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),D=t.distance,h=t.position[0],
q=t.position[2],b.arc(f+h,m+q,D,0,2*Math.PI,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),h=t.aabb[0][0],q=t.aabb[0][2],s=t.aabb[1][0]-h,t=t.aabb[1][2]-q,b.rect(f+h,m+q,s,t),b.closePath(),b.stroke();A=0;for(C=this._static_lights.length;A<C;++A)t=this._static_lights[A],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),D=t.distance,h=t.position[0],q=t.position[2],b.arc(f+h,m+q,D,0,2*Math.PI,!0),b.closePath(),
b.stroke(),b.fill(),b.beginPath(),h=t.aabb[0][0],q=t.aabb[0][2],s=t.aabb[1][0]-h,t=t.aabb[1][2]-q,b.rect(f+h,m+q,s,t),b.closePath(),b.stroke()}if("lights"!=e&&"objects"!=e&&"map"!=e){b.save();h=this._nodes;A=0;for(t=h.length;A<t;++A)if(D=h[A],D.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();h=D.aabb[0][0];q=D.aabb[0][2];s=D.aabb[1][0]-h;t=D.aabb[1][2]-q;b.rect(f+h,m+q,s,t);b.closePath();b.stroke();h=D.octree_aabb;b.strokeStyle="#0000FF";g(h[0][0],h[0][2],h[1][0],h[1][2]);b.lineWidth=
1;null!==D.common_root&&(b.strokeStyle="#00FF00");break}b.lineWidth=1;b.strokeStyle="#FFFF00";g(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}A=0;for(C=this._children.length;A<C;++A)null!==this._children[A]&&this._children[A].draw_on_map(a,b,e)};y.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};y.prototype.get_frustum_hits=function(a,d){var e={objects:[],lights:[]};if((d===n||!0===d)&&!this.contains_point(a.position)){if(!1===b.intersects(a.frustum.sphere,this._sphere))return e;var g=a.frustum.contains_sphere(this._sphere);if(-1===g)return this._debug_visible=!1,e;if(1===g)this._debug_visible=2,d=!1;else if(0===g){this._debug_visible=!0;g=a.frustum.contains_box(this._bbox);if(-1===g)return this._debug_visible=!1,e;1===
g&&(this._debug_visible=3,d=!1)}}var f,m,g=0;for(f=this._nodes.length;g<f;++g)m=this._nodes[g],e.objects.push(m),m.dynamic_lights=[].concat(this._lights),m.was_culled=m.culled,m.culled=!1,m.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;g=0;for(f=this._lights.length;g<f;++g)m=this._lights[g],!0===m.visible&&(e.lights.push(m),m.was_culled=m.culled,m.culled=!1);g=0;for(f=this._static_lights.length;g<f;++g)m=this._static_lights[g],!0===m.visible&&(m.culled=!1);for(g=
0;8>g;++g)if(null!==this._children[g]){f=this._children[g].get_frustum_hits(a,d);var h;m=0;for(h=f.objects.length;m<h;++m){e.objects.push(f.objects[m]);for(var q=f.objects[m].dynamic_lights,s=0,t=this._lights.length;s<t;++s)0>q.indexOf(this._lights[s])&&q.push(this._lights[s])}m=0;for(h=f.lights.length;m<h;++m)0>e.lights.indexOf(f.lights[m])&&e.lights.push(f.lights[m])}return e};y.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=
!0;a=0;for(b=this._lights.length;a<b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};w.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};w.prototype.attach=function(a){this._object=a};q.prototype.extract=function(a,b,e){var g=h.mat4,o=h.vec3;if(!(b===n||e===n)){g=g.multiply(e,b);b=this._planes;b[f.frustum.plane.LEFT][0]=
g[3]+g[0];b[f.frustum.plane.LEFT][1]=g[7]+g[4];b[f.frustum.plane.LEFT][2]=g[11]+g[8];b[f.frustum.plane.LEFT][3]=g[15]+g[12];b[f.frustum.plane.RIGHT][0]=g[3]-g[0];b[f.frustum.plane.RIGHT][1]=g[7]-g[4];b[f.frustum.plane.RIGHT][2]=g[11]-g[8];b[f.frustum.plane.RIGHT][3]=g[15]-g[12];b[f.frustum.plane.TOP][0]=g[3]-g[1];b[f.frustum.plane.TOP][1]=g[7]-g[5];b[f.frustum.plane.TOP][2]=g[11]-g[9];b[f.frustum.plane.TOP][3]=g[15]-g[13];b[f.frustum.plane.BOTTOM][0]=g[3]+g[1];b[f.frustum.plane.BOTTOM][1]=g[7]+g[5];
b[f.frustum.plane.BOTTOM][2]=g[11]+g[9];b[f.frustum.plane.BOTTOM][3]=g[15]+g[13];b[f.frustum.plane.NEAR][0]=g[3]+g[2];b[f.frustum.plane.NEAR][1]=g[7]+g[6];b[f.frustum.plane.NEAR][2]=g[11]+g[10];b[f.frustum.plane.NEAR][3]=g[15]+g[14];b[f.frustum.plane.FAR][0]=g[3]-g[2];b[f.frustum.plane.FAR][1]=g[7]-g[6];b[f.frustum.plane.FAR][2]=g[11]-g[10];b[f.frustum.plane.FAR][3]=g[15]-g[14];for(var m=0;6>m;++m)s.normalize(b[m]);m=-b[f.frustum.plane.NEAR][3];b=b[f.frustum.plane.FAR][3]-m;e=b*(1/e[5]);e=o.subtract([0,
0,m+0.5*b],[e,e,m+b]);e=o.length(e);g=[g[3],g[9],g[10]];m=o.length(g);g=o.multiply(g,1/m);a=[a.position[0],a.position[1],a.position[2]];a=o.add(a,o.multiply(g,0.5*b));a=o.add(a,o.multiply(g,1));this.sphere=[a[0],a[1],a[2],e]}};q.prototype.contains_sphere=function(a){for(var b=h.vec3,e=this._planes,g=0;6>g;++g){var f=e[g],f=b.dot([f[0],f[1],f[2]],[a[0],a[1],a[2]])+f.d;this.last_in[g]=1;if(f<-a[3])return-1;if(Math.abs(f)<a[3])return 0}return 1};q.prototype.draw_on_map=function(a,b){var e=a.width/2,
g=a.height/2;b.save();for(var f=this._planes,m=[0,1,4,5],h=0,n=m.length;h<n;++h){var q=f[m[h]];b.strokeStyle="#FF00FF";h<this.last_in.length&&this.last_in[h]&&(b.strokeStyle="#FFFF00");var t=-e,s=e,D=(-q[3]-q[0]*s)/q[2];b.moveTo(e+t,g+(-q[3]-q[0]*t)/q[2]);b.lineTo(e+s,g+D);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(e+this.sphere[0],g+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);b.closePath();b.stroke();b.restore()};q.prototype.contains_box=function(a){var b=0,e=[];e[0]=a[0];e[1]=[a[0][0],
a[0][1],a[1][2]];e[2]=[a[0][0],a[1][1],a[0][2]];e[3]=[a[0][0],a[1][1],a[1][2]];e[4]=[a[1][0],a[0][1],a[0][2]];e[5]=[a[1][0],a[0][1],a[1][2]];e[6]=[a[1][0],a[1][1],a[0][2]];e[7]=a[1];for(var a=this._planes,g=0;6>g;++g){for(var f=8,m=1,h=0;8>h;++h)-1===s.classifyPoint(a[g],e[h])&&(m=0,--f);this.last_in[g]=m;if(0===f)return-1;b+=m}return 6===b?1:0};return{Frustum:q,Octree:y}});
CubicVR.RegisterModule("CVRXML",function(h){function y(a,b,g,f){var m=CubicVR.util,h=null,n=null;f.triangles&&(n=m.intDelimArray(c.getTextNode(f,"triangles")," "));if(n&&(f.segments&&(h=m.intDelimArray(c.getTextNode(f,"segments")," ")),null===h&&(h=[0,parseInt(n.length/3,10)]),f=0,a.setFaceMaterial(b),n.length)){p=0;for(pMax=h.length;p<pMax;p+=2){b=3*h[p+1];a.setSegment(h[p]);j=f;for(jMax=f+b;j<jMax;j+=3)m=a.addFace([n[j],n[j+1],n[j+2]]),g&&a.faces[m].setUV([g[j],g[j+1],g[j+2]]);f+=b}}}function w(a){var b=
CubicVR.util,g=new CubicVR.UVMapper,o=null,m=null;if(a.type)switch(o=c.getTextNode(a,"type"),o){case "planar":g.projection_mode=f.uv.projection.PLANAR;break;case "cylindrical":g.projection_mode=f.uv.projection.CYLINDRICAL;break;case "spherical":g.projection_mode=f.uv.projection.SPHERICAL;break;case "cubic":g.projection_mode=f.uv.projection.CUBIC}if(!o)return null;"uv"===o&&a.uv&&(m=c.getPoints(a,"uv"));if(a.axis)switch(c.getTextNode(a,"axis")){case "x":g.projection_axis=f.uv.axis.X;break;case "y":g.projection_axis=
f.uv.axis.Y;break;case "z":g.projection_axis=f.uv.axis.Z}a.center&&(g.center=b.floatDelimArray(c.getTextNode(a,"center")));a.rotation&&(g.rotation=b.floatDelimArray(c.getTextNode(a,"rotation")));a.scale&&(g.scale=b.floatDelimArray(c.getTextNode(a,"scale")));a.wrap_w&&(g.wrap_w_count=parseFloat(c.getTextNode(a,"wrap_w")));a.wrap_h&&(g.wrap_h_count=parseFloat(c.getTextNode(a,"wrap_h")));return""!==o&&"uv"!==o?g:m}function q(d,e){if(a[d]!==b)return a[d];var g=CubicVR.util,o,m,n,q;o=null;o="object"==
typeof d?d:-1!=d.indexOf(".js")?g.getJSON(d):CubicVR.util.xml2badgerfish(g.getXML(d));o.root&&(o=o.root);o.properties&&(o=o.properties);g=new CubicVR.Mesh;o.points&&(n=c.getPoints(o,"points"))&&g.addPoint(n);var s=o.material;s&&!s.length&&(s=[s]);var t=[];if(s){o=0;for(n=s.length;o<n;o++){var A=s[o],D;D=A;var C=e,I=new CubicVR.Material({name:D.name?D.name.$:null});D.shininess&&(I.shininess=c.getFloatNode(D,"shininess",I.shininess)/100);I.opacity=c.getFloatNode(D,"alpha",I.opacity);I.max_smooth=c.getFloatNode(D,
"max_smooth",I.max_smooth);I.color=c.getFloatDelimNode(D,"color",I.color);I.ambient=c.getFloatDelimNode(D,"ambient",I.ambient);I.diffuse=c.getFloatDelimNode(D,"diffuse",I.diffuse);I.specular=c.getFloatDelimNode(D,"specular",I.specular);m=void 0;if(m=c.getTextNode(D,"texture"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.COLOR);if(m=c.getTextNode(D,"texture_luminosity"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:
new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.AMBIENT);if(m=c.getTextNode(D,"texture_normal"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.NORMAL);if(m=c.getTextNode(D,"texture_specular"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.SPECULAR);if(m=c.getTextNode(D,"texture_bump"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:
new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.BUMP);if(m=c.getTextNode(D,"texture_envsphere"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.ENVSPHERE);if(m=c.getTextNode(D,"texture_alpha"))m=(C?C:"")+m,tex=h.Textures_ref[m]!==b?h.Textures_obj[h.Textures_ref[m]]:new CubicVR.Texture(m),I.setTexture(tex,f.texture.map.ALPHA);D=I;var u=null;m=C=null;A.uvmapper&&((C=w(A.uvmapper))&&!C.length?t.push([C,D]):m=C);(I=A.part)&&
!I.length&&(I=[I]);if(I&&I.length){var x=null,E=null;m=0;for(q=I.length;m<q;m++){var z=I[m],x=null;if(u=z.uvmapper)x=w(u),A.triangles&&(E=u=g.faces.length,x&&!x.length?(y(g,D,null,z),E=g.faces.length-1,g.calcFaceNormals(u,E),x.apply(g,D,b,u,E)):x&&x.length?y(g,D,x,z):C&&!C.length&&(y(g,D,null,z),E=g.faces.length-1,g.calcFaceNormals(u,E),C.apply(g,D,b,u,E)));if(z.procedural){(u=z.uvmapper)&&(x=w(u));var E=z.transform?c.getTransform(z.transform):b,u=b,z=z.procedural,F=c.getTextNode(z,"type");E&&(u=
new CubicVR.Transform,u.translate(E.position),u.pushMatrix(),u.rotate(E.rotation),u.pushMatrix(),u.scale(E.scale));C||(C=b);x={material:D,uvmapper:C||x};if("box"===F||"cube"===F)x.size=c.getFloatNode(z,"size"),g.booleanAdd(CubicVR.primitives.box(x),u);else if("sphere"===F)x.radius=c.getFloatNode(z,"radius"),x.lat=c.getIntNode(z,"lat"),x.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.sphere(x),u);else if("cone"===F)x.base=c.getFloatNode(z,"base"),x.height=c.getFloatNode(z,"height"),x.lon=
c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.cone(x),u);else if("plane"===F)x.size=c.getFloatNode(z,"size"),g.booleanAdd(CubicVR.primitives.plane(x),u);else if("cylinder"===F)x.radius=c.getFloatNode(z,"radius"),x.height=c.getFloatNode(z,"height"),x.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.cylinder(x),u);else if("torus"===F)x.innerRadius=c.getFloatNode(z,"innerRadius"),x.outerRadius=c.getFloatNode(z,"outerRadius"),x.lat=c.getIntNode(z,"lat"),x.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.torus(x),
u);else if("lathe"===F)x.points=c.getPoints(z,"p"),x.lon=c.getIntNode(z,"lon"),g.booleanAdd(CubicVR.primitives.lathe(x),u);else if("polygon"===F){E=c.getPoints(z,"p");E=new CubicVR.Polygon(E);(F=z.cut)&&!F.length&&(F=[F]);if(F.length){m=0;for(n=F.length;m<q;m++)E.cut(new CubicVR.Polygon(c.getPoints(F[m])))}x.front=0;x.back=0;x.frontShift=0;x.backShift=0;x.frontDepth=0;x.backDepth=0;if(z.extrude&&(z=z.extrude,x.front=c.getFloatNode(z,"front",0),x.back=c.getFloatNode(z,"back",0),x.frontShift=c.getFloatNode(z,
"frontBevelShift",0),x.backShift=c.getFloatNode(z,"backBevelShift",0),x.frontDepth=c.getFloatNode(z,"frontBevelDepth",0),x.backDepth=c.getFloatNode(z,"backBevelDepth",0),x.depth=c.getFloatNode(z,"depth",0),x.shift=c.getFloatNode(z,"shift",0),x.bevel=c.getFloatNode(z,"bevel",0),x.depth&&(!x.backDepth&&!x.frontDepth)&&(x.front=-x.depth/2,x.back=x.depth/2),x.shift&&(!x.backShift&&!x.frontShift)&&(x.frontShift=x.shift,x.backShift=x.shift),x.bevel&&!x.backDepth&&!x.frontDepth))x.frontDepth=x.bevel,x.backDepth=
x.bevel;z=E.toExtrudedBeveledMesh(new CubicVR.Mesh,x);z.setFaceMaterial(x.material);g.booleanAdd(z,u)}}}}else y(g,D,m,A)}}g.triangulateQuads();g.calcNormals();o=0;for(n=t.length;o<n;o++)t[o][0].apply(g,t[o][1]);g.compile();return a[d]=g}function n(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function s(a,c,g){var o=CubicVR.util,m=[];m[0]=a.getElementsByTagName("x");m[1]=a.getElementsByTagName("y");
m[2]=a.getElementsByTagName("z");m[3]=a.getElementsByTagName("fov");var h,n,q,t,s,D;for(D in m)if(m.hasOwnProperty(D)&&m[D]!==b&&m[D].length){h=m[D][0].getElementsByTagName("time");n=m[D][0].getElementsByTagName("value");q=m[D][0].getElementsByTagName("in");t=m[D][0].getElementsByTagName("out");s=m[D][0].getElementsByTagName("tcb");var C=null,w=null,u=null,x=a=null;q.length&&(a=o.collectTextNode(q[0]));t.length&&(x=o.collectTextNode(t[0]));h.length&&(C=o.floatDelimArray(o.collectTextNode(h[0])," "));
n.length&&(w=o.floatDelimArray(o.collectTextNode(n[0])," "));s.length&&(u=o.floatDelimArray(o.collectTextNode(s[0])," "));if(null!==C&&null!==w){h=0;for(n=C.length;h<n;h++)q=g.setKey(c,D,C[h],w[h]),u&&(q.tension=u[3*h],q.continuity=u[3*h+1],q.bias=u[3*h+2])}w=C=f.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":C=f.envelope.behavior.RESET;break;case "constant":C=f.envelope.behavior.CONSTANT;break;case "repeat":C=f.envelope.behavior.REPEAT;break;case "oscillate":C=f.envelope.behavior.OSCILLATE;
break;case "offset":C=f.envelope.behavior.OFFSET;break;case "linear":C=f.envelope.behavior.LINEAR}if(x)switch(x){case "reset":w=f.envelope.behavior.RESET;break;case "constant":w=f.envelope.behavior.CONSTANT;break;case "repeat":w=f.envelope.behavior.REPEAT;break;case "oscillate":w=f.envelope.behavior.OSCILLATE;break;case "offset":w=f.envelope.behavior.OFFSET;break;case "linear":w=f.envelope.behavior.LINEAR}g.setBehavior(c,D,C,w)}}var b=h.undef,f=CubicVR.enums,a=[],c={getPoints:function(a,e,f){a=e?
c.getTextNode(a,e):a.$;if(!a)return b;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var c=CubicVR.util;if(!a)return null;var b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},f;postition=a.position;f=a.rotation;a=a.scale;f&&(b.rotation=c.floatDelimArray(f.$));a&&(b.scale=c.floatDelimArray(a.$));return f||a?b:null},getTextNode:function(a,c,b){a=a[c];if(!a)return b;
a.length&&(a=a[0]);return a.$?a.$:b},getFloatNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseFloat(a),a!=a?f:a):f},getIntNode:function(a,b,f){return(a=c.getTextNode(a,b))?(a=parseInt(a,10),a!=a?f:a):f},getFloatDelimNode:function(a,b,f,o){var m=CubicVR.util;return(a=c.getTextNode(a,b))?m.floatDelimArray(a,o):f},getIntDelimNode:function(a,b,f,o){var m=CubicVR.util;return(a=c.getTextNode(a,b))?m.intDelimArray(a,o):f}};return{loadMesh:q,loadScene:function(a,c,g){var o=CubicVR.util;c===b&&(c=
"");g===b&&(g="");for(var m=new CubicVR.Mesh,h=o.getXML(a),a=new CubicVR.Scene,B=[],v=h.getElementsByTagName("sceneobjects"),t,A,D,w=0,y=v[0].childNodes.length;w<y;w++){var u=v[0].childNodes[w];if("sceneobject"===u.tagName){var x="unnamed",E="",z="",m=u.getElementsByTagName("name");m.length&&(x=o.collectTextNode(m[0]));m=u.getElementsByTagName("parent");m.length&&(E=o.collectTextNode(m[0]));m=u.getElementsByTagName("model");m.length&&(z=o.collectTextNode(m[0]));D=A=t=null;m=u.getElementsByTagName("position");
m.length&&(t=m[0]);m=u.getElementsByTagName("rotation");m.length&&(A=m[0]);m=u.getElementsByTagName("scale");m.length&&(D=m[0]);m=null;""!==z&&(m=q(c+z,g));m=new CubicVR.SceneObject(m,x);n(t)?(m.motion||(m.motion=new CubicVR.Motion),s(t,f.motion.POS,m.motion)):t&&(m.position=o.floatDelimArray(o.collectTextNode(t)));n(A)?(m.motion||(m.motion=new CubicVR.Motion),s(A,f.motion.ROT,m.motion)):m.rotation=o.floatDelimArray(o.collectTextNode(A));n(D)?(m.motion||(m.motion=new CubicVR.Motion),s(D,f.motion.SCL,
m.motion)):m.scale=o.floatDelimArray(o.collectTextNode(D));a.bindSceneObject(m);""!==E&&B.push([m,E])}}for(var F in B)B.hasOwnProperty(F)&&a.getSceneObject(B[F][1]).bindChild(B[F][0]);c=h.getElementsByTagName("camera");c.length&&((A=t=null,g="",m=c[0].getElementsByTagName("name"),F=a.camera,h=null,m.length&&(g=m[0].firstChild.nodeValue),m=c[0].getElementsByTagName("target"),m.length&&(g=m[0].firstChild.nodeValue),""!==g&&(F.targetSceneObject=a.getSceneObject(g)),m=c[0].getElementsByTagName("position"),
m.length&&(t=m[0]),m=c[0].getElementsByTagName("rotation"),m.length&&(A=m[0]),m=c[0].getElementsByTagName("fov"),m.length&&(h=m[0]),n(t)?(F.motion||(F.motion=new CubicVR.Motion),s(t,f.motion.POS,F.motion)):t&&(F.position=o.floatDelimArray(t.firstChild.nodeValue)),n(A)?(F.motion||(F.motion=new CubicVR.Motion),s(A,f.motion.ROT,F.motion)):A&&(F.rotation=o.floatDelimArray(A.firstChild.nodeValue)),n(h))?(F.motion||(F.motion=new CubicVR.Motion),s(h,f.motion.FOV,F.motion)):h&&(F.fov=parseFloat(h.firstChild.nodeValue)));
return a}}});
CubicVR.RegisterModule("Worker",function(h){function y(a){var c=this;this.message=a.message||function(){};this.send=function(a,c){postMessage({message:a,data:c})};self.addEventListener("message",function(a){"init"!==a.data.message&&c.message(a.data)},!1)}function w(a){function c(a){setTimeout(function(){b.send("test",a)},1E3)}a&&c(a);var b=new y({message:c})}function q(a){function c(a){a=r.getURL(a);b.send("done",a.length)}var b;b=new y({message:function(a){c(a)}});a&&c(a)}function n(a){function c(a){a=r.getURL(a);
b.send("loaded",a)}var b,d;b=new y({message:function(a){if("parse"===a.message)d=new m,CubicVR.loadCollada("","",d,a.data),b.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var c=a.triangulateQuads().compileVBO(a.compileMap());b.send("getMesh",{mesh:a,vbo:c})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&c(a)}function s(c){function b(c){var e=new a,f;for(f in c)c.hasOwnProperty(f)&&(e[f]=c[f]);c=e.triangulateQuads().compileVBO(e.compileMap());d.send("done",
c)}var d;d=new y({message:function(a){b(a)}});c&&b(c)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(b){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var f=h.undef,a=CubicVR.Mesh,c=CubicVR.Texture,d=CubicVR.Material,e=CubicVR.SceneObject,g=CubicVR.Motion,o=CubicVR.Envelope,m=CubicVR.DeferredBin,r=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var c=this;this.worker.onmessage=function(a){c.message(a.data)};this.worker.onerror=function(a){c.error(a)};this.init=function(a){c.send("init",{type:c.type,data:a})};this.send=function(a,b){c.worker.postMessage({message:a,data:b})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&c.init(a.data)},ResourcePool:function(){function b(c){var d=c.parsed||
function(){},e={},f;c.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:c.url,message:function(c){if("loaded"===c.message){var c=(new DOMParser).parseFromString(c.data,"text/xml"),b=r.xml2badgerfish(c);console.log(c);f.send("parse",b)}else if("getMesh"===c.message){var b=new a,g;for(g in c.data.mesh)c.data.mesh.hasOwnProperty(g)&&(b[g]=c.data.mesh[g]);b.bindBuffer(b.bufferVBO(c.data.vbo));e.getMesh&&e.getMesh(b)}else"parsed"===c.message&&d()}}));this.getSceneObject=function(a,c){f.send("getMesh",
a);e.getMesh=c}}function f(a,c){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c}var g=this,m={};this.createSceneFileManager=function(a){var c=new b({url:a.url,parsed:a.parsed});return m[a.url]=c};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete m[settings];else for(var c in m)m[c]===a&&delete m[c]};this.createSceneObjectFromMesh=function(b){var m=b.scene,h=b.object,o=b.assetBase||"",n=g.createSceneFileManager({url:b.mesh,parsed:function(){h&&n.getSceneObject(h,
function(b){for(var b=f(b,new a),g=0,h=b.materials.length;g<h;++g){for(var n=f(b.materials[g],new d),t=0,r=n.textures.length;t<r;++t){var q=n.textures[g];n.textures[g]=new c(o+q.img_path,q.filter_type)}b.materials[g]=n}b=new e(b);m.bindSceneObject(b)})}})};this.loadFile=function(a,c){c=c||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){c(a.data)}})}},loadColladaWorker:function(b,m,h,n){var r;try{r=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(q){throw Error("Can't find collada.js");
}var s=[],u=[];r.onmessage=function(m){function r(a,c){for(var b in a)c[b]=a[b]}function q(a){if(a.motion){for(var c=a.motion.controllers,b=[],d=0,e=c.length;d<e;++d){var f=c[d];if(f){for(var m=[],h=0,n=f.length;h<n;++h){var t=f[h];if(t){var s=t.keys[0];1<t.keys.length&&(s.prev=null,s.next=t.keys[1],s=t.keys[1]);for(var v=1,u=t.keys.length-1;v<u;++v)s.prev=t.keys[v-1],s.next=t.keys[v+1],s=t.keys[v+1];1<t.keys.length&&(s=t.keys[t.keys.length-1],s.prev=t.keys[t.keys.length-2],s.next=null);t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;s=new o;r(t,s);m[h]=s}else f[h]=null}b[d]=m}else c[d]=null}a.motion.controllers=b;c=new g;r(a.motion,c);a.motion=c}}function v(c){var d=new e;r(c,d);if(null!==c.obj){var g=u[c.obj.id];if(g===f)if(g=new a,r(c.obj,g),d.obj=g,u[c.obj.id]=g,n){if(0<g.points.length){n.addMesh(b,b+":"+g.id,g);for(var m=0,h=g.faces.length;m<h;++m){var o=g.faces[m],t=o.material;o.material=s[t]!==f?s[t]:0}}}else d.obj.triangulateQuads(),d.obj.calcNormals(),d.obj.compile(),
d.obj.clean();else d.obj=g}d.trans=new Transform;if(c.children&&0<c.children.length&&(d.children=[],c.children)){g=0;for(m=c.children.length;g<m;++g)h=v(c.children[g]),d.bindChild(h)}return d}var D;D=m.data.message;if("materials"==D){var w=JSON.parse(m.data.data),m=0;for(D=w.length;m<D;++m){var C=new d(w[m].name),y=C.material_id;r(w[m],C);C.material_id=y;s[w[m].material_id]=y;for(var y=0,M=w[m].textures.length;y<M;++y){var K=w[m].textures[y];if(K){var N=Texture_ref[K.img_path];N===f?(K=new c(K.img_path,
K.filter_type,n,b),C.textures[y]=K):C.textures[y]=Textures_obj[N]}else C.textures[y]=0}}}else if("scene"==D){w=JSON.parse(m.data.data);m=0;for(D=w.sceneObjects.length;m<D;++m)C=w.sceneObjects[m],null!==C.obj&&nop(),C.reassembled===f&&(q(C),C.reassembled=!0),w.sceneObjects[m]=v(C);C=new Scene;m=C.camera;D=m.transform;r(w.camera,m);r(w.camera.transform,D);q(m);C.camera=m;C.camera.transform=D;C.camera.frustum=new Frustum;m=0;for(D=w.sceneObjects.length;m<D;++m){y=w.sceneObjects[m];C.bindSceneObject(y);
try{y.getAABB()}catch(S){}}m=0;for(D=w.lights.length;m<D;++m)y=new Light,r(w.lights[m],y),y.trans=new Transform,q(y),C.bindLight(y);h(C)}else console.log("message from collada worker:",m.data.message)};r.onerror=function(a){console.log("error from collada worker:",a.message)};r.postMessage({message:"start",params:{meshUrl:b,prefix:m,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:w,prepareMesh:s,file:q,sceneFile:n};self.addEventListener("message",function(c){if("init"===
c.data.message){var b=c.data.data.type;if(b in a)new a[b](c.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(h){function y(a){var c=[],b=a.length;if(3>b)return null;var d=[],f;f=a.length;for(var h=0,n=f-1,q=0;q<f;n=q++)h+=a[n][0]*a[q][1]-a[q][0]*a[n][1];if(0<0.5*h)for(f=0;f<b;f++)d[f]=f;else for(f=0;f<b;f++)d[f]=b-1-f;q=2*b;h=0;for(f=b-1;2<b;){if(0>=q--)return null;var s=f;b<=s&&(s=0);f=s+1;b<=f&&(f=0);n=f+1;b<=n&&(n=0);var w;a:{w=a;var y=s,u=f,x=n,E=b,z=d,F=void 0,H=void 0,G=void 0,J=void 0,L=void 0,M=void 0,K=void 0,N=void 0,S=void 0,H=w[z[y]][0],G=w[z[y]][1],
J=w[z[u]][0],L=w[z[u]][1],M=w[z[x]][0],K=w[z[x]][1];if(e>(J-H)*(K-G)-(L-G)*(M-H))w=!1;else{for(F=0;F<E;F++)if(!(F==y||F==u||F==x)){var N=w[z[F]][0],S=w[z[F]][1],ca=void 0,V=void 0,na=void 0,Q=void 0,O=void 0,Ma=void 0,gb=void 0,hb=void 0,Na=void 0,qb=void 0,Oa=void 0,ib=void 0,ca=na=O=void 0,ca=M-J,V=K-L,na=H-M,Q=G-K,O=J-H,Ma=L-G,gb=N-H,hb=S-G,Na=N-J,qb=S-L,Oa=N-M,ib=S-K,ca=ca*qb-V*Na,O=O*hb-Ma*gb,na=na*ib-Q*Oa;if(0<=ca&&0<=na&&0<=O){w=!1;break a}}w=!0}}if(w){q=d[s];s=d[f];n=d[n];c.push(q);c.push(s);
c.push(n);h++;n=f;for(q=f+1;q<b;n++,q++)d[n]=d[q];b--;q=2*b}}return c}function w(a,c,b){b===d&&(b=0);var f;f=y(c);var e=CubicVR.util.repackArray(f,3,f.length/3),h=[],n=a.points.length;f=0;for(iMax=c.length;f<iMax;f++)h.push([c[f][0],c[f][1],b]);a.addPoint(h);f=0;for(iMax=e.length;f<iMax;f++)a.addFace([e[f][0]+n,e[f][1]+n,e[f][2]+n])}function q(a,c){var b=c[0]-a[0],d=c[1]-a[1];return Math.sqrt(b*b+d*d)}function n(a,c){var b,d,f=[],e=a.length,h=c.length,n=[];for(b=0;b<e;b++)for(d=0;d<h;d++){var s=q(a[b],
c[d]);f.push([s,b,d])}f.sort(function(a,c){return a[0]>c[0]});for(b=0;5>b;b++)for(d=0;d<f.length;d++)b!=d&&f[b][1]!=f[d][1]&&f[b][2]!=f[d][2]&&f[b][1]<f[d][1]&&f[b][2]<f[d][2]&&4>Math.abs(f[b][1]-f[d][1])&&4>Math.abs(f[b][2]-f[d][2])&&n.push([b,d]);n.sort(function(a,c){return f[a[0]][0]+f[a[1]][0]>f[c[0]][0]+f[c[1]][0]});10<n.length&&(n.length=10);d=[];for(b=0;b<n.length;b++)d.push([f[n[b][0]],f[n[b][1]]]);return d}function s(a,c){var b=n(a,c),d;if(!b.length)return null;d=b[0][0];var f=b[0][1],b=
f[1]-d[1],f=f[2]-d[2],e=a.slice(d[1]),e=e.concat(a.slice(0,d[1])),h=c.slice(d[2]),h=h.concat(c.slice(0,d[2])),q=[];for(d=b;d<e.length;d++)q.push(e[d]);q.push(e[0]);for(d=f;d<h.length;d++)q.push(h[d]);q.push(h[0]);var s=[];for(d=0;d<=b;d++)s.push(e[d]);for(d=0;d<=f;d++)s.push(h[d]);return[q,s]}function b(a){for(var c=[0,0],b=0;b<a.length;b++)c[0]+=a[b][0],c[1]+=a[b][1];c[0]/=a.length;c[1]/=a.length;return c}function f(a,c,b){for(var d=[],f=0;f<a.length;f++){var e=[a[f][0]-c[0],a[f][1]-c[1]],h=Math.sqrt(e[0]*
e[0]+e[1]*e[1])+b,e=Math.atan2(e[1],e[0]);d[f]=[c[0]+Math.cos(e)*h,c[1]+Math.sin(e)*h]}return d}function a(a,c,b,d,f){var e,h=a.points.length;if(c.length!=b.length)return null;var n=c.length;for(e=0;e<n;e++)a.addPoint([c[e][0],c[e][1],d]);for(e=0;e<n;e++)a.addPoint([b[e][0],b[e][1],f]);for(e=0;e<n-1;e++)a.addFace([h+e,h+e+1,h+(e+n+1),h+(e+n)]);e=n-1;a.addFace([h+e,h,h+n,h+(e+n)])}function c(a){this.points=a;this.cuts=[];this.result=[]}var d=h.undef,e=1.0E-10;c.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var c;a||(a=new CubicVR.Mesh);this.result=[this.points];for(c=0;c<this.cuts.length;c++){var b=this.cuts[c].points.slice(0),b=b.reverse(),b=s(this.result[0],b);this.result[0]=b[0];this.result.push(b[1])}for(c=0;c<this.result.length;c++)w(a,this.result[c]);a.removeDoubles();return a}},toExtrudedMesh:function(c,b,f){if(0!==this.points.length){var e,h;b===d&&(b=0);f===d&&(f=0);var n=b!=f;c||(c=new CubicVR.Mesh);this.result=[this.points];for(h=0;h<this.cuts.length;h++)e=
this.cuts[h].points.slice(0),e=e.reverse(),e=s(this.result[0],e),this.result[0]=e[0],this.result.push(e[1]);e=new CubicVR.Mesh;for(h=0;h<this.result.length;h++)w(e,this.result[h],f);c.booleanAdd(e);e.flipFaces();if(n)for(h=0;h<e.points.length;h++)e.points[h][2]=b;c.booleanAdd(e);if(n){a(c,this.points,this.points,b,f);for(h=0;h<this.cuts.length;h++)e=this.cuts[h].points.slice(0),e=e.reverse(),a(c,e,e,b,f)}c.removeDoubles();return c}},toExtrudedBeveledMesh:function(c,d,e,h,n,q,t){var A=[],D=[],y,I,
u,x;if(0!==this.points.length){"object"===typeof d&&(t=d,d=t.front||0,e=t.back||0,h=t.frontDepth||0,n=t.frontShift||0,q=t.backDepth||0,t=t.backShift||0);var E=d!==e,z=0!==q,F=0!==h;c||(c=new CubicVR.Mesh);F?(I=b(this.points),I=f(this.points,I,-n),this.result=[I.slice(0)]):this.result=[this.points.slice(0)];for(x=0;x<this.cuts.length;x++)u=b(this.cuts[x].points),u=f(this.cuts[x].points,u,n),u=u.reverse(),A.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);n=new CubicVR.Mesh;
for(x=0;x<this.result.length;x++)w(n,this.result[x],d-h);n.flipFaces();c.booleanAdd(n);if(z||F){y=b(this.points);y=f(this.points,y,-t);this.result=[y.slice(0)];for(x=0;x<this.cuts.length;x++)u=b(this.cuts[x].points),u=f(this.cuts[x].points,u,t),u=u.reverse(),D.push(u),u=s(this.result[0],u),this.result[0]=u[0],this.result.push(u[1]);n=new CubicVR.Mesh;for(x=0;x<this.result.length;x++)w(n,this.result[x],e+q)}else{for(x=0;x<n.points.length;x++)n.points[x][2]=e;n.flipFaces()}c.booleanAdd(n);F&&a(c,I,
this.points,d-h,d);E&&a(c,this.points,this.points,d,e);z&&a(c,this.points,y,e,e+q);for(x=0;x<A.length;x++)u=this.cuts[x].points.slice(0).reverse(),F&&a(c,A[x],u,d-h,d),E&&a(c,u,u,d,e),z&&a(c,u,D[x],e,e+q);c.removeDoubles();return c}}};return{polygon:{triangulate2D:y,toMesh:w,findNearPair:function(a,c){for(var b=[0,0],d=q(a[0],c[0]),e=a.length,f=c.length,h=0;h<e;h++)for(var n=0;n<f;n++){var s=q(a[h],c[n]);s<d&&(b[0]=h,b[1]=n,d=s)}return b},subtract:s,addOffset:function(a,c){for(var b=[],d=0,e=a.length;d<
e;d++){var f=a[d];b.push([f[0]+c[0],f[1]+c[1]])}return b}},Polygon:c}});
CubicVR.RegisterModule("ScenePhysics",function(h){function y(a,c){c.setX(a[0]);c.setY(a[1]);c.setZ(a[2])}function w(a,c){c.setX(a.x);c.setY(a.y);c.setZ(a.z);c.setW(a.w)}function q(a,c){c.x=a.x();c.y=a.y();c.z=a.z();c.w=a.w()}function n(a){return new Ammo.btVector3(a[0],a[1],a[2])}function s(a){var c=new Ammo.btQuaternion;c.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return c}function b(a){return[a.x(),a.y(),a.z()]}function f(a){this.setManifold(a)}var a=h.undef,c=h.enums;
c.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var d,e,g,o,m,r=function(a,c,b){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,c=d.properties,b=d.collision);d=h.get(d)||{};this.properties=new h.RigidProperties(c?h.get(c):{collision:b});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(n(this.init_position));this.transform.setRotation(s(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};r.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===c.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),y(this.linearVelocity,o),this.body.setLinearVelocity(o),y(this.angularVelocity,o),this.body.setAngularVelocity(o),h.vec3.equal([0,0,0],this.impulse)||(y(this.impulse,o),y(this.impulsePosition,m),this.body.applyImpulse(o,m)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(d),a=d.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=d.getRotation(),e.x=a.x(),e.y=a.y(),e.z=a.z(),e.w=a.w(),e.x!=e.x?console.log("rotation is NaN"):(a=e.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();y(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;e.fromEuler(a[0],a[1],a[2]);a=[e.x,e.y,e.z,e.w];g.setX(a[0]);g.setY(a[1]);g.setZ(a[2]);g.setW(a[3]);this.body.getWorldTransform().setRotation(g);this.activate()}},resetMotion:function(){y(this.init_linearVelocity,
o);this.body.setLinearVelocity(o);y(this.init_angularVelocity,o);this.body.setAngularVelocity(o);h.vec3.equal([0,0,0],this.init_impulse)||(y(this.init_impulse,o),y(this.init_impulsePosition,m),this.body.applyImpulse(o,m))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var b=a.getShapes(),e,f,g,m,o,q,r,v=[],w=null;f=0;for(g=b.length;f<g;f++){e=b[f];w=null;if(e.type===c.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(e.size[0]/
2,e.size[1]/2,e.size[2]/2));else if(e.type===c.collision.shape.SPHERE)w=new Ammo.btSphereShape(e.radius);else if(e.type===c.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(e.radius,e.height);else if(e.type===c.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===c.collision.shape.CONE)w=new Ammo.btConeShape(e.radius,e.height);else if(e.type===c.collision.shape.MESH){r=e.mesh;w=new Ammo.btTriangleMesh;q=e.size;var B=new Ammo.btVector3(0,
0,0),J=new Ammo.btVector3(0,0,0),L=new Ammo.btVector3(0,0,0),M=r.getMaterials();m=0;for(o=r.faces.length;m<o;m++){var K=r.faces[m];M[K.material].collision&&3===K.points.length&&(B.setValue(r.points[K.points[0]][0]*q[0],r.points[K.points[0]][1]*q[1],r.points[K.points[0]][2]*q[2]),J.setValue(r.points[K.points[1]][0]*q[0],r.points[K.points[1]][1]*q[1],r.points[K.points[1]][2]*q[2]),L.setValue(r.points[K.points[2]][0]*q[0],r.points[K.points[2]][1]*q[1],r.points[K.points[2]][2]*q[2]),w.addTriangle(B,J,
L))}0===this.getMass()||this.getType()==c.physics.body.STATIC||this.getType()==c.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(e.type===c.collision.shape.CONVEX_HULL){r=e.mesh;q=e.size;B=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;m=0;for(o=r.points.length;m<o;m++)y([r.points[m][0]*q[0],r.points[m][1]*q[1],r.points[m][2]*q[2]],B),w.addPoint(B)}else if(e.type===c.collision.shape.HEIGHTFIELD){var J=B=r=q=0,
N,S;e.landscape&&!e.getHeightField&&e.landscape instanceof h.HeightField?e.heightfield=e.landscape:e.landscape&&e.landscape instanceof h.Landscape&&(q=e.landscape.getHeightField().getDivX(),B=e.landscape.getHeightField().getDivZ(),r=e.landscape.getHeightField().getSizeX(),J=e.landscape.getHeightField().getSizeZ(),N=e.landscape.getMesh().points,S=e.landscape.getHeightField());e.heightfield&&e.heightfield instanceof h.HeightField&&(q=e.heightfield.getDivX(),B=e.heightfield.getDivZ(),r=e.heightfield.getSizeX(),
J=e.heightfield.getSizeZ(),N=e.getMesh().points,S=e.heightfield);w=Ammo.allocate(4*N.length,"float",Ammo.ALLOC_NORMAL);m=0;for(o=q*B;m<o;m++)Ammo.setValue(w+(m<<2),N[m][1],"float");w=new Ammo.btHeightfieldTerrainShape(q,B,w,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);m=new Ammo.btVector3(r/q,1,J/B);w.setLocalScaling(m);d=new Ammo.btTransform;btMetaShape=new Ammo.btCompoundShape(!1);d.setIdentity();d.setOrigin(n([-S.getCellSize()/2,0,-S.getCellSize()/2]));btMetaShape.addChildShape(d,w);w=btMetaShape}w&&
(0!==e.margin&&w.setMargin(e.margin),v.push({cShape:e,btShape:w}))}b=null;if(1===v.length)b=v[0].btShape;else if(1<v.length){d=new Ammo.btTransform;b=new Ammo.btCompoundShape(!1);f=0;for(g=v.length;f<g;f++)d.setIdentity(),d.setOrigin(n(v[f].cShape.position)),d.setRotation(s(v[f].cShape.rotation)),b.addChildShape(d,v[f].btShape)}a.setResult(b);a=b}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(y(a,o),this.body.setAngularVelocity(o))},setGravity:function(a){this.gravity=
a;this.body&&(y(a,o),this.body.setGravity(o))},getGravity:function(){return this.gravity&&!this.body?this.gravity:b(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=a;this.body&&(y(a,o),this.body.setLinearVelocity(o))},applyImpulse:function(a,c){this.impulse=a||[0,0,0];this.impulsePosition=c||[0,0,0];this.body&&!h.vec3.equal([0,0,0],a)&&(y(this.impulse,o),y(this.impulsePosition,m),this.body.applyImpulse(o,m))},applyForce:function(a,c){this.body&&!h.vec3.equal([0,0,0],a)&&
(y(a,o),y(c,m),this.body.applyImpulse(o,m))},getAngularVelocity:function(){return b(this.body.getAngularVelocity())},getLinearVelocity:function(){return b(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(c.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(c){this.body&&c!==a&&(c.length||(c=[c,c,c]),y(c,o),this.body.setAngularFactor(o))},isActive:function(){return this.body?
this.body.isActive():!1},isStatic:function(){return this.properties.type==c.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=a=h.parseEnum(c.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)y(a,o),this.body&&this.body.getCenterOfMassTransform().setOrigin(o),this.ghost&&this.ghost.getWorldTransform().setOrigin(o)},
getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(g);this.ghost&&this.ghost.getWorldTransform().getRotation(g);var a=new h.Quaternion;q(g,a);return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)w(a,g),this.body&&this.body.getCenterOfMassTransform().setRotation(g),this.ghost&&this.ghost.getWorldTransform().setRotation(g)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;
var a=new h.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(g);this.ghost&&this.ghost.getWorldTransform().getRotation(g);q(g,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=a;g.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(g);this.ghost&&this.body.getWorldTransform().setRotation(g)}};var B=function(b){b=b||{};this.ctype=h.parseEnum(c.physics.constraint,
b.ctype)||c.physics.constraint.P2P;this.strength=b.strength||0.1;this.maxImpulse=b.maxImpulse||0;this.rigidBodyA=b.rigidBodyA||b.rigidBody||null;this.rigidBodyB=b.rigidBodyB||null;this.positionA=b.positionA||[0,0,0];this.positionB=b.positionB||b.position||[0,0,0];this.damping=b.damping!=a?b.damping:1;this.btConstraint=null;this.localPivotA=n(this.positionA);this.localPivotB=n(this.positionB)};B.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===c.physics.constraint.P2P&&
(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=
null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&
(y(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};f.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),friction:a.get_m_combinedFriction(),positionA:b(a.getPositionWorldOnA()),positionB:b(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var v=function(){this.rigidObjects=
[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,
-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!d||!e)o=new Ammo.btVector3,m=new Ammo.btVector3,d=new Ammo.btTransform,e=new h.Quaternion,g=new Ammo.btQuaternion};v.prototype={addConstraint:function(a){var c=a.getConstraint();return c?(this.dynamicsWorld.addConstraint(c),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){y(a,
o);this.dynamicsWorld.setGravity(o)},bindSceneObject:function(a,c){var b=new h.RigidBody(a,c);this.rigidObjects.push(b);b.getBody();b.activate();this.dynamicsWorld.addRigidBody(b.getBody());b.updateSceneObject(!0);return b},bind:function(a){a instanceof h.Vehicle?a.initBody(this):a instanceof h.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof h.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;
this.ghostObjects.push(a);var b=a.getBody();a.properties.blocker||b.setCollisionFlags(b.getCollisionFlags()+c.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(b)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);b=a.getBody();a.activate();this.dynamicsWorld.addRigidBody(b);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(c.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(c.event.COLLIDE)&&
this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===c.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var b,d;if((b=a.getSceneObject())&&(d=b.getEventHandler()))d.hasEvent(c.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&
this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(c.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,c){this.dynamicsWorld.stepSimulation(a,c||2);for(var b=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&b++;this.active_count=b},triggerEvents:function(){var a,b,d,e,g=this.dynamicsWorld;if(this.contactObjects.length){var h=
g.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=g.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||null;if(n&&(e=n.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new f(m);else if(o&&o.isStatic()&&(e=o.getSceneObject())&&(b=e.getEventHandler())&&
b.hasEvent(c.event.CONTACT))d=b.triggerEvent(c.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new f(m)}}g=this.collisionObjects.length;for(a=0;a<g;a++)if(n=this.collisionObjects[a],(e=n.getSceneObject())&&(b=e.getEventHandler())&&b.hasEvent(c.event.COLLIDE))if(d=b.getProperties(c.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){h=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,
q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[a].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&(d=b.triggerEvent(c.event.COLLIDE)))d.collisions=h}g=this.ghostObjects.length;for(a=0;a<g;a++)if(d=this.ghostObjects[a],e=d.getSceneObject())if((b=e.getEventHandler())&&b.hasEvent(c.event.CONTACT_GHOST))if(e=
d.getBody(),h=e.getNumOverlappingObjects()){d=b.triggerEvent(c.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=h);for(b=0;b<h;b++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(b)),d.contacts[b]=m._cvr_rigidbody||null}},reset:function(){for(var a=0,c=this.rigidObjects.length;a<c;a++)this.rigidObjects[a].reset()},getRayHit:function(a,c,d,e){var f,a=n(a);f=n(c);d=d||!1;e=e||!1;c=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,
c);if(c.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(c.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=c.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(f=d._cvr_rigidbody)return Ammo.destroy(c),{position:b(e),localPosition:b(a),rigidBody:f,ammoBody:d};Ammo.destroy(c);return{position:b(e),localPosition:b(a),rigidBody:null,ammoBody:d}}Ammo.destroy(c)}};return{ScenePhysics:v,Constraint:B,RigidProperties:function(b){this.type=
h.parseEnum(c.physics.body,b.type);this.mass=b.mass!==a?b.mass:this.type?1:0;this.size=b.size||[1,1,1];this.restitution=b.restitution||(this.type?0:1);this.friction=b.friction||1;if((this.collision=b.collision)&&!this.collision.getShapes)this.collision=new h.CollisionMap(this.collision);this.blocker=b.blocker||!1},RigidBody:r,vec3bt_copy:y,btvec3_copy:function(a,c){c[0]=a.x();c[1]=a.y();c[2]=a.z()},quatbt_copy:w,btquat_copy:q}});
CubicVR.RegisterModule("CollisionMap",function(h){var y=h.enums;y.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var w=function(h){this.shapes=[];this.result=null;if(h){h&&!h.length&&(h=[h]);for(var n=0,s=h.length;n<s;n++)this.addShape(h[n])}};w.prototype={addShape:function(q){q.type=h.parseEnum(y.collision.shape,q.type);q.position=q.position||[0,0,0];q.rotation=q.rotation||[0,0,0];q.size=q.size||[1,1,1];q.radius=q.radius||1;q.height=q.height||1;
q.margin=q.margin||0;q.mesh=q.mesh||null;this.shapes.push(q)},getShapes:function(){return this.shapes},setResult:function(h){this.result=h},getResult:function(){return this.result}};return{CollisionMap:w}});
CubicVR.RegisterModule("RigidVehicle",function(h){var y=h.undef,w=h.enums,q,n,s=function(b){var b=h.get(b)||{},a=b.mesh,c=b.collision;this.maxEngineForce=b.maxEngineForce||2E3;this.maxBreakingForce=b.maxBreakingForce||125;this.steeringClamp=b.steeringClamp||0.51;this.mass=b.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new h.CollisionMap(c);this.sceneObject=new h.SceneObject(this.bodyMesh);if(!q||!n)new Ammo.btVector3,new Ammo.btVector3,q=new Ammo.btTransform,n=new h.Quaternion,new Ammo.btQuaternion;if(b.wheels!=y){a=0;for(c=b.wheels.length;a<c;a++){var d=b.wheels[a];d instanceof h.VehicleWheel?this.addWheel(d):this.addWheel(new h.VehicleWheel(d))}}};s.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(b){this.body=
new h.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});h.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);h.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(b.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(w.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,c=0;c<this.wheels.length;c++)h.vec3bt_copy(this.wheels[c].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[c].getSuspensionRest(),this.wheels[c].getWheelRadius(),this.m_tuning,this.wheels[c].getSteering());b.dynamicsWorld.addVehicle(this.m_vehicle);b.bind(this.body);this.updateSuspension()},evaluate:function(){for(var b=this.m_vehicle.getNumWheels(),
a=0;a<b;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var c=this.m_vehicle.getWheelTransformWS(a),d=c.getOrigin();this.wheels[a].wheelObj.position[0]=d.x();this.wheels[a].wheelObj.position[1]=d.y();this.wheels[a].wheelObj.position[2]=d.z();c=c.getRotation();n.x=
c.x();n.y=c.y();n.z=c.z();n.w=c.w();c=n.toEuler();this.wheels[a].wheelObj.rotation[0]=c[0];this.wheels[a].wheelObj.rotation[1]=c[1];this.wheels[a].wheelObj.rotation[2]=c[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(b){if(this.body&&(this.body.isActive()||b))return this.body.getBody().getMotionState().getWorldTransform(q),b=q.getOrigin(),b.x!=b.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
b.x(),this.sceneObject.position[1]=b.y(),this.sceneObject.position[2]=b.z()),b=q.getRotation(),n.x=b.x(),n.y=b.y(),n.z=b.z(),n.w=b.w(),n.x!=n.x?console.log("rotation is NaN"):(b=n.toEuler(),this.sceneObject.rotation[0]=b[0],this.sceneObject.rotation[1]=b[1],this.sceneObject.rotation[2]=b[2]),!0},setEngineForce:function(b){this.gEngineForce=b;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(b){this.setEngineForce(this.getEngineForce()+b)},decEngine:function(b){this.setEngineForce(this.getEngineForce()-b)},setSteering:function(b){this.gVehicleSteering=b},getSteering:function(){return this.gVehicleSteering},incSteering:function(b){this.gVehicleSteering+=b;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(b){this.gBreakingForce=b},getWheelGroundPosition:function(b){return this.wheels[b].wheelObj.getWorldPosition()-[0,wheels[b].getWheelRadius(),0]},getWheelSkid:function(b){return this.m_vehicle.getWheelInfo(b).get_m_skidInfo()},getRigidGround:function(b){this.m_vehicle.getWheelInfo(b)},addWheel:function(b,a){a===y&&(a=this.wheels.length);this.wheels[a]=b},getWheel:function(b){return this.wheels[b]},bindToScene:function(b){for(var a=this.wheels.length,c=0;c<a;c++)b.bind(this.getWheelObj(c));
b.bind(this.getSceneObject())},getWheelObj:function(b){return this.getWheel(b).wheelObj},updateSuspension:function(){var b,a=this.m_vehicle.getNumWheels();for(b=0;b<a;b++){var c=this.m_vehicle.getWheelInfo(b);c.set_m_suspensionStiffness(this.wheels[b].getSuspensionStiffness());c.set_m_suspensionRestLength1(this.wheels[b].getSuspensionRest());c.set_m_wheelsDampingRelaxation(this.wheels[b].getDampingRelaxation());c.set_m_wheelsDampingCompression(this.wheels[b].getDampingCompression());c.set_m_frictionSlip(this.wheels[b].getFrictionSlip());
c.set_m_rollInfluence(this.wheels[b].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(b=0;b<a;b++)this.m_vehicle.updateWheelTransform(b,!0)}},getMass:function(){return this.mass},setMass:function(b){this.mass=b;this.body&&this.body.setMass(this.mass)}};var b=function(b){b=h.get(b)||{};this.wheelRef=new h.SceneObject;this.wheelObj=new h.SceneObject;this.wheelRef.scale=b.scale||[1,1,1];this.wheelRadius=b.radius||0;this.wheelWidth=b.width||0;b.mesh!=y&&this.setModel(b.mesh);
this.suspensionStiffness=b.suspensionStiffness||40;this.suspensionRest=b.suspensionRest||0.05;this.dampingRelaxation=b.dampingRelaxation||2.3;this.dampingCompression=b.dampingCompression||2.4;this.frictionSlip=b.frictionSlip||0.94;this.rollInfluence=b.rollInfluence||0.5;this.wheelPosition=b.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=b.steering||!1;this.braking=b.braking||!1;this.driving=b.driving||!1};b.prototype={setModel:function(b,a,c){this.wheelModel=b;this.wheelRadius=a||0;this.wheelWidth=
c||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(b){this.suspensionStiffness=b},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(b){this.suspensionRest=
b},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(b){this.dampingRelaxation=b},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(b){this.dampingCompression=b},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(b){this.frictionSlip=b},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(b){this.rollInfluence=b},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(b){this.wheelRadius=b},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(b){this.wheelWidth=b},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(b){this.wheelRotation=b;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(b){this.wheelPosition=b;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(b){this.steering=
b},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(b){this.driving=b},isDriving:function(){return this.driving}};return{Vehicle:s,VehicleWheel:b}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
