try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(h,x,u,m,q){function r(a,f){if("object"!==typeof a)return o("enumerator validation failed, invalid type base object."),q;if(f===q)return q;if("number"===typeof f)return f;if("string"===typeof f){var e=parseInt(f,10);if(""!==f&&isFinite(e))return e;e=f.toUpperCase();e=a[e];if(e!==q)return e;o("enumerator validation failed, unknown enum value: "+f);var e="",b;for(b in a)a.hasOwnProperty(b)&&(""!==e&&(e+=", "),e+=b.toLowerCase());o("possible enum values are: "+e)}return q}var c="";try{for(var g=
x.querySelectorAll("script"),d=0,a=g.length;d<a;d++){var b=g[d].src.lastIndexOf("/CubicVR.js");-1<b&&(c=g[d].src.substr(0,b)+"/")}}catch(e){}var f=h.CubicVR={};f.contexts={};var o;try{o=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(n){o=m}var s={quality:{LOW:0,MEDIUM:1,HIGH:2}};h.cubicvr=s;var D={},w=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t=function(a){function e(a,f,b){var n=function(){};n.prototype=a.prototype;f.prototype=new n;for(var o in b)f.prototype[o]=
b[o];return f}var b=this,n;a&&(n=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return n}}));b.undef=q;b.nop=m;b.scriptLocation=c;b.GLCore=z;b.Textures=[];b.Textures_obj=[];b.Textures_ref=[];b.Images=[];b.ShaderPool=[];b.log=o;b.enums=f.enums;b.MAX_LIGHTS=6;b.extendClassGeneral=e;b.extendClass=function(a,f,b){return e(a,function(){a.apply(this);f.apply(this,arguments)},b)};b.features={};b.quality=f.enums.HIGH;var d={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},g={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},t={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};b.features=t;var z={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,
resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,e,n){var d,s=b.util,g=f.enums;if(e&&n){e=s.getScriptContents(e);n=s.getScriptContents(n)}else if(h.CubicVRShader.CubicVRCoreVS&&h.CubicVRShader.CubicVRCoreFS){e=h.CubicVRShader.CubicVRCoreVS;n=h.CubicVRShader.CubicVRCoreFS}else{e=s.getScriptContents(c+"CubicVR_Core.vs");n=s.getScriptContents(c+"CubicVR_Core.fs")}if(a===q){a=x.createElement("canvas");if(!d)try{d=a.getContext("experimental-webgl",{antialias:b.features.antiAlias})}catch(t){return null}z.gl=
d;if(z.fixed_size!==null){z.width=z.fixed_size[0];z.height=z.fixed_size[1];z.resizeElement(a,z.width,z.height)}else{z.addResizeable(a);if(z.canvasSizeFactor!==1&&a.getContext!==q){var s=u.round(h.innerWidth*z.canvasSizeFactor),w=u.round(h.innerHeight*z.canvasSizeFactor);z.resizeElement(a,s,w);a.style.top=h.innerHeight/2-w/2+"px";a.style.left=h.innerWidth/2-s/2+"px";a.style.position="absolute"}else z.resizeElement(a,h.innerWidth,h.innerHeight)}x.body.appendChild(a)}if(a.getContext!==q&&a.width!==q&&
a.height!==q){try{d||(d=a.getContext("experimental-webgl",{antialias:b.features.antiAlias}));d.viewport(0,0,a.width,a.height);z.canvas=a;z.width=a.width;z.height=a.height;d.clearColor(0,0,0,1);d.clearDepth(1);d.enable(d.DEPTH_TEST);d.depthFunc(d.LEQUAL)}catch(D){}if(!d)return null}else d=a;z.gl=d;z.CoreShader_vs=e;z.CoreShader_fs=n;d.enable(d.CULL_FACE);d.cullFace(d.BACK);d.frontFace(d.CCW);for(e=f.enums.light.type.NULL;e<g.light.type.MAX;e++)b.ShaderPool[e]=[];n=new b.Texture;a=new b.Material;for(e=
0;e<g.texture.map.MAX;e++)e!==g.texture.map.BUMP&&a.setTexture(n,e);a.opacity=0.5;for(e=1;;){if(!a.use(g.light.type.POINT,e)||e===8){b.MAX_LIGHTS=e;break}e++}a=z.emptyLight=new b.Light(g.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;o("Calibrated maximum lights per pass to: "+e);for(e=g.light.type.NULL;e<g.light.type.MAX;e++)b.ShaderPool[e]=[];if(z.resizeList.length){h.addEventListener("resize",function(){b.GLCore.onResize()},false);z.resize_active=true}return d},
addResizeable:function(a){b.GLCore.resizeList.push(a)},onResize:function(){var a=h.innerWidth,e=h.innerHeight;if(z.fixed_size!==null){a=b.GLCore.fixed_size[0];e=b.GLCore.fixed_size[1]}for(var f=0,n=b.GLCore.resizeList.length;f<n;f++)z.resizeElement(b.GLCore.resizeList[f],a,e)},setFixedAspect:function(a){b.GLCore.fixed_aspect=a},setFixedSize:function(a,e){b.GLCore.fixed_size=[a,e]},getCanvas:function(){return b.GLCore.canvas},resizeElement:function(a,e,f){var n=z.gl;if(z.fixed_aspect!==0){var o=e*
(1/b.GLCore.fixed_aspect);if(o>f){o=f;e=f*b.GLCore.fixed_aspect}f=o}if(a.getContext!==q){a.width=e;a.height=f;if(!b.GLCore.fixed_size){a.style.left=(h.innerWidth/2-e/2|0)+"px";a.style.top=(h.innerHeight/2-f/2|0)+"px";a.style.position="absolute"}n.viewport(0,0,e,f)}else a.resize(e,f)},setDepthAlpha:function(a,e,f){z.depth_alpha=a;z.depth_alpha_near=e;z.depth_alpha_far=f},setDefaultFilter:function(a){z.default_filter=r(b.enums.texture.filter,a)},setSoftShadows:function(a){z.soft_shadow=a},setFog:function(a){z.fog_enabled=
a},setFogExp:function(a,e){z.fog_enabled=true;z.fogLinear=false;z.fogExp=true;z.fogColor=a;z.fogDensity=e},setNoise:function(a){z.fogNoise=a},setFogLinear:function(a,e,f){z.fog_enabled=true;z.fogExp=false;z.fogLinear=true;z.fogColor=a;z.fogNear=e;z.fogFar=f},setCanvasSizeFactor:function(a){z.canvasSizeFactor=a},setQuality:function(a){a=r(s.quality,a);if(a===s.quality.HIGH)b.features=t;else if(a===s.quality.MEDIUM)b.features=g;else if(a===s.quality.LOW)b.features=d;b.quality=a;return b.features},getQuality:function(){return b.features}},
G=function(a,e,f){for(var n,o=x.getElementsByTagName("script"),d=0;d<o.length;++d){var s=o[d];if(s.getAttribute("data-cubicvr")){var c=s.getAttribute("src");if(c){var g=new XMLHttpRequest;g.open("GET",c,false);g.send(null);if(g.status===200||g.status===0)s.text=g.responseText}}}if(typeof a==="object")if(a.getContext)n=a;else{n=a.canvas;e=a.vertexShader||e;f=a.fragmentShader||f}else if(a){a[0]=="#"&&(a=a.substr(1));n=x.getElementById(a)}for(var t in D){var a=D[t](b),w;for(w in a)a.hasOwnProperty(w)&&
(b[w]=a[w])}z.init(n,e,f);return z.gl};b.GLCore=z;b.init=G;b.start=function(a,e,f,n,o){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=q);f=f||"Sorry, your browser does not appear to support WebGL :-(";if(a=G(a,n,o)){e&&typeof e==="function"&&e(a,b.getCanvas());return a}if(!a){f&&typeof f==="function"?f():alert(f);return false}};b.addResizeable=z.addResizeable;b.setFixedAspect=z.setFixedAspect;b.setFixedSize=z.setFixedSize;b.setCanvasSizeFactor=z.setCanvasSizeFactor;b.getCanvas=z.getCanvas;b.enums=
s;b.IdentityMatrix=w;b.Textures=b.Textures;b.Textures_obj=b.Textures_obj;b.Images=b.Images;b.globalAmbient=[0.1,0.1,0.1];b.setGlobalAmbient=function(a){b.globalAmbient=a};b.setGlobalDepthAlpha=z.setDepthAlpha;b.setDefaultFilter=z.setDefaultFilter;b.setSoftShadows=z.setSoftShadows;b.setQuality=z.setQuality;b.getQuality=z.getQuality;b.RegisterModule=f.RegisterModule;b.getScriptLocation=f.getScriptLocation;b.setFogExp=z.setFogExp;b.setFogLinear=z.setFogLinear;b.setFogNoise=z.setFogNoise;b.parseEnum=
r};f.init=function(a,e,b){var n;a&&(a.context&&"string"===typeof a.context)&&(n=a.context);n=new t(n);if(n.context)return f.contexts[n.context]=n,n.init(a,e,b),n;h.CubicVR=f=n;n.init(a,e,b);return n.GLCore.gl};f.start=function(a,e,b,n,o){var d=new t;h.CubicVR=f=d;d.start(a,e,b,n,o);return d};f.RegisterModule=function(a,e){D[a]=e};f.getScriptLocation=function(){return c};f.enums=s})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(h){function x(a){return this.clearStack(a)}function u(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}var m=h.undef,q=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=Math.PI/2,c=h.enums;c.aabb={DISJOINT:0,A_INSIDE_B:1,B_INSIDE_A:2,INTERSECT:3};var g={length:function(a,b){var e,f,o;b===m?(e=a[0],f=a[1],
o=a[2]):(e=b[0]-a[0],f=b[1]-a[1],o=b[2]-a[2]);return Math.sqrt(e*e+f*f+o*o)},normalize:function(a){var b=a[0],e=a[1],f=a[2];return(b=Math.sqrt(b*b+e*e+f*f))?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,
b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===m&&(e=1.0E-7);return a===m&&b===m?!0:a===m||b===m?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,f,o){var n=Math.atan2(f,e),b=Math.atan2(b[2]-a[2],b[0]-a[0]),e=Math.sqrt(e*e+f*f),n=b+n+r;return"object"===typeof o?[o[0]+e*Math.cos(n),o[1],o[2]+e*Math.sin(n)]:[a[0]+e*
Math.cos(n),a[1],a[2]+e*Math.sin(n)]},trackTarget:function(a,b,e,f){var b=g.subtract(b,a),o=g.length(b),n;n=g.normalize(b);n=g.multiply(n,e*(1/(1/(o-f))));o>f?a=g.add(a,n):o<f?(n=g.normalize(b),n=g.multiply(n,e*(1/(1/Math.abs(o-f)))),a=g.subtract(a,n)):a=[a[0],a[1]+n[2],a[2]];return a},getClosestTo:function(a,b,e){b=g.subtract(b,a);e=g.subtract(e,a);return g.add(g.multiply(b,g.dot(b,e)/g.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,f){var o=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(f[0]-e[0])+a[1]*
(f[1]-e[1])+a[2]*(f[2]-e[2]);if(0.001>Math.abs(b))return!1;a=-(o+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+a*(f[0]-e[0]),e[1]+a*(f[1]-e[1]),e[2]+a*(f[2]-e[2])]}},d={lookat:function(a,b,e,f,o,n,d,c,w){var t=[],B=[],m=[],B=[];t[0]=f-a;t[1]=o-b;t[2]=n-e;m[0]=d;m[1]=c;m[2]=w;t=g.normalize(t);B=g.cross(t,m);B=g.normalize(B);m=g.cross(B,t);B=[B[0],m[0],-t[0],0,B[1],m[1],-t[1],0,B[2],m[2],-t[2],0,0,0,0,1];f=new h.Transform(B);f.translate([-a,-b,-e]);return f.getResult()},multiply:function(a,b,e){e===
m&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+
a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===m&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*
a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===m&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,f){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(f+e)/(f-e),-1,0,0,-(2*f*e)/(f-e),0]},ortho:function(a,b,e,f,o,n){return[2/(b-a),0,0,0,0,2/(f-e),0,0,0,0,-2/(n-o),0,-(a+b)/(b-a),-(f+e)/(f-e),-(n+o)/(n-o),1]},determinant:function(a){return(a[0]*a[5]-a[1]*
a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],f=a[1],o=a[2],n=a[4],d=a[5],c=a[6],g=a[8],t=a[9],a=a[10],
m=a*d-c*t,q=-a*n+c*g,h=t*n-d*g,r=e*m+f*q+o*h;if(!r)return null;r=1/r;b[0]=m*r;b[1]=(-a*f+o*t)*r;b[2]=(c*f-o*d)*r;b[3]=q*r;b[4]=(a*e-o*g)*r;b[5]=(-c*e+o*n)*r;b[6]=h*r;b[7]=(-t*e+f*g)*r;b[8]=(d*e-f*n)*r;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],f=a[0]*a[6]-a[2]*a[4],o=a[0]*a[7]-a[3]*a[4],n=a[1]*a[6]-a[2]*a[5],d=a[1]*a[7]-a[3]*a[5],c=a[2]*a[7]-a[3]*a[6],g=a[8]*a[13]-a[9]*a[12],t=a[8]*a[14]-a[10]*a[12],B=a[8]*a[15]-a[11]*a[12],q=a[9]*a[14]-a[10]*a[13],h=a[9]*a[15]-a[11]*a[13],r=a[10]*
a[15]-a[11]*a[14],v=e*r-f*h+o*q+n*B-d*t+c*g;return 0!==v?(b===m&&(b=[]),b[0]=0+a[5]*r-a[6]*h+a[7]*q,b[4]=0-a[4]*r+a[6]*B-a[7]*t,b[8]=0+a[4]*h-a[5]*B+a[7]*g,b[12]=0-a[4]*q+a[5]*t-a[6]*g,b[1]=0-a[1]*r+a[2]*h-a[3]*q,b[5]=0+a[0]*r-a[2]*B+a[3]*t,b[9]=0-a[0]*h+a[1]*B-a[3]*g,b[13]=0+a[0]*q-a[1]*t+a[2]*g,b[2]=0+a[13]*c-a[14]*d+a[15]*n,b[6]=0-a[12]*c+a[14]*o-a[15]*f,b[10]=0+a[12]*d-a[13]*o+a[15]*e,b[14]=0-a[12]*n+a[13]*f-a[14]*e,b[3]=0-a[9]*c+a[10]*d-a[11]*n,b[7]=0+a[8]*c-a[10]*o+a[11]*f,b[11]=0-a[8]*d+a[9]*
o-a[11]*e,b[15]=0+a[8]*n-a[9]*f+a[10]*e,e=1/v,b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b):null},identity:function(a){if(a==m)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,f){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(f===m)return a;d.multiply(f.slice(0),a,f)},rotateAxis:function(a,
b,e,f,o){var n=Math.sin(a*(Math.PI/180)),a=Math.cos(a*(Math.PI/180)),b=[a+b*b*(1-a),b*e*(1-a)-f*n,b*f*(1-a)+e*n,0,e*b*(1-a)+f*n,a+e*e*(1-a),e*f*(1-a)-b*n,0,f*b*(1-a)-e*n,f*e*(1-a)+b*n,a+f*f*(1-a),0,0,0,0,1];if(o===m)return b;d.multiply(o.slice(0),b,o)},rotate:function(a,b,e,f){var o;f===m&&(f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==e&&(o=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),d.multiply(f.slice(0),[e,o,0,0,-o,e,0,0,0,0,1,0,0,0,0,1],f));0!==b&&(o=Math.sin(b*(Math.PI/180)),e=Math.cos(b*
(Math.PI/180)),d.multiply(f.slice(0),[e,0,-o,0,0,1,0,0,o,0,e,0,0,0,0,1],f));0!==a&&(o=Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),d.multiply(f.slice(0),[1,0,0,0,0,e,o,0,0,-o,e,0,0,0,0,1],f));return f},scale:function(a,b,e,f){if(f===m)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];d.multiply(f.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],f)},transform:function(a,b,e){var f=d.identity();a&&d.translate(a[0],a[1],a[2],f);b&&(0===b[0]&&0===b[1]&&0===b[2]||d.rotate(b[0],b[1],b[2],f));e&&(1===e[0]&&1===
e[1]&&1===e[2]||d.scale(e[0],e[1],e[2],f));return f}};x.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=h.mat4;if(!this.c_stack)return this.m_stack[0];var b=q;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var e=this.valid;e<
this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:q;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==m?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var f=h.mat4;if("object"===
typeof a)return this.translate(a[0],a[1],a[2]);var o=this.getIdentity();o[12]=a;o[13]=b;o[14]=e;this.m_stack[this.c_stack]=f.multiply(this.m_stack[this.c_stack],o);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var f=h.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var o=this.getIdentity();o[0]=a;o[5]=b;o[10]=e;this.m_stack[this.c_stack]=f.multiply(this.m_stack[this.c_stack],o);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},
rotate:function(a,b,e,f){var o=h.mat4;if("object"===typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var n,d;if(b||e||f)n=Math.sin(-a*(Math.PI/180)),d=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=d*b,a[9]=n*b,a[6]=-n*b,a[10]=d*b,this.m_stack[this.c_stack]=o.multiply(a,this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=d*e,b[8]=-n*e,b[2]=n*e,b[10]=d*e,this.m_stack[this.c_stack]=o.multiply(b,this.m_stack[this.c_stack]));f&&(e=this.getIdentity(),
e[0]=d*f,e[4]=n*f,e[1]=-n*f,e[5]=d*f,this.m_stack[this.c_stack]=o.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};u.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],e,f,o;1.0E-8<b?(e=2*Math.sqrt(b),b=(a[9]-a[6])/e,f=(a[2]-a[8])/e,o=(a[4]-a[1])/e,
a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=2*Math.sqrt(1+a[0]-a[5]-a[10]),b=0.25*e,f=(a[4]+a[1])/e,o=(a[2]+a[8])/e,a=(a[9]-a[6])/e):a[5]>a[10]?(e=2*Math.sqrt(1+a[5]-a[0]-a[10]),b=(a[4]+a[1])/e,f=0.25*e,o=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=2*Math.sqrt(1+a[10]-a[0]-a[5]),b=(a[2]+a[8])/e,f=(a[9]+a[6])/e,o=0.25*e,a=(a[4]-a[1])/e);this.x=b;this.y=f;this.z=o;this.w=a},fromEuler:function(a,b,e){var f=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),o=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),n=Math.cos(Math.PI/
180*a/2),a=Math.sin(Math.PI/180*a/2),d=f*o,c=b*e;this.w=d*n-c*a;this.x=d*a+c*n;this.y=b*o*n+f*e*a;this.z=f*e*n-b*o*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,e=this.y*this.y,f=this.z*this.z,o=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+f+a),n=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-f+a);return[o,n,a]},multiply:function(a,b){b===m&&(b=a,a=this);return new u(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*
b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,e){e===m&&(e=1.0E-8);return a===m&&b===m?!0:a===m||b===m?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e},onLine:function(a,b,e){var f=a[1]<b[1]?a[1]:b[1],o=a[0]>b[0]?a[0]:b[0],n=a[1]>b[1]?a[1]:b[1];return(a[0]<b[0]?a[0]:b[0])<=e[0]&&e[0]<=o&&f<=e[1]&&e[1]<=n?!0:!1},lineIntersect:function(a,b,e,f){var o=a[0],a=a[1],n=b[0],b=b[1],d=e[0],e=e[1],c=f[0],f=f[1],g=(o-n)*(e-f)-(a-
b)*(d-c);return 0===g?!1:[((d-c)*(o*b-a*n)-(o-n)*(d*f-e*c))/g,((e-f)*(o*b-a*n)-(a-b)*(d*f-e*c))/g]},add:function(a,b){return[a[0]+b[0],a[1]+b[1]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1]]},length:function(a,b){if(b===m)return Math.sqrt(a[0]*a[0]+a[1]*a[1]);var e=[a[0]-b[0],a[1]-b[1]];return Math.sqrt(e[0]*e[0]+e[1]*e[1])}},vec3:g,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],f=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=f},vec3_multiply:function(a,b,e){e===m&&(e=[]);e[0]=
b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:d,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){void 0===b&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-
a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]},intersects:function(a,b){return a[0][0]>b[1][0]||a[1][0]<b[0][0]||a[0][1]>b[1][1]||a[1][1]<b[0][1]||a[0][2]>b[1][2]||a[1][2]<b[0][2]?c.aabb.DISJOINT:a[0][0]>=b[0][0]&&a[1][0]<=b[1][0]&&a[0][1]>=b[0][1]&&a[1][1]<=b[1][1]&&a[0][2]>=b[0][2]&&a[1][2]<=b[1][2]?c.aabb.A_INSIDE_B:b[0][0]>=a[0][0]&&b[1][0]<=a[1][0]&&b[0][1]>=a[0][1]&&b[1][1]<=a[1][1]&&b[0][2]>=a[0][2]&&b[1][2]<=a[1][2]?c.aabb.B_INSIDE_A:
c.aabb.INTERSECT}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];return 0>e?-1:0<e?1:0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=h.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),f=a[3]+b[3];return e*e<f*f?!0:!1}},triangle:{normal:function(a,b,e,f){f===m&&(f=[]);var o=a[0]-b[0],n=a[1]-b[1],a=a[2]-b[2],d=b[0]-e[0],c=b[1]-e[1],
b=b[2]-e[2];f[0]=n*b-a*c;f[1]=a*d-o*b;f[2]=o*c-n*d;return f}},Transform:x,Quaternion:u}});
CubicVR.RegisterModule("Utility",function(h){var x=h.undef,u=h.log,m={},q={},r={multiSplit:function(c,g){for(var d=c.split(g[0]),a=1,b=g.length;a<b;a++)for(var e=g[a],f=0,o=d.length;f<o;f++){var n=d[f].trim().split(e),s=!0;if(1<n.length)for(var D=0;D<n.length;D++)""!==n[D].trim()&&(d.splice(f+D,0===D?1:0,n[D]),D&&o++,s=!1);else d[f]=d[f].trim().replace(e,""),""!==d[f]&&(s=!1);s&&(d.splice(f,1),o--,f--)}return d},getJSONScriptObj:function(c,g){if("string"===typeof c&&0<c.length&&"#"===c.charAt(0)){var d=
document.getElementById(c.substr(1));if(d)return d=JSON.parse(d.innerHTML||d.text),g&&g(d),d}return c},getScriptContents:function(c){var g=document.getElementById(c),d="",a="";if(g){if(""!==g.src||g.attributes.srcUrl!==x)a=""!==g.src?g.src:g.attributes.srcUrl.value}else a=c;if(0!==a.length){if(c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("application/json"),c.open("GET",a,!1),c.send(null),200===c.status||0===c.status)d=c.responseText}else for(a=g.firstChild;a;)3===a.nodeType&&(d+=a.textContent),
a=a.nextSibling;return d},xmlNeedsBadgerFish:function(c){for(c=[c];c.length;){var g=c.pop();if(g.attributes&&g.attributes.length)return!0;for(var d=0,a=g.childNodes.length;d<a;d++)c.push(g.childNodes[d])}return!1},getFirstEntry:function(c){for(var g in c)if(c.hasOwnProperty(g))return c[g]},getURIFileType:function(c){function g(a){for(var e in b)if(b.hasOwnProperty(e)&&-1!==b[e].indexOf(a))return e;return x}var d=c.toLowerCase(),a=["_ext","ext"],b={json:["js","javascript","json"],xml:["xml"]};if(-1!==
d.indexOf("?")){var e=d.split("?"),d=e[0];if(e[1])for(var e=-1===e[1].indexOf("&")?[e[1]]:e[1].split("&"),f=0,o=e.length;f<o;f++){var n=e[f];if(-1!==n.indexOf("=")&&(n=n.split("="),-1!==a.indexOf(n[0]))){var s=g(n[1]);if(s)return s;u("Unable to determine extension type '"+n[1]+"' provided for URI: ["+c+"], falling back to filename part.")}}}return-1!==d.indexOf(".")?(c=d.split("."),g(c[c.length-1])):x},get:function(c,g){var d=null,a=null,b=null,g=g||null;if(c===x)return x;if(isFinite(c))return c;
"function"===typeof c&&(c=c(g));if("object"===typeof c)return g&&!(c instanceof g)?new g(c):c;if("string"==typeof c){if(-1!==c.indexOf("\n"))return c;"#"==c[0]&&(d=c.substr(1),(b=document.getElementById(d))&&(a=b.src||null));!b&&(!d&&!a&&c)&&(a=c)}if(b&&!a)return CubicVR.util.collectTextNode(b);if(a){var d=null,e=q[a]||null;if(!e){var f=r.getURIFileType(a);if(f===x&&!b)return a;"json"===f?e=CubicVR.util.getJSON(a):d="xml"===f?CubicVR.util.getXML(a):CubicVR.util.getURL(a);d&&d.childNodes?e=r.getFirstEntry(r.xml2json(d)):
d&&(e=d)}e&&q[a]===x&&(q[a]=e);if(g){if(m[a]&&m[a]instanceof g)return m[a];if(e)return m[a]=new g(e),m[a]}else if(e)return e;return a}d&&!b&&console.log("Unable to retrieve requested ID: '"+c+"'");return x},clearCache:function(){m={};q={}},getURL:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.send(null);if(200===g.status||0===g.status){if(g.responseText.length)return g.responseText;if(g.responseXML)return g.responseXML}}catch(d){alert(c+" failed to load.")}return null},getXML:function(c){try{var g=
new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/xml");g.send(null);if(200===g.status||0===g.status)return g.responseXML}catch(d){try{alert(c+" failed to load.")}catch(a){throw d;}}return null},getJSON:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/json");g.send(null);if(200===g.status||0===g.status)return eval("("+g.responseText+")")}catch(d){try{alert(c+" failed to load.")}catch(a){throw d;}}return null},repackArray:function(c,g,
d){c.length!==parseInt(g,10)*parseInt(d,10)&&u("array repack error, data size !== stride*count: data.length="+c.length+" stride="+g+" count="+d);for(var d=[],a=0,b=0,e=c.length;b<e;b++){var f=b%g;0===f&&(d[a]=[]);d[a][f]=c[b];f===g-1&&a++}return d},collectTextNode:function(c){if(!c)return"";for(var g="",c=c.childNodes,d=0,a=c.length;d<a;d++)g+=c[d].nodeValue;return g},floatDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=c.split(g?g:","),a=0,b=d.length;a<
b;a++)d[a]=parseFloat(d[a]);d[d.length-1]!==d[d.length-1]&&d.pop();return d},intDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=c.split(g?g:","),a=0,b=d.length;a<b;a++)d[a]=parseInt(d[a],10);d[d.length-1]!==d[d.length-1]&&d.pop();return d},textDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var d=c.split(g?g:","),a=0,b=d.length;a<b;a++)d[a]=d[a];return d},xmlstring2json:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,d,a=[],b=[],e={},f=e,o=0,n=c.length;o<n;o++){var s=c[o];if(!(g.test(s)||""===s)&&!/<\?\s?xml[^>]*>/.test(s))if(/<.*?>/.test(s)){d=s.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==d[0]&&(s=d.split(" "),d=s[0],s=s.slice(1).join(" "),a.push(d),b.push(e),e[d]&&!(e[d]instanceof Array)?e[d]=[e[d]]:(e[d]||(e[d]={}),e=e[d]),e instanceof Array&&(e.push({}),e=e[e.length-1]),"/"===d.substr(d.length-1)||"/"===s.substr(s.length-1)))d="/"+d;if("/"===d[0]){d=
d.substr(1);if(a.length&&a[a.length-1]!==d)return console.log("Unmatched tag, aborting: "+d),!1;a.pop();e=b.length?b[b.length-1]:null;b.pop()}}else{var D=b[b.length-1][d];D instanceof Array?(D.pop(),D.push(r.parseNumeric(s))):b[b.length-1][d]=r.parseNumeric(s)}}return f},xmlstring2badgerfish:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,d,a=[],b=[],e={},f=e,o=0,n=c.length;o<n;o++)if(d=c[o],!(g.test(d)||""===d)&&!/<\?\s?xml[^>]*>/.test(d))if(/<.*?>/.test(d)){d=
d.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==d[0]){var s=d.split(" ");d=s[0];s=s.slice(1).join(" ");a.push(d);b.push(e);e[d]&&!(e[d]instanceof Array)?e[d]=[e[d]]:e[d]||(e[d]={});e=e[d];e instanceof Array&&(e.push({}),e=e[e.length-1]);if("/"===d.substr(d.length-1)||"/"===s.substr(s.length-1))d="/"+d;for(var s=r.multiSplit(s,"= "),D="",w=0;w<s.length;w++){var t=s[w];"/"===t[t.length-1]&&(t=t.substr(0,t.length-1));if(1===w%2){if("'"===t[0]||'"'===t[0]){for(var m=t[0],t=t.substr(1);t[t.length-1]!==m&&s.length+
1<w;)t+=s.splice(w+1,1);t[t.length-1]===m&&(t=t.substr(0,t.length-1))}e["@"+D]=t}else D=t}}if("/"===d[0]){d=d.substr(1);if(a.length&&a[a.length-1]!==d)return console.log("Unmatched tag, aborting: "+a[a.length-1]),!1;a.pop();e=b.length?b[b.length-1]:null;b.pop()}}else e.$=d;return f},xml2badgerfish:function(c){var g={},d=[],a,b,e,f,o,n=/^\s+|\s+$/g;c.jsonParent=g;for(d.push(c);d.length;){b=d.pop();var s=null;e=b.jsonParent;c=0;for(a=b.childNodes.length;c<a;c++)f=b.childNodes[c],o=f.tagName,o!==x&&
(s=s||{},s[o]=s[o]||0,s[o]++);if(b.attributes&&b.attributes.length){c=0;for(a=b.attributes.length;c<a;c++)f=b.attributes[c],e["@"+f.name]=f.value}c=0;for(a=b.childNodes.length;c<a;c++)f=b.childNodes[c],o=f.tagName,1===f.nodeType?(1<s[o]?(e[o]=e[o]||[],e[o].push({}),f.jsonParent=e[o][e[o].length-1]):(e[o]=e[o]||{},f.jsonParent=e[o]),d.push(f)):3===f.nodeType&&""!==f.nodeValue.replace(n,"")&&(e.$=e.$||"",e.$+=f.nodeValue)}return g},isTextNode:function(c){for(var c=c.childNodes,g=0,d=c.length;g<d;g++)if(3!==
c[g].nodeType||c[g].childNodes.length)return!1;return!0},parseNumeric:function(c){var g=null,d,g=c.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===g)return g;if((-1!==g.indexOf(" ")||-1!==g.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=g.split(" ");
c=0;for(d=g.length;c<d;c++)g[c]=r.floatDelimArray(g[c],",");return g}}else{g=g.split(" ");c=0;for(d=g.length;c<d;c++)g[c]=r.intDelimArray(g[c],",");return g}else return r.floatDelimArray(g,",");else return r.floatDelimArray(g," ");else return r.intDelimArray(g,",");else return r.intDelimArray(g," ");else return parseInt(g,10);d=parseFloat(g);return!isNaN(d)?/[^0-9\-\+]+/g.test(g)?d:parseInt(g,10):c},xml2json:function(c){var g={},d=[],a,b,e,f,o;c.jsonParent=g;for(d.push(c);d.length;){b=d.pop();var n=
null;e=b.jsonParent;c=0;for(a=b.childNodes.length;c<a;c++)f=b.childNodes[c],o=f.tagName,o!==x&&(n=n||{},n[o]=n[o]||0,n[o]++);c=0;for(a=b.childNodes.length;c<a;c++){f=b.childNodes[c];o=f.tagName;var s=r.isTextNode(f);1===f.nodeType&&(1<n[o]?(e[o]=e[o]||[],s?e[o].push(r.parseNumeric(r.collectTextNode(f))):(e[o].push({}),f.jsonParent=e[o][e[o].length-1])):s?e[o]=r.parseNumeric(r.collectTextNode(f)):(e[o]=e[o]||{},f.jsonParent=e[o]),s||d.push(f))}}return g}};return{util:r,get:r.get,clearCache:r.clearCache}});
"undefined"===typeof Iuppiter&&(Iuppiter={version:"3026 $".replace(" $","")});Iuppiter.toByteArray=function(h){var x=[],u,m;for(u=0;u<h.length;u++)m=h.charCodeAt(u),127>=m?x.push(m):(2047>=m?x.push(m>>6|192):(65535>=m?x.push(m>>12|224):(x.push(m>>18|240),x.push(m>>12&63|128)),x.push(m>>6&63|128)),x.push(m&63|128));return x};
Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:Array(256),IAS:Array(256),init:function(){var h;for(h=0;256>h;h++)Iuppiter.Base64.IA[h]=-1,Iuppiter.Base64.IAS[h]=-1;h=0;for(iS=Iuppiter.Base64.CA.length;h<iS;h++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(h)]=h,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(h)]=h;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(h,
x){var u,m,q,r,c,g,d,a,b;u=x?Iuppiter.Base64.CAS:Iuppiter.Base64.CA;q=h.constructor==Array?h:Iuppiter.toByteArray(h);r=q.length;c=3*(r/3);g=(r-1)/3+1<<2;m=Array(g);for(a=d=0;d<c;)b=(q[d++]&255)<<16|(q[d++]&255)<<8|q[d++]&255,m[a++]=u.charAt(b>>18&63),m[a++]=u.charAt(b>>12&63),m[a++]=u.charAt(b>>6&63),m[a++]=u.charAt(b&63);d=r-c;0<d&&(b=(q[c]&255)<<10|(2==d?(q[r-1]&255)<<2:0),m[g-4]=u.charAt(b>>12),m[g-3]=u.charAt(b>>6&63),m[g-2]=2==d?u.charAt(b&63):"=",m[g-1]="=");return m.join("")},decode:function(h,
x){var u,m,q,r,c,g,d,a,b,e,f,o;u=x?Iuppiter.Base64.IAS:Iuppiter.Base64.IA;h.constructor==Array?(q=h,c=!0):(q=Iuppiter.toByteArray(h),c=!1);r=q.length;g=0;for(d=r-1;g<d&&0>u[q[g]];)g++;for(;0<d&&0>u[q[d]];)d--;a="="==q[d]?"="==q[d-1]?2:1:0;m=d-g+1;b=76<r?("\r"==q[76]?m/78:0)<<1:0;r=(6*(m-b)>>3)-a;m=Array(r);f=e=0;for(eLen=3*(r/3);e<eLen;)o=u[q[g++]]<<18|u[q[g++]]<<12|u[q[g++]]<<6|u[q[g++]],m[e++]=o>>16&255,m[e++]=o>>8&255,m[e++]=o&255,0<b&&19==++f&&(g+=2,f=0);if(e<r){for(b=o=0;g<=d-a;b++)o|=u[q[g++]]<<
18-6*b;for(u=16;e<r;u-=8)m[e++]=o>>u&255}if(c)return m;for(o=0;o<m.length;o++)m[o]=String.fromCharCode(m[o]);return m.join("")}};Iuppiter.Base64.init();
(function(){Iuppiter.compress=function(h){var x=[],u,m=0,q=0,r,c,g=128,d,a,b=Array(256);for(u=0;256>u;u++)b[u]=3435973836;h=h.constructor==Array?h:Iuppiter.toByteArray(h);for(u=h.length;m<u;){if(256==(g<<=1)){if(q>=u-1-16){d=u;for(q=m=0;d;d--)x[q++]=h[m++];break}g=1;c=q;x[q++]=0}if(m>u-66)x[q++]=h[m++];else if(r=(h[m]+13^h[m+1]-13^h[m+2])&255,a=m-b[r]&1023,b[r]=m,r=m-a,0<=r&&r!=m&&h[m]==h[r]&&h[m+1]==h[r+1]&&h[m+2]==h[r+2]){x[c]|=g;for(d=3;66>d&&h[m+d]==h[r+d];d++);x[q++]=d-3<<2|a>>8;x[q++]=a;m+=
d}else x[q++]=h[m++]}return x};Iuppiter.decompress=function(h,x){var u,m=[],q,r=0,c=0,g,d,a=128,b;u=h.constructor==Array?h:Iuppiter.toByteArray(h);for(q=u.length;r<q;){if(256==(a<<=1))a=1,d=u[r++];if(d&a)if(b=(u[r]>>2)+3,g=(u[r]<<8|u[r+1])&1023,r+=2,0<=(g=c-g))for(;0<=--b;)m[c++]=m[g++];else break;else m[c++]=u[r++]}if(!("undefined"==typeof x?0:x)){for(u=0;u<c;u++)m[u]=String.fromCharCode(m[u]);m=m.join("")}return m}})();
CubicVR.RegisterModule("Shader",function(h){function x(e,f){var b=h.util,n,s,g,w,t=q.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==e.indexOf("\n")?(g=e,n=d(q.gl,e,"x-shader/x-vertex")):(n=a(q.gl,e),null===n&&(g=b.getURL(e),n=d(q.gl,g,"x-shader/x-vertex")));t.getShaderParameter(n,t.COMPILE_STATUS)||(this.vertexLog=t.getShaderInfoLog(n),this.success=!1);-1!==f.indexOf("\n")?(w=f,s=d(q.gl,f,"x-shader/x-fragment")):(s=a(q.gl,
f),null===s&&(w=b.getURL(f),s=d(q.gl,w,"x-shader/x-fragment")));t.getShaderParameter(s,t.COMPILE_STATUS)||(this.fragmentLog=t.getShaderInfoLog(s),this.success=!1);this.success?(this.shader=t.createProgram(),t.attachShader(this.shader,n),t.attachShader(this.shader,s),t.linkProgram(this.shader),q.gl.getProgramParameter(this.shader,t.LINK_STATUS)||(c("Error linking shader:\n"+t.getProgramInfoLog(this.shader)),this.success=!1)):(n=b.multiSplit(this.vertexLog,";\n"),b=b.multiSplit(this.fragmentLog,";\n"),
n.length&&this.dumpErrors(n,g),b.length&&this.dumpErrors(b,w))}function u(a){this._update=a.update||null;this._init=a.init||null;this._vertex=h.get(a.vertex)||null;this._fragment=h.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var m=h.undef,q=h.GLCore,r=h.enums,c=h.log,g=h.util;r.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var d=function(a,f,b){if("x-shader/x-fragment"===b)b=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===b)b=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(b,f);a.compileShader(b);return b},a=function(a,f){var b=document.getElementById(f);if(!b)return null;for(var n="",d=b.firstChild;d;)3===d.nodeType&&(n+=d.textContent),
d=d.nextSibling;if("x-shader/x-fragment"===b.type)b=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===b.type)b=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(b,n);a.compileShader(b);return b};x.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,f,b){for(var b=(b||"Error on line")+" ",f=f.split("\n"),n=0,d=a.length;n<d;n++){var c=a[n];if(0===c.indexOf("ERROR: ")){var c=c.substr(7).trim(),g=c.substr(0,c.indexOf(" ")),c=c.substr(g.length),g=g.split(":"),
g=parseInt(g[1],10);console.log(g+"> "+f[g-1]);console.log(b+g+", :"+c)}}},bindSelf:function(a){var f,b,n;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(f=a.split("["),n=f[0],f=f[1].split("]"),b=f[0],f=f[1].split("."),f=f[1],this[n]===m&&(this[n]=[]),this[n][b]===m&&(this[n][b]={}),this[n][b][f]=this.uniforms[a]):(f=a.split("."),n=f[0],f=f[1],this[n]===m&&(this[n]={}),this[n][f]=this.uniforms[a]):-1!==a.indexOf("[")?(f=a.split("["),n=f[0],f=f[1].split("]"),b=f[0],this[n]===m&&(this[n]=[]),this[n][b]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,f){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==m&&this.setMatrix(a,f);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,f){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
f!==m&&this.setVector(a,f);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,f){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==m&&this.setFloat(a,f);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=q.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,f){this.use();this.uniforms[a]=q.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);f!==m&&this.setInt(a,f);this.bindSelf(a);return this.uniforms[a]},use:function(){q.gl.useProgram(this.shader)},setMatrix:function(a,f){var b=this.uniforms[a];if(null!==b){var n=f.length;16===n?q.gl.uniformMatrix4fv(b,!1,f):9===n?q.gl.uniformMatrix3fv(b,!1,f):4===
n&&q.gl.uniformMatrix2fv(b,!1,f)}},setInt:function(a,f){var b=this.uniforms[a];null!==b&&q.gl.uniform1i(b,f)},setFloat:function(a,f){var b=this.uniforms[a];null!==b&&q.gl.uniform1f(b,f)},setVector:function(a,f){var b=this.uniforms[a];if(null!==b){var n=f.length;3==n?q.gl.uniform3fv(b,f):2==n?q.gl.uniform2fv(b,f):q.gl.uniform4fv(b,f)}},clearArray:function(a){var f=q.gl,a=this.uniforms[a];null!==a&&f.disableVertexAttribArray(a)},bindArray:function(a,f){var b=q.gl,n=this.uniforms[a];if(null!==n){var d=
this.uniform_type[a];d===r.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,f),b.vertexAttribPointer(n,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(n)):d===r.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,f),b.vertexAttribPointer(n,2,b.FLOAT,!1,0,0)):d===r.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,f),b.vertexAttribPointer(n,1,b.FLOAT,!1,0,0))}}};var b={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var f={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var b=a[i];0===b.indexOf("#define")&&(b=b.split(" "),2<b.length&&(f[b[1]]=b.slice(2).join(" ")))}return f},replaceAll:function(a,f,b,n){var b=b||"",n=n||"",d;for(d in f)if(f.hasOwnProperty(d))for(var c=b+d+n;-1!==a.indexOf(c);)a=a.replace(c,b+f[d]+n);return a},getShaderInfo:function(a,f){var d,n,
s,c,w,t,B=["uniform","attribute","varying"],q=[],h={};t={};var r;f===m&&(f="");a=b.tidyScript(a);f=b.tidyScript(f);h.v_define=b.getDefines(a);h.f_define=b.getDefines(f);a=b.replaceAll(a,h.v_define,"[","]");f=b.replaceAll(f,h.f_define,"[","]");r=g.multiSplit(a+"\n"+f,"\n;");var v=[];c=s=-1;d=0;for(n=r.length;d<n;d++)w=r[d],-1===s&&0===w.indexOf("struct")?s=d:-1===c&&(-1!==s&&-1!==w.indexOf("}"))&&(c=d+1),-1!==s&&-1!==c&&(w=r.slice(s,c).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),v.push({start:s,end:c,struct:w.split("\n")}),c=s=-1);d=0;for(n=v.length;d<n;d++){var y=v[d].struct,u=null;s=0;for(c=y.length;s<c;s++)w=y[s].split(" "),1>=w.length||("struct"==w[0]?(u=w[1],t[u]={}):u&&(t[u][w[1]]=w[0]))}h.struct=t;d=0;for(n=B.length;d<n;d++)h[B[d]]=[];d=0;for(n=r.length;d<n;d++){w=r[d];s=0;for(c=B.length;s<c;s++)if(v=B[s],0===w.indexOf(v)&&(t=w.split(" "),3===t.length&&t[0]==v&&-1===q.indexOf(t[2])))if(q.push(t[2]),-1!==t[2].indexOf("[")){var y=t[2].split("["),
u=y[1].replace("]",""),z=parseInt(u,10);z===z&&(u=z);h[v].push({name:y[0],type:t[1],isArray:!0,len:u})}else h[v].push({name:t[2],type:t[1]})}return h},genShaderVarList:function(a,f){var b=a[f],n=[],d,c,g,t,m,q;if(!b)return[];d=0;for(c=b.length;d<c;d++){var h=b[d];if(a.struct[h.type]){var r=a.struct[h.type];if(r&&h.isArray){g=0;for(t=h.len;g<t;g++)for(q in m=h.name+"["+g+"]",r)r.hasOwnProperty(q)&&n.push({location:m+"."+q,type:r[q],basename:h.name})}else for(q in r)n.push({location:h.name+"."+q,type:r[q],
basename:h.name})}else if(h.isArray){g=0;for(t=h.len;g<t;g++)m=h.name+"["+g+"]",n.push({location:m,type:h.type,basename:h.name})}else n.push({location:h.name,type:h.type,basename:h.name})}return n},getShaderVars:function(a){var f={};f.uniform=b.genShaderVarList(a,"uniform");f.attribute=b.genShaderVarList(a,"attribute");return f}};u.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,f,d,n,c){d=d||[];a=h.util.get(a);f=h.util.get(f);c=c||"#define customShader_splice";if(n=n===m?this._vertex||this._fragment:n)n=a.indexOf(c),c=f.indexOf(c),-1!==n&&this._vertex&&(a=a.substr(0,n)+this._vertex),-1!==c&&this._fragment&&(f=f.substr(0,c)+this._fragment);this._shader=new h.Shader(a,f);this._shaderInfo=b.getShaderInfo(a,f);this._shaderVars=b.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",d);this._appendShaderVars(this._shaderVars,"attribute",d);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,f,b){for(var a=function(a,f){return function(e,b){b!==m&&(t.activeTexture(t.TEXTURE0+e),t.bindTexture(q.gl.TEXTURE_2D,h.Textures[b.tex_id]));f.value=e;a.update(f)}},n=0,d=this._shaderVars[f].length;n<d;n++){var c=this._shaderVars[f][n],g=c.location;if(-1===b.indexOf(c.basename)&&(c=c.type,"vec3"===c?"attribute"===f?this._shader.addVertexArray(g):
this._shader.addVector(g):"vec2"===c?"attribute"===f?this._shader.addUVArray(g):this._shader.addVector(g):"float"===c?"attribute"===f?this._shader.addFloatArray(g):this._shader.addFloat(g):"sampler2D"===c||"int"===c?this._shader.addInt(g):("mat4"===c||"mat3"===c||"mat2"===c)&&this._shader.addMatrix(g),g=this._bindSelf(g),"sampler2D"==c&&g)){var t=q.gl;g.set=a(this,g)}}},_bindSelf:function(a){var f,b,n,d;if(null!==this._shader.uniforms[a]){var c=function(a,f){return function(b){f.value=b;a.update(f)}};
-1!==a.indexOf(".")?-1!==a.indexOf("[")?(f=a.split("["),n=f[0],f=f[1].split("]"),b=f[0],f=f[1].split("."),f=f[1],this[n]===m&&(this[n]=[]),this[n][b]===m&&(this[n][b]={}),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[n][b][f]=d):(f=a.split("."),n=f[0],f=f[1],this[n]===m&&(this[n]={}),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[n][f]=d):-1!==a.indexOf("[")?(f=a.split("["),n=f[0],f=f[1].split("]"),b=f[0],this[n]===
m&&(this[n]=[]),d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[n][b]=d):(d={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=d);this._bindings.push(d);d&&(d.set=c(this,d));return d}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var f=0,b=this._bindings.length;f<b;f++)this.update(this._bindings[f],a)},update:function(a){if(this._initialized){var f=q.gl,b=a.value,n=a.location;
null!==n&&(a.type===r.shader.uniform.MATRIX?(a=b.length,16===a?f.uniformMatrix4fv(n,!1,b):9===a?f.uniformMatrix3fv(n,!1,b):4===a&&f.uniformMatrix2fv(n,!1,b)):a.type===r.shader.uniform.INT?f.uniform1i(n,b):a.type===r.shader.uniform.VECTOR?(a=b.length,3===a?f.uniform3fv(n,b):2===a?f.uniform2fv(n,b):f.uniform4fv(n,b)):a.type===r.shader.uniform.FLOAT?f.uniform1f(n,b):a.type===r.shader.uniform.ARRAY_VERTEX?(f.bindBuffer(f.ARRAY_BUFFER,b),f.vertexAttribPointer(n,3,f.FLOAT,!1,0,0),f.enableVertexAttribArray(n)):
a.type===r.shader.uniform.ARRAY_UV?(f.bindBuffer(f.ARRAY_BUFFER,b),f.vertexAttribPointer(n,2,f.FLOAT,!1,0,0),f.enableVertexAttribArray(n)):a.type===r.shader.uniform.ARRAY_FLOAT&&(f.bindBuffer(f.ARRAY_BUFFER,b),f.vertexAttribPointer(n,1,f.FLOAT,!1,0,0),f.enableVertexAttribArray(n)))}}};return{Shader:x,shader_util:b,CustomShader:u}});
CubicVR.RegisterModule("MainLoop",function(h){function x(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function u(){null!==h.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(u),h.GLCore.mainloop.interval())}function m(d,a,b){window.requestAnimationFrame===r&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==h.GLCore.mainloop&&(!window.requestAnimationFrame&&h.GLCore.mainloop&&clearInterval(h.GLCore.mainloop.interval),h.GLCore.mainloop=null);if(null===d)h.GLCore.mainloop=null;else{this.renderList=[];var e=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],f=new x;f.start();this.timer=f;this.func=d;this.doclear=a!==r?a:!0;h.GLCore.mainloop=this;g.resizeList.length&&!h.GLCore.resize_active&&(window.addEventListener("resize",
function(){h.GLCore.onResize()},!1),h.GLCore.resize_active=!0);a=function(){return function(){var a=h.GLCore.gl;f.update();h.GLCore.mainloop.doclear&&a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);d(f,h.GLCore.gl);var b=e[e.length-1],c=b.scenes;b.update&&b.update(f,a);if(c){a=0;for(b=c.length;a<b;++a){var g=c[a];if(!g.paused){g.update&&g.update(f,h.GLCore.gl);g.render()}}}}}();b?this.loopFunc=a:window.requestAnimationFrame?(this.interval=a,window.requestAnimationFrame(u)):this.interval=setInterval(a,
20)}}function q(d,a,b){this.canvas=d;this.camera=a;this.mpos=[0,0];this.mdown=!1;var e=this;this.mEvents={};this.keyState=[];for(var f in c.keyboard)this.keyState[f]=!1;this.onMouseDown=function(){return function(a){e.mdown=!0;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseDown&&e.mEvents.mouseDown(e,e.mpos,e.keyState)}}();this.onMouseUp=function(){return function(a){e.mdown=!1;e.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];e.mEvents.mouseUp&&e.mEvents.mouseUp(e,
e.mpos,e.keyState)}}();this.onMouseMove=function(){return function(a){var f=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];f[0]=a[0]-e.mpos[0];f[1]=a[1]-e.mpos[1];e.mpos=a;e.mEvents.mouseMove&&e.mEvents.mouseMove(e,e.mpos,f,e.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;e.mEvents.mouseWheel&&e.mEvents.mouseWheel(e,e.mpos,a,e.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,f=null;e.mEvents.keyPress?
(f=e.mEvents.keyPress(e,e.mpos,a,e.keyState),e.keyState[a]=f!==r?!!f:!0):e.keyState[a]=!0;e.keyState[a]&&e.mEvents.keyDown&&(f=e.mEvents.keyDown(e,e.mpos,a,e.keyState),e.keyState[a]=f!==r?!!f:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;e.mEvents.keyUp&&e.mEvents.keyUp(e,e.mpos,a,e.keyState);e.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,f,b){a.mdown&&a.orbitView(b)},mouseWheel:function(a,f,b){a.zoomView(b)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
!1!==b&&this.setEvents(b===r?this.eventDefaults:b);this.bind()}var r=h.undef,c=h.enums,g=h.GLCore;c.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};x.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(d){this.lock_rate=1/d;this.lock_state=!0},unlock:function(){var d=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=d-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(d){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-d},setSeconds:function(d){this.setMilliseconds(1E3*d|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(d){this.paused_state=d},getPaused:function(){return this.paused_state}};m.prototype={setPaused:function(d){this.timer.setPaused(d)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(d){this.timer.setSeconds(d)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(d){this.renderStack[this.renderStack.length-
1].scenes.push(d);return d},pushSceneGroup:function(d){d.scenes=d.scenes||[];this.renderStack.push(d);for(var a=0;a<d.scenes.length;++a)d.scenes[a].enable();d.start&&d.start()},popSceneGroup:function(){for(var d=this.renderStack[this.renderStack.length-1],a=0;a<d.scenes.length;++a)d.scenes[a].disable();1<this.renderStack.length&&this.renderStack.pop();d.stop&&d.stop()},getScene:function(d){for(var a=renderStack[renderStack.length-1],b,e=0,f=a.scenes.length;e<f;++e)if(a.scenes[e].scene.name===d){b=
a.scenes[e];break}return b},resumeScene:function(d){"string"===typeof d&&(d=this.getScene(d));d.enable();d.paused=!1},pauseScene:function(d){"string"===typeof d&&(d=this.getScene(d));d.paused=!0;d.disable()},removeScene:function(d){var a=renderStack[renderStack.length-1];"string"===typeof d&&(d=this.getScene(d));var b=a.scenes.indexOf(d);-1<b&&a.scenes.splice(b,1);return d},runOnce:function(){this.loopFunc()}};q.prototype={isKeyPressed:function(d){return this.keyState[d]},getKeyState:function(d){return d!==
r?this.keyState[d]:this.keyState},setEvents:function(d){this.mEvents={};for(var a in d)this.bindEvent(a,d[a])},orbitView:function(d){var a=h.vec3,b=a.subtract(this.camera.target,this.camera.position),b=a.length(b);this.camera.position=a.moveViewRelative(this.camera.position,this.camera.target,-b*d[0]/300,0);this.camera.position[1]+=b*d[1]/300;this.camera.position=a.add(this.camera.target,a.multiply(a.normalize(a.subtract(this.camera.position,this.camera.target)),b))},panView:function(d,a){var b=h.vec3;
a||(a=!1);var e=b.subtract(this.camera.target,this.camera.position),e=b.length(e),f=this.camera.position;a?this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*d[0]/300,-e*d[1]/300):(this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*d[0]/300,0),this.camera.position[1]+=e*d[1]/300);e=b.subtract(this.camera.position,f);this.camera.target=b.add(this.camera.target,e)},zoomView:function(d,a,b){var e=h.vec3,f=e.subtract(this.camera.target,this.camera.position),
f=e.length(f),f=f-d/1E3;a||(a=0.1);b||(b=1E3);f<a&&(f=a);f>b&&(f=b);this.camera.position=e.add(this.camera.target,e.multiply(e.normalize(e.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(d,a){this.mEvents[d]=a===r?this.eventDefaults[d]:a},unbindEvent:function(d){this.bindEvent(d,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,
!1);this.canvas.addEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,
!1);this.canvas.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(d){this.camera=d},getMousePosition:function(){return this.mpos}};return{Timer:x,MainLoop:m,MouseViewController:q,setMainLoop:function(d){h.GLCore.mainloop=d},keyboard:c.keyboard}});
CubicVR.RegisterModule("Texture",function(h){function x(a,f){if(1===a||1===f)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==f)for(;0===f%2;)f/=2;return 1<a||1<f?!1:!0}function u(f){var b=h.GLCore.gl;if("CANVAS"===f.nodeName||"IMG"===f.nodeName||"VIDEO"===f.nodeName)this.canvasSource=f;else{this.canvasSource=document.createElement("CANVAS");if(void 0===f.width||void 0===f.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=f.width;this.canvasSource.height=
f.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=f.update;this.texture=new h.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var d=this.canvasSource;(!d.height||!d.width)&&e("Warning - CanvasTexture input has no initial width and height, edges clamped.");!d.height||!d.width||!x(d.width,d.height)?(this.setFilter(a.texture.filter.LINEAR),b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE)):(this.setFilter(a.texture.filter.LINEAR_MIP),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.REPEAT));"IMG"===f.nodeName&&this.update()}function m(f,b){if(!f)throw"PDF Texture Error: page is null.";var e=this,d=h.GLCore.gl,c=this.canvasSource=document.createElement("canvas"),o;c.mozOpaque=!0;c.width=b.width;c.height=b.height;o=this.canvasContext=
c.getContext("2d");o.save();o.fillStyle="rgb(255, 255, 255)";o.fillRect(0,0,c.width,c.height);o.restore();f.startRendering(o,function(){e.update()});this.texture=new h.Texture;this.updateFunction=b.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(c.width,c.height)?(this.setFilter(a.texture.filter.LINEAR_MIP),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.REPEAT),
d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.REPEAT)):(this.setFilter(a.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function q(f,b,e){var d=h.GLCore.gl;this.texture=new h.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=b;this.canvas.height=e;this.pjs=new Processing(this.canvas,h.util.getURL(f));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;
this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;x(this.canvas.width,this.canvas.height)?this.setFilter(a.texture.filter.LINEAR_MIP):(this.setFilter(a.texture.filter.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE))}function r(f,b,e){var c=d.gl;this.width=b;this.height=e;this.srcTex=f;this.outTex=new h.RenderBuffer(b,e);x(b,e);f=[1/b,1/
e,0];this.outputBuffer=new h.RenderBuffer(b,e,!1);this.fsQuad=h.fsQuad.make(b,e);shaderNMap=new h.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",f);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(c.TEXTURE0);this.setFilter(a.texture.filter.LINEAR);
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)}function c(f,b,e){var c=d.gl;this.width=f;this.height=b;this.outTex=new h.RenderBuffer(f,b,e);this.texture=this.outTex.texture;var o=x(f,b);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(c.TEXTURE0);o?(this.setFilter(a.texture.filter.LINEAR),
c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT)):(this.setFilter(a.texture.filter.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE));this.dims=[f,b];this.depth=e?!0:!1}function g(a,f){this.scene=a;this.renderTex=new c(f?f.width:a.camera.width,f?f.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var d=h.GLCore,a=h.enums,b=h.undef,e=h.log;a.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var f=function(a,f){this.img_path=a;this.filter_type=f};f.prototype={getTexture:function(a,f){return new o(this.img_path,this.filter_type,a,f)}};var o=function(f,e,c,o,g){var m=
d.gl;this.tex_id=h.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;h.Textures[this.tex_id]=m.createTexture();h.Textures_obj[this.tex_id]=this;f&&("string"===typeof f?h.Images[this.tex_id]=new Image:"object"===typeof f&&"IMG"===f.nodeName&&(h.Images[this.tex_id]=f),h.Textures_ref[f]=this.tex_id);m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR);if(f){var q=this.tex_id,
r=e!==b?e:d.default_filter,u=this;h.Images[this.tex_id].onload=function(){m.bindTexture(m.TEXTURE_2D,h.Textures[q]);m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,true);m.pixelStorei(m.UNPACK_COLORSPACE_CONVERSION_WEBGL,m.NONE);var f=h.Images[q];m.texImage2D(m.TEXTURE_2D,0,m.RGBA,m.RGBA,m.UNSIGNED_BYTE,f);if(f=x(f.width,f.height)){m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.REPEAT);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.REPEAT)}else{m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE);
m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE)}if(h.Textures_obj[q].filterType===-1){if(f)r=a.texture.filter.LINEAR_MIP;else if(r===a.texture.filter.LINEAR_MIP)r=a.texture.filter.LINEAR;h.Textures_obj[q].filterType===-1&&h.Textures_obj[q].setFilter(r)}else h.Textures_obj[q].setFilter(h.Textures_obj[q].filterType);if(u.onready)u.onready();m.bindTexture(m.TEXTURE_2D,null);u.loaded=true};c?(h.Images[this.tex_id].deferredSrc=f,c.addImage(o,f,h.Images[this.tex_id])):"string"===typeof f&&
(h.Images[this.tex_id].src=f)}this.active_unit=-1};o.prototype={setFilter:function(f){if(-1<this.tex_id){var b=h.GLCore.gl;b.bindTexture(b.TEXTURE_2D,h.Textures[this.tex_id]);f===a.texture.filter.LINEAR?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR)):f===a.texture.filter.LINEAR_MIP?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_NEAREST),b.generateMipmap(b.TEXTURE_2D)):
f===a.texture.filter.NEAREST?(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST)):f===a.texture.filter.NEAREST_MIP&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST_MIPMAP_LINEAR),b.generateMipmap(b.TEXTURE_2D));this.filterType=f}},use:function(a){-1<this.tex_id&&(d.gl.activeTexture(a),d.gl.bindTexture(d.gl.TEXTURE_2D,h.Textures[this.tex_id]),this.active_unit=
a)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(d.gl.activeTexture(this.active_unit),d.gl.bindTexture(d.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=h.GLCore.gl;-1<this.tex_id&&h.Textures[this.tex_id]&&(a.deleteTexture(h.Textures[this.tex_id]),delete h.Textures_obj[this.tex_id],this.tex_id=-1)}};u.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var f=h.GLCore.gl;f.bindTexture(f.TEXTURE_2D,h.Textures[this.texture.tex_id]);
f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,this.canvasSource);this.filterType===a.texture.filter.LINEAR_MIP&&f.generateMipmap(f.TEXTURE_2D);f.bindTexture(f.TEXTURE_2D,null)}};m.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var f=h.GLCore.gl;f.bindTexture(f.TEXTURE_2D,h.Textures[this.texture.tex_id]);f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,this.canvasSource);
this.filterType===a.texture.filter.LINEAR_MIP&&f.generateMipmap(f.TEXTURE_2D);f.bindTexture(f.TEXTURE_2D,null)}};q.prototype={update:function(){var f=h.GLCore.gl;this.pjs.redraw();f.bindTexture(f.TEXTURE_2D,h.Textures[this.texture.tex_id]);f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,this.canvas);this.filterType===a.texture.filter.LINEAR_MIP&&f.generateMipmap(f.TEXTURE_2D);f.bindTexture(f.TEXTURE_2D,null)}};r.prototype={update:function(){var a=
d.gl,f=a.getParameter(a.VIEWPORT);this.outputBuffer.use();a.viewport(0,0,this.width,this.height);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.srcTex.use(a.TEXTURE0);h.fsQuad.render(this.shaderNorm,this.fsQuad);a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(f[0],f[1],f[2],f[3])}};c.prototype={begin:function(){var a=d.gl;this.dims=a.getParameter(a.VIEWPORT);this.outTex.use();a.viewport(0,0,this.width,this.height);this.depth?a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT):a.clear(a.COLOR_BUFFER_BIT)},
end:function(){var a=d.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:o,DeferredLoadTexture:f,CanvasTexture:u,PdfTexture:m,TextTexture:function(a,f){var e=f&&f.color||"#fff",d=f&&f.bgcolor,c=f&&f.font||"18pt Arial",o=f&&f.align||"start",g=f&&f.y||0,m=f&&f.width||b,q=f&&f.height||b,h,r=document.createElement("CANVAS"),
C=r.getContext("2d"),z=0,z="string"===typeof a?1:a.length;C.font=c;var x=f&&f.lineHeight||C.measureText("OO").width,H;if(1===z)H=C.measureText(a).width;else for(h=H=0;h<z;++h){var I=C.measureText(a[h]).width;I>H&&(H=I)}r.width=m||H;r.height=q||x*z;d&&(C.fillStyle=d,C.fillRect(0,0,r.width,r.height));C.fillStyle=e;C.font=c;C.textAlign=o;C.textBaseline="top";if(1===z)e=f&&f.x||"center"===o?r.width/2:"right"===o?r.width:0,C.fillText(a,e,g);else for(h=0;h<z;++h)e=f&&f.x||"center"===o?r.width/2:"right"===
o?r.width:0,C.fillText(a[h],e,g+h*x);C.fill();this.use=u.prototype.use;this.clear=u.prototype.clear;this.update=u.prototype.update;u.apply(this,[r]);this.update();this.canvasSource=null},PJSTexture:q,NormalMapGen:r,RenderTexture:c,SceneRenderTexture:g}});
CubicVR.RegisterModule("DrawBufferTexture",function(h){var x=h.GLCore,u=h.enums;u.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var m=function(m){m=m||{};this.operation=h.parseEnum(u.draw.op,m.operation||m.op)||u.draw.op.REPLACE;this.brushType=h.parseEnum(u.draw.brush,m.brushType)||u.draw.brush.SINE;this.brushSize=m.size||5;this.color=m.color||[255,255,255,255]};m.prototype={setOperation:function(m){this.operation=h.parseEnum(u.draw.op,m)},getOperation:function(){return this.operation},
setBrushType:function(m){this.brushType=h.parseEnum(u.draw.brush,m)||u.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(m){this.brushSize=m},getSize:function(){return this.brushSize},setColor:function(m){this.color=m},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:h.extendClassGeneral(h.Texture,function(q){q=q||{};h.Texture.apply(this,[q.image,q.filter,q.deferred_bin,q.binId,q.readyFunc]);this.width=q.width||0;this.height=q.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=q.brush||new m;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{getUint8Buffer:function(){return this.imageBuffer},needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(m){this.brush=
m},getBrush:function(){return this.brush},draw:function(m,h,c){var g=c||this.brush,c=g.getOperation(),d=g.getSize(),a=g.getBrushType(),g=g.getColor();this.drawBuffer.push([m,h,c,d,a,g])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var m=this.drawBuffer.pop();this.drawFunc(m[0],m[1],m[2],m[3],m[4],m[5])}return!0},drawFunc:function(m,h,c,g,d,a){for(var b=this.imageBuffer,e=this.width,f=this.height,o=parseInt(Math.floor(m),10)-g;o<parseInt(Math.ceil(m),10)+g;o++)for(var n=
o-m,s,D=parseInt(Math.floor(h),10)-g;D<parseInt(Math.ceil(h),10)+g;D++)if(!(0>o||o>=e||0>D||D>=f)){s=D-h;var w;0===d&&(w=(1-Math.sqrt(n*n+s*s)/g)/2);s=4*(D*e+o);0===c?0>w&&(w=0):1===c?0>w&&(w=0):2===c&&(w=-w,0<w&&(w=0));var t=Math.floor(b[s]*(1-w)+a[0]*w),B=Math.floor(b[s+1]*(1-w)+a[1]*w),A=Math.floor(b[s+2]*(1-w)+a[2]*w),E=Math.floor(b[s+3]*(1-w)+a[3]*w);255<t?t=255:0>t&&(t=0);255<B?B=255:0>B&&(B=0);255<A?A=255:0>A&&(A=0);255<E?E=255:0>E&&(E=0);b[s]=t;b[s+1]=B;b[s+2]=A;b[s+3]=E}},update:function(){var m=
x.gl;this.flush();m.bindTexture(m.TEXTURE_2D,h.Textures[this.tex_id]);m.texImage2D(m.TEXTURE_2D,0,m.RGBA,this.width,this.height,0,m.RGBA,m.UNSIGNED_BYTE,this.imageBuffer);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.LINEAR);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.LINEAR)}}),DrawBufferBrush:m}});
CubicVR.RegisterModule("Material",function(h){function x(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=h.get(a)||{},a.shader||null);null===r&&(r=new h.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
r._init_shader(r._vertex,r._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new h.CustomShader(this.customShader));this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==u?a.visible:!0;this.friction=a.friction!==u?a.friction:0.3;this.collision=a.visible!==u?a.collision:!0;this.opacity=a.opacity===u?
1:a.opacity;this.shininess=a.shininess===u?1:a.shininess;this.max_smooth=a.max_smooth===u?60:a.max_smooth;this.env_amount=a.env_amount===u?0.75:a.env_amount;this.morph=a.morph===u?!1:a.morph;this.color_map=a.colorMap===u?!1:a.colorMap;this.uvOffset=a.uvOffset===u?[0,0]:a.uvOffset;this.noFog=a.noFog===u?!1:a.noFog;if(a.textures)for(var b in a.textures)this.setTexture(a.textures[b],b)}var u=h.undef,m=h.GLCore,q=h.enums,r=null,c=[q.texture.map.REFLECT,q.texture.map.SPECULAR,q.texture.map.NORMAL,q.texture.map.BUMP],
g=[],d="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
x.prototype={clone:function(){var a=new h.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,name:this.name}),b;for(b in this.textures)this.textures.hasOwnProperty(b)&&a.setTexture(this.textures[b],b);return a},setVisibility:function(a){this.visible=
a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,b){if(a&&(b=h.parseEnum(q.texture.map,b)||0,h.features.texturePerPixel||-1===c.indexOf(b)))!a.use&&"string"===typeof a&&(a=h.Textures_ref[a]!==u?h.Textures_obj[h.Textures_ref[a]]:new h.Texture(a)),this.textures[b]=a},calcShaderMask:function(){var a;a=0+("object"===
typeof this.textures[q.texture.map.COLOR]?q.shader.map.COLOR:0);a+="object"===typeof this.textures[q.texture.map.SPECULAR]?q.shader.map.SPECULAR:0;a+="object"===typeof this.textures[q.texture.map.NORMAL]?q.shader.map.NORMAL:0;a+="object"===typeof this.textures[q.texture.map.BUMP]?q.shader.map.BUMP:0;a+="object"===typeof this.textures[q.texture.map.REFLECT]?q.shader.map.REFLECT:0;a+="object"===typeof this.textures[q.texture.map.ENVSPHERE]?q.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[q.texture.map.AMBIENT]?
q.shader.map.AMBIENT:0;a+="object"===typeof this.textures[q.texture.map.ALPHA]?q.shader.map.ALPHA:0;a+=1!==this.opacity?q.shader.map.ALPHA:0;a+=this.color_map?q.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return a},getShaderHeader:function(a,b){return(b!==u?"#define LIGHT_COUNT "+b+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[q.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[q.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+
("object"===typeof this.textures[q.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[q.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[q.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[q.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[q.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[q.texture.map.ALPHA]?1:
0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===q.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===q.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===q.light.type.SPOT||a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===q.light.type.SPOT_SHADOW_PROJECTOR?
1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(m.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===q.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===q.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(m.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(m.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(m.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(m.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(h.features.lightPerPixel?
1:0)+"\n\n"},bindObject:function(a,b){var e=m.gl,f=b.vertexPosition,d=b.vertexTexCoord,n=b.vertexNormal,c=b.vertexColor;e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_points);e.vertexAttribPointer(f,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(f);d!==u&&(null!==a.compiled.gl_uvs&&-1!==d)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_uvs),e.vertexAttribPointer(d,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(d));g.uv=d;n!==u&&(null!==a.compiled.gl_normals&&-1!==n)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_normals),
e.vertexAttribPointer(n,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(n));g.un=n;c!==u&&(null!==a.compiled.gl_colors&&-1!==c)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_colors),e.vertexAttribPointer(c,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(c));g.uc=c;a.morphTarget&&(f=b.vertexMorphPosition,n=b.vertexMorphNormal,e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_points),e.vertexAttribPointer(f,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(f),n!==u&&(null!==a.morphTarget.gl_normals&&-1!==n)&&(e.bindBuffer(e.ARRAY_BUFFER,
a.morphTarget.gl_normals),e.vertexAttribPointer(n,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(n)),e.uniform1f(b.materialMorphWeight,a.morphWeight));a.compiled.unrolled?e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null):e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},bindLines:function(a,b){var e=m.gl,f=b.vertexPosition,d=b.vertexTexCoord,n=b.vertexNormal,c=b.vertexColor;a.compiled.unrolled?(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_lines),e.vertexAttribPointer(f,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(f),
g.up=f,d!==u&&(null!==a.compiled.gl_line_uvs&&-1!==d)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_line_uvs),e.vertexAttribPointer(d,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(d)),g.uv=d,n!==u&&(null!==a.compiled.gl_line_normals&&-1!==n)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_line_normals),e.vertexAttribPointer(n,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(n)),g.un=n,c!==u&&(null!==a.compiled.gl_line_colors&&-1!==c)&&(e.bindBuffer(e.ARRAY_BUFFER,a.compiled.gl_line_colors),e.vertexAttribPointer(c,
3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(c)),g.uc=c):e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a.compiled.gl_line_elements);a.morphTarget&&(f=b.vertexMorphPosition,n=b.vertexMorphNormal,e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_lines),e.vertexAttribPointer(f,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(f),n!==u&&(null!==a.morphTarget.gl_line_normals&&-1!==n)&&(e.bindBuffer(e.ARRAY_BUFFER,a.morphTarget.gl_line_normals),e.vertexAttribPointer(n,3,e.FLOAT,!1,0,0),e.enableVertexAttribArray(n)),e.uniform1f(b.materialMorphWeight,
a.morphWeight))},clearObject:function(a,b){var e=m.gl;g.uv!==u&&-1!==g.uv&&e.disableVertexAttribArray(g.uv);g.un!==u&&-1!==g.un&&e.disableVertexAttribArray(g.un);g.uc!==u&&-1!==g.uc&&e.disableVertexAttribArray(g.uc);a.morphTarget&&b&&(up=b.vertexMorphPosition,e.disableVertexAttribArray(up),un=b.vertexMorphNormal,null!==un&&(null!==a.compiled.gl_normals&&-1!==un)&&e.disableVertexAttribArray(un))},use:function(a,b){var e,f=m.gl,c=this.textures,n=!0,b=b||0,a=a||0;this.shader[a]||(this.shader[a]=[]);
var g=this.shader[a][b],D=this.customShader&&a===q.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();g&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(g=null,this.dirtyFlag=!1);if(g)n=g!==r,g.use();else{e=this.calcShaderMask(a);if(!this.customShader||D)h.ShaderPool[a][e]||(h.ShaderPool[a][e]=[]),g=h.ShaderPool[a][e][b];if(!g){var w=this.getShaderHeader(a,b),t=w+m.CoreShader_vs,w=w+m.CoreShader_fs;this.customShader&&!D?this.customShader._initialized||(this.customShader._init_shader(t,
w,d),g=this.customShader.getShader(),g.isCompiled()||(n=!1,g=r.getShader())):(g=new h.Shader(t,w),g.isCompiled()||(n=!1,g=r.getShader()),h.ShaderPool[a][e][b]=g);e=0;if(a!==q.light.type.DEPTH_PACK){if(a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA)e+=b,a===q.light.type.SPOT_SHADOW_PROJECTOR&&(e+=b);"object"===typeof c[q.texture.map.COLOR]&&g.addInt("textureColor",e++);"object"===typeof c[q.texture.map.ENVSPHERE]&&g.addInt("textureEnvSphere",e++);"object"===
typeof c[q.texture.map.NORMAL]&&g.addInt("textureNormal",e++);"object"===typeof c[q.texture.map.BUMP]&&g.addInt("textureBump",e++);"object"===typeof c[q.texture.map.REFLECT]&&g.addInt("textureReflect",e++);"object"===typeof c[q.texture.map.SPECULAR]&&g.addInt("textureSpecular",e++);"object"===typeof c[q.texture.map.AMBIENT]&&g.addInt("textureAmbient",e++)}"object"===typeof c[q.texture.map.ALPHA]&&g.addInt("textureAlpha",e++);g.addMatrix("matrixModelView");g.addMatrix("matrixProjection");g.addMatrix("matrixObject");
g.addMatrix("matrixNormal");g.addVertexArray("vertexPosition",0);g.addVertexArray("vertexNormal");this.color_map&&g.addVertexArray("vertexColor");this.morph&&(g.addVertexArray("vertexMorphPosition"),g.addVertexArray("vertexMorphNormal"),g.addFloat("materialMorphWeight",0));for(e=0;e<b;e++)if(g.addVector("lightDiffuse["+e+"]"),g.addVector("lightSpecular["+e+"]"),g.addFloat("lightIntensity["+e+"]"),g.addFloat("lightDistance["+e+"]"),g.addVector("lightPosition["+e+"]"),g.addVector("lightDirection["+
e+"]"),(a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.SPOT)&&g.addFloat("lightCutOffAngle["+e+"]"),a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA)g.addInt("lightShadowMap["+e+"]"),a===q.light.type.SPOT_SHADOW_PROJECTOR&&g.addInt("lightProjectionMap["+e+"]"),g.addVector("lightDepthClip["+e+"]"),g.addMatrix("lightShadowMatrix["+e+"]");a!==q.light.type.DEPTH_PACK&&(g.addVector("lightAmbient"),g.addVector("materialDiffuse"),
g.addVector("materialColor"),g.addVector("materialAmbient"),g.addVector("materialSpecular"),g.addFloat("materialShininess"),g.addFloat("materialEnvironment"));g.addFloat("materialAlpha");(m.depth_alpha||a===q.light.type.DEPTH_PACK||a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA)&&g.addVector("postDepthInfo");g.addUVArray("vertexTexCoord");g.addVector("materialTexOffset");m.fog_enabled&&!this.noFog&&(g.addVector("fogColor",m.fogColor),g.addFloat("fogDensity",
m.fogDensity),g.addFloat("fogNear",m.fogNear),g.addFloat("fogFar",m.fogFar))}this.shader[a][b]=g;g.use();-1!=g.materialTexOffset&&f.uniform2fv(g.materialTexOffset,[0,0])}e=0;if(a!==q.light.type.DEPTH_PACK){if(a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA)e+=b,a===q.light.type.SPOT_SHADOW_PROJECTOR&&(e+=b);if(t=c[q.texture.map.COLOR])t.use(m.gl.TEXTURE0+e),e++;if(t=c[q.texture.map.ENVSPHERE])t.use(m.gl.TEXTURE0+e),e++,f.uniform1f(g.materialEnvironment,
this.env_amount);if(t=c[q.texture.map.NORMAL])t.use(m.gl.TEXTURE0+e),e++;if(t=c[q.texture.map.BUMP])t.use(m.gl.TEXTURE0+e),e++;if(t=c[q.texture.map.REFLECT])t.use(m.gl.TEXTURE0+e),e++;if(t=c[q.texture.map.SPECULAR])t.use(m.gl.TEXTURE0+e),e++;if(t=c[q.texture.map.AMBIENT])t.use(m.gl.TEXTURE0+e),e++}if(t=c[q.texture.map.ALPHA])t.use(m.gl.TEXTURE0+e),e++;m.fog_enabled&&!this.noFog&&(f.uniform3fv(g.fogColor,m.fogColor),f.uniform1f(g.fogDensity,m.fogDensity),f.uniform1f(g.fogNear,m.fogNear),f.uniform1f(g.fogFar,
m.fogFar));a!==q.light.type.DEPTH_PACK?(f.uniform3fv(g.materialColor,this.color),f.uniform3fv(g.materialDiffuse,this.diffuse),f.uniform3fv(g.materialAmbient,this.ambient),f.uniform3fv(g.materialSpecular,this.specular),f.uniform1f(g.materialShininess,128*this.shininess),f.uniform3fv(g.lightAmbient,h.globalAmbient),1!==this.opacity&&f.uniform1f(g.materialAlpha,this.opacity),(m.depth_alpha||a===q.light.type.SPOT_SHADOW||a===q.light.type.SPOT_SHADOW_PROJECTOR||a===q.light.type.AREA)&&f.uniform3fv(g.postDepthInfo,
[m.depth_alpha_near,m.depth_alpha_far,0])):f.uniform3fv(g.postDepthInfo,[m.shadow_near,m.shadow_far,0]);g.materialTexOffset&&f.uniform2fv(g.materialTexOffset,this.uvOffset);this.customShader&&(a!==q.light.type.DEPTH_PACK||a===q.light.type.DEPTH_PACK&&!D)&&this.customShader._doUpdate({material:this,textureIndex:e});return n}};return{Material:x}});
CubicVR.RegisterModule("Mesh",function(h){function x(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function u(c){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;this.genNormals=
!0;c=h.get(c)||{};if(c instanceof h.Mesh)this.booleanAdd(c),c._clones=c._clones||1,c._clones++,this.name=c.name?c.name+"_copy"+c._clones:null;else{this.name=c.name||null;this.dynamic=c.dynamic||!1;if(c.material){var g=c.material;g.length?this.materials=g:"object"===typeof g&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new h.Material(g)))}(c.point||c.points)&&this.build(c);c.part?this.build(c.part):c.parts&&this.build(c.parts);if((this.primitives=c.primitives||c.primitive||null)&&!this.primitives.length||
"string"===typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,d=this.primitives.length;g<d;g++){var a=this.primitives[g];"string"===typeof a&&(a=h.get(a));var b=h.primitives[a.type];if(a.type&&b)this.booleanAdd(b(a));else if(a.type){r("Mesh error, primitive "+a.type+" is unknown.");var a="",e;for(e in h.primitives)h.primitives.hasOwnProperty(e)&&(""!==a&&(a+=", "),a+=e);r("Available primitive types are: "+a)}else r("Mesh error, primitive "+
(g+1)+" lacks type.")}this.buildWireframe=c.buildWireframe||c.wireframe||!!c.wireframeMaterial||c.triangulateWireframe||!1;this.triangulateWireframe=c.triangulateWireframe||null;this.wireframeMaterial=h.get(c.wireframeMaterial,h.Material)||null;this.wireframe=c.wireframe||!1;c.flipFaces&&this.faces.length&&this.flipFaces();(c.prepare||c.compile&&this.faces.length)&&this.prepare();(c.clean||c.compile&&this.faces.length&&!this.dynamic)&&this.clean();this.genNormals&&(c.calcNormals&&!c.compile&&!c.prepare)&&
this.calcNormals()}}var m=h.undef,q=h.GLCore,r=h.log;x.prototype={setUV:function(c,g){g!==m?this.uvs[g]=c:2!==c.length?this.uvs=c:this.uvs.push(c)},setPointNormal:function(c,g){g!==m?this.point_normals[g]=c:"number"===typeof c[0]?this.point_normals.push(c):this.point_normals=c},setNormal:function(c){this.normal=c;if(!this.point_normals.length&&this.points.length)for(var g=0,d=this.points.length;g<d;g++)this.point_normals[g]=c},setColor:function(c,g){g!==m?this.point_colors[g]=c:"number"!==typeof c[0]?
this.point_colors=c:this.point_colors.push(c)},flip:function(){for(var c=0,g=this.point_normals.length;c<g;c++)this.point_normals[c]=[-this.point_normals[c][0],-this.point_normals[c][1],-this.point_normals[c][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};u.prototype={setWireframe:function(c){this.wireframe=c},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(c){this.wireframeMaterial=
c},build:function(c,g){var d,a;"string"===typeof c&&(c=h.get(c));c&&!c.length&&(c=[c]);var b=this.faces.length;g&&g.length&&this.points.concat(g);for(var e=0,f=c.length;e<f;e++){var o=c[e];d=o.material;a=o.points||o.point;var n=o.faces||o.face,s=o.uv||o.uvs,m=o.color||o.colors,w=o.normal||o.normals,o=o.segment||null;null!==o&&this.setSegment(parseInt(o,10));if(a&&a.length&&(this.points=this.points.concat(a),n&&b)){n=n.slice(0);a=0;for(o=n.length;a<o;a++)for(var t=n[a],q=0,A=n.length;q<A;q++)t[q]+=
b}d&&(d.length?this.materials=d:"object"===typeof d&&(d.use?this.setFaceMaterial(d):this.setFaceMaterial(new h.Material(d))));n&&n.length&&this.addFace(n);if(n&&s&&"object"===typeof s){o=null;if(s.length)if(s.length===n.length){d=0;for(a=s.length;d<a;d++)this.faces[d+b].setUV(s[d])}else r("Mesh error in part, face count: "+n.length+", uv count:"+s.length);else o=s.apply?s:new h.UVMapper(s);o&&o.apply(this,this.currentMaterial,this.currentSegment,b,this.faces.length-b)}if(n&&w)if(w.length&&w[0].length)if(w.length===
n.length){this.genNormals=!1;s="number"===typeof w[0][0];d=0;for(a=w.length;d<a;d++)s?this.faces[d+b].setNormal(w[d]):this.faces[d+b].setPointNormal(w[d])}else r("Mesh error in part, face count: "+n.length+", normals count:"+s.length);else r("Mesh error in part, unknown something where normals should be? ["+typeof w+"]");if(n&&m&&"object"===typeof m)if(m.length&&m.length===n.length){d=0;for(a=m.length;d<a;d++)this.faces[d+b].setColor(m[d]);this.materials[this.currentMaterial].colorMap=!0}else r("Mesh error in part, face count: "+
n.length+", color count:"+m.length)}return this},showAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!0)},hideAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!1)},setSegment:function(c,g){g!==m?this.segment_state[c]=g:this.currentSegment=c},addPoint:function(c){if(3!==c.length||"object"===typeof c[0])for(var g=0,d=c.length;g<d;g++)this.points.push(c[g]);else this.points.push(c);
return this.points.length-1},getMaterialIndex:function(c){return this.materials.indexOf(c)},setFaceMaterial:function(c,g){var d;"number"==typeof c?d=c:(d=this.materials.indexOf(c),-1===d&&(this.materials.push(c),d=this.materials.length-1));g!==m?this.faces[g]!==m&&(this.faces[g].material=d):this.currentMaterial=d;return this},addFace:function(c,g,d,a){if("number"!==typeof c[0]){g=0;for(d=c.length;g<d;g++)this.addFace(c[g])}else return g===m?(this.currentFace=this.faces.length,this.faces.push(new x)):
(this.faces[g]===m&&(this.faces[g]=new x),this.currentFace=g),"object"===typeof c&&(this.faces[this.currentFace].points=c),d!==m?this.setFaceMaterial(d,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=a!==m?a:this.currentSegment,this.currentFace},flipFaces:function(){for(var c=0,g=this.faces.length;c<g;c++)this.faces[c].flip()},triangulateQuads:function(){for(var c=0,g=this.faces.length;c<g;c++)if(4===this.faces[c].points.length){var d=
this.faces.length;this.addFace([this.faces[c].points[2],this.faces[c].points[3],this.faces[c].points[0]],this.faces.length,this.faces[c].material,this.faces[c].segment);this.faces[c].points.pop();this.faces[d].normal=this.faces[c].normal.slice(0);4===this.faces[c].point_colors.length&&(this.faces[d].setColor(this.faces[c].point_colors[2],0),this.faces[d].setColor(this.faces[c].point_colors[3],1),this.faces[d].setColor(this.faces[c].point_colors[0],2),this.faces[c].point_colors.pop());4===this.faces[c].uvs.length&&
(this.faces[d].setUV(this.faces[c].uvs[2],0),this.faces[d].setUV(this.faces[c].uvs[3],1),this.faces[d].setUV(this.faces[c].uvs[0],2),this.faces[c].uvs.pop());4===this.faces[c].point_normals.length&&(this.faces[d].point_normals[0]=this.faces[c].point_normals[2],this.faces[d].point_normals[1]=this.faces[c].point_normals[3],this.faces[d].point_normals[2]=this.faces[c].point_normals[0],this.faces[c].point_normals.pop())}return this},booleanAdd:function(c,g){var d=h.mat4,a=this.points.length,b,e,f,o;b=
g;g=b===m?m:"array"===typeof b?b:"object"===typeof b?b.getResult?b.getResult():b.position||b.rotation||b.scale?h.mat4.transform(b.position,b.rotation,b.scale):m:void 0;c.wireframeMaterial&&(this.wireframeMaterial=c.wireframeMaterial);if(g!==m){e=g;b=0;for(f=c.points.length;b<f;b++)this.addPoint(d.vec3_multiply(c.points[b],e))}else{b=0;for(f=c.points.length;b<f;b++)this.addPoint([c.points[b][0],c.points[b][1],c.points[b][2]])}d=[];b=0;for(f=c.materials.length;b<f;b++)e=this.materials.indexOf(c.materials[b]),
-1===e?(this.materials.push(c.materials[b]),d[b]=this.materials.length-1):d[b]=e;b=0;for(f=c.faces.length;b<f;b++){var n=[];e=0;for(o=c.faces[b].points.length;e<o;e++)n.push(c.faces[b].points[e]+a);n=this.faces[this.addFace(n)];n.segment=c.faces[b].segment;n.material=d[c.faces[b].material];n.material===m&&(n.material=0);e=0;for(o=c.faces[b].uvs.length;e<o;e++)n.uvs[e]=[c.faces[b].uvs[e][0],c.faces[b].uvs[e][1]];e=0;for(o=c.faces[b].point_normals.length;e<o;e++)n.point_normals[e]=[c.faces[b].point_normals[e][0],
c.faces[b].point_normals[e][1],c.faces[b].point_normals[e][2]]}return this},calcFaceNormals:function(c,g){var d=h.vec3,a=h.triangle,b=0,e=this.faces.length,f,o=this.points,n;c&&(b=c);for(g&&(e=g+1);b<e;b++)f=this.faces[b],n=f.points,3>n.length?f.normal=[0,0,0]:d.normalize(a.normal(o[n[0]],o[n[1]],o[n[2]],f.normal));return this},getMaterial:function(c){if(!isNaN(parseInt(c,10)))return this.materials[g];for(var g=0,d=this.materials.length;g<d;g++)if(this.materials[g].name===c)return this.materials[g];
return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(c){this.instanceMaterials=c},calcNormals:function(c){var g=h.vec3,d=!1,a;this.genNormals=!0;this.dynamic&&(a=[],c=c||{});c!==m&&(a=[],d=!0);this.calcFaceNormals();var b,e,f,o,n=Array(this.points.length);b=0;for(o=n.length;b<o;b++)n[b]=[];o=this.faces.length;for(b=0;b<o;b++){f=this.faces[b].points.length;for(e=0;e<f;e++)n[this.faces[b].points[e]].push([b,e])}b=0;for(o=this.points.length;b<o;b++){var s=n[b].length;
for(e=0;e<s;e++){var D=1,w=n[b][e][0],t=n[b][e][1],q=this.materials.length?this.materials[this.faces[w].material].max_smooth:60,A=this.faces[w];d&&(a[w]===m&&(a[w]=[]),a[w][t]===m&&(a[w][t]=[]));var r=Array(3);r[0]=A.normal[0];r[1]=A.normal[1];r[2]=A.normal[2];if(0!==q)for(f=0;f<s;f++)if(e!==f){var u=n[b][f][0],v=this.faces[u],y=g.angle(v.normal,A.normal);if(y!==y||y*(180/Math.PI)<=q)d&&a[w][t].push(u),r[0]+=v.normal[0],r[1]+=v.normal[1],r[2]+=v.normal[2],D++}r[0]/=D;r[1]/=D;r[2]/=D;this.faces[w].point_normals[t]=
g.normalize(r)}}if(d){b=g=0;for(o=a.length;b<o;b++){e=0;for(f=a[b].length;e<f;e++)g+=a[b][e].length}c.faceCount||(c.faceCount=new Uint8Array(3*this.faces.length));c.faceNorm||(c.faceNorm=65535<this.faces.length?new Uint32Array(g):new Uint16Array(g));c.faceNormIdx||(c.faceNormIdx=65535<this.faces.length?new Uint32Array(this.faces.length):new Uint16Array(this.faces.length));b=g=0;for(o=this.faces.length;b<o;b++)for(e=0;3>e;e++)if(d=a[b][e],c.faceCount[3*b+e]=d?d.length:0,c.faceNormIdx[b]=g,d){f=0;for(d=
d.length;f<d;f++)c.faceNorm[g++]=a[b][e][f]}else g++;this.normalMapRef=c}return this},recalcNormals:function(c,g){if(this.genNormals){var d,a,b,e,f,o,n,s,h,w,g=g||{};if(c=c||this.normalMapRef){d=g.segments!==m?!0:!1;a=g.segments;this.calcFaceNormals();var t=0,q=0,A=0,r;if(d)for(var q=this.dynamicData.VBO.dynamicMap,u=c.faceNormIdx,v=0,y=a.length;v<y;v++)for(var C=q.segmentMap[a[v]],z=0,x=C.length;z<x;z++){d=C[z];h=this.faces[d];r=h.normal;t=u[d];for(j=0;3>j;j++){s=h.point_normals[j];f=r[0];o=r[1];
n=r[2];w=c.faceCount[3*d+j];b=0;for(iMax=w;b<iMax;b++)e=c.faceNorm[t+b],e=this.faces[e],e=e.normal,f+=e[0],o+=e[1],n+=e[2];w?(b=w+1,f/=b,o/=b,n/=b,b=Math.sqrt(f*f+o*o+n*n),f/=b,o/=b,n/=b,s[0]=f,s[1]=o,s[2]=n):A++}}else{d=0;for(a=this.faces.length;d<a;d++){h=this.faces[d];r=h.normal;for(j=0;3>j;j++){s=h.point_normals[j];f=r[0];o=r[1];n=r[2];w=c.faceCount[q++];b=0;for(iMax=w;b<iMax;b++)e=c.faceNorm[t++],e=this.faces[e],e=e.normal,f+=e[0],o+=e[1],n+=e[2];w?(b=w+1,f/=b,o/=b,n/=b,b=Math.sqrt(f*f+o*o+n*
n),f/=b,o/=b,n/=b,s[0]=f,s[1]=o,s[2]=n):A++}}}return this}}},removeDoubles:function(c){var g=[],d=[],a,b,e,f;a=0;for(b=this.points.length;a<b;a++){var o=-1,n=this.points[a];e=0;for(f=g.length;e<f;e++)if(h.vec3.equal(n,g[e],c)){o=e;break}-1!=o?d[a]=o:(d[a]=g.length,g.push(this.points[a]))}this.points=g;a=0;for(b=this.faces.length;a<b;a++){c=this.faces[a];e=0;for(f=c.points.length;e<f;e++)c.points[e]=d[c.points[e]]}return this},buildEdges:function(){var c,g,d,a,b=[],e=[];c=0;for(d=this.faces.length;c<
d;c++){var f=this.faces[c];g=0;for(a=f.points.length;g<a;g++){var o,n,s;s=f.segment;matId=f.material;g?(n=f.points[g],o=f.points[g-1]):(n=f.points[g],o=f.points[a-1]);b[o]=b[o]||{};b[o][matId]=b[o][matId]||{};b[o][matId][s]=b[o][matId][s]||{};!b[o][matId][s][n]&&(!b[n]||!b[n][matId][s][o])&&e.push([matId,s,o,n])}}this.edges=e;return this},subdivide:function(c,g){var d=h.vec3,g=g===m?!0:g;c===m&&(c=1);if(0!==c){var a,b,e,f,o,n={},s=[],D=[],w=this.points.length,t=this.faces.length,q=[],A=[],u=[],F=
[];a=0;for(e=t;a<e;a++)if(o=this.faces[a],o.points&&(3===o.points.length||4===o.points.length)){var v=[0,0,0];b=0;for(f=o.points.length;b<f;b++){var y=this.points[o.points[b]];v[0]+=y[0];v[1]+=y[1];v[2]+=y[2]}v[0]/=f;v[1]/=f;v[2]/=f;q[a]=this.addPoint(v);if(o.uvs.length===o.points.length){v=[0,0];b=0;for(f=o.uvs.length;b<f;b++)y=o.uvs[b],v[0]+=y[0],v[1]+=y[1];v[0]/=f;v[1]/=f;A[a]=v}if(o.point_colors.length===o.points.length){v=[0,0,0];b=0;for(f=o.point_colors.length;b<f;b++)y=o.point_colors[b],v[0]+=
y[0],v[1]+=y[1],v[2]+=y[2];v[0]/=f;v[1]/=f;v[2]/=f;u[a]=v}if(o.point_normals.length===o.points.length){v=[0,0,0];b=0;for(f=o.point_normals.length;b<f;b++)y=o.point_normals[b],v[0]+=y[0],v[1]+=y[1],v[2]+=y[2];v[0]/=f;v[1]/=f;v[2]/=f;F[a]=v}}a=0;for(e=this.faces.length;a<e;a++){o=this.faces[a];b=0;for(f=o.points.length;b<f;b++){var C,z;b?(C=b,z=b-1):(C=b,z=f-1);y=o.points[C];v=o.points[z];n[v]=n[v]||{};s[v]=s[v]||[];s[v].push(a);n[v][y]={face:a,a:v,b:y,fpa:C,fpb:z}}}for(a in n)if(n.hasOwnProperty(a))for(b in n[a])if(n[a].hasOwnProperty(b)){e=
n[a][b];o=n[b][a];if(o===m){r("Mesh.subdivide error. Hole at face #"+e.face+", Edge:["+e.fpa+"->"+e.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}e.edge_point||(f=d.multiply(d.add(this.points[e.a],this.points[e.b]),0.5),g?(v=d.multiply(d.add(this.points[q[e.face]],this.points[q[o.face]]),0.5),e.edge_point=d.multiply(d.add(f,v),0.5)):e.edge_point=f,o.edge_point=e.edge_point,e.edge_avg=f,o.edge_avg=f,e.ep_idx=this.addPoint(e.edge_point),o.ep_idx=e.ep_idx);D[e.a]=D[e.a]||
[];D[e.a].push(e.edge_avg);f=this.faces[e.face].uvs;f.length&&(o=f[e.fpa],f=f[e.fpb],e.uv=[(o[0]+f[0])/2,(o[1]+f[1])/2]);o=this.faces[e.face].point_colors;o.length&&(e.color=d.multiply(d.add(o[e.fpa],o[e.fpb]),0.5));o=this.faces[e.face].point_normals;o.length&&(e.normal=d.normalize(d.multiply(d.add(o[e.fpa],o[e.fpb]),0.5)))}if(g){o=[];a=0;for(e=w;a<e;a++)if(v=[0,0,0],s[a]){b=0;for(f=s[a].length;b<f;b++)y=this.points[q[s[a][b]]],v[0]+=y[0],v[1]+=y[1],v[2]+=y[2];v[0]/=f;v[1]/=f;v[2]/=f;o[a]=v}v=[];
a=0;for(e=w;a<e;a++)if(y=[0,0,0],D[a]){b=0;for(f=D[a].length;b<f;b++)C=D[a][b],y[0]+=C[0],y[1]+=C[1],y[2]+=C[2];y[0]/=f;y[1]/=f;y[2]/=f;v[a]=y}a=0;for(e=w;a<e;a++)s[a]&&(w=s[a].length,b=1/w,D=2/w,w=d.multiply(this.points[a],(w-3)/w),w=d.add(w,d.multiply(o[a],b)),w=d.add(w,d.multiply(v[a],D)),this.points[a]=w)}for(a=0;a<t;a++)if(o=this.faces[a],!(3!==o.points.length&&4!==o.points.length))if(d=o.points.slice(0),s=o.uvs.slice(0),b=o.point_colors.slice(0),D=o.point_normals.slice(0),w=s.length===d.length,
e=b.length===d.length,f=D.length===d.length,o=o.material,3===d.length){if(this.setFaceMaterial(o),v=n[d[0]][d[1]],y=n[d[2]][d[0]],this.addFace([d[0],v.ep_idx,q[a],y.ep_idx],a),w&&(this.faces[a].uvs=[s[0],v.uv,A[a],y.uv]),e&&(this.faces[a].point_colors=[b[0],v.color,u[a],y.color]),f&&(this.faces[a].point_normals=[D[0],v.normal,F[a],y.normal]),v=n[d[1]][d[2]],y=n[d[0]][d[1]],o=this.addFace([d[1],v.ep_idx,q[a],y.ep_idx]),w&&(this.faces[o].uvs=[s[1],v.uv,A[a],y.uv]),e&&(this.faces[o].point_colors=[b[1],
v.color,u[a],y.color]),f&&(this.faces[o].point_normals=[D[1],v.normal,F[a],y.normal]),v=n[d[2]][d[0]],y=n[d[1]][d[2]],o=this.addFace([d[2],v.ep_idx,q[a],y.ep_idx]),w&&(this.faces[o].uvs=[s[2],v.uv,A[a],y.uv]),e&&(this.faces[o].point_colors=[b[2],v.color,u[a],y.color]),f)this.faces[o].point_normals=[D[2],v.normal,F[a],y.normal]}else if(this.setFaceMaterial(o),v=n[d[0]][d[1]],y=n[d[3]][d[0]],this.addFace([d[0],v.ep_idx,q[a],y.ep_idx],a),w&&(this.faces[a].uvs=[s[0],v.uv,A[a],y.uv]),e&&(this.faces[a].point_colors=
[b[0],v.color,u[a],y.color]),f&&(this.faces[a].point_normals=[D[0],v.normal,F[a],y.normal]),v=n[d[1]][d[2]],y=n[d[0]][d[1]],o=this.addFace([d[1],v.ep_idx,q[a],y.ep_idx]),w&&(this.faces[o].uvs=[s[1],v.uv,A[a],y.uv]),e&&(this.faces[o].point_colors=[b[1],v.color,u[a],y.color]),f&&(this.faces[o].point_normals=[D[1],v.normal,F[a],y.normal]),v=n[d[2]][d[3]],y=n[d[1]][d[2]],o=this.addFace([d[2],v.ep_idx,q[a],y.ep_idx]),w&&(this.faces[o].uvs=[s[2],v.uv,A[a],y.uv]),e&&(this.faces[o].point_colors=[b[2],v.color,
u[a],y.color]),f&&(this.faces[o].point_normals=[D[2],v.normal,F[a],y.normal]),v=n[d[3]][d[0]],y=n[d[2]][d[3]],o=this.addFace([d[3],v.ep_idx,q[a],y.ep_idx]),w&&(this.faces[o].uvs=[s[3],v.uv,A[a],y.uv]),e&&(this.faces[o].point_colors=[b[3],v.color,u[a],y.color]),f)this.faces[o].point_normals=[D[3],v.normal,F[a],y.normal];c--;if(0!==c)this.subdivide(c,g);else return this}},removeInternals:function(){var c,g,d,a,b,e={},f=this.faces.length,o,n,s,h;c=0;for(d=this.faces.length;c<d;c++){b=this.faces[c];g=
0;for(a=b.points.length;g<a;g++)g?(s=g,h=g-1):(s=g,h=a-1),o=b.points[s],n=b.points[h],e[o]=e[o]||{},e[o][n]===m?e[o][n]=[c]:e[o][n].push(c)}d=function(a){return-1!==e[n][o].indexOf(a)};for(c=0;c<f;c++){b=this.faces[c];var w=null;g=0;for(a=b.points.length;g<a;g++)g?(s=g,h=g-1):(s=g,h=a-1),o=b.points[s],n=b.points[h],w=w?w.filter(d):e[n][o];w.length&&(this.faces.splice(c,1),f--,c--)}return this},prepare:function(c){c===m&&(c=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads();
this.genNormals&&this.calcNormals();this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();c&&!this.dynamic&&this.clean();return this},clean:function(){var c,g;c=0;for(g=this.points.length;c<g;c++)delete this.points[c],this.points[c]=null;this.points=[];c=0;for(g=this.faces.length;c<g;c++)delete this.faces[c].points,delete this.faces[c].point_normals,delete this.faces[c].uvs,delete this.faces[c].normal,delete this.faces[c],this.faces[c]=null;this.faces=[];return this},compileMap:function(c){var g=
h.vec3,d=h.vec2;c===m&&(c=1.0E-5);var a={segments:[],bounds:[]},b=[],e,f,o,n,s,D,w,t;this.materials.length||this.materials.push(new h.Material);e=0;for(D=this.materials.length;e<D;e++)b[e]=[];e=0;for(D=this.faces.length;e<D;e++)3===this.faces[e].points.length&&(o=this.faces[e].material,n=this.faces[e].segment,b[o][n]===m&&(b[o][n]=[],a.segments.push(n)),b[o][n].push(e));var q=[],r=0,u=!1,F=!1,v=!1,y;e=0;for(D=b.length;e<D;e++)for(f in b[e])if(b[e].hasOwnProperty(f))for(o=0;o<b[e][f].length;o++)y=
b[e][f][o],u=u||0!==this.faces[y].uvs.length,F=F||0!==this.faces[y].point_normals.length,v=v||0!==this.faces[y].point_colors.length;if(u)for(e=0;e<this.faces.length;e++)if(!this.faces[e].uvs.length)for(f=0;f<this.faces[e].points.length;f++)this.faces[e].uvs.push([0,0]);if(F)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_normals.length)for(f=0;f<this.faces[e].points.length;f++)this.faces[e].point_normals.push([0,0,0]);if(v)for(e=0;e<this.faces.length;e++)if(!this.faces[e].point_colors.length)for(f=
0;f<this.faces[e].points.length;f++)this.faces[e].point_colors.push([0,0,0]);e=0;for(D=b.length;e<D;e++)for(f in b[e])if(b[e].hasOwnProperty(f)){o=0;for(w=b[e][f].length;o<w;o++){y=b[e][f][o];for(n=0;3>n;n++){var C=this.faces[y].points[n],z=-1;if(q[C]!==m){s=0;for(t=q[C].length;s<t;s++){var x=q[C][s][0],H=q[C][s][1],z=q[C][s][2];F&&(z=g.equal(this.faces[x].point_normals[H],this.faces[y].point_normals[n],c)?z:-1);u&&(z=d.equal(this.faces[x].uvs[H],this.faces[y].uvs[n],c)?z:-1);v&&(z=g.equal(this.faces[x].point_colors[H],
this.faces[y].point_colors[n],c)?z:-1)}}-1!==z?(a.elements===m&&(a.elements=[]),a.elements[e]===m&&(a.elements[e]=[]),a.elements[e][f]===m&&(a.elements[e][f]=[]),a.elements[e][f].push(z)):(a.points===m&&(a.points=[]),a.points.push(C),0===a.bounds.length?(a.bounds[0]=[this.points[C][0],this.points[C][1],this.points[C][2]],a.bounds[1]=[this.points[C][0],this.points[C][1],this.points[C][2]]):(this.points[C][0]<a.bounds[0][0]&&(a.bounds[0][0]=this.points[C][0]),this.points[C][1]<a.bounds[0][1]&&(a.bounds[0][1]=
this.points[C][1]),this.points[C][2]<a.bounds[0][2]&&(a.bounds[0][2]=this.points[C][2]),this.points[C][0]>a.bounds[1][0]&&(a.bounds[1][0]=this.points[C][0]),this.points[C][1]>a.bounds[1][1]&&(a.bounds[1][1]=this.points[C][1]),this.points[C][2]>a.bounds[1][2]&&(a.bounds[1][2]=this.points[C][2])),F&&(a.normals===m&&(a.normals=[]),a.normals.push([y,n])),v&&(a.colors===m&&(a.colors=[]),a.colors.push([y,n])),u&&(a.uvs===m&&(a.uvs=[]),a.uvs.push([y,n])),a.elements===m&&(a.elements=[]),a.elements[e]===m&&
(a.elements[e]=[]),a.elements[e][f]===m&&(a.elements[e][f]=[]),a.elements[e][f].push(r),q[C]===m&&(q[C]=[]),q[C].push([y,n,r]),r++)}}}if(this.edges){a.line_elements=[];e=0;for(D=this.edges.length;e<D;e++)g=this.edges[e],o=g[0],n=g[1],c=g[2],g=g[3],a.line_elements[o]=a.line_elements[o]||[],a.line_elements[o][n]=a.line_elements[o][n]||[],a.line_elements[o][n].push(q[c][0][2]),a.line_elements[o][n].push(q[g][0][2])}a.dynamic=this.dynamic;return a},compileVBO:function(c,g,d,a,b,e,f,o){"object"==typeof g?
(g=g.element!==m?g.element:!0,d=g.vertex!==m?g.vertex:!0,e=g.color!==m?g.color:!0,a=g.normal!==m?g.normal:!0,b=g.uv!==m?g.uv:!0,f=g.lines!==m?g.lines:!!c.line_elements,o=g.dynamic!==m?g.dynamic:c.dynamic):(g===m&&(g=!0),d===m&&(d=!0),e===m&&(e=!0),a===m&&(a=!0),b===m&&(b=!0),f===m&&(f=!!c.line_elements),o===m&&(o=c.dynamic));var n={},s,h,w,t,q,r,u,F,v;s=c.points.length||c.uvs.length||c.normals.length||c.colors.length;var y=65535<s;o&&(v={points:y?new Uint32Array(c.points.length):new Uint16Array(c.points.length),
face_points:y?new Uint32Array(2*c.points.length):new Uint16Array(2*c.points.length),segments:null},n.dynamicMap=v,n.dynamic=!0);if(d=c.points&&d){n.vbo_points=new Float32Array(3*s);t=0;for(r=s;t<r;t++)w=c.points[t],n.vbo_points[3*t]=this.points[w][0],n.vbo_points[3*t+1]=this.points[w][1],n.vbo_points[3*t+2]=this.points[w][2],o&&(v.points[t]=w)}if(o){h=c.normals||c.colors||c.uvs;t=0;for(r=h.length;t<r;t++)w=h[t],v.face_points[2*t]=w[0],v.face_points[2*t+1]=w[1]}if(a=c.normals&&a){n.vbo_normals=new Float32Array(3*
s);t=h=0;for(r=s;t<r;t++)w=c.normals[t],n.vbo_normals[h++]=this.faces[w[0]].point_normals[w[1]][0],n.vbo_normals[h++]=this.faces[w[0]].point_normals[w[1]][1],n.vbo_normals[h++]=this.faces[w[0]].point_normals[w[1]][2]}if(e=c.colors&&e){n.vbo_colors=new Float32Array(3*s);t=h=0;for(r=s;t<r;t++)w=c.colors[t],n.vbo_colors[h++]=this.faces[w[0]].point_colors[w[1]][0],n.vbo_colors[h++]=this.faces[w[0]].point_colors[w[1]][1],n.vbo_colors[h++]=this.faces[w[0]].point_colors[w[1]][2]}if(b=c.uvs&&b){s=c.uvs.length;
n.vbo_uvs=new Float32Array(2*s);t=h=0;for(r=s;t<r;t++)w=c.uvs[t],n.vbo_uvs[h++]=this.faces[w[0]].uvs[w[1]][0],n.vbo_uvs[h++]=this.faces[w[0]].uvs[w[1]][1]}s=[];w=0;if(g){n.elements_ref=[];n.vbo_elements=[];t=0;for(r=c.elements.length;t<r;t++)for(q in n.elements_ref[t]=[],g=0,c.elements[t])if(c.elements[t].hasOwnProperty(q)){F=c.elements[t][q];h=0;for(u=F.length;h<u;h++)s.push(F[h]);n.elements_ref[t][g]=[q|0,F.length|0];g++}w=s.length/3;y||(n.vbo_elements=new Uint16Array(s))}n.segments=c.segments;
n.bounds=c.bounds;if(f){if(y){if(n.vbo_lines=[],a&&(n.vbo_line_normals=[]),b&&(n.vbo_line_uvs=[]),e)n.vbo_line_colors=[]}else n.vbo_line_elements=[];n.line_elements_ref=[];t=0;for(r=c.line_elements.length;t<r;t++)for(q in n.line_elements_ref[t]=[],g=0,c.line_elements[t])if(c.line_elements[t].hasOwnProperty(q)){F=c.line_elements[t][q];h=0;for(u=F.length;h<u;h++)if(y){if(f=F[h],n.vbo_lines.push(n.vbo_points[3*f]),n.vbo_lines.push(n.vbo_points[3*f+1]),n.vbo_lines.push(n.vbo_points[3*f+2]),a&&(n.vbo_line_normals.push(n.vbo_normals[3*
f]),n.vbo_line_normals.push(n.vbo_normals[3*f+1]),n.vbo_line_normals.push(n.vbo_normals[3*f+2])),e&&(n.vbo_line_colors.push(n.vbo_colors[3*f]),n.vbo_line_colors.push(n.vbo_colors[3*f+1]),n.vbo_line_colors.push(n.vbo_colors[3*f+2])),b)n.vbo_line_uvs.push(n.vbo_uvs[2*f]),n.vbo_line_uvs.push(n.vbo_uvs[2*f+1])}else n.vbo_line_elements.push(F[h]);n.line_elements_ref[t][g]=[q|0,F.length|0];g++}if(y){if(n.vbo_lines=new Float32Array(n.vbo_lines),a&&(n.vbo_line_normals=new Float32Array(n.vbo_line_normals)),
b&&(n.vbo_line_uvs=new Float32Array(n.vbo_line_uvs)),e)n.vbo_line_colors=new Float32Array(n.vbo_line_colors)}else n.vbo_line_elements=new Uint16Array(n.vbo_line_elements)}if(y){console.log("Mesh "+(this.name?this.name+" ":"")+"exceeded element index limit -- unrolling "+w+" triangles..");var C,z,x,H;d&&(C=new Float32Array(9*w));a&&(z=new Float32Array(9*w));b&&(x=new Float32Array(6*w));e&&(H=new Float32Array(9*w));var I,J;o&&(I=new Uint32Array(6*w),J=new Uint32Array(3*w));t=0;for(r=w;t<r;t++)if(q=
9*t,y=3*s[3*t],f=3*s[3*t+1],w=3*s[3*t+2],o&&(g=3*t,h=2*g,I[h]=v.face_points[2*s[g]],I[h+1]=v.face_points[2*s[g]+1],I[h+2]=v.face_points[2*s[g+1]],I[h+3]=v.face_points[2*s[g+1]+1],I[h+4]=v.face_points[2*s[g+2]],I[h+5]=v.face_points[2*s[g+2]+1],J[g]=v.points[s[g]],J[g+1]=v.points[s[g+1]],J[g+2]=v.points[s[g+2]]),d&&(C[q]=n.vbo_points[y],C[q+1]=n.vbo_points[y+1],C[q+2]=n.vbo_points[y+2],C[q+3]=n.vbo_points[f],C[q+4]=n.vbo_points[f+1],C[q+5]=n.vbo_points[f+2],C[q+6]=n.vbo_points[w],C[q+7]=n.vbo_points[w+
1],C[q+8]=n.vbo_points[w+2]),a&&(z[q]=n.vbo_normals[y],z[q+1]=n.vbo_normals[y+1],z[q+2]=n.vbo_normals[y+2],z[q+3]=n.vbo_normals[f],z[q+4]=n.vbo_normals[f+1],z[q+5]=n.vbo_normals[f+2],z[q+6]=n.vbo_normals[w],z[q+7]=n.vbo_normals[w+1],z[q+8]=n.vbo_normals[w+2]),b&&(g=2*s[3*t],h=2*s[3*t+1],u=2*s[3*t+2],x[6*t]=n.vbo_uvs[g],x[6*t+1]=n.vbo_uvs[g+1],x[6*t+2]=n.vbo_uvs[h],x[6*t+3]=n.vbo_uvs[h+1],x[6*t+4]=n.vbo_uvs[u],x[6*t+5]=n.vbo_uvs[u+1]),e)H[q]=n.vbo_colors[y],H[q+1]=n.vbo_colors[y+1],H[q+2]=n.vbo_colors[y+
2],H[q+3]=n.vbo_colors[f],H[q+4]=n.vbo_colors[f+1],H[q+5]=n.vbo_colors[f+2],H[q+6]=n.vbo_colors[w],H[q+7]=n.vbo_colors[w+1],H[q+8]=n.vbo_colors[w+2];d&&(n.vbo_points=C);a&&(n.vbo_normals=z);b&&(n.vbo_uvs=x);e&&(n.vbo_colors=H);o&&(delete v.points,delete v.face_points,v.points=J,v.face_points=I);n.unrolled=!0}else n.unrolled=!1;if(o&&1<c.segments.length){c=[];h=v.points;t=0;for(r=h.length;t<r;t++)d=this.faces[v.face_points[2*t]].segment||0,c[d]===m&&(c[d]=[]),c[d].push(t);n.dynamicMap.segmentMap=c}return n},
updateVBO:function(c,g){if(!c.dynamic)return!1;var d,a,b=c.dynamicMap,e=g.points&&!!c.vbo_points,f=g.normals&&!!c.vbo_normals,o=g.uvs&&!!c.vbo_uvs,n=g.colors&&!!c.vbo_colors;a=g.segments;var s,h,w;if(g.segments!==m)for(var t=0,q=a.length;t<q;t++)for(var r=b.segmentMap[a[t]],u=0,F=r.length;u<F;u++){if(d=r[u],h=this.faces[b.face_points[2*d]],w=b.face_points[2*d+1],e&&(s=this.points[b.points[d]],c.vbo_points[3*d]=s[0],c.vbo_points[3*d+1]=s[1],c.vbo_points[3*d+2]=s[2]),f&&(s=h.point_normals[w],c.vbo_normals[3*
d]=s[0],c.vbo_normals[3*d+1]=s[1],c.vbo_normals[3*d+2]=s[2]),n&&(s=h.point_colors[w],c.vbo_colors[3*d]=s[0],c.vbo_colors[3*d+1]=s[1],c.vbo_colors[3*d+2]=s[2]),o)s=h.uvs[w],c.vbo_uvs[2*d]=s[0],c.vbo_uvs[2*d+1]=s[1]}else{d=0;for(a=b.points.length;d<a;d++){h=this.faces[b.face_points[2*d]];w=b.face_points[2*d+1];if(!h){console.log(b.face_points[2*d]);return}e&&(s=this.points[b.points[d]],c.vbo_points[3*d]=s[0],c.vbo_points[3*d+1]=s[1],c.vbo_points[3*d+2]=s[2]);f&&(s=h.point_normals[w],c.vbo_normals[3*
d]=s[0],c.vbo_normals[3*d+1]=s[1],c.vbo_normals[3*d+2]=s[2]);n&&(s=h.point_colors[w],c.vbo_colors[3*d]=s[0],c.vbo_colors[3*d+1]=s[1],c.vbo_colors[3*d+2]=s[2]);o&&(s=h.uvs[w],c.vbo_uvs[2*d]=s[0],c.vbo_uvs[2*d+1]=s[1])}}return this},rebufferVBO:function(c,g,d){var a=q.gl;d.points&&(a.bindBuffer(a.ARRAY_BUFFER,g.gl_points),a.bufferData(a.ARRAY_BUFFER,c.vbo_points,a.DYNAMIC_DRAW));d.normals&&c.vbo_normals&&(a.bindBuffer(a.ARRAY_BUFFER,g.gl_normals),a.bufferData(a.ARRAY_BUFFER,c.vbo_normals,a.DYNAMIC_DRAW));
d.uvs&&c.vbo_uvs&&(a.bindBuffer(a.ARRAY_BUFFER,g.gl_uvs),a.bufferData(a.ARRAY_BUFFER,c.vbo_uvs,a.DYNAMIC_DRAW));d.colors&&c.vbo_colors&&(a.bindBuffer(a.ARRAY_BUFFER,g.gl_colors),a.bufferData(a.ARRAY_BUFFER,c.vbo_colors,a.DYNAMIC_DRAW));a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(c,g){var d=q.gl,a={};g===m&&(g={});a.gl_points=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,a.gl_points);d.bufferData(d.ARRAY_BUFFER,c.vbo_points,d.STATIC_DRAW);c.vbo_normals?(a.gl_normals=d.createBuffer(),
d.bindBuffer(d.ARRAY_BUFFER,a.gl_normals),d.bufferData(d.ARRAY_BUFFER,c.vbo_normals,d.STATIC_DRAW)):a.gl_normals=g.gl_normals?g.gl_normals:null;c.vbo_uvs?(a.gl_uvs=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,a.gl_uvs),d.bufferData(d.ARRAY_BUFFER,c.vbo_uvs,d.STATIC_DRAW)):a.gl_uvs=g.gl_uvs?g.gl_uvs:null;c.vbo_colors?(a.gl_colors=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,a.gl_colors),d.bufferData(d.ARRAY_BUFFER,c.vbo_colors,d.STATIC_DRAW)):a.gl_colors=g.gl_colors?g.gl_colors:null;!c.vbo_elements&&
g.gl_elements?(a.gl_elements=g.gl_elements,a.elements_ref=g.elements_ref):(c.vbo_elements.length&&(a.gl_elements=d.createBuffer(),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.gl_elements),d.bufferData(d.ELEMENT_ARRAY_BUFFER,c.vbo_elements,d.STATIC_DRAW)),a.elements_ref=c.elements_ref);!c.vbo_line_elements&&g.gl_line_elements?(a.gl_line_elements=g.gl_line_elements,a.line_elements_ref=g.line_elements_ref):c.vbo_line_elements&&(a.gl_line_elements=d.createBuffer(),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.gl_line_elements),
d.bufferData(d.ELEMENT_ARRAY_BUFFER,c.vbo_line_elements,d.STATIC_DRAW),a.line_elements_ref=c.line_elements_ref);!c.vbo_lines&&g.gl_lines?a.gl_lines=g.gl_lines:c.vbo_lines?(a.gl_lines=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,a.gl_lines),d.bufferData(d.ARRAY_BUFFER,c.vbo_lines,d.STATIC_DRAW),a.line_elements_ref=c.line_elements_ref):a.gl_lines=null;!c.vbo_line_colors&&g.gl_line_colors?a.gl_line_colors=g.gl_line_colors:c.vbo_line_colors?(a.gl_line_colors=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,
a.gl_line_colors),d.bufferData(d.ARRAY_BUFFER,c.vbo_line_colors,d.STATIC_DRAW)):a.gl_line_colors=null;!c.vbo_line_uvs&&g.gl_line_uvs?a.gl_line_uvs=g.gl_line_uvs:c.vbo_line_uvs?(a.gl_line_uvs=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,a.gl_line_uvs),d.bufferData(d.ARRAY_BUFFER,c.vbo_line_uvs,d.STATIC_DRAW)):a.gl_line_uvs=null;!c.vbo_line_normals&&g.gl_line_normals?a.gl_line_normals=g.gl_line_normals:c.vbo_line_normals?(a.gl_line_normals=d.createBuffer(),d.bindBuffer(d.ARRAY_BUFFER,a.gl_line_normals),
d.bufferData(d.ARRAY_BUFFER,c.vbo_line_normals,d.STATIC_DRAW)):a.gl_line_normals=null;a.segments=c.segments;a.bounds=c.bounds;a.unrolled=c.unrolled;d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return a},update:function(c){var c=c||{},g=!0;c.points!==m&&(g=c.points);var d=c.uvs||c.uv||c.texture||c.all||!1,a=!0;c.normals!==m&&(a=c.normals);var b=c.colors||c.color||c.all||!1,c=c.segments||c.segment;c!==m&&c.length===m&&(c=[c]);if(!this.dynamic)return r("Mesh not defined as dynamic, cannot update."),!1;
a&&this.normalMapRef&&this.recalcNormals(m,{segments:c});g={points:g,uvs:d,normals:a,colors:b,segments:c};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,g)},bindBuffer:function(c){null===this.originBuffer&&(this.originBuffer=c);this.compiled=c;this.segment_state=[];for(var g=0,d=c.segments.length;g<d;g++)this.segment_state[c.segments[g]]=!0;this.bb=c.bounds},compile:function(c){if(0<this.faces.length&&0<this.points.length){var c=this.compileVBO(this.compileMap(c)),
g=this.bufferVBO(c);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var d=0,a=this.points.length;d<a;d++)this.sourcePoints[d]=this.points[d].slice(0);this.dynamicData={VBO:c,buffer:g}}}return this},addMorphTarget:function(c){null===this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(c)},setMorphSource:function(c){this.morphSourceIndex!==c&&(this.morphSourceIndex=c,this.bindBuffer(this.morphTargets[c]))},setMorphTarget:function(c){this.morphTargetIndex!==c&&(this.morphTargetIndex=
c,this.morphTarget=this.morphTargets[c])},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:u,Face:x}});
CubicVR.RegisterModule("UVMapper",function(h){function x(d){d=h.get(d)||{};this.rotation=d.rotation===u?[0,0,0]:d.rotation;this.scale=d.scale===u?[1,1,1]:d.scale;this.center=d.center===u?[0,0,0]:d.center;this.projection_mode=d.projectionMode===u?m.uv.projection.PLANAR:h.parseEnum(m.uv.projection,d.projectionMode);this.projection_axis=d.projectionAxis===u?m.uv.axis.X:h.parseEnum(m.uv.axis,d.projectionAxis);this.wrap_w_count=d.wrapW===u?1:d.wrapW;this.wrap_h_count=d.wrapH===u?1:d.wrapH}var u=h.undef,
m=h.enums,q=2*Math.PI,r=Math.PI/2;m.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var c=function(d,a,b){return 0===d&&0===b?0:0===b?0>d?r:-r:0>b?-Math.atan(d/b)+Math.PI:-Math.atan(d/b)},g=function(d,a,b){var e;0===d&&0===b?(e=0,d=0!==a?0>a?-r:r:0):(e=0===b?0>d?r:-r:0>b?-Math.atan(d/b)+Math.PI:-Math.atan(d/b),d=Math.sqrt(d*d+b*b),d=0===d?0>a?-r:r:Math.atan(a/d));return[e,d]};x.prototype={setRotation:function(d){this.rotation=d},setScale:function(d){this.scale=
d},setCenter:function(d){this.center=d},setProjectionAxis:function(d){this.projection_axis=d},setProjectionMode:function(d){this.projection_mode=d},setWrapW:function(d){this.wrap_w_count=d},setWrapH:function(d){this.wrap_h_count=d},apply:function(d,a,b,e,f){var o=h.mat4,n,s,D,w,t,B=new h.Transform,A=!1,E=null;if(this.center[0]||this.center[1]||this.center[2])B.translate(-this.center[0],-this.center[1],-this.center[2]),A=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
B.rotate(this.rotation[2],0,0,1),this.rotation[1]&&B.rotate(this.rotation[1],0,1,0),this.rotation[2]&&B.rotate(this.rotation[0],1,0,0),A=!0;A&&(E=B.getResult());"object"===typeof a&&(a=d.materials.indexOf(a));var B=0,F=d.faces.length;e&&(B=e);for(f&&(F=f+1);B<F;B++)if(d.faces[B].material===a&&!(b!==u&&d.faces[B].segment!==b)){var v,y,C;if(this.projection_mode===m.uv.projection.CUBIC||this.projection_mode===m.uv.projection.SKY)v=Math.abs(d.faces[B].normal[0]),y=Math.abs(d.faces[B].normal[1]),C=Math.abs(d.faces[B].normal[2]);
for(var e=[],f=0,z=d.faces[B].points.length;f<z;f++){s=d.faces[B].points[f];var x=d.faces[B].points[(f+1)%3],H=d.faces[B].points[(f+2)%3];n=d.points[s];var I=d.points[x],J=d.points[H],L;A&&(n=o.vec3_multiply(n,E));L=this.projection_mode;if(L===m.uv.projection.SKY)s=d.sky_mapping,v>=y&&v>=C&&(D=n[2]/this.scale[2]+this.scale[2]/2,w=-n[1]/this.scale[1]+this.scale[1]/2,0>d.faces[B].normal[0]?(D=(s[2][2]-s[2][0])*(1-D),w=1-(s[2][3]-s[2][1])*w,D+=s[2][0],w+=s[2][1]):(D*=s[3][2]-s[3][0],w=1-(s[3][3]-s[3][1])*
w,D+=s[3][0],w+=s[3][1])),y>=v&&y>=C&&(D=n[0]/this.scale[0]+this.scale[0]/2,w=-n[2]/this.scale[2]+this.scale[2]/2,0>d.faces[B].normal[1]?(D*=s[1][2]-s[1][0],w=1-(s[1][3]-s[1][1])*w,D+=s[1][0],w-=s[1][1]):(D*=s[0][2]-s[0][0],w=1-(s[0][3]-s[0][1])*w,D+=s[0][0],w-=s[0][1])),C>=v&&C>=y&&(D=n[0]/this.scale[0]+this.scale[0]/2,w=n[1]/this.scale[1]+this.scale[1]/2,0>d.faces[B].normal[2]?(D*=s[4][2]-s[4][0],w=1-(s[4][3]-s[4][1])*(1-w),D+=s[4][0],w-=s[4][1]):(D=(s[5][2]-s[5][0])*(1-D),w=1-(s[5][3]-s[5][1])*
(1-w),D+=s[5][0],w+=s[5][1])),d.faces[B].setUV([D,w],f);else if(L===m.uv.projection.CUBIC)v>=y&&v>=C&&(D=n[2]/this.scale[2]+0.5,w=n[1]/this.scale[1]+0.5),y>=v&&y>=C&&(D=-n[0]/this.scale[0]+0.5,w=n[2]/this.scale[2]+0.5),C>=v&&C>=y&&(D=-n[0]/this.scale[0]+0.5,w=n[1]/this.scale[1]+0.5),0<d.faces[B].normal[0]&&(D=-D),0>d.faces[B].normal[1]&&(D=-D),0<d.faces[B].normal[2]&&(D=-D),d.faces[B].setUV([D,w],f);else if(L===m.uv.projection.PLANAR)D=this.projection_axis===m.uv.axis.X?n[2]/this.scale[2]+0.5:-n[0]/
this.scale[0]+0.5,w=this.projection_axis===m.uv.axis.Y?n[2]/this.scale[2]+0.5:n[1]/this.scale[1]+0.5,d.faces[B].setUV([D,w],f);else{if(L===m.uv.projection.CYLINDRICAL)L=this.projection_axis,L===m.uv.axis.X?(t=c(n[2],n[0],-n[1]),w=-n[0]/this.scale[0]+0.5):L===m.uv.axis.Y?(t=c(-n[0],n[1],n[2]),w=-n[1]/this.scale[1]+0.5):L===m.uv.axis.Z&&(t=c(-n[0],n[2],-n[1]),w=-n[2]/this.scale[2]+0.5),t=1-t/q,1!==this.wrap_w_count&&(t*=this.wrap_w_count),n=t,s=w;else if(L===m.uv.projection.SPHERICAL){var M,K,N;L=this.projection_axis;
L===m.uv.axis.X?(M=e[s]?e[s]:g(n[2],n[0],-n[1]),e[s]||(e[s]=M),K=e[x]?e[x]:g(I[2],I[0],-I[1]),e[x]||(e[x]=K),N=e[H]?e[H]:g(J[2],J[0],-J[1]),e[H]||(e[H]=N)):L===m.uv.axis.Y?(M=e[s]?e[s]:g(n[0],-n[1],n[2]),e[s]||(e[s]=M),K=e[x]?e[x]:g(I[0],-I[1],I[2]),e[x]||(e[x]=K),N=e[H]?e[H]:g(J[0],-J[1],J[2]),e[H]||(e[H]=N)):L===m.uv.axis.Z&&(M=e[s]?e[s]:g(-n[0],n[2],-n[1]),e[s]||(e[s]=M),K=e[x]?e[x]:g(-I[0],I[2],-I[1]),e[x]||(e[x]=K),N=e[H]?e[H]:g(-J[0],J[2],-J[1]),e[H]||(e[H]=N));Math.abs(M[0]-K[0])>r&&Math.abs(M[0]-
N[0])>r&&(M[0]=M[0]>K[0]&&M[0]>N[0]?M[0]-q:M[0]+q);Math.abs(M[1]-K[1])>r&&Math.abs(M[1]-N[1])>r&&(M[1]=M[1]>K[1]&&M[1]>N[1]?M[1]-q:M[1]+q);t=1-M[0]/q;s=0.5-M[1]/Math.PI;1!==this.wrap_w_count&&(t*=this.wrap_w_count);1!==this.wrap_h_count&&(s*=this.wrap_h_count);n=t}else s=n=0;d.faces[B].setUV([n,s],f)}}}return this}};return{UVMapper:x}});
CubicVR.RegisterModule("Renderer",function(h){var x=h.undef;return{renderObject:function(u,m,q,r,c,g,d){var a=!1,c=c||!1,g=g||!1;if(null!==u.compiled){var b=0,e=h.GLCore.gl,f,o=r===x?0:r.length,n,s=0,D,w=null,t=u.instanceMaterials||u.materials,B=(d=(u.wireframe||d)&&u.compiled.line_elements_ref)?u.compiled.line_elements_ref:u.compiled.elements_ref,A=!1,E,F,v;e.depthFunc(e.LEQUAL);q===x&&(q=cubicvr_identity);for(var y=0,C=B.length;y<C;y++){var w=d&&u.wireframeMaterial?u.wireframeMaterial:t[y],z=0,
s=!1;if(1>w.opacity&&c)a=!0;else if(!(g&&1<=w.opacity)){1!==w.opacity?(e.enable(e.BLEND),e.depthMask(0),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA)):(e.depthMask(1),e.disable(e.BLEND),e.blendFunc(e.ONE,e.ONE));for(var G=0,H=B[y].length;G<H;G++)if(D=B[y][G][0],s=!1,f=B[y][G][1],z+=f,w.visible){if(!u.segment_state[D])if(z>f){b+=2*f;z-=f;if(o){F=!1;for(E=0;E<o;){f=o-E;f>h.MAX_LIGHTS&&(f=h.MAX_LIGHTS);0<E&&!F&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),F=!0);n=r[E];v=n.light_type;
for(s=0;s<f;s++)if(r[s+E].light_type!=v){f=s;break}w.use(n.light_type,f);n=w.shader[n.light_type][f];e.uniformMatrix4fv(n.matrixModelView,!1,m.mvMatrix);e.uniformMatrix4fv(n.matrixProjection,!1,m.pMatrix);e.uniformMatrix4fv(n.matrixObject,!1,q);e.uniformMatrix3fv(n.matrixNormal,!1,m.nMatrix);A||(w.bindObject(u,n),A=-1!=n.vertexTexCoord,d&&w.bindLines(u,n));for(s=0;s<f;s++)r[s+E].setupShader(n,s);d?u.compiled.unrolled?e.drawArrays(e.LINES,b,z):e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,b):u.compiled.unrolled?
e.drawArrays(e.TRIANGLES,b,z):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,b);E+=f}F&&(e.disable(e.BLEND),e.depthFunc(e.LEQUAL))}else w.use(0,0),e.uniformMatrix4fv(w.shader[0][0].matrixModelView,!1,m.mvMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixProjection,!1,m.pMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixObject,!1,q),e.uniformMatrix3fv(w.shader[0][0].matrixNormal,!1,m.nMatrix),A||(w.bindObject(u,w.shader[0][0]),A=-1!=w.shader[0][0].vertexTexCoord,d&&w.bindLines(u,w.shader[0][0])),d?u.compiled.unrolled?
e.drawArrays(e.LINES,b,z):e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,b):u.compiled.unrolled?e.drawArrays(e.TRIANGLES,b,z):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,b);b+=2*z;z=0;s=!0}else b+=2*z,z=0}else b+=2*f,z-=f;if(!s&&u.segment_state[D]&&w.visible){if(o){F=!1;for(E=0;E<o;){f=o-E;f>h.MAX_LIGHTS&&(f=h.MAX_LIGHTS);0<E&&!F&&(e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE),e.depthFunc(e.EQUAL),F=!0);n=r[E];v=n.light_type;for(s=0;s<f;s++)if(r[s+E].light_type!=v){f=s;break}w.use(n.light_type,f);n=w.shader[n.light_type][f];
e.uniformMatrix4fv(n.matrixModelView,!1,m.mvMatrix);e.uniformMatrix4fv(n.matrixProjection,!1,m.pMatrix);e.uniformMatrix4fv(n.matrixObject,!1,q);e.uniformMatrix3fv(n.matrixNormal,!1,m.nMatrix);A||(w.bindObject(u,n),A=-1!=n.vertexTexCoord,d&&w.bindLines(u,n));for(s=0;s<f;s++)r[s+E].setupShader(n,s);d?u.compiled.unrolled?e.drawArrays(e.LINES,b,z):e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,b):u.compiled.unrolled?e.drawArrays(e.TRIANGLES,b,z):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,b);E+=f}F&&(e.disable(e.BLEND),
e.depthFunc(e.LEQUAL))}else w.use(0,0),e.uniformMatrix4fv(w.shader[0][0].matrixModelView,!1,m.mvMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixProjection,!1,m.pMatrix),e.uniformMatrix4fv(w.shader[0][0].matrixObject,!1,q),e.uniformMatrix3fv(w.shader[0][0].matrixNormal,!1,m.nMatrix),A||(w.bindObject(u,w.shader[0][0]),A=-1!=w.shader[0][0].vertexTexCoord,d&&w.bindLines(u,w.shader[0][0])),d?u.compiled.unrolled?e.drawArrays(e.LINES,b,z):e.drawElements(e.LINES,z,e.UNSIGNED_SHORT,b):u.compiled.unrolled?
e.drawArrays(e.TRIANGLES,b,z):e.drawElements(e.TRIANGLES,z,e.UNSIGNED_SHORT,b);b+=2*z}}}w&&n?w.clearObject(u,n):w.clearObject(u,null);e.depthMask(1);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return a}}}});
CubicVR.RegisterModule("Light",function(h){function x(c,g){var d=h.aabb,c=h.get(c)||{};c===q&&(c=m.light.type.POINT);g===q&&(g=m.light.method.DYNAMIC);"object"==typeof c?(this.light_type=c.type!==q?h.parseEnum(m.light.type,c.type):m.light.type.POINT,this.diffuse=c.diffuse!==q?c.diffuse:[1,1,1],this.specular=c.specular!==q?c.specular:[1,1,1],this.intensity=c.intensity!==q?c.intensity:1,this.position=c.position!==q?c.position:[0,0,0],this.direction=c.direction!==q?c.direction:[0,0,0],this.distance=
c.distance!==q?c.distance:this.light_type===m.light.type.AREA?30:10,this.cutoff=c.cutoff!==q?c.cutoff:60,this.map_res=c.map_res!==q?c.map_res:this.light_type===m.light.type.AREA?2048:512,this.map_res=c.mapRes!==q?c.mapRes:this.map_res,this.method=c.method!==q?h.parseEnum(m.light.method,c.method):g,this.areaCam=c.areaCam!==q?c.areaCam:null,this.areaCeiling=c.areaCeiling!==q?c.areaCeiling:40,this.areaFloor=c.areaFloor!==q?c.areaFloor:-40,this.areaAxis=c.areaAxis!==q?c.areaAxis:[1,1,0],this.projectorTex=
c.projector!==q?c.projector:null):(this.light_type=h.parseEnum(m.light.type,c),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===m.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===m.light.type.AREA?2048:512,this.method=h.parseEnum(m.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&"string"===typeof this.projectorTex){var a=
this.projectorTex;this.projectorTex=h.Textures_ref[a]!==q?h.Textures_obj[h.Textures_ref[a]]:new h.Texture(a)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];d.reset(this.aabb,this.position);this.adjust_octree=h.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===
m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA&&h.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var u=h.GLCore,m=h.enums,q=h.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];m.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};x.prototype={get x(){return this.position[0]},set x(c){this.position[0]=
c},get y(){return this.position[1]},set y(c){this.position[1]=c},get z(){return this.position[2]},set z(c){this.position[2]=c},get rotX(){return this.rotation[0]},set rotX(c){this.rotation[0]=c},get rotY(){return this.rotation[1]},set rotY(c){this.rotation[1]=c},get rotZ(){return this.rotation[2]},set rotZ(c){this.rotation[2]=c},get dirX(){return this.direction[0]},set dirX(c){this.direction[0]=c},get dirY(){return this.direction[1]},set dirY(c){this.direction[1]=c},get dirZ(){return this.direction[2]},
set dirZ(c){this.direction[2]=c},get pos(){return this.position.slice(0)},set pos(c){this.position=c.slice(0)},get rot(){return this.rotation.slice(0)},set rot(c){this.rotation=c.slice(0)},get dir(){return this.direction.slice(0)},set dir(c){this.direction=vec3.normalize(c.slice(0))},setType:function(c){if(c===m.light.type.AREA&&!h.features.lightShadows)this.dummyCam=new h.Camera,this.areaCam=new h.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=m.light.type.DIRECTIONAL;else if((c===
m.light.type.SPOT_SHADOW||c===m.light.type.SPOT_SHADOW_PROJECTOR)&&!h.features.lightShadows)c=m.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=c},setIntensity:function(c){this.intensity=c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var g=h.mat4,d=h.mat3,a=this.light_type;
this.parent?a===m.light.type.SPOT||a===m.light.type.SPOT_SHADOW||a===m.light.type.SPOT_SHADOW_PROJECTOR?(a=g.inverse_mat3(this.parent.tMatrix),d.transpose_inline(a),this.lDir=d.vec3_multiply(this.direction,a),this.lDir=d.vec3_multiply(this.lDir,c.nMatrix),this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))):a===m.light.type.POINT&&(this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))):a===m.light.type.DIRECTIONAL?this.lDir=d.vec3_multiply(this.direction,
c.nMatrix):a===m.light.type.SPOT||a===m.light.type.SPOT_SHADOW||a===m.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=d.vec3_multiply(this.direction,c.nMatrix),this.lPos=g.vec3_multiply(this.position,c.mvMatrix)):a===m.light.type.POINT?this.lPos=g.vec3_multiply(this.position,c.mvMatrix):a===m.light.type.AREA&&(this.lDir=d.vec3_multiply(this.direction,c.nMatrix))},control:function(c,g,d){c===m.motion.POS?this.position[g]=d:c===m.motion.INTENSITY&&(this.intensity=d)},getAABB:function(){var c=h.vec3,g=h.aabb,
d=[[0,0,0],[0,0,0]];g.engulf(d,[this.distance,this.distance,this.distance]);g.engulf(d,[-this.distance,-this.distance,-this.distance]);d[0]=c.add(d[0],this.position);d[1]=c.add(d[1],this.position);return this.aabb=d},setDirection:function(c,g,d){var a=h.vec3;if("object"===typeof c)this.setDirection(c[0],c[1],c[2]);else return this.direction=a.normalize([c,g,d]),this},lookat:function(c,g,d){var a=h.vec3;if("object"===typeof c)this.lookat(c[0],c[1],c[2]);else return this.direction=a.normalize(a.subtract([c,
g,d],this.position)),this},setRotation:function(c,g,d){var a=h.mat4,b=h.vec3;if("object"===typeof c)this.setRotation(c[0],c[1],c[2]);else{var e=new h.Transform;e.rotate([-c,-g,-d]);e.pushMatrix();this.direction=b.normalize(a.vec3_multiply([1,0,0],e.getResult()));this.rotation=[c,g,d];return this}},setupShader:function(c,g){var d=u.gl;d.uniform3fv(c.lightDiffuse[g],this.diffuse);d.uniform3fv(c.lightSpecular[g],this.specular);this.lPos&&d.uniform3fv(c.lightPosition[g],this.lPos);this.lDir&&d.uniform3fv(c.lightDirection[g],
this.lDir);d.uniform1f(c.lightIntensity[g],this.intensity);d.uniform1f(c.lightDistance[g],this.distance);(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.SPOT)&&d.uniform1f(c.lightCutOffAngle[g],this.cutoff);if(this.light_type===m.light.type.SPOT_SHADOW||this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===m.light.type.AREA)this.light_type===m.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(u.gl.TEXTURE0+
2*g),d.uniform1i(c.lightShadowMap[g],2*g),this.projectorTex.use(u.gl.TEXTURE0+2*g+1),d.uniform1i(c.lightProjectionMap[g],2*g+1)):(this.shadowMapTex.texture.use(u.gl.TEXTURE0+g),d.uniform1i(c.lightShadowMap[g],g)),d.uniform3fv(c.lightDepthClip[g],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),d.uniformMatrix4fv(c.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(c){h.features.lightShadows&&(this.map_res=c,this.shadowMapTex=new h.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(m.texture.filter.NEAREST),
this.dummyCam=new h.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(c){this.projectorTex=c},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var c=u.gl,g=h.mat4,d=h.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==m.light.type.AREA?
(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var a=g.inverse_mat3(this.parent.tMatrix);d.transpose_inline(a);d.vec3_multiply(this.direction,a);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),
g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=u.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var c=h.mat4;this.spMatrix=c.multiply(r,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=
c.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=h.vec3,g=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var d=0,d=Math.tan(this.areaCam.fov/2*(Math.PI/180)),a=c.subtract(this.areaCam.target,this.areaCam.position);a[1]=0;a=c.normalize(a);c.normalize(c.cross(a,[0,1,0]));var b=-Math.atan2(a[2],a[0]),d=this.distance/2*Math.abs(d)-
this.distance/2;d<this.distance/3/2&&(d=this.distance/3/2);var a=c.multiply(a,d),d=this.areaAxis[1]*(Math.PI/180),e=Math.tan(this.areaAxis[0]*(Math.PI/180)),d=[Math.tan(d),0,e],b=b-Math.atan2(d[0],d[2]);this.position=c.add(c.add(this.areaCam.position,a),c.multiply(d,g));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,a),c.multiply(d,-g));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=b*(180/
Math.PI);c=this.dummyCam.farclip*Math.abs(this.direction[1])*g;g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);g[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);g[1][1]>this.areaFloor&&(g=g[1][1]-this.areaFloor,c+=g/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=
c;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(c,g,d,a,b,e){var a=h.vec3,f=a.normalize([b[0],b[4],b[8]]),o=a.normalize([b[1],b[5],b[9]]),b=a.normalize(a.cross(o,f)),n;n=d/2;d=[];g=a.multiply(f,g/2);f=a.multiply(o,n);e=a.multiply(b,e);d[0]=a.add(a.subtract(c,g),a.add(f,e));d[1]=a.add(a.add(c,g),a.add(f,e));d[2]=a.subtract(a.subtract(c,g),a.add(f,e));d[3]=a.subtract(a.add(c,g),a.add(f,e));aabb1=d[0];aabb2=d[0];for(c=1;4>c;c++)aabb1[0]>
d[c][0]&&(aabb1[0]=d[c][0]),aabb1[1]>d[c][1]&&(aabb1[1]=d[c][1]),aabb1[2]>d[c][2]&&(aabb1[2]=d[c][2]),aabb2[0]<d[c][0]&&(aabb2[0]=d[c][0]),aabb2[1]<d[c][1]&&(aabb2[1]=d[c][1]),aabb2[2]<d[c][2]&&(aabb2[2]=d[c][2]);return[aabb1,aabb2]}};return{Light:x}});
CubicVR.RegisterModule("Camera",function(h){function x(d,a,b,e,f){var c=h.mat4;this.frustum=new h.Frustum;"object"==typeof d?(this.position=d.position||[0,0,-1],this.rotation=d.rotation||[0,0,0],this.target=d.target||[0,0,0],this.fov=d.fov||60,this.nearclip=d.nearclip||d.nearClip||d.near||0.1,this.farclip=d.farclip||d.farClip||d.far||400,this.targeted=d.targeted!==q?d.targeted:!0,this.calc_nmatrix=d.calcNormalMatrix!==q?d.calcNormalMatrix:!0,this.name=d.name||"camera"+g,a=d.height?d.height:q,d=d.width?
d.width:q):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=b!==q?b:60,this.nearclip=e!==q?e:0.1,this.farclip=f!==q?f:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new h.Transform;this.manual=!1;this.setDimensions(d!==q?d:512,a!==q?a:512);this.mvMatrix=c.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}function u(d){this.position=
d!==q?d:[0,0,0]}function m(d,a,b){this.camPath=new h.Motion;this.targetPath=new h.Motion;this.start_position=d!==q?d:[8,8,8];this.target=a!==q?a:[0,0,0];this.bounds=b!==q?b:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var q=h.undef,r=h.enums,c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=0;x.prototype={get x(){return this.position[0]},
set x(d){this.position[0]=d},get y(){return this.position[1]},set y(d){this.position[1]=d},get z(){return this.position[2]},set z(d){this.position[2]=d},get rotX(){return this.rotation[0]},set rotX(d){this.rotation[0]=d},get rotY(){return this.rotation[1]},set rotY(d){this.rotation[1]=d},get rotZ(){return this.rotation[2]},set rotZ(d){this.rotation[2]=d},get targetX(){return this.target[0]},set targetX(d){this.target[0]=d},get targetY(){return this.target[1]},set targetY(d){this.target[1]=d},get targetZ(){return this.target[2]},
set targetZ(d){this.target[2]=d},get pos(){return this.position.slice(0)},set pos(d){this.position=d.slice(0)},get rot(){return this.rotation.slice(0)},set rot(d){this.rotation=d.slice(0)},trackTarget:function(d,a,b){this.position=h.vec3.trackTarget(this.position,d,a,b)},setParent:function(d){this.parent=d},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?h.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(d,a,b,e){this.ortho=!0;this.ortho_view.left=d;this.ortho_view.right=a;this.ortho_view.bottom=b;this.ortho_view.top=e},control:function(d,a,b){d===r.motion.ROT?this.rotation[a]=b:d===r.motion.POS?this.position[a]=b:d===r.motion.FOV?this.setFOV(b):d===r.motion.LENS?this.setLENS(b):d===r.motion.NEARCLIP?this.setClip(b,this.farclip):d===r.motion.FARCLIP&&this.setClip(this.nearclip,b)},makeFrustum:function(d,a,b,e,f,c){return[2*f/(a-d),0,0,0,0,2*f/
(e-b),0,0,(a+d)/(a-d),(e+b)/(e-b),-(c+f)/(c-f),-1,0,0,-2*c*f/(c-f),0]},setTargeted:function(d){this.targeted=d},calcProjection:function(){var d=h.mat4,a=h.mat3;this.pMatrix=this.ortho?d.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):d.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(d.identity(this.mvMatrix),d.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
d.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&d.multiply(this.mvMatrix.slice(0),d.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=d.inverse_mat3(this.mvMatrix),a.transpose_inline(this.nMatrix)):d.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(d,a){this.nearclip=d;this.farclip=a;this.calcProjection()},setDimensions:function(d,a){this.width=d;this.height=a;this.aspect=d/a;this.calcProjection()},
setAspect:function(d){this.aspect=d;this.calcProjection()},resize:function(d,a){this.setDimensions(d,a)},setFOV:function(d){this.fov=d;this.ortho=!1;this.calcProjection()},setLENS:function(d){this.setFOV(2*Math.atan(16/d)*(180/Math.PI))},lookat:function(d,a,b,e,f,g,n,s,m){var w=h.mat4,t=h.mat3;"object"==typeof d?this.lookat(this.position[0],this.position[1],this.position[2],d[0],d[1],d[2],0,1,0):(this.mvMatrix=w.lookat(d,a,b,e,f,g,n,s,m),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],
0,0,1),this.transform.pushMatrix(this.mvMatrix),this.mvMatrix=this.transform.getResult()),null!==this.parent&&w.multiply(this.mvMatrix.slice(0),w.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=w.inverse_mat3(this.mvMatrix),t.transpose_inline(this.nMatrix)):this.nMatrix=c,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(d,a,b){var e=h.mat4,f=h.vec3,c=[0,0,this.width,this.height],d=e.vec4_multiply(e.vec4_multiply([2*((d-c[0])/c[2])-1,-(2*((a-c[1])/
c[3])-1),1,1],e.inverse(this.pMatrix)),e.inverse(this.mvMatrix)),d=[d[0]/d[3],d[1]/d[3],d[2]/d[3]];return b!==q?(a=this.getParentedPosition(),f.add(a,f.multiply(f.normalize(f.subtract(d,a)),b))):d},project:function(d,a,b){var e=h.mat4,e=e.vec4_multiply(e.vec4_multiply([d,a,b,1],this.mvMatrix),this.pMatrix);e[2]=h.vec3.length(h.vec3.subtract([d,a,b],this.position));return[(e[0]/e[3]+1)/2*this.width,(-e[1]/e[3]+1)/2*this.height,e[2]]}};u.prototype={control:function(d,a,b){d===r.motion.POS&&(this.position[a]=
b)}};m.prototype={inBounds:function(d){var a=h.vec3;if(!(d[0]>this.bounds[0][0]&&d[1]>this.bounds[0][1]&&d[2]>this.bounds[0][2]&&d[0]<this.bounds[1][0]&&d[1]<this.bounds[1][1]&&d[2]<this.bounds[1][2]))return!1;for(var b=0,e=this.avoid_sphere.length;b<e;b++)if(a.length(d,this.avoid_sphere[b][0])<this.avoid_sphere[b][1])return!1;return!0},findNextNode:function(d,a){var b=h.vec3,e=[0,0,0],f=[0,0,0],c=e=0,n=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=b.normalize(f),
e=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,e=b.add(a.position,b.multiply(f,e)),n=this.inBounds(e),c++,30<c){e=a.position;break}while(!n);return e},run:function(d){this.current_time=d;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,this.start_position[2]));
for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=this.segment_time;var a=new u,b=new u;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,a);this.camPath.apply(this.path_time-this.segment_time,b);a=this.findNextNode(a,b);this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,a[0]);this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,a[1]);this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,a[2]);this.path_length++}a=new u;this.camPath.apply(d,
a);return a.position},addSafeBound:function(d,a){this.safe_bb.push([d,a])},addAvoidSphere:function(d,a){this.avoid_sphere.push([d,a])}};return{Camera:x,AutoCamera:m}});
CubicVR.RegisterModule("Motion",function(h){function x(){this.time=this.value=0;this.shape=r.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function u(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(r.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||r.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||r.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=r.envelope.behavior.CONSTANT}function m(a,f){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var b=CubicVR.get(a);this.env_init=CubicVR.get(b.envelope);this.key_init=CubicVR.get(b.key);for(var d in b)if(b.hasOwnProperty(d)&&!("envelope"===d||"key"===d)){var c=b[d],g=CubicVR.get(c.envelope),m;for(m in c)if(c.hasOwnProperty(m)&&!("envelope"===m||"key"===m)){var t=c[m];if("object"===typeof t)for(var h in t)this.setKey(d,h,m,t[h]),g&&this.setBehavior(d,h,
g)}}}else this.env_init=a,this.key_init=f}var q=h.undef,r=CubicVR.enums;r.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};r.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var c=function(a,f,b){var d=0,d=b-f;if(0===d)return[f,0];f=a-d*Math.floor((a-f)/d);d=-parseInt((f-a)/d+(f>a?0.5:-0.5),10);return[f,d]},g=function(a,f,b,d,c){var g,m;m=c*c;g=3*(f-
a);f=3*(b-f)-g;return(d-a-g-f)*m*c+f*m+g*c+a},d=function(a,f,b,n,c,m,h){var t,q;q=m+0.5*(h-m);t=g(a,f,b,n,q);return 1.0E-4<Math.abs(c-t)?(t>c?h=q:m=q,d(a,f,b,n,c,m,h)):q},a=function(a,f){var b,d,c,g;a.shape===r.envelope.shape.TCB?(b=(1-a.tension)*(1+a.continuity)*(1+a.bias),d=(1-a.tension)*(1-a.continuity)*(1-a.bias),c=f.value-a.value,a.prev?(g=(f.time-a.time)/(f.time-a.prev.time),b=g*(b*(a.value-a.prev.value)+d*c)):b=d*c):a.shape===r.envelope.shape.LINE?(c=f.value-a.value,a.prev?(g=(f.time-a.time)/
(f.time-a.prev.time),b=g*(a.value-a.prev.value+c)):b=c):a.shape===r.envelope.shape.BEZI||a.shape===r.envelope.shape.HERM?(b=a.param[1],a.prev&&(b*=(f.time-a.time)/(f.time-a.prev.time))):a.shape===r.envelope.shape.BEZ2?(b=a.param[3]*(f.time-a.time),b=1.0E-5<Math.abs(a.param[2])?b/a.param[2]:1E5*b):b=0;return b},b=function(a,f){var b,d,c,g;f.shape===r.envelope.shape.LINE?(c=f.value-a.value,f.next?(g=(f.time-a.time)/(f.next.time-a.time),b=g*(f.next.value-f.value+c)):b=c):f.shape===r.envelope.shape.TCB?
(b=(1-f.tension)*(1-f.continuity)*(1+f.bias),d=(1-f.tension)*(1+f.continuity)*(1-f.bias),c=f.value-a.value,f.next?(g=(f.time-a.time)/(f.next.time-a.time),b=g*(d*(f.next.value-f.value)+b*c)):b*=c):f.shape===r.envelope.shape.HERM||f.shape===r.envelope.shape.BEZI?(b=f.param[0],f.next&&(b*=(f.time-a.time)/(f.next.time-a.time))):f.shape===r.envelope.shape.BEZ2?(b=f.param[1]*(f.time-a.time),b=1.0E-5<Math.abs(f.param[0])?b/f.param[0]:1E5*b):b=0;return b};u.prototype={setBehavior:function(a,f){this.in_behavior=
CubicVR.parseEnum(r.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,f)},empty:function(){return 0===this.nKeys},addKey:function(a,f,b){var d="object"==typeof a?a:b;f||(f=0);a||(a=0);d?(d=a,a=d.time,b=this.insertKey(a),b.value=d.value?d.value:f,b.time=d.time?d.time:a,b.shape=CubicVR.parseEnum(r.envelope.shape,d.shape)||r.envelope.shape.TCB,b.tension=d.tension?d.tension:0,b.continuity=d.continuity?d.continuity:0,b.bias=d.bias?d.bias:0,b.param=d.param?d.param:[0,0,0,0]):
(b=this.insertKey(a),b.value=f);return b},insertKey:function(a){var f=new x;f.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=f,this.nKeys++,f;for(var b=this.keys;b;){this.firstKey.time>a?this.firstKey=f:this.lastKey.time<a&&(this.lastKey=f);if(b.time>f.time)return f.prev=b.prev,f.prev&&(f.prev.next=f),f.next=b,f.next.prev=f,this.nKeys++,f;if(!b.next)return f.prev=b,b.next=f,this.nKeys++,f;b=b.next}return null},evaluate:function(e){var f,o,n,s,m,h=0;if(0===this.nKeys)return 0;if(1===
this.nKeys)return this.keys.value;o=this.firstKey;f=this.lastKey;if(e<o.time){s=this.in_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return o.value;if(s===r.envelope.behavior.REPEAT)s=c(e,o.time,f.time),e=s[0];else if(s===r.envelope.behavior.OCILLATE)s=c(e,o.time,f.time),e=s[0],s=s[1],s%2&&(e=f.time-o.time-e);else if(s===r.envelope.behavior.OFFSET)s=c(e,o.time,f.time),e=s[0],s=s[1],h=s*(f.value-o.value);else if(s===r.envelope.behavior.LINEAR)return m=a(o,
o.next)/(o.next.time-o.time),m*(e-o.time)+o.value}else if(e>f.time){s=this.out_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return f.value;if(s===r.envelope.behavior.REPEAT)s=c(e,o.time,f.time),e=s[0];else if(s===r.envelope.behavior.OCILLATE)s=c(e,o.time,f.time),e=s[0],s=s[1],s%2&&(e=f.time-o.time-e);else if(s===r.envelope.behavior.OFFSET)s=c(e,o.time,f.time),e=s[0],s=s[1],h=s*(f.value-o.value);else if(s===r.envelope.behavior.LINEAR)return s=b(f.prev,f)/(f.time-
f.prev.time),s*(e-f.time)+f.value}if(this.lastKey0)if(e>this.lastKey0.time)f=this.lastKey0;else if(e<this.lastKey0.time)for(f=this.lastKey;e<f.time&&f.prev;)f=f.prev;else f=this.keys;else f=this.keys;for(;e>f.next.time;)f=f.next;o=f.next;this.lastKey0=f;if(e===f.time)return f.value+h;if(e===o.time)return o.value+h;n=(e-f.time)/(o.time-f.time);s=o.shape;if(s===r.envelope.shape.TCB||s===r.envelope.shape.BEZI||s===r.envelope.shape.HERM){m=a(f,o);s=b(f,o);var t,q;q=n*n;t=n*q;e=3*q-t-t;t-=q;e=[1-e,e,t-
q+n,t];return e[0]*f.value+e[1]*o.value+e[2]*m+e[3]*s+h}return s===r.envelope.shape.BEZ2?(e=d(f.time,f.shape===r.envelope.shape.BEZ2?f.time+f.param[2]:f.time+(o.time-f.time)/3,o.time+o.param[0],o.time,e,0,1),g(f.value,f.shape===r.envelope.shape.BEZ2?f.value+f.param[3]:f.value+f.param[1]/3,o.param[1]+o.value,o.value,e)+h):s===r.envelope.shape.LINE?f.value+n*(o.value-f.value)+h:s===r.envelope.shape.STEP?f.value+h:h}};m.prototype={clone:function(){var a=new h.Motion(this.env_init,this.key_init),f;for(f in this.controllers)if(this.controllers.hasOwnProperty(f)){a.controllers[f]===
q&&(a.controllers[f]=[]);for(var b in this.controllers[f])if(this.controllers[f].hasOwnProperty(b)){var d=this.controllers[f][b],c=a.controllers[f][b]=new u({in_behavior:d.in_behavior,out_behavior:d.out_behavior});c.nKeys=d.nKeys;c.keys=d.keys;c.firstKey=d.firstKey;c.lastKey=d.lastKey}}return a},envelope:function(a,f){f=CubicVR.parseEnum(r.motion,f)||0;a=CubicVR.parseEnum(r.motion,a)||0;this.controllers[a]===q&&(this.controllers[a]=[]);this.controllers[a][f]===q&&(this.controllers[a][f]=new u(this.env_init));
return this.controllers[a][f]},evaluate:function(a){var f=[],b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){f[b]=[];for(var d in this.controllers[b])this.controllers[b].hasOwnProperty(d)&&(f[b][d]=this.controllers[b][d].evaluate(a))}return f},apply:function(a,f){for(var b in this.controllers)if(this.controllers.hasOwnProperty(b)){var d=parseInt(b,10);if(this.yzflip&&d===r.motion.ROT){this.q||(this.q=new CubicVR.Quaternion);var c=this.q,g=this.controllers[b][0].evaluate(a),m=this.controllers[b][1].evaluate(a),
t=this.controllers[b][2].evaluate(a);c.fromEuler(g,t,-m);c=c.toEuler();f.control(d,0,c[0]);f.control(d,1,c[1]);f.control(d,2,c[2])}else for(var h in this.controllers[b])this.controllers[b].hasOwnProperty(h)&&f.control(d,parseInt(h,10),this.controllers[b][h].evaluate(a))}},setKey:function(a,f,b,d,c){f=CubicVR.parseEnum(r.motion,f)||0;a=CubicVR.parseEnum(r.motion,a)||0;return this.envelope(a,f).addKey(b,d,c?c:this.key_init)},setArray:function(a,f,b,d){var c=[],a=CubicVR.parseEnum(r.motion,a)||0,g;for(g in b)if(b.hasOwnProperty(g)){var m=
this.envelope(a,CubicVR.parseEnum(r.motion,g));c[g]=m.addKey(f,b[g],d?d:this.key_init)}return c},setBehavior:function(a,f,b,d){var c=this.envelope(a,f);"object"===typeof b&&(d=b,b=d.in_behavior||d.inBehavior||d.behavior,d=d.out_behavior||d.outBehavior||d.behavior);CubicVR.parseEnum(r.motion,f);CubicVR.parseEnum(r.motion,a);c.setBehavior(b,d)},setBehaviorArray:function(a,f,b){var a=CubicVR.parseEnum(r.motion,a)||0,d=this.controllers[a],c;for(c in d)d.hasOwnProperty(c)&&this.envelope(a,CubicVR.parseEnum(r.motion,
c)||0).setBehavior(f,b)}};return{Motion:m,Envelope:u,EnvelopeKey:x}});
CubicVR.RegisterModule("EventHandler",function(h){function x(g){g=CubicVR.parseEnum(r.event,g);return g===q?(c("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(g,10))&&(g>=r.event.EVENT_MAX||0>g)?(c("Unknown event ID passed: "+g),!1):g}function u(c){c=c||{};this.name=c.name;c.id=x(c.id)||r.event.TICK;this.id=c.id;this.interval=c.interval||0;this.enabled=c.enabled||
!0;this.action=c.action||null;this.properties=c.properties||{};this.event_properties=c.event_properties||{};this.buffered=c.buffered||!1;this.weight=c.weight===q?-1:c.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function m(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var q=h.undef,
r=CubicVR.enums,c=h.log;r.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};u.prototype={getName:function(){return this.name},setName:function(c){this.name=c},getSubject:function(){return this.subject},setSubject:function(c){this.subject=c},getId:function(){return this.id},setId:function(c){this.id=c},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(c){c&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=c},isBuffered:function(){return this.buffered},setBuffered:function(c){this.buffered=c},setInterval:function(c){this.interval=c},getInterval:function(){return this.interval},setAction:function(c){this.action=c},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(c){this.properties=
c},getProperty:function(c){return this.properties[c]},setProperty:function(c,d){this.properties[c]=d},setEventProperties:function(c){this.event_properties=c},getEventProperties:function(){return this.event_properties},getEventProperty:function(c){return this.event_properties[c]},setEventProperty:function(c,d){this.properties[c]=d},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(c){this.t_rest=c},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(c){this.setRestInterval(c||0)},awake:function(){this.t_rest=0},update:function(c,d){if(!this.enabled)return!1;var a=0,b=!0;0===this.n_updates?(this.t_updatecall=this.t_update=c,a=1/60):c!==this.t_update?
(this.t_rest||(this.t_last=c-this.t_update,this.t_update=c),a=c-this.t_updatecall,this.t_updatecall=c):b=!1;if(0<this.t_rest)b&&(this.t_resting+=a,this.t_rest-=a,0>this.t_rest&&(this.t_rest=0));else return b&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(d),!0;b&&this.n_updates++;return!1},callEvent:function(c){return!this.action?!1:this.action(this,c)}};m.prototype={addEvent:function(c){c.callEvent||(c=new u(c));var d=c.getId();
this.eventProperties[d]||(this.eventProperties[d]={});this.listeners[d]=this.listeners[d]||0;this.listeners[d]++;this.events.push(c);-1===this.listenerNames.indexOf(d)&&this.listenerNames.push(d);return c},removeEvent:function(c){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(c)&&this.lockRemovals.push(c);else{var d=this.events.indexOf(c);-1!==d&&(c=c.getId(),this.events.splice(d,1),this.listeners[c]--,this.listeners[c]||(this.eventHandled[c]=!0,this.eventParameters[c]=
{},this.eventProperties[c]=[],this.eventPropertyCount[c]=0,d=this.listenerNames.indexOf(c),0<=d&&this.listenerNames.splice(d,1)))}},getProperties:function(c){this.eventParameters[c]=this.eventParameters[c]||{};return this.eventParameters[c]},setProperties:function(c,d){this.eventParameters[c]=d},getProperty:function(c,d){return this.getProperties(c)[d]},setProperty:function(c,d,a){this.getProperties(c)[d]=a},hasEvent:function(c){return!!this.listeners[c]},triggerEvent:function(c,d){if(!this.listeners[c])return null;
this.eventProperties[c]==q&&(this.eventProperties[c]=[]);var a=this.eventProperties[c];this.eventPropertyCount[c]===q&&(this.eventPropertyCount[c]=0);var b=this.eventPropertyCount[c];20<b&&console.log("Warning, event "+c+" count > 20: "+b);a[b]=d&&a?d:a[b]||{};this.eventPropertyCount[c]++;this.eventHandled[c]=!1;return a[b]},update:function(c){var d,a,b,e,f,o;if(this.hasEvent(r.event.TICK)&&0===this.eventPropertyCount[r.event.TICK]&&(d=this.triggerEvent(r.event.TICK)))d.time=c,d.handler=this;this.lockState=
!0;d=0;for(a=this.events.length;d<a;d++){f=this.events[d];o=f.getId();e=this.eventPropertyCount[o];var n=!1;b=!1;if(e){var s=this.eventProperties[o];if(f.isEnabled()){if(f.isBuffered()){if(s.length=e,f.setEventProperties(s),n=n||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}}else for(b=0;b<e;b++)if(f.setEventProperties(s[d]),n=n||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}b=!0}}if(n||!b)this.eventHandled[o]=!0}d=0;for(a=this.listenerNames.length;d<a;d++)o=this.listenerNames[d],
this.eventHandled[o]&&(this.eventPropertyCount[o]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){d=0;for(a=this.lockRemovals.length;d<a;d++)this.removeEvent(this.lockRemovals[d]);this.lockRemovals.length=0}}};return{Event:u,EventHandler:m,registerEvent:function(g){g=g.toUpperCase();r.event[g]!==q?c("Error, event '"+g+"' is already registered."):(r.event[g]=r.event.ENUM_MAX,r.event.ENUM_MAX++)},validateEvent:x}});
CubicVR.RegisterModule("Scene",function(h){function x(a,b){return a.light_type-b.light_type}function u(f,b){var e=null,c;f!==r&&null!==f?f.compile?e={}:(e=h.get(f)||{},f=null):e={};this.morphWeight=e.morphWeight||0;this.morphSource=e.morphSource||-1;this.morphTarget=e.morphTarget||-1;this.position=e.position===r?[0,0,0]:e.position;this.rotation=e.rotation===r?[0,0,0]:e.rotation;this.scale=e.scale===r?[1,1,1]:e.scale;this.shadowCast=e.shadowCast===r?!0:e.shadowCast;this.wireframe=e.wireframe||!1;this.motion=
e.motion===r?null:h.get(e.motion,h.Motion)||null;this.obj=!e.mesh?f?h.get(f,h.Mesh):null:h.get(e.mesh,h.Mesh);this.name=e.name===r?b!==r?b:null:e.name;this.properties=h.get(e.properties)||{};this.parent=this.children=null;var g=e.children||e.child||e.sceneObject||e.sceneObjects;if(g){if(g&&!g.length||"string"===typeof g)g=[g];if(g.length){e=0;for(c=g.length;e<c;e++)this.bindChild(h.get(g[e],h.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=a.identity();this.tMatrix=a.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];d.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function m(a,b,d,c,g,m){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=h.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+e;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((c=a.sceneObjects||a.sceneObject||a.objects)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(d=c.length;b<d;b++)this.bindSceneObject(h.get(c[b],h.SceneObject))}if((c=a.lights||a.light)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(d=c.length;b<d;b++)this.bindLight(h.get(c[b],h.Light))}if((c=a.cameras||
a.camera)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(d=c.length;b<d;b++)this.bindCamera(h.get(c[b],h.Camera));this.camera=this.cameras[0]}c||(this.camera=new h.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip))}else this.skybox=null,this.octree=m,this.name="scene"+e,this.camera=new h.Camera(a,b,d,c,g),this.wireframe=!1;this.paused=!1;++e}function q(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var r=h.undef,c=h.enums,
g=h.GLCore,d=h.aabb,a=h.mat4,b=0;u.prototype={get x(){return this.position[0]},set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=
a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},get sclX(){return this.scale[0]},set sclX(a){this.scale[0]=a},get sclY(){return this.scale[1]},set sclY(a){this.scale[1]=a},get sclZ(){return this.scale[2]},set sclZ(a){this.scale[2]=a},get scl(){return this.scale.slice(0)},set scl(a){this.scale=a.slice(0)},clone:function(){var a,b;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var e=new h.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),
rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){e.instanceMaterials=[];a=0;for(b=this.instanceMaterials.length;a<b;a++)e.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(null!==this.children){a=0;for(b=this.children.length;a<b;a++)e.bindChild(this.children[a].clone())}return e},
evaluate:function(a){var b,e;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(null!==this.children){b=0;for(e=this.children.length;b<e;b++)this.children[b].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){this.eventHandler||(this.eventHandler=new h.EventHandler);a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},
getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=
this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),e=0,c=b.length;e<c;e++)if(b[e].name==a)return b[e];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?
this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MATRIX_UPDATE)&&(a.triggerEvent(c.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(b){var e=h.vec3;if(!this.matrixLock&&(!e.equal(this.lposition,this.position)||!e.equal(this.lrotation,this.rotation)||!e.equal(this.lscale,
this.scale)||b!==r))b!==r?this.tMatrix=b.slice(0):a.identity(this.tMatrix),a.identity(this.lMatrix),a.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),a.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||a.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),a.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],
this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(b=this.getEventHandler(),b.hasEvent(c.event.MOVE)&&(b=b.triggerEvent(c.event.MOVE),b.oldPosition=this.lposition,b.position=this.position,b.oldRotation=this.lrotation,b.rotation=this.rotation,b.oldScale=this.lscale,b.scale=this.scale))},adjust_octree:function(){var a=
this.getAABB(),b=this.octree_aabb,e=a[0][0],c=a[0][1],g=a[0][2],m=a[1][0],t=a[1][1],h=a[1][2],q=b[0][0],u=b[0][1],F=b[0][2],v=b[1][0],y=b[1][1],b=b[1][2];if(0<this.octree_leaves.length&&(e<q||c<u||g<F||m>v||t>y||h>b)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(null!==e){for(;;)if(!e.contains_point(a[0])||!e.contains_point(a[1]))if(e._root!==r&&null!==e._root)e=e._root;
else break;else break;d.reset(this.octree_aabb,this.position);e.insert(this)}}},bindChild:function(a){null===this.children&&(this.children=[]);a.parent=this;this.children.push(a)},control:function(a,b,e){a===c.motion.POS?this.position[b]=e:a===c.motion.SCL?this.scale[b]=e:a===c.motion.ROT&&(this.rotation[b]=e)},getAABB:function(){var a=h.mat4,b=h.vec3;if(this.dirty){var e=Array(8);this.doTransform();var c,d;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,
1],this.position)];c=this.obj.bb[0];d=this.obj.bb[1]}if(!this.obj||c===r||d===r)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var g=c;c=b.subtract(d,c);e[0]=[g[0],g[1],g[2]];e[1]=[g[0],g[1],g[2]+c[2]];e[2]=[g[0]+c[0],g[1],g[2]];e[3]=[g[0]+c[0],g[1],g[2]+c[2]];e[4]=[g[0],g[1]+c[1],g[2]];e[5]=[g[0],g[1]+c[1],g[2]+c[2]];e[6]=[g[0]+c[0],g[1]+c[1],g[2]];e[7]=[g[0]+c[0],g[1]+c[1],g[2]+c[2]];g=a.vec3_multiply(e[0],this.tMatrix);c=[g[0],g[1],g[2]];d=[g[0],g[1],g[2]];for(b=
1;8>b;++b)g=a.vec3_multiply(e[b],this.tMatrix),c[0]>g[0]&&(c[0]=g[0]),c[1]>g[1]&&(c[1]=g[1]),c[2]>g[2]&&(c[2]=g[2]),d[0]<g[0]&&(d[0]=g[0]),d[1]<g[1]&&(d[1]=g[1]),d[2]<g[2]&&(d[2]=g[2]);this.aabb[0]=c;this.aabb[1]=d;this.dirty=!1}return this.aabb}};var e=0;m.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(a){this.octree=a;a.init&&a.init(this);a=this.lights;this.lights=[];for(var e=0,c=a.length;e<c;e++)this.bindLight(a[e]);a=
this.sceneObjects;if(this.octree!==r){e=0;for(c=a.length;e<c;++e){var g=a[e];null!==g.obj&&(0>g.id&&(g.id=b,++b),this.sceneObjectsById[g.id]=g,d.reset(g.octree_aabb,g.position),this.octree.insert(g),(void 0===g.octree_common_root||null===g.octree_common_root)&&log("!!",g.name,"octree_common_root is null"))}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(a,e,c){if(-1==this.sceneObjects.indexOf(a)){this.sceneObjects.push(a);
e!==r&&e&&this.pickables.push(a);null!==a.name&&(this.sceneObjectsByName[a.name]=a);if(this.octree!==r&&(c===r||"true"===c))0>a.id&&(a.id=b,++b),this.sceneObjectsById[a.id]=a,d.reset(a.octree_aabb,a.position),this.octree.insert(a);if(a.children)for(var g=0,m=a.children.length;g<m;g++)this.bindSceneObject(a.children[g],e,c);return a}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState)this.lockRemovals||(this.lockRemovals=
[]),-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a);else if(b=this.sceneObjects.indexOf(a),0<=b&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),0<=b&&this.pickables.splice(b,1),null!==a.name&&this.sceneObjectsByName[a.name]!==r&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var e=a.children.length;b<e;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==r&&(b===r||"true"===b))a.method===c.light.method.GLOBAL?this.global_lights.push(a):
(a.method===c.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(x)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof h.Light?this.bindLight(a):a instanceof h.SceneObject?this.bindSceneObject(a):
a instanceof h.Camera?this.bindCamera(a):a instanceof h.Vehicle?a.bindToScene(this):a instanceof h.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof h.Light?this.removeLight(a):a instanceof h.SceneObject?this.removeSceneObject(a):a instanceof h.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){a&&("object"!==typeof a&&(a=this.getCamera(a)),this.camera=a)},getCamera:function(a){return a===r?
this.camera:this.camerasByName[a]},evaluate:function(a){var b,e;b=0;for(e=this.sceneObjects.length;b<e;b++)this.sceneObjects[b].motion&&!this.sceneObjects[b].independentMotion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(a,this.camera));b=0;for(e=this.lights.length;b<e;b++){var c=this.lights[b];null!==c.motion&&c.motion.apply(a,c)}},prepareTransforms:function(a){var b,
e;if(a){if(a.doTransform(),a.children){b=0;for(e=a.children.length;b<e;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(0!==this.sceneObjects.length){b=0;for(e=this.sceneObjects.length;b<e;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a,b){var e=g.gl,b=b||this.camera;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(h.features.lightShadows){for(var d=e.getParameter(e.FRAMEBUFFER_BINDING),m=!1,q=e.getParameter(e.VIEWPORT),
t=0,r=this.lights.length;t<r;t++){var A=this.lights[t];if(A.light_type==c.light.type.SPOT_SHADOW||A.light_type==c.light.type.SPOT_SHADOW_PROJECTOR||A.light_type==c.light.type.AREA){var m=!0,u=[new h.Light(c.light.type.DEPTH_PACK)];A.light_type===c.light.type.AREA&&(A.areaCam=b,A.updateAreaLight());g.shadow_near=A.dummyCam.nearclip;g.shadow_far=A.dummyCam.farclip;A.shadowBegin();for(var F=0,v=this.sceneObjects.length;F<v;F++){var y=this.sceneObjects[F];y.parent||!1===y.visible||!1===y.shadowCast||
this.renderSceneObject(y,A.dummyCam,u,!1,!0)}A.shadowEnd();d&&e.bindFramebuffer(e.FRAMEBUFFER,d)}}m&&e.viewport(q[0],q[1],q[2],q[3])}},updateCamera:function(a){a=a||this.camera;!1===a.manual&&(a.targeted?a.lookat(a.position[0],a.position[1],a.position[2],a.target[0],a.target[1],a.target[2],0,1,0):a.calcProjection());g.depth_alpha_near=a.nearclip;g.depth_alpha_far=a.farclip},resize:function(a,b){this.camera&&this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==r,b=0,e=this.sceneObjects.length;b<
e;b++){var c=this.sceneObjects[b];null===c.parent&&(this.prepareTransforms(c),a&&(lights=[],c.dirty&&null!==c.obj&&c.adjust_octree(),!1===c.visible||a&&(c.ignore_octree||!0===c.drawn_this_frame||!0===c.culled)||(lights=c.dynamic_lights,lights=lights.concat(c.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(this.lights_rendered=Math.max(lights.length,this.lights_rendered),this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered),lights=0===lights.length?
[g.emptyLight]:lights.sort(x),c.drawn_this_frame=!0)))}},renderSceneObject:function(a,b,e,c,d,m,t){var q=!1,A=g.gl,c=c!==r&&c,d=d||!1,m=m||!1;if(a.visible&&a.obj){0>a.scale[0]&&(q=!q);0>a.scale[1]&&(q=!q);0>a.scale[2]&&(q=!q);q&&A.cullFace(A.FRONT);var u=a.obj;null!==u.morphTargets&&(-1!==a.morphSource&&u.setMorphSource(a.morphSource),-1!==a.morphTarget&&u.setMorphTarget(a.morphTarget),null!==a.morphWeight&&(u.morphWeight=a.morphWeight));a.instanceMaterials&&u.bindInstanceMaterials(a.instanceMaterials);
h.renderObject(u,b,a.tMatrix,e,d,m,this.isWireframe()||a.isWireframe())&&t&&t.push(a);a.instanceMaterials&&u.bindInstanceMaterials(null);q&&A.cullFace(A.BACK)}a=a.children;if(c&&a){c=0;for(q=a.length;c<q;c++)this.renderSceneObject(a[c],b,e,!0,d,m,t)}},runEvents:function(a){var b,e;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(e=this.sceneObjects.length;b<e;b++){var c=this.sceneObjects[b];c.hasEvents()&&c.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(e=this.lockRemovals.length;b<
e;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(b){++this.frames;b=b||{};b.postProcess&&b.postProcess.begin(!b.postBuffer);var e=b.camera||this.camera,c=g.gl,d;d=this.octree!==r;this.lights_rendered=0;d&&(this.octree.reset_node_visibility(),this.octree.cleanup(),d=this.octree.get_frustum_hits(e),this.lights_rendered=d.lights.length);this.doTransform();this.updateCamera(e);this.updateShadows(!0);this.shadows_updated=!1;var m;d=0;for(m=this.lights.length;d<
m;d++)this.lights[d].prepare(e);this.objects_rendered=0;var q=[],t=[],B=this.lights;d=0;for(m=this.sceneObjects.length;d<m;d++){var A=this.sceneObjects[d];!1===A.visible||null!==A.parent||this.renderSceneObject(A,e,B,!0,!0,!1,t)}d=0;for(m=t.length;d<m;d++)this.renderSceneObject(t[d],e,B,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=q,this.stats["lights.num_global"]=this.global_lights.length,
this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(c.cullFace(c.FRONT),d=2*e.farclip/Math.sqrt(3),this.skybox.scene_object.position=e.parent?a.vec3_multiply(e.position,e.parent.tMatrix):[e.position[0],e.position[1],e.position[2]],this.skybox.scene_object.scale=[d,d,d],this.skybox.scene_object.doTransform(),h.renderObject(this.skybox.scene_object.obj,e,this.skybox.scene_object.tMatrix,[]),c.cullFace(c.BACK));b.postProcess&&(b.postProcess.end(),
b.postBuffer||b.postProcess.render())},bbRayTest:function(a,b,e,c){var d=h.vec3,g=[],c=c||this.camera,b=2===b.length?c.unProject(b[0],b[1]):d.add(a,b),t;for(t in this.pickables)if(this.pickables.hasOwnProperty(t)&&(c=this.pickables[t],!0===c.visible)){var m,q;q=c.getAABB();m=q[0];q=q[1];0.2>q[0]-m[0]&&(m[0]-=0.1,q[0]+=0.1);0.2>q[1]-m[1]&&(m[1]-=0.1,q[1]+=0.1);0.2>q[2]-m[2]&&(m[2]-=0.1,q[2]+=0.1);var r=d.multiply(d.add(m,q),0.5),u=d.getClosestTo(a,b,r),r=d.length(d.subtract(u,r));(u[0]>=m[0]&&u[0]<=
q[0]?1:0)+(u[1]>=m[1]&&u[1]<=q[1]?1:0)+(u[2]>=m[2]&&u[2]<=q[2]?1:0)>=e&&g.push({dist:r,obj:c})}g.length&&g.sort(function(a,b){return a.dist==b.dist?0:a.dist<b.dist?-1:1});return g}};q.prototype={addMesh:function(a,b,e){this.meshBin[a]===r&&(this.meshBin[a]=[],this.meshBinPtr[a]===r&&(this.meshBinPtr[a]=0));this.meshMap[b]===r&&(this.meshMap[b]=e,this.meshBin[a].push(e))},addImage:function(a,b,e){this.imageBin[a]===r&&(this.imageBin[a]=[],this.imageBinPtr[a]===r&&(this.imageBinPtr[a]=0));this.imageMap[b]===
r&&(this.imageMap[b]=e,this.imageBin[a].push(e))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];return b<this.meshBin[a].length?(this.meshBinPtr[a]++,this.meshBin[a][b]):null},loadNextMesh:function(a){a=this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},
isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);null!==a&&(a.src=a.deferredSrc)},getNextImage:function(a){var b=this.imageBinPtr[a];return b<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][b]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===this.imageBin[a].length}};return{Scene:m,SceneObject:u,SkyBox:function(a){var b=a.texture,a=a.mapping,e=this;this.mapping=null;this.ready=!1;this.texture=
null;this.onready=function(){b.onready=null;var a=1/h.Images[e.texture.tex_id].width;null===e.mapping&&(e.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]]);var a=new h.Material({name:"skybox",textures:{color:b},noFog:!0}),f=new h.Mesh;f.sky_mapping=e.mapping;h.primitives.box({mesh:f,size:1,material:a,uvmapper:{projectionMode:h.enums.uv.projection.SKY,scale:[1,1,1]}});f.prepare();e.scene_object=new h.SceneObject(f);e.ready=!0};if(b&&("string"===
typeof b?b=new h.Texture(b,null,null,null,this.onready):b.loaded||(b.onready=this.onready),this.texture=b,a))this.mapping=a,this.onready()},DeferredBin:q}});
CubicVR.RegisterModule("PostProcess",function(h){function x(a){if(a.shader_vertex===q||a.shader_fragment===q)return null;this.outputMode=a.outputMode===q?c.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===q?null:a.onresize;this.onupdate=a.onupdate===q?null:a.onupdate;this.init=a.init===q?null:a.init;this.enabled=a.enabled===q?!0:a.enabled;this.outputDivisor=a.outputDivisor===q?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function u(a,b,e){var f=r.gl;this.width=a;this.height=b;this.accum=e===q?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,b,!0);this.bufferA=new CubicVR.RenderBuffer(a,b,!1);this.bufferB=new CubicVR.RenderBuffer(a,
b,!1);this.bufferC=new CubicVR.RenderBuffer(a,b,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(a,b,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT),this.blur_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.bufferB.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new x({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,b)}function m(a,b,e){this.createBuffer(a,b,e)}var q=h.undef,r=h.GLCore,c=CubicVR.enums;c.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],d=[];u.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,b){var e=r.gl,f={},c=a/a,d=b/b;f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,c,0,c,d,0,d,0,0,c,d]);f.gl_points=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,
f.gl_points);e.bufferData(e.ARRAY_BUFFER,f.vbo_points,e.STATIC_DRAW);f.gl_uvs=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,f.gl_uvs);e.bufferData(e.ARRAY_BUFFER,f.vbo_uvs,e.STATIC_DRAW);return f},destroyFSQuad:function(a){var b=r.gl;b.deleteBuffer(a.gl_points);b.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,b){var e=r.gl;a.use();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.bindBuffer(e.ARRAY_BUFFER,b.gl_points);e.vertexAttribPointer(a.aVertex,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aVertex);
e.bindBuffer(e.ARRAY_BUFFER,b.gl_uvs);e.vertexAttribPointer(a.aTex,2,e.FLOAT,!1,0,0);e.enableVertexAttribArray(a.aTex);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);e.drawArrays(e.TRIANGLES,0,6)},addShader:function(a){this.shaders[this.shaders.length]=a;a.shader.use();a.shader.setVector("texel",this.vTexel);if(a.outputDivisor&&1!=a.outputDivisor&&g[a.outputDivisor]===q){var b=this.width/a.outputDivisor|0,e=this.height/a.outputDivisor|0;g[a.outputDivisor]=new CubicVR.RenderBuffer(b,e,!1);d[a.outputDivisor]=
this.makeFSQuad(b,e)}},resize:function(a,b){var e=r.gl;this.width=a;this.height=b;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT));for(var f in g){var e=this.width/f|0,c=this.height/f|0;g[f].destroyBuffer();g[f].createBuffer(e,c,!1);this.destroyFSQuad(d[f]);d[f]=this.makeFSQuad(e,c)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;f=0;for(e=this.shaders.length;f<e;f++)if(this.shaders[f].shader.use(),this.shaders[f].shader.setVector("texel",this.vTexel),null!==this.shaders[f].onresize)this.shaders[f].onresize(this.shaders[f].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var b=r.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?b.clear(b.DEPTH_BUFFER_BIT|b.COLOR_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT))},end:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var a=r.gl;this.captureBuffer.texture.use(a.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(a.TEXTURE0);a.clearColor(0,0,0,1);a.clear(a.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var b=0,e=0,f=this.shaders.length;e<f;e++){var o=this.shaders[e];if(o.enabled){this.swap();this.inputBuffer.texture.use(a.TEXTURE0);var n=o.outputMode;if(n===c.post.output.REPLACE)1!==o.outputDivisor?g[o.outputDivisor].use():this.outputBuffer.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT);else if(n===c.post.output.ADD||
n===c.post.output.BLEND)1!==o.outputDivisor?g[o.outputDivisor].use():this.bufferC.use(),a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT);null!==o.onupdate&&(o.shader.use(),o.onupdate(o.shader));1!==o.outputDivisor?(a.viewport(0,0,g[o.outputDivisor].width,g[o.outputDivisor].height),this.renderFSQuad(o.shader,d[o.outputDivisor]),o.outputMode===c.post.output.REPLACE?(this.outputBuffer.use(),g[o.outputDivisor].texture.use(a.TEXTURE0),a.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):a.viewport(0,0,this.width,this.height)):this.renderFSQuad(o.shader,this.fsQuad);n===c.post.output.BLEND?(this.swap(),this.outputBuffer.use(),a.enable(a.BLEND),a.blendFunc(a.ONE,a.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(a.TEXTURE0),1!==o.outputDivisor?g[o.outputDivisor].texture.use(a.TEXTURE0):this.bufferC.texture.use(a.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.disable(a.BLEND)):n===c.post.output.ADD&&(this.swap(),this.outputBuffer.use(),a.enable(a.BLEND),
a.blendFunc(a.ONE,a.ONE),1!==o.outputDivisor?g[o.outputDivisor].texture.use(a.TEXTURE0):this.bufferC.texture.use(a.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.disable(a.BLEND));this.end();b++}}0===b?this.captureBuffer.texture.use(a.TEXTURE0):this.outputBuffer.texture.use(a.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),a.disable(a.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(a.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),a.disable(a.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};m.prototype={createBuffer:function(a,
b,e){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(b,10);var a=this.sizeParam(a),b=this.sizeParam(b),f=r.gl;this.fbo=f.createFramebuffer();e&&(this.depth=f.createRenderbuffer());f.bindFramebuffer(f.FRAMEBUFFER,this.fbo);e&&(f.bindRenderbuffer(f.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,b),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depth)):
(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,b),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;f.bindTexture(f.TEXTURE_2D,h.Textures[this.texture.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texImage2D(f.TEXTURE_2D,
0,f.RGBA,a,b,0,f.RGBA,f.UNSIGNED_BYTE,null);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,h.Textures[this.texture.tex_id],0);f.bindFramebuffer(f.FRAMEBUFFER,null)},destroyBuffer:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(h.Textures[this.texture.tex_id]);h.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:m,PostProcessShader:x,PostProcessChain:u,fsQuad:{make:u.prototype.makeFSQuad,destroy:u.prototype.destroyFSQuad,render:u.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function h(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function x(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;
this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}h.prototype={addSubview:function(h){this.childViews.push(h);h.superView=this},makePanel:function(h){return this.superView.makePanel(h)}};x.prototype={resize:function(h,m){this.width=h;this.height=m},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(h){h.setInt("srcTex",0);h.addVector("screen");h.addVector("position");h.addVector("tint");h.addVector("size")}})},addSubview:function(h){this.childViews.push(h);h.superView=this},removeSubview:function(h){h=this.childViews.indexOf(h);-1<h&&this.childViews.splice(h,
1)},makePanel:function(h){var m=CubicVR.GLCore.gl,q={};q.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);q.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);q.gl_points=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,q.gl_points);m.bufferData(m.ARRAY_BUFFER,q.vbo_points,m.STATIC_DRAW);q.gl_uvs=m.createBuffer();m.bindBuffer(m.ARRAY_BUFFER,q.gl_uvs);m.bufferData(m.ARRAY_BUFFER,q.vbo_uvs,m.STATIC_DRAW);h.panel=q},renderPanel:function(h){if(!h.texture)return!1;h.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(h){if(h.texture){var m=CubicVR.GLCore.gl,q=h.offsetLeft,r=h.offsetTop;q||(q=0);r||(r=0);var c=this.shader.shader;c.use();c.setVector("screen",[this.width,this.height,0]);c.setVector("position",[h.x+q,h.y+r,0]);c.setVector("size",[h.width,h.height,0]);c.setVector("tint",h.tint);h.blend&&(m.enable(m.BLEND),m.blendFunc(m.SRC_ALPHA,m.ONE_MINUS_SRC_ALPHA));h.texture.use(m.TEXTURE0);m.drawArrays(m.TRIANGLES,0,6);h.blend&&(m.disable(m.BLEND),m.blendFunc(m.ONE,m.ZERO))}},render:function(){var h=
CubicVR.GLCore.gl;h.disable(h.DEPTH_TEST);this.texture&&this.renderView(this);var m=[];this.offsetTop=this.offsetLeft=0;m.push(this);var q=this.shader.shader;q.use();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_points);h.vertexAttribPointer(q.uniforms.aVertex,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(q.uniforms.aVertex);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_uvs);h.vertexAttribPointer(q.uniforms.aTex,2,h.FLOAT,!1,0,0);h.enableVertexAttribArray(q.uniforms.aTex);
for(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);m.length;){var r=m.pop();this.renderView(r);if(r.childViews.length)for(var c=r.childViews.length-1;0<=c;c--)r.childViews[c].offsetLeft=r.x+r.offsetLeft,r.childViews[c].offsetTop=r.y+r.offsetTop,m.push(r.childViews[c])}h.disableVertexAttribArray(q.uniforms.aTex);h.enable(h.DEPTH_TEST)}};return{Layout:x,View:h}});
CubicVR.RegisterModule("Primitives",function(h){function x(a,b,c,d,g,o){var m=h.mat4,q=h.vec3,r=[],v,y=[0,1,0],u=[1,0,0],z=[0,0,0],x=a.points.length,H,I,J;for(H=v=0;H<f&&v!==c;H+=f/c){u=[Math.cos(H),0,Math.sin(H)];I=0;for(J=b.length;I<J;I++)z=q.add(q.multiply(u,b[I][0]),q.multiply(y,b[I][1])),r[v]===e&&(r[v]=[]),r[v].push(z);v++}J=null;g!==e&&(J=g.getResult!==e?g.getResult():g);for(I=0;I<c;I++){g=0;for(v=b.length;g<v;g++)J?a.addPoint(m.vec3_multiply(r[I][g],J)):a.addPoint(r[I][g])}"string"===typeof d&&
(d=new h.Material(d));a.setFaceMaterial(d);for(g=0;g<c;g++){I=0;for(J=b.length-1;I<J;I++)m=I+b.length*g,r=I+b.length*((g+1)%c),q.equal(a.points[x+m],a.points[x+r])?a.addFace([x+m+1,x+r+1,x+r]):q.equal(a.points[x+m+1],a.points[x+r+1])?a.addFace([x+m,x+m+1,x+r]):a.addFace([x+m,x+m+1,x+r+1,x+r])}o!==e&&(b=null,o.apply!==e?b=o:o&&(b=new h.UVMapper(o)),null!==b&&(a.calcFaceNormals(),b.apply(a,d)))}function u(a,b,f,c,d){var g=h.mat4,b=0.5*b,o=a.points.length;"string"===typeof f&&(f=new h.Material(f));a.setFaceMaterial(f);
c!==e?(c=c.getResult!==e?c.getResult():c,a.addPoint([g.vec3_multiply([b,-b,0],c),g.vec3_multiply([b,b,0],c),g.vec3_multiply([-b,b,0],c),g.vec3_multiply([-b,-b,0],c)])):a.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);a.addFace([[o+0,o+1,o+2,o+3],[o+3,o+2,o+1,o+0]]);d!==e&&(g=null,d.apply!==e?g=d:d&&(g=new h.UVMapper(d)),null!==g&&(a.calcFaceNormals(),g.apply(a,f)))}function m(a,b,f,c,d){var g=h.mat4,o,m;"object"===typeof b?(o=b[0]/2,m=b[1]/2,b=b[2]/2):o=m=b/=2;var q=a.points.length;"string"===typeof f&&
(f=new h.Material(f));a.setFaceMaterial(f);c!==e?(c=c.getResult!==e?c.getResult():c,a.addPoint([g.vec3_multiply([o,-m,b],c),g.vec3_multiply([o,m,b],c),g.vec3_multiply([-o,m,b],c),g.vec3_multiply([-o,-m,b],c),g.vec3_multiply([o,-m,-b],c),g.vec3_multiply([o,m,-b],c),g.vec3_multiply([-o,m,-b],c),g.vec3_multiply([-o,-m,-b],c)])):a.addPoint([[o,-m,b],[o,m,b],[-o,m,b],[-o,-m,b],[o,-m,-b],[o,m,-b],[-o,m,-b],[-o,-m,-b]]);a.addFace([[q+0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+
6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);d!==e&&(g=null,d.apply!==e?g=d:d&&(g=new h.UVMapper(d)),null!==g&&(a.calcFaceNormals(),g.apply(a,f)))}function q(a,b,e,c,d,g,o,m){for(var q=[],e=e-b,b=b+e/2,r=f/d,y=0,u=0;u<=d;u++)q.push([b+Math.cos(y)*e,Math.sin(y)*e,0]),y+=r;h.genLatheObject(a,q,c,g,o,m)}function r(a,b,e,f,c,d,g){h.genLatheObject(a,[[0,-e/2,0],[b/2,-e/2,0],[0,e/2,0]],f,c,d,g)}function c(a,b,e,f,c,d,g){h.genLatheObject(a,[[0,-e/2,0],[b,-e/2,0],[b,e/2,0],[0,e/2,0]],f,c,d,g)}function g(a,b,e,f,c,
d,g){for(var m=[],f=(f/=2)|0,e=e|0,q=Math.PI/f,r=-o,y=0;y<=f;y++)m.push([Math.cos(r)*b,Math.sin(r)*b,0]),r+=q;h.genLatheObject(a,m,e,c,d,g)}function d(a){"string"===typeof a&&(a=h.get(a,h.Material));return a===e?new h.Material:a.use?a:"object"===typeof a?new h.Material(a):new h.Material}function a(a){if(a===e)return e;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?a.getResult():a.position||a.rotation||a.scale?h.mat4.transform(a.position,a.rotation,a.scale):e}function b(a){"string"===
typeof a&&(a=h.get(a));return a===e?e:a.apply?a:"object"===typeof a?new h.UVMapper(a):e}var e=h.undef,f=2*Math.PI,o=Math.PI/2;return{genPlaneObject:u,genBoxObject:m,genLatheObject:x,genTorusObject:q,genConeObject:r,genCylinderObject:c,genSphereObject:g,primitives:{lathe:function(f){var c,g,o,m;if(f.points==e)return null;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);g=d(f.material);o=a(f.transform);m=b(f.uvmapper||f.uv);x(c,f.points,f.divisions!==e?f.divisions:24,g,o,m);return c},box:function(f){var c,
g,o,t;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);g=d(f.material);o=a(f.transform);t=b(f.uvmapper||f.uv);m(c,f.size!==e?f.size:1,g,o,t);return c},plane:function(f){var c,g,o,m;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);g=d(f.material);o=a(f.transform);m=b(f.uvmapper||f.uv);u(c,f.size!==e?f.size:1,g,o,m);return c},sphere:function(f){var c,o,m,t;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);o=d(f.material);m=a(f.transform);t=b(f.uvmapper||f.uv);g(c,f.radius!==e?f.radius:1,f.lon!==
e?f.lon:24,f.lat!==e?f.lat:24,o,m,t);return c},torus:function(f){var c,g,o,m;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);g=d(f.material);o=a(f.transform);m=b(f.uvmapper||f.uv);q(c,f.innerRadius!==e?f.innerRadius:0.75,f.outerRadius!==e?f.outerRadius:1,f.lon!==e?f.lon:24,f.lat!==e?f.lat:24,g,o,m);return c},cone:function(f){var c,g,o,m;c=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);g=d(f.material);o=a(f.transform);m=b(f.uvmapper||f.uv);r(c,f.base!==e?f.base:1,f.height!==e?f.height:1,f.lon!==
e?f.lon:24,g,o,m);return c},cylinder:function(f){var g,o,m,t;g=f.mesh!==e?f.mesh:new h.Mesh(f.name!==e?f.name:e);o=d(f.material);m=a(f.transform);t=b(f.uvmapper||f.uv);c(g,f.radius!==e?f.radius:1,f.height!==e?f.height:1,f.lon!==e?f.lon:24,o,m,t);return g}}}});
CubicVR.RegisterModule("COLLADA",function(h){function x(g,d){function a(a){return!a.color?!1:(a=a.color)?e.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function b(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var e=h.util,f,o,n,q,D,w;w="object"==typeof g?g:-1!=g.indexOf(".js")?e.getJSON(g):h.util.xml2badgerfish(e.getXML(g));var t,B,A,E,x,v,y,C,z,G,H,I,J,L,M,K,N,Y,ca,U,na,Q=w;w=null;if(!Q.COLLADA)throw Error(g+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,O={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var Ma=Q.asset.up_axis.$;"X_UP"===Ma?O.up_axis=0:"Y_UP"===Ma?O.up_axis=1:"Z_UP"===Ma&&(O.up_axis=2)}var gb=O.up_axis;if(Q.library_images&&(Q.library_images.image&&!Q.library_images.image.length&&(Q.library_images.image=[Q.library_images.image]),Q.library_images.image.length))for(var hb=Q.library_images.image,Na=0,qb=hb.length;Na<qb;Na++){var Oa=hb[Na],ib=Oa["@id"],Ic=
Oa["@name"],ac=Oa.init_from;if(ac.$){var ra=ac.$;d!==u&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));d!==u&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));O.images[ib]={source:ra,id:ib,name:Ic}}}var jb,rb,bc,V,Pa,ka,Qa,da,P,W,S,Da,ha,Ra,Sa,Z,aa;if(Q.library_effects){var Ta=Q.library_effects.effect;Ta&&!Ta.length&&(Ta=[Ta]);rb=0;for(bc=Ta.length;rb<bc;rb++){var Db=Ta[rb];jb=Db["@id"];var T={};T.id=jb;T.surfaces=[];T.samplers=[];(da=Db.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da){Y=0;for(ca=da.length;Y<ca;Y++){var sa=da[Y],Ua=sa["@sid"];if(sa.surface){T.surfaces[Ua]={};var cc=sa.surface.init_from.$;"object"===typeof O.images[cc]&&(T.surfaces[Ua].source=d+"/"+O.images[cc].source)}else if(sa.sampler2D&&(T.samplers[Ua]={},T.samplers[Ua].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(T.samplers[Ua].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))T.samplers[Ua].magfiter=sa.sampler2D.magfilter.$}}var va=Db.profile_COMMON.technique;
va&&!va.length&&(va=[va]);T.material={textures_ref:[]};V=0;for(Pa=va.length;V<Pa;V++){f=va[V].blinn;f||(f=va[V].phong);f||(f=va[V].lambert);if(f)for(var ea in f){var sb=f[ea],ta=a(sb),dc=b(sb),Eb;Eb=sb.texture?sb.texture["@texture"]:!1;!1!==ta&&3<ta.length&&ta.pop();"emission"==ea?!1!==ta&&(T.material.ambient=ta):"ambient"!=ea&&("diffuse"==ea?!1!==ta&&(T.material.color=ta):"specular"==ea?!1!==ta&&(T.material.specular=ta):"shininess"==ea&&!1!==dc&&(T.material.shininess=dc));if(!1!==Eb){var Va=T.surfaces[T.samplers[Eb].source].source;
"emission"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.AMBIENT}):"ambient"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.AMBIENT}):"diffuse"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.COLOR}):"specular"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?T.material.textures_ref.push({image:Va,type:m.texture.map.REFLECT}):"reflectivity"!=ea&&"transparent"==ea&&T.material.textures_ref.push({image:Va,
type:m.texture.map.ALPHA}))}}O.effects[jb]=T}}}var Fb=c.getAllOf(Q,"instance_geometry"),tb=[];if(Fb.length){v=0;for(C=Fb.length;v<C;v++){var ec=Fb[v],Gb=c.getAllOf(ec,"instance_material");if(Gb.length){U=0;for(na=Gb.length;U<na;U++){var fc=Gb[U],Jc=fc["@symbol"],Kc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Jc]=Kc}}}}var Hb=Q.library_materials;if(Hb&&Hb.material){var Wa=Hb.material;Wa&&!Wa.length&&(Wa=[Wa]);G=0;for(H=Wa.length;G<H;G++){var Ib=Wa[G],Lc=Ib["@id"],Mc=Ib["@name"],gc=Ib.instance_effect;
gc&&(jb=gc["@url"].substr(1),O.materials.push({id:Lc,name:Mc,mat:O.effects[jb].material}))}}var hc=Q.library_geometries,Xa;if(hc){var ua=hc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Nc=ua.length;kb<Nc;kb++){var ma={id:u,points:[],parts:[]},Ya=ua[kb].mesh;if(Ya){Xa=ua[kb]["@id"];D=ua[kb]["@name"];var Za=Ya.source;Za&&!Za.length&&(Za=[Za]);for(var R=[],Jb=0,Oc=Za.length;Jb<Oc;Jb++){var ub=Za[Jb];o=ub["@id"];var Pc=ub["@name"],Kb=ub.float_array;Kb&&(R[o]={id:o,name:Pc,data:e.floatDelimArray(Kb.$?
Kb.$:""," ")});var Lb=ub.technique_common.accessor;Lb&&(R[o].count=Lb["@count"]|0,R[o].stride=Lb["@stride"]|0,R[o].count&&(R[o].data=e.repackArray(R[o].data,R[o].stride,R[o].count)))}var Mb=Ya.vertices,lb=null,Nb=null,Ea=null,Fa=null,Ga=null;if(Mb&&(Nb=Mb["@id"],(P=Mb.input)&&!P.length&&(P=[P]),P)){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],"POSITION"===W["@semantic"]&&(lb=W["@source"].substr(1))}var oa=Ya.triangles;oa&&!oa.length&&(oa=[oa]);if(oa){V=0;for(Pa=oa.length;V<Pa;V++){aa={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Qc=parseInt(oa[V]["@count"],10);(P=oa[V].input)&&!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],Z=parseInt(W["@offset"],10),q=W["@source"].substr(1),"VERTEX"===W["@semantic"]?(q===Nb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,R[Ea].count&&(S[Z]=1)):"TEXCOORD"===W["@semantic"]?(Ga=q,R[Ga].count&&(S[Z]=2)):"COLOR"===W["@semantic"]?(Fa=q,R[Fa].count&&(S[Z]=3)):S[Z]=4}E=S.length;n=Xa+":"+oa[V]["@material"];null===n?aa.material=
0:tb[n]===u?(r("missing material ["+n+"]@"+Xa+"?"),aa.material=0):aa.material=tb[n];var ic=oa[V].p,wa=[];ic&&(wa=e.intDelimArray(ic.$," "));if(wa.length&&(x=wa.length/S.length/3,x===Qc)){0===ma.points.length&&(ma.points=R[lb].data);v=Z=0;C=wa.length;for(z=S.length;v<C;v+=3*z){t=[];B=[];A=[];ia=[];for(U=0;U<3*z;U++){var vb=U%z;0===S[vb]?B.push(wa[v+U]):1===S[vb]?t.push(wa[v+U]):2===S[vb]?A.push(wa[v+U]):3===S[vb]&&ia.push(wa[v+U])}B.length&&(aa.faces.push(B),3===t.length&&aa.normals.push([c.fixuaxis(O.up_axis,
R[Ea].data[t[0]]),c.fixuaxis(O.up_axis,R[Ea].data[t[1]]),c.fixuaxis(O.up_axis,R[Ea].data[t[2]])]),3===A.length&&aa.texcoords.push([R[Ga].data[A[0]],R[Ga].data[A[1]],R[Ga].data[A[2]]]),3===ia.length&&aa.colors.push([R[Fa].data[ia[0]],R[Fa].data[ia[1]],R[Fa].data[ia[2]]]))}}ma.parts.push(aa)}}var ja=Ya.polylist;ja||(ja=Ya.polygons);ja&&!ja.length&&(ja=[ja]);if(ja){V=0;for(Pa=ja.length;V<Pa;V++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ja[V]["@count"],10);(P=ja[V].input)&&
!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++){W=P[ka];var Ob=W["@offset"];null===Ob&&(Ob=W["@idx"]);Z=parseInt(Ob,10);q=W["@source"].substr(1);"VERTEX"===W["@semantic"]?(q===Nb&&(q=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=q,S[Z]=1):"TEXCOORD"===W["@semantic"]?(Ga=q,S[Z]=2):"COLOR"===W["@semantic"]?(Fa=q,S[Z]=3):S[Z]=4}}var kc=ja[V].vcount,$a=[];kc&&($a=e.intDelimArray(kc.$," "));n=Xa+":"+ja[V]["@material"];aa.material=n===u?0:tb[n];var mb=ja[V].p;E=S.length;var xa=[];if(1<
mb.length&&!$a.length){Y=0;for(ca=mb.length;Y<ca;Y++){var lc=e.intDelimArray(mb[Y].$," ");$a[Y]=parseInt(lc.length/E,10);xa=xa.concat(lc)}}else mb&&(xa=e.intDelimArray(mb.$," "));if(xa.length)if(x=$a.length,x!==jc)r("poly vcount data doesn't add up, skipping object load: "+x+" !== "+jc);else{0===ma.points.length&&(ma.points=R[lb].data);v=Z=0;for(C=$a.length;v<C;v++){t=[];B=[];A=[];ia=[];U=0;for(na=$a[v]*E;U<na;U++)0===S[U%E]?B.push(xa[Z]):1===S[U%E]?t.push(xa[Z]):2===S[U%E]?A.push(xa[Z]):3===S[U%
E]&&ia.push(xa[Z]),Z++;var ab;if(B.length){aa.faces.push(B);if(t.length){$=[];I=0;for(J=t.length;I<J;I++)$.push(c.fixuaxis(O.up_axis,R[Ea].data[t[I]]));aa.normals.push($)}if(A.length){ab=[];I=0;for(J=A.length;I<J;I++)ab.push(R[Ga].data[A[I]]);aa.texcoords.push(ab)}if(ia.length){ab=[];I=0;for(J=ia.length;I<J;I++)ab.push(R[Fa].data[ia[I]]);aa.colors.push(ab)}}}}ma.parts.push(aa)}}if(1!==gb){v=0;for(C=ma.points.length;v<C;v++)ma.points[v]=c.fixuaxis(O.up_axis,ma.points[v])}ma.id=Xa;O.meshes.push(ma)}}}var mc=
Q.library_cameras;if(mc){(Ra=mc.camera)&&!Ra.length&&(Ra=[Ra]);L=0;for(M=Ra.length;L<M;L++){ha=Ra[L];var Rc=ha["@id"],wb=0,xb=0,yb=0;ha.optics&&(ha.optics.technique_common&&ha.optics.technique_common.perspective)&&(wb=ha.optics.technique_common.perspective.yfov,xb=ha.optics.technique_common.perspective.znear,yb=ha.optics.technique_common.perspective.zfar);var Pb,Qb,Rb;if(!wb&&!xb&&!yb){(da=ha.param)&&!da.length&&(da=[da]);v=0;for(C=da.length;v<C;v++){var Sb=da[v].$,Tb=da[v]["@name"];"YFOV"==Tb?Pb=
parseFloat(Sb):"ZNEAR"==Tb?Qb=parseFloat(Sb):"ZFAR"==Tb&&(Rb=parseFloat(Sb))}}else Pb=wb?parseFloat(wb.$):60,Qb=xb?parseFloat(xb.$):0.1,Rb=yb?parseFloat(yb.$):1E3;O.cameras.push({id:Rc,targeted:!1,fov:parseFloat(Pb),nearclip:parseFloat(Qb),farclip:parseFloat(Rb)})}}var nc=Q.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Ub=0,Sc=Ia.length;Ub<Sc;Ub++){Ha=Ia[Ub];var pc,nb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=
zb;nb=Ha.technique_common[zb];break}if(nb){var Tc=oc[pc]||"point",qc=Ha["@id"],rc=nb.intensity,Uc=rc?parseFloat(rc.$):1,sc=nb.distance,Vc=sc?parseFloat(sc.$):10,tc=nb.color,ia=[1,1,1];tc&&(ia=e.floatDelimArray(tc.$," "));O.lights.push({id:qc,name:qc,type:Tc,method:m.light.method.STATIC,diffuse:ia,specular:[0,0,0],distance:Vc,intensity:Uc})}}}var uc=Q.library_visual_scenes;if(uc){var bb=null;(bb=uc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Vb=0,Wc=bb.length;Vb<Wc;Vb++){Sa=bb[Vb];var ya={id:Sa["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]},pa=[],cb=[],za,Wb,la,ba,$,vc=Q.library_nodes;if(vc){var db=vc.node;db&&!db.length&&(db=[db]);pa=[];v=0;for(C=db.length;v<C;v++)Wb=db[v],mnodeId=Wb["@id"],pa[la]=Wb;for(za=[Sa];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){v=0;for(C=$.length;v<C;v++)za.push($[v])}if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);v=0;for(C=eb.length;v<C;v++){var Xb=eb[v]["@url"].substr(1);pa[Xb]&&(ba.node&&ba.node.length&&
(ba.node=[ba.node]),ba.node?ba.node.push(pa[Xb]):ba.node=[pa[Xb]])}}}}for(za=[Sa];za.length;)if(ba=za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){v=0;for(C=$.length;v<C;v++)$[v].parentNode=ba,cb.push($[v]),za.push($[v])}if(cb.length)for(var ob=0,Xc=cb.length;ob<Xc;ob++){var Aa=cb[ob],Ba=Aa.instance_geometry;Ha=cb[ob].instance_light;ha=cb[ob].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ga=c.cl_getInitalTransform(O.up_axis,Aa);2===gb&&(ga.rotation=c.quaternionFilterZYYZ(ga.rotation,ha?[-90,
0,0]:u));var pb=null,X=null,fb;if(Ba){Ba&&!Ba.length&&(Ba=[Ba]);v=0;for(C=Ba.length;v<C;v++)if(D=Ba[v]["@url"].substr(1),X={},X.name=(fa?fa:la)+(v?v:""),X.id=(la?la:fa)+(v?v:""),X.meshId=Xa,X.meshName=D,pb||(X.position=ga.position,X.rotation=ga.rotation,X.scale=ga.scale,X.matrix=ga.matrix),ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode)(fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:X.id}):1<Ba.length&&(pb?pa[pb.id]&&ya.parentMap.push({parent:pb.id,child:X.id}):(pb=X,X={}))}else if(ha){var Yc=
ha["@url"].substr(1);ya.cameras.push({name:fa?fa:la,id:fa?fa:la,source:Yc,position:ga.position,rotation:ga.rotation})}else if(Ha){var Zc=Ha["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Zc,position:ga.position,rotation:ga.rotation||[0,0,0]})}else X={position:ga.position,rotation:ga.rotation,scale:ga.scale,matrix:ga.matrix},X.name=fa?fa:la,X.id=la?la:fa,ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:X.id})}O.scenes.push(ya)}}var wc=
Q.library_animations,qa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Yb=0,$c=Ja.length;Yb<$c;Yb++){var Ab=Ja[Yb];qa=Ab["@id"];O.animations[qa]={};O.animations[qa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){K=0;for(N=Ka.length;K<N;K++){var Ca=Ka[K];o=Ca["@id"];var xc=Ca.technique_common,Bb=null,yc=null;Ca.name_array?Bb=e.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Bb=e.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(yc=e.floatDelimArray(Ca.float_array.$,
" "));var Zb=0,zc="",Cb=1;if(xc){f=xc;var $b=f.accessor,Zb=parseInt($b["@count"],10),zc=$b["@source"].substr(1),Ac=$b["@stride"];Ac&&(Cb=parseInt(Ac,10))}O.animations[qa].sources[o]={data:Bb?Bb:yc,count:Zb,source:zc,stride:Cb};1!==Cb&&(O.animations[qa].sources[o].data=e.repackArray(O.animations[qa].sources[o].data,Cb,Zb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){O.animations[qa].samplers=[];K=0;for(N=Da.length;K<N;K++){var Bc=Da[K],ad=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=
[];y=0;for(C=P.length;y<C;y++)W=P[y],Cc[W["@semantic"]]=W["@source"].substr(1);O.animations[qa].samplers[ad]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){O.animations[qa].channels=[];L=0;for(M=La.length;L<M;L++){var Dc=La[L],bd=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),cd=Fc[0],Gc=Fc[1].split(".");O.animations[qa].channels.push({source:bd,target:Ec,targetName:cd,paramName:Gc[0],typeName:Gc[1]})}}}}var Hc=Q.scene;if(Hc&&(Sa=Hc.instance_visual_scene)){var dd=Sa["@url"].substr(1);
O.scene=dd}return O}var u=h.undef,m=h.enums,q=h.GLCore,r=h.log,c={fixuaxis:function(c,d){if(0===c)return[d[1],d[0],d[2]];if(1===c)return d;if(2===c)return[d[0],d[2],-d[1]]},fixscaleaxis:function(c,d){if(0===c)return[d[1],d[0],d[2]];if(1===c)return d;if(2===c)return[d[0],d[2],d[1]]},fixukaxis:function(c,d,a,b){return d===m.motion.POS&&a===m.motion.Z&&c===m.motion.Z?-b:b},getAllOf:function(c,d){for(var a=[c],b=[],e,f,o,n;a.length;)for(f in e=a.pop(),e)if(e.hasOwnProperty(f)){if(f===d)if(e[f].length){o=
0;for(n=e[f].length;o<n;o++)b.push(e[f][o])}else b.push(e[f]);if("object"==typeof e[f])if(e[f].length){o=0;for(n=e[f].length;o<n;o++)a.push(e[f][o])}else a.push(e[f])}return b},quaternionFilterZYYZ:function(c,d){var a=h.vec3,b=c,e=new h.Quaternion;d!==u&&(b=a.add(c,d));e.fromEuler(b[0],b[2],-b[1]);return e.toEuler()},cl_getInitalTransform:function(g,d){var a=h.util,b={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},e=d.translate,f=d.rotate,o=d.scale;if(d.matrix&&!e&&!f&&!o)return b;e&&e.$&&(b.position=
c.fixuaxis(g,a.floatDelimArray(e.$," ")));if(f)for(var e=0,n=f.length;e<n;e++){var m=f[e],q=m["@sid"],m=a.floatDelimArray(m.$," ");if("rotateX"==q||"rotationX"==q)b.rotation[0]=m[3];else if("rotateY"==q||"rotationY"==q)b.rotation[1]=m[3];else if("rotateZ"==q||"rotationZ"==q)b.rotation[2]=m[3]}o&&(b.scale=c.fixscaleaxis(g,a.floatDelimArray(o.$," ")));return b}};return{loadCollada:function(g,d,a){var d=x(g,d,a),b=d.up_axis,e=[],f,o,n,s,r,w,t,B;o=0;for(n=d.materials.length;o<n;o++){r=d.materials[o];
t=new h.Material(r.mat);t.name=r.name||null;w=0;for(s=r.mat.textures_ref.length;w<s;w++){B=r.mat.textures_ref[w];var A=null,A=void 0===h.Textures_ref[B.image]?new h.Texture(B.image,q.default_filter,a,g):h.Textures_obj[h.Textures_ref[B.image]];t.setTexture(A,B.type)}e[r.id]=t}w=[];o=0;for(n=d.meshes.length;o<n;o++){var A=d.meshes[o],E=new h.Mesh({name:A.id});E.points=A.points;var F=!1;t=0;for(B=A.parts.length;t<B;t++){var v=A.parts[t];0!==v.material&&((s=e[v.material])||(s=new h.Material({name:v.material})),
E.setFaceMaterial(s));var y=v.normals.length?!0:!1,C=v.texcoords.length?!0:!1,z=v.colors.length?!0:!1;z&&(e[v.material].color_map=!0);s=0;for(r=v.faces.length;s<r;s++){var G=E.addFace(v.faces[s]);y&&(E.faces[G].point_normals=v.normals[s]);C&&(E.faces[G].uvs=v.texcoords[s]);z&&(E.faces[G].point_colors=v.colors[s])}F|=y}E.faces.length&&(a?a.addMesh(g,g+":"+meshId,E):(F||E.calcNormals(),E.triangulateQuads(),E.compile()),w[A.id]=E)}n=[];g=0;for(s=d.cameras.length;g<s;g++)n[d.cameras[g].id]=d.cameras[g];
A=[];s=0;for(r=d.lights.length;s<r;s++)A[d.lights[s].id]=d.lights[s];a={};e={};o={};g={};t=0;for(B=d.scenes.length;t<B;t++){E=d.scenes[t];F=new h.Scene;s=0;for(r=E.sceneObjects.length;s<r;s++)v=E.sceneObjects[s],y=new h.SceneObject(v),y.obj=(w[v.meshName]?w[v.meshName]:w[v.meshId])||null,v.matrix&&y.setMatrix(v.matrix),a[v.id]=y,F.bindSceneObject(y);s=0;for(r=E.lights.length;s<r;s++)v=E.lights[s],y=new h.Light(A[v.source]),y.position=v.position,y.rotation=v.rotation,e[v.id]=y,F.bindLight(y);E.cameras.length&&
(s=E.cameras[0],r=new h.Camera(n[s.source]),r.position=s.position,r.rotation=s.rotation,o[s.id]=r,F.camera=r);s=0;for(r=E.parentMap.length;s<r;s++)v=E.parentMap[s],a[v.parent].bindChild(a[v.child]);g[E.id]=F}for(var H in d.animations)if(d.animations.hasOwnProperty(H)&&(w=d.animations[H],w.channels.length)){cCount=0;for(s=w.channels.length;cCount<s;cCount++){n=w.channels[cCount];v=w.samplers[n.source];r=w.sources[v.INPUT];t=w.sources[v.OUTPUT];B=w.sources[v.INTERPOLATION];var A=w.sources[v.IN_TANGENT],
E=w.sources[v.OUT_TANGENT],F=v.IN_TANGENT!==u,v=v.OUT_TANGENT!==u,y=null,z=a[n.targetName],C=o[n.targetName],I=e[n.targetName];z?(null===z.motion&&(z.motion=new h.Motion),y=z.motion):C?(null===C.motion&&(C.motion=new h.Motion),y=C.motion):I&&(null===I.motion&&(I.motion=new h.Motion),y=I.motion);if(null!==y){z=m.motion.POS;G=m.motion.X;2===b&&(y.yzflip=!0);f=n.paramName;if("rotateX"===f||"rotationX"===f)z=m.motion.ROT,G=m.motion.X;else if("rotateY"===f||"rotationY"===f)z=m.motion.ROT,G=m.motion.Y;
else if("rotateZ"===f||"rotationZ"===f)z=m.motion.ROT,G=m.motion.Z;else if("location"===f){if(z=m.motion.POS,"X"===n.typeName&&(G=m.motion.X),"Y"===n.typeName&&(G=m.motion.Y),"Z"===n.typeName)G=m.motion.Z}else if("translate"===f){if(z=m.motion.POS,"X"===n.typeName&&(G=m.motion.X),"Y"===n.typeName&&(G=m.motion.Y),"Z"===n.typeName)G=m.motion.Z}else if("LENS"===f)continue;else"FOV"===f?(z=m.motion.FOV,G=3):"ZNEAR"===f?(z=m.motion.NEARCLIP,G=3):"ZFAR"===f?(z=m.motion.FARCLIP,G=3):"intensity"===f&&(z=
m.motion.INTENSITY,G=3);I&&3>z&&(I.method=m.light.method.DYNAMIC);mCount=0;for(n=r.data.length;mCount<n;mCount++)if(k=null,"object"===typeof t.data[mCount]){i=0;for(iMax=t.data[mCount].length;i<iMax;i++)I=i,2===b&&2===i?I=1:2===b&&1===i&&(I=2),k=y.setKey(z,I,r.data[mCount],c.fixukaxis(d.up_axis,z,I,t.data[mCount][i])),B&&(f=B.data[mCount][i],"LINEAR"===f?k.shape=m.envelope.shape.LINE:"BEZIER"===f&&(k.shape=!F&&!v?m.envelope.shape.LINEAR:m.envelope.shape.BEZI))}else if(I=G,ofs=0,C&&z===m.motion.ROT&&
2===b&&0===I&&(ofs=-90),z===m.motion.ROT?k=y.setKey(z,I,r.data[mCount],t.data[mCount]+ofs):(2===b&&2===G?I=1:2===b&&1===G&&(I=2),k=y.setKey(z,I,r.data[mCount],c.fixukaxis(d.up_axis,z,I,t.data[mCount]))),B)if(f=B.data[mCount],"LINEAR"===f)k.shape=m.envelope.shape.LINE;else if("BEZIER"===f)if(!F&&!v)k.shape=m.envelope.shape.LINEAR,k.continutity=1;else{k.shape=m.envelope.shape.BEZ2;f=A.data[mCount][0];var J,L=E.data[mCount][0];z===m.motion.ROT?(J=A.data[mCount][1],I=E.data[mCount][1],k.param[0]=f-k.time,
k.param[1]=J-k.value+ofs,k.param[2]=L-k.time,k.param[3]=I-k.value+ofs):(J=c.fixukaxis(d.up_axis,z,I,A.data[mCount][1]),I=c.fixukaxis(d.up_axis,z,I,E.data[mCount][1]),k.param[0]=f-k.time,k.param[1]=J-k.value,k.param[2]=L-k.time,k.param[3]=I-k.value)}}}}H=null;return H=d.scene?g[d.scene]:g.pop()},parseCollada:x}});
CubicVR.RegisterModule("GML",function(h){function x(m){var h=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(m!==u){var m=h.getXML(m),r=m.getElementsByTagName("header");if(!r.length)return null;var c=r[0],r=m.getElementsByTagName("environment");if(!r.length)return null;this.name=null;c=c.getElementsByTagName("name");c.length&&(this.name=h.collectTextNode(c[0]));c=r[0].getElementsByTagName("screenBounds");c.length&&
(this.bounds=[parseFloat(h.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(c[0].getElementsByTagName("z")[0]))]);c=r[0].getElementsByTagName("origin");c.length&&(this.origin=[parseFloat(h.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(c[0].getElementsByTagName("z")[0]))]);r=r[0].getElementsByTagName("up");
r.length&&(this.upvector=[parseFloat(h.collectTextNode(r[0].getElementsByTagName("x")[0])),parseFloat(h.collectTextNode(r[0].getElementsByTagName("y")[0])),parseFloat(h.collectTextNode(r[0].getElementsByTagName("z")[0]))]);m=m.getElementsByTagName("drawing");r=0;for(c=m.length;r<c;r++)for(var g=m[r].getElementsByTagName("stroke"),d=0,a=0,b=0,e=0,f=0,o=g.length;f<o;f++){for(var n=g[f].getElementsByTagName("pt"),s=n.length,D=Array(s),w,t,B,A=0,E=s;A<E;A++)B=n[A],s=parseFloat(h.collectTextNode(B.getElementsByTagName("x")[0])),
w=parseFloat(h.collectTextNode(B.getElementsByTagName("y")[0])),t=parseFloat(h.collectTextNode(B.getElementsByTagName("z")[0])),B=parseFloat(h.collectTextNode(B.getElementsByTagName("time")[0])),1===this.upvector[0]?D[A]=[w!==w?0:w,s!==s?0:-s,t!==t?0:t,B]:1===this.upvector[1]?D[A]=[s!==s?0:s,w!==w?0:w,t!==t?0:t,B]:1===this.upvector[2]&&(D[A]=[s!==s?0:s,t!==t?0:-t,w!==w?0:w,B]),d<s&&(d=s),a<w&&(a=w),b<t&&(b=t),e<B&&(e=B);if(b>e){n=0;for(A=D.length;n<A;n++)s=D[n][3],D[n][3]=D[n][2],D[n][2]=s/this.bounds[2]}this.strokes[f]=
D}}}var u=h.undef;x.prototype={addStroke:function(m,h){var r=[];h===u&&(h=0.1);for(var c=0,g=m.length;c<g;c++){var d=[m[c][0],m[c][1],m[c][2]];this.manual_pos+=h;d.push(this.manual_pos);r.push(d)}this.strokes.push(r)},recenter:function(){var m=CubicVR.vec3,h=[0,0,0],r=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,g,d,a;d=0;for(a=this.strokes.length;d<a;d++){c=0;for(g=this.strokes[d].length;c<g;c++)h[0]>this.strokes[d][c][0]&&(h[0]=this.strokes[d][c][0]),h[1]>this.strokes[d][c][1]&&
(h[1]=this.strokes[d][c][1]),h[2]>this.strokes[d][c][2]&&(h[2]=this.strokes[d][c][2]),r[0]<this.strokes[d][c][0]&&(r[0]=this.strokes[d][c][0]),r[1]<this.strokes[d][c][1]&&(r[1]=this.strokes[d][c][1]),r[2]<this.strokes[d][c][2]&&(r[2]=this.strokes[d][c][2])}m=m.multiply(m.subtract(r,h),0.5);d=0;for(a=this.strokes.length;d<a;d++){c=0;for(g=this.strokes[d].length;c<g;c++)this.strokes[d][c][0]-=m[0],this.strokes[d][c][1]-=this.upvector[1]?m[1]:-m[1],this.strokes[d][c][2]-=m[2]}},generateObject:function(m,
h,r,c,g){var d=CubicVR.vec3;m===u&&(m=0);h===u&&(h=0);g===u&&(g=!1);c===u&&(c=0.02);r===u&&(r=0.015);for(var a=0!==h,b=0,e=0,f=new CubicVR.Mesh(this.name),o,n,s,D,w,t,B=0,A=this.strokes.length;B<A;B++){t=new CubicVR.Envelope;var E=new CubicVR.Envelope,x=new CubicVR.Envelope,v=this.strokes[B].length,y=[],C=[],z=0,G=this.strokes[B];for(w=0;w<v;w++){var H=G[w],I=t.addKey(H[3],H[0]),J=E.addKey(H[3],H[1]),L;L=g?x.addKey(H[3],H[2]):x.addKey(H[3],0);I.tension=0.5;J.tension=0.5;L.tension=0.5;0!==w?(o=H[0]-
o,n=H[1]-n,s=H[2]-s,D=H[3]-D,s=Math.sqrt(o*o+n*n+s*s),y[w-1]=s,C[w-1]=D):z=H[3];o=H[0];n=H[1];s=H[2];D=H[3]}v=f.points.length;for(w=0;w<y.length;w++){G=C[w];J=Math.ceil(3*(y[w]/c));H=z;I=z+G;for(J=G/J;H<I-J;H+=J){H===z&&(o=t.evaluate(H),n=E.evaluate(H),s=x.evaluate(H));var M,K;L=t.evaluate(H+J);M=E.evaluate(H+J);K=x.evaluate(H+J);var N=L-o,Y=M-n,ca=K-s;Math.sqrt(N*N+Y*Y+ca*ca);N=d.multiply(d.normalize(d.cross(this.viewvector,d.normalize([N,Y,ca]))),r/2);f.addPoint([o-N[0],-(n-N[1]),s-N[2]+(a?h/2:
0)]);f.addPoint([o+N[0],-(n+N[1]),s+N[2]+(a?h/2:0)]);o=L;n=M;s=K}z+=G}E=f.points.length;if(a){w=v;for(t=E;w<t;w++)f.addPoint([f.points[w][0],f.points[w][1],f.points[w][2]-(a?h/2:0)])}w=0;for(t=E-v;w<=t-4;w+=2){0===b%m&&e++;f.setSegment(e);x=[v+w,v+w+1,v+w+3,v+w+2];f.addFace(x);if(a&&(x=[x[3]+E-v,x[2]+E-v,x[1]+E-v,x[0]+E-v],f.addFace(x),x=[v+w,v+w+2,v+w+2+E-v,v+w+E-v],f.addFace(x),x=[v+w+1+E-v,v+w+3+E-v,v+w+3,v+w+1],f.addFace(x),0===w&&(x=[v+w+E-v,v+w+1+E-v,v+w+1,v+w],f.addFace(x)),w===t-4))x=[v+w+
2,v+w+3,v+w+3+E-v,v+w+2+E-v],f.addFace(x);b++}}f.calcFaceNormals();f.triangulateQuads();f.calcNormals();f.compile();return f}};return{GML:x}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(h){if(!h.src)throw"PDF Error: you must specify a src url for a PDF.";var x=h.src,u=h.callback||function(){},m,q=[],r=[];this.__defineGetter__("pages",function(){return m?m.numPages:0});this.getPage=function(c){var g=m.numPages,c=1>c?1:c;return q[(c>g?g:c)-1]};this.getPageTexture=function(c,g,d){c=this.getPage(c);g=g||c.width;d=d||c.height;return new CubicVR.PdfTexture(c,{width:g,height:d})};getPdf({url:x,error:function(){console.log("PDF Error: error loading pdf `"+
x+"`")}},function(c){m=new PDFDoc(c);for(var c=1,g=m.numPages;c<=g;c++){var d=m.getPage(c);q.push(d);r.push(d)}u()})}}});
CubicVR.RegisterModule("Particles",function(h){function x(m,h,c,g,d,a,b){m&&(this.last_particle=this.particles=null,this.pTex=c!==u?c:null,this.vWidth=g,this.vHeight=d,this.alpha=a!==u?a:!1,this.alphaCut=b!==u?b:0,this.pfunc=function(a,b){var c=b-a.start_time;if(0>c)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];null!==this.pgov&&this.pgov(a,
b);return 1},this.pgov=null,this.hasColor=h===u?!1:h,c=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=m,this.numParticles=0,this.arPoints=new Float32Array(3*m),this.glPoints=null,h&&(this.arColor=new Float32Array(3*m),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition",
0),this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,d,0])),this.genBuffer())}var u=h.undef,m=h.GLCore;x.prototype={resizeView:function(m,h){this.vWidth=m;this.vHeight=h;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[m,h,0]))},addParticle:function(m){null===this.last_particle?this.particles=m:this.last_particle.nextParticle=m;this.last_particle=m},genBuffer:function(){var h=m.gl;this.glPoints=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW);this.hasColor&&(this.glColor=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW))},updatePoints:function(){var h=m.gl;h.bindBuffer(h.ARRAY_BUFFER,
this.glPoints);h.bufferData(h.ARRAY_BUFFER,this.arPoints,h.DYNAMIC_DRAW)},updateColors:function(){var h=m.gl;this.hasColor&&(h.bindBuffer(h.ARRAY_BUFFER,this.glColor),h.bufferData(h.ARRAY_BUFFER,this.arColor,h.DYNAMIC_DRAW))},draw:function(h,r,c){var g=m.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",h);this.shader_particle.setMatrix("uPMatrix",r);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(c!==u){this.numParticles=0;if(null===this.particles){g.disable(g.BLEND);return}for(var h=this.particles,r=null,d=0;null!==h;){var a=3*this.numParticles,
b=this.pfunc(h,c);if(1===b){if(this.arPoints[a]=h.pos[0],this.arPoints[a+1]=h.pos[1],this.arPoints[a+2]=h.pos[2],null!==h.color&&this.arColor!==u&&(this.arColor[a]=h.color[0],this.arColor[a+1]=h.color[1],this.arColor[a+2]=h.color[2]),this.numParticles++,d++,this.numParticles===this.maxPoints)break}else-1===b?null!==r&&(r.nextParticle=h.nextParticle):0===b&&d++;r=h;h=h.nextParticle}d||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(g.enable(g.BLEND),
g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:x,Particle:function(h,m,c,g,d){this.startpos=new Float32Array(h);this.pos=new Float32Array(h);this.velocity=new Float32Array(g!==u?g:[0,0,0]);this.accel=new Float32Array(d!==u?d:[0,0,0]);this.start_time=
m!==u?m:0;this.life_time=c!==u?c:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("Lines",function(h){function x(h){h=h||{};this.color=h.color||[1,1,1];this.maxPoints=h.maxPoints||1024;this.vs="#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvoid main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\ngl_Position = position;\n}";this.fs="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 color;\nvoid main(void) {\nvec4 c = vec4(color,1.0);\ngl_FragColor = c;\n}";this.arLines=
new Float32Array(6*this.maxPoints);this.glLines=null;this.lineLength=0;this.shader_line=new CubicVR.Shader(this.vs,this.fs);this.shader_line.use();this.shader_line.addVertexArray("aVertexPosition",0);this.shader_line.addVector("color",this.color);this.shader_line.addMatrix("uMVMatrix");this.shader_line.addMatrix("uPMatrix");this.genBuffer();this.newSegment=!1}var u=h.GLCore;x.prototype={genBuffer:function(){var h=u.gl;this.glLines=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,
this.arLines,h.DYNAMIC_DRAW)},update:function(){var h=u.gl;h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,this.arLines,h.DYNAMIC_DRAW)},addPoint:function(h){var q=this.lineLength;1<q&&(this.arLines[3*q]=this.arLines[3*(q-1)],this.arLines[3*q+1]=this.arLines[3*(q-1)+1],this.arLines[3*q+2]=this.arLines[3*(q-1)+2],this.lineLength++,q++);this.arLines[3*q]=h[0];this.arLines[3*q+1]=h[1];this.arLines[3*q+2]=h[2];this.lineLength++},addSegment:function(h){var q=this.lineLength;this.arLines[3*
q]=h[0];this.arLines[3*q+1]=h[1];this.arLines[3*q+2]=h[2];this.lineLength++},clear:function(){this.lineLength=0},render:function(h){var q=u.gl,r=h.mvMatrix,h=h.pMatrix;this.shader_line.use();this.shader_line.setMatrix("uMVMatrix",r);this.shader_line.setMatrix("uPMatrix",h);this.shader_line.setVector("color",this.color);q.bindBuffer(q.ELEMENT_ARRAY_BUFFER,null);q.bindBuffer(q.ARRAY_BUFFER,this.glLines);q.vertexAttribPointer(this.shader_line.uniforms.aVertexPosition,3,q.FLOAT,!1,0,0);q.enableVertexAttribArray(this.shader_line.uniforms.aVertexPosition);
q.drawArrays(q.LINES,0,this.lineLength)}};return{Lines:x}});
CubicVR.RegisterModule("HeightField",function(h){var x=h.undef,u=h.enums;u.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var m=function(c){c=c||{};this.operation=h.parseEnum(u.draw.op,c.operation||c.op)||u.draw.op.REPLACE;this.brushType=h.parseEnum(u.draw.brush,c.brushType)||u.draw.brush.SINE;this.brushSize=c.size||5;this.strength=c.strength||1};m.prototype={setOperation:function(c){this.operation=h.parseEnum(u.draw.op,c)},getOperation:function(){return this.operation},setBrushType:function(c){this.brushType=
h.parseEnum(u.draw.brush,c)||u.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(c){this.brushSize=c},getSize:function(){return this.brushSize},setStrength:function(c){this.strength=c},getStrength:function(){return this.strength}};var q=function(c){c=c||{};this.divX=c.divX||null;this.divZ=c.divZ||null;this.size=c.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.ofsX=c.ofsX||-this.cellSize/2;this.ofsZ=
c.ofsZ||-this.cellSize/2;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};q.prototype={initBuffer:function(c,g,d){this.hfBuffer=new ArrayBuffer(4*c*g);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=c||null;this.divZ=g||null;this.size=d||null;this.divX>this.divZ?(this.sizeX=d,this.sizeZ=d/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?
d/this.divZ*this.divX:d,this.sizeZ=d);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX;this.startX=-(this.sizeX/2)+this.ofsX;this.startZ=-(this.sizeZ/2)+this.ofsZ},setBrush:function(c){this.brush=c},getBrush:function(){return this.brush},draw:function(c,g,d){var a=this.brush||d,d=a.getOperation(),b=a.getSize(),e=a.getBrushType(),a=a.getStrength();if(this.areaBuffered){var f=c-b,o=g-b,n=c+b,h=g+b;f<this.drawArea.startX&&(this.drawArea.startX=f);o<this.drawArea.startZ&&(this.drawArea.startZ=o);
n>this.drawArea.endX&&(this.drawArea.endX=n);n>this.drawArea.endX&&(this.drawArea.endZ=h)}else this.drawArea={startX:c-b,startZ:g-b,endX:c+b,endZ:g+b},this.areaBuffered=!0;this.drawBuffer.push([c,g,d,b,e,a])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var c=this.drawBuffer.pop();this.drawFunc(c[0],c[1],c[2],c[3],c[4],c[5])}return!0},needsFlush:function(){return 0!==
this.drawBuffer.length},drawFunc:function(c,g,d,a,b,e){for(var d=this.hfFloatBuffer,b=this.divX,f=this.divZ,a=a/this.cellSize,c=(c-this.startX)/this.cellSize,g=(g-this.startZ)/this.cellSize,o=parseInt(Math.floor(c-a),10),n=parseInt(Math.ceil(c+a),10);o<n;o++)for(var h=o-c,m=parseInt(Math.floor(g-a),10),q=parseInt(Math.ceil(g+a),10);m<q;m++)if(!(0>o||o>=b||0>m||m>=f)){var t=m-g,t=e*((1-Math.sqrt(h*h+t*t)/a)/2);0>t&&0<=e&&(t=0);0<t&&0>=e&&(t=0);d[m*b+o]+=t}},getUint8Buffer:function(){return this.hfUInt8Buffer},
getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getStartX:function(){return this.startX},getStartZ:function(){return this.startZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(c){var c=c||{},g=c.value||0,d=c.src||c.func||null,a=c.startX||0,b=c.startZ||0,e=c.walkX,f=c.walkZ,c=this.hfFloatBuffer,
o,n=this.startX,h=this.startZ;if(a!==x&&b!==x&&e!==x&&f!==x){if(!(a>=this.divX)&&!(b>=this.divZ)&&(a+e>=this.divX&&(e=this.divX-1-a),b+f>=this.divZ&&(f=this.divZ-1-b),!(0>=e||0>=f))){o=a;for(a+=e;o<a;o++)for(var e=b,m=b+f;e<m;e++){var q=o+e*this.divX;c[q]=null===d?g:d(this.cellSize*o+n,this.cellSize*e+h,q)}}}else{o=0;for(a=this.hfFloatBuffer.length;o<a;o++)null===d?c[o]=g:(b=d(o%this.divX*this.cellSize+n,Math.floor(o/this.divX)*this.cellSize+h,o),c[o]=b)}},getIndicesAt:function(c,g){if("object"===
typeof c)return this.getIndicesAt(c[0],c[2]);var d=this.startX,a=this.startZ,b=Math.floor((c-d)/this.cellSize),e=Math.floor((g-a)/this.cellSize);if(0>b||b>=this.divX-1||0>e||e>=this.divZ-1)return-1;if(1<=Math.abs(g-((e+1)*this.cellSize+a))/Math.abs(c-(b*this.cellSize+d)))return d=[b+(e+1)*this.divX,b+1+e*this.divX,b+e*this.divX],[b,e,d,0];d=[b+(e+1)*this.divX,b+1+(e+1)*this.divX,b+1+e*this.divX];return[b,e,d,1]},getHeightValue:function(c,g){var d=h.triangle;if("object"===typeof c)return this.getHeightValue(c[0],
c[2]);var a=this.getIndicesAt(c,g);if(-1===a)return 0;var b=a[2],e=a[0]*this.cellSize+this.startX,f=a[1]*this.cellSize+this.startZ,o;o=0===a[3]?d.normal([e,this.hfFloatBuffer[b[0]],f+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[b[1]],f],[e,this.hfFloatBuffer[b[2]],f]):d.normal([e,this.hfFloatBuffer[b[0]],f+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[b[1]],f+this.cellSize],[e+this.cellSize,this.hfFloatBuffer[b[2]],f]);d=o[0];a=o[1];o=o[2];b=[e,this.hfFloatBuffer[b[0]],f+this.cellSize];
return(d*c+o*g+(-(d*b[0])-a*b[1]-o*b[2]))/-a},rayIntersect:function(c,g){var d=c.slice(0),a=this.startX,b=this.startZ,e=this.startX+this.sizeX,f=this.startZ+this.sizeZ,o=this.cellSize,n=h.vec2,m=h.vec3,q=m.normalize(g),r=[q[0],q[2]],t=[d[0],d[2]];if(d[0]<a||d[0]>e||d[2]<b||d[2]>f){var B=[[a,b],[e,b],[a,f],[e,f]],A=[];d[0]>=e&&A.push([B[1],B[3]]);d[0]<=a&&A.push([B[0],B[2]]);d[2]>=f&&A.push([B[2],B[3]]);d[2]<=b&&A.push([B[0],B[1]]);if(0!==A.length){d=[];e=0;for(f=A.length;e<f;e++)B=n.lineIntersect(t,
n.add(t,r),A[e][0],A[e][1]),!1!==B&&n.onLine(A[e][0],A[e][1],B)&&d.push(B);B=0;A=-1;e=0;for(f=d.length;e<f;e++){var u=n.length(d[e],t);0===e?(B=u,A=0):u<B&&(A=e,B=u)}if(-1!=A){if(v=B/n.length(r),d=[d[A][0],0,d[A][1]],d[1]=c[1]+q[1]*v,d[1]<=this.getHeightValue(d[0],d[2]))return!1}else return!1}t=[d[0],d[2]]}B=Math.floor((t[0]-a)/o);f=Math.floor((t[1]-b)/o);A=t[0]-(a+B*o);e=t[1]-(b+f*o);e=A<e?A/Math.abs(r[0]):e/Math.abs(r[1]);0===e?(A=t[0],e=t[1]):(A=t[0]+e*r[0],e=t[1]+e*r[1]);for(var B=A-(a+B*o),u=
e-(b+f*o),f=0<=r[0]?B:o-B,B=0<=r[1]?u:o-u,u=this.getFloat32Buffer(),x,v;;){var y=(o-f)/Math.abs(r[0]),C=(o-B)/Math.abs(r[1]),y=y<C?y:C;x=r[0]*y;var z=r[1]*y,f=f+Math.abs(x),B=B+Math.abs(z),y=(A+(A+x))/2,C=(e+(e+z))/2,A=A+x,e=e+z,y=Math.floor((y-a)/o),C=Math.floor((C-b)/o);if(f>=o)for(;f>=o;)f-=o;if(B>=o)for(;B>=o;)B-=o;v=n.length(t,[A,e])/n.length(r);x=n.length(t,[A-x,e-z])/n.length(r);v=d[1]+q[1]*v;x=d[1]+q[1]*x;if(y>this.divX||0>y||C>this.divZ||0>C)return!1;var z=u[C*this.divX+y],G=u[C*this.divX+
y+1],H=u[(C+1)*this.divX+y],I=u[(C+1)*this.divX+y+1];if(0>=v-z||0>=v-G||0>=v-H||0>=v-I||0>=x-z||0>=x-G||0>=x-H||0>=x-I){G=[y+(C+1)*this.divX,y+1+C*this.divX,y+C*this.divX];z=[y+(C+1)*this.divX,y+1+(C+1)*this.divX,y+1+C*this.divX];v=a+o*y;x=b+o*C;tmpNormA=h.triangle.normal([v,u[G[0]],x+o],[v+o,u[G[1]],x],[v,u[G[2]],x]);tmpNormB=h.triangle.normal([v,u[z[0]],x+o],[v+o,u[z[1]],x+o],[v+o,u[z[2]],x]);G=m.linePlaneIntersect(tmpNormA,[v,u[G[0]],x+o],d,m.add(d,q));y=Math.abs(b+(C+1)*o-G[0])/Math.abs(a+y*o-
G[2]);if(1<=y&&G[0]>=v-1.0E-8&&G[0]<=v+o+1.0E-8&&G[2]>=x-1.0E-8&&G[2]<=x+1.0E-8+o)return G;C=m.linePlaneIntersect(tmpNormB,[v,u[z[0]],x+o],d,m.add(d,q));if(1>y&&C[0]>=v-1.0E-8&&C[0]<=v+o+1.0E-8&&C[2]>=x-1.0E-8&&C[2]<=x+o+1.0E-8)return C}}}};var r=h.extendClassGeneral(h.Mesh,function(c){c=c||{};c.dynamic=!0;c.buildWireframe=!0;this.material=c.material;this._update=h.Mesh.prototype.update;h.Mesh.apply(this,[c]);this.hField=c.hField||null;this.divX=c.divX||null;this.divZ=c.divZ||null;this.viewX=c.viewX||
0;this.viewZ=c.viewZ||0;this.ofsX=c.ofsX||0;this.ofsZ=c.ofsZ||0;this.edgeX=c.edgeX||0;this.edgeZ=c.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(c,g,d){this.points[c+g*this.divX][1]=d},genHeightfieldMesh:function(){var c,g,d=this.divX+this.edgeX,a=this.divZ+this.edgeZ,b=this.hField.getCellSize(),e=b*this.divX;c=b*this.divZ;0!==this.points.length&&this.clean();var f=-(c/2);for(g=0;g<a;g++){var o=-(e/2);for(c=0;c<d;c++)this.addPoint([o+this.ofsX,0,f+this.ofsZ]),
o+=b;f+=b}this.setFaceMaterial(this.material);c=-1/(d-1);g=1/(a-1);for(e=f=0;e<a-1;e++){o=1;for(b=0;b<d-1;b++)f1=this.addFace([b+(e+1)*d,b+1+e*d,b+e*d]),f2=this.addFace([b+(e+1)*d,b+1+(e+1)*d,b+1+e*d]),this.faces[f1].uvs=[[o,f+g],[o+c,f],[o,f]],this.faces[f2].uvs=[[o,f+g],[o+c,f+g],[o+c,f]],o+=c;f+=g}},recalcNormals:function(c){var g;if(c=c||this.normalMapRef){var c=this.divX+this.edgeX,d=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(g=0;g<this.points.length;g++)this.normalBuffer.push([0,
1,0]);var a=0;for(g=0;g<d-1;g++)for(k=0;k<c-1;k++)this.faces[a++].point_normals=[this.normalBuffer[k+(g+1)*c],this.normalBuffer[k+1+g*c],this.normalBuffer[k+g*c]],this.faces[a++].point_normals=[this.normalBuffer[k+(g+1)*c],this.normalBuffer[k+1+(g+1)*c],this.normalBuffer[k+1+g*c]]}d=this.hField;a=d.getFloat32Buffer();g=this.viewX||0;var b=(this.viewZ||0)*d.getDivX()+g;for(g=0;g<this.points.length;g++){var e=g%c,f=Math.floor(g/c),o=b+e+(f-1)*d.getDivX(),n=b+e+(f+1)*d.getDivX(),m=b+(e+1)+f*d.getDivX(),
q=b+(e-1)+f*d.getDivX(),e=b+e+f*d.getDivX(),o=a[o],n=a[n],m=a[m],q=a[q],e=a[e];o===x&&(o=e);n===x&&(n=e);m===x&&(m=e);q===x&&(q=e);q=h.vec3.normalize([(m-e+(e-q))/2,2,(o-e+(e-n))/2]);this.normalBuffer[g][0]=q[0];this.normalBuffer[g][1]=q[1];this.normalBuffer[g][2]=q[2]}return this}},update:function(){var c=this.viewX||0,g=this.viewZ||0,d=this.divX+this.edgeX,a=this.divZ+this.edgeZ,b=this.hField.getDivX();this.hField.getDivZ();for(var e=this.hField.getFloat32Buffer(),f=g,a=g+a;f<a;f++)for(var o=c,
n=c+d;o<n;o++)this.points[(f-g)*d+(o-c)][1]=e[f*b+o];this._update()}});return{HeightField:q,HeightFieldBrush:m,HeightFieldMesh:r}});
CubicVR.RegisterModule("Landscape",function(h){var x=h.undef,u=Math.PI/2;return{Landscape:h.extendClassGeneral(h.SceneObject,function(){if(1<arguments.length)this.hField=new h.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new h.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3],ofsX:this.hField.getCellSize()/2,ofsZ:this.hField.getCellSize()/2}),this.hfMesh.prepare(),h.SceneObject.apply(this,[{mesh:this.hfMesh,
shadowCast:!1}]);else{var m=arguments[0]||{};this.size=m.size||128;this.divX=m.divX||128;this.divZ=m.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=m.tileX||this.divX;this.tileZ=m.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new h.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*
this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=m.spatResolution||256;this.spats=m.spats||[];this.sourceSpats=m.spats.slice(0);h.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var q=0,r=0,c=0;c<this.divZ;c+=this.tileZ){for(var g=q=0;g<this.divX;g+=this.tileX){var d=new h.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),a=g+1!=this.tileX?1:0,b=c+1!=this.tileZ?1:0,e=new h.SpatMaterial({color:[1,
1,1],specular:[0.05,0.05,0.05],spats:this.sourceSpats,sourceTexture:d,spatResolution:this.spatResolution,spatOffset:[this.divX/(this.divX+a),this.divZ/(this.divZ+b),1]}),a=new h.HeightFieldMesh({hField:this.hField,size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:g,viewZ:c,edgeX:a,edgeZ:b,material:e});a.prepare();var b=new h.SceneObject({mesh:a}),f=this.hField.getStartX(),o=this.hField.getStartZ();b.position[0]=f+this.tileSize*q+this.tileSize/2;b.position[2]=o+this.tileSize*r+this.tileSize/
2;this.bindChild(b);this.tiles.push(b);this.tileMeshes.push(a);this.tileMaterials.push(e);this.tileSpats.push(d);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);q++}r++}m.jsonData&&this.loadFromJSON(m,m.compress||!1)}},{loadFile:function(h){var q=new FileReader;q.onload=function(h){return function(c){c=JSON.parse(c.target.result);h.loadFromJSON(c,c.compress)}}(this);q.readAsText(h)},loadFromJSON:function(h,q){var q=q||h.compress,r=this.tileSpats,c=h.jsonData.tiles;if(q){h.jsonData.heightfield=
Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(h.jsonData.heightfield),!0)).split(",");i=0;for(iMax=c.length;i<iMax;i++)c[i]=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(c[i]),!0)).split(",")}var g=this.hField.getUint8Buffer(),d=h.jsonData.heightfield;i=0;for(iMax=g.length;i<iMax;i++)g[i]=parseInt(d[i],10);i=0;for(iMax=c.length;i<iMax;i++){for(var g=c[i],d=r[i].getUint8Buffer(),a=0,b=g.length;a<b;a++)d[a]=parseInt(g[a],10);console.log(g);this.tileChanged[i]=!0;
this.tileSpatChanged[i]=!0}this.update()},saveToJSON:function(h,q){var h=h!==x?h:!0,q=q!==x?q:!1,r,c,g={divX:this.divX,divZ:this.divZ,tileX:this.tileX,tileZ:this.tileZ,spats:this.spats,spatResolution:this.spatResolution,compress:h,size:this.size,jsonData:{heightfield:[],tiles:[]}},d=this.hField.getUint8Buffer(),a=g.jsonData.heightfield;r=0;for(c=d.length;r<c;r++)a[r]=d[r];d=this.tileSpats;a=g.jsonData.tiles;r=0;for(c=d.length;r<c;r++){a[r]=[];for(var b=a[r],e=d[r].getUint8Buffer(),f=0,o=e.length;f<
o;f++)b[f]=e[f]}if(h){g.jsonData.heightfield=Iuppiter.Base64.encode(Iuppiter.compress(g.jsonData.heightfield.join(",")),!0);r=0;for(c=a.length;r<c;r++)g.jsonData.tiles[r]=Iuppiter.Base64.encode(Iuppiter.compress(a[r].join(",")),!0)}r=JSON.stringify(g);if(q)uriContent="data:text/x-download;charset=utf-8,"+encodeURIComponent(r),window.location.href=uriContent;else return r},update:function(){var h,q;this.hField.needsFlush()&&this.hField.flush();h=this.hField.getDrawArea();if(!1!==h){var r=this.getTileAt(h.startX-
this.cellSize,h.startZ-this.cellSize,h.endX-h.startX+this.cellSize,h.endZ-h.startZ,this.cellSize);!1!==r&&r.length===x&&(r=[r]);h=0;for(q=r.length;h<q;h++)this.tileChanged[r[h]]=!0;this.hField.clearDrawArea()}h=0;for(q=this.tiles.length;h<q;h++)if(this.tileChanged[h]&&(this.tileMeshes[h].update(),this.tileChanged[h]=!1),this.tileSpatChanged[h])this.tileSpats[h].update(),this.tileSpatChanged[h]=!1},getHeightField:function(){return this.hField},mapGen:function(h,q,r,c,g){this.hField.setRect({src:h,
startX:q,startZ:r,walkX:c,walkZ:g});this.hfMesh.update()},getFaceAt:function(h,q){return this.hField.getFaceAt([h,0,q])},getHeightValue:function(h,q){return this.hField.getHeightValue([h,0,q])},orient:function(h,q,r,c,g,d){d===x&&(d=0);var a,b,e=[];a=r/2;var f=c/2;b=Math.sqrt(f*f+a*a);f=Math.atan2(f,a);g*=Math.PI/180;a=h+Math.sin(g)*d;d=q+Math.cos(g)*d;e[0]=this.getHeightValue([a+b*Math.cos(-f-u+g),0,d+b*-Math.sin(-f-u+g)]);e[1]=this.getHeightValue([a+b*Math.cos(f-u+g),0,d+b*-Math.sin(f-u+g)]);e[2]=
this.getHeightValue([a+b*Math.cos(-f+u+g),0,d+b*-Math.sin(-f+u+g)]);e[3]=this.getHeightValue([a+b*Math.cos(f+u+g),0,d+b*-Math.sin(f+u+g)]);b=-Math.atan2(e[1]-e[2],r);d=-Math.atan2(e[0]-e[1],c);b+=-Math.atan2(e[0]-e[3],r);d+=-Math.atan2(e[3]-e[2],c);return[[h,(e[2]+e[3]+e[1]+e[0])/4,q],[b/2*(180/Math.PI),g,d/2*(180/Math.PI)]]},getTileAt:function(h,q,r,c){var r=r||0,c=c||0,g=this.hField.getStartX(),d=this.hField.getStartZ(),a=Math.floor(this.divX/this.tileX),b=Math.floor((h-g)/(this.tileX*this.tileSize)*
this.tileX),e=Math.floor((q-d)/(this.tileZ*this.tileSize)*this.tileZ),f=0;if(0===r&&0===c)return f=parseInt(b+e*a,10);h=Math.floor((h+r-g)/(this.tileX*this.tileSize)*this.tileX);q=Math.floor((q+c-d)/(this.tileZ*this.tileSize)*this.tileZ);for(c=[];e<=q;e++)for(d=b;d<=h;d++)f=e*(this.divX/this.tileX)+d,0<=f&&f<this.tiles.length&&c.push(f);return c},getSpatLocation:function(h,q,r){if(r===x)h=(1-(h/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%this.spatResolution,q=
(1-(q/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divZ/this.tileZ)%this.spatResolution;else var c=this.divX/this.tileX,g=r%c,c=Math.floor(r/c),r=this.hField.getStartX(),c=this.hField.getStartZ()+c*this.tileSize,h=(1-(h-(r+g*this.tileSize))/this.tileSize)*this.spatResolution,q=(1-(q-c)/this.tileSize)*this.spatResolution;return{x:h,z:q}},drawSpat:function(h,q,r){var c=r.getSize()*(this.size/this.spatResolution),g=h-c/2,d=q-c/2,c=this.getTileAt(g,d,h+c/2-g,q+c/2-d);!1!==c&&c.length===
x&&(c=[c]);if(!1!==c){g=0;for(d=c.length;g<d;g++){var a=c[g],b=this.getSpatLocation(h,q,a);0<=a&&a<this.tileSpats.length&&(this.tileSpats[a].draw(b.x,b.z,r),this.tileSpatChanged[a]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(h){var x=h.undef,u;return{SpatMaterial:h.extendClassGeneral(h.Material,function(m){m=m||{};u||(u=new h.Texture);this.spats=m.spats||[u,u,u,u,u];this.sourceTex=m.sourceTexture||u;this.spatResolution=m.spatResolution||256;this.spatTexel=1/this.spatResolution;var q=this.spats,r;for(r in q){var c=q[r];"string"===typeof c&&(q[r]=h.Textures_ref[c]!==x?h.Textures_obj[h.Textures_ref[c]]:new h.Texture(c))}this.spatOffset=m.spatOffset||[1,1,1];this.spatShader=
new h.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nuniform float spatTexel;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.y);\nif (spatSourceCoord.s<=spatTexel/2.0) {\n   spatSourceCoord.s=spatTexel/2.0;\n}\nif (spatSourceCoord.s>=1.0-spatTexel/2.0) {\n   spatSourceCoord.s=1.0-spatTexel/2.0;\n}\nif (spatSourceCoord.t<=spatTexel/2.0) {\n   spatSourceCoord.t=spatTexel/2.0;\n}\nif (spatSourceCoord.t>=1.0-spatTexel/2.0) {\n   spatSourceCoord.t=1.0-spatTexel/2.0;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(c){return function(d,a){var b=a.textureIndex;d.spatImage.set(b++,c.sourceTex);d.spatOffset.set(c.spatOffset);d.spatTexel.set(c.spatTexel);q[0]&&d.spat0.set(b++,q[0]);q[1]&&d.spat1.set(b++,q[1]);q[2]&&d.spat2.set(b++,q[2]);q[3]&&d.spat3.set(b++,q[3]);q[4]&&d.spat4.set(b++,q[4])}}(this)});m.shader=this.spatShader;h.Material.apply(this,[m])},{setSpats:function(h){this.spats=h},getSpats:function(){return this.spats},setSource:function(h){this.sourceTexture=h}})}});
CubicVR.RegisterModule("Octree",function(h){function x(a,b,e,f,c){var d=this._children=[];this._dirty=!1;d[0]=null;d[1]=null;d[2]=null;d[3]=null;d[4]=null;d[5]=null;d[6]=null;d[7]=null;this._child_index=c||-1;this._root=e||null;this._max_depth=b||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];b=this._bbox=[[0,0,0],[0,0,0]];e=h.aabb;e.reset(b,f);a/=2;e.engulf(b,[f[0]+a,f[1]+
a,f[2]+a]);e.engulf(b,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function u(){this.position=[0,0,0];this.visible=!1;this._object=null}function m(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var q=h.undef,r=h.plane,c=h.sphere,g=h.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var d=function(a,b,e){e=a.slice((e||b)+1||a.length);
a.length=0>b?a.length+b:b;return a.push.apply(a,e)};x.prototype.destroy=function(){var a,b,e;a=0;for(b=this._static_lights.length;a<b;++a)e=this._static_lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;a=0;for(b=this._lights.length;a<b;++a)e=this._lights[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].destroy();a=0;for(b=this._nodes.length;a<
b;++a)e=this._nodes[a],e.octree_leaves=null,e.octree_common_root=null,e.octree_aabb=null,e.dynamic_lights=[],e.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};x.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};x.prototype.remove=function(a){var b=!1,e=this._nodes.length,f;f=e-1;for(e=this._nodes.length;0<=f;--f)if(a===this._nodes[f]){d(this._nodes,f);this.dirty_lineage();b=!0;break}if(!b)for(f=e-1;0<=f;--f)if(a===this._lights[f]){d(this._lights,f);this.dirty_lineage();break}};x.prototype.dirty_lineage=function(){this._dirty=!0;null!==this._root&&
this._root.dirty_lineage()};x.prototype.cleanup=function(){for(var a=this._children.length,b=0,e=0;e<a;++e){var f=this._children[e];if(null!==f){var c=!0;!0===f._dirty&&(c=f.cleanup());c?++b:this._children[e]=null}}return 0===this._nodes.length&&(0===this._static_lights.length&&0===this._lights.length)&&(0===b||0===a)?!1:!0};x.prototype.insert_light=function(a){this.insert(a,!0)};x.prototype.propagate_static_light=function(a){var b,e;b=0;for(e=this._nodes.length;b<e;++b)-1===this._nodes[b].static_lights.indexOf(a)&&
this._nodes[b].static_lights.push(a);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].propagate_static_light(a)};x.prototype.collect_static_lights=function(a){var b,e;b=0;for(e=this._static_lights.length;b<e;++b)-1===a.static_lights.indexOf(this._static_lights[b])&&a.static_lights.push(this._static_lights[b]);for(b=0;8>b;++b)null!==this._children[b]&&this._children[b].collect_static_lights(a)};x.prototype.insert=function(a,b){function e(a,b,f,e){var c,d;if(f)if(b.method===g.light.method.STATIC){-1===
a._static_lights.indexOf(b)&&a._static_lights.push(b);f=0;for(c=a._nodes.length;f<c;++f)-1===a._nodes[f].static_lights.indexOf(b)&&a._nodes[f].static_lights.push(b);for(d=a._root;null!==d;){f=0;for(l=d._nodes.length;f<l;++f)c=d._nodes[f],-1===c.static_lights.indexOf(b)&&c.static_lights.push(b);d=d._root}}else-1===a._lights.indexOf(b)&&a._lights.push(b);else{a._nodes.push(b);f=0;for(c=a._static_lights.length;f<c;++f)-1===b.static_lights.indexOf(a._static_lights[f])&&b.static_lights.push(a._static_lights[f]);
for(d=a._root;null!==d;){f=0;for(c=d._static_lights.length;f<c;++f){var n=d._static_lights[f];-1===b.static_lights.indexOf(n)&&b.static_lights.push(n)}d=d._root}}b.octree_leaves.push(a);b.octree_common_root=e;e=h.aabb;e.engulf(b.octree_aabb,a._bbox[0]);e.engulf(b.octree_aabb,a._bbox[1])}b===q&&(b=!1);null===this._root&&(a.octree_leaves=[],a.octree_common_root=null);if(0===this._max_depth)e(this,a,b,this._root);else{var f=this._position,c,d,m,r,w,t,B;d=a.getAABB();B=[d[0][0],d[0][1],d[0][2]];var A=
[d[1][0],d[1][1],d[1][2]];c=B[0]<f[0]&&B[1]<f[1]&&B[2]<f[2];d=A[0]>f[0]&&B[1]<f[1]&&B[2]<f[2];w=B[0]<f[0]&&A[1]>f[1]&&B[2]<f[2];t=A[0]>f[0]&&A[1]>f[1]&&B[2]<f[2];m=B[0]<f[0]&&B[1]<f[1]&&A[2]>f[2];r=A[0]>f[0]&&B[1]<f[1]&&A[2]>f[2];B=B[0]<f[0]&&A[1]>f[1]&&A[2]>f[2];f=A[0]>f[0]&&A[1]>f[1]&&A[2]>f[2];if(c&&d&&w&&t&&m&&r&&B&&f)e(this,a,b,this),b?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var A=0,u=this._static_lights.length;A<u;++A)a.static_lights===
q&&(a.static_lights=[]),-1===a.static_lights.indexOf(this._static_lights[A])&&a.static_lights.push(this._static_lights[A]);var A=this._size/2,u=this._size/4,F=0,v=this._position[0],y=this._position[1],C=this._position[2];c&&(c=[v-u,y-u,C-u],null===this._children[g.octree.TOP_NW]&&(this._children[g.octree.TOP_NW]=new x(A,this._max_depth-1,this,c,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,b),++F);d&&(c=[v+u,y-u,C-u],null===this._children[g.octree.TOP_NE]&&(this._children[g.octree.TOP_NE]=
new x(A,this._max_depth-1,this,c,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,b),++F);w&&(c=[v-u,y+u,C-u],null===this._children[g.octree.BOTTOM_NW]&&(this._children[g.octree.BOTTOM_NW]=new x(A,this._max_depth-1,this,c,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,b),++F);t&&(c=[v+u,y+u,C-u],null===this._children[g.octree.BOTTOM_NE]&&(this._children[g.octree.BOTTOM_NE]=new x(A,this._max_depth-1,this,c,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,
b),++F);m&&(c=[v-u,y-u,C+u],null===this._children[g.octree.TOP_SW]&&(this._children[g.octree.TOP_SW]=new x(A,this._max_depth-1,this,c,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,b),++F);r&&(c=[v+u,y-u,C+u],null===this._children[g.octree.TOP_SE]&&(this._children[g.octree.TOP_SE]=new x(A,this._max_depth-1,this,c,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,b),++F);B&&(c=[v-u,y+u,C+u],null===this._children[g.octree.BOTTOM_SW]&&(this._children[g.octree.BOTTOM_SW]=new x(A,
this._max_depth-1,this,c,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,b),++F);f&&(c=[v+u,y+u,C+u],null===this._children[g.octree.BOTTOM_SE]&&(this._children[g.octree.BOTTOM_SE]=new x(A,this._max_depth-1,this,c,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,b),++F);if(1<F||null===a.octree_common_root)a.octree_common_root=this}}};x.prototype.draw_on_map=function(a,b,e){function f(a,f,e,g,h){var m=a<e?a:e,t=f<g?f:g,a=a<e?e-a:a-e,f=f<g?g-f:f-g;b.save();void 0!==h&&
(b.fillStyle=h,b.fillRect(c+m,d+t,a,f));b.strokeRect(c+m,d+t,a,f);b.restore()}var c=a.width/2,d=a.height/2,g,h,m,t,r,A,u;if(e===q||"map"===e)b.save(),!1!==this._debug_visible?(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="#FF0000"):(b.fillStyle="rgba(0,0,0,0)",b.strokeStyle="rgba(0,0,0,0)"),b.beginPath(),r=this._size/2,g=this._position[0],h=this._position[2],b.moveTo(c+g-r,c+h-r),b.lineTo(c+g-r,c+h+r),b.lineTo(c+g+r,c+h+r),b.lineTo(c+g+r,c+h-r),b.stroke(),b.fill(),b.restore();if(e===q||"objects"===e){b.save();
r=0;for(u=this._nodes.length;r<u;++r)A=this._nodes[r],b.fillStyle="#5500FF",b.strokeStyle=!0===A.visible&&!1===A.culled?"#FFFFFF":"#000000",b.beginPath(),g=A.aabb[0][0],h=A.aabb[0][2],m=A.aabb[1][0]-g,t=A.aabb[1][2]-h,b.rect(c+g,d+h,m,t),b.stroke();b.restore()}if(e===q||"lights"===e){r=0;for(u=this._lights.length;r<u;++r)t=this._lights[r],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FFFF00",b.beginPath(),A=t.distance,g=t.position[0],
h=t.position[2],b.arc(c+g,d+h,A,0,2*Math.PI,!0),b.closePath(),b.stroke(),b.fill(),b.beginPath(),g=t.aabb[0][0],h=t.aabb[0][2],m=t.aabb[1][0]-g,t=t.aabb[1][2]-h,b.rect(c+g,d+h,m,t),b.closePath(),b.stroke();r=0;for(u=this._static_lights.length;r<u;++r)t=this._static_lights[r],b.fillStyle=!1===t.culled&&!0===t.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",b.strokeStyle="#FF66BB",b.beginPath(),A=t.distance,g=t.position[0],h=t.position[2],b.arc(c+g,d+h,A,0,2*Math.PI,!0),b.closePath(),
b.stroke(),b.fill(),b.beginPath(),g=t.aabb[0][0],h=t.aabb[0][2],m=t.aabb[1][0]-g,t=t.aabb[1][2]-h,b.rect(c+g,d+h,m,t),b.closePath(),b.stroke()}if("lights"!=e&&"objects"!=e&&"map"!=e){b.save();g=this._nodes;r=0;for(t=g.length;r<t;++r)if(A=g[r],A.name==e){b.strokeStyle="#FFFF00";b.lineWidth=3;b.beginPath();g=A.aabb[0][0];h=A.aabb[0][2];m=A.aabb[1][0]-g;t=A.aabb[1][2]-h;b.rect(c+g,d+h,m,t);b.closePath();b.stroke();g=A.octree_aabb;b.strokeStyle="#0000FF";f(g[0][0],g[0][2],g[1][0],g[1][2]);b.lineWidth=
1;null!==A.common_root&&(b.strokeStyle="#00FF00");break}b.lineWidth=1;b.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");b.fill();b.restore()}r=0;for(u=this._children.length;r<u;++r)null!==this._children[r]&&this._children[r].draw_on_map(a,b,e)};x.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};x.prototype.get_frustum_hits=function(a,b){var e={objects:[],lights:[]};if((b===q||!0===b)&&!this.contains_point(a.position)){if(!1===c.intersects(a.frustum.sphere,this._sphere))return e;var f=a.frustum.contains_sphere(this._sphere);if(-1===f)return this._debug_visible=!1,e;if(1===f)this._debug_visible=2,b=!1;else if(0===f){this._debug_visible=!0;f=a.frustum.contains_box(this._bbox);if(-1===f)return this._debug_visible=!1,e;1===
f&&(this._debug_visible=3,b=!1)}}var d,g,f=0;for(d=this._nodes.length;f<d;++f)g=this._nodes[f],e.objects.push(g),g.dynamic_lights=[].concat(this._lights),g.was_culled=g.culled,g.culled=!1,g.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;f=0;for(d=this._lights.length;f<d;++f)g=this._lights[f],!0===g.visible&&(e.lights.push(g),g.was_culled=g.culled,g.culled=!1);f=0;for(d=this._static_lights.length;f<d;++f)g=this._static_lights[f],!0===g.visible&&(g.culled=!1);for(f=
0;8>f;++f)if(null!==this._children[f]){d=this._children[f].get_frustum_hits(a,b);var h;g=0;for(h=d.objects.length;g<h;++g){e.objects.push(d.objects[g]);for(var m=d.objects[g].dynamic_lights,r=0,t=this._lights.length;r<t;++r)0>m.indexOf(this._lights[r])&&m.push(this._lights[r])}g=0;for(h=d.lights.length;g<h;++g)0>e.lights.indexOf(d.lights[g])&&e.lights.push(d.lights[g])}return e};x.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,b;a=0;for(b=this._nodes.length;a<b;++a)this._nodes[a].culled=
!0;a=0;for(b=this._lights.length;a<b;++a)this._lights[a].culled=!0;a=0;for(b=this._static_lights.length;a<b;++a)this._static_lights[a].culled=!0;a=0;for(b=this._children.length;a<b;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};u.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};u.prototype.attach=function(a){this._object=a};m.prototype.extract=function(a,b,c){var f=h.mat4,d=h.vec3;if(!(b===q||c===q)){f=f.multiply(c,b);b=this._planes;b[g.frustum.plane.LEFT][0]=
f[3]+f[0];b[g.frustum.plane.LEFT][1]=f[7]+f[4];b[g.frustum.plane.LEFT][2]=f[11]+f[8];b[g.frustum.plane.LEFT][3]=f[15]+f[12];b[g.frustum.plane.RIGHT][0]=f[3]-f[0];b[g.frustum.plane.RIGHT][1]=f[7]-f[4];b[g.frustum.plane.RIGHT][2]=f[11]-f[8];b[g.frustum.plane.RIGHT][3]=f[15]-f[12];b[g.frustum.plane.TOP][0]=f[3]-f[1];b[g.frustum.plane.TOP][1]=f[7]-f[5];b[g.frustum.plane.TOP][2]=f[11]-f[9];b[g.frustum.plane.TOP][3]=f[15]-f[13];b[g.frustum.plane.BOTTOM][0]=f[3]+f[1];b[g.frustum.plane.BOTTOM][1]=f[7]+f[5];
b[g.frustum.plane.BOTTOM][2]=f[11]+f[9];b[g.frustum.plane.BOTTOM][3]=f[15]+f[13];b[g.frustum.plane.NEAR][0]=f[3]+f[2];b[g.frustum.plane.NEAR][1]=f[7]+f[6];b[g.frustum.plane.NEAR][2]=f[11]+f[10];b[g.frustum.plane.NEAR][3]=f[15]+f[14];b[g.frustum.plane.FAR][0]=f[3]-f[2];b[g.frustum.plane.FAR][1]=f[7]-f[6];b[g.frustum.plane.FAR][2]=f[11]-f[10];b[g.frustum.plane.FAR][3]=f[15]-f[14];for(var n=0;6>n;++n)r.normalize(b[n]);n=-b[g.frustum.plane.NEAR][3];b=b[g.frustum.plane.FAR][3]-n;c=b*(1/c[5]);c=d.subtract([0,
0,n+0.5*b],[c,c,n+b]);c=d.length(c);f=[f[3],f[9],f[10]];n=d.length(f);f=d.multiply(f,1/n);a=[a.position[0],a.position[1],a.position[2]];a=d.add(a,d.multiply(f,0.5*b));a=d.add(a,d.multiply(f,1));this.sphere=[a[0],a[1],a[2],c]}};m.prototype.contains_sphere=function(a){for(var b=h.vec3,c=this._planes,f=0;6>f;++f){var d=c[f],d=b.dot([d[0],d[1],d[2]],[a[0],a[1],a[2]])+d.d;this.last_in[f]=1;if(d<-a[3])return-1;if(Math.abs(d)<a[3])return 0}return 1};m.prototype.draw_on_map=function(a,b){var c=a.width/2,
f=a.height/2;b.save();for(var d=this._planes,g=[0,1,4,5],h=0,m=g.length;h<m;++h){var q=d[g[h]];b.strokeStyle="#FF00FF";h<this.last_in.length&&this.last_in[h]&&(b.strokeStyle="#FFFF00");var t=-c,r=c,A=(-q[3]-q[0]*r)/q[2];b.moveTo(c+t,f+(-q[3]-q[0]*t)/q[2]);b.lineTo(c+r,f+A);b.stroke()}b.strokeStyle="#0000FF";b.beginPath();b.arc(c+this.sphere[0],f+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);b.closePath();b.stroke();b.restore()};m.prototype.contains_box=function(a){var b=0,c=[];c[0]=a[0];c[1]=[a[0][0],
a[0][1],a[1][2]];c[2]=[a[0][0],a[1][1],a[0][2]];c[3]=[a[0][0],a[1][1],a[1][2]];c[4]=[a[1][0],a[0][1],a[0][2]];c[5]=[a[1][0],a[0][1],a[1][2]];c[6]=[a[1][0],a[1][1],a[0][2]];c[7]=a[1];for(var a=this._planes,f=0;6>f;++f){for(var d=8,g=1,h=0;8>h;++h)-1===r.classifyPoint(a[f],c[h])&&(g=0,--d);this.last_in[f]=g;if(0===d)return-1;b+=g}return 6===b?1:0};return{Frustum:m,Octree:x}});
CubicVR.RegisterModule("CVRXML",function(h){function x(b,c,f,d){var g=CubicVR.util,h=null,m=null;d.triangles&&(m=g.intDelimArray(a.getTextNode(d,"triangles")," "));if(m&&(d.segments&&(h=g.intDelimArray(a.getTextNode(d,"segments")," ")),null===h&&(h=[0,parseInt(m.length/3,10)]),d=0,b.setFaceMaterial(c),m.length)){p=0;for(pMax=h.length;p<pMax;p+=2){c=3*h[p+1];b.setSegment(h[p]);j=d;for(jMax=d+c;j<jMax;j+=3)g=b.addFace([m[j],m[j+1],m[j+2]]),f&&b.faces[g].setUV([f[j],f[j+1],f[j+2]]);d+=c}}}function u(b){var c=
CubicVR.util,f=new CubicVR.UVMapper,d=null,h=null;if(b.type)switch(d=a.getTextNode(b,"type"),d){case "planar":f.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":f.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":f.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":f.projection_mode=g.uv.projection.CUBIC}if(!d)return null;"uv"===d&&b.uv&&(h=a.getPoints(b,"uv"));if(b.axis)switch(a.getTextNode(b,"axis")){case "x":f.projection_axis=g.uv.axis.X;break;case "y":f.projection_axis=
g.uv.axis.Y;break;case "z":f.projection_axis=g.uv.axis.Z}b.center&&(f.center=c.floatDelimArray(a.getTextNode(b,"center")));b.rotation&&(f.rotation=c.floatDelimArray(a.getTextNode(b,"rotation")));b.scale&&(f.scale=c.floatDelimArray(a.getTextNode(b,"scale")));b.wrap_w&&(f.wrap_w_count=parseFloat(a.getTextNode(b,"wrap_w")));b.wrap_h&&(f.wrap_h_count=parseFloat(a.getTextNode(b,"wrap_h")));return""!==d&&"uv"!==d?f:h}function m(b,e){if(d[b]!==c)return d[b];var f=CubicVR.util,o,n,m,q;o=null;o="object"==
typeof b?b:-1!=b.indexOf(".js")?f.getJSON(b):CubicVR.util.xml2badgerfish(f.getXML(b));o.root&&(o=o.root);o.properties&&(o=o.properties);f=new CubicVR.Mesh;o.points&&(m=a.getPoints(o,"points"))&&f.addPoint(m);var r=o.material;r&&!r.length&&(r=[r]);var t=[];if(r){o=0;for(m=r.length;o<m;o++){var B=r[o],A;A=B;var E=e,F=new CubicVR.Material({name:A.name?A.name.$:null});A.shininess&&(F.shininess=a.getFloatNode(A,"shininess",F.shininess)/100);F.opacity=a.getFloatNode(A,"alpha",F.opacity);F.max_smooth=a.getFloatNode(A,
"max_smooth",F.max_smooth);F.color=a.getFloatDelimNode(A,"color",F.color);F.ambient=a.getFloatDelimNode(A,"ambient",F.ambient);F.diffuse=a.getFloatDelimNode(A,"diffuse",F.diffuse);F.specular=a.getFloatDelimNode(A,"specular",F.specular);n=void 0;if(n=a.getTextNode(A,"texture"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.COLOR);if(n=a.getTextNode(A,"texture_luminosity"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:
new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.AMBIENT);if(n=a.getTextNode(A,"texture_normal"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.NORMAL);if(n=a.getTextNode(A,"texture_specular"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.SPECULAR);if(n=a.getTextNode(A,"texture_bump"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:
new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.BUMP);if(n=a.getTextNode(A,"texture_envsphere"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.ENVSPHERE);if(n=a.getTextNode(A,"texture_alpha"))n=(E?E:"")+n,tex=h.Textures_ref[n]!==c?h.Textures_obj[h.Textures_ref[n]]:new CubicVR.Texture(n),F.setTexture(tex,g.texture.map.ALPHA);A=F;var v=null;n=E=null;B.uvmapper&&((E=u(B.uvmapper))&&!E.length?t.push([E,A]):n=E);(F=B.part)&&
!F.length&&(F=[F]);if(F&&F.length){var y=null,C=null;n=0;for(q=F.length;n<q;n++){var z=F[n],y=null;if(v=z.uvmapper)y=u(v),B.triangles&&(C=v=f.faces.length,y&&!y.length?(x(f,A,null,z),C=f.faces.length-1,f.calcFaceNormals(v,C),y.apply(f,A,c,v,C)):y&&y.length?x(f,A,y,z):E&&!E.length&&(x(f,A,null,z),C=f.faces.length-1,f.calcFaceNormals(v,C),E.apply(f,A,c,v,C)));if(z.procedural){(v=z.uvmapper)&&(y=u(v));var C=z.transform?a.getTransform(z.transform):c,v=c,z=z.procedural,G=a.getTextNode(z,"type");C&&(v=
new CubicVR.Transform,v.translate(C.position),v.pushMatrix(),v.rotate(C.rotation),v.pushMatrix(),v.scale(C.scale));E||(E=c);y={material:A,uvmapper:E||y};if("box"===G||"cube"===G)y.size=a.getFloatNode(z,"size"),f.booleanAdd(CubicVR.primitives.box(y),v);else if("sphere"===G)y.radius=a.getFloatNode(z,"radius"),y.lat=a.getIntNode(z,"lat"),y.lon=a.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.sphere(y),v);else if("cone"===G)y.base=a.getFloatNode(z,"base"),y.height=a.getFloatNode(z,"height"),y.lon=
a.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.cone(y),v);else if("plane"===G)y.size=a.getFloatNode(z,"size"),f.booleanAdd(CubicVR.primitives.plane(y),v);else if("cylinder"===G)y.radius=a.getFloatNode(z,"radius"),y.height=a.getFloatNode(z,"height"),y.lon=a.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.cylinder(y),v);else if("torus"===G)y.innerRadius=a.getFloatNode(z,"innerRadius"),y.outerRadius=a.getFloatNode(z,"outerRadius"),y.lat=a.getIntNode(z,"lat"),y.lon=a.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.torus(y),
v);else if("lathe"===G)y.points=a.getPoints(z,"p"),y.lon=a.getIntNode(z,"lon"),f.booleanAdd(CubicVR.primitives.lathe(y),v);else if("polygon"===G){C=a.getPoints(z,"p");C=new CubicVR.Polygon(C);(G=z.cut)&&!G.length&&(G=[G]);if(G.length){n=0;for(m=G.length;n<q;n++)C.cut(new CubicVR.Polygon(a.getPoints(G[n])))}y.front=0;y.back=0;y.frontShift=0;y.backShift=0;y.frontDepth=0;y.backDepth=0;if(z.extrude&&(z=z.extrude,y.front=a.getFloatNode(z,"front",0),y.back=a.getFloatNode(z,"back",0),y.frontShift=a.getFloatNode(z,
"frontBevelShift",0),y.backShift=a.getFloatNode(z,"backBevelShift",0),y.frontDepth=a.getFloatNode(z,"frontBevelDepth",0),y.backDepth=a.getFloatNode(z,"backBevelDepth",0),y.depth=a.getFloatNode(z,"depth",0),y.shift=a.getFloatNode(z,"shift",0),y.bevel=a.getFloatNode(z,"bevel",0),y.depth&&(!y.backDepth&&!y.frontDepth)&&(y.front=-y.depth/2,y.back=y.depth/2),y.shift&&(!y.backShift&&!y.frontShift)&&(y.frontShift=y.shift,y.backShift=y.shift),y.bevel&&!y.backDepth&&!y.frontDepth))y.frontDepth=y.bevel,y.backDepth=
y.bevel;z=C.toExtrudedBeveledMesh(new CubicVR.Mesh,y);z.setFaceMaterial(y.material);f.booleanAdd(z,v)}}}}else x(f,A,n,B)}}f.triangulateQuads();f.calcNormals();o=0;for(m=t.length;o<m;o++)t[o][0].apply(f,t[o][1]);f.compile();return d[b]=f}function q(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function r(a,e,f){var d=CubicVR.util,h=[];h[0]=a.getElementsByTagName("x");h[1]=a.getElementsByTagName("y");
h[2]=a.getElementsByTagName("z");h[3]=a.getElementsByTagName("fov");var m,q,r,t,u,A;for(A in h)if(h.hasOwnProperty(A)&&h[A]!==c&&h[A].length){m=h[A][0].getElementsByTagName("time");q=h[A][0].getElementsByTagName("value");r=h[A][0].getElementsByTagName("in");t=h[A][0].getElementsByTagName("out");u=h[A][0].getElementsByTagName("tcb");var x=null,F=null,v=null,y=a=null;r.length&&(a=d.collectTextNode(r[0]));t.length&&(y=d.collectTextNode(t[0]));m.length&&(x=d.floatDelimArray(d.collectTextNode(m[0])," "));
q.length&&(F=d.floatDelimArray(d.collectTextNode(q[0])," "));u.length&&(v=d.floatDelimArray(d.collectTextNode(u[0])," "));if(null!==x&&null!==F){m=0;for(q=x.length;m<q;m++)r=f.setKey(e,A,x[m],F[m]),v&&(r.tension=v[3*m],r.continuity=v[3*m+1],r.bias=v[3*m+2])}F=x=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":x=g.envelope.behavior.RESET;break;case "constant":x=g.envelope.behavior.CONSTANT;break;case "repeat":x=g.envelope.behavior.REPEAT;break;case "oscillate":x=g.envelope.behavior.OSCILLATE;
break;case "offset":x=g.envelope.behavior.OFFSET;break;case "linear":x=g.envelope.behavior.LINEAR}if(y)switch(y){case "reset":F=g.envelope.behavior.RESET;break;case "constant":F=g.envelope.behavior.CONSTANT;break;case "repeat":F=g.envelope.behavior.REPEAT;break;case "oscillate":F=g.envelope.behavior.OSCILLATE;break;case "offset":F=g.envelope.behavior.OFFSET;break;case "linear":F=g.envelope.behavior.LINEAR}f.setBehavior(e,A,x,F)}}var c=h.undef,g=CubicVR.enums,d=[],a={getPoints:function(b,e,f){b=e?
a.getTextNode(b,e):b.$;if(!b)return c;b=b.split(" ");i=0;for(iMax=b.length;i<iMax;i++){b[i]=b[i].split(",");j=0;for(jMax=b[i].length;j<jMax;j++)b[i][j]=parseFloat(b[i][j]);f&&(b[i][2]=0)}return b},getTransform:function(a){var c=CubicVR.util;if(!a)return null;var f={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d;postition=a.position;d=a.rotation;a=a.scale;d&&(f.rotation=c.floatDelimArray(d.$));a&&(f.scale=c.floatDelimArray(a.$));return d||a?f:null},getTextNode:function(a,c,f){a=a[c];if(!a)return f;
a.length&&(a=a[0]);return a.$?a.$:f},getFloatNode:function(b,c,f){return(b=a.getTextNode(b,c))?(b=parseFloat(b),b!=b?f:b):f},getIntNode:function(b,c,f){return(b=a.getTextNode(b,c))?(b=parseInt(b,10),b!=b?f:b):f},getFloatDelimNode:function(b,c,f,d){var g=CubicVR.util;return(b=a.getTextNode(b,c))?g.floatDelimArray(b,d):f},getIntDelimNode:function(b,c,f,d){var g=CubicVR.util;return(b=a.getTextNode(b,c))?g.intDelimArray(b,d):f}};return{loadMesh:m,loadScene:function(a,d,f){var h=CubicVR.util;d===c&&(d=
"");f===c&&(f="");for(var n=new CubicVR.Mesh,s=h.getXML(a),a=new CubicVR.Scene,u=[],w=s.getElementsByTagName("sceneobjects"),t,B,A,x=0,F=w[0].childNodes.length;x<F;x++){var v=w[0].childNodes[x];if("sceneobject"===v.tagName){var y="unnamed",C="",z="",n=v.getElementsByTagName("name");n.length&&(y=h.collectTextNode(n[0]));n=v.getElementsByTagName("parent");n.length&&(C=h.collectTextNode(n[0]));n=v.getElementsByTagName("model");n.length&&(z=h.collectTextNode(n[0]));A=B=t=null;n=v.getElementsByTagName("position");
n.length&&(t=n[0]);n=v.getElementsByTagName("rotation");n.length&&(B=n[0]);n=v.getElementsByTagName("scale");n.length&&(A=n[0]);n=null;""!==z&&(n=m(d+z,f));n=new CubicVR.SceneObject(n,y);q(t)?(n.motion||(n.motion=new CubicVR.Motion),r(t,g.motion.POS,n.motion)):t&&(n.position=h.floatDelimArray(h.collectTextNode(t)));q(B)?(n.motion||(n.motion=new CubicVR.Motion),r(B,g.motion.ROT,n.motion)):n.rotation=h.floatDelimArray(h.collectTextNode(B));q(A)?(n.motion||(n.motion=new CubicVR.Motion),r(A,g.motion.SCL,
n.motion)):n.scale=h.floatDelimArray(h.collectTextNode(A));a.bindSceneObject(n);""!==C&&u.push([n,C])}}for(var G in u)u.hasOwnProperty(G)&&a.getSceneObject(u[G][1]).bindChild(u[G][0]);d=s.getElementsByTagName("camera");d.length&&((B=t=null,f="",n=d[0].getElementsByTagName("name"),G=a.camera,s=null,n.length&&(f=n[0].firstChild.nodeValue),n=d[0].getElementsByTagName("target"),n.length&&(f=n[0].firstChild.nodeValue),""!==f&&(G.targetSceneObject=a.getSceneObject(f)),n=d[0].getElementsByTagName("position"),
n.length&&(t=n[0]),n=d[0].getElementsByTagName("rotation"),n.length&&(B=n[0]),n=d[0].getElementsByTagName("fov"),n.length&&(s=n[0]),q(t)?(G.motion||(G.motion=new CubicVR.Motion),r(t,g.motion.POS,G.motion)):t&&(G.position=h.floatDelimArray(t.firstChild.nodeValue)),q(B)?(G.motion||(G.motion=new CubicVR.Motion),r(B,g.motion.ROT,G.motion)):B&&(G.rotation=h.floatDelimArray(B.firstChild.nodeValue)),q(s))?(G.motion||(G.motion=new CubicVR.Motion),r(s,g.motion.FOV,G.motion)):s&&(G.fov=parseFloat(s.firstChild.nodeValue)));
return a}}});
CubicVR.RegisterModule("Worker",function(h){function x(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){"init"!==a.data.message&&b.message(a.data)},!1)}function u(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new x({message:b})}function m(a){function b(a){a=s.getURL(a);c.send("done",a.length)}var c;c=new x({message:function(a){b(a)}});a&&b(a)}function q(a){function b(a){a=s.getURL(a);
c.send("loaded",a)}var c,f;c=new x({message:function(a){if("parse"===a.message)f=new n,CubicVR.loadCollada("","",f,a.data),c.send("parsed");else if("getMesh"===a.message){if(a=f.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function r(a){function b(a){var f=new d,e;for(e in a)a.hasOwnProperty(e)&&(f[e]=a[e]);a=f.triangulateQuads().compileVBO(f.compileMap());c.send("done",
a)}var c;c=new x({message:function(a){b(a)}});a&&b(a)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(c){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=h.undef,d=CubicVR.Mesh,a=CubicVR.Texture,b=CubicVR.Material,e=CubicVR.SceneObject,f=CubicVR.Motion,o=CubicVR.Envelope,n=CubicVR.DeferredBin,s=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(a){var b=a.parsed||
function(){},f={},e;a.url.match(/\.dae/)&&(e=new CubicVR.Worker({type:"sceneFile",data:a.url,message:function(a){if("loaded"===a.message){var a=(new DOMParser).parseFromString(a.data,"text/xml"),c=s.xml2badgerfish(a);console.log(a);e.send("parse",c)}else if("getMesh"===a.message){var c=new d,g;for(g in a.data.mesh)a.data.mesh.hasOwnProperty(g)&&(c[g]=a.data.mesh[g]);c.bindBuffer(c.bufferVBO(a.data.vbo));f.getMesh&&f.getMesh(c)}else"parsed"===a.message&&b()}}));this.getSceneObject=function(a,b){e.send("getMesh",
a);f.getMesh=b}}function f(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,h={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return h[a.url]=b};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete h[settings];else for(var b in h)h[b]===a&&delete h[b]};this.createSceneObjectFromMesh=function(c){var h=c.scene,n=c.object,m=c.assetBase||"",o=g.createSceneFileManager({url:c.mesh,parsed:function(){n&&o.getSceneObject(n,
function(c){for(var c=f(c,new d),g=0,n=c.materials.length;g<n;++g){for(var o=f(c.materials[g],new b),t=0,q=o.textures.length;t<q;++t){var r=o.textures[g];o.textures[g]=new a(m+r.img_path,r.filter_type)}c.materials[g]=o}c=new e(c);h.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,h,n,m){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(r){throw Error("Can't find collada.js");
}var s=[],v=[];q.onmessage=function(h){function q(a,b){for(var c in a)b[c]=a[c]}function r(a){if(a.motion){for(var b=a.motion.controllers,c=[],d=0,e=b.length;d<e;++d){var g=b[d];if(g){for(var h=[],n=0,m=g.length;n<m;++n){var t=g[n];if(t){var s=t.keys[0];1<t.keys.length&&(s.prev=null,s.next=t.keys[1],s=t.keys[1]);for(var v=1,w=t.keys.length-1;v<w;++v)s.prev=t.keys[v-1],s.next=t.keys[v+1],s=t.keys[v+1];1<t.keys.length&&(s=t.keys[t.keys.length-1],s.prev=t.keys[t.keys.length-2],s.next=null);t.firstKey=
t.keys[0];t.lastKey=t.keys[t.keys.length-1];t.keys=t.firstKey;s=new o;q(t,s);h[n]=s}else g[n]=null}c[d]=h}else b[d]=null}a.motion.controllers=c;b=new f;q(a.motion,b);a.motion=b}}function w(a){var b=new e;q(a,b);if(null!==a.obj){var f=v[a.obj.id];if(f===g)if(f=new d,q(a.obj,f),b.obj=f,v[a.obj.id]=f,m){if(0<f.points.length){m.addMesh(c,c+":"+f.id,f);for(var h=0,n=f.faces.length;h<n;++h){var o=f.faces[h],t=o.material;o.material=s[t]!==g?s[t]:0}}}else b.obj.triangulateQuads(),b.obj.calcNormals(),b.obj.compile(),
b.obj.clean();else b.obj=f}b.trans=new Transform;if(a.children&&0<a.children.length&&(b.children=[],a.children)){f=0;for(h=a.children.length;f<h;++f)n=w(a.children[f]),b.bindChild(n)}return b}var u;u=h.data.message;if("materials"==u){var A=JSON.parse(h.data.data),h=0;for(u=A.length;h<u;++h){var x=new b(A[h].name),E=x.material_id;q(A[h],x);x.material_id=E;s[A[h].material_id]=E;for(var E=0,M=A[h].textures.length;E<M;++E){var K=A[h].textures[E];if(K){var N=Texture_ref[K.img_path];N===g?(K=new a(K.img_path,
K.filter_type,m,c),x.textures[E]=K):x.textures[E]=Textures_obj[N]}else x.textures[E]=0}}}else if("scene"==u){A=JSON.parse(h.data.data);h=0;for(u=A.sceneObjects.length;h<u;++h)x=A.sceneObjects[h],null!==x.obj&&nop(),x.reassembled===g&&(r(x),x.reassembled=!0),A.sceneObjects[h]=w(x);x=new Scene;h=x.camera;u=h.transform;q(A.camera,h);q(A.camera.transform,u);r(h);x.camera=h;x.camera.transform=u;x.camera.frustum=new Frustum;h=0;for(u=A.sceneObjects.length;h<u;++h){E=A.sceneObjects[h];x.bindSceneObject(E);
try{E.getAABB()}catch(Y){}}h=0;for(u=A.lights.length;h<u;++h)E=new Light,q(A.lights[h],E),E.trans=new Transform,r(E),x.bindLight(E);n(x)}else console.log("message from collada worker:",h.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:c,prefix:h,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:u,prepareMesh:r,file:m,sceneFile:q};self.addEventListener("message",function(b){if("init"===
b.data.message){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(h){function x(a){var b=[],c=a.length;if(3>c)return null;var d=[],g;g=a.length;for(var h=0,m=g-1,q=0;q<g;m=q++)h+=a[m][0]*a[q][1]-a[q][0]*a[m][1];if(0<0.5*h)for(g=0;g<c;g++)d[g]=g;else for(g=0;g<c;g++)d[g]=c-1-g;q=2*c;h=0;for(g=c-1;2<c;){if(0>=q--)return null;var r=g;c<=r&&(r=0);g=r+1;c<=g&&(g=0);m=g+1;c<=m&&(m=0);var u;a:{u=a;var x=r,v=g,y=m,C=c,z=d,G=void 0,H=void 0,I=void 0,J=void 0,L=void 0,M=void 0,K=void 0,N=void 0,Y=void 0,H=u[z[x]][0],I=u[z[x]][1],
J=u[z[v]][0],L=u[z[v]][1],M=u[z[y]][0],K=u[z[y]][1];if(e>(J-H)*(K-I)-(L-I)*(M-H))u=!1;else{for(G=0;G<C;G++)if(!(G==x||G==v||G==y)){var N=u[z[G]][0],Y=u[z[G]][1],ca=void 0,U=void 0,na=void 0,Q=void 0,O=void 0,Ma=void 0,gb=void 0,hb=void 0,Na=void 0,qb=void 0,Oa=void 0,ib=void 0,ca=na=O=void 0,ca=M-J,U=K-L,na=H-M,Q=I-K,O=J-H,Ma=L-I,gb=N-H,hb=Y-I,Na=N-J,qb=Y-L,Oa=N-M,ib=Y-K,ca=ca*qb-U*Na,O=O*hb-Ma*gb,na=na*ib-Q*Oa;if(0<=ca&&0<=na&&0<=O){u=!1;break a}}u=!0}}if(u){q=d[r];r=d[g];m=d[m];b.push(q);b.push(r);
b.push(m);h++;m=g;for(q=g+1;q<c;m++,q++)d[m]=d[q];c--;q=2*c}}return b}function u(a,c,d){d===b&&(d=0);var e;e=x(c);var g=CubicVR.util.repackArray(e,3,e.length/3),h=[],m=a.points.length;e=0;for(iMax=c.length;e<iMax;e++)h.push([c[e][0],c[e][1],d]);a.addPoint(h);e=0;for(iMax=g.length;e<iMax;e++)a.addFace([g[e][0]+m,g[e][1]+m,g[e][2]+m])}function m(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)}function q(a,b){var c,d,e=[],g=a.length,h=b.length,q=[];for(c=0;c<g;c++)for(d=0;d<h;d++){var r=m(a[c],
b[d]);e.push([r,c,d])}e.sort(function(a,b){return a[0]>b[0]});for(c=0;5>c;c++)for(d=0;d<e.length;d++)c!=d&&e[c][1]!=e[d][1]&&e[c][2]!=e[d][2]&&e[c][1]<e[d][1]&&e[c][2]<e[d][2]&&4>Math.abs(e[c][1]-e[d][1])&&4>Math.abs(e[c][2]-e[d][2])&&q.push([c,d]);q.sort(function(a,b){return e[a[0]][0]+e[a[1]][0]>e[b[0]][0]+e[b[1]][0]});10<q.length&&(q.length=10);d=[];for(c=0;c<q.length;c++)d.push([e[q[c][0]],e[q[c][1]]]);return d}function r(a,b){var c=q(a,b),d;if(!c.length)return null;d=c[0][0];var e=c[0][1],c=
e[1]-d[1],e=e[2]-d[2],g=a.slice(d[1]),g=g.concat(a.slice(0,d[1])),h=b.slice(d[2]),h=h.concat(b.slice(0,d[2])),m=[];for(d=c;d<g.length;d++)m.push(g[d]);m.push(g[0]);for(d=e;d<h.length;d++)m.push(h[d]);m.push(h[0]);var r=[];for(d=0;d<=c;d++)r.push(g[d]);for(d=0;d<=e;d++)r.push(h[d]);return[m,r]}function c(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,c){for(var d=[],e=0;e<a.length;e++){var g=[a[e][0]-b[0],a[e][1]-b[1]],h=Math.sqrt(g[0]*
g[0]+g[1]*g[1])+c,g=Math.atan2(g[1],g[0]);d[e]=[b[0]+Math.cos(g)*h,b[1]+Math.sin(g)*h]}return d}function d(a,b,c,d,e){var g,h=a.points.length;if(b.length!=c.length)return null;var m=b.length;for(g=0;g<m;g++)a.addPoint([b[g][0],b[g][1],d]);for(g=0;g<m;g++)a.addPoint([c[g][0],c[g][1],e]);for(g=0;g<m-1;g++)a.addFace([h+g,h+g+1,h+(g+m+1),h+(g+m)]);g=m-1;a.addFace([h+g,h,h+m,h+(g+m)])}function a(a){this.points=a;this.cuts=[];this.result=[]}var b=h.undef,e=1.0E-10;a.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var c=this.cuts[b].points.slice(0),c=c.reverse(),c=r(this.result[0],c);this.result[0]=c[0];this.result.push(c[1])}for(b=0;b<this.result.length;b++)u(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(a,c,e){if(0!==this.points.length){var g,h;c===b&&(c=0);e===b&&(e=0);var m=c!=e;a||(a=new CubicVR.Mesh);this.result=[this.points];for(h=0;h<this.cuts.length;h++)g=
this.cuts[h].points.slice(0),g=g.reverse(),g=r(this.result[0],g),this.result[0]=g[0],this.result.push(g[1]);g=new CubicVR.Mesh;for(h=0;h<this.result.length;h++)u(g,this.result[h],e);a.booleanAdd(g);g.flipFaces();if(m)for(h=0;h<g.points.length;h++)g.points[h][2]=c;a.booleanAdd(g);if(m){d(a,this.points,this.points,c,e);for(h=0;h<this.cuts.length;h++)g=this.cuts[h].points.slice(0),g=g.reverse(),d(a,g,g,c,e)}a.removeDoubles();return a}},toExtrudedBeveledMesh:function(a,b,e,h,m,q,t){var x=[],A=[],E,F,
v,y;if(0!==this.points.length){"object"===typeof b&&(t=b,b=t.front||0,e=t.back||0,h=t.frontDepth||0,m=t.frontShift||0,q=t.backDepth||0,t=t.backShift||0);var C=b!==e,z=0!==q,G=0!==h;a||(a=new CubicVR.Mesh);G?(F=c(this.points),F=g(this.points,F,-m),this.result=[F.slice(0)]):this.result=[this.points.slice(0)];for(y=0;y<this.cuts.length;y++)v=c(this.cuts[y].points),v=g(this.cuts[y].points,v,m),v=v.reverse(),x.push(v),v=r(this.result[0],v),this.result[0]=v[0],this.result.push(v[1]);m=new CubicVR.Mesh;
for(y=0;y<this.result.length;y++)u(m,this.result[y],b-h);m.flipFaces();a.booleanAdd(m);if(z||G){E=c(this.points);E=g(this.points,E,-t);this.result=[E.slice(0)];for(y=0;y<this.cuts.length;y++)v=c(this.cuts[y].points),v=g(this.cuts[y].points,v,t),v=v.reverse(),A.push(v),v=r(this.result[0],v),this.result[0]=v[0],this.result.push(v[1]);m=new CubicVR.Mesh;for(y=0;y<this.result.length;y++)u(m,this.result[y],e+q)}else{for(y=0;y<m.points.length;y++)m.points[y][2]=e;m.flipFaces()}a.booleanAdd(m);G&&d(a,F,
this.points,b-h,b);C&&d(a,this.points,this.points,b,e);z&&d(a,this.points,E,e,e+q);for(y=0;y<x.length;y++)v=this.cuts[y].points.slice(0).reverse(),G&&d(a,x[y],v,b-h,b),C&&d(a,v,v,b,e),z&&d(a,v,A[y],e,e+q);a.removeDoubles();return a}}};return{polygon:{triangulate2D:x,toMesh:u,findNearPair:function(a,b){for(var c=[0,0],d=m(a[0],b[0]),e=a.length,g=b.length,h=0;h<e;h++)for(var q=0;q<g;q++){var r=m(a[h],b[q]);r<d&&(c[0]=h,c[1]=q,d=r)}return c},subtract:r,addOffset:function(a,b){for(var c=[],d=0,e=a.length;d<
e;d++){var g=a[d];c.push([g[0]+b[0],g[1]+b[1]])}return c}},Polygon:a}});
CubicVR.RegisterModule("ScenePhysics",function(h){function x(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function u(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function m(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function q(a){return new Ammo.btVector3(a[0],a[1],a[2])}function r(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function c(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var d=h.undef,a=h.enums;
a.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var b,e,f,o,n,s=function(a,b,c){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,b=d.properties,c=d.collision);d=h.get(d)||{};this.properties=new h.RigidProperties(b?h.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(q(this.init_position));this.transform.setRotation(r(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};s.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var b=this.getCollisionShape();this.getType()===a.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(b),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&b.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,b,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),x(this.linearVelocity,o),this.body.setLinearVelocity(o),x(this.angularVelocity,o),this.body.setAngularVelocity(o),h.vec3.equal([0,0,0],this.impulse)||(x(this.impulse,o),x(this.impulsePosition,n),this.body.applyImpulse(o,n)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(b),a=b.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=b.getRotation(),e.x=a.x(),e.y=a.y(),e.z=a.z(),e.w=a.w(),e.x!=e.x?console.log("rotation is NaN"):(a=e.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();x(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;e.fromEuler(a[0],a[1],a[2]);a=[e.x,e.y,e.z,e.w];f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);f.setW(a[3]);this.body.getWorldTransform().setRotation(f);this.activate()}},resetMotion:function(){x(this.init_linearVelocity,
o);this.body.setLinearVelocity(o);x(this.init_angularVelocity,o);this.body.setAngularVelocity(o);h.vec3.equal([0,0,0],this.init_impulse)||(x(this.init_impulse,o),x(this.init_impulsePosition,n),this.body.applyImpulse(o,n))},getCollisionShape:function(){if(!this.shape){var c;c=this.getCollisionMap();if(c.getResult())c=c.getResult();else{var d=c.getShapes(),e,f,g,m,n,o,s,u=[],w=null;f=0;for(g=d.length;f<g;f++){e=d[f];w=null;if(e.type===a.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(e.size[0]/
2,e.size[1]/2,e.size[2]/2));else if(e.type===a.collision.shape.SPHERE)w=new Ammo.btSphereShape(e.radius);else if(e.type===a.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(e.radius,e.height);else if(e.type===a.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(e.size[0]/2,e.size[1]/2,e.size[2]/2));else if(e.type===a.collision.shape.CONE)w=new Ammo.btConeShape(e.radius,e.height);else if(e.type===a.collision.shape.MESH){s=e.mesh;w=new Ammo.btTriangleMesh;o=e.size;var D=new Ammo.btVector3(0,
0,0),J=new Ammo.btVector3(0,0,0),L=new Ammo.btVector3(0,0,0),M=s.getMaterials();m=0;for(n=s.faces.length;m<n;m++){var K=s.faces[m];M[K.material].collision&&3===K.points.length&&(D.setValue(s.points[K.points[0]][0]*o[0],s.points[K.points[0]][1]*o[1],s.points[K.points[0]][2]*o[2]),J.setValue(s.points[K.points[1]][0]*o[0],s.points[K.points[1]][1]*o[1],s.points[K.points[1]][2]*o[2]),L.setValue(s.points[K.points[2]][0]*o[0],s.points[K.points[2]][1]*o[1],s.points[K.points[2]][2]*o[2]),w.addTriangle(D,J,
L))}0===this.getMass()||this.getType()==a.physics.body.STATIC||this.getType()==a.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(e.type===a.collision.shape.CONVEX_HULL){s=e.mesh;o=e.size;D=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;m=0;for(n=s.points.length;m<n;m++)x([s.points[m][0]*o[0],s.points[m][1]*o[1],s.points[m][2]*o[2]],D),w.addPoint(D)}else if(e.type===a.collision.shape.HEIGHTFIELD){var J=D=s=o=0,
N;e.landscape&&!e.getHeightField&&e.landscape instanceof h.HeightField?e.heightfield=e.landscape:e.landscape&&e.landscape instanceof h.Landscape&&(o=e.landscape.getHeightField().getDivX(),D=e.landscape.getHeightField().getDivZ(),s=e.landscape.getHeightField().getSizeX(),J=e.landscape.getHeightField().getSizeZ(),N=e.landscape.getMesh().points,e.landscape.getHeightField());e.heightfield&&e.heightfield instanceof h.HeightField&&(o=e.heightfield.getDivX(),D=e.heightfield.getDivZ(),s=e.heightfield.getSizeX(),
J=e.heightfield.getSizeZ(),N=e.getMesh().points);w=Ammo.allocate(4*N.length,"float",Ammo.ALLOC_NORMAL);m=0;for(n=o*D;m<n;m++)Ammo.setValue(w+(m<<2),N[m][1],"float");w=new Ammo.btHeightfieldTerrainShape(o,D,w,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);m=new Ammo.btVector3(s/o,1,J/D);w.setLocalScaling(m)}w&&(0!==e.margin&&w.setMargin(e.margin),u.push({cShape:e,btShape:w}))}d=null;if(1===u.length)d=u[0].btShape;else if(1<u.length){b=new Ammo.btTransform;d=new Ammo.btCompoundShape(!1);f=0;for(g=
u.length;f<g;f++)b.setIdentity(),b.setOrigin(q(u[f].cShape.position)),b.setRotation(r(u[f].cShape.rotation)),d.addChildShape(b,u[f].btShape)}c.setResult(d);c=d}this.shape=c}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(x(a,o),this.body.setAngularVelocity(o))},setGravity:function(a){this.gravity=a;this.body&&(x(a,o),this.body.setGravity(o))},getGravity:function(){return this.gravity&&!this.body?this.gravity:c(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=
a;this.body&&(x(a,o),this.body.setLinearVelocity(o))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!h.vec3.equal([0,0,0],a)&&(x(this.impulse,o),x(this.impulsePosition,n),this.body.applyImpulse(o,n))},applyForce:function(a,b){this.body&&!h.vec3.equal([0,0,0],a)&&(x(a,o),x(b,n),this.body.applyImpulse(o,n))},getAngularVelocity:function(){return c(this.body.getAngularVelocity())},getLinearVelocity:function(){return c(this.body.getLinearVelocity())},activate:function(b){this.noDeactivate=
b||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(a.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(a){this.body&&a!==d&&(a.length||(a=[a,a,a]),x(a,o),this.body.setAngularFactor(o))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==a.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(b){this.collision_flags=
b=h.parseEnum(a.physics.collision_flags,b);this.body&&this.body.setCollisionFlags(b)},setPosition:function(a){this.position=a;if(this.body||this.ghost)x(a,o),this.body&&this.body.getCenterOfMassTransform().setOrigin(o),this.ghost&&this.ghost.getWorldTransform().setOrigin(o)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);var a=new h.Quaternion;m(f,a);
return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)u(a,f),this.body&&this.body.getCenterOfMassTransform().setRotation(f),this.ghost&&this.ghost.getWorldTransform().setRotation(f)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new h.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);m(f,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;f.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(f);this.ghost&&this.body.getWorldTransform().setRotation(f)}};var D=function(b){b=b||{};this.ctype=h.parseEnum(a.physics.constraint,b.ctype)||a.physics.constraint.P2P;this.strength=b.strength||0.1;this.maxImpulse=b.maxImpulse||0;this.rigidBodyA=b.rigidBodyA||b.rigidBody||null;this.rigidBodyB=b.rigidBodyB||null;this.positionA=b.positionA||
[0,0,0];this.positionB=b.positionB||b.position||[0,0,0];this.damping=b.damping!=d?b.damping:1;this.btConstraint=null;this.localPivotA=q(this.positionA);this.localPivotB=q(this.positionB)};D.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===a.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(x(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),
friction:a.get_m_combinedFriction(),positionA:c(a.getPositionWorldOnA()),positionB:c(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var w=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;
this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!b||!e)o=new Ammo.btVector3,n=new Ammo.btVector3,b=new Ammo.btTransform,e=new h.Quaternion,f=new Ammo.btQuaternion};w.prototype={addConstraint:function(a){var b=
a.getConstraint();return b?(this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){x(a,o);this.dynamicsWorld.setGravity(o)},bindSceneObject:function(a,b){var c=new h.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bind:function(a){a instanceof h.Vehicle?a.initBody(this):
a instanceof h.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof h.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(b){if(b.getType()===a.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(b))return;this.ghostObjects.push(b);var c=b.getBody();b.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+a.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(c)}else{if(-1!==this.rigidObjects.indexOf(b))return;this.rigidObjects.push(b);c=
b.getBody();b.activate();this.dynamicsWorld.addRigidBody(c);b.updateSceneObject(!0)}var d,e;if((d=b.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(a.event.CONTACT)&&this.contactObjects.push(b),e.hasEvent(a.event.COLLIDE)&&this.collisionObjects.push(b)},removeRigidBody:function(b){if(b.getType()===a.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(b))return;this.ghostObjects.splice(this.ghostObjects.indexOf(b),1);this.dynamicsWorld.removeCollisionObject(b.getBody())}else{if(-1===this.rigidObjects.indexOf(b))return;
this.rigidObjects.splice(this.rigidObjects.indexOf(b),1);this.dynamicsWorld.removeRigidBody(b.getBody())}var c,d;if((c=b.getSceneObject())&&(d=c.getEventHandler()))d.hasEvent(a.event.CONTACT)&&-1!==this.contactObjects.indexOf(b)&&this.contactObjects.splice(this.contactObjects.indexOf(b),1),d.hasEvent(a.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(b)&&this.collisionObjects.splice(this.collisionObjects.indexOf(b),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var b,c,d,e,f=this.dynamicsWorld;if(this.contactObjects.length){var h=f.getDispatcher().getNumManifolds();for(b=0;b<h;b++){var m=f.getDispatcher().getManifoldByIndexInternal(b),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(n&&(e=n.getSceneObject())&&(c=e.getEventHandler())&&c.hasEvent(a.event.CONTACT))d=c.triggerEvent(a.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m);else if(o&&o.isStatic()&&(e=o.getSceneObject())&&(c=e.getEventHandler())&&c.hasEvent(a.event.CONTACT))d=c.triggerEvent(a.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m)}}f=this.collisionObjects.length;for(b=0;b<f;b++)if(n=this.collisionObjects[b],(e=n.getSceneObject())&&
(c=e.getEventHandler())&&c.hasEvent(a.event.COLLIDE))if(d=c.getProperties(a.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){h=[];n=n.getBody();b=0;for(iMax=m.length;b<iMax;b++){var o=m[b],q=o.getBody();d.mf[b]||(d.mf[b]=new Ammo.btManifoldResult(n,q));d.alg[b]||(d.alg[b]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[b].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),d.mf[b]);0<d.mf[b].getPersistentManifold().getNumContacts()&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[b].getPersistentManifold()))}if(h.length&&
(d=c.triggerEvent(a.event.COLLIDE)))d.collisions=h}f=this.ghostObjects.length;for(b=0;b<f;b++)if(d=this.ghostObjects[b],e=d.getSceneObject())if((c=e.getEventHandler())&&c.hasEvent(a.event.CONTACT_GHOST))if(e=d.getBody(),h=e.getNumOverlappingObjects()){d=c.triggerEvent(a.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=h);for(c=0;c<h;c++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(c)),d.contacts[c]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,d,e){var f,a=q(a);f=q(b);d=d||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,f);this.dynamicsWorld.rayTest(a,f,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=b.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(f=d._cvr_rigidbody)return Ammo.destroy(b),{position:c(e),
localPosition:c(a),rigidBody:f,ammoBody:d};Ammo.destroy(b);return{position:c(e),localPosition:c(a),rigidBody:null,ammoBody:d}}Ammo.destroy(b)}};return{ScenePhysics:w,Constraint:D,RigidProperties:function(b){this.type=h.parseEnum(a.physics.body,b.type);this.mass=b.mass!==d?b.mass:this.type?1:0;this.size=b.size||[1,1,1];this.restitution=b.restitution||(this.type?0:1);this.friction=b.friction||1;if((this.collision=b.collision)&&!this.collision.getShapes)this.collision=new h.CollisionMap(this.collision);
this.blocker=b.blocker||!1},RigidBody:s,vec3bt_copy:x,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:u,btquat_copy:m}});
CubicVR.RegisterModule("CollisionMap",function(h){var x=h.enums;x.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var u=function(h){this.shapes=[];this.result=null;if(h){h&&!h.length&&(h=[h]);for(var q=0,r=h.length;q<r;q++)this.addShape(h[q])}};u.prototype={addShape:function(m){m.type=h.parseEnum(x.collision.shape,m.type);m.position=m.position||[0,0,0];m.rotation=m.rotation||[0,0,0];m.size=m.size||[1,1,1];m.radius=m.radius||1;m.height=m.height||1;
m.margin=m.margin||0;m.mesh=m.mesh||null;this.shapes.push(m)},getShapes:function(){return this.shapes},setResult:function(h){this.result=h},getResult:function(){return this.result}};return{CollisionMap:u}});
CubicVR.RegisterModule("RigidVehicle",function(h){var x=h.undef,u=h.enums,m,q,r=function(c){var c=h.get(c)||{},d=c.mesh,a=c.collision;this.maxEngineForce=c.maxEngineForce||2E3;this.maxBreakingForce=c.maxBreakingForce||125;this.steeringClamp=c.steeringClamp||0.51;this.mass=c.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=d;this.bodyCollision=new h.CollisionMap(a);this.sceneObject=new h.SceneObject(this.bodyMesh);if(!m||!q)new Ammo.btVector3,new Ammo.btVector3,m=new Ammo.btTransform,q=new h.Quaternion,new Ammo.btQuaternion;if(c.wheels!=x){d=0;for(a=c.wheels.length;d<a;d++){var b=c.wheels[d];b instanceof h.VehicleWheel?this.addWheel(b):this.addWheel(new h.VehicleWheel(b))}}};r.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(c){this.body=
new h.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});h.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);h.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(c.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(u.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var d=new Ammo.btVector3,a=0;a<this.wheels.length;a++)h.vec3bt_copy(this.wheels[a].getWheelPosition(),d),this.m_vehicle.addWheel(d,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[a].getSuspensionRest(),this.wheels[a].getWheelRadius(),this.m_tuning,this.wheels[a].getSteering());c.dynamicsWorld.addVehicle(this.m_vehicle);c.bind(this.body);this.updateSuspension()},evaluate:function(){for(var c=this.m_vehicle.getNumWheels(),
d=0;d<c;d++){this.wheels[d].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,d);this.wheels[d].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,d);this.wheels[d].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,d);this.m_vehicle.updateWheelTransform(d,!0);var a=this.m_vehicle.getWheelTransformWS(d),b=a.getOrigin();this.wheels[d].wheelObj.position[0]=b.x();this.wheels[d].wheelObj.position[1]=b.y();this.wheels[d].wheelObj.position[2]=b.z();a=a.getRotation();q.x=
a.x();q.y=a.y();q.z=a.z();q.w=a.w();a=q.toEuler();this.wheels[d].wheelObj.rotation[0]=a[0];this.wheels[d].wheelObj.rotation[1]=a[1];this.wheels[d].wheelObj.rotation[2]=a[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(c){if(this.body&&(this.body.isActive()||c))return this.body.getBody().getMotionState().getWorldTransform(m),c=m.getOrigin(),c.x!=c.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
c.x(),this.sceneObject.position[1]=c.y(),this.sceneObject.position[2]=c.z()),c=m.getRotation(),q.x=c.x(),q.y=c.y(),q.z=c.z(),q.w=c.w(),q.x!=q.x?console.log("rotation is NaN"):(c=q.toEuler(),this.sceneObject.rotation[0]=c[0],this.sceneObject.rotation[1]=c[1],this.sceneObject.rotation[2]=c[2]),!0},setEngineForce:function(c){this.gEngineForce=c;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(c){this.setEngineForce(this.getEngineForce()+c)},decEngine:function(c){this.setEngineForce(this.getEngineForce()-c)},setSteering:function(c){this.gVehicleSteering=c},getSteering:function(){return this.gVehicleSteering},incSteering:function(c){this.gVehicleSteering+=c;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(c){this.gBreakingForce=c},getWheelGroundPosition:function(c){return this.wheels[c].wheelObj.getWorldPosition()-[0,wheels[c].getWheelRadius(),0]},getWheelSkid:function(c){return this.m_vehicle.getWheelInfo(c).get_m_skidInfo()},getRigidGround:function(c){this.m_vehicle.getWheelInfo(c)},addWheel:function(c,d){d===x&&(d=this.wheels.length);this.wheels[d]=c},getWheel:function(c){return this.wheels[c]},bindToScene:function(c){for(var d=this.wheels.length,a=0;a<d;a++)c.bind(this.getWheelObj(a));
c.bind(this.getSceneObject())},getWheelObj:function(c){return this.getWheel(c).wheelObj},updateSuspension:function(){var c,d=this.m_vehicle.getNumWheels();for(c=0;c<d;c++){var a=this.m_vehicle.getWheelInfo(c);a.set_m_suspensionStiffness(this.wheels[c].getSuspensionStiffness());a.set_m_suspensionRestLength1(this.wheels[c].getSuspensionRest());a.set_m_wheelsDampingRelaxation(this.wheels[c].getDampingRelaxation());a.set_m_wheelsDampingCompression(this.wheels[c].getDampingCompression());a.set_m_frictionSlip(this.wheels[c].getFrictionSlip());
a.set_m_rollInfluence(this.wheels[c].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(c=0;c<d;c++)this.m_vehicle.updateWheelTransform(c,!0)}},getMass:function(){return this.mass},setMass:function(c){this.mass=c;this.body&&this.body.setMass(this.mass)}};var c=function(c){c=h.get(c)||{};this.wheelRef=new h.SceneObject;this.wheelObj=new h.SceneObject;this.wheelRef.scale=c.scale||[1,1,1];this.wheelRadius=c.radius||0;this.wheelWidth=c.width||0;c.mesh!=x&&this.setModel(c.mesh);
this.suspensionStiffness=c.suspensionStiffness||40;this.suspensionRest=c.suspensionRest||0.05;this.dampingRelaxation=c.dampingRelaxation||2.3;this.dampingCompression=c.dampingCompression||2.4;this.frictionSlip=c.frictionSlip||0.94;this.rollInfluence=c.rollInfluence||0.5;this.wheelPosition=c.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=c.steering||!1;this.braking=c.braking||!1;this.driving=c.driving||!1};c.prototype={setModel:function(c,d,a){this.wheelModel=c;this.wheelRadius=d||0;this.wheelWidth=
a||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(c){this.suspensionStiffness=c},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(c){this.suspensionRest=
c},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(c){this.dampingRelaxation=c},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(c){this.dampingCompression=c},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(c){this.frictionSlip=c},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(c){this.rollInfluence=c},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(c){this.wheelRadius=c},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(c){this.wheelWidth=c},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(c){this.wheelRotation=c;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(c){this.wheelPosition=c;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(c){this.steering=
c},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(c){this.driving=c},isDriving:function(){return this.driving}};return{Vehicle:r,VehicleWheel:c}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
