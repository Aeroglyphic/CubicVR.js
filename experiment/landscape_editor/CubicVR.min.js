try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(e$$8){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}
(function(h,y,w,q,n){function r(a,b){if("object"!==typeof a)return m("enumerator validation failed, invalid type base object."),n;if(b===n)return n;if("number"===typeof b)return b;if("string"===typeof b){var f=parseInt(b,10);if(""!==b&&isFinite(f))return f;f=b.toUpperCase();f=a[f];if(f!==n)return f;m("enumerator validation failed, unknown enum value: "+b);var f="",d;for(d in a)a.hasOwnProperty(d)&&(""!==f&&(f+=", "),f+=d.toLowerCase());m("possible enum values are: "+f)}return n}var c="";try{for(var g=
y.querySelectorAll("script"),a=0,b=g.length;a<b;a++){var e=g[a].src.lastIndexOf("/CubicVR.js");-1<e&&(c=g[a].src.substr(0,e)+"/")}}catch(d){}var f=h.CubicVR={};f.contexts={};var m;try{m=void 0!==console&&console.log?function(a){console.log("CubicVR Log: "+a)}:function(){}}catch(o){m=q}var s={quality:{LOW:0,MEDIUM:1,HIGH:2}};h.cubicvr=s;var D={},v=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],u=function(a){function b(a,f,d){var o=function(){};o.prototype=a.prototype;f.prototype=new o;for(var m in d)f.prototype[m]=
d[m];return f}var d=this,o;a&&(o=a+"",Object.defineProperty(this,"context",{enumerable:!0,configurable:!1,get:function(){return o}}));d.undef=n;d.nop=q;d.scriptLocation=c;d.GLCore=A;d.Textures=[];d.Textures_obj=[];d.Textures_ref=[];d.Images=[];d.ShaderPool=[];d.log=m;d.enums=f.enums;d.MAX_LIGHTS=6;d.extendClassGeneral=b;d.extendClass=function(a,f,d){return b(a,function(){a.apply(this);f.apply(this,arguments)},d)};d.features={};d.quality=f.enums.HIGH;var e={antiAlias:!1,lightPerPixel:!1,lightShadows:!1,
texturePerPixel:!1,postProcess:!1},g={antiAlias:!1,lightPerPixel:!0,lightShadows:!1,texturePerPixel:!1,postProcess:!1},u={antiAlias:!0,lightPerPixel:!0,lightShadows:!0,texturePerPixel:!0,postProcess:!0};d.features=u;var A={CoreShader_vs:null,CoreShader_fs:null,canvas:null,width:null,height:null,fixed_aspect:0,fixed_size:null,depth_alpha:!1,default_filter:1,mainloop:null,shadow_near:0.1,shadow_far:100,soft_shadow:!1,fogLinear:!1,fogExp:!1,fogNoise:!1,fogColor:[1,1,1],fogDensity:0,fogNear:0,fogFar:0,
resize_active:!1,emptyLight:null,resizeList:[],canvasSizeFactor:1,init:function(a,b,o){var e,s=d.util,g=f.enums;if(b&&o){b=s.getScriptContents(b);o=s.getScriptContents(o)}else if(h.CubicVRShader.CubicVRCoreVS&&h.CubicVRShader.CubicVRCoreFS){b=h.CubicVRShader.CubicVRCoreVS;o=h.CubicVRShader.CubicVRCoreFS}else{b=s.getScriptContents(c+"CubicVR_Core.vs");o=s.getScriptContents(c+"CubicVR_Core.fs")}if(a===n){a=y.createElement("canvas");if(!e)try{e=a.getContext("experimental-webgl",{antialias:d.features.antiAlias})}catch(u){return null}A.gl=
e;if(A.fixed_size!==null){A.width=A.fixed_size[0];A.height=A.fixed_size[1];A.resizeElement(a,A.width,A.height)}else{A.addResizeable(a);if(A.canvasSizeFactor!==1&&a.getContext!==n){var s=w.round(h.innerWidth*A.canvasSizeFactor),v=w.round(h.innerHeight*A.canvasSizeFactor);A.resizeElement(a,s,v);a.style.top=h.innerHeight/2-v/2+"px";a.style.left=h.innerWidth/2-s/2+"px";a.style.position="absolute"}else A.resizeElement(a,h.innerWidth,h.innerHeight)}y.body.appendChild(a)}if(a.getContext!==n&&a.width!==n&&
a.height!==n){try{e||(e=a.getContext("experimental-webgl",{antialias:d.features.antiAlias}));e.viewport(0,0,a.width,a.height);A.canvas=a;A.width=a.width;A.height=a.height;e.clearColor(0,0,0,1);e.clearDepth(1);e.enable(e.DEPTH_TEST);e.depthFunc(e.LEQUAL)}catch(D){}if(!e)return null}else e=a;A.gl=e;A.CoreShader_vs=b;A.CoreShader_fs=o;e.enable(e.CULL_FACE);e.cullFace(e.BACK);e.frontFace(e.CCW);for(b=f.enums.light.type.NULL;b<g.light.type.MAX;b++)d.ShaderPool[b]=[];o=new d.Texture;a=new d.Material;for(b=
0;b<g.texture.map.MAX;b++)b!==g.texture.map.BUMP&&a.setTexture(o,b);a.opacity=0.5;for(b=1;;){if(!a.use(g.light.type.POINT,b)||b===8){d.MAX_LIGHTS=b;break}b++}a=A.emptyLight=new d.Light(g.light.type.POINT);a.diffuse=[0,0,0];a.specular=[0,0,0];a.distance=0;a.intensity=0;a.cutoff=0;m("Calibrated maximum lights per pass to: "+b);for(b=g.light.type.NULL;b<g.light.type.MAX;b++)d.ShaderPool[b]=[];if(A.resizeList.length){h.addEventListener("resize",function(){d.GLCore.onResize()},false);A.resize_active=true}return e},
addResizeable:function(a){d.GLCore.resizeList.push(a)},onResize:function(){var a=h.innerWidth,b=h.innerHeight;if(A.fixed_size!==null){a=d.GLCore.fixed_size[0];b=d.GLCore.fixed_size[1]}for(var f=0,o=d.GLCore.resizeList.length;f<o;f++)A.resizeElement(d.GLCore.resizeList[f],a,b)},setFixedAspect:function(a){d.GLCore.fixed_aspect=a},setFixedSize:function(a,b){d.GLCore.fixed_size=[a,b]},getCanvas:function(){return d.GLCore.canvas},resizeElement:function(a,b,f){var o=A.gl;if(A.fixed_aspect!==0){var m=b*
(1/d.GLCore.fixed_aspect);if(m>f){m=f;b=f*d.GLCore.fixed_aspect}f=m}if(a.getContext!==n){a.width=b;a.height=f;if(!d.GLCore.fixed_size){a.style.left=(h.innerWidth/2-b/2|0)+"px";a.style.top=(h.innerHeight/2-f/2|0)+"px";a.style.position="absolute"}o.viewport(0,0,b,f)}else a.resize(b,f)},setDepthAlpha:function(a,b,f){A.depth_alpha=a;A.depth_alpha_near=b;A.depth_alpha_far=f},setDefaultFilter:function(a){A.default_filter=r(d.enums.texture.filter,a)},setSoftShadows:function(a){A.soft_shadow=a},setFog:function(a){A.fog_enabled=
a},setFogExp:function(a,b){A.fog_enabled=true;A.fogLinear=false;A.fogExp=true;A.fogColor=a;A.fogDensity=b},setNoise:function(a){A.fogNoise=a},setFogLinear:function(a,b,f){A.fog_enabled=true;A.fogExp=false;A.fogLinear=true;A.fogColor=a;A.fogNear=b;A.fogFar=f},setCanvasSizeFactor:function(a){A.canvasSizeFactor=a},setQuality:function(a){a=r(s.quality,a);if(a===s.quality.HIGH)d.features=u;else if(a===s.quality.MEDIUM)d.features=g;else if(a===s.quality.LOW)d.features=e;d.quality=a;return d.features},getQuality:function(){return d.features}},
E=function(a,b,f){for(var o,m=y.getElementsByTagName("script"),e=0;e<m.length;++e){var s=m[e];if(s.getAttribute("data-cubicvr")){var c=s.getAttribute("src");if(c){var g=new XMLHttpRequest;g.open("GET",c,false);g.send(null);if(g.status===200||g.status===0)s.text=g.responseText}}}if(typeof a==="object")if(a.getContext)o=a;else{o=a.canvas;b=a.vertexShader||b;f=a.fragmentShader||f}else if(a){a[0]=="#"&&(a=a.substr(1));o=y.getElementById(a)}for(var u in D){var a=D[u](d),v;for(v in a)a.hasOwnProperty(v)&&
(d[v]=a[v])}A.init(o,b,f);return A.gl};d.GLCore=A;d.init=E;d.start=function(a,b,f,o,m){typeof a==="string"&&a.toLowerCase()==="auto"&&(a=n);f=f||"Sorry, your browser does not appear to support WebGL :-(";if(a=E(a,o,m)){b&&typeof b==="function"&&b(a,d.getCanvas());return a}if(!a){f&&typeof f==="function"?f():alert(f);return false}};d.addResizeable=A.addResizeable;d.setFixedAspect=A.setFixedAspect;d.setFixedSize=A.setFixedSize;d.setCanvasSizeFactor=A.setCanvasSizeFactor;d.getCanvas=A.getCanvas;d.enums=
s;d.IdentityMatrix=v;d.Textures=d.Textures;d.Textures_obj=d.Textures_obj;d.Images=d.Images;d.globalAmbient=[0.1,0.1,0.1];d.setGlobalAmbient=function(a){d.globalAmbient=a};d.setGlobalDepthAlpha=A.setDepthAlpha;d.setDefaultFilter=A.setDefaultFilter;d.setSoftShadows=A.setSoftShadows;d.setQuality=A.setQuality;d.getQuality=A.getQuality;d.RegisterModule=f.RegisterModule;d.getScriptLocation=f.getScriptLocation;d.setFogExp=A.setFogExp;d.setFogLinear=A.setFogLinear;d.setFogNoise=A.setFogNoise;d.parseEnum=
r};f.init=function(a,b,d){var o;a&&(a.context&&"string"===typeof a.context)&&(o=a.context);o=new u(o);if(o.context)return f.contexts[o.context]=o,o.init(a,b,d),o;h.CubicVR=f=o;o.init(a,b,d);return o.GLCore.gl};f.start=function(a,b,d,o,m){var e=new u;h.CubicVR=f=e;e.start(a,b,d,o,m);return e};f.RegisterModule=function(a,b){D[a]=b};f.getScriptLocation=function(){return c};f.enums=s})(window,window.document,Math,function(){});window.CubicVRShader={};
CubicVR.RegisterModule("Math",function(h){function y(a){return this.clearStack(a)}function w(){1===arguments.length&&(this.x=arguments[0][0],this.y=arguments[0][1],this.z=arguments[0][2],this.w=arguments[0][3]);4===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2],this.w=arguments[3])}var q=h.undef,n=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=Math.PI/2,c={length:function(a,b){var e,d,f;b===q?(e=a[0],d=a[1],f=a[2]):(e=b[0]-a[0],d=b[1]-a[1],f=b[2]-a[2]);return Math.sqrt(e*e+d*
d+f*f)},normalize:function(a){var b=a[0],e=a[1],d=a[2];return(b=Math.sqrt(b*b+e*e+d*d))?[a[0]/b,a[1]/b,a[2]/b]:[0,0,0]},dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},angle:function(a,b){return Math.acos((a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/(Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*Math.sqrt(b[0]*b[0]+b[1]*b[1]+b[2]*b[2])))},cross:function(a,b){return[a[1]*b[2]-b[1]*a[2],a[2]*b[0]-b[2]*a[0],a[0]*b[1]-b[0]*a[1]]},multiply:function(a,b){return[a[0]*b,a[1]*b,a[2]*b]},add:function(a,b){return[a[0]+
b[0],a[1]+b[1],a[2]+b[2]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},equal:function(a,b,e){e===q&&(e=1.0E-7);return a===q&&b===q?!0:a===q||b===q?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e&&Math.abs(a[2]-b[2])<e},moveViewRelative:function(a,b,e,d,f){var m=Math.atan2(d,e),b=Math.atan2(b[2]-a[2],b[0]-a[0]),e=Math.sqrt(e*e+d*d),m=b+m+r;return"object"===typeof f?[f[0]+e*Math.cos(m),f[1],f[2]+e*Math.sin(m)]:[a[0]+e*Math.cos(m),a[1],a[2]+e*Math.sin(m)]},trackTarget:function(a,b,
e,d){var b=c.subtract(b,a),f=c.length(b),m;m=c.normalize(b);m=c.multiply(m,e*(1/(1/(f-d))));f>d?a=c.add(a,m):f<d?(m=c.normalize(b),m=c.multiply(m,e*(1/(1/Math.abs(f-d)))),a=c.subtract(a,m)):a=[a[0],a[1]+m[2],a[2]];return a},getClosestTo:function(a,b,e){b=c.subtract(b,a);e=c.subtract(e,a);return c.add(c.multiply(b,c.dot(b,e)/c.dot(b,b)),a)},linePlaneIntersect:function(a,b,e,d){var f=-a[0]*b[0]-a[1]*b[1]-a[2]*b[2],b=a[0]*(d[0]-e[0])+a[1]*(d[1]-e[1])+a[2]*(d[2]-e[2]);if(0.0010>Math.abs(b))return!1;a=
-(f+a[0]*e[0]+a[1]*e[1]+a[2]*e[2])/b;return[e[0]+a*(d[0]-e[0]),e[1]+a*(d[1]-e[1]),e[2]+a*(d[2]-e[2])]}},g={lookat:function(a,b,e,d,f,m,o,s,g){var v=[],u=[],z=[],u=[];v[0]=d-a;v[1]=f-b;v[2]=m-e;z[0]=o;z[1]=s;z[2]=g;v=c.normalize(v);u=c.cross(v,z);u=c.normalize(u);z=c.cross(u,v);u=[u[0],z[0],-v[0],0,u[1],z[1],-v[1],0,u[2],z[2],-v[2],0,0,0,0,1];d=new h.Transform(u);d.translate([-a,-b,-e]);return d.getResult()},multiply:function(a,b,e){e===q&&(e=[]);e[0]=a[0]*b[0]+a[4]*b[1]+a[8]*b[2]+a[12]*b[3];e[1]=
a[1]*b[0]+a[5]*b[1]+a[9]*b[2]+a[13]*b[3];e[2]=a[2]*b[0]+a[6]*b[1]+a[10]*b[2]+a[14]*b[3];e[3]=a[3]*b[0]+a[7]*b[1]+a[11]*b[2]+a[15]*b[3];e[4]=a[0]*b[4]+a[4]*b[5]+a[8]*b[6]+a[12]*b[7];e[5]=a[1]*b[4]+a[5]*b[5]+a[9]*b[6]+a[13]*b[7];e[6]=a[2]*b[4]+a[6]*b[5]+a[10]*b[6]+a[14]*b[7];e[7]=a[3]*b[4]+a[7]*b[5]+a[11]*b[6]+a[15]*b[7];e[8]=a[0]*b[8]+a[4]*b[9]+a[8]*b[10]+a[12]*b[11];e[9]=a[1]*b[8]+a[5]*b[9]+a[9]*b[10]+a[13]*b[11];e[10]=a[2]*b[8]+a[6]*b[9]+a[10]*b[10]+a[14]*b[11];e[11]=a[3]*b[8]+a[7]*b[9]+a[11]*b[10]+
a[15]*b[11];e[12]=a[0]*b[12]+a[4]*b[13]+a[8]*b[14]+a[12]*b[15];e[13]=a[1]*b[12]+a[5]*b[13]+a[9]*b[14]+a[13]*b[15];e[14]=a[2]*b[12]+a[6]*b[13]+a[10]*b[14]+a[14]*b[15];e[15]=a[3]*b[12]+a[7]*b[13]+a[11]*b[14]+a[15]*b[15];return e},vec4_multiply:function(a,b,e){e===q&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12]*a[3];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13]*a[3];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14]*a[3];e[3]=b[3]*a[0]+b[7]*a[1]+b[11]*a[2]+b[15]*a[3];return e},vec3_multiply:function(a,b,e){e===
q&&(e=[]);e[0]=b[0]*a[0]+b[4]*a[1]+b[8]*a[2]+b[12];e[1]=b[1]*a[0]+b[5]*a[1]+b[9]*a[2]+b[13];e[2]=b[2]*a[0]+b[6]*a[1]+b[10]*a[2]+b[14];return e},perspective:function(a,b,e,d){a=Math.tan(a*Math.PI/360);return[1/(a*b),0,0,0,0,1/a,0,0,0,0,-(d+e)/(d-e),-1,0,0,-(2*d*e)/(d-e),0]},ortho:function(a,b,e,d,f,m){return[2/(b-a),0,0,0,0,2/(d-e),0,0,0,0,-2/(m-f),0,-(a+b)/(b-a),-(d+e)/(d-e),-(m+f)/(m-f),1]},determinant:function(a){return(a[0]*a[5]-a[1]*a[4])*(a[10]*a[15]-a[11]*a[14])-(a[0]*a[6]-a[2]*a[4])*(a[9]*
a[15]-a[11]*a[13])+(a[0]*a[7]-a[3]*a[4])*(a[9]*a[14]-a[10]*a[13])+(a[1]*a[6]-a[2]*a[5])*(a[8]*a[15]-a[11]*a[12])-(a[1]*a[7]-a[3]*a[5])*(a[8]*a[14]-a[10]*a[12])+(a[2]*a[7]-a[3]*a[6])*(a[8]*a[13]-a[9]*a[12])},coFactor:function(){},transpose:function(a){return[a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]]},inverse_mat3:function(a){var b=[],e=a[0],d=a[1],f=a[2],m=a[4],o=a[5],s=a[6],c=a[8],g=a[9],a=a[10],u=a*o-s*g,z=-a*m+s*c,q=g*m-o*c,n=e*u+d*z+f*q;if(!n)return null;
n=1/n;b[0]=u*n;b[1]=(-a*d+f*g)*n;b[2]=(s*d-f*o)*n;b[3]=z*n;b[4]=(a*e-f*c)*n;b[5]=(-s*e+f*m)*n;b[6]=q*n;b[7]=(-g*e+d*c)*n;b[8]=(o*e-d*m)*n;return b},inverse:function(a,b){var e=a[0]*a[5]-a[1]*a[4],d=a[0]*a[6]-a[2]*a[4],f=a[0]*a[7]-a[3]*a[4],m=a[1]*a[6]-a[2]*a[5],o=a[1]*a[7]-a[3]*a[5],s=a[2]*a[7]-a[3]*a[6],c=a[8]*a[13]-a[9]*a[12],g=a[8]*a[14]-a[10]*a[12],u=a[8]*a[15]-a[11]*a[12],z=a[9]*a[14]-a[10]*a[13],n=a[9]*a[15]-a[11]*a[13],h=a[10]*a[15]-a[11]*a[14],r=e*h-d*n+f*z+m*u-o*g+s*c;return 0!==r?(b===q&&
(b=[]),b[0]=0+a[5]*h-a[6]*n+a[7]*z,b[4]=0-a[4]*h+a[6]*u-a[7]*g,b[8]=0+a[4]*n-a[5]*u+a[7]*c,b[12]=0-a[4]*z+a[5]*g-a[6]*c,b[1]=0-a[1]*h+a[2]*n-a[3]*z,b[5]=0+a[0]*h-a[2]*u+a[3]*g,b[9]=0-a[0]*n+a[1]*u-a[3]*c,b[13]=0+a[0]*z-a[1]*g+a[2]*c,b[2]=0+a[13]*s-a[14]*o+a[15]*m,b[6]=0-a[12]*s+a[14]*f-a[15]*d,b[10]=0+a[12]*o-a[13]*f+a[15]*e,b[14]=0-a[12]*m+a[13]*d-a[14]*e,b[3]=0-a[9]*s+a[10]*o-a[11]*m,b[7]=0+a[8]*s-a[10]*f+a[11]*d,b[11]=0-a[8]*o+a[9]*f-a[11]*e,b[15]=0+a[8]*m-a[9]*d+a[10]*e,e=1/r,b[0]*=e,b[1]*=e,
b[2]*=e,b[3]*=e,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=e,b[9]*=e,b[10]*=e,b[11]*=e,b[12]*=e,b[13]*=e,b[14]*=e,b[15]*=e,b):null},identity:function(a){if(a==q)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1},translate:function(a,b,e,d){a=[1,0,0,0,0,1,0,0,0,0,1,0,a,b,e,1];if(d===q)return a;g.multiply(d.slice(0),a,d)},rotateAxis:function(a,b,e,d,f){var m=Math.sin(a*(Math.PI/180)),a=Math.cos(a*
(Math.PI/180)),b=[a+b*b*(1-a),b*e*(1-a)-d*m,b*d*(1-a)+e*m,0,e*b*(1-a)+d*m,a+e*e*(1-a),e*d*(1-a)-b*m,0,d*b*(1-a)-e*m,d*e*(1-a)+b*m,a+d*d*(1-a),0,0,0,0,1];if(f===q)return b;g.multiply(f.slice(0),b,f)},rotate:function(a,b,e,d){var f;d===q&&(d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);0!==e&&(f=Math.sin(e*(Math.PI/180)),e=Math.cos(e*(Math.PI/180)),g.multiply(d.slice(0),[e,f,0,0,-f,e,0,0,0,0,1,0,0,0,0,1],d));0!==b&&(f=Math.sin(b*(Math.PI/180)),e=Math.cos(b*(Math.PI/180)),g.multiply(d.slice(0),[e,0,-f,0,0,1,0,
0,f,0,e,0,0,0,0,1],d));0!==a&&(f=Math.sin(a*(Math.PI/180)),e=Math.cos(a*(Math.PI/180)),g.multiply(d.slice(0),[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1],d));return d},scale:function(a,b,e,d){if(d===q)return[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1];g.multiply(d.slice(0),[a,0,0,0,0,b,0,0,0,0,e,0,0,0,0,1],d)},transform:function(a,b,e){var d=g.identity();a&&g.translate(a[0],a[1],a[2],d);b&&(0===b[0]&&0===b[1]&&0===b[2]||g.rotate(b[0],b[1],b[2],d));e&&(1===e[0]&&1===e[1]&&1===e[2]||g.scale(e[0],e[1],e[2],d));return d}};
y.prototype={setIdentity:function(){this.m_stack[this.c_stack]=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},getIdentity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},invalidate:function(){this.valid=0;this.result=null;return this},getResult:function(){var a=h.mat4;if(!this.c_stack)return this.m_stack[0];var b=n;this.valid>this.c_stack-1&&(this.valid=this.c_stack-1);for(var e=this.valid;e<this.c_stack+1;e++)b=a.multiply(b,this.m_stack[e]),
this.m_cache[e]=b;this.valid=this.c_stack-1;return this.result=this.m_cache[this.c_stack]},pushMatrix:function(a){this.c_stack++;this.m_stack[this.c_stack]=a?a:n;return this},popMatrix:function(){if(0!==this.c_stack)return this.c_stack--,this},clearStack:function(a){this.m_stack=[];this.m_cache=[];this.valid=this.c_stack=0;this.result=null;a!==q?this.m_stack[0]=a:this.setIdentity();return this},translate:function(a,b,e){var d=h.mat4;if("object"===typeof a)return this.translate(a[0],a[1],a[2]);var f=
this.getIdentity();f[12]=a;f[13]=b;f[14]=e;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},scale:function(a,b,e){var d=h.mat4;if("object"===typeof a)return this.scale(a[0],a[1],a[2]);var f=this.getIdentity();f[0]=a;f[5]=b;f[10]=e;this.m_stack[this.c_stack]=d.multiply(this.m_stack[this.c_stack],f);this.valid===this.c_stack&&this.c_stack&&this.valid--;return this},rotate:function(a,b,e,d){var f=h.mat4;if("object"===
typeof a)return this.rotate(a[0],1,0,0),this.rotate(a[1],0,1,0),this.rotate(a[2],0,0,1),this;var m,o;if(b||e||d)m=Math.sin(-a*(Math.PI/180)),o=Math.cos(-a*(Math.PI/180));b&&(a=this.getIdentity(),a[5]=o*b,a[9]=m*b,a[6]=-m*b,a[10]=o*b,this.m_stack[this.c_stack]=f.multiply(a,this.m_stack[this.c_stack]));e&&(b=this.getIdentity(),b[0]=o*e,b[8]=-m*e,b[2]=m*e,b[10]=o*e,this.m_stack[this.c_stack]=f.multiply(b,this.m_stack[this.c_stack]));d&&(e=this.getIdentity(),e[0]=o*d,e[4]=m*d,e[1]=-m*d,e[5]=o*d,this.m_stack[this.c_stack]=
f.multiply(e,this.m_stack[this.c_stack]));this.valid===this.c_stack&&this.c_stack&&this.valid--;return this}};w.prototype={length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var a=Math.sqrt(this.length());this.x/=a;this.y/=a;this.z/=a;this.w/=a},fromMatrix:function(a){var b=1+a[0]+a[5]+a[10],e,d,f;1.0E-8<b?(e=2*Math.sqrt(b),b=(a[9]-a[6])/e,d=(a[2]-a[8])/e,f=(a[4]-a[1])/e,a=0.25*e):a[0]>a[5]&&a[0]>a[10]?(e=2*Math.sqrt(1+a[0]-a[5]-a[10]),
b=0.25*e,d=(a[4]+a[1])/e,f=(a[2]+a[8])/e,a=(a[9]-a[6])/e):a[5]>a[10]?(e=2*Math.sqrt(1+a[5]-a[0]-a[10]),b=(a[4]+a[1])/e,d=0.25*e,f=(a[9]+a[6])/e,a=(a[2]-a[8])/e):(e=2*Math.sqrt(1+a[10]-a[0]-a[5]),b=(a[2]+a[8])/e,d=(a[9]+a[6])/e,f=0.25*e,a=(a[4]-a[1])/e);this.x=b;this.y=d;this.z=f;this.w=a},fromEuler:function(a,b,e){var d=Math.cos(Math.PI/180*b/2),b=Math.sin(Math.PI/180*b/2),f=Math.cos(Math.PI/180*e/2),e=Math.sin(Math.PI/180*e/2),m=Math.cos(Math.PI/180*a/2),a=Math.sin(Math.PI/180*a/2),o=d*f,s=b*e;this.w=
o*m-s*a;this.x=o*a+s*m;this.y=b*f*m+d*e*a;this.z=d*e*m-b*f*a},toEuler:function(){var a=this.w*this.w,b=this.x*this.x,e=this.y*this.y,d=this.z*this.z,f=180/Math.PI*Math.atan2(2*(this.y*this.z+this.x*this.w),-b-e+d+a),m=180/Math.PI*Math.asin(-2*(this.x*this.z-this.y*this.w)),a=180/Math.PI*Math.atan2(2*(this.x*this.y+this.z*this.w),b-e-d+a);return[f,m,a]},multiply:function(a,b){b===q&&(b=a,a=this);return new w(a.x*b.w+a.w*b.x+a.y*b.z-a.z*b.y,a.y*b.w+a.w*b.y+a.z*b.x-a.x*b.z,a.z*b.w+a.w*b.z+a.x*b.y-a.y*
b.x,a.w*b.w-a.x*b.x-a.y*b.y-a.z*b.z)}};return{vec2:{equal:function(a,b,e){e===q&&(e=1.0E-8);return a===q&&b===q?!0:a===q||b===q?!1:Math.abs(a[0]-b[0])<e&&Math.abs(a[1]-b[1])<e},onLine:function(a,b,e){var d=a[1]<b[1]?a[1]:b[1],f=a[0]>b[0]?a[0]:b[0],m=a[1]>b[1]?a[1]:b[1];return(a[0]<b[0]?a[0]:b[0])<=e[0]&&e[0]<=f&&d<=e[1]&&e[1]<=m?!0:!1},lineIntersect:function(a,b,e,d){var f=a[0],a=a[1],m=b[0],b=b[1],o=e[0],e=e[1],s=d[0],d=d[1],c=(f-m)*(e-d)-(a-b)*(o-s);return 0===c?!1:[((o-s)*(f*b-a*m)-(f-m)*(o*d-
e*s))/c,((e-d)*(f*b-a*m)-(a-b)*(o*d-e*s))/c]},add:function(a,b){return[a[0]+b[0],a[1]+b[1]]},subtract:function(a,b){return[a[0]-b[0],a[1]-b[1]]},length:function(a,b){if(b===q)return Math.sqrt(a[0]*a[0]+a[1]*a[1]);var e=[a[0]-b[0],a[1]-b[1]];return Math.sqrt(e[0]*e[0]+e[1]*e[1])}},vec3:c,mat3:{transpose_inline:function(a){var b=a[1],e=a[2],d=a[5];a[1]=a[3];a[2]=a[6];a[3]=b;a[5]=a[7];a[6]=e;a[7]=d},vec3_multiply:function(a,b,e){e===q&&(e=[]);e[0]=b[0]*a[0]+b[3]*a[1]+b[6]*a[2];e[1]=b[1]*a[0]+b[4]*a[1]+
b[7]*a[2];e[2]=b[2]*a[0]+b[5]*a[1]+b[8]*a[2];return e}},mat4:g,aabb:{engulf:function(a,b){a[0][0]>b[0]&&(a[0][0]=b[0]);a[0][1]>b[1]&&(a[0][1]=b[1]);a[0][2]>b[2]&&(a[0][2]=b[2]);a[1][0]<b[0]&&(a[1][0]=b[0]);a[1][1]<b[1]&&(a[1][1]=b[1]);a[1][2]<b[2]&&(a[1][2]=b[2])},reset:function(a,b){void 0===b&&(b=[0,0,0]);a[0][0]=b[0];a[0][1]=b[1];a[0][2]=b[2];a[1][0]=b[0];a[1][1]=b[1];a[1][2]=b[2]},size:function(a){return[a[0][0]<a[1][0]?a[1][0]-a[0][0]:a[0][0]-a[1][0],a[0][1]<a[1][1]?a[1][1]-a[0][1]:a[0][1]-a[1][1],
a[0][2]<a[1][2]?a[1][2]-a[0][2]:a[0][2]-a[1][2]]}},plane:{classifyPoint:function(a,b){var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3];return 0>e?-1:0<e?1:0},normalize:function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);a[0]/=b;a[1]/=b;a[2]/=b;a[3]/=b}},sphere:{intersects:function(a,b){var e=h.vec3.subtract([a[0],a[1],a[2]],[b[0],b[1],b[2]]),e=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),d=a[3]+b[3];return e*e<d*d?!0:!1}},triangle:{normal:function(a,b,e,d){d===q&&(d=[]);var f=a[0]-b[0],m=a[1]-b[1],a=a[2]-
b[2],o=b[0]-e[0],s=b[1]-e[1],b=b[2]-e[2];d[0]=m*b-a*s;d[1]=a*o-f*b;d[2]=f*s-m*o;return d}},Transform:y,Quaternion:w}});
CubicVR.RegisterModule("Utility",function(h){var y=h.undef,w=h.log,q={},n={},r={multiSplit:function(c,g){for(var a=c.split(g[0]),b=1,e=g.length;b<e;b++)for(var d=g[b],f=0,m=a.length;f<m;f++){var o=a[f].trim().split(d),s=!0;if(1<o.length)for(var D=0;D<o.length;D++)""!==o[D].trim()&&(a.splice(f+D,0===D?1:0,o[D]),D&&m++,s=!1);else a[f]=a[f].trim().replace(d,""),""!==a[f]&&(s=!1);s&&(a.splice(f,1),m--,f--)}return a},getJSONScriptObj:function(c,g){if("string"===typeof c&&0<c.length&&"#"===c.charAt(0)){var a=
document.getElementById(c.substr(1));if(a)return a=JSON.parse(a.innerHTML||a.text),g&&g(a),a}return c},getScriptContents:function(c){var g=document.getElementById(c),a="",b="";if(g){if(""!==g.src||g.attributes.srcUrl!==y)b=""!==g.src?g.src:g.attributes.srcUrl.value}else b=c;if(0!==b.length){if(c=new XMLHttpRequest,c.overrideMimeType&&c.overrideMimeType("application/json"),c.open("GET",b,!1),c.send(null),200===c.status||0===c.status)a=c.responseText}else for(b=g.firstChild;b;)3===b.nodeType&&(a+=b.textContent),
b=b.nextSibling;return a},xmlNeedsBadgerFish:function(c){for(c=[c];c.length;){var g=c.pop();if(g.attributes&&g.attributes.length)return!0;for(var a=0,b=g.childNodes.length;a<b;a++)c.push(g.childNodes[a])}return!1},getFirstEntry:function(c){for(var g in c)if(c.hasOwnProperty(g))return c[g]},getURIFileType:function(c){function g(a){for(var b in e)if(e.hasOwnProperty(b)&&-1!==e[b].indexOf(a))return b;return y}var a=c.toLowerCase(),b=["_ext","ext"],e={json:["js","javascript","json"],xml:["xml"]};if(-1!==
a.indexOf("?")){var d=a.split("?"),a=d[0];if(d[1])for(var d=-1===d[1].indexOf("&")?[d[1]]:d[1].split("&"),f=0,m=d.length;f<m;f++){var o=d[f];if(-1!==o.indexOf("=")&&(o=o.split("="),-1!==b.indexOf(o[0]))){var s=g(o[1]);if(s)return s;w("Unable to determine extension type '"+o[1]+"' provided for URI: ["+c+"], falling back to filename part.")}}}return-1!==a.indexOf(".")?(c=a.split("."),g(c[c.length-1])):y},get:function(c,g){var a=null,b=null,e=null,g=g||null;if(c===y)return y;if(isFinite(c))return c;
"function"===typeof c&&(c=c(g));if("object"===typeof c)return g&&!(c instanceof g)?new g(c):c;if("string"==typeof c){if(-1!==c.indexOf("\n"))return c;"#"==c[0]&&(a=c.substr(1),(e=document.getElementById(a))&&(b=e.src||null));!e&&(!a&&!b&&c)&&(b=c)}if(e&&!b)return CubicVR.util.collectTextNode(e);if(b){var a=null,d=n[b]||null;if(!d){var f=r.getURIFileType(b);if(f===y&&!e)return b;"json"===f?d=CubicVR.util.getJSON(b):a="xml"===f?CubicVR.util.getXML(b):CubicVR.util.getURL(b);a&&a.childNodes?d=r.getFirstEntry(r.xml2json(a)):
a&&(d=a)}d&&n[b]===y&&(n[b]=d);if(g){if(q[b]&&q[b]instanceof g)return q[b];if(d)return q[b]=new g(d),q[b]}else if(d)return d;return b}a&&!e&&console.log("Unable to retrieve requested ID: '"+c+"'");return y},clearCache:function(){q={};n={}},getURL:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.send(null);if(200===g.status||0===g.status){if(g.responseText.length)return g.responseText;if(g.responseXML)return g.responseXML}}catch(a){alert(c+" failed to load.")}return null},getXML:function(c){try{var g=
new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/xml");g.send(null);if(200===g.status||0===g.status)return g.responseXML}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;}}return null},getJSON:function(c){try{var g=new XMLHttpRequest;g.open("GET",c,!1);g.overrideMimeType("application/json");g.send(null);if(200===g.status||0===g.status)return eval("("+g.responseText+")")}catch(a){try{alert(c+" failed to load.")}catch(b){throw a;}}return null},repackArray:function(c,g,
a){c.length!==parseInt(g,10)*parseInt(a,10)&&w("array repack error, data size !== stride*count: data.length="+c.length+" stride="+g+" count="+a);for(var a=[],b=0,e=0,d=c.length;e<d;e++){var f=e%g;0===f&&(a[b]=[]);a[b][f]=c[e];f===g-1&&b++}return a},collectTextNode:function(c){if(!c)return"";for(var g="",c=c.childNodes,a=0,b=c.length;a<b;a++)g+=c[a].nodeValue;return g},floatDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=c.split(g?g:","),b=0,e=a.length;b<
e;b++)a[b]=parseFloat(a[b]);a[a.length-1]!==a[a.length-1]&&a.pop();return a},intDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=parseInt(a[b],10);a[a.length-1]!==a[a.length-1]&&a.pop();return a},textDelimArray:function(c,g){"\n"!=g&&(c=c.replace(/\n/g," ").replace(/^\s+|\s+$/,""));for(var a=c.split(g?g:","),b=0,e=a.length;b<e;b++)a[b]=a[b];return a},xmlstring2json:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,
"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],d={},f=d,m=0,o=c.length;m<o;m++){var s=c[m];if(!(g.test(s)||""===s)&&!/<\?\s?xml[^>]*>/.test(s))if(/<.*?>/.test(s)){a=s.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]&&(s=a.split(" "),a=s[0],s=s.slice(1).join(" "),b.push(a),e.push(d),d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:(d[a]||(d[a]={}),d=d[a]),d instanceof Array&&(d.push({}),d=d[d.length-1]),"/"===a.substr(a.length-1)||"/"===s.substr(s.length-1)))a="/"+a;if("/"===a[0]){a=
a.substr(1);if(b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+a),!1;b.pop();d=e.length?e[e.length-1]:null;e.pop()}}else{var D=e[e.length-1][a];D instanceof Array?(D.pop(),D.push(r.parseNumeric(s))):e[e.length-1][a]=r.parseNumeric(s)}}return f},xmlstring2badgerfish:function(c){for(var c=c.replace(/<\!--.*?--\>/gm,"").replace(/\n/g," ").split(/(<[^>]*>)([^<]*)/gm),g=/^\s+$/gm,a,b=[],e=[],d={},f=d,m=0,o=c.length;m<o;m++)if(a=c[m],!(g.test(a)||""===a)&&!/<\?\s?xml[^>]*>/.test(a))if(/<.*?>/.test(a)){a=
a.split(/<([^>]*?)(.*)?>/g)[2];if("/"!==a[0]){var s=a.split(" ");a=s[0];s=s.slice(1).join(" ");b.push(a);e.push(d);d[a]&&!(d[a]instanceof Array)?d[a]=[d[a]]:d[a]||(d[a]={});d=d[a];d instanceof Array&&(d.push({}),d=d[d.length-1]);if("/"===a.substr(a.length-1)||"/"===s.substr(s.length-1))a="/"+a;for(var s=r.multiSplit(s,"= "),D="",v=0;v<s.length;v++){var u=s[v];"/"===u[u.length-1]&&(u=u.substr(0,u.length-1));if(1===v%2){if("'"===u[0]||'"'===u[0]){for(var z=u[0],u=u.substr(1);u[u.length-1]!==z&&s.length+
1<v;)u+=s.splice(v+1,1);u[u.length-1]===z&&(u=u.substr(0,u.length-1))}d["@"+D]=u}else D=u}}if("/"===a[0]){a=a.substr(1);if(b.length&&b[b.length-1]!==a)return console.log("Unmatched tag, aborting: "+b[b.length-1]),!1;b.pop();d=e.length?e[e.length-1]:null;e.pop()}}else d.$=a;return f},xml2badgerfish:function(c){var g={},a=[],b,e,d,f,m,o=/^\s+|\s+$/g;c.jsonParent=g;for(a.push(c);a.length;){e=a.pop();var s=null;d=e.jsonParent;c=0;for(b=e.childNodes.length;c<b;c++)f=e.childNodes[c],m=f.tagName,m!==y&&
(s=s||{},s[m]=s[m]||0,s[m]++);if(e.attributes&&e.attributes.length){c=0;for(b=e.attributes.length;c<b;c++)f=e.attributes[c],d["@"+f.name]=f.value}c=0;for(b=e.childNodes.length;c<b;c++)f=e.childNodes[c],m=f.tagName,1===f.nodeType?(1<s[m]?(d[m]=d[m]||[],d[m].push({}),f.jsonParent=d[m][d[m].length-1]):(d[m]=d[m]||{},f.jsonParent=d[m]),a.push(f)):3===f.nodeType&&""!==f.nodeValue.replace(o,"")&&(d.$=d.$||"",d.$+=f.nodeValue)}return g},isTextNode:function(c){for(var c=c.childNodes,g=0,a=c.length;g<a;g++)if(3!==
c[g].nodeType||c[g].childNodes.length)return!1;return!0},parseNumeric:function(c){var g=null,a,g=c.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\n/g," ").replace(/ *, */gm,",").replace(/\s+/g," ");if(""===g)return g;if((-1!==g.indexOf(" ")||-1!==g.indexOf(","))&&/[0-9\.,e\-\+ ]+/g.test(g))if(/[^0-9\-\+]+/g.test(g))if(/[^0-9\- ]+/g.test(g))if(/[^0-9\-,]+/g.test(g))if(/[^0-9\.e\-\+ ]+/g.test(g))if(/[^0-9\.,e\+\-]+/g.test(g))if(/[^0-9,\-\+ ]+/g.test(g)){if(!/[^0-9\.,e\-\+ ]+/g.test(g)){g=g.split(" ");
c=0;for(a=g.length;c<a;c++)g[c]=r.floatDelimArray(g[c],",");return g}}else{g=g.split(" ");c=0;for(a=g.length;c<a;c++)g[c]=r.intDelimArray(g[c],",");return g}else return r.floatDelimArray(g,",");else return r.floatDelimArray(g," ");else return r.intDelimArray(g,",");else return r.intDelimArray(g," ");else return parseInt(g,10);a=parseFloat(g);return!isNaN(a)?/[^0-9\-\+]+/g.test(g)?a:parseInt(g,10):c},xml2json:function(c){var g={},a=[],b,e,d,f,m;c.jsonParent=g;for(a.push(c);a.length;){e=a.pop();var o=
null;d=e.jsonParent;c=0;for(b=e.childNodes.length;c<b;c++)f=e.childNodes[c],m=f.tagName,m!==y&&(o=o||{},o[m]=o[m]||0,o[m]++);c=0;for(b=e.childNodes.length;c<b;c++){f=e.childNodes[c];m=f.tagName;var s=r.isTextNode(f);1===f.nodeType&&(1<o[m]?(d[m]=d[m]||[],s?d[m].push(r.parseNumeric(r.collectTextNode(f))):(d[m].push({}),f.jsonParent=d[m][d[m].length-1])):s?d[m]=r.parseNumeric(r.collectTextNode(f)):(d[m]=d[m]||{},f.jsonParent=d[m]),s||a.push(f))}}return g}};return{util:r,get:r.get,clearCache:r.clearCache}});
CubicVR.RegisterModule("Shader",function(h){function y(d,f){var m=h.util,o,e,g,v,u=n.gl;this.uniforms=[];this.uniform_type=[];this.uniform_typelist=[];this.success=!0;this.fragmentLog=this.vertexLog="";-1!==d.indexOf("\n")?(g=d,o=a(n.gl,d,"x-shader/x-vertex")):(o=b(n.gl,d),null===o&&(g=m.getURL(d),o=a(n.gl,g,"x-shader/x-vertex")));u.getShaderParameter(o,u.COMPILE_STATUS)||(this.vertexLog=u.getShaderInfoLog(o),this.success=!1);-1!==f.indexOf("\n")?(v=f,e=a(n.gl,f,"x-shader/x-fragment")):(e=b(n.gl,
f),null===e&&(v=m.getURL(f),e=a(n.gl,v,"x-shader/x-fragment")));u.getShaderParameter(e,u.COMPILE_STATUS)||(this.fragmentLog=u.getShaderInfoLog(e),this.success=!1);this.success?(this.shader=u.createProgram(),u.attachShader(this.shader,o),u.attachShader(this.shader,e),u.linkProgram(this.shader),n.gl.getProgramParameter(this.shader,u.LINK_STATUS)||(c("Error linking shader:\n"+u.getProgramInfoLog(this.shader)),this.success=!1)):(o=m.multiSplit(this.vertexLog,";\n"),m=m.multiSplit(this.fragmentLog,";\n"),
o.length&&this.dumpErrors(o,g),m.length&&this.dumpErrors(m,v))}function w(a){this._update=a.update||null;this._init=a.init||null;this._vertex=h.get(a.vertex)||null;this._fragment=h.get(a.fragment)||null;this._bindings=[];this._shaderVars=this._shaderInfo=this._shader=null;this._initialized=!1;a=(this._vertex||"")+(this._fragment||"");this._hasDepthPack=""!==a.trim()?/\s\!?LIGHT_DEPTH_PASS\s/.test(a):!1}var q=h.undef,n=h.GLCore,r=h.enums,c=h.log,g=h.util;r.shader={map:{COLOR:1,SPECULAR:2,NORMAL:4,
BUMP:8,REFLECT:16,ENVSPHERE:32,AMBIENT:64,ALPHA:128,COLORMAP:256},uniform:{MATRIX:0,VECTOR:1,FLOAT:2,ARRAY_VERTEX:3,ARRAY_UV:4,ARRAY_FLOAT:5,INT:6}};var a=function(a,b,m){if("x-shader/x-fragment"===m)m=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===m)m=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(m,b);a.compileShader(m);return m},b=function(a,b){var m=document.getElementById(b);if(!m)return null;for(var o="",e=m.firstChild;e;)3===e.nodeType&&(o+=e.textContent),
e=e.nextSibling;if("x-shader/x-fragment"===m.type)m=a.createShader(a.FRAGMENT_SHADER);else if("x-shader/x-vertex"===m.type)m=a.createShader(a.VERTEX_SHADER);else return null;a.shaderSource(m,o);a.compileShader(m);return m};y.prototype={isCompiled:function(){return this.success},dumpErrors:function(a,b,m){for(var m=(m||"Error on line")+" ",b=b.split("\n"),o=0,e=a.length;o<e;o++){var c=a[o];if(0===c.indexOf("ERROR: ")){var c=c.substr(7).trim(),g=c.substr(0,c.indexOf(" ")),c=c.substr(g.length),g=g.split(":"),
g=parseInt(g[1],10);console.log(g+"> "+b[g-1]);console.log(m+g+", :"+c)}}},bindSelf:function(a){var b,m,o;-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),o=b[0],b=b[1].split("]"),m=b[0],b=b[1].split("."),b=b[1],this[o]===q&&(this[o]=[]),this[o][m]===q&&(this[o][m]={}),this[o][m][b]=this.uniforms[a]):(b=a.split("."),o=b[0],b=b[1],this[o]===q&&(this[o]={}),this[o][b]=this.uniforms[a]):-1!==a.indexOf("[")?(b=a.split("["),o=b[0],b=b[1].split("]"),m=b[0],this[o]===q&&(this[o]=[]),this[o][m]=this.uniforms[a]):
this[a]=this.uniforms[a]},addMatrix:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.MATRIX;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setMatrix(a,b);this.bindSelf(a);return this.uniforms[a]},addVector:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.VECTOR;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
b!==q&&this.setVector(a,b);this.bindSelf(a);return this.uniforms[a]},addFloat:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setFloat(a,b);this.bindSelf(a);return this.uniforms[a]},addVertexArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_VERTEX;this.uniform_typelist.push([this.uniforms[a],
this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addUVArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_UV;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);this.bindSelf(a);return this.uniforms[a]},addFloatArray:function(a){this.use();this.uniforms[a]=n.gl.getAttribLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.ARRAY_FLOAT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);
this.bindSelf(a);return this.uniforms[a]},addInt:function(a,b){this.use();this.uniforms[a]=n.gl.getUniformLocation(this.shader,a);this.uniform_type[a]=r.shader.uniform.INT;this.uniform_typelist.push([this.uniforms[a],this.uniform_type[a]]);b!==q&&this.setInt(a,b);this.bindSelf(a);return this.uniforms[a]},use:function(){n.gl.useProgram(this.shader)},setMatrix:function(a,b){var m=this.uniforms[a];if(null!==m){var o=b.length;16===o?n.gl.uniformMatrix4fv(m,!1,b):9===o?n.gl.uniformMatrix3fv(m,!1,b):4===
o&&n.gl.uniformMatrix2fv(m,!1,b)}},setInt:function(a,b){var m=this.uniforms[a];null!==m&&n.gl.uniform1i(m,b)},setFloat:function(a,b){var m=this.uniforms[a];null!==m&&n.gl.uniform1f(m,b)},setVector:function(a,b){var m=this.uniforms[a];if(null!==m){var o=b.length;3==o?n.gl.uniform3fv(m,b):2==o?n.gl.uniform2fv(m,b):n.gl.uniform4fv(m,b)}},clearArray:function(a){var b=n.gl,a=this.uniforms[a];null!==a&&b.disableVertexAttribArray(a)},bindArray:function(a,b){var m=n.gl,o=this.uniforms[a];if(null!==o){var e=
this.uniform_type[a];e===r.shader.uniform.ARRAY_VERTEX?(m.bindBuffer(m.ARRAY_BUFFER,b),m.vertexAttribPointer(o,3,m.FLOAT,!1,0,0),m.enableVertexAttribArray(o)):e===r.shader.uniform.ARRAY_UV?(m.bindBuffer(m.ARRAY_BUFFER,b),m.vertexAttribPointer(o,2,m.FLOAT,!1,0,0)):e===r.shader.uniform.ARRAY_FLOAT&&(m.bindBuffer(m.ARRAY_BUFFER,b),m.vertexAttribPointer(o,1,m.FLOAT,!1,0,0))}}};var e={tidyScript:function(a){return a.replace(/\t+/g," ").replace(/\/\/.*$/gm,"").replace(/\/\*(.|\n)*\*\//g,"").replace(/ +/g,
" ").replace(/ *\[ */g,"[").replace(/ *\] */g,"]").replace(/ *; */g,";").replace(/ *$/gm,"").replace(/^ */gm,"")},getDefines:function(a){var b={},a=g.multiSplit(a,"\n;");i=0;for(iMax=a.length;i<iMax;i++){var e=a[i];0===e.indexOf("#define")&&(e=e.split(" "),2<e.length&&(b[e[1]]=e.slice(2).join(" ")))}return b},replaceAll:function(a,b,e,o){var e=e||"",o=o||"",s;for(s in b)if(b.hasOwnProperty(s))for(var c=e+s+o;-1!==a.indexOf(c);)a=a.replace(c,e+b[s]+o);return a},getShaderInfo:function(a,b){var m,o,
s,c,v,u,z=["uniform","attribute","varying"],n=[],h={};u={};var r;b===q&&(b="");a=e.tidyScript(a);b=e.tidyScript(b);h.v_define=e.getDefines(a);h.f_define=e.getDefines(b);a=e.replaceAll(a,h.v_define,"[","]");b=e.replaceAll(b,h.f_define,"[","]");r=g.multiSplit(a+"\n"+b,"\n;");var t=[];c=s=-1;m=0;for(o=r.length;m<o;m++)v=r[m],-1===s&&0===v.indexOf("struct")?s=m:-1===c&&(-1!==s&&-1!==v.indexOf("}"))&&(c=m+1),-1!==s&&-1!==c&&(v=r.slice(s,c).join("\n").replace(/(\{|\})/g,"\n").replace(/ +$/gm,"").replace(/^ +/gm,
"").replace(/\n\n/gm,"\n"),t.push({start:s,end:c,struct:v.split("\n")}),c=s=-1);m=0;for(o=t.length;m<o;m++){var x=t[m].struct,w=null;s=0;for(c=x.length;s<c;s++)v=x[s].split(" "),1>=v.length||("struct"==v[0]?(w=v[1],u[w]={}):w&&(u[w][v[1]]=v[0]))}h.struct=u;m=0;for(o=z.length;m<o;m++)h[z[m]]=[];m=0;for(o=r.length;m<o;m++){v=r[m];s=0;for(c=z.length;s<c;s++)if(t=z[s],0===v.indexOf(t)&&(u=v.split(" "),3===u.length&&u[0]==t&&-1===n.indexOf(u[2])))if(n.push(u[2]),-1!==u[2].indexOf("[")){var x=u[2].split("["),
w=x[1].replace("]",""),A=parseInt(w,10);A===A&&(w=A);h[t].push({name:x[0],type:u[1],isArray:!0,len:w})}else h[t].push({name:u[2],type:u[1]})}return h},genShaderVarList:function(a,b){var e=a[b],o=[],s,c,g,u,z,n;if(!e)return[];s=0;for(c=e.length;s<c;s++){var q=e[s];if(a.struct[q.type]){var h=a.struct[q.type];if(h&&q.isArray){g=0;for(u=q.len;g<u;g++)for(n in z=q.name+"["+g+"]",h)h.hasOwnProperty(n)&&o.push({location:z+"."+n,type:h[n],basename:q.name})}else for(n in h)o.push({location:q.name+"."+n,type:h[n],
basename:q.name})}else if(q.isArray){g=0;for(u=q.len;g<u;g++)z=q.name+"["+g+"]",o.push({location:z,type:q.type,basename:q.name})}else o.push({location:q.name,type:q.type,basename:q.name})}return o},getShaderVars:function(a){var b={};b.uniform=e.genShaderVarList(a,"uniform");b.attribute=e.genShaderVarList(a,"attribute");return b}};w.prototype={use:function(){this._initialized&&this._shader.use()},getShader:function(){return this._shader},ready:function(){return this._initialized},isReady:function(){return this._initialized},
hasDepthPack:function(){return this._hasDepthPack},_init_shader:function(a,b,m,o,s){m=m||[];a=h.util.get(a);b=h.util.get(b);s=s||"#define customShader_splice";if(o=o===q?this._vertex||this._fragment:o)o=a.indexOf(s),s=b.indexOf(s),-1!==o&&this._vertex&&(a=a.substr(0,o)+this._vertex),-1!==s&&this._fragment&&(b=b.substr(0,s)+this._fragment);this._shader=new h.Shader(a,b);this._shaderInfo=e.getShaderInfo(a,b);this._shaderVars=e.getShaderVars(this._shaderInfo);this._appendShaderVars(this._shaderVars,
"uniform",m);this._appendShaderVars(this._shaderVars,"attribute",m);(this._initialized=this._shader.isCompiled())&&this._init&&this._init(this)},_appendShaderVars:function(a,b,e){for(var a=function(a,b){return function(f,d){d!==q&&(u.activeTexture(u.TEXTURE0+f),u.bindTexture(n.gl.TEXTURE_2D,h.Textures[d.tex_id]));b.value=f;a.update(b)}},o=0,s=this._shaderVars[b].length;o<s;o++){var c=this._shaderVars[b][o],g=c.location;if(-1===e.indexOf(c.basename)&&(c=c.type,"vec3"===c?"attribute"===b?this._shader.addVertexArray(g):
this._shader.addVector(g):"vec2"===c?"attribute"===b?this._shader.addUVArray(g):this._shader.addVector(g):"float"===c?"attribute"===b?this._shader.addFloatArray(g):this._shader.addFloat(g):"sampler2D"===c||"int"===c?this._shader.addInt(g):("mat4"===c||"mat3"===c||"mat2"===c)&&this._shader.addMatrix(g),g=this._bindSelf(g),"sampler2D"==c&&g)){var u=n.gl;g.set=a(this,g)}}},_bindSelf:function(a){var b,e,o,s;if(null!==this._shader.uniforms[a]){var c=function(a,b){return function(f){b.value=f;a.update(b)}};
-1!==a.indexOf(".")?-1!==a.indexOf("[")?(b=a.split("["),o=b[0],b=b[1].split("]"),e=b[0],b=b[1].split("."),b=b[1],this[o]===q&&(this[o]=[]),this[o][e]===q&&(this[o][e]={}),s={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][e][b]=s):(b=a.split("."),o=b[0],b=b[1],this[o]===q&&(this[o]={}),s={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][b]=s):-1!==a.indexOf("[")?(b=a.split("["),o=b[0],b=b[1].split("]"),e=b[0],this[o]===
q&&(this[o]=[]),s={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[o][e]=s):(s={location:this._shader.uniforms[a],value:null,type:this._shader.uniform_type[a]},this[a]=s);this._bindings.push(s);s&&(s.set=c(this,s));return s}},_doUpdate:function(a){if(this._initialized)if(this._update)this._update(this,a);else for(var b=0,e=this._bindings.length;b<e;b++)this.update(this._bindings[b],a)},update:function(a){if(this._initialized){var b=n.gl,e=a.value,o=a.location;
null!==o&&(a.type===r.shader.uniform.MATRIX?(a=e.length,16===a?b.uniformMatrix4fv(o,!1,e):9===a?b.uniformMatrix3fv(o,!1,e):4===a&&b.uniformMatrix2fv(o,!1,e)):a.type===r.shader.uniform.INT?b.uniform1i(o,e):a.type===r.shader.uniform.VECTOR?(a=e.length,3===a?b.uniform3fv(o,e):2===a?b.uniform2fv(o,e):b.uniform4fv(o,e)):a.type===r.shader.uniform.FLOAT?b.uniform1f(o,e):a.type===r.shader.uniform.ARRAY_VERTEX?(b.bindBuffer(b.ARRAY_BUFFER,e),b.vertexAttribPointer(o,3,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o)):
a.type===r.shader.uniform.ARRAY_UV?(b.bindBuffer(b.ARRAY_BUFFER,e),b.vertexAttribPointer(o,2,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o)):a.type===r.shader.uniform.ARRAY_FLOAT&&(b.bindBuffer(b.ARRAY_BUFFER,e),b.vertexAttribPointer(o,1,b.FLOAT,!1,0,0),b.enableVertexAttribArray(o)))}}};return{Shader:y,shader_util:e,CustomShader:w}});
CubicVR.RegisterModule("MainLoop",function(h){function y(){this.paused_state=this.offset=this.paused_time=this.last_update=this.end_time=this.start_time=this.system_milliseconds=this.time_elapsed=0}function w(){null!==h.GLCore.mainloop&&(window.requestAnimationFrame&&window.requestAnimationFrame(w),h.GLCore.mainloop.interval())}function q(a,b,e){window.requestAnimationFrame===r&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||
window.msRequestAnimationFrame||null);null!==h.GLCore.mainloop&&(!window.requestAnimationFrame&&h.GLCore.mainloop&&clearInterval(h.GLCore.mainloop.interval),h.GLCore.mainloop=null);if(null===a)h.GLCore.mainloop=null;else{this.renderList=[];var d=this.renderStack=[{scenes:[],update:function(){},start:function(){},stop:function(){}}],f=new y;f.start();this.timer=f;this.func=a;this.doclear=b!==r?b:!0;h.GLCore.mainloop=this;g.resizeList.length&&!h.GLCore.resize_active&&(window.addEventListener("resize",
function(){h.GLCore.onResize()},!1),h.GLCore.resize_active=!0);b=function(){return function(){var b=h.GLCore.gl;f.update();h.GLCore.mainloop.doclear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);a(f,h.GLCore.gl);var o=d[d.length-1],e=o.scenes;o.update&&o.update(f,b);if(e){b=0;for(o=e.length;b<o;++b){var c=e[b];if(!c.paused){c.update&&c.update(f,h.GLCore.gl);c.render()}}}}}();e?this.loopFunc=b:window.requestAnimationFrame?(this.interval=b,window.requestAnimationFrame(w)):this.interval=setInterval(b,
20)}}function n(a,b,e){this.canvas=a;this.camera=b;this.mpos=[0,0];this.mdown=!1;var d=this;this.mEvents={};this.keyState=[];for(var f in c.keyboard)this.keyState[f]=!1;this.onMouseDown=function(){return function(a){d.mdown=!0;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseDown&&d.mEvents.mouseDown(d,d.mpos,d.keyState)}}();this.onMouseUp=function(){return function(a){d.mdown=!1;d.mpos=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];d.mEvents.mouseUp&&d.mEvents.mouseUp(d,
d.mpos,d.keyState)}}();this.onMouseMove=function(){return function(a){var b=[],a=[a.pageX-a.target.offsetLeft,a.pageY-a.target.offsetTop];b[0]=a[0]-d.mpos[0];b[1]=a[1]-d.mpos[1];d.mpos=a;d.mEvents.mouseMove&&d.mEvents.mouseMove(d,d.mpos,b,d.keyState)}}();this.onMouseWheel=function(){return function(a){a=a.wheelDelta?a.wheelDelta:100*-a.detail;d.mEvents.mouseWheel&&d.mEvents.mouseWheel(d,d.mpos,a,d.keyState)}}();this.onKeyDown=function(){return function(a){var a=a.keyCode,b=null;d.mEvents.keyPress?
(b=d.mEvents.keyPress(d,d.mpos,a,d.keyState),d.keyState[a]=b!==r?!!b:!0):d.keyState[a]=!0;d.keyState[a]&&d.mEvents.keyDown&&(b=d.mEvents.keyDown(d,d.mpos,a,d.keyState),d.keyState[a]=b!==r?!!b:!0)}}();this.onKeyUp=function(){return function(a){a=a.keyCode;d.mEvents.keyUp&&d.mEvents.keyUp(d,d.mpos,a,d.keyState);d.keyState[a]=!1}}();this.eventDefaults={mouseMove:function(a,b,f){a.mdown&&a.orbitView(f)},mouseWheel:function(a,b,f){a.zoomView(f)},mouseDown:null,mouseUp:null,keyDown:null,keyUp:null,keyPress:null};
!1!==e&&this.setEvents(e===r?this.eventDefaults:e);this.bind()}var r=h.undef,c=h.enums,g=h.GLCore;c.keyboard={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,KEY_K:75,
KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,LEFT_META:91,RIGHT_META:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUM_LOCK:144,SCROLL_LOCK:145,SEMICOLON:186,EQUALS:187,COMMA:188,
DASH:189,PERIOD:190,FORWARD_SLASH:191,GRAVE_ACCENT:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,SINGLE_QUOTE:222};y.prototype={start:function(){this.update();this.num_updates=0;this.last_update=this.start_time=this.system_milliseconds;this.lock_state=this.paused_state=!1;this.offset=this.paused_time=this.lock_rate=0},stop:function(){this.end_time=this.system_milliseconds},reset:function(){this.start()},lockFramerate:function(a){this.lock_rate=1/a;this.lock_state=!0},unlock:function(){var a=
this.system_milliseconds;this.lock_state=!1;this.update();this.last_update=this.system_milliseconds-this.lock_rate;this.offset+=a-this.system_milliseconds;this.lock_rate=0},locked:function(){return this.lock_state},update:function(){this.num_updates++;this.last_update=this.system_milliseconds;this.system_milliseconds=this.lock_state?this.system_milliseconds+(1E3*this.lock_rate|0):Date.now();this.paused_state&&(this.paused_time+=this.system_milliseconds-this.last_update);this.time_elapsed=this.system_milliseconds-
this.start_time-this.paused_time+this.offset},getMilliseconds:function(){return this.time_elapsed},getSeconds:function(){return this.getMilliseconds()/1E3},setMilliseconds:function(a){this.offset-=this.system_milliseconds-this.start_time-this.paused_time+this.offset-a},setSeconds:function(a){this.setMilliseconds(1E3*a|0)},getLastUpdateSeconds:function(){return this.getLastUpdateMilliseconds()/1E3},getLastUpdateMilliseconds:function(){return this.system_milliseconds-this.last_update},getTotalMilliseconds:function(){return this.system_milliseconds-
this.start_time},getTotalSeconds:function(){return this.getTotalMilliseconds()/1E3},getNumUpdates:function(){return this.num_updates},setPaused:function(a){this.paused_state=a},getPaused:function(){return this.paused_state}};q.prototype={setPaused:function(a){this.timer.setPaused(a)},getPaused:function(){return this.timer.getPaused()},setTimerSeconds:function(a){this.timer.setSeconds(a)},getTimerSeconds:function(){return this.timer.getSeconds()},resetTimer:function(){this.timer.reset()},addScene:function(a){this.renderStack[this.renderStack.length-
1].scenes.push(a);return a},pushSceneGroup:function(a){a.scenes=a.scenes||[];this.renderStack.push(a);for(var b=0;b<a.scenes.length;++b)a.scenes[b].enable();a.start&&a.start()},popSceneGroup:function(){for(var a=this.renderStack[this.renderStack.length-1],b=0;b<a.scenes.length;++b)a.scenes[b].disable();1<this.renderStack.length&&this.renderStack.pop();a.stop&&a.stop()},getScene:function(a){for(var b=renderStack[renderStack.length-1],e,d=0,f=b.scenes.length;d<f;++d)if(b.scenes[d].scene.name===a){e=
b.scenes[d];break}return e},resumeScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.enable();a.paused=!1},pauseScene:function(a){"string"===typeof a&&(a=this.getScene(a));a.paused=!0;a.disable()},removeScene:function(a){var b=renderStack[renderStack.length-1];"string"===typeof a&&(a=this.getScene(a));var e=b.scenes.indexOf(a);-1<e&&b.scenes.splice(e,1);return a},runOnce:function(){this.loopFunc()}};n.prototype={getKeyState:function(a){return a!==r?this.keyState[a]:this.keyState},setEvents:function(a){this.mEvents=
{};for(var b in a)this.bindEvent(b,a[b])},orbitView:function(a){var b=h.vec3,e=b.subtract(this.camera.target,this.camera.position),e=b.length(e);this.camera.position=b.moveViewRelative(this.camera.position,this.camera.target,-e*a[0]/300,0);this.camera.position[1]+=e*a[1]/300;this.camera.position=b.add(this.camera.target,b.multiply(b.normalize(b.subtract(this.camera.position,this.camera.target)),e))},panView:function(a,b){var e=h.vec3;b||(b=!1);var d=e.subtract(this.camera.target,this.camera.position),
d=e.length(d),f=this.camera.position;b?this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,-d*a[1]/300):(this.camera.position=e.moveViewRelative(this.camera.position,this.camera.target,-d*a[0]/300,0),this.camera.position[1]+=d*a[1]/300);d=e.subtract(this.camera.position,f);this.camera.target=e.add(this.camera.target,d)},zoomView:function(a,b,e){var d=h.vec3,f=d.subtract(this.camera.target,this.camera.position),f=d.length(f),f=f-a/1E3;b||(b=0.1);e||(e=1E3);f<
b&&(f=b);f>e&&(f=e);this.camera.position=d.add(this.camera.target,d.multiply(d.normalize(d.subtract(this.camera.position,this.camera.target)),f))},bindEvent:function(a,b){this.mEvents[a]=b===r?this.eventDefaults[a]:b},unbindEvent:function(a){this.bindEvent(a,null)},bind:function(){this.canvas.addEventListener("mousemove",this.onMouseMove,!1);this.canvas.addEventListener("mousedown",this.onMouseDown,!1);this.canvas.addEventListener("mouseup",this.onMouseUp,!1);this.canvas.addEventListener("mousewheel",
this.onMouseWheel,!1);this.canvas.addEventListener("DOMMouseScroll",this.onMouseWheel,!1);window.addEventListener("keydown",this.onKeyDown,!1);window.addEventListener("keyup",this.onKeyUp,!1)},unbind:function(){this.canvas.removeEventListener("mousemove",this.onMouseMove,!1);this.canvas.removeEventListener("mousedown",this.onMouseDown,!1);this.canvas.removeEventListener("mouseup",this.onMouseUp,!1);this.canvas.removeEventListener("mousewheel",this.onMouseWheel,!1);this.canvas.removeEventListener("DOMMouseScroll",
this.onMouseWheel,!1);window.removeEventListener("keydown",this.onKeyDown,!1);window.removeEventListener("keyup",this.onKeyUp,!1)},setCamera:function(a){this.camera=a},getMousePosition:function(){return this.mpos}};return{Timer:y,MainLoop:q,MouseViewController:n,setMainLoop:function(a){h.GLCore.mainloop=a},keyboard:c.keyboard}});
CubicVR.RegisterModule("Texture",function(h){function y(a,b){if(1===a||1===b)return!1;if(1!==a)for(;0===a%2;)a/=2;if(1!==b)for(;0===b%2;)b/=2;return 1<a||1<b?!1:!0}function w(a){var f=h.GLCore.gl;if("CANVAS"===a.nodeName||"IMG"===a.nodeName||"VIDEO"===a.nodeName)this.canvasSource=a;else{this.canvasSource=document.createElement("CANVAS");if(void 0===a.width||void 0===a.height)throw Error("Width and height must be specified for generating a new CanvasTexture.");this.canvasSource.width=a.width;this.canvasSource.height=
a.height;this.canvasContext=this.canvasSource.getContext("2d")}this.updateFunction=a.update;this.texture=new h.Texture;this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;var e=this.canvasSource;(!e.height||!e.width)&&d("Warning - CanvasTexture input has no initial width and height, edges clamped.");!e.height||!e.width||!y(e.width,e.height)?(this.setFilter(b.texture.filter.LINEAR),f.texParameteri(f.TEXTURE_2D,
f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE)):(this.setFilter(b.texture.filter.LINEAR_MIP),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.REPEAT),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.REPEAT));"IMG"===a.nodeName&&this.update()}function q(a,f){if(!a)throw"PDF Texture Error: page is null.";var d=this,e=h.GLCore.gl,m=this.canvasSource=document.createElement("canvas"),c;m.mozOpaque=!0;m.width=f.width;m.height=f.height;c=this.canvasContext=
m.getContext("2d");c.save();c.fillStyle="rgb(255, 255, 255)";c.fillRect(0,0,m.width,m.height);c.restore();a.startRendering(c,function(){d.update()});this.texture=new h.Texture;this.updateFunction=f.update||function(){};this.setFilter=this.texture.setFilter;this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(m.width,m.height)?(this.setFilter(b.texture.filter.LINEAR_MIP),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),
e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))}function n(a,f,d){var e=h.GLCore.gl;this.texture=new h.Texture;this.canvas=document.createElement("CANVAS");this.canvas.width=f;this.canvas.height=d;this.pjs=new Processing(this.canvas,h.util.getURL(a));this.pjs.noLoop();this.pjs.redraw();this.setFilter=this.texture.setFilter;
this.clear=this.texture.clear;this.use=this.texture.use;this.tex_id=this.texture.tex_id;this.filterType=this.texture.filterType;y(this.canvas.width,this.canvas.height)?this.setFilter(b.texture.filter.LINEAR_MIP):(this.setFilter(b.texture.filter.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE))}function r(f,d,e){var m=a.gl;this.width=d;this.height=e;this.srcTex=f;this.outTex=new h.RenderBuffer(d,e);y(d,e);f=[1/d,1/
e,0];this.outputBuffer=new h.RenderBuffer(d,e,!1);this.fsQuad=h.fsQuad.make(d,e);shaderNMap=new h.Shader("attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\n  vTex = aTex;\n  vec4 vPos = vec4(aVertex.xyz,1.0);\n  gl_Position = vPos;\n}","#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform vec3 texel;\nvoid main(void)\n{\n vec3 color;\n color.r = (texture2D(srcTex,vTex + vec2(texel.x,0)).r-texture2D(srcTex,vTex + vec2(-texel.x,0)).r)/2.0 + 0.5;\n color.g = (texture2D(srcTex,vTex + vec2(0,-texel.y)).r-texture2D(srcTex,vTex + vec2(0,texel.y)).r)/2.0 + 0.5;\n color.b = 1.0;\n gl_FragColor.rgb = color;\n gl_FragColor.a = 1.0;\n}");
shaderNMap.use();shaderNMap.addUVArray("aTex");shaderNMap.addVertexArray("aVertex");shaderNMap.addInt("srcTex",0);shaderNMap.addVector("texel");shaderNMap.setVector("texel",f);this.shaderNorm=shaderNMap;this.setFilter=this.outputBuffer.texture.setFilter;this.clear=this.outputBuffer.texture.clear;this.use=this.outputBuffer.texture.use;this.tex_id=this.outputBuffer.texture.tex_id;this.filterType=this.outputBuffer.texture.filterType;this.outTex.use(m.TEXTURE0);this.setFilter(b.texture.filter.LINEAR);
m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.REPEAT);m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.REPEAT)}function c(f,d,e){var m=a.gl;this.width=f;this.height=d;this.outTex=new h.RenderBuffer(f,d,e);this.texture=this.outTex.texture;var c=y(f,d);this.setFilter=this.outTex.texture.setFilter;this.clear=this.outTex.texture.clear;this.use=this.outTex.texture.use;this.tex_id=this.outTex.texture.tex_id;this.filterType=this.outTex.texture.filterType;this.texture.use(m.TEXTURE0);c?(this.setFilter(b.texture.filter.LINEAR),
m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.REPEAT),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.REPEAT)):(this.setFilter(b.texture.filter.LINEAR),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE));this.dims=[f,d];this.depth=e?!0:!1}function g(a,b){this.scene=a;this.renderTex=new c(b?b.width:a.camera.width,b?b.height:a.camera.height,!0);this.setFilter=this.renderTex.texture.setFilter;this.clear=this.renderTex.texture.clear;
this.use=this.renderTex.texture.use;this.tex_id=this.renderTex.texture.tex_id;this.filterType=this.renderTex.texture.filterType}var a=h.GLCore,b=h.enums,e=h.undef,d=h.log;b.texture={map:{COLOR:0,ENVSPHERE:1,NORMAL:2,BUMP:3,REFLECT:4,SPECULAR:5,AMBIENT:6,ALPHA:7,MAX:8},filter:{LINEAR:0,LINEAR_MIP:1,NEAREST:2,NEAREST_MIP:3}};var f=function(a,b){this.img_path=a;this.filter_type=b};f.prototype={getTexture:function(a,b){return new m(this.img_path,this.filter_type,a,b)}};var m=function(f,d,m,c,g){var z=
a.gl;this.tex_id=h.Textures.length;this.filterType=-1;this.onready=g;this.loaded=!1;h.Textures[this.tex_id]=z.createTexture();h.Textures_obj[this.tex_id]=this;f&&("string"===typeof f?h.Images[this.tex_id]=new Image:"object"===typeof f&&"IMG"===f.nodeName&&(h.Images[this.tex_id]=f),h.Textures_ref[f]=this.tex_id);z.bindTexture(z.TEXTURE_2D,h.Textures[this.tex_id]);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,z.LINEAR);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MIN_FILTER,z.LINEAR);if(f){var n=this.tex_id,
q=d!==e?d:a.default_filter,r=this;h.Images[this.tex_id].onload=function(){z.bindTexture(z.TEXTURE_2D,h.Textures[n]);z.pixelStorei(z.UNPACK_FLIP_Y_WEBGL,true);z.pixelStorei(z.UNPACK_COLORSPACE_CONVERSION_WEBGL,z.NONE);var a=h.Images[n];z.texImage2D(z.TEXTURE_2D,0,z.RGBA,z.RGBA,z.UNSIGNED_BYTE,a);if(a=y(a.width,a.height)){z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_S,z.REPEAT);z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_T,z.REPEAT)}else{z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_S,z.CLAMP_TO_EDGE);
z.texParameteri(z.TEXTURE_2D,z.TEXTURE_WRAP_T,z.CLAMP_TO_EDGE)}if(h.Textures_obj[n].filterType===-1){if(a)q=b.texture.filter.LINEAR_MIP;else if(q===b.texture.filter.LINEAR_MIP)q=b.texture.filter.LINEAR;h.Textures_obj[n].filterType===-1&&h.Textures_obj[n].setFilter(q)}else h.Textures_obj[n].setFilter(h.Textures_obj[n].filterType);if(r.onready)r.onready();z.bindTexture(z.TEXTURE_2D,null);r.loaded=true};m?(h.Images[this.tex_id].deferredSrc=f,m.addImage(c,f,h.Images[this.tex_id])):"string"===typeof f&&
(h.Images[this.tex_id].src=f)}this.active_unit=-1};m.prototype={setFilter:function(a){if(-1<this.tex_id){var f=h.GLCore.gl;f.bindTexture(f.TEXTURE_2D,h.Textures[this.tex_id]);a===b.texture.filter.LINEAR?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR)):a===b.texture.filter.LINEAR_MIP?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.generateMipmap(f.TEXTURE_2D)):
a===b.texture.filter.NEAREST?(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST)):a===b.texture.filter.NEAREST_MIP&&(f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST_MIPMAP_LINEAR),f.generateMipmap(f.TEXTURE_2D));this.filterType=a}},use:function(b){-1<this.tex_id&&(a.gl.activeTexture(b),a.gl.bindTexture(a.gl.TEXTURE_2D,h.Textures[this.tex_id]),this.active_unit=
b)},clear:function(){-1<this.tex_id&&-1!==this.active_unit&&(a.gl.activeTexture(this.active_unit),a.gl.bindTexture(a.gl.TEXTURE_2D,null),this.active_unit=-1)},destroy:function(){var a=h.GLCore.gl;-1<this.tex_id&&h.Textures[this.tex_id]&&(a.deleteTexture(h.Textures[this.tex_id]),delete h.Textures_obj[this.tex_id],this.tex_id=-1)}};w.prototype={update:function(){this.updateFunction&&this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);
a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};q.prototype={update:function(){this.updateFunction(this.canvasSource,this.canvasContext);var a=h.GLCore.gl;a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvasSource);
this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};n.prototype={update:function(){var a=h.GLCore.gl;this.pjs.redraw();a.bindTexture(a.TEXTURE_2D,h.Textures[this.texture.tex_id]);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this.canvas);this.filterType===b.texture.filter.LINEAR_MIP&&a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)}};r.prototype={update:function(){var b=
a.gl,f=b.getParameter(b.VIEWPORT);this.outputBuffer.use();b.viewport(0,0,this.width,this.height);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.srcTex.use(b.TEXTURE0);h.fsQuad.render(this.shaderNorm,this.fsQuad);b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(f[0],f[1],f[2],f[3])}};c.prototype={begin:function(){var b=a.gl;this.dims=b.getParameter(b.VIEWPORT);this.outTex.use();b.viewport(0,0,this.width,this.height);this.depth?b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT):b.clear(b.COLOR_BUFFER_BIT)},
end:function(){var b=a.gl;b.bindFramebuffer(b.FRAMEBUFFER,null);b.viewport(this.dims[0],this.dims[1],this.dims[2],this.dims[3])}};g.prototype={update:function(){this.renderTex.begin();this.scene.updateShadows();this.scene.render();this.renderTex.end()}};return{Texture:m,DeferredLoadTexture:f,CanvasTexture:w,PdfTexture:q,TextTexture:function(a,b){var f=b&&b.color||"#fff",d=b&&b.bgcolor,m=b&&b.font||"18pt Arial",c=b&&b.align||"start",g=b&&b.y||0,n=b&&b.width||e,q=b&&b.height||e,h,x=document.createElement("CANVAS"),
r=x.getContext("2d"),A=0,A="string"===typeof a?1:a.length;r.font=m;var E=b&&b.lineHeight||r.measureText("OO").width,y;if(1===A)y=r.measureText(a).width;else for(h=y=0;h<A;++h){var G=r.measureText(a[h]).width;G>y&&(y=G)}x.width=n||y;x.height=q||E*A;d&&(r.fillStyle=d,r.fillRect(0,0,x.width,x.height));r.fillStyle=f;r.font=m;r.textAlign=c;r.textBaseline="top";if(1===A)f=b&&b.x||"center"===c?x.width/2:"right"===c?x.width:0,r.fillText(a,f,g);else for(h=0;h<A;++h)f=b&&b.x||"center"===c?x.width/2:"right"===
c?x.width:0,r.fillText(a[h],f,g+h*E);r.fill();this.use=w.prototype.use;this.clear=w.prototype.clear;this.update=w.prototype.update;w.apply(this,[x]);this.update();this.canvasSource=null},PJSTexture:n,NormalMapGen:r,RenderTexture:c,SceneRenderTexture:g}});
CubicVR.RegisterModule("DrawBufferTexture",function(h){var y=h.GLCore,w=h.enums;w.draw={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2,MULTIPLY:3}};var q=function(n){n=n||{};this.operation=h.parseEnum(w.draw.op,n.operation||n.op)||w.draw.op.REPLACE;this.brushType=h.parseEnum(w.draw.brush,n.brushType)||w.draw.brush.SINE;this.brushSize=n.size||5;this.color=n.color||[255,255,255,255]};q.prototype={setOperation:function(n){this.operation=h.parseEnum(w.draw.op,n)},getOperation:function(){return this.operation},
setBrushType:function(n){this.brushType=h.parseEnum(w.draw.brush,n)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(n){this.brushSize=n},getSize:function(){return this.brushSize},setColor:function(n){this.color=n},getColor:function(){return this.color.slice(0)}};return{DrawBufferTexture:h.extendClassGeneral(h.Texture,function(n){n=n||{};h.Texture.apply(this,[n.image,n.filter,n.deferred_bin,n.binId,n.readyFunc]);this.width=n.width||0;this.height=n.height||0;this.imageBufferData=
this.imageBuffer=null;this.brush=n.brush||new q;this.drawBuffer=[];this.width&&this.height&&this.setupImageBuffer(this.width,this.height)},{needsFlush:function(){return 0!==this.drawBuffer.length},getWidth:function(){return this.width},getHeight:function(){return this.height},setupImageBuffer:function(){this.imageBufferData=new ArrayBuffer(4*this.width*this.height);this.imageBuffer=new Uint8Array(this.imageBufferData);this.update()},setBrush:function(n){this.brush=n},getBrush:function(){return this.brush},
draw:function(n,q,c){var g=c||this.brush,c=g.getOperation(),a=g.getSize(),b=g.getBrushType(),g=g.getColor();this.drawBuffer.push([n,q,c,a,b,g])},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var n=this.drawBuffer.pop();this.drawFunc(n[0],n[1],n[2],n[3],n[4],n[5])}return!0},drawFunc:function(n,q,c,g,a,b){for(var e=this.imageBuffer,d=this.width,f=this.height,m=parseInt(Math.floor(n),10)-g;m<parseInt(Math.ceil(n),10)+g;m++)for(var o=m-n,s,D=parseInt(Math.floor(q),
10)-g;D<parseInt(Math.ceil(q),10)+g;D++)if(!(0>m||m>=d||0>D||D>=f)){s=D-q;var v;0===a&&(v=(1-Math.sqrt(o*o+s*s)/g)/2);s=4*(D*d+m);0===c?0>v&&(v=0):1===c?0>v&&(v=0):2===c&&(v=-v,0<v&&(v=0));var u=Math.floor(e[s]*(1-v)+b[0]*v),z=Math.floor(e[s+1]*(1-v)+b[1]*v),h=Math.floor(e[s+2]*(1-v)+b[2]*v),C=Math.floor(e[s+3]*(1-v)+b[3]*v);255<u?u=255:0>u&&(u=0);255<z?z=255:0>z&&(z=0);255<h?h=255:0>h&&(h=0);255<C?C=255:0>C&&(C=0);e[s]=u;e[s+1]=z;e[s+2]=h;e[s+3]=C}},update:function(){var n=y.gl;this.flush();n.bindTexture(n.TEXTURE_2D,
h.Textures[this.tex_id]);n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.UNSIGNED_BYTE,this.imageBuffer);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR)}}),DrawBufferBrush:q}});
CubicVR.RegisterModule("Material",function(h){function y(a){this.blendEnabled=this.dirtyFlag=this.initialized=!1;this.textures=[];this.shader=[];this.customShader=(a=h.get(a)||{},a.shader||null);null===r&&(r=new h.CustomShader({vertex:"precision lowp float; \nattribute vec3 vertexPosition; uniform mat4 matrixModelView; uniform mat4 matrixProjection; uniform mat4 matrixObject;\nvoid main(void) { gl_Position = matrixProjection * matrixModelView * matrixObject * vec4(vertexPosition,1.0); }",fragment:"precision lowp float; \nvoid main(void) { gl_FragColor = vec4(1.0,0.0,1.0,1.0); }\n"}),
r._init_shader(r._vertex,r._fragment,!1));this.customShader&&(!this.customShader._init_shader&&"object"===typeof this.customShader)&&(this.customShader=new h.CustomShader(this.customShader));this.diffuse=a.diffuse||[1,1,1];this.specular=a.specular||[0.1,0.1,0.1];this.color=a.color||[1,1,1];this.ambient=a.ambient||[0,0,0];this.name=a.name||null;this.visible=a.visible!==w?a.visible:!0;this.friction=a.friction!==w?a.friction:0.3;this.collision=a.visible!==w?a.collision:!0;this.opacity=a.opacity===w?
1:a.opacity;this.shininess=a.shininess===w?1:a.shininess;this.max_smooth=a.max_smooth===w?60:a.max_smooth;this.env_amount=a.env_amount===w?0.75:a.env_amount;this.morph=a.morph===w?!1:a.morph;this.color_map=a.colorMap===w?!1:a.colorMap;this.uvOffset=a.uvOffset===w?[0,0]:a.uvOffset;this.noFog=a.noFog===w?!1:a.noFog;if(a.textures)for(var e in a.textures)this.setTexture(a.textures[e],e)}var w=h.undef,q=h.GLCore,n=h.enums,r=null,c=[n.texture.map.REFLECT,n.texture.map.SPECULAR,n.texture.map.NORMAL,n.texture.map.BUMP],
g=[],a="textureColor textureEnvSphere textureNormal textureBump textureReflect textureSpecular textureAmbient textureAlpha matrixModelView matrixProjection matrixObject matrixNormal vertexPosition vertexNormal vertexColor vertexTexCoord materialTexOffset vertexMorphPosition vertexMorphNormal materialMorphWeight lightDiffuse lightSpecular lightIntensity lightDistance lightPosition lightDirection lightCutOffAngle lightShadowMap lightProjectionMap lightDepthClip lightShadowMatrix lightAmbient materialDiffuse materialColor materialAmbient materialSpecular materialShininess materialEnvironment materialAlpha postDepthInfo".split(" ");
y.prototype={clone:function(){var a=new h.Material({diffuse:this.diffuse,specular:this.specular,color:this.color,ambient:this.ambient,opacity:this.opacity,shininess:this.shininess,max_smooth:this.max_smooth,env_amount:this.env_amount,morph:this.morph,colorMap:this.color_map,visible:this.visible,friction:this.friction,collision:this.collision,name:this.name}),e;for(e in this.textures)this.textures.hasOwnProperty(e)&&a.setTexture(this.textures[e],e);return a},setVisibility:function(a){this.visible=
a},getVisibility:function(){return this.visible},setCollision:function(a){this.collision=a},getCollision:function(){return this.collision},setFriction:function(a){this.friction=a},getFriction:function(){return this.friction},setTexture:function(a,e){if(a&&(e=h.parseEnum(n.texture.map,e)||0,h.features.texturePerPixel||-1===c.indexOf(e)))!a.use&&"string"===typeof a&&(a=h.Textures_ref[a]!==w?h.Textures_obj[h.Textures_ref[a]]:new h.Texture(a)),this.textures[e]=a},calcShaderMask:function(){var a;a=0+("object"===
typeof this.textures[n.texture.map.COLOR]?n.shader.map.COLOR:0);a+="object"===typeof this.textures[n.texture.map.SPECULAR]?n.shader.map.SPECULAR:0;a+="object"===typeof this.textures[n.texture.map.NORMAL]?n.shader.map.NORMAL:0;a+="object"===typeof this.textures[n.texture.map.BUMP]?n.shader.map.BUMP:0;a+="object"===typeof this.textures[n.texture.map.REFLECT]?n.shader.map.REFLECT:0;a+="object"===typeof this.textures[n.texture.map.ENVSPHERE]?n.shader.map.ENVSPHERE:0;a+="object"===typeof this.textures[n.texture.map.AMBIENT]?
n.shader.map.AMBIENT:0;a+="object"===typeof this.textures[n.texture.map.ALPHA]?n.shader.map.ALPHA:0;a+=1!==this.opacity?n.shader.map.ALPHA:0;a+=this.color_map?n.shader.map.COLORMAP:0;1!==this.opacity&&(this.blendEnabled=!0);return a},getShaderHeader:function(a,e){return(e!==w?"#define LIGHT_COUNT "+e+"\n":"")+"#define TEXTURE_COLOR "+("object"===typeof this.textures[n.texture.map.COLOR]?1:0)+"\n#define TEXTURE_SPECULAR "+("object"===typeof this.textures[n.texture.map.SPECULAR]?1:0)+"\n#define TEXTURE_NORMAL "+
("object"===typeof this.textures[n.texture.map.NORMAL]?1:0)+"\n#define TEXTURE_BUMP "+("object"===typeof this.textures[n.texture.map.BUMP]?1:0)+"\n#define TEXTURE_REFLECT "+("object"===typeof this.textures[n.texture.map.REFLECT]?1:0)+"\n#define TEXTURE_ENVSPHERE "+("object"===typeof this.textures[n.texture.map.ENVSPHERE]?1:0)+"\n#define TEXTURE_AMBIENT "+("object"===typeof this.textures[n.texture.map.AMBIENT]?1:0)+"\n#define TEXTURE_ALPHA "+("object"===typeof this.textures[n.texture.map.ALPHA]?1:
0)+"\n#define MATERIAL_ALPHA "+(1!==this.opacity?1:0)+"\n#define LIGHT_IS_POINT "+(a===n.light.type.POINT?1:0)+"\n#define LIGHT_IS_DIRECTIONAL "+(a===n.light.type.DIRECTIONAL?1:0)+"\n#define LIGHT_IS_SPOT "+(a===n.light.type.SPOT||a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR?1:0)+"\n#define LIGHT_SHADOWED "+(a===n.light.type.SPOT_SHADOW||a===n.light.type.SPOT_SHADOW_PROJECTOR||a===n.light.type.AREA?1:0)+"\n#define LIGHT_IS_PROJECTOR "+(a===n.light.type.SPOT_SHADOW_PROJECTOR?
1:0)+"\n#define LIGHT_SHADOWED_SOFT "+(q.soft_shadow?1:0)+"\n#define LIGHT_IS_AREA "+(a===n.light.type.AREA?1:0)+"\n#define LIGHT_DEPTH_PASS "+(a===n.light.type.DEPTH_PACK?1:0)+"\n#define FX_DEPTH_ALPHA "+(q.depth_alpha?1:0)+"\n#define VERTEX_MORPH "+(this.morph?1:0)+"\n#define VERTEX_COLOR "+(this.color_map?1:0)+"\n#define FOG_ENABLED "+(q.fog_enabled&&!this.noFog?1:0)+"\n#define USE_FOG_EXP "+(q.fogExp?1:0)+"\n#define USE_FOG_LINEAR "+(q.fogLinear?1:0)+"\n#define LIGHT_PERPIXEL "+(h.features.lightPerPixel?
1:0)+"\n\n"},bindObject:function(a,e){var d=q.gl,f=e.vertexPosition,m=e.vertexTexCoord,o=e.vertexNormal,c=e.vertexColor;d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_points);d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(f);null!==m&&(null!==a.compiled.gl_uvs&&-1!==m)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_uvs),d.vertexAttribPointer(m,2,d.FLOAT,!1,0,0),d.enableVertexAttribArray(m));g.uv=m;null!==o&&(null!==a.compiled.gl_normals&&-1!==o)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_normals),
d.vertexAttribPointer(o,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(o));g.un=o;null!==c&&(null!==a.compiled.gl_colors&&-1!==c)&&(d.bindBuffer(d.ARRAY_BUFFER,a.compiled.gl_colors),d.vertexAttribPointer(c,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(c));g.uc=c;a.morphTarget&&(f=e.vertexMorphPosition,o=e.vertexMorphNormal,d.bindBuffer(d.ARRAY_BUFFER,a.morphTarget.gl_points),d.vertexAttribPointer(f,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(f),null!==o&&(null!==a.morphTarget.gl_normals&&-1!==o)&&(d.bindBuffer(d.ARRAY_BUFFER,
a.morphTarget.gl_normals),d.vertexAttribPointer(o,3,d.FLOAT,!1,0,0),d.enableVertexAttribArray(o)),d.uniform1f(e.materialMorphWeight,a.morphWeight));d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a.compiled.gl_elements)},clearObject:function(a,e){var d=q.gl;g.uv!==w&&-1!==g.uv&&d.disableVertexAttribArray(g.uv);g.un!==w&&-1!==g.un&&d.disableVertexAttribArray(g.un);g.uc!==w&&-1!==g.uc&&d.disableVertexAttribArray(g.uc);a.morphTarget&&e&&(up=e.vertexMorphPosition,d.disableVertexAttribArray(up),un=e.vertexMorphNormal,
null!==un&&(null!==a.compiled.gl_normals&&-1!==un)&&d.disableVertexAttribArray(un))},use:function(b,e){var d,f=q.gl,m=this.textures,o=!0,e=e||0,b=b||0;this.shader[b]||(this.shader[b]=[]);var c=this.shader[b][e],g=this.customShader&&b===n.light.type.DEPTH_PACK&&!this.customShader.hasDepthPack();c&&(1!==this.opacity&&!0!==this.blendEnabled)&&(this.dirtyFlag=!0);!0===this.dirtyFlag&&(c=null,this.dirtyFlag=!1);if(c)o=c!==r,c.use();else{d=this.calcShaderMask(b);if(!this.customShader||g)h.ShaderPool[b][d]||
(h.ShaderPool[b][d]=[]),c=h.ShaderPool[b][d][e];if(!c){var v=this.getShaderHeader(b,e),u=v+q.CoreShader_vs,v=v+q.CoreShader_fs;this.customShader&&!g?this.customShader._initialized||(this.customShader._init_shader(u,v,a),c=this.customShader.getShader(),c.isCompiled()||(o=!1,c=r.getShader())):(c=new h.Shader(u,v),c.isCompiled()||(o=!1,c=r.getShader()),h.ShaderPool[b][d][e]=c);d=0;if(b!==n.light.type.DEPTH_PACK){if(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)d+=
e,b===n.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);"object"===typeof m[n.texture.map.COLOR]&&c.addInt("textureColor",d++);"object"===typeof m[n.texture.map.ENVSPHERE]&&c.addInt("textureEnvSphere",d++);"object"===typeof m[n.texture.map.NORMAL]&&c.addInt("textureNormal",d++);"object"===typeof m[n.texture.map.BUMP]&&c.addInt("textureBump",d++);"object"===typeof m[n.texture.map.REFLECT]&&c.addInt("textureReflect",d++);"object"===typeof m[n.texture.map.SPECULAR]&&c.addInt("textureSpecular",d++);"object"===
typeof m[n.texture.map.AMBIENT]&&c.addInt("textureAmbient",d++)}"object"===typeof m[n.texture.map.ALPHA]&&c.addInt("textureAlpha",d++);c.addMatrix("matrixModelView");c.addMatrix("matrixProjection");c.addMatrix("matrixObject");c.addMatrix("matrixNormal");c.addVertexArray("vertexPosition");c.addVertexArray("vertexNormal");this.color_map&&c.addVertexArray("vertexColor");this.morph&&(c.addVertexArray("vertexMorphPosition"),c.addVertexArray("vertexMorphNormal"),c.addFloat("materialMorphWeight",0));for(d=
0;d<e;d++)if(c.addVector("lightDiffuse["+d+"]"),c.addVector("lightSpecular["+d+"]"),c.addFloat("lightIntensity["+d+"]"),c.addFloat("lightDistance["+d+"]"),c.addVector("lightPosition["+d+"]"),c.addVector("lightDirection["+d+"]"),(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.SPOT)&&c.addFloat("lightCutOffAngle["+d+"]"),b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)c.addInt("lightShadowMap["+d+"]"),b===n.light.type.SPOT_SHADOW_PROJECTOR&&
c.addInt("lightProjectionMap["+d+"]"),c.addVector("lightDepthClip["+d+"]"),c.addMatrix("lightShadowMatrix["+d+"]");b!==n.light.type.DEPTH_PACK&&(c.addVector("lightAmbient"),c.addVector("materialDiffuse"),c.addVector("materialColor"),c.addVector("materialAmbient"),c.addVector("materialSpecular"),c.addFloat("materialShininess"),c.addFloat("materialEnvironment"));c.addFloat("materialAlpha");(q.depth_alpha||b===n.light.type.DEPTH_PACK||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||
b===n.light.type.AREA)&&c.addVector("postDepthInfo");c.addUVArray("vertexTexCoord");c.addVector("materialTexOffset");q.fog_enabled&&!this.noFog&&(c.addVector("fogColor",q.fogColor),c.addFloat("fogDensity",q.fogDensity),c.addFloat("fogNear",q.fogNear),c.addFloat("fogFar",q.fogFar))}this.shader[b][e]=c;c.use();-1!=c.materialTexOffset&&f.uniform2fv(c.materialTexOffset,[0,0])}d=0;if(b!==n.light.type.DEPTH_PACK){if(b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)d+=
e,b===n.light.type.SPOT_SHADOW_PROJECTOR&&(d+=e);if(u=m[n.texture.map.COLOR])u.use(q.gl.TEXTURE0+d),d++;if(u=m[n.texture.map.ENVSPHERE])u.use(q.gl.TEXTURE0+d),d++,f.uniform1f(c.materialEnvironment,this.env_amount);if(u=m[n.texture.map.NORMAL])u.use(q.gl.TEXTURE0+d),d++;if(u=m[n.texture.map.BUMP])u.use(q.gl.TEXTURE0+d),d++;if(u=m[n.texture.map.REFLECT])u.use(q.gl.TEXTURE0+d),d++;if(u=m[n.texture.map.SPECULAR])u.use(q.gl.TEXTURE0+d),d++;if(u=m[n.texture.map.AMBIENT])u.use(q.gl.TEXTURE0+d),d++}if(u=
m[n.texture.map.ALPHA])u.use(q.gl.TEXTURE0+d),d++;q.fog_enabled&&!this.noFog&&(f.uniform3fv(c.fogColor,q.fogColor),f.uniform1f(c.fogDensity,q.fogDensity),f.uniform1f(c.fogNear,q.fogNear),f.uniform1f(c.fogFar,q.fogFar));b!==n.light.type.DEPTH_PACK?(f.uniform3fv(c.materialColor,this.color),f.uniform3fv(c.materialDiffuse,this.diffuse),f.uniform3fv(c.materialAmbient,this.ambient),f.uniform3fv(c.materialSpecular,this.specular),f.uniform1f(c.materialShininess,128*this.shininess),f.uniform3fv(c.lightAmbient,
h.globalAmbient),1!==this.opacity&&f.uniform1f(c.materialAlpha,this.opacity),(q.depth_alpha||b===n.light.type.SPOT_SHADOW||b===n.light.type.SPOT_SHADOW_PROJECTOR||b===n.light.type.AREA)&&f.uniform3fv(c.postDepthInfo,[q.depth_alpha_near,q.depth_alpha_far,0])):f.uniform3fv(c.postDepthInfo,[q.shadow_near,q.shadow_far,0]);c.materialTexOffset&&f.uniform2fv(c.materialTexOffset,this.uvOffset);this.customShader&&(b!==n.light.type.DEPTH_PACK||b===n.light.type.DEPTH_PACK&&!g)&&this.customShader._doUpdate({material:this,
textureIndex:d});return o}};return{Material:y}});
CubicVR.RegisterModule("Mesh",function(h){function y(){this.points=[];this.point_normals=[];this.point_colors=[];this.uvs=[];this.normal=[0,0,0];this.segment=this.material=0}function w(c){this.compiled=null;this.materials=[];this.edges=this.instanceMaterials=this.bb=null;this.faces=[];this.points=[];this.currentFace=-1;this.currentSegment=this.currentMaterial=0;this.morphTarget=this.morphTargets=null;this.morphWeight=0;this.morphTargetIndex=this.morphSourceIndex=-1;this.originBuffer=null;c=h.get(c)||
{};if(c instanceof h.Mesh)this.booleanAdd(c),c._clones=c._clones||1,c._clones++,this.name=c.name?c.name+"_copy"+c._clones:null;else{this.name=c.name||null;this.dynamic=c.dynamic||!1;if(c.material){var g=c.material;g.length?this.materials=g:"object"===typeof g&&(g.use?this.setFaceMaterial(g):this.setFaceMaterial(new h.Material(g)))}c.points&&this.build(c);c.part?this.build(c.part):c.parts&&this.build(c.parts);if((this.primitives=c.primitives||c.primitive||null)&&!this.primitives.length||"string"===
typeof this.primitives)this.primitives=[this.primitives];if(this.primitives&&this.primitives.length)for(var g=0,a=this.primitives.length;g<a;g++){var b=this.primitives[g];"string"===typeof b&&(b=h.get(b));var e=h.primitives[b.type];if(b.type&&e)this.booleanAdd(e(b));else if(b.type){r("Mesh error, primitive "+b.type+" is unknown.");var b="",d;for(d in h.primitives)h.primitives.hasOwnProperty(d)&&(""!==b&&(b+=", "),b+=d);r("Available primitive types are: "+b)}else r("Mesh error, primitive "+(g+1)+" lacks type.")}this.buildWireframe=
c.buildWireframe||c.wireframe||!!c.wireframeMaterial||c.triangulateWireframe||!1;this.triangulateWireframe=c.triangulateWireframe||null;this.wireframeMaterial=h.get(c.wireframeMaterial,h.Material)||null;this.wireframe=c.wireframe||!1;c.flipFaces&&this.faces.length&&this.flipFaces();(c.prepare||c.compile&&this.faces.length)&&this.prepare();(c.clean||c.compile&&this.faces.length&&!this.dynamic)&&this.clean();c.calcNormals&&(!c.compile&&!c.prepare)&&this.calcNormals()}}var q=h.undef,n=h.GLCore,r=h.log;
y.prototype={setUV:function(c,g){g!==q?this.uvs[g]=c:2!==c.length?this.uvs=c:this.uvs.push(c)},setColor:function(c,g){g!==q?this.point_colors[g]=c:"number"!==typeof c[0]?this.point_colors=c:this.point_colors.push(c)},flip:function(){for(var c=0,g=this.point_normals.length;c<g;c++)this.point_normals[c]=[-this.point_normals[c][0],-this.point_normals[c][1],-this.point_normals[c][2]];this.points.reverse();this.point_normals.reverse();this.uvs.reverse();this.normal=[-this.normal[0],-this.normal[1],-this.normal[2]]}};
w.prototype={setWireframe:function(c){this.wireframe=c},isWireframe:function(){return this.wireframe},setWireframeMaterial:function(c){this.wireframeMaterial=c},build:function(c,g){var a,b;"string"===typeof c&&(c=h.get(c));c&&!c.length&&(c=[c]);var e=this.faces.length;g&&g.length&&this.points.concat(g);for(var d=0,f=c.length;d<f;d++){var m=c[d];a=m.material;b=m.points;var o=m.faces,s=m.uv,D=m.color,m=m.segment||null;null!==m&&this.setSegment(parseInt(m,10));if(b&&b.length&&(this.points=this.points.concat(b),
o&&e)){o=o.slice(0);b=0;for(m=o.length;b<m;b++)for(var v=o[b],u=0,n=o.length;u<n;u++)v[u]+=e}a&&(a.length?this.materials=a:"object"===typeof a&&(a.use?this.setFaceMaterial(a):this.setFaceMaterial(new h.Material(a))));o&&o.length&&this.addFace(o);if(o&&s&&"object"===typeof s){m=null;if(s.length&&s.length===o.length)if(s.length===o.length){a=0;for(b=s.length;a<b;a++)this.faces[a+e].setUV(s[a])}else r("Mesh error in part, face count: "+o.length+", uv count:"+s.length);else m=s.apply?s:new h.UVMapper(s);
m&&m.apply(this,this.currentMaterial,this.currentSegment,e,this.faces.length-e)}if(o&&D&&"object"===typeof D)if(D.length&&D.length===o.length){a=0;for(b=D.length;a<b;a++)this.faces[a+e].setColor(D[a]);this.materials[this.currentMaterial].colorMap=!0}else r("Mesh error in part, face count: "+o.length+", color count:"+D.length)}return this},showAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&(this.segment_state[c]=!0)},hideAllSegments:function(){for(var c in this.segment_state)this.segment_state.hasOwnProperty(c)&&
(this.segment_state[c]=!1)},setSegment:function(c,g){g!==q?this.segment_state[c]=g:this.currentSegment=c},addPoint:function(c){if(3!==c.length||"object"===typeof c[0])for(var g=0,a=c.length;g<a;g++)this.points.push(c[g]);else this.points.push(c);return this.points.length-1},getMaterialIndex:function(c){return this.materials.indexOf(c)},setFaceMaterial:function(c,g){var a;"number"==typeof c?a=c:(a=this.materials.indexOf(c),-1===a&&(this.materials.push(c),a=this.materials.length-1));g!==q?this.faces[g]!==
q&&(this.faces[g].material=a):this.currentMaterial=a;return this},addFace:function(c,g,a,b){if("number"!==typeof c[0]){g=0;for(a=c.length;g<a;g++)this.addFace(c[g])}else return g===q?(this.currentFace=this.faces.length,this.faces.push(new y)):(this.faces[g]===q&&(this.faces[g]=new y),this.currentFace=g),"object"===typeof c&&(this.faces[this.currentFace].points=c),a!==q?this.setFaceMaterial(a,this.currentFace):this.faces[this.currentFace].material=this.currentMaterial,this.faces[this.currentFace].segment=
b!==q?b:this.currentSegment,this.currentFace},flipFaces:function(){for(var c=0,g=this.faces.length;c<g;c++)this.faces[c].flip()},triangulateQuads:function(){for(var c=0,g=this.faces.length;c<g;c++)if(4===this.faces[c].points.length){var a=this.faces.length;this.addFace([this.faces[c].points[2],this.faces[c].points[3],this.faces[c].points[0]],this.faces.length,this.faces[c].material,this.faces[c].segment);this.faces[c].points.pop();this.faces[a].normal=this.faces[c].normal.slice(0);4===this.faces[c].point_colors.length&&
(this.faces[a].setColor(this.faces[c].point_colors[2],0),this.faces[a].setColor(this.faces[c].point_colors[3],1),this.faces[a].setColor(this.faces[c].point_colors[0],2),this.faces[c].point_colors.pop());4===this.faces[c].uvs.length&&(this.faces[a].setUV(this.faces[c].uvs[2],0),this.faces[a].setUV(this.faces[c].uvs[3],1),this.faces[a].setUV(this.faces[c].uvs[0],2),this.faces[c].uvs.pop());4===this.faces[c].point_normals.length&&(this.faces[a].point_normals[0]=this.faces[c].point_normals[2],this.faces[a].point_normals[1]=
this.faces[c].point_normals[3],this.faces[a].point_normals[2]=this.faces[c].point_normals[0],this.faces[c].point_normals.pop())}return this},booleanAdd:function(c,g){var a=h.mat4,b=this.points.length,e,d,f,m;e=g;g=e===q?q:"array"===typeof e?e:"object"===typeof e?e.getResult?e.getResult():e.position||e.rotation||e.scale?h.mat4.transform(e.position,e.rotation,e.scale):q:void 0;c.wireframeMaterial&&(this.wireframeMaterial=c.wireframeMaterial);if(g!==q){d=g;e=0;for(f=c.points.length;e<f;e++)this.addPoint(a.vec3_multiply(c.points[e],
d))}else{e=0;for(f=c.points.length;e<f;e++)this.addPoint([c.points[e][0],c.points[e][1],c.points[e][2]])}a=[];e=0;for(f=c.materials.length;e<f;e++)d=this.materials.indexOf(c.materials[e]),-1===d?(this.materials.push(c.materials[e]),a[e]=this.materials.length-1):a[e]=d;e=0;for(f=c.faces.length;e<f;e++){var o=[];d=0;for(m=c.faces[e].points.length;d<m;d++)o.push(c.faces[e].points[d]+b);o=this.faces[this.addFace(o)];o.segment=c.faces[e].segment;o.material=a[c.faces[e].material];o.material===q&&(o.material=
0);d=0;for(m=c.faces[e].uvs.length;d<m;d++)o.uvs[d]=[c.faces[e].uvs[d][0],c.faces[e].uvs[d][1]];d=0;for(m=c.faces[e].point_normals.length;d<m;d++)o.point_normals[d]=[c.faces[e].point_normals[d][0],c.faces[e].point_normals[d][1],c.faces[e].point_normals[d][2]]}return this},calcFaceNormals:function(c,g){var a=h.vec3,b=h.triangle,e=0,d=this.faces.length,f,m=this.points,o;c&&(e=c);for(g&&(d=g+1);e<d;e++)f=this.faces[e],o=f.points,3>o.length?f.normal=[0,0,0]:a.normalize(b.normal(m[o[0]],m[o[1]],m[o[2]],
f.normal));return this},getMaterial:function(c){if(!isNaN(parseInt(c,10)))return this.materials[g];for(var g=0,a=this.materials.length;g<a;g++)if(this.materials[g].name===c)return this.materials[g];return null},getMaterials:function(){return this.materials},bindInstanceMaterials:function(c){this.instanceMaterials=c},calcNormals:function(c){var g=h.vec3,a=!1,b;this.dynamic&&(b=[],c=c||{});c!==q&&(b=[],a=!0);this.calcFaceNormals();var e,d,f,m,o=Array(this.points.length);e=0;for(m=o.length;e<m;e++)o[e]=
[];m=this.faces.length;for(e=0;e<m;e++){f=this.faces[e].points.length;for(d=0;d<f;d++)o[this.faces[e].points[d]].push([e,d])}e=0;for(m=this.points.length;e<m;e++){var s=o[e].length;for(d=0;d<s;d++){var D=1,v=o[e][d][0],u=o[e][d][1],n=this.materials.length?this.materials[this.faces[v].material].max_smooth:60,B=this.faces[v];a&&(b[v]===q&&(b[v]=[]),b[v][u]===q&&(b[v][u]=[]));var r=Array(3);r[0]=B.normal[0];r[1]=B.normal[1];r[2]=B.normal[2];if(0!==n)for(f=0;f<s;f++)if(d!==f){var w=o[e][f][0],t=this.faces[w],
x=g.angle(t.normal,B.normal);if(x!==x||x*(180/Math.PI)<=n)a&&b[v][u].push(w),r[0]+=t.normal[0],r[1]+=t.normal[1],r[2]+=t.normal[2],D++}r[0]/=D;r[1]/=D;r[2]/=D;this.faces[v].point_normals[u]=g.normalize(r)}}if(a){e=g=0;for(m=b.length;e<m;e++){d=0;for(f=b[e].length;d<f;d++)g+=b[e][d].length}c.faceCount||(c.faceCount=new Uint8Array(3*this.faces.length));c.faceNorm||(c.faceNorm=new Uint16Array(g));c.faceNormIdx||(c.faceNormIdx=new Uint16Array(this.faces.length));e=g=0;for(m=this.faces.length;e<m;e++)for(d=
0;3>d;d++)if(a=b[e][d],c.faceCount[3*e+d]=a?a.length:0,c.faceNormIdx[e]=g,a){f=0;for(a=a.length;f<a;f++)c.faceNorm[g++]=b[e][d][f]}else g++;this.normalMapRef=c}return this},recalcNormals:function(c,g){var a,b,e,d,f,m,o,s,D,v;if(c=c||this.normalMapRef){a=g.segments!==q?!0:!1;b=g.segments;this.calcFaceNormals();var u=0,n=0,h=0,r;if(a)for(var n=this.dynamicData.VBO.dynamicMap,w=c.faceNormIdx,t=0,x=b.length;t<x;t++)for(var F=n.segmentMap[b[t]],A=0,E=F.length;A<E;A++){a=F[A];D=this.faces[a];r=D.normal;
u=w[a];for(j=0;3>j;j++){s=D.point_normals[j];f=r[0];m=r[1];o=r[2];v=c.faceCount[3*a+j];e=0;for(iMax=v;e<iMax;e++)d=c.faceNorm[u+e],d=this.faces[d],d=d.normal,f+=d[0],m+=d[1],o+=d[2];v?(e=v+1,f/=e,m/=e,o/=e,e=Math.sqrt(f*f+m*m+o*o),f/=e,m/=e,o/=e,s[0]=f,s[1]=m,s[2]=o):h++}}else{a=0;for(b=this.faces.length;a<b;a++){D=this.faces[a];r=D.normal;for(j=0;3>j;j++){s=D.point_normals[j];f=r[0];m=r[1];o=r[2];v=c.faceCount[n++];e=0;for(iMax=v;e<iMax;e++)d=c.faceNorm[u++],d=this.faces[d],d=d.normal,f+=d[0],m+=
d[1],o+=d[2];v?(e=v+1,f/=e,m/=e,o/=e,e=Math.sqrt(f*f+m*m+o*o),f/=e,m/=e,o/=e,s[0]=f,s[1]=m,s[2]=o):h++}}}return this}},removeDoubles:function(c){var g=[],a=[],b,e,d,f;b=0;for(e=this.points.length;b<e;b++){var m=-1,o=this.points[b];d=0;for(f=g.length;d<f;d++)if(h.vec3.equal(o,g[d],c)){m=d;break}-1!=m?a[b]=m:(a[b]=g.length,g.push(this.points[b]))}this.points=g;b=0;for(e=this.faces.length;b<e;b++){c=this.faces[b];d=0;for(f=c.points.length;d<f;d++)c.points[d]=a[c.points[d]]}return this},buildEdges:function(){var c,
g,a,b,e=[],d=[];c=0;for(a=this.faces.length;c<a;c++){var f=this.faces[c];g=0;for(b=f.points.length;g<b;g++){var m,o,s;s=f.segment;matId=f.material;g?(o=f.points[g],m=f.points[g-1]):(o=f.points[g],m=f.points[b-1]);e[m]=e[m]||{};e[m][matId]=e[m][matId]||{};e[m][matId][s]=e[m][matId][s]||{};!e[m][matId][s][o]&&(!e[o]||!e[o][matId][s][m])&&d.push([matId,s,m,o])}}this.edges=d;return this},subdivide:function(c,g){var a=h.vec3,g=g===q?!0:g;c===q&&(c=1);if(0!==c){var b,e,d,f,m,o={},s=[],D=[],v=this.points.length,
u=this.faces.length,n=[],B=[],C=[],w=[];b=0;for(d=u;b<d;b++)if(m=this.faces[b],m.points&&(3===m.points.length||4===m.points.length)){var t=[0,0,0];e=0;for(f=m.points.length;e<f;e++){var x=this.points[m.points[e]];t[0]+=x[0];t[1]+=x[1];t[2]+=x[2]}t[0]/=f;t[1]/=f;t[2]/=f;n[b]=this.addPoint(t);if(m.uvs.length===m.points.length){t=[0,0];e=0;for(f=m.uvs.length;e<f;e++)x=m.uvs[e],t[0]+=x[0],t[1]+=x[1];t[0]/=f;t[1]/=f;B[b]=t}if(m.point_colors.length===m.points.length){t=[0,0,0];e=0;for(f=m.point_colors.length;e<
f;e++)x=m.point_colors[e],t[0]+=x[0],t[1]+=x[1],t[2]+=x[2];t[0]/=f;t[1]/=f;t[2]/=f;C[b]=t}if(m.point_normals.length===m.points.length){t=[0,0,0];e=0;for(f=m.point_normals.length;e<f;e++)x=m.point_normals[e],t[0]+=x[0],t[1]+=x[1],t[2]+=x[2];t[0]/=f;t[1]/=f;t[2]/=f;w[b]=t}}b=0;for(d=this.faces.length;b<d;b++){m=this.faces[b];e=0;for(f=m.points.length;e<f;e++){var F,A;e?(F=e,A=e-1):(F=e,A=f-1);x=m.points[F];t=m.points[A];o[t]=o[t]||{};s[t]=s[t]||[];s[t].push(b);o[t][x]={face:b,a:t,b:x,fpa:F,fpb:A}}}for(b in o)if(o.hasOwnProperty(b))for(e in o[b])if(o[b].hasOwnProperty(e)){d=
o[b][e];m=o[e][b];if(m===q){r("Mesh.subdivide error. Hole at face #"+d.face+", Edge:["+d.fpa+"->"+d.fpb+"], holes not yet supported; perhaps use Mesh.removeDoubles()?");return}d.edge_point||(f=a.multiply(a.add(this.points[d.a],this.points[d.b]),0.5),g?(t=a.multiply(a.add(this.points[n[d.face]],this.points[n[m.face]]),0.5),d.edge_point=a.multiply(a.add(f,t),0.5)):d.edge_point=f,m.edge_point=d.edge_point,d.edge_avg=f,m.edge_avg=f,d.ep_idx=this.addPoint(d.edge_point),m.ep_idx=d.ep_idx);D[d.a]=D[d.a]||
[];D[d.a].push(d.edge_avg);f=this.faces[d.face].uvs;f.length&&(m=f[d.fpa],f=f[d.fpb],d.uv=[(m[0]+f[0])/2,(m[1]+f[1])/2]);m=this.faces[d.face].point_colors;m.length&&(d.color=a.multiply(a.add(m[d.fpa],m[d.fpb]),0.5));m=this.faces[d.face].point_normals;m.length&&(d.normal=a.normalize(a.multiply(a.add(m[d.fpa],m[d.fpb]),0.5)))}if(g){m=[];b=0;for(d=v;b<d;b++)if(t=[0,0,0],s[b]){e=0;for(f=s[b].length;e<f;e++)x=this.points[n[s[b][e]]],t[0]+=x[0],t[1]+=x[1],t[2]+=x[2];t[0]/=f;t[1]/=f;t[2]/=f;m[b]=t}t=[];
b=0;for(d=v;b<d;b++)if(x=[0,0,0],D[b]){e=0;for(f=D[b].length;e<f;e++)F=D[b][e],x[0]+=F[0],x[1]+=F[1],x[2]+=F[2];x[0]/=f;x[1]/=f;x[2]/=f;t[b]=x}b=0;for(d=v;b<d;b++)s[b]&&(v=s[b].length,e=1/v,D=2/v,v=a.multiply(this.points[b],(v-3)/v),v=a.add(v,a.multiply(m[b],e)),v=a.add(v,a.multiply(t[b],D)),this.points[b]=v)}for(b=0;b<u;b++)if(m=this.faces[b],!(3!==m.points.length&&4!==m.points.length))if(a=m.points.slice(0),s=m.uvs.slice(0),e=m.point_colors.slice(0),D=m.point_normals.slice(0),v=s.length===a.length,
d=e.length===a.length,f=D.length===a.length,m=m.material,3===a.length){if(this.setFaceMaterial(m),t=o[a[0]][a[1]],x=o[a[2]][a[0]],this.addFace([a[0],t.ep_idx,n[b],x.ep_idx],b),v&&(this.faces[b].uvs=[s[0],t.uv,B[b],x.uv]),d&&(this.faces[b].point_colors=[e[0],t.color,C[b],x.color]),f&&(this.faces[b].point_normals=[D[0],t.normal,w[b],x.normal]),t=o[a[1]][a[2]],x=o[a[0]][a[1]],m=this.addFace([a[1],t.ep_idx,n[b],x.ep_idx]),v&&(this.faces[m].uvs=[s[1],t.uv,B[b],x.uv]),d&&(this.faces[m].point_colors=[e[1],
t.color,C[b],x.color]),f&&(this.faces[m].point_normals=[D[1],t.normal,w[b],x.normal]),t=o[a[2]][a[0]],x=o[a[1]][a[2]],m=this.addFace([a[2],t.ep_idx,n[b],x.ep_idx]),v&&(this.faces[m].uvs=[s[2],t.uv,B[b],x.uv]),d&&(this.faces[m].point_colors=[e[2],t.color,C[b],x.color]),f)this.faces[m].point_normals=[D[2],t.normal,w[b],x.normal]}else if(this.setFaceMaterial(m),t=o[a[0]][a[1]],x=o[a[3]][a[0]],this.addFace([a[0],t.ep_idx,n[b],x.ep_idx],b),v&&(this.faces[b].uvs=[s[0],t.uv,B[b],x.uv]),d&&(this.faces[b].point_colors=
[e[0],t.color,C[b],x.color]),f&&(this.faces[b].point_normals=[D[0],t.normal,w[b],x.normal]),t=o[a[1]][a[2]],x=o[a[0]][a[1]],m=this.addFace([a[1],t.ep_idx,n[b],x.ep_idx]),v&&(this.faces[m].uvs=[s[1],t.uv,B[b],x.uv]),d&&(this.faces[m].point_colors=[e[1],t.color,C[b],x.color]),f&&(this.faces[m].point_normals=[D[1],t.normal,w[b],x.normal]),t=o[a[2]][a[3]],x=o[a[1]][a[2]],m=this.addFace([a[2],t.ep_idx,n[b],x.ep_idx]),v&&(this.faces[m].uvs=[s[2],t.uv,B[b],x.uv]),d&&(this.faces[m].point_colors=[e[2],t.color,
C[b],x.color]),f&&(this.faces[m].point_normals=[D[2],t.normal,w[b],x.normal]),t=o[a[3]][a[0]],x=o[a[2]][a[3]],m=this.addFace([a[3],t.ep_idx,n[b],x.ep_idx]),v&&(this.faces[m].uvs=[s[3],t.uv,B[b],x.uv]),d&&(this.faces[m].point_colors=[e[3],t.color,C[b],x.color]),f)this.faces[m].point_normals=[D[3],t.normal,w[b],x.normal];c--;if(0!==c)this.subdivide(c,g);else return this}},removeInternals:function(){var c,g,a,b,e,d={},f=this.faces.length,m,o,s,n;c=0;for(a=this.faces.length;c<a;c++){e=this.faces[c];g=
0;for(b=e.points.length;g<b;g++)g?(s=g,n=g-1):(s=g,n=b-1),m=e.points[s],o=e.points[n],d[m]=d[m]||{},d[m][o]===q?d[m][o]=[c]:d[m][o].push(c)}a=function(a){return-1!==d[o][m].indexOf(a)};for(c=0;c<f;c++){e=this.faces[c];var v=null;g=0;for(b=e.points.length;g<b;g++)g?(s=g,n=g-1):(s=g,n=b-1),m=e.points[s],o=e.points[n],v=v?v.filter(a):d[o][m];v.length&&(this.faces.splice(c,1),f--,c--)}return this},prepare:function(c){c===q&&(c=!0);this.buildWireframe&&!this.triangulateWireframe&&this.buildEdges();this.triangulateQuads().calcNormals();
this.buildWireframe&&this.triangulateWireframe&&this.buildEdges();this.compile();c&&!this.dynamic&&this.clean();return this},clean:function(){var c,g;c=0;for(g=this.points.length;c<g;c++)delete this.points[c],this.points[c]=null;this.points=[];c=0;for(g=this.faces.length;c<g;c++)delete this.faces[c].points,delete this.faces[c].point_normals,delete this.faces[c].uvs,delete this.faces[c].normal,delete this.faces[c],this.faces[c]=null;this.faces=[];return this},compileMap:function(c){var g=h.vec3,a=
h.vec2;c===q&&(c=1.0E-5);var b={segments:[],bounds:[]},e=[],d,f,m,o,s,n,v,u;this.materials.length||this.materials.push(new h.Material);d=0;for(n=this.materials.length;d<n;d++)e[d]=[];d=0;for(n=this.faces.length;d<n;d++)3===this.faces[d].points.length&&(m=this.faces[d].material,o=this.faces[d].segment,e[m][o]===q&&(e[m][o]=[],b.segments.push(o)),e[m][o].push(d));var z=[],B=0,r=!1,w=!1,t=!1,x;d=0;for(n=e.length;d<n;d++)for(f in e[d])if(e[d].hasOwnProperty(f))for(m=0;m<e[d][f].length;m++)x=e[d][f][m],
r=r||0!==this.faces[x].uvs.length,w=w||0!==this.faces[x].point_normals.length,t=t||0!==this.faces[x].point_colors.length;if(r)for(d=0;d<this.faces.length;d++)if(!this.faces[d].uvs.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].uvs.push([0,0]);if(w)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_normals.length)for(f=0;f<this.faces[d].points.length;f++)this.faces[d].point_normals.push([0,0,0]);if(t)for(d=0;d<this.faces.length;d++)if(!this.faces[d].point_colors.length)for(f=0;f<
this.faces[d].points.length;f++)this.faces[d].point_colors.push([0,0,0]);d=0;for(n=e.length;d<n;d++)for(f in e[d])if(e[d].hasOwnProperty(f)){m=0;for(v=e[d][f].length;m<v;m++){x=e[d][f][m];for(o=0;3>o;o++){var F=this.faces[x].points[o],A=-1;if(z[F]!==q){s=0;for(u=z[F].length;s<u;s++){var E=z[F][s][0],y=z[F][s][1],A=z[F][s][2];w&&(A=g.equal(this.faces[E].point_normals[y],this.faces[x].point_normals[o],c)?A:-1);r&&(A=a.equal(this.faces[E].uvs[y],this.faces[x].uvs[o],c)?A:-1);t&&(A=g.equal(this.faces[E].point_colors[y],
this.faces[x].point_colors[o],c)?A:-1)}}-1!==A?(b.elements===q&&(b.elements=[]),b.elements[d]===q&&(b.elements[d]=[]),b.elements[d][f]===q&&(b.elements[d][f]=[]),b.elements[d][f].push(A)):(b.points===q&&(b.points=[]),b.points.push(F),0===b.bounds.length?(b.bounds[0]=[this.points[F][0],this.points[F][1],this.points[F][2]],b.bounds[1]=[this.points[F][0],this.points[F][1],this.points[F][2]]):(this.points[F][0]<b.bounds[0][0]&&(b.bounds[0][0]=this.points[F][0]),this.points[F][1]<b.bounds[0][1]&&(b.bounds[0][1]=
this.points[F][1]),this.points[F][2]<b.bounds[0][2]&&(b.bounds[0][2]=this.points[F][2]),this.points[F][0]>b.bounds[1][0]&&(b.bounds[1][0]=this.points[F][0]),this.points[F][1]>b.bounds[1][1]&&(b.bounds[1][1]=this.points[F][1]),this.points[F][2]>b.bounds[1][2]&&(b.bounds[1][2]=this.points[F][2])),w&&(b.normals===q&&(b.normals=[]),b.normals.push([x,o])),t&&(b.colors===q&&(b.colors=[]),b.colors.push([x,o])),r&&(b.uvs===q&&(b.uvs=[]),b.uvs.push([x,o])),b.elements===q&&(b.elements=[]),b.elements[d]===q&&
(b.elements[d]=[]),b.elements[d][f]===q&&(b.elements[d][f]=[]),b.elements[d][f].push(B),z[F]===q&&(z[F]=[]),z[F].push([x,o,B]),B++)}}}if(this.edges){b.line_elements=[];d=0;for(n=this.edges.length;d<n;d++)g=this.edges[d],m=g[0],o=g[1],c=g[2],g=g[3],b.line_elements[m]=b.line_elements[m]||[],b.line_elements[m][o]=b.line_elements[m][o]||[],b.line_elements[m][o].push(z[c][0][2]),b.line_elements[m][o].push(z[g][0][2])}b.dynamic=this.dynamic;return b},compileVBO:function(c,g,a,b,e,d,f,m){"object"==typeof g?
(g=g.element!==q?g.element:!0,a=g.vertex!==q?g.vertex:!0,d=g.color!==q?g.color:!0,b=g.normal!==q?g.normal:!0,e=g.uv!==q?g.uv:!0,f=g.lines!==q?g.lines:!!c.line_elements,m=g.dynamic!==q?g.dynamic:c.dynamic):(g===q&&(g=!0),a===q&&(a=!0),d===q&&(d=!0),b===q&&(b=!0),e===q&&(e=!0),f===q&&(f=!!c.line_elements),m===q&&(m=c.dynamic));var o={},s,n,v,u,h;m&&(u={points:new Int16Array(c.points.length),face_points:new Int16Array(2*c.points.length),segments:null},o.dynamicMap=u,o.dynamic=!0);if(c.points&&a){s=c.points.length;
o.vbo_points=new Float32Array(3*s);for(a=0;a<s;a++)n=c.points[a],o.vbo_points[3*a]=this.points[n][0],o.vbo_points[3*a+1]=this.points[n][1],o.vbo_points[3*a+2]=this.points[n][2],m&&(u.points[a]=n)}if(m){h=c.normals||c.colors||c.uvs;a=0;for(s=h.length;a<s;a++)n=h[a],u.face_points[2*a]=n[0],u.face_points[2*a+1]=n[1]}if(c.normals&&b){s=c.normals.length;o.vbo_normals=new Float32Array(3*s);for(a=b=0;a<s;a++)n=c.normals[a],o.vbo_normals[b++]=this.faces[n[0]].point_normals[n[1]][0],o.vbo_normals[b++]=this.faces[n[0]].point_normals[n[1]][1],
o.vbo_normals[b++]=this.faces[n[0]].point_normals[n[1]][2]}if(c.colors&&d){s=c.colors.length;o.vbo_colors=new Float32Array(3*s);for(a=b=0;a<s;a++)n=c.colors[a],o.vbo_colors[b++]=this.faces[n[0]].point_colors[n[1]][0],o.vbo_colors[b++]=this.faces[n[0]].point_colors[n[1]][1],o.vbo_colors[b++]=this.faces[n[0]].point_colors[n[1]][2]}if(c.uvs&&e){s=c.uvs.length;o.vbo_uvs=new Float32Array(2*s);for(a=b=0;a<s;a++)n=c.uvs[a],o.vbo_uvs[b++]=this.faces[n[0]].uvs[n[1]][0],o.vbo_uvs[b++]=this.faces[n[0]].uvs[n[1]][1]}if(g){o.elements_ref=
[];o.vbo_elements=[];a=0;for(s=c.elements.length;a<s;a++)for(v in o.elements_ref[a]=[],g=0,c.elements[a])if(c.elements[a].hasOwnProperty(v)){b=c.elements[a][v];e=0;for(d=b.length;e<d;e++)o.vbo_elements.push(b[e]);o.elements_ref[a][g]=[v|0,b.length|0];g++}o.vbo_elements=new Uint16Array(o.vbo_elements)}if(f){o.line_elements_ref=[];o.vbo_line_elements=[];a=0;for(s=c.line_elements.length;a<s;a++)for(v in o.line_elements_ref[a]=[],g=0,c.line_elements[a])if(c.line_elements[a].hasOwnProperty(v)){b=c.line_elements[a][v];
e=0;for(d=b.length;e<d;e++)o.vbo_line_elements.push(b[e]);o.line_elements_ref[a][g]=[v|0,b.length|0];g++}o.vbo_line_elements=new Uint16Array(o.vbo_line_elements)}o.segments=c.segments;o.bounds=c.bounds;if(m&&1<c.segments.length){c=[];h=u.points;a=0;for(s=h.length;a<s;a++)f=this.faces[u.face_points[2*a]].segment||0,c[f]===q&&(c[f]=[]),c[f].push(a);o.dynamicMap.segmentMap=c}return o},updateVBO:function(c,g){if(!c.dynamic)return!1;var a,b,e=c.dynamicMap,d=g.points&&!!c.vbo_points,f=g.normals&&!!c.vbo_normals,
m=g.uvs&&!!c.vbo_uvs,o=g.colors&&!!c.vbo_colors;b=g.segments;var s,n,v;if(g.segments!==q)for(var u=0,h=b.length;u<h;u++)for(var B=e.segmentMap[b[u]],r=0,w=B.length;r<w;r++){if(a=B[r],n=this.faces[e.face_points[2*a]],v=e.face_points[2*a+1],d&&(s=this.points[e.points[a]],c.vbo_points[3*a]=s[0],c.vbo_points[3*a+1]=s[1],c.vbo_points[3*a+2]=s[2]),f&&(s=n.point_normals[v],c.vbo_normals[3*a]=s[0],c.vbo_normals[3*a+1]=s[1],c.vbo_normals[3*a+2]=s[2]),o&&(s=n.point_colors[v],c.vbo_colors[3*a]=s[0],c.vbo_colors[3*
a+1]=s[1],c.vbo_colors[3*a+2]=s[2]),m)s=n.uvs[v],c.vbo_uvs[2*a]=s[0],c.vbo_uvs[2*a+1]=s[1]}else{a=0;for(b=e.points.length;a<b;a++)if(n=this.faces[e.face_points[2*a]],v=e.face_points[2*a+1],d&&(s=this.points[e.points[a]],c.vbo_points[3*a]=s[0],c.vbo_points[3*a+1]=s[1],c.vbo_points[3*a+2]=s[2]),f&&(s=n.point_normals[v],c.vbo_normals[3*a]=s[0],c.vbo_normals[3*a+1]=s[1],c.vbo_normals[3*a+2]=s[2]),o&&(s=n.point_colors[v],c.vbo_colors[3*a]=s[0],c.vbo_colors[3*a+1]=s[1],c.vbo_colors[3*a+2]=s[2]),m)s=n.uvs[v],
c.vbo_uvs[2*a]=s[0],c.vbo_uvs[2*a+1]=s[1]}return this},rebufferVBO:function(c,g,a){var b=n.gl;a.points&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_points),b.bufferData(b.ARRAY_BUFFER,c.vbo_points,b.DYNAMIC_DRAW));a.normals&&c.vbo_normals&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_normals),b.bufferData(b.ARRAY_BUFFER,c.vbo_normals,b.DYNAMIC_DRAW));a.uvs&&c.vbo_uvs&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_uvs),b.bufferData(b.ARRAY_BUFFER,c.vbo_uvs,b.DYNAMIC_DRAW));a.colors&&c.vbo_colors&&(b.bindBuffer(b.ARRAY_BUFFER,g.gl_colors),
b.bufferData(b.ARRAY_BUFFER,c.vbo_colors,b.DYNAMIC_DRAW));b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null);return this},bufferVBO:function(c,g){var a=n.gl,b={};g===q&&(g={});b.gl_points=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b.gl_points);a.bufferData(a.ARRAY_BUFFER,c.vbo_points,a.STATIC_DRAW);c.vbo_normals?(b.gl_normals=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_normals),a.bufferData(a.ARRAY_BUFFER,c.vbo_normals,a.STATIC_DRAW)):b.gl_normals=g.gl_normals?g.gl_normals:null;c.vbo_uvs?(b.gl_uvs=
a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_uvs),a.bufferData(a.ARRAY_BUFFER,c.vbo_uvs,a.STATIC_DRAW)):b.gl_uvs=g.gl_uvs?g.gl_uvs:null;c.vbo_colors?(b.gl_colors=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,b.gl_colors),a.bufferData(a.ARRAY_BUFFER,c.vbo_colors,a.STATIC_DRAW)):b.gl_colors=g.gl_colors?g.gl_colors:null;!c.vbo_elements&&g.gl_elements?(b.gl_elements=g.gl_elements,b.elements_ref=g.elements_ref):(b.gl_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,
c.vbo_elements,a.STATIC_DRAW),b.elements_ref=c.elements_ref);!c.vbo_line_elements&&g.gl_line_elements?(b.gl_line_elements=g.gl_line_elements,b.line_elements_ref=g.line_elements_ref):(b.gl_line_elements=a.createBuffer(),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,b.gl_line_elements),a.bufferData(a.ELEMENT_ARRAY_BUFFER,c.vbo_line_elements,a.STATIC_DRAW),b.line_elements_ref=c.line_elements_ref);b.segments=c.segments;b.bounds=c.bounds;a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null);return b},update:function(c){var c=
c||{},g=c.points||c.point||c.vertex||c.vertices||c.all||!0,a=c.uvs||c.uv||c.texture||c.all||!1,b=c.normals||c.normal||c.all||!0,e=c.colors||c.color||c.all||!1,c=c.segments||c.segment;c!==q&&c.length===q&&(c=[c]);if(!this.dynamic)return r("Mesh not defined as dynamic, cannot update."),!1;b&&this.normalMapRef&&this.recalcNormals(q,{segments:c});g={points:g,uvs:a,normals:b,colors:e,segments:c};this.updateVBO(this.dynamicData.VBO,g);this.rebufferVBO(this.dynamicData.VBO,this.dynamicData.buffer,g)},bindBuffer:function(c){null===
this.originBuffer&&(this.originBuffer=c);this.compiled=c;this.segment_state=[];for(var g=0,a=c.segments.length;g<a;g++)this.segment_state[c.segments[g]]=!0;this.bb=c.bounds},compile:function(c){if(0<this.faces.length&&0<this.points.length){var c=this.compileVBO(this.compileMap(c)),g=this.bufferVBO(c);this.bindBuffer(g);if(this.dynamic){this.sourcePoints=[];for(var a=0,b=this.points.length;a<b;a++)this.sourcePoints[a]=this.points[a].slice(0);this.dynamicData={VBO:c,buffer:g}}}return this},addMorphTarget:function(c){null===
this.morphTargets&&(this.morphTargets=[]);this.morphTargets.push(c)},setMorphSource:function(c){this.morphSourceIndex!==c&&(this.morphSourceIndex=c,this.bindBuffer(this.morphTargets[c]))},setMorphTarget:function(c){this.morphTargetIndex!==c&&(this.morphTargetIndex=c,this.morphTarget=this.morphTargets[c])},setMorphWeight:function(c){this.morphWeight=c},morphTargetCount:function(){return null!==this.morphTargets?this.morphTargets.length:0}};return{Mesh:w,Face:y}});
CubicVR.RegisterModule("UVMapper",function(h){function y(a){a=h.get(a)||{};this.rotation=a.rotation===w?[0,0,0]:a.rotation;this.scale=a.scale===w?[1,1,1]:a.scale;this.center=a.center===w?[0,0,0]:a.center;this.projection_mode=a.projectionMode===w?q.uv.projection.PLANAR:h.parseEnum(q.uv.projection,a.projectionMode);this.projection_axis=a.projectionAxis===w?q.uv.axis.X:h.parseEnum(q.uv.axis,a.projectionAxis);this.wrap_w_count=a.wrapW===w?1:a.wrapW;this.wrap_h_count=a.wrapH===w?1:a.wrapH}var w=h.undef,
q=h.enums,n=2*Math.PI,r=Math.PI/2;q.uv={axis:{X:0,Y:1,Z:2},projection:{UV:0,PLANAR:1,CYLINDRICAL:2,SPHERICAL:3,CUBIC:4,SKY:5}};var c=function(a,b,e){return 0===a&&0===e?0:0===e?0>a?r:-r:0>e?-Math.atan(a/e)+Math.PI:-Math.atan(a/e)},g=function(a,b,e){var d;0===a&&0===e?(d=0,a=0!==b?0>b?-r:r:0):(d=0===e?0>a?r:-r:0>e?-Math.atan(a/e)+Math.PI:-Math.atan(a/e),a=Math.sqrt(a*a+e*e),a=0===a?0>b?-r:r:Math.atan(b/a));return[d,a]};y.prototype={setRotation:function(a){this.rotation=a},setScale:function(a){this.scale=
a},setCenter:function(a){this.center=a},setProjectionAxis:function(a){this.projection_axis=a},setProjectionMode:function(a){this.projection_mode=a},setWrapW:function(a){this.wrap_w_count=a},setWrapH:function(a){this.wrap_h_count=a},apply:function(a,b,e,d,f){var m=h.mat4,o,s,D,v,u,z=new h.Transform,B=!1,C=null;if(this.center[0]||this.center[1]||this.center[2])z.translate(-this.center[0],-this.center[1],-this.center[2]),B=!0;if(this.rotation[0]||this.rotation[1]||this.rotation[2])this.rotation[0]&&
z.rotate(this.rotation[2],0,0,1),this.rotation[1]&&z.rotate(this.rotation[1],0,1,0),this.rotation[2]&&z.rotate(this.rotation[0],1,0,0),B=!0;B&&(C=z.getResult());"object"===typeof b&&(b=a.materials.indexOf(b));var z=0,H=a.faces.length;d&&(z=d);for(f&&(H=f+1);z<H;z++)if(a.faces[z].material===b&&!(e!==w&&a.faces[z].segment!==e)){var t,x,F;if(this.projection_mode===q.uv.projection.CUBIC||this.projection_mode===q.uv.projection.SKY)t=Math.abs(a.faces[z].normal[0]),x=Math.abs(a.faces[z].normal[1]),F=Math.abs(a.faces[z].normal[2]);
for(var d=[],f=0,A=a.faces[z].points.length;f<A;f++){s=a.faces[z].points[f];var E=a.faces[z].points[(f+1)%3],y=a.faces[z].points[(f+2)%3];o=a.points[s];var G=a.points[E],J=a.points[y],L;B&&(o=m.vec3_multiply(o,C));L=this.projection_mode;if(L===q.uv.projection.SKY)s=a.sky_mapping,t>=x&&t>=F&&(D=o[2]/this.scale[2]+this.scale[2]/2,v=-o[1]/this.scale[1]+this.scale[1]/2,0>a.faces[z].normal[0]?(D=(s[2][2]-s[2][0])*(1-D),v=1-(s[2][3]-s[2][1])*v,D+=s[2][0],v+=s[2][1]):(D*=s[3][2]-s[3][0],v=1-(s[3][3]-s[3][1])*
v,D+=s[3][0],v+=s[3][1])),x>=t&&x>=F&&(D=o[0]/this.scale[0]+this.scale[0]/2,v=-o[2]/this.scale[2]+this.scale[2]/2,0>a.faces[z].normal[1]?(D*=s[1][2]-s[1][0],v=1-(s[1][3]-s[1][1])*v,D+=s[1][0],v-=s[1][1]):(D*=s[0][2]-s[0][0],v=1-(s[0][3]-s[0][1])*v,D+=s[0][0],v-=s[0][1])),F>=t&&F>=x&&(D=o[0]/this.scale[0]+this.scale[0]/2,v=o[1]/this.scale[1]+this.scale[1]/2,0>a.faces[z].normal[2]?(D*=s[4][2]-s[4][0],v=1-(s[4][3]-s[4][1])*(1-v),D+=s[4][0],v-=s[4][1]):(D=(s[5][2]-s[5][0])*(1-D),v=1-(s[5][3]-s[5][1])*
(1-v),D+=s[5][0],v+=s[5][1])),a.faces[z].setUV([D,v],f);else if(L===q.uv.projection.CUBIC)t>=x&&t>=F&&(D=o[2]/this.scale[2]+0.5,v=o[1]/this.scale[1]+0.5),x>=t&&x>=F&&(D=-o[0]/this.scale[0]+0.5,v=o[2]/this.scale[2]+0.5),F>=t&&F>=x&&(D=-o[0]/this.scale[0]+0.5,v=o[1]/this.scale[1]+0.5),0<a.faces[z].normal[0]&&(D=-D),0>a.faces[z].normal[1]&&(D=-D),0<a.faces[z].normal[2]&&(D=-D),a.faces[z].setUV([D,v],f);else if(L===q.uv.projection.PLANAR)D=this.projection_axis===q.uv.axis.X?o[2]/this.scale[2]+0.5:-o[0]/
this.scale[0]+0.5,v=this.projection_axis===q.uv.axis.Y?o[2]/this.scale[2]+0.5:o[1]/this.scale[1]+0.5,a.faces[z].setUV([D,v],f);else{if(L===q.uv.projection.CYLINDRICAL)L=this.projection_axis,L===q.uv.axis.X?(u=c(o[2],o[0],-o[1]),v=-o[0]/this.scale[0]+0.5):L===q.uv.axis.Y?(u=c(-o[0],o[1],o[2]),v=-o[1]/this.scale[1]+0.5):L===q.uv.axis.Z&&(u=c(-o[0],o[2],-o[1]),v=-o[2]/this.scale[2]+0.5),u=1-u/n,1!==this.wrap_w_count&&(u*=this.wrap_w_count),o=u,s=v;else if(L===q.uv.projection.SPHERICAL){var M,K,N;L=this.projection_axis;
L===q.uv.axis.X?(M=d[s]?d[s]:g(o[2],o[0],-o[1]),d[s]||(d[s]=M),K=d[E]?d[E]:g(G[2],G[0],-G[1]),d[E]||(d[E]=K),N=d[y]?d[y]:g(J[2],J[0],-J[1]),d[y]||(d[y]=N)):L===q.uv.axis.Y?(M=d[s]?d[s]:g(o[0],-o[1],o[2]),d[s]||(d[s]=M),K=d[E]?d[E]:g(G[0],-G[1],G[2]),d[E]||(d[E]=K),N=d[y]?d[y]:g(J[0],-J[1],J[2]),d[y]||(d[y]=N)):L===q.uv.axis.Z&&(M=d[s]?d[s]:g(-o[0],o[2],-o[1]),d[s]||(d[s]=M),K=d[E]?d[E]:g(-G[0],G[2],-G[1]),d[E]||(d[E]=K),N=d[y]?d[y]:g(-J[0],J[2],-J[1]),d[y]||(d[y]=N));Math.abs(M[0]-K[0])>r&&Math.abs(M[0]-
N[0])>r&&(M[0]=M[0]>K[0]&&M[0]>N[0]?M[0]-n:M[0]+n);Math.abs(M[1]-K[1])>r&&Math.abs(M[1]-N[1])>r&&(M[1]=M[1]>K[1]&&M[1]>N[1]?M[1]-n:M[1]+n);u=1-M[0]/n;s=0.5-M[1]/Math.PI;1!==this.wrap_w_count&&(u*=this.wrap_w_count);1!==this.wrap_h_count&&(s*=this.wrap_h_count);o=u}else s=o=0;a.faces[z].setUV([o,s],f)}}}return this}};return{UVMapper:y}});
CubicVR.RegisterModule("Renderer",function(h){var y=h.undef;return{renderObject:function(w,q,n,r,c,g,a){var b=!1,c=c||!1,g=g||!1;if(null!==w.compiled){var e=0,d=h.GLCore.gl,f,m=r===y?0:r.length,o,s=0,D,v=null,u=w.instanceMaterials||w.materials,z=(a=(w.wireframe||a)&&w.compiled.line_elements_ref)?w.compiled.line_elements_ref:w.compiled.elements_ref,B=!1,C,H,t;d.depthFunc(d.LEQUAL);n===y&&(n=cubicvr_identity);for(var x=0,F=z.length;x<F;x++){var v=a&&w.wireframeMaterial?w.wireframeMaterial:u[x],A=0,
s=!1;if(1>v.opacity&&c)b=!0;else if(!(g&&1<=v.opacity)){1!==v.opacity?(d.enable(d.BLEND),d.depthMask(0),d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA)):(d.depthMask(1),d.disable(d.BLEND),d.blendFunc(d.ONE,d.ONE));for(var E=0,I=z[x].length;E<I;E++)if(D=z[x][E][0],s=!1,f=z[x][E][1],A+=f,v.visible){if(!w.segment_state[D])if(A>f){e+=2*f;A-=f;if(m){H=!1;for(C=0;C<m;){f=m-C;f>h.MAX_LIGHTS&&(f=h.MAX_LIGHTS);0<C&&!H&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),H=!0);o=r[C];t=o.light_type;
for(s=0;s<f;s++)if(r[s+C].light_type!=t){f=s;break}v.use(o.light_type,f);o=v.shader[o.light_type][f];d.uniformMatrix4fv(o.matrixModelView,!1,q.mvMatrix);d.uniformMatrix4fv(o.matrixProjection,!1,q.pMatrix);d.uniformMatrix4fv(o.matrixObject,!1,n);d.uniformMatrix3fv(o.matrixNormal,!1,q.nMatrix);B||(v.bindObject(w,o),B=-1!=o.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(s=0;s<f;s++)r[s+C].setupShader(o,s);a?d.drawElements(d.LINES,A,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,
A,d.UNSIGNED_SHORT,e);C+=f}H&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else v.use(0,0),d.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,q.mvMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixProjection,!1,q.pMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,n),d.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,q.nMatrix),B||(v.bindObject(w,v.shader[0][0]),B=-1!=v.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?d.drawElements(d.LINES,A,d.UNSIGNED_SHORT,
e):d.drawElements(d.TRIANGLES,A,d.UNSIGNED_SHORT,e);e+=2*A;A=0;s=!0}else e+=2*A,A=0}else e+=2*f,A-=f;if(!s&&w.segment_state[D]&&v.visible){if(m){H=!1;for(C=0;C<m;){f=m-C;f>h.MAX_LIGHTS&&(f=h.MAX_LIGHTS);0<C&&!H&&(d.enable(d.BLEND),d.blendFunc(d.ONE,d.ONE),d.depthFunc(d.EQUAL),H=!0);o=r[C];t=o.light_type;for(s=0;s<f;s++)if(r[s+C].light_type!=t){f=s;break}v.use(o.light_type,f);o=v.shader[o.light_type][f];d.uniformMatrix4fv(o.matrixModelView,!1,q.mvMatrix);d.uniformMatrix4fv(o.matrixProjection,!1,q.pMatrix);
d.uniformMatrix4fv(o.matrixObject,!1,n);d.uniformMatrix3fv(o.matrixNormal,!1,q.nMatrix);B||(v.bindObject(w,o),B=-1!=o.vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements));for(s=0;s<f;s++)r[s+C].setupShader(o,s);a?d.drawElements(d.LINES,A,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,A,d.UNSIGNED_SHORT,e);C+=f}H&&(d.disable(d.BLEND),d.depthFunc(d.LEQUAL))}else v.use(0,0),d.uniformMatrix4fv(v.shader[0][0].matrixModelView,!1,q.mvMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixProjection,
!1,q.pMatrix),d.uniformMatrix4fv(v.shader[0][0].matrixObject,!1,n),d.uniformMatrix3fv(v.shader[0][0].matrixNormal,!1,q.nMatrix),B||(v.bindObject(w,v.shader[0][0]),B=-1!=v.shader[0][0].vertexTexCoord,a&&d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,w.compiled.gl_line_elements)),a?d.drawElements(d.LINES,A,d.UNSIGNED_SHORT,e):d.drawElements(d.TRIANGLES,A,d.UNSIGNED_SHORT,e);e+=2*A}}}v&&o?v.clearObject(w,o):v.clearObject(w,null);d.depthMask(1);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);return b}}}});
CubicVR.RegisterModule("Light",function(h){function y(c,g){var a=h.aabb,c=h.get(c)||{};c===n&&(c=q.light.type.POINT);g===n&&(g=q.light.method.DYNAMIC);"object"==typeof c?(this.light_type=c.type!==n?h.parseEnum(q.light.type,c.type):q.light.type.POINT,this.diffuse=c.diffuse!==n?c.diffuse:[1,1,1],this.specular=c.specular!==n?c.specular:[1,1,1],this.intensity=c.intensity!==n?c.intensity:1,this.position=c.position!==n?c.position:[0,0,0],this.direction=c.direction!==n?c.direction:[0,0,0],this.distance=
c.distance!==n?c.distance:this.light_type===q.light.type.AREA?30:10,this.cutoff=c.cutoff!==n?c.cutoff:60,this.map_res=c.map_res!==n?c.map_res:this.light_type===q.light.type.AREA?2048:512,this.map_res=c.mapRes!==n?c.mapRes:this.map_res,this.method=c.method!==n?h.parseEnum(q.light.method,c.method):g,this.areaCam=c.areaCam!==n?c.areaCam:null,this.areaCeiling=c.areaCeiling!==n?c.areaCeiling:40,this.areaFloor=c.areaFloor!==n?c.areaFloor:-40,this.areaAxis=c.areaAxis!==n?c.areaAxis:[1,1,0],this.projectorTex=
c.projector!==n?c.projector:null):(this.light_type=h.parseEnum(q.light.type,c),this.diffuse=[1,1,1],this.specular=[1,1,1],this.intensity=1,this.position=[0,0,0],this.direction=[0,0,0],this.distance=this.light_type===q.light.type.AREA?30:10,this.cutoff=60,this.map_res=this.light_type===q.light.type.AREA?2048:512,this.method=h.parseEnum(q.light.method,g),this.areaCam=null,this.areaCeiling=40,this.areaFloor=-40,this.areaAxis=[1,1,0],this.projectorTex=null);if(this.projectorTex&&"string"===typeof this.projectorTex){var b=
this.projectorTex;this.projectorTex=h.Textures_ref[b]!==n?h.Textures_obj[h.Textures_ref[b]]:new h.Texture(b)}this.setType(this.light_type);this.lposition=[0,0,0];this.dirty=!0;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.aabb=[[0,0,0],[0,0,0]];a.reset(this.aabb,this.position);this.adjust_octree=h.SceneObject.prototype.adjust_octree;this.motion=null;this.rotation=[0,0,0];(this.light_type===
q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA&&h.features.lightShadows)&&this.setShadow(this.map_res);this.lDir=[0,0,0];this.lPos=[0,0,0];this.parent=null}var w=h.GLCore,q=h.enums,n=h.undef,r=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];q.light={type:{NULL:0,POINT:1,DIRECTIONAL:2,SPOT:3,AREA:4,DEPTH_PACK:5,SPOT_SHADOW:6,SPOT_SHADOW_PROJECTOR:7,MAX:8},method:{GLOBAL:0,STATIC:1,DYNAMIC:2}};y.prototype={get x(){return this.position[0]},set x(c){this.position[0]=
c},get y(){return this.position[1]},set y(c){this.position[1]=c},get z(){return this.position[2]},set z(c){this.position[2]=c},get rotX(){return this.rotation[0]},set rotX(c){this.rotation[0]=c},get rotY(){return this.rotation[1]},set rotY(c){this.rotation[1]=c},get rotZ(){return this.rotation[2]},set rotZ(c){this.rotation[2]=c},get dirX(){return this.direction[0]},set dirX(c){this.direction[0]=c},get dirY(){return this.direction[1]},set dirY(c){this.direction[1]=c},get dirZ(){return this.direction[2]},
set dirZ(c){this.direction[2]=c},get pos(){return this.position.slice(0)},set pos(c){this.position=c.slice(0)},get rot(){return this.rotation.slice(0)},set rot(c){this.rotation=c.slice(0)},get dir(){return this.direction.slice(0)},set dir(c){this.direction=vec3.normalize(c.slice(0))},setType:function(c){if(c===q.light.type.AREA&&!h.features.lightShadows)this.dummyCam=new h.Camera,this.areaCam=new h.Camera,this.updateAreaLight(),this.areaCam=this.dummyCam=null,c=q.light.type.DIRECTIONAL;else if((c===
q.light.type.SPOT_SHADOW||c===q.light.type.SPOT_SHADOW_PROJECTOR)&&!h.features.lightShadows)c=q.light.type.SPOT;this.light_type=c},setParent:function(c){this.parent=c},setMethod:function(c){this.method=c},setDiffuse:function(c){this.diffuse=c},setSpecular:function(c){this.specular=c},setIntensity:function(c){this.intensity=c},setPosition:function(c){this.position=c},setDistance:function(c){this.distance=c},setCutoff:function(c){this.cutoff=c},prepare:function(c){var g=h.mat4,a=h.mat3,b=this.light_type;
this.parent?b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR?(b=g.inverse_mat3(this.parent.tMatrix),a.transpose_inline(b),this.lDir=a.vec3_multiply(this.direction,b),this.lDir=a.vec3_multiply(this.lDir,c.nMatrix),this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))):b===q.light.type.POINT&&(this.lPos=g.vec3_multiply(this.position,g.multiply(c.mvMatrix,this.parent.tMatrix))):b===q.light.type.DIRECTIONAL?this.lDir=a.vec3_multiply(this.direction,
c.nMatrix):b===q.light.type.SPOT||b===q.light.type.SPOT_SHADOW||b===q.light.type.SPOT_SHADOW_PROJECTOR?(this.lDir=a.vec3_multiply(this.direction,c.nMatrix),this.lPos=g.vec3_multiply(this.position,c.mvMatrix)):b===q.light.type.POINT?this.lPos=g.vec3_multiply(this.position,c.mvMatrix):b===q.light.type.AREA&&(this.lDir=a.vec3_multiply(this.direction,c.nMatrix))},control:function(c,g,a){c===q.motion.POS?this.position[g]=a:c===q.motion.INTENSITY&&(this.intensity=a)},getAABB:function(){var c=h.vec3,g=h.aabb,
a=[[0,0,0],[0,0,0]];g.engulf(a,[this.distance,this.distance,this.distance]);g.engulf(a,[-this.distance,-this.distance,-this.distance]);a[0]=c.add(a[0],this.position);a[1]=c.add(a[1],this.position);return this.aabb=a},setDirection:function(c,g,a){var b=h.vec3;if("object"===typeof c)this.setDirection(c[0],c[1],c[2]);else return this.direction=b.normalize([c,g,a]),this},lookat:function(c,g,a){var b=h.vec3;if("object"===typeof c)this.lookat(c[0],c[1],c[2]);else return this.direction=b.normalize(b.subtract([c,
g,a],this.position)),this},setRotation:function(c,g,a){var b=h.mat4,e=h.vec3;if("object"===typeof c)this.setRotation(c[0],c[1],c[2]);else{var d=new h.Transform;d.rotate([-c,-g,-a]);d.pushMatrix();this.direction=e.normalize(b.vec3_multiply([1,0,0],d.getResult()));this.rotation=[c,g,a];return this}},setupShader:function(c,g){var a=w.gl;a.uniform3fv(c.lightDiffuse[g],this.diffuse);a.uniform3fv(c.lightSpecular[g],this.specular);this.lPos&&a.uniform3fv(c.lightPosition[g],this.lPos);this.lDir&&a.uniform3fv(c.lightDirection[g],
this.lDir);a.uniform1f(c.lightIntensity[g],this.intensity);a.uniform1f(c.lightDistance[g],this.distance);(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.SPOT)&&a.uniform1f(c.lightCutOffAngle[g],this.cutoff);if(this.light_type===q.light.type.SPOT_SHADOW||this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR||this.light_type===q.light.type.AREA)this.light_type===q.light.type.SPOT_SHADOW_PROJECTOR?(this.shadowMapTex.texture.use(w.gl.TEXTURE0+
2*g),a.uniform1i(c.lightShadowMap[g],2*g),this.projectorTex.use(w.gl.TEXTURE0+2*g+1),a.uniform1i(c.lightProjectionMap[g],2*g+1)):(this.shadowMapTex.texture.use(w.gl.TEXTURE0+g),a.uniform1i(c.lightShadowMap[g],g)),a.uniform3fv(c.lightDepthClip[g],[this.dummyCam.nearclip,this.dummyCam.farclip,1/this.map_res]),a.uniformMatrix4fv(c.lightShadowMatrix[g],!1,this.spMatrix)},setShadow:function(c){h.features.lightShadows&&(this.map_res=c,this.shadowMapTex=new h.RenderBuffer(this.map_res,this.map_res,!0),this.shadowMapTex.texture.setFilter(q.texture.filter.NEAREST),
this.dummyCam=new h.Camera(this.map_res,this.map_res,80,0.1,this.distance),this.dummyCam.calc_nmatrix=!1,this.dummyCam.setTargeted(!0),this.has_shadow=!0)},hasShadow:function(){return has_shadow},setProjector:function(c){this.projectorTex=c},hasProjector:function(){return null!==this.projectorTex?!0:!1},shadowBegin:function(){var c=w.gl,g=h.mat4,a=h.mat3;this.shadowMapTex.use();c.viewport(0,0,this.map_res,this.map_res);c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT);this.light_type!==q.light.type.AREA?
(this.dummyCam.setClip(0.1,this.distance),this.dummyCam.setFOV(this.cutoff)):this.dummyCam.calcProjection();if(this.parent){var b=g.inverse_mat3(this.parent.tMatrix);a.transpose_inline(b);a.vec3_multiply(this.direction,b);g.vec3_multiply(this.position,this.parent.tMatrix);this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);g.multiply(this.dummyCam.mvMatrix.slice(0),
g.inverse(this.parent.tMatrix),this.dummyCam.mvMatrix)}else this.dummyCam.lookat(this.position[0],this.position[1],this.position[2],this.position[0]+10*this.direction[0],this.position[1]+10*this.direction[1],this.position[2]+10*this.direction[2],0,1,0);c.cullFace(c.FRONT)},shadowEnd:function(){var c=w.gl;c.bindFramebuffer(c.FRAMEBUFFER,null);c.cullFace(c.BACK);this.setupTexGen()},setupTexGen:function(){var c=h.mat4;this.spMatrix=c.multiply(r,[0.5,0,0,0,0,0.5,0,0,0,0,0.5,0,0.5,0.5,0.5,1]);this.spMatrix=
c.multiply(this.spMatrix,this.dummyCam.pMatrix);this.spMatrix=c.multiply(this.spMatrix,this.dummyCam.mvMatrix)},setAreaAxis:function(c){this.areaAxis=c},updateAreaLight:function(){var c=h.vec3,g=this.areaCeiling-this.areaFloor;this.dummyCam.ortho=!0;this.dummyCam.setClip(0.01,1);var a=0,a=Math.tan(this.areaCam.fov/2*(Math.PI/180)),b=c.subtract(this.areaCam.target,this.areaCam.position);b[1]=0;b=c.normalize(b);c.normalize(c.cross(b,[0,1,0]));var e=-Math.atan2(b[2],b[0]),a=this.distance/2*Math.abs(a)-
this.distance/2;a<this.distance/3/2&&(a=this.distance/3/2);var b=c.multiply(b,a),a=this.areaAxis[1]*(Math.PI/180),d=Math.tan(this.areaAxis[0]*(Math.PI/180)),a=[Math.tan(a),0,d],e=e-Math.atan2(a[0],a[2]);this.position=c.add(c.add(this.areaCam.position,b),c.multiply(a,g));this.position[1]=this.areaCeiling;this.target=c.add(c.add(this.areaCam.position,b),c.multiply(a,-g));this.target[1]=this.areaFloor;this.direction=c.normalize(c.subtract(this.target,this.position));this.dummyCam.rotation[2]=e*(180/
Math.PI);c=this.dummyCam.farclip*Math.abs(this.direction[1])*g;g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.nearclip);g[0][1]<this.areaCeiling&&Math.abs(this.direction[1]);g=this.orthoBounds(this.position,this.distance,this.distance,this.dummyCam.pMatrix,this.dummyCam.mvMatrix,this.dummyCam.farclip);g[1][1]>this.areaFloor&&(g=g[1][1]-this.areaFloor,c+=g/Math.abs(this.direction[1]));this.dummyCam.nearclip=0.01;this.dummyCam.farclip=
c;this.dummyCam.setOrtho(-this.distance/2,this.distance/2,-this.distance/2,this.distance/2)},orthoBounds:function(c,g,a,b,e,d){var b=h.vec3,f=b.normalize([e[0],e[4],e[8]]),m=b.normalize([e[1],e[5],e[9]]),e=b.normalize(b.cross(m,f)),o;o=a/2;a=[];g=b.multiply(f,g/2);f=b.multiply(m,o);d=b.multiply(e,d);a[0]=b.add(b.subtract(c,g),b.add(f,d));a[1]=b.add(b.add(c,g),b.add(f,d));a[2]=b.subtract(b.subtract(c,g),b.add(f,d));a[3]=b.subtract(b.add(c,g),b.add(f,d));aabb1=a[0];aabb2=a[0];for(c=1;4>c;c++)aabb1[0]>
a[c][0]&&(aabb1[0]=a[c][0]),aabb1[1]>a[c][1]&&(aabb1[1]=a[c][1]),aabb1[2]>a[c][2]&&(aabb1[2]=a[c][2]),aabb2[0]<a[c][0]&&(aabb2[0]=a[c][0]),aabb2[1]<a[c][1]&&(aabb2[1]=a[c][1]),aabb2[2]<a[c][2]&&(aabb2[2]=a[c][2]);return[aabb1,aabb2]}};return{Light:y}});
CubicVR.RegisterModule("Camera",function(h){function y(a,b,e,d,f){var c=h.mat4;this.frustum=new h.Frustum;"object"==typeof a?(this.position=a.position||[0,0,-1],this.rotation=a.rotation||[0,0,0],this.target=a.target||[0,0,0],this.fov=a.fov||60,this.nearclip=a.nearclip||a.nearClip||a.near||0.1,this.farclip=a.farclip||a.farClip||a.far||400,this.targeted=a.targeted!==n?a.targeted:!0,this.calc_nmatrix=a.calcNormalMatrix!==n?a.calcNormalMatrix:!0,this.name=a.name||"camera"+g,b=a.height?a.height:n,a=a.width?
a.width:n):(this.position=[0,0,0],this.rotation=[0,0,0],this.target=[0,0,0],this.fov=e!==n?e:60,this.nearclip=d!==n?d:0.1,this.farclip=f!==n?f:400,this.calc_nmatrix=this.targeted=!0,this.name="camera"+g);this.motion=this.targetSceneObject=null;this.transform=new h.Transform;this.manual=!1;this.setDimensions(a!==n?a:512,b!==n?b:512);this.mvMatrix=c.identity();this.pMatrix=null;this.calcProjection();this.ortho=!1;this.ortho_view={left:-1,right:1,bottom:-1,top:1};this.parent=null;++g}function w(a){this.position=
a!==n?a:[0,0,0]}function q(a,b,e){this.camPath=new h.Motion;this.targetPath=new h.Motion;this.start_position=a!==n?a:[8,8,8];this.target=b!==n?b:[0,0,0];this.bounds=e!==n?e:[[-15,3,-15],[15,20,15]];this.safe_bb=[];this.avoid_sphere=[];this.segment_time=3;this.buffer_time=20;this.path_length=this.path_time=this.current_time=this.start_time=0;this.min_distance=2;this.angle_min=this.max_distance=40;this.angle_max=180}var n=h.undef,r=h.enums,c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],g=0;y.prototype={get x(){return this.position[0]},
set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get targetX(){return this.target[0]},set targetX(a){this.target[0]=a},get targetY(){return this.target[1]},set targetY(a){this.target[1]=a},get targetZ(){return this.target[2]},
set targetZ(a){this.target[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},trackTarget:function(a,b,e){this.position=h.vec3.trackTarget(this.position,a,b,e)},setParent:function(a){this.parent=a},hasParent:function(){return!!this.parent},getParent:function(){return this.parent},getParentedPosition:function(){return null!==this.parent&&this.mvMatrix&&this.parent.tMatrix?h.mat4.vec3_multiply(this.position,
this.parent.tMatrix):this.position},setOrtho:function(a,b,e,d){this.ortho=!0;this.ortho_view.left=a;this.ortho_view.right=b;this.ortho_view.bottom=e;this.ortho_view.top=d},control:function(a,b,e){a===r.motion.ROT?this.rotation[b]=e:a===r.motion.POS?this.position[b]=e:a===r.motion.FOV?this.setFOV(e):a===r.motion.LENS?this.setLENS(e):a===r.motion.NEARCLIP?this.setClip(e,this.farclip):a===r.motion.FARCLIP&&this.setClip(this.nearclip,e)},makeFrustum:function(a,b,e,d,f,c){return[2*f/(b-a),0,0,0,0,2*f/
(d-e),0,0,(b+a)/(b-a),(d+e)/(d-e),-(c+f)/(c-f),-1,0,0,-2*c*f/(c-f),0]},setTargeted:function(a){this.targeted=a},calcProjection:function(){var a=h.mat4,b=h.mat3;this.pMatrix=this.ortho?a.ortho(this.ortho_view.left,this.ortho_view.right,this.ortho_view.bottom,this.ortho_view.top,this.nearclip,this.farclip):a.perspective(this.fov,this.aspect,this.nearclip,this.farclip);!this.targeted&&this.mvMatrix&&(a.identity(this.mvMatrix),a.rotate(-this.rotation[0],-this.rotation[1],-this.rotation[2],this.mvMatrix),
a.translate(-this.position[0],-this.position[1],-this.position[2],this.mvMatrix),this.parent&&a.multiply(this.mvMatrix.slice(0),a.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=a.inverse_mat3(this.mvMatrix),b.transpose_inline(this.nMatrix)):a.identity(this.nMatrix));this.frustum.extract(this,this.mvMatrix,this.pMatrix)},setClip:function(a,b){this.nearclip=a;this.farclip=b;this.calcProjection()},setDimensions:function(a,b){this.width=a;this.height=b;this.aspect=a/b;this.calcProjection()},
resize:function(a,b){this.setDimensions(a,b)},setFOV:function(a){this.fov=a;this.ortho=!1;this.calcProjection()},setLENS:function(a){this.setFOV(2*Math.atan(16/a)*(180/Math.PI))},lookat:function(a,b,e,d,f,m,o,g,n){var v=h.mat4,u=h.mat3;"object"==typeof a?this.lookat(this.position[0],this.position[1],this.position[2],a[0],a[1],a[2],0,1,0):(this.mvMatrix=v.lookat(a,b,e,d,f,m,o,g,n),this.rotation[2]&&(this.transform.clearStack(),this.transform.rotate(-this.rotation[2],0,0,1),this.transform.pushMatrix(this.mvMatrix),
this.mvMatrix=this.transform.getResult()),null!==this.parent&&v.multiply(this.mvMatrix.slice(0),v.inverse(this.parent.tMatrix),this.mvMatrix),this.calc_nmatrix?(this.nMatrix=v.inverse_mat3(this.mvMatrix),u.transpose_inline(this.nMatrix)):this.nMatrix=c,this.frustum.extract(this,this.mvMatrix,this.pMatrix))},unProject:function(a,b,e){var d=h.mat4,f=h.vec3,c=[0,0,this.width,this.height],a=d.vec4_multiply(d.vec4_multiply([2*((a-c[0])/c[2])-1,-(2*((b-c[1])/c[3])-1),1,1],d.inverse(this.pMatrix)),d.inverse(this.mvMatrix)),
a=[a[0]/a[3],a[1]/a[3],a[2]/a[3]];return e!==n?(b=this.getParentedPosition(),f.add(b,f.multiply(f.normalize(f.subtract(a,b)),e))):a},project:function(a,b,e){var d=h.mat4,d=d.vec4_multiply(d.vec4_multiply([a,b,e,1],this.mvMatrix),this.pMatrix);d[2]=h.vec3.length(h.vec3.subtract([a,b,e],this.position));return[(d[0]/d[3]+1)/2*this.width,(-d[1]/d[3]+1)/2*this.height,d[2]]}};w.prototype={control:function(a,b,e){a===r.motion.POS&&(this.position[b]=e)}};q.prototype={inBounds:function(a){var b=h.vec3;if(!(a[0]>
this.bounds[0][0]&&a[1]>this.bounds[0][1]&&a[2]>this.bounds[0][2]&&a[0]<this.bounds[1][0]&&a[1]<this.bounds[1][1]&&a[2]<this.bounds[1][2]))return!1;for(var e=0,d=this.avoid_sphere.length;e<d;e++)if(b.length(a,this.avoid_sphere[e][0])<this.avoid_sphere[e][1])return!1;return!0},findNextNode:function(a,b){var e=h.vec3,d=[0,0,0],f=[0,0,0],c=d=0,o=!1;do if(f[0]=Math.random()-0.5,f[1]=Math.random()-0.5,f[2]=Math.random()-0.5,f=e.normalize(f),d=Math.random()*(this.max_distance-this.min_distance)+this.min_distance,
d=e.add(b.position,e.multiply(f,d)),o=this.inBounds(d),c++,30<c){d=b.position;break}while(!o);return d},run:function(a){this.current_time=a;0===this.path_time&&(this.path_time=this.current_time,this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,this.start_position[0]),this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,this.start_position[1]),this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,this.start_position[2]));for(;this.path_time<this.current_time+this.buffer_time;){this.path_time+=
this.segment_time;var b=new w,e=new w;this.path_length&&this.camPath.apply(this.path_time-2*this.segment_time,b);this.camPath.apply(this.path_time-this.segment_time,e);b=this.findNextNode(b,e);this.camPath.setKey(r.motion.POS,r.motion.X,this.path_time,b[0]);this.camPath.setKey(r.motion.POS,r.motion.Y,this.path_time,b[1]);this.camPath.setKey(r.motion.POS,r.motion.Z,this.path_time,b[2]);this.path_length++}b=new w;this.camPath.apply(a,b);return b.position},addSafeBound:function(a,b){this.safe_bb.push([a,
b])},addAvoidSphere:function(a,b){this.avoid_sphere.push([a,b])}};return{Camera:y,AutoCamera:q}});
CubicVR.RegisterModule("Motion",function(h){function y(){this.time=this.value=0;this.shape=r.envelope.shape.TCB;this.bias=this.continuity=this.tension=0;this.next=this.prev=null;this.param=[0,0,0,0]}function w(a){this.nKeys=0;this.lastKey=this.firstKey=this.keys=null;a?(this.in_behavior=CubicVR.parseEnum(r.envelope.behavior,a.in_behavior||a.inBehavior||a.behavior)||r.envelope.behavior.CONSTANT,this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,a.out_behavior||a.outBehavior||a.behavior)||r.envelope.behavior.CONSTANT):
this.out_behavior=this.in_behavior=r.envelope.behavior.CONSTANT}function q(a,b){this.controllers=[];this.yzflip=!1;if("object"===typeof a){var e=CubicVR.get(a);this.env_init=CubicVR.get(e.envelope);this.key_init=CubicVR.get(e.key);for(var c in e)if(e.hasOwnProperty(c)&&!("envelope"===c||"key"===c)){var g=e[c],n=CubicVR.get(g.envelope),v;for(v in g)if(g.hasOwnProperty(v)&&!("envelope"===v||"key"===v)){var u=g[v];if("object"===typeof u)for(var q in u)this.setKey(c,q,v,u[q]),n&&this.setBehavior(c,q,
n)}}}else this.env_init=a,this.key_init=b}var n=h.undef,r=CubicVR.enums;r.motion={POS:0,ROT:1,SCL:2,POSITION:0,ROTATION:1,SCALE:2,FOV:3,LENS:4,NEARCLIP:5,FARCLIP:6,INTENSITY:7,X:0,Y:1,Z:2,V:3};r.envelope={shape:{TCB:0,HERM:1,BEZI:2,LINE:3,STEP:4,BEZ2:5},behavior:{RESET:0,CONSTANT:1,REPEAT:2,OSCILLATE:3,OFFSET:4,LINEAR:5}};var c=function(a,b,e){var c=0,c=e-b;if(0===c)return[b,0];b=a-c*Math.floor((a-b)/c);c=-parseInt((b-a)/c+(b>a?0.5:-0.5),10);return[b,c]},g=function(a,b,e,c,g){var n,v;v=g*g;n=3*(b-
a);b=3*(e-b)-n;return(c-a-n-b)*v*g+b*v+n*g+a},a=function(b,f,e,c,s,n,v){var u,q;q=n+0.5*(v-n);u=g(b,f,e,c,q);return 1.0E-4<Math.abs(s-u)?(u>s?v=q:n=q,a(b,f,e,c,s,n,v)):q},b=function(a,b){var e,c,g,n;a.shape===r.envelope.shape.TCB?(e=(1-a.tension)*(1+a.continuity)*(1+a.bias),c=(1-a.tension)*(1-a.continuity)*(1-a.bias),g=b.value-a.value,a.prev?(n=(b.time-a.time)/(b.time-a.prev.time),e=n*(e*(a.value-a.prev.value)+c*g)):e=c*g):a.shape===r.envelope.shape.LINE?(g=b.value-a.value,a.prev?(n=(b.time-a.time)/
(b.time-a.prev.time),e=n*(a.value-a.prev.value+g)):e=g):a.shape===r.envelope.shape.BEZI||a.shape===r.envelope.shape.HERM?(e=a.param[1],a.prev&&(e*=(b.time-a.time)/(b.time-a.prev.time))):a.shape===r.envelope.shape.BEZ2?(e=a.param[3]*(b.time-a.time),e=1.0E-5<Math.abs(a.param[2])?e/a.param[2]:1E5*e):e=0;return e},e=function(a,b){var e,c,g,n;b.shape===r.envelope.shape.LINE?(g=b.value-a.value,b.next?(n=(b.time-a.time)/(b.next.time-a.time),e=n*(b.next.value-b.value+g)):e=g):b.shape===r.envelope.shape.TCB?
(e=(1-b.tension)*(1-b.continuity)*(1+b.bias),c=(1-b.tension)*(1+b.continuity)*(1-b.bias),g=b.value-a.value,b.next?(n=(b.time-a.time)/(b.next.time-a.time),e=n*(c*(b.next.value-b.value)+e*g)):e*=g):b.shape===r.envelope.shape.HERM||b.shape===r.envelope.shape.BEZI?(e=b.param[0],b.next&&(e*=(b.time-a.time)/(b.next.time-a.time))):b.shape===r.envelope.shape.BEZ2?(e=b.param[1]*(b.time-a.time),e=1.0E-5<Math.abs(b.param[0])?e/b.param[0]:1E5*e):e=0;return e};w.prototype={setBehavior:function(a,b){this.in_behavior=
CubicVR.parseEnum(r.envelope.behavior,a);this.out_behavior=CubicVR.parseEnum(r.envelope.behavior,b)},empty:function(){return 0===this.nKeys},addKey:function(a,b,e){var c="object"==typeof a?a:e;b||(b=0);a||(a=0);c?(c=a,a=c.time,e=this.insertKey(a),e.value=c.value?c.value:b,e.time=c.time?c.time:a,e.shape=CubicVR.parseEnum(r.envelope.shape,c.shape)||r.envelope.shape.TCB,e.tension=c.tension?c.tension:0,e.continuity=c.continuity?c.continuity:0,e.bias=c.bias?c.bias:0,e.param=c.param?c.param:[0,0,0,0]):
(e=this.insertKey(a),e.value=b);return e},insertKey:function(a){var b=new y;b.time=a;if(!this.nKeys)return this.lastKey=this.firstKey=this.keys=b,this.nKeys++,b;for(var e=this.keys;e;){this.firstKey.time>a?this.firstKey=b:this.lastKey.time<a&&(this.lastKey=b);if(e.time>b.time)return b.prev=e.prev,b.prev&&(b.prev.next=b),b.next=e,b.next.prev=b,this.nKeys++,b;if(!e.next)return b.prev=e,e.next=b,this.nKeys++,b;e=e.next}return null},evaluate:function(d){var f,m,o,s,n,v=0;if(0===this.nKeys)return 0;if(1===
this.nKeys)return this.keys.value;m=this.firstKey;f=this.lastKey;if(d<m.time){s=this.in_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return m.value;if(s===r.envelope.behavior.REPEAT)s=c(d,m.time,f.time),d=s[0];else if(s===r.envelope.behavior.OCILLATE)s=c(d,m.time,f.time),d=s[0],s=s[1],s%2&&(d=f.time-m.time-d);else if(s===r.envelope.behavior.OFFSET)s=c(d,m.time,f.time),d=s[0],s=s[1],v=s*(f.value-m.value);else if(s===r.envelope.behavior.LINEAR)return n=b(m,
m.next)/(m.next.time-m.time),n*(d-m.time)+m.value}else if(d>f.time){s=this.out_behavior;if(s===r.envelope.behavior.RESET)return 0;if(s===r.envelope.behavior.CONSTANT)return f.value;if(s===r.envelope.behavior.REPEAT)s=c(d,m.time,f.time),d=s[0];else if(s===r.envelope.behavior.OCILLATE)s=c(d,m.time,f.time),d=s[0],s=s[1],s%2&&(d=f.time-m.time-d);else if(s===r.envelope.behavior.OFFSET)s=c(d,m.time,f.time),d=s[0],s=s[1],v=s*(f.value-m.value);else if(s===r.envelope.behavior.LINEAR)return s=e(f.prev,f)/(f.time-
f.prev.time),s*(d-f.time)+f.value}if(this.lastKey0)if(d>this.lastKey0.time)f=this.lastKey0;else if(d<this.lastKey0.time)for(f=this.lastKey;d<f.time&&f.prev;)f=f.prev;else f=this.keys;else f=this.keys;for(;d>f.next.time;)f=f.next;m=f.next;this.lastKey0=f;if(d===f.time)return f.value+v;if(d===m.time)return m.value+v;o=(d-f.time)/(m.time-f.time);s=m.shape;if(s===r.envelope.shape.TCB||s===r.envelope.shape.BEZI||s===r.envelope.shape.HERM){n=b(f,m);s=e(f,m);var u,q;q=o*o;u=o*q;d=3*q-u-u;u-=q;d=[1-d,d,u-
q+o,u];return d[0]*f.value+d[1]*m.value+d[2]*n+d[3]*s+v}return s===r.envelope.shape.BEZ2?(d=a(f.time,f.shape===r.envelope.shape.BEZ2?f.time+f.param[2]:f.time+(m.time-f.time)/3,m.time+m.param[0],m.time,d,0,1),g(f.value,f.shape===r.envelope.shape.BEZ2?f.value+f.param[3]:f.value+f.param[1]/3,m.param[1]+m.value,m.value,d)+v):s===r.envelope.shape.LINE?f.value+o*(m.value-f.value)+v:s===r.envelope.shape.STEP?f.value+v:v}};q.prototype={clone:function(){var a=new h.Motion(this.env_init,this.key_init),b;for(b in this.controllers)if(this.controllers.hasOwnProperty(b)){a.controllers[b]===
n&&(a.controllers[b]=[]);for(var e in this.controllers[b])if(this.controllers[b].hasOwnProperty(e)){var c=this.controllers[b][e],g=a.controllers[b][e]=new w({in_behavior:c.in_behavior,out_behavior:c.out_behavior});g.nKeys=c.nKeys;g.keys=c.keys;g.firstKey=c.firstKey;g.lastKey=c.lastKey}}return a},envelope:function(a,b){b=CubicVR.parseEnum(r.motion,b)||0;a=CubicVR.parseEnum(r.motion,a)||0;this.controllers[a]===n&&(this.controllers[a]=[]);this.controllers[a][b]===n&&(this.controllers[a][b]=new w(this.env_init));
return this.controllers[a][b]},evaluate:function(a){var b=[],e;for(e in this.controllers)if(this.controllers.hasOwnProperty(e)){b[e]=[];for(var c in this.controllers[e])this.controllers[e].hasOwnProperty(c)&&(b[e][c]=this.controllers[e][c].evaluate(a))}return b},apply:function(a,b){for(var e in this.controllers)if(this.controllers.hasOwnProperty(e)){var c=parseInt(e,10);if(this.yzflip&&c===r.motion.ROT){this.q||(this.q=new CubicVR.Quaternion);var g=this.q,n=this.controllers[e][0].evaluate(a),v=this.controllers[e][1].evaluate(a),
u=this.controllers[e][2].evaluate(a);g.fromEuler(n,u,-v);g=g.toEuler();b.control(c,0,g[0]);b.control(c,1,g[1]);b.control(c,2,g[2])}else for(var q in this.controllers[e])this.controllers[e].hasOwnProperty(q)&&b.control(c,parseInt(q,10),this.controllers[e][q].evaluate(a))}},setKey:function(a,b,e,c,g){b=CubicVR.parseEnum(r.motion,b)||0;a=CubicVR.parseEnum(r.motion,a)||0;return this.envelope(a,b).addKey(e,c,g?g:this.key_init)},setArray:function(a,b,e,c){var g=[],a=CubicVR.parseEnum(r.motion,a)||0,n;for(n in e)if(e.hasOwnProperty(n)){var v=
this.envelope(a,CubicVR.parseEnum(r.motion,n));g[n]=v.addKey(b,e[n],c?c:this.key_init)}return g},setBehavior:function(a,b,e,c){var g=this.envelope(a,b);"object"===typeof e&&(c=e,e=c.in_behavior||c.inBehavior||c.behavior,c=c.out_behavior||c.outBehavior||c.behavior);CubicVR.parseEnum(r.motion,b);CubicVR.parseEnum(r.motion,a);g.setBehavior(e,c)},setBehaviorArray:function(a,b,e){var a=CubicVR.parseEnum(r.motion,a)||0,c=this.controllers[a],g;for(g in c)c.hasOwnProperty(g)&&this.envelope(a,CubicVR.parseEnum(r.motion,
g)||0).setBehavior(b,e)}};return{Motion:q,Envelope:w,EnvelopeKey:y}});
CubicVR.RegisterModule("EventHandler",function(h){function y(g){g=CubicVR.parseEnum(r.event,g);return g===n?(c("For custom events use CubicVR.registerEvent('event_name'); and use the resulting CubicVR.enums.event.EVENT_NAME for type checks and 'event_name' for construction."),!1):!isNaN(parseInt(g,10))&&(g>=r.event.EVENT_MAX||0>g)?(c("Unknown event ID passed: "+g),!1):g}function w(c){c=c||{};this.name=c.name;c.id=y(c.id)||r.event.TICK;this.id=c.id;this.interval=c.interval||0;this.enabled=c.enabled||
!0;this.action=c.action||null;this.properties=c.properties||{};this.event_properties=c.event_properties||{};this.buffered=c.buffered||!1;this.weight=c.weight===n?-1:c.weight;this.subject=null;this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0;this.break_chain=!1}function q(){this.events=[];this.eventProperties=[];this.eventPropertyCount=[];this.eventHandled=[];this.listeners=[];this.listenerNames=[];this.eventParameters=[]}var n=h.undef,
r=CubicVR.enums,c=h.log;r.event={TICK:0,MOVE:1,MATRIX_UPDATE:2,OCTREE_ADJUST:3,COLLIDE:4,CONTACT:5,CONTACT_ADD:6,CONTACT_REMOVE:7,CONTACT_GHOST:8,RIGID_REST:9,RIGID_AWAKE:10,ENUM_MAX:11};w.prototype={getName:function(){return this.name},setName:function(c){this.name=c},getSubject:function(){return this.subject},setSubject:function(c){this.subject=c},getId:function(){return this.id},setId:function(c){this.id=c},isEnabled:function(){return this.enabled},disable:function(){this.setEnabled(!1)},enable:function(){this.setEnabled(!0)},
setEnabled:function(c){c&&!this.enabled&&(this.n_updates=this.t_resting=this.t_rest=this.t_last=this.t_update=this.t_updatecall=this.t_active=this.t_sleep=0,this.break_chain=!1);this.enabled=c},isBuffered:function(){return this.buffered},setBuffered:function(c){this.buffered=c},setInterval:function(c){this.interval=c},getInterval:function(){return this.interval},setAction:function(c){this.action=c},getAction:function(){return this.action},getProperties:function(){return this.properties},setProperties:function(c){this.properties=
c},getProperty:function(c){return this.properties[c]},setProperty:function(c,a){this.properties[c]=a},setEventProperties:function(c){this.event_properties=c},getEventProperties:function(){return this.event_properties},getEventProperty:function(c){return this.event_properties[c]},setEventProperty:function(c,a){this.properties[c]=a},getTimeSleeping:function(){return this.t_sleep},getTimeActive:function(){return this.t_active},getTimeUpdated:function(){return this.t_update},getSeconds:function(){return this.getTimeUpdated()},
getRestInterval:function(){return this.t_rest},getLastUpdateSeconds:function(){return this.t_last},setRestInterval:function(c){this.t_rest=c},getUpdateCount:function(){return this.n_updates},breakChain:function(){this.break_chain=!0},isChainBroken:function(){return this.break_chain},rest:function(c){this.setRestInterval(c||0)},awake:function(){this.t_rest=0},update:function(c,a){if(!this.enabled)return!1;var b=0,e=!0;0===this.n_updates?(this.t_updatecall=this.t_update=c,b=1/60):c!==this.t_update?
(this.t_rest||(this.t_last=c-this.t_update,this.t_update=c),b=c-this.t_updatecall,this.t_updatecall=c):e=!1;if(0<this.t_rest)e&&(this.t_resting+=b,this.t_rest-=b,0>this.t_rest&&(this.t_rest=0));else return e&&(this.t_active+=this.t_last,!this.t_rest&&this.interval&&(this.t_rest=this.interval),this.n_updates++),this.callEvent(a),!0;e&&this.n_updates++;return!1},callEvent:function(c){return!this.action?!1:this.action(this,c)}};q.prototype={addEvent:function(c){c.callEvent||(c=new w(c));var a=c.getId();
this.eventProperties[a]||(this.eventProperties[a]={});this.listeners[a]=this.listeners[a]||0;this.listeners[a]++;this.events.push(c);-1===this.listenerNames.indexOf(a)&&this.listenerNames.push(a);return c},removeEvent:function(c){if(this.lockState)this.lockRemovals||(this.lockRemovals=[]),-1==this.lockRemovals.indexOf(c)&&this.lockRemovals.push(c);else{var a=this.events.indexOf(c);-1!==a&&(c=c.getId(),this.events.splice(a,1),this.listeners[c]--,this.listeners[c]||(this.eventHandled[c]=!0,this.eventParameters[c]=
{},this.eventProperties[c]=[],this.eventPropertyCount[c]=0,a=this.listenerNames.indexOf(c),0<=a&&this.listenerNames.splice(a,1)))}},getProperties:function(c){this.eventParameters[c]=this.eventParameters[c]||{};return this.eventParameters[c]},setProperties:function(c,a){this.eventParameters[c]=a},getProperty:function(c,a){return this.getProperties(c)[a]},setProperty:function(c,a,b){this.getProperties(c)[a]=b},hasEvent:function(c){return!!this.listeners[c]},triggerEvent:function(c,a){if(!this.listeners[c])return null;
this.eventProperties[c]==n&&(this.eventProperties[c]=[]);var b=this.eventProperties[c];this.eventPropertyCount[c]===n&&(this.eventPropertyCount[c]=0);var e=this.eventPropertyCount[c];20<e&&console.log("Warning, event "+c+" count > 20: "+e);b[e]=a&&b?a:b[e]||{};this.eventPropertyCount[c]++;this.eventHandled[c]=!1;return b[e]},update:function(c){var a,b,e,d,f,m;if(this.hasEvent(r.event.TICK)&&0===this.eventPropertyCount[r.event.TICK]&&(a=this.triggerEvent(r.event.TICK)))a.time=c,a.handler=this;this.lockState=
!0;a=0;for(b=this.events.length;a<b;a++){f=this.events[a];m=f.getId();d=this.eventPropertyCount[m];var o=!1;e=!1;if(d){var s=this.eventProperties[m];if(f.isEnabled()){if(f.isBuffered()){if(s.length=d,f.setEventProperties(s),o=o||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}}else for(e=0;e<d;e++)if(f.setEventProperties(s[a]),o=o||f.update(c,this),f.isChainBroken()){f.breakChain(!1);break}e=!0}}if(o||!e)this.eventHandled[m]=!0}a=0;for(b=this.listenerNames.length;a<b;a++)m=this.listenerNames[a],
this.eventHandled[m]&&(this.eventPropertyCount[m]=0);this.lockState=!1;if(this.lockRemovals&&this.lockRemovals.length){a=0;for(b=this.lockRemovals.length;a<b;a++)this.removeEvent(this.lockRemovals[a]);this.lockRemovals.length=0}}};return{Event:w,EventHandler:q,registerEvent:function(g){g=g.toUpperCase();r.event[g]!==n?c("Error, event '"+g+"' is already registered."):(r.event[g]=r.event.ENUM_MAX,r.event.ENUM_MAX++)},validateEvent:y}});
CubicVR.RegisterModule("Scene",function(h){function y(a,b){return a.light_type-b.light_type}function w(f,e){var c=null,d;f!==r&&null!==f?f.compile?c={}:(c=h.get(f)||{},f=null):c={};this.morphWeight=c.morphWeight||0;this.morphSource=c.morphSource||-1;this.morphTarget=c.morphTarget||-1;this.position=c.position===r?[0,0,0]:c.position;this.rotation=c.rotation===r?[0,0,0]:c.rotation;this.scale=c.scale===r?[1,1,1]:c.scale;this.shadowCast=c.shadowCast===r?!0:c.shadowCast;this.wireframe=c.wireframe||!1;this.motion=
c.motion===r?null:h.get(c.motion,h.Motion)||null;this.obj=!c.mesh?f?h.get(f,h.Mesh):null:h.get(c.mesh,h.Mesh);this.name=c.name===r?e!==r?e:null:c.name;this.properties=h.get(c.properties)||{};this.parent=this.children=null;var g=c.children||c.child||c.sceneObject||c.sceneObjects;if(g){if(g&&!g.length||"string"===typeof g)g=[g];if(g.length){c=0;for(d=g.length;c<d;c++)this.bindChild(h.get(g[c],h.SceneObject))}}this.drawn_this_frame=!1;this.lposition=[0,0,0];this.lrotation=[0,0,0];this.lscale=[0,0,0];
this.lMatrix=b.identity();this.tMatrix=b.identity();this.dirty=!0;this.aabb=[];this.id=-1;this.octree_leaves=[];this.octree_common_root=null;this.octree_aabb=[[0,0,0],[0,0,0]];a.reset(this.octree_aabb,[0,0,0]);this.ignore_octree=!1;this.was_culled=this.culled=this.visible=!0;this.dynamic_lights=[];this.static_lights=[];this.matrixLock=!1;this.eventHandler=this.instanceMaterials=null;this.duplicateCount=0;this.independentMotion=!1}function q(a,b,e,c,g,n){this.frames=0;this.sceneObjects=[];this.sceneObjectsByName=
[];this.sceneObjectsById=[];this.lights=[];this.global_lights=[];this.dynamic_lights=[];this.pickables=[];this.stats=[];this.cameras=[];this.camerasByName=[];this.shadows_updated=this.collect_stats=!1;if("object"===typeof a||"string"===typeof a){a=h.get(a);this.octree=a.octree;this.skybox=a.skybox||null;this.name=a.name||"scene"+d;this.wireframe=a.wireframe||!1;this.destroy=a.destroy||function(){};this.update=a.update||function(){};this.enable=a.enable||function(){};this.disable=a.disable||function(){};
b=a.setup&&a.setup(this)||{};this.update=b.update||this.update;this.enable=b.enable||this.enable;this.disable=b.disable||this.disable;this.destroy=b.destroy||this.destroy;if((c=a.sceneObjects||a.sceneObject||a.objects)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(e=c.length;b<e;b++)this.bindSceneObject(h.get(c[b],h.SceneObject))}if((c=a.lights||a.light)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(e=c.length;b<e;b++)this.bindLight(h.get(c[b],h.Light))}if((c=a.cameras||
a.camera)&&!c.length||"string"===typeof c)c=[c];if(c&&c.length){b=0;for(e=c.length;b<e;b++)this.bindCamera(h.get(c[b],h.Camera));this.camera=this.cameras[0]}c||(this.camera=new h.Camera(a.width,a.height,a.fov,a.nearclip,a.farclip))}else this.skybox=null,this.octree=n,this.name="scene"+d,this.camera=new h.Camera(a,b,e,c,g),this.wireframe=!1;this.paused=!1;++d}function n(){this.meshBin={};this.imageBin={};this.meshMap={};this.imageMap={};this.imageBinPtr={};this.meshBinPtr={}}var r=h.undef,c=h.enums,
g=h.GLCore,a=h.aabb,b=h.mat4,e=0;w.prototype={get x(){return this.position[0]},set x(a){this.position[0]=a},get y(){return this.position[1]},set y(a){this.position[1]=a},get z(){return this.position[2]},set z(a){this.position[2]=a},get rotX(){return this.rotation[0]},set rotX(a){this.rotation[0]=a},get rotY(){return this.rotation[1]},set rotY(a){this.rotation[1]=a},get rotZ(){return this.rotation[2]},set rotZ(a){this.rotation[2]=a},get pos(){return this.position.slice(0)},set pos(a){this.position=
a.slice(0)},get rot(){return this.rotation.slice(0)},set rot(a){this.rotation=a.slice(0)},get sclX(){return this.scale[0]},set sclX(a){this.scale[0]=a},get sclY(){return this.scale[1]},set sclY(a){this.scale[1]=a},get sclZ(){return this.scale[2]},set sclZ(a){this.scale[2]=a},get scl(){return this.scale.slice(0)},set scl(a){this.scale=a.slice(0)},clone:function(){var a,b;a=this.name?this.name+"_"+this.duplicateCount:null;this.duplicateCount++;var c=new h.SceneObject({name:a,mesh:this.obj,position:this.position.slice(0),
rotation:this.rotation.slice(0),scale:this.scale.slice(0),morphWeight:this.morphWeight,morphSource:this.morphSource,morphTarget:this.morphTarget,shadowCast:this.shadowCast,wireframe:this.wireframe,motion:this.motion?this.motion.clone():null});if(null!==this.instanceMaterials){c.instanceMaterials=[];a=0;for(b=this.instanceMaterials.length;a<b;a++)c.instanceMaterials[a]=this.instanceMaterials[a].clone()}if(null!==this.children){a=0;for(b=this.children.length;a<b;a++)c.bindChild(this.children[a].clone())}return c},
evaluate:function(a){var b,c;this.independentMotion=!0;this.motion&&this.motion.apply(a,this);if(null!==this.children){b=0;for(c=this.children.length;b<c;b++)this.children[b].evaluate(a)}},isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},addEvent:function(a){this.eventHandler||(this.eventHandler=new h.EventHandler);a=this.eventHandler.addEvent(a);a.setSubject(this);return a},removeEvent:function(a){this.eventHandler&&this.eventHandler.removeEvent(a)},hasEvents:function(){return!!this.eventHandler},
getEventHandler:function(){return this.eventHandler},setMesh:function(a){this.obj=a},getMesh:function(){return this.obj},getProperties:function(){return this.properties},setProperties:function(a){this.properties=a},getProperty:function(a){return this.properties[a]},setProperty:function(a,b){this.properties[a]=b},getInstanceMaterials:function(){if(!this.obj)return null;if(this.instanceMaterials)return this.instanceMaterials;this.instanceMaterials=[];for(var a=0,b=this.obj.materials.length;a<b;a++)this.instanceMaterials[a]=
this.obj.materials[a].clone();return this.instanceMaterials},getInstanceMaterial:function(a){for(var b=this.getInstanceMaterials(),c=0,e=b.length;c<e;c++)if(b[c].name==a)return b[c];return null},setMorphSource:function(a){this.morphSource=a},setMorphTarget:function(a){this.morphTarget=a},getMorphSource:function(){return this.morphSource},getMorphTarget:function(){return this.morphTarget},setMorphWeight:function(a){this.morphWeight=a},morphTargetCount:function(){return null!==this.obj.morphTargets?
this.obj.morphTargets.length:0},setMatrixLock:function(a){this.matrixLock=a},getMatrixLock:function(){return this.matrixLock},setMatrix:function(a){a?(this.tMatrix=a.slice(0),this.matrixLock=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MATRIX_UPDATE)&&(a.triggerEvent(c.event.MATRIX_UPDATE).matrix=this.tMatrix))):this.matrixLock=!1},doTransform:function(a){var e=h.vec3;if(!this.matrixLock&&(!e.equal(this.lposition,this.position)||!e.equal(this.lrotation,this.rotation)||!e.equal(this.lscale,
this.scale)||a!==r))a!==r?this.tMatrix=a.slice(0):b.identity(this.tMatrix),b.identity(this.lMatrix),b.translate(this.position[0],this.position[1],this.position[2],this.lMatrix),b.rotate(this.rotation[0],this.rotation[1],this.rotation[2],this.lMatrix),1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]||b.scale(this.scale[0],this.scale[1],this.scale[2],this.lMatrix),b.multiply(this.tMatrix.slice(0),this.lMatrix,this.tMatrix),this.lposition[0]=this.position[0],this.lposition[1]=this.position[1],
this.lposition[2]=this.position[2],this.lrotation[0]=this.rotation[0],this.lrotation[1]=this.rotation[1],this.lrotation[2]=this.rotation[2],this.lscale[0]=this.scale[0],this.lscale[1]=this.scale[1],this.lscale[2]=this.scale[2],this.dirty=!0,this.hasEvents()&&(a=this.getEventHandler(),a.hasEvent(c.event.MOVE)&&(a=a.triggerEvent(c.event.MOVE),a.oldPosition=this.lposition,a.position=this.position,a.oldRotation=this.lrotation,a.rotation=this.rotation,a.oldScale=this.lscale,a.scale=this.scale))},adjust_octree:function(){var b=
this.getAABB(),c=this.octree_aabb,e=b[0][0],d=b[0][1],g=b[0][2],n=b[1][0],u=b[1][1],q=b[1][2],h=c[0][0],C=c[0][1],w=c[0][2],t=c[1][0],x=c[1][1],c=c[1][2];if(0<this.octree_leaves.length&&(e<h||d<C||g<w||n>t||u>x||q>c)){for(e=0;e<this.octree_leaves.length;++e)this.octree_leaves[e].remove(this);this.octree_leaves=[];this.static_lights=[];e=this.octree_common_root;this.octree_common_root=null;if(null!==e){for(;;)if(!e.contains_point(b[0])||!e.contains_point(b[1]))if(e._root!==r&&null!==e._root)e=e._root;
else break;else break;a.reset(this.octree_aabb,this.position);e.insert(this)}}},bindChild:function(a){null===this.children&&(this.children=[]);a.parent=this;this.children.push(a)},control:function(a,b,e){a===c.motion.POS?this.position[b]=e:a===c.motion.SCL?this.scale[b]=e:a===c.motion.ROT&&(this.rotation[b]=e)},getAABB:function(){var a=h.mat4,b=h.vec3;if(this.dirty){var c=Array(8);this.doTransform();var e,d;if(this.obj){if(!this.obj.bb)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,
1],this.position)];e=this.obj.bb[0];d=this.obj.bb[1]}if(!this.obj||e===r||d===r)return this.aabb=[b.add([-1,-1,-1],this.position),b.add([1,1,1],this.position)];var g=e;e=b.subtract(d,e);c[0]=[g[0],g[1],g[2]];c[1]=[g[0],g[1],g[2]+e[2]];c[2]=[g[0]+e[0],g[1],g[2]];c[3]=[g[0]+e[0],g[1],g[2]+e[2]];c[4]=[g[0],g[1]+e[1],g[2]];c[5]=[g[0],g[1]+e[1],g[2]+e[2]];c[6]=[g[0]+e[0],g[1]+e[1],g[2]];c[7]=[g[0]+e[0],g[1]+e[1],g[2]+e[2]];g=a.vec3_multiply(c[0],this.tMatrix);e=[g[0],g[1],g[2]];d=[g[0],g[1],g[2]];for(b=
1;8>b;++b)g=a.vec3_multiply(c[b],this.tMatrix),e[0]>g[0]&&(e[0]=g[0]),e[1]>g[1]&&(e[1]=g[1]),e[2]>g[2]&&(e[2]=g[2]),d[0]<g[0]&&(d[0]=g[0]),d[1]<g[1]&&(d[1]=g[1]),d[2]<g[2]&&(d[2]=g[2]);this.aabb[0]=e;this.aabb[1]=d;this.dirty=!1}return this.aabb}};var d=0;q.prototype={isWireframe:function(){return this.wireframe},setWireframe:function(a){this.wireframe=a},attachOctree:function(b){this.octree=b;b.init&&b.init(this);b=this.lights;this.lights=[];for(var c=0,d=b.length;c<d;c++)this.bindLight(b[c]);b=
this.sceneObjects;if(this.octree!==r){c=0;for(d=b.length;c<d;++c){var g=b[c];null!==g.obj&&(0>g.id&&(g.id=e,++e),this.sceneObjectsById[g.id]=g,a.reset(g.octree_aabb,g.position),this.octree.insert(g),(void 0===g.octree_common_root||null===g.octree_common_root)&&log("!!",g.name,"octree_common_root is null"))}}},setSkyBox:function(a){this.skybox=a},getSceneObject:function(a){return this.sceneObjectsByName[a]},bindSceneObject:function(b,c,d){if(-1==this.sceneObjects.indexOf(b)){this.sceneObjects.push(b);
c!==r&&c&&this.pickables.push(b);null!==b.name&&(this.sceneObjectsByName[b.name]=b);if(this.octree!==r&&(d===r||"true"===d))0>b.id&&(b.id=e,++e),this.sceneObjectsById[b.id]=b,a.reset(b.octree_aabb,b.position),this.octree.insert(b);if(b.children)for(var g=0,n=b.children.length;g<n;g++)this.bindSceneObject(b.children[g],c,d);return b}},removeLight:function(a){a=this.lights.indexOf(a);0<=a&&this.lights.splice(a,1)},removeSceneObject:function(a){var b;if(this.lockState)this.lockRemovals||(this.lockRemovals=
[]),-1==this.lockRemovals.indexOf(a)&&this.lockRemovals.push(a);else if(b=this.sceneObjects.indexOf(a),0<=b&&this.sceneObjects.splice(b,1),b=this.pickables.indexOf(a),0<=b&&this.pickables.splice(b,1),null!==a.name&&this.sceneObjectsByName[a.name]!==r&&delete this.sceneObjectsByName[a.name],a.children){b=0;for(var c=a.children.length;b<c;b++)this.removeSceneObject(a.children[b])}},bindLight:function(a,b){this.lights.push(a);if(this.octree!==r&&(b===r||"true"===b))a.method===c.light.method.GLOBAL?this.global_lights.push(a):
(a.method===c.light.method.DYNAMIC&&this.dynamic_lights.push(a),this.octree.insert_light(a));this.lights=this.lights.sort(y)},bindCamera:function(a){-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);this.camera=a},removeCamera:function(a){"object"!==typeof a&&(a=this.getCamera(camName));-1===this.cameras.indexOf(a)&&(this.cameras.push(a),this.camerasByName[a.name]=a);return a},bind:function(a){a instanceof h.Light?this.bindLight(a):a instanceof h.SceneObject?this.bindSceneObject(a):
a instanceof h.Camera?this.bindCamera(a):a instanceof h.Vehicle?a.bindToScene(this):a instanceof h.RigidBody&&this.bindSceneObject(a.getSceneObject())},remove:function(a){a instanceof h.Light?this.removeLight(a):a instanceof h.SceneObject?this.removeSceneObject(a):a instanceof h.Camera?this.removeCamera(a):a instanceof bsae.RigidBody&&this.removeSceneObject(a.getSceneObject())},setCamera:function(a){a&&("object"!==typeof a&&(a=this.getCamera(a)),this.camera=a)},getCamera:function(a){return a===r?
this.camera:this.camerasByName[a]},evaluate:function(a){var b,c;b=0;for(c=this.sceneObjects.length;b<c;b++)this.sceneObjects[b].motion&&!this.sceneObjects[b].independentMotion&&this.sceneObjects[b].motion.apply(a,this.sceneObjects[b]);null!==this.camera.motion&&(null!==this.camera.targetSceneObject&&(this.camera.target=this.camera.targetSceneObject.position),this.camera.motion.apply(a,this.camera));b=0;for(c=this.lights.length;b<c;b++){var e=this.lights[b];null!==e.motion&&e.motion.apply(a,e)}},prepareTransforms:function(a){var b,
c;if(a){if(a.doTransform(),a.children){b=0;for(c=a.children.length;b<c;b++)a.children[b].doTransform(a.tMatrix),this.prepareTransforms(a.children[b])}}else if(0!==this.sceneObjects.length){b=0;for(c=this.sceneObjects.length;b<c;++b)this.prepareTransforms(this.sceneObjects[b])}},updateShadows:function(a){var b=g.gl;if(this.shadows_updated)return!1;a||this.doTransform();this.shadows_updated=!0;if(h.features.lightShadows){for(var a=b.getParameter(b.FRAMEBUFFER_BINDING),e=!1,d=b.getParameter(b.VIEWPORT),
n=0,q=this.lights.length;n<q;n++){var u=this.lights[n];if(u.light_type==c.light.type.SPOT_SHADOW||u.light_type==c.light.type.SPOT_SHADOW_PROJECTOR||u.light_type==c.light.type.AREA){var e=!0,z=[new h.Light(c.light.type.DEPTH_PACK)];u.light_type===c.light.type.AREA&&(u.areaCam=this.camera,u.updateAreaLight());g.shadow_near=u.dummyCam.nearclip;g.shadow_far=u.dummyCam.farclip;u.shadowBegin();for(var B=0,r=this.sceneObjects.length;B<r;B++){var w=this.sceneObjects[B];w.parent||!1===w.visible||!1===w.shadowCast||
this.renderSceneObject(w,u.dummyCam,z,!1,!0)}u.shadowEnd();a&&b.bindFramebuffer(b.FRAMEBUFFER,a)}}e&&b.viewport(d[0],d[1],d[2],d[3])}},updateCamera:function(){!1===this.camera.manual&&(this.camera.targeted?this.camera.lookat(this.camera.position[0],this.camera.position[1],this.camera.position[2],this.camera.target[0],this.camera.target[1],this.camera.target[2],0,1,0):this.camera.calcProjection());g.depth_alpha_near=this.camera.nearclip;g.depth_alpha_far=this.camera.farclip},resize:function(a,b){this.camera&&
this.camera.setDimensions(a,b)},doTransform:function(){for(var a=this.octree!==r,b=0,c=this.sceneObjects.length;b<c;b++){var e=this.sceneObjects[b];null===e.parent&&(this.prepareTransforms(e),a&&(lights=[],e.dirty&&null!==e.obj&&e.adjust_octree(),!1===e.visible||a&&(e.ignore_octree||!0===e.drawn_this_frame||!0===e.culled)||(lights=e.dynamic_lights,lights=lights.concat(e.static_lights),lights=lights.concat(this.global_lights),this.collect_stats&&(this.lights_rendered=Math.max(lights.length,this.lights_rendered),
this.lights_rendered===lights.length&&(lights_list=lights),++this.objects_rendered),lights=0===lights.length?[g.emptyLight]:lights.sort(y),e.drawn_this_frame=!0)))}},renderSceneObject:function(a,b,e,c,d,n,u){var q=!1,B=g.gl,c=c!==r&&c,d=d||!1,n=n||!1;if(a.visible&&a.obj){0>a.scale[0]&&(q=!q);0>a.scale[1]&&(q=!q);0>a.scale[2]&&(q=!q);q&&B.cullFace(B.FRONT);var C=a.obj;null!==C.morphTargets&&(-1!==a.morphSource&&C.setMorphSource(a.morphSource),-1!==a.morphTarget&&C.setMorphTarget(a.morphTarget),null!==
a.morphWeight&&(C.morphWeight=a.morphWeight));a.instanceMaterials&&C.bindInstanceMaterials(a.instanceMaterials);h.renderObject(C,b,a.tMatrix,e,d,n,this.isWireframe()||a.isWireframe())&&u&&u.push(a);a.instanceMaterials&&C.bindInstanceMaterials(null);q&&B.cullFace(B.BACK)}a=a.children;if(c&&a){c=0;for(q=a.length;c<q;c++)this.renderSceneObject(a[c],b,e,!0,d,n,u)}},runEvents:function(a){var b,c;this.lockState=!0;a.getSeconds&&(a=a.getSeconds());b=0;for(c=this.sceneObjects.length;b<c;b++){var e=this.sceneObjects[b];
e.hasEvents()&&e.getEventHandler().update(a)}this.lockState=!1;if(this.lockRemovals){b=0;for(c=this.lockRemovals.length;b<c;b++)this.removeSceneObject(this.lockRemovals[b])}this.lockRemovals=null},render:function(a){++this.frames;a=a||{};a.postProcess&&a.postProcess.begin(!a.postBuffer);var c=g.gl,e;e=this.octree!==r;this.lights_rendered=0;e&&(this.octree.reset_node_visibility(),this.octree.cleanup(),e=this.octree.get_frustum_hits(this.camera),this.lights_rendered=e.lights.length);this.doTransform();
this.updateCamera();this.updateShadows(!0);this.shadows_updated=!1;var d;e=0;for(d=this.lights.length;e<d;e++)this.lights[e].prepare(this.camera);this.objects_rendered=0;var n=[],q=[],u=this.lights;e=0;for(d=this.sceneObjects.length;e<d;e++){var z=this.sceneObjects[e];!1===z.visible||null!==z.parent||this.renderSceneObject(z,this.camera,u,!0,!0,!1,q)}e=0;for(d=q.length;e<d;e++)this.renderSceneObject(q[e],this.camera,u,!1,!1,!0);this.collect_stats&&(this.stats["objects.num_rendered"]=this.objects_rendered,
this.stats["lights.num_rendered"]=this.lights_rendered,this.stats["lights.rendered"]=n,this.stats["lights.num_global"]=this.global_lights.length,this.stats["lights.num_dynamic"]=this.dynamic_lights.length);null!==this.skybox&&!0===this.skybox.ready&&(c.cullFace(c.FRONT),e=2*this.camera.farclip/Math.sqrt(3),this.skybox.scene_object.position=this.camera.parent?b.vec3_multiply(this.camera.position,this.camera.parent.tMatrix):[this.camera.position[0],this.camera.position[1],this.camera.position[2]],this.skybox.scene_object.scale=
[e,e,e],this.skybox.scene_object.doTransform(),h.renderObject(this.skybox.scene_object.obj,this.camera,this.skybox.scene_object.tMatrix,[]),c.cullFace(c.BACK));a.postProcess&&(a.postProcess.end(),a.postBuffer||a.postProcess.render())},bbRayTest:function(a,b,e){var c=h.vec3,d=[],b=2===b.length?this.camera.unProject(b[0],b[1]):c.add(a,b),g;for(g in this.pickables)if(this.pickables.hasOwnProperty(g)){var u=this.pickables[g];if(!0===u.visible){var n,q;q=u.getAABB();n=q[0];q=q[1];0.2>q[0]-n[0]&&(n[0]-=
0.1,q[0]+=0.1);0.2>q[1]-n[1]&&(n[1]-=0.1,q[1]+=0.1);0.2>q[2]-n[2]&&(n[2]-=0.1,q[2]+=0.1);var r=c.multiply(c.add(n,q),0.5),w=c.getClosestTo(a,b,r),r=c.length(c.subtract(w,r));(w[0]>=n[0]&&w[0]<=q[0]?1:0)+(w[1]>=n[1]&&w[1]<=q[1]?1:0)+(w[2]>=n[2]&&w[2]<=q[2]?1:0)>=e&&d.push({dist:r,obj:u})}}d.length&&d.sort(function(a,b){return a.dist==b.dist?0:a.dist<b.dist?-1:1});return d}};n.prototype={addMesh:function(a,b,e){this.meshBin[a]===r&&(this.meshBin[a]=[],this.meshBinPtr[a]===r&&(this.meshBinPtr[a]=0));
this.meshMap[b]===r&&(this.meshMap[b]=e,this.meshBin[a].push(e))},addImage:function(a,b,e){this.imageBin[a]===r&&(this.imageBin[a]=[],this.imageBinPtr[a]===r&&(this.imageBinPtr[a]=0));this.imageMap[b]===r&&(this.imageMap[b]=e,this.imageBin[a].push(e))},getMeshes:function(a){return this.meshBin[a]},getImages:function(a){return this.imageBin[a]},rewindMeshes:function(a){this.meshBinPtr[a]=0},rewindImages:function(a){this.imageBinPtr[a]=0},getNextMesh:function(a){var b=this.meshBinPtr[a];return b<this.meshBin[a].length?
(this.meshBinPtr[a]++,this.meshBin[a][b]):null},loadNextMesh:function(a){a=this.getNextMesh(a);return null!==a?(null===a.compiled&&(a.triangulateQuads(),a.compile(),a.clean()),!0):!1},isMeshBinEmpty:function(a){return this.meshBinPtr[a]===this.meshBin[a].length},loadNextImage:function(a){a=this.getNextImage(a);null!==a&&(a.src=a.deferredSrc)},getNextImage:function(a){var b=this.imageBinPtr[a];return b<this.imageBin[a].length?(this.imageBinPtr[a]++,this.imageBin[a][b]):null},isImageBinEmpty:function(a){return this.imageBinPtr[a]===
this.imageBin[a].length}};return{Scene:q,SceneObject:w,SkyBox:function(a){var b=a.texture,a=a.mapping,e=this;this.mapping=null;this.ready=!1;this.texture=null;this.onready=function(){b.onready=null;var a=1/h.Images[e.texture.tex_id].width;null===e.mapping&&(e.mapping=[[1/3,0.5,2/3-a,1],[0,0.5,1/3,1],[0,0,1/3-a,0.5],[2/3,0,1,0.5],[2/3+a,0.5,1,1],[1/3,0,2/3,0.5]]);var a=new h.Material({name:"skybox",textures:{color:b},noFog:!0}),c=new h.Mesh;c.sky_mapping=e.mapping;h.primitives.box({mesh:c,size:1,material:a,
uvmapper:{projectionMode:h.enums.uv.projection.SKY,scale:[1,1,1]}});c.prepare();e.scene_object=new h.SceneObject(c);e.ready=!0};if(b&&("string"===typeof b?b=new h.Texture(b,null,null,null,this.onready):b.loaded||(b.onready=this.onready),this.texture=b,a))this.mapping=a,this.onready()},DeferredBin:n}});
CubicVR.RegisterModule("PostProcess",function(h){function y(a){if(a.shader_vertex===n||a.shader_fragment===n)return null;this.outputMode=a.outputMode===n?c.post.output.REPLACE:CubicVR.parseEnum(CubicVR.enums.post.output,a.outputMode);this.onresize=a.onresize===n?null:a.onresize;this.onupdate=a.onupdate===n?null:a.onupdate;this.init=a.init===n?null:a.init;this.enabled=a.enabled===n?!0:a.enabled;this.outputDivisor=a.outputDivisor===n?1:a.outputDivisor;this.shader=new CubicVR.Shader(a.shader_vertex,
a.shader_fragment);this.shader.use();this.shader.addUVArray("aTex");this.shader.addVertexArray("aVertex");this.shader.addInt("srcTex",0);this.shader.addInt("captureTex",1);this.shader.addVector("texel");null!==this.init&&this.init(this.shader)}function w(a,e,c){var f=r.gl;this.width=a;this.height=e;this.accum=c===n?!1:!0;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer=new CubicVR.RenderBuffer(a,e,!0);this.bufferA=new CubicVR.RenderBuffer(a,e,!1);this.bufferB=new CubicVR.RenderBuffer(a,
e,!1);this.bufferC=new CubicVR.RenderBuffer(a,e,!1);this.accumOpacity=1;this.accumIntensity=0.3;this.accum&&(this.accumBuffer=new CubicVR.RenderBuffer(a,e,!1),this.accumBuffer.use(),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT),this.blur_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void)\n{\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nuniform float opacity;\nvoid main(void)\n{ gl_FragColor = vec4(texture2D(srcTex, vTex).rgb, opacity);\n}",
init:function(a){a.addFloat("opacity");a.setFloat("opacity",1)}}));this.bufferA.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.bufferB.use();f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT);this.end();this.fsQuad=this.makeFSQuad(this.width,this.height);this.shaders=[];this.copy_shader=new y({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\ngl_Position = vPos;\n}",shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nvarying vec2 vTex;\nvoid main(void) {\ngl_FragColor = texture2D(srcTex, vTex);\n}"});
this.resize(a,e)}function q(a,e,c){this.createBuffer(a,e,c)}var n=h.undef,r=h.GLCore,c=CubicVR.enums;c.post={output:{REPLACE:0,BLEND:1,ADD:2,ALPHACUT:3}};var g=[],a=[];w.prototype={setBlurOpacity:function(a){this.accumOpacity=a},setBlurIntensity:function(a){this.accumIntensity=a},makeFSQuad:function(a,e){var c=r.gl,f={},g=a/a,o=e/e;f.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);f.vbo_uvs=new Float32Array([0,0,g,0,g,o,0,o,0,0,g,o]);f.gl_points=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,
f.gl_points);c.bufferData(c.ARRAY_BUFFER,f.vbo_points,c.STATIC_DRAW);f.gl_uvs=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,f.gl_uvs);c.bufferData(c.ARRAY_BUFFER,f.vbo_uvs,c.STATIC_DRAW);return f},destroyFSQuad:function(a){var c=r.gl;c.deleteBuffer(a.gl_points);c.deleteBuffer(a.gl_uvs)},renderFSQuad:function(a,c){var d=r.gl;a.use();d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.bindBuffer(d.ARRAY_BUFFER,c.gl_points);d.vertexAttribPointer(a.aVertex,3,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aVertex);
d.bindBuffer(d.ARRAY_BUFFER,c.gl_uvs);d.vertexAttribPointer(a.aTex,2,d.FLOAT,!1,0,0);d.enableVertexAttribArray(a.aTex);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null);d.drawArrays(d.TRIANGLES,0,6)},addShader:function(b){this.shaders[this.shaders.length]=b;b.shader.use();b.shader.setVector("texel",this.vTexel);if(b.outputDivisor&&1!=b.outputDivisor&&g[b.outputDivisor]===n){var c=this.width/b.outputDivisor|0,d=this.height/b.outputDivisor|0;g[b.outputDivisor]=new CubicVR.RenderBuffer(c,d,!1);a[b.outputDivisor]=
this.makeFSQuad(c,d)}},resize:function(b,c){var d=r.gl;this.width=b;this.height=c;this.vTexel=[1/this.width,1/this.height,0];this.captureBuffer.destroyBuffer();this.captureBuffer.createBuffer(this.width,this.height,!0);this.bufferA.destroyBuffer();this.bufferA.createBuffer(this.width,this.height,!1);this.bufferB.destroyBuffer();this.bufferB.createBuffer(this.width,this.height,!1);this.bufferC.destroyBuffer();this.bufferC.createBuffer(this.width,this.height,!1);this.accum&&(this.accumBuffer.destroyBuffer(),
this.accumBuffer.createBuffer(this.width,this.height,!1),this.accumBuffer.use(),d.clearColor(0,0,0,1),d.clear(d.COLOR_BUFFER_BIT));for(var f in g){var d=this.width/f|0,m=this.height/f|0;g[f].destroyBuffer();g[f].createBuffer(d,m,!1);this.destroyFSQuad(a[f]);a[f]=this.makeFSQuad(d,m)}this.inputBuffer=this.bufferA;this.outputBuffer=this.bufferB;f=0;for(d=this.shaders.length;f<d;f++)if(this.shaders[f].shader.use(),this.shaders[f].shader.setVector("texel",this.vTexel),null!==this.shaders[f].onresize)this.shaders[f].onresize(this.shaders[f].shader,
this.width,this.height);this.destroyFSQuad(this.fsQuad);this.fsQuad=this.makeFSQuad(this.width,this.height)},swap:function(){var a=this.inputBuffer;this.inputBuffer=this.outputBuffer;this.outputBuffer=a},begin:function(a){var c=r.gl;this.captureBuffer.use();a&&(this.captureBuffer.depth?c.clear(c.DEPTH_BUFFER_BIT|c.COLOR_BUFFER_BIT):c.clear(c.COLOR_BUFFER_BIT))},end:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null)},render:function(){var b=r.gl;this.captureBuffer.texture.use(b.TEXTURE1);
this.outputBuffer.use();this.captureBuffer.texture.use(b.TEXTURE0);b.clearColor(0,0,0,1);b.clear(b.COLOR_BUFFER_BIT);this.renderFSQuad(this.copy_shader.shader,this.fsQuad);this.end();for(var e=0,d=0,f=this.shaders.length;d<f;d++){var m=this.shaders[d];if(m.enabled){this.swap();this.inputBuffer.texture.use(b.TEXTURE0);var o=m.outputMode;if(o===c.post.output.REPLACE)1!==m.outputDivisor?g[m.outputDivisor].use():this.outputBuffer.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);else if(o===c.post.output.ADD||
o===c.post.output.BLEND)1!==m.outputDivisor?g[m.outputDivisor].use():this.bufferC.use(),b.clearColor(0,0,0,1),b.clear(b.COLOR_BUFFER_BIT);null!==m.onupdate&&(m.shader.use(),m.onupdate(m.shader));1!==m.outputDivisor?(b.viewport(0,0,g[m.outputDivisor].width,g[m.outputDivisor].height),this.renderFSQuad(m.shader,a[m.outputDivisor]),m.outputMode===c.post.output.REPLACE?(this.outputBuffer.use(),g[m.outputDivisor].texture.use(b.TEXTURE0),b.viewport(0,0,this.width,this.height),this.renderFSQuad(this.copy_shader.shader,
this.fsQuad)):b.viewport(0,0,this.width,this.height)):this.renderFSQuad(m.shader,this.fsQuad);o===c.post.output.BLEND?(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.ONE,b.ONE_MINUS_SRC_ALPHA),this.inputBuffer.texture.use(b.TEXTURE0),1!==m.outputDivisor?g[m.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND)):o===c.post.output.ADD&&(this.swap(),this.outputBuffer.use(),b.enable(b.BLEND),
b.blendFunc(b.ONE,b.ONE),1!==m.outputDivisor?g[m.outputDivisor].texture.use(b.TEXTURE0):this.bufferC.texture.use(b.TEXTURE0),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.disable(b.BLEND));this.end();e++}}0===e?this.captureBuffer.texture.use(b.TEXTURE0):this.outputBuffer.texture.use(b.TEXTURE0);this.accum&&1!==this.accumOpacity?(this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumOpacity),this.accumBuffer.use(),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),
this.renderFSQuad(this.blur_shader.shader,this.fsQuad),this.end(),b.disable(b.BLEND),this.renderFSQuad(this.copy_shader.shader,this.fsQuad),b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),this.blur_shader.shader.use(),this.blur_shader.shader.setFloat("opacity",this.accumIntensity),this.accumBuffer.texture.use(b.TEXTURE0),this.renderFSQuad(this.blur_shader.shader,this.fsQuad),b.disable(b.BLEND)):this.renderFSQuad(this.copy_shader.shader,this.fsQuad)}};q.prototype={createBuffer:function(a,
c,d){this.texture=this.depth=this.fbo=null;this.width=parseInt(a,10);this.height=parseInt(c,10);var a=this.sizeParam(a),c=this.sizeParam(c),f=r.gl;this.fbo=f.createFramebuffer();d&&(this.depth=f.createRenderbuffer());f.bindFramebuffer(f.FRAMEBUFFER,this.fbo);d&&(f.bindRenderbuffer(f.RENDERBUFFER,this.depth),-1!==navigator.appVersion.indexOf("Windows")?(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,a,c),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depth)):
(f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_STENCIL,a,c),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.RENDERBUFFER,this.depth)));this.texture=new CubicVR.Texture;f.bindTexture(f.TEXTURE_2D,h.Textures[this.texture.tex_id]);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE);f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);f.texImage2D(f.TEXTURE_2D,
0,f.RGBA,a,c,0,f.RGBA,f.UNSIGNED_BYTE,null);f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,h.Textures[this.texture.tex_id],0);f.bindFramebuffer(f.FRAMEBUFFER,null)},destroyBuffer:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteRenderbuffer(this.depth);a.deleteFramebuffer(this.fbo);a.deleteTexture(h.Textures[this.texture.tex_id]);h.Textures[this.texture.tex_id]=null},sizeParam:function(a){return a},use:function(){var a=r.gl;a.bindFramebuffer(a.FRAMEBUFFER,
this.fbo)}};return{RenderBuffer:q,PostProcessShader:y,PostProcessChain:w,fsQuad:{make:w.prototype.makeFSQuad,destroy:w.prototype.destroyFSQuad,render:w.prototype.renderFSQuad}}});
CubicVR.RegisterModule("Layout",function(){function h(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="view";this.superView=null;this.childViews=[];this.panel=null}function y(h){this.texture=h.texture?h.texture:null;this.width=h.width?h.width:128;this.height=h.height?h.height:128;
this.x=h.x?h.x:0;this.y=h.y?h.y:0;this.blend=h.blend?h.blend:!1;this.opacity="undefined"!==typeof h.opacity?h.opacity:1;this.tint=h.tint?h.tint:[1,1,1];this.type="root";this.superView=null;this.childViews=[];this.setupShader();this.panel=null;this.makePanel(this)}h.prototype={addSubview:function(h){this.childViews.push(h);h.superView=this},makePanel:function(h){return this.superView.makePanel(h)}};y.prototype={resize:function(h,q){this.width=h;this.height=q},setupShader:function(){this.shader=new CubicVR.PostProcessShader({shader_vertex:"attribute vec3 aVertex;\nattribute vec2 aTex;\nvarying vec2 vTex;\nuniform vec3 screen;\nuniform vec3 position;\nuniform vec3 size;\nvoid main(void) {\nvTex = aTex;\nvec4 vPos = vec4(aVertex.xyz,1.0);\nvPos.x *= size.x/screen.x;\nvPos.y *= size.y/screen.y;\nvPos.x += (size.x/screen.x);\nvPos.y -= (size.y/screen.y);\nvPos.x += (position.x/screen.x)*2.0 - 1.0;\nvPos.y -= (position.y/screen.y)*2.0 - 1.0;\ngl_Position = vPos;\n}",
shader_fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D srcTex;\nuniform vec3 tint;\nvarying vec2 vTex;\nvoid main(void) {\nvec4 color = texture2D(srcTex, vTex)*vec4(tint,1.0);\ngl_FragColor = color;\n}",init:function(h){h.setInt("srcTex",0);h.addVector("screen");h.addVector("position");h.addVector("tint");h.addVector("size")}})},addSubview:function(h){this.childViews.push(h);h.superView=this},removeSubview:function(h){h=this.childViews.indexOf(h);-1<h&&this.childViews.splice(h,
1)},makePanel:function(h){var q=CubicVR.GLCore.gl,n={};n.vbo_points=new Float32Array([-1,-1,0,1,-1,0,1,1,0,-1,1,0,-1,-1,0,1,1,0]);n.vbo_uvs=new Float32Array([0,0,1,0,1,1,0,1,0,0,1,1]);n.gl_points=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,n.gl_points);q.bufferData(q.ARRAY_BUFFER,n.vbo_points,q.STATIC_DRAW);n.gl_uvs=q.createBuffer();q.bindBuffer(q.ARRAY_BUFFER,n.gl_uvs);q.bufferData(q.ARRAY_BUFFER,n.vbo_uvs,q.STATIC_DRAW);h.panel=n},renderPanel:function(h){if(!h.texture)return!1;h.texture.use(CubicVR.GLCore.gl.TEXTURE0)},
renderView:function(h){if(h.texture){var q=CubicVR.GLCore.gl,n=h.offsetLeft,r=h.offsetTop;n||(n=0);r||(r=0);var c=this.shader.shader;c.use();c.setVector("screen",[this.width,this.height,0]);c.setVector("position",[h.x+n,h.y+r,0]);c.setVector("size",[h.width,h.height,0]);c.setVector("tint",h.tint);h.blend&&(q.enable(q.BLEND),q.blendFunc(q.SRC_ALPHA,q.ONE_MINUS_SRC_ALPHA));h.texture.use(q.TEXTURE0);q.drawArrays(q.TRIANGLES,0,6);h.blend&&(q.disable(q.BLEND),q.blendFunc(q.ONE,q.ZERO))}},render:function(){var h=
CubicVR.GLCore.gl;h.disable(h.DEPTH_TEST);this.texture&&this.renderView(this);var q=[];this.offsetTop=this.offsetLeft=0;q.push(this);var n=this.shader.shader;n.use();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_points);h.vertexAttribPointer(n.uniforms.aVertex,3,h.FLOAT,!1,0,0);h.enableVertexAttribArray(n.uniforms.aVertex);h.bindBuffer(h.ARRAY_BUFFER,this.panel.gl_uvs);h.vertexAttribPointer(n.uniforms.aTex,2,h.FLOAT,!1,0,0);h.enableVertexAttribArray(n.uniforms.aTex);
for(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null);q.length;){var r=q.pop();this.renderView(r);if(r.childViews.length)for(var c=r.childViews.length-1;0<=c;c--)r.childViews[c].offsetLeft=r.x+r.offsetLeft,r.childViews[c].offsetTop=r.y+r.offsetTop,q.push(r.childViews[c])}h.disableVertexAttribArray(n.uniforms.aTex);h.enable(h.DEPTH_TEST)}};return{Layout:y,View:h}});
CubicVR.RegisterModule("Primitives",function(h){function y(a,b,c,e,g,m){var n=h.mat4,q=h.vec3,r=[],t,x=[0,1,0],w=[1,0,0],A=[0,0,0],y=a.points.length,I,G,J;for(I=t=0;I<f&&t!==c;I+=f/c){w=[Math.cos(I),0,Math.sin(I)];G=0;for(J=b.length;G<J;G++)A=q.add(q.multiply(w,b[G][0]),q.multiply(x,b[G][1])),r[t]===d&&(r[t]=[]),r[t].push(A);t++}J=null;g!==d&&(J=g.getResult!==d?g.getResult():g);for(G=0;G<c;G++){g=0;for(t=b.length;g<t;g++)J?a.addPoint(n.vec3_multiply(r[G][g],J)):a.addPoint(r[G][g])}"string"===typeof e&&
(e=new h.Material(e));a.setFaceMaterial(e);for(g=0;g<c;g++){G=0;for(J=b.length-1;G<J;G++)n=G+b.length*g,r=G+b.length*((g+1)%c),q.equal(a.points[y+n],a.points[y+r])?a.addFace([y+n+1,y+r+1,y+r]):q.equal(a.points[y+n+1],a.points[y+r+1])?a.addFace([y+n,y+n+1,y+r]):a.addFace([y+n,y+n+1,y+r+1,y+r])}m!==d&&(b=null,m.apply!==d?b=m:m&&(b=new h.UVMapper(m)),null!==b&&(a.calcFaceNormals(),b.apply(a,e)))}function w(a,b,c,e,f){var g=h.mat4,b=0.5*b,m=a.points.length;"string"===typeof c&&(c=new h.Material(c));a.setFaceMaterial(c);
e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([g.vec3_multiply([b,-b,0],e),g.vec3_multiply([b,b,0],e),g.vec3_multiply([-b,b,0],e),g.vec3_multiply([-b,-b,0],e)])):a.addPoint([[b,-b,0],[b,b,0],[-b,b,0],[-b,-b,0]]);a.addFace([[m+0,m+1,m+2,m+3],[m+3,m+2,m+1,m+0]]);f!==d&&(g=null,f.apply!==d?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,c)))}function q(a,b,c,e,f){var g=h.mat4,m,n;"object"===typeof b?(m=b[0]/2,n=b[1]/2,b=b[2]/2):m=n=b/=2;var q=a.points.length;"string"===typeof c&&
(c=new h.Material(c));a.setFaceMaterial(c);e!==d?(e=e.getResult!==d?e.getResult():e,a.addPoint([g.vec3_multiply([m,-n,b],e),g.vec3_multiply([m,n,b],e),g.vec3_multiply([-m,n,b],e),g.vec3_multiply([-m,-n,b],e),g.vec3_multiply([m,-n,-b],e),g.vec3_multiply([m,n,-b],e),g.vec3_multiply([-m,n,-b],e),g.vec3_multiply([-m,-n,-b],e)])):a.addPoint([[m,-n,b],[m,n,b],[-m,n,b],[-m,-n,b],[m,-n,-b],[m,n,-b],[-m,n,-b],[-m,-n,-b]]);a.addFace([[q+0,q+1,q+2,q+3],[q+7,q+6,q+5,q+4],[q+4,q+5,q+1,q+0],[q+5,q+6,q+2,q+1],[q+
6,q+7,q+3,q+2],[q+7,q+4,q+0,q+3]]);f!==d&&(g=null,f.apply!==d?g=f:f&&(g=new h.UVMapper(f)),null!==g&&(a.calcFaceNormals(),g.apply(a,c)))}function n(a,b,c,e,d,g,m,n){for(var q=[],c=c-b,b=b+c/2,r=f/d,x=0,w=0;w<=d;w++)q.push([b+Math.cos(x)*c,Math.sin(x)*c,0]),x+=r;h.genLatheObject(a,q,e,g,m,n)}function r(a,b,c,e,d,f,g){h.genLatheObject(a,[[0,-c/2,0],[b/2,-c/2,0],[0,c/2,0]],e,d,f,g)}function c(a,b,c,e,d,f,g){h.genLatheObject(a,[[0,-c/2,0],[b,-c/2,0],[b,c/2,0],[0,c/2,0]],e,d,f,g)}function g(a,b,c,e,d,
f,g){for(var n=[],e=(e/=2)|0,c=c|0,q=Math.PI/e,r=-m,x=0;x<=e;x++)n.push([Math.cos(r)*b,Math.sin(r)*b,0]),r+=q;h.genLatheObject(a,n,c,d,f,g)}function a(a){"string"===typeof a&&(a=h.get(a,h.Material));return a===d?new h.Material:a.use?a:"object"===typeof a?new h.Material(a):new h.Material}function b(a){if(a===d)return d;if("array"===typeof a)return a;if("object"===typeof a)return a.getResult?a.getResult():a.position||a.rotation||a.scale?h.mat4.transform(a.position,a.rotation,a.scale):d}function e(a){"string"===
typeof a&&(a=h.get(a));return a===d?d:a.apply?a:"object"===typeof a?new h.UVMapper(a):d}var d=h.undef,f=2*Math.PI,m=Math.PI/2;return{genPlaneObject:w,genBoxObject:q,genLatheObject:y,genTorusObject:n,genConeObject:r,genCylinderObject:c,genSphereObject:g,primitives:{lathe:function(c){var f,g,m,n;if(c.points==d)return null;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);g=a(c.material);m=b(c.transform);n=e(c.uvmapper||c.uv);y(f,c.points,c.divisions!==d?c.divisions:24,g,m,n);return f},box:function(c){var f,
g,m,n;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);g=a(c.material);m=b(c.transform);n=e(c.uvmapper||c.uv);q(f,c.size!==d?c.size:1,g,m,n);return f},plane:function(c){var f,g,m,n;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);g=a(c.material);m=b(c.transform);n=e(c.uvmapper||c.uv);w(f,c.size!==d?c.size:1,g,m,n);return f},sphere:function(c){var f,m,n,u;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);m=a(c.material);n=b(c.transform);u=e(c.uvmapper||c.uv);g(f,c.radius!==d?c.radius:1,c.lon!==
d?c.lon:24,c.lat!==d?c.lat:24,m,n,u);return f},torus:function(c){var f,g,m,u;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);g=a(c.material);m=b(c.transform);u=e(c.uvmapper||c.uv);n(f,c.innerRadius!==d?c.innerRadius:0.75,c.outerRadius!==d?c.outerRadius:1,c.lon!==d?c.lon:24,c.lat!==d?c.lat:24,g,m,u);return f},cone:function(c){var f,g,m,n;f=c.mesh!==d?c.mesh:new h.Mesh(c.name!==d?c.name:d);g=a(c.material);m=b(c.transform);n=e(c.uvmapper||c.uv);r(f,c.base!==d?c.base:1,c.height!==d?c.height:1,c.lon!==
d?c.lon:24,g,m,n);return f},cylinder:function(f){var g,m,n,u;g=f.mesh!==d?f.mesh:new h.Mesh(f.name!==d?f.name:d);m=a(f.material);n=b(f.transform);u=e(f.uvmapper||f.uv);c(g,f.radius!==d?f.radius:1,f.height!==d?f.height:1,f.lon!==d?f.lon:24,m,n,u);return g}}}});
CubicVR.RegisterModule("COLLADA",function(h){function y(g,a){function b(a){return!a.color?!1:(a=a.color)?d.floatDelimArray(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")," "):!1}function e(a){return!a["float"]?!1:a=(a=a["float"])?parseFloat(a.$.replace(/ {2}/g," ").replace(/^\s+|\s+$/,"")):0}var d=h.util,f,m,o,n,D,v;v="object"==typeof g?g:-1!=g.indexOf(".js")?d.getJSON(g):h.util.xml2badgerfish(d.getXML(g));var u,z,B,C,y,t,x,F,A,E,I,G,J,L,M,K,N,Y,ca,U,na,Q=v;v=null;if(!Q.COLLADA)throw Error(g+" does not appear to be a valid COLLADA file.");
var Q=Q.COLLADA,O={up_axis:1,images:[],effects:[],materials:[],meshes:[],scenes:[],lights:[],cameras:[],animations:[]};if(Q.asset){var Ma=Q.asset.up_axis.$;"X_UP"===Ma?O.up_axis=0:"Y_UP"===Ma?O.up_axis=1:"Z_UP"===Ma&&(O.up_axis=2)}var gb=O.up_axis;if(Q.library_images&&(Q.library_images.image&&!Q.library_images.image.length&&(Q.library_images.image=[Q.library_images.image]),Q.library_images.image.length))for(var hb=Q.library_images.image,Na=0,qb=hb.length;Na<qb;Na++){var Oa=hb[Na],ib=Oa["@id"],Ic=
Oa["@name"],$b=Oa.init_from;if($b.$){var ra=$b.$;a!==w&&-1!==ra.lastIndexOf("/")&&(ra=ra.substr(ra.lastIndexOf("/")+1));a!==w&&-1!==ra.lastIndexOf("\\")&&(ra=ra.substr(ra.lastIndexOf("\\")+1));O.images[ib]={source:ra,id:ib,name:Ic}}}var jb,rb,ac,V,Pa,ka,Qa,da,P,W,S,Da,ha,Ra,Sa,Z,aa;if(Q.library_effects){var Ta=Q.library_effects.effect;Ta&&!Ta.length&&(Ta=[Ta]);rb=0;for(ac=Ta.length;rb<ac;rb++){var Db=Ta[rb];jb=Db["@id"];var T={};T.id=jb;T.surfaces=[];T.samplers=[];(da=Db.profile_COMMON.newparam)&&
!da.length&&(da=[da]);if(da){Y=0;for(ca=da.length;Y<ca;Y++){var sa=da[Y],Ua=sa["@sid"];if(sa.surface){T.surfaces[Ua]={};var bc=sa.surface.init_from.$;"object"===typeof O.images[bc]&&(T.surfaces[Ua].source=a+"/"+O.images[bc].source)}else if(sa.sampler2D&&(T.samplers[Ua]={},T.samplers[Ua].source=sa.sampler2D.source.$,sa.sampler2D.minfilter&&(T.samplers[Ua].minfilter=sa.sampler2D.minfilter.$),sa.sampler2D.magfilter))T.samplers[Ua].magfiter=sa.sampler2D.magfilter.$}}var va=Db.profile_COMMON.technique;
va&&!va.length&&(va=[va]);T.material={textures_ref:[]};V=0;for(Pa=va.length;V<Pa;V++){f=va[V].blinn;f||(f=va[V].phong);f||(f=va[V].lambert);if(f)for(var ea in f){var sb=f[ea],ta=b(sb),cc=e(sb),dc=!sb.texture?!1:sb.texture["@texture"];!1!==ta&&3<ta.length&&ta.pop();"emission"==ea?!1!==ta&&(T.material.ambient=ta):"ambient"!=ea&&("diffuse"==ea?!1!==ta&&(T.material.color=ta):"specular"==ea?!1!==ta&&(T.material.specular=ta):"shininess"==ea&&!1!==cc&&(T.material.shininess=cc));if(!1!==dc){var Va=T.surfaces[T.samplers[dc].source].source;
"emission"==ea?T.material.textures_ref.push({image:Va,type:q.texture.map.AMBIENT}):"ambient"==ea?T.material.textures_ref.push({image:Va,type:q.texture.map.AMBIENT}):"diffuse"==ea?T.material.textures_ref.push({image:Va,type:q.texture.map.COLOR}):"specular"==ea?T.material.textures_ref.push({image:Va,type:q.texture.map.SPECULAR}):"shininess"!=ea&&("reflective"==ea?T.material.textures_ref.push({image:Va,type:q.texture.map.REFLECT}):"reflectivity"!=ea&&"transparent"==ea&&T.material.textures_ref.push({image:Va,
type:q.texture.map.ALPHA}))}}O.effects[jb]=T}}}var Eb=c.getAllOf(Q,"instance_geometry"),tb=[];if(Eb.length){t=0;for(F=Eb.length;t<F;t++){var ec=Eb[t],Fb=c.getAllOf(ec,"instance_material");if(Fb.length){U=0;for(na=Fb.length;U<na;U++){var fc=Fb[U],Jc=fc["@symbol"],Kc=fc["@target"].substr(1);tb[ec["@url"].substr(1)+":"+Jc]=Kc}}}}var Gb=Q.library_materials;if(Gb&&Gb.material){var Wa=Gb.material;Wa&&!Wa.length&&(Wa=[Wa]);E=0;for(I=Wa.length;E<I;E++){var Hb=Wa[E],Lc=Hb["@id"],Mc=Hb["@name"],gc=Hb.instance_effect;
gc&&(jb=gc["@url"].substr(1),O.materials.push({id:Lc,name:Mc,mat:O.effects[jb].material}))}}var hc=Q.library_geometries,Xa;if(hc){var ua=hc.geometry;ua&&!ua.length&&(ua=[ua]);if(ua.length)for(var kb=0,Nc=ua.length;kb<Nc;kb++){var ma={id:w,points:[],parts:[]},Ya=ua[kb].mesh;if(Ya){Xa=ua[kb]["@id"];D=ua[kb]["@name"];var Za=Ya.source;Za&&!Za.length&&(Za=[Za]);for(var R=[],Ib=0,Oc=Za.length;Ib<Oc;Ib++){var ub=Za[Ib];m=ub["@id"];var Pc=ub["@name"],Jb=ub.float_array;Jb&&(R[m]={id:m,name:Pc,data:d.floatDelimArray(Jb.$?
Jb.$:""," ")});var Kb=ub.technique_common.accessor;Kb&&(R[m].count=Kb["@count"]|0,R[m].stride=Kb["@stride"]|0,R[m].count&&(R[m].data=d.repackArray(R[m].data,R[m].stride,R[m].count)))}var Lb=Ya.vertices,lb=null,Mb=null,Ea=null,Fa=null,Ga=null;if(Lb&&(Mb=Lb["@id"],(P=Lb.input)&&!P.length&&(P=[P]),P)){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],"POSITION"===W["@semantic"]&&(lb=W["@source"].substr(1))}var oa=Ya.triangles;oa&&!oa.length&&(oa=[oa]);if(oa){V=0;for(Pa=oa.length;V<Pa;V++){aa={material:0,faces:[],
normals:[],texcoords:[],colors:[]};var Qc=parseInt(oa[V]["@count"],10);(P=oa[V].input)&&!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++)W=P[ka],Z=parseInt(W["@offset"],10),n=W["@source"].substr(1),"VERTEX"===W["@semantic"]?(n===Mb&&(n=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=n,R[Ea].count&&(S[Z]=1)):"TEXCOORD"===W["@semantic"]?(Ga=n,R[Ga].count&&(S[Z]=2)):"COLOR"===W["@semantic"]?(Fa=n,R[Fa].count&&(S[Z]=3)):S[Z]=4}C=S.length;o=Xa+":"+oa[V]["@material"];null===o?aa.material=
0:tb[o]===w?(r("missing material ["+o+"]@"+Xa+"?"),aa.material=0):aa.material=tb[o];var ic=oa[V].p,wa=[];ic&&(wa=d.intDelimArray(ic.$," "));if(wa.length&&(y=wa.length/S.length/3,y===Qc)){0===ma.points.length&&(ma.points=R[lb].data);t=Z=0;F=wa.length;for(A=S.length;t<F;t+=3*A){u=[];z=[];B=[];ia=[];for(U=0;U<3*A;U++){var vb=U%A;0===S[vb]?z.push(wa[t+U]):1===S[vb]?u.push(wa[t+U]):2===S[vb]?B.push(wa[t+U]):3===S[vb]&&ia.push(wa[t+U])}z.length&&(aa.faces.push(z),3===u.length&&aa.normals.push([c.fixuaxis(O.up_axis,
R[Ea].data[u[0]]),c.fixuaxis(O.up_axis,R[Ea].data[u[1]]),c.fixuaxis(O.up_axis,R[Ea].data[u[2]])]),3===B.length&&aa.texcoords.push([R[Ga].data[B[0]],R[Ga].data[B[1]],R[Ga].data[B[2]]]),3===ia.length&&aa.colors.push([R[Fa].data[ia[0]],R[Fa].data[ia[1]],R[Fa].data[ia[2]]]))}}ma.parts.push(aa)}}var ja=Ya.polylist;ja||(ja=Ya.polygons);ja&&!ja.length&&(ja=[ja]);if(ja){V=0;for(Pa=ja.length;V<Pa;V++){aa={material:0,faces:[],normals:[],texcoords:[],colors:[]};var jc=parseInt(ja[V]["@count"],10);(P=ja[V].input)&&
!P.length&&(P=[P]);S=[];if(P.length){ka=0;for(Qa=P.length;ka<Qa;ka++){W=P[ka];var Nb=W["@offset"];null===Nb&&(Nb=W["@idx"]);Z=parseInt(Nb,10);n=W["@source"].substr(1);"VERTEX"===W["@semantic"]?(n===Mb&&(n=lb),S[Z]=0):"NORMAL"===W["@semantic"]?(Ea=n,S[Z]=1):"TEXCOORD"===W["@semantic"]?(Ga=n,S[Z]=2):"COLOR"===W["@semantic"]?(Fa=n,S[Z]=3):S[Z]=4}}var kc=ja[V].vcount,$a=[];kc&&($a=d.intDelimArray(kc.$," "));o=Xa+":"+ja[V]["@material"];aa.material=o===w?0:tb[o];var mb=ja[V].p;C=S.length;var xa=[];if(1<
mb.length&&!$a.length){Y=0;for(ca=mb.length;Y<ca;Y++){var lc=d.intDelimArray(mb[Y].$," ");$a[Y]=parseInt(lc.length/C,10);xa=xa.concat(lc)}}else mb&&(xa=d.intDelimArray(mb.$," "));if(xa.length)if(y=$a.length,y!==jc)r("poly vcount data doesn't add up, skipping object load: "+y+" !== "+jc);else{0===ma.points.length&&(ma.points=R[lb].data);t=Z=0;for(F=$a.length;t<F;t++){u=[];z=[];B=[];ia=[];U=0;for(na=$a[t]*C;U<na;U++)0===S[U%C]?z.push(xa[Z]):1===S[U%C]?u.push(xa[Z]):2===S[U%C]?B.push(xa[Z]):3===S[U%
C]&&ia.push(xa[Z]),Z++;var ab;if(z.length){aa.faces.push(z);if(u.length){$=[];G=0;for(J=u.length;G<J;G++)$.push(c.fixuaxis(O.up_axis,R[Ea].data[u[G]]));aa.normals.push($)}if(B.length){ab=[];G=0;for(J=B.length;G<J;G++)ab.push(R[Ga].data[B[G]]);aa.texcoords.push(ab)}if(ia.length){ab=[];G=0;for(J=ia.length;G<J;G++)ab.push(R[Fa].data[ia[G]]);aa.colors.push(ab)}}}}ma.parts.push(aa)}}if(1!==gb){t=0;for(F=ma.points.length;t<F;t++)ma.points[t]=c.fixuaxis(O.up_axis,ma.points[t])}ma.id=Xa;O.meshes.push(ma)}}}var mc=
Q.library_cameras;if(mc){(Ra=mc.camera)&&!Ra.length&&(Ra=[Ra]);L=0;for(M=Ra.length;L<M;L++){ha=Ra[L];var Rc=ha["@id"],wb=0,xb=0,yb=0;ha.optics&&(ha.optics.technique_common&&ha.optics.technique_common.perspective)&&(wb=ha.optics.technique_common.perspective.yfov,xb=ha.optics.technique_common.perspective.znear,yb=ha.optics.technique_common.perspective.zfar);var Ob,Pb,Qb;if(!wb&&!xb&&!yb){(da=ha.param)&&!da.length&&(da=[da]);t=0;for(F=da.length;t<F;t++){var Rb=da[t].$,Sb=da[t]["@name"];"YFOV"==Sb?Ob=
parseFloat(Rb):"ZNEAR"==Sb?Pb=parseFloat(Rb):"ZFAR"==Sb&&(Qb=parseFloat(Rb))}}else Ob=wb?parseFloat(wb.$):60,Pb=xb?parseFloat(xb.$):0.1,Qb=yb?parseFloat(yb.$):1E3;O.cameras.push({id:Rc,targeted:!1,fov:parseFloat(Ob),nearclip:parseFloat(Pb),farclip:parseFloat(Qb)})}}var nc=Q.library_lights,Ha;if(nc){var Ia=nc.light;Ia&&!Ia.length&&(Ia=[Ia]);var oc={point:"point",directional:"directional",spot:"spot"};if(Ia)for(var Tb=0,Sc=Ia.length;Tb<Sc;Tb++){Ha=Ia[Tb];var pc,nb,zb;for(zb in oc)if(Ha.technique_common[zb]){pc=
zb;nb=Ha.technique_common[zb];break}if(nb){var Tc=oc[pc]||"point",qc=Ha["@id"],rc=nb.intensity,Uc=rc?parseFloat(rc.$):1,sc=nb.distance,Vc=sc?parseFloat(sc.$):10,tc=nb.color,ia=[1,1,1];tc&&(ia=d.floatDelimArray(tc.$," "));O.lights.push({id:qc,name:qc,type:Tc,method:q.light.method.STATIC,diffuse:ia,specular:[0,0,0],distance:Vc,intensity:Uc})}}}var uc=Q.library_visual_scenes;if(uc){var bb=null;(bb=uc.visual_scene)&&!bb.length&&(bb=[bb]);for(var Ub=0,Wc=bb.length;Ub<Wc;Ub++){Sa=bb[Ub];var ya={id:Sa["@id"],
sceneObjects:[],cameras:[],lights:[],parentMap:[]},pa=[],cb=[],za,Vb,la,ba,$,vc=Q.library_nodes;if(vc){var db=vc.node;db&&!db.length&&(db=[db]);pa=[];t=0;for(F=db.length;t<F;t++)Vb=db[t],mnodeId=Vb["@id"],pa[la]=Vb;for(za=[Sa];za.length;){ba=za.pop();if(ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){t=0;for(F=$.length;t<F;t++)za.push($[t])}if(ba.instance_node){var eb=ba.instance_node;eb&&!eb.length&&(eb=[eb]);t=0;for(F=eb.length;t<F;t++){var Wb=eb[t]["@url"].substr(1);pa[Wb]&&(ba.node&&ba.node.length&&
(ba.node=[ba.node]),ba.node?ba.node.push(pa[Wb]):ba.node=[pa[Wb]])}}}}for(za=[Sa];za.length;)if(ba=za.pop(),ba.node&&(($=ba.node)&&!$.length&&($=[$]),$)){t=0;for(F=$.length;t<F;t++)$[t].parentNode=ba,cb.push($[t]),za.push($[t])}if(cb.length)for(var ob=0,Xc=cb.length;ob<Xc;ob++){var Aa=cb[ob],Ba=Aa.instance_geometry;Ha=cb[ob].instance_light;ha=cb[ob].instance_camera;la=Aa["@id"];var fa=Aa["@name"],ga=c.cl_getInitalTransform(O.up_axis,Aa);2===gb&&(ga.rotation=c.quaternionFilterZYYZ(ga.rotation,ha?[-90,
0,0]:w));var pb=null,X=null,fb;if(Ba){Ba&&!Ba.length&&(Ba=[Ba]);t=0;for(F=Ba.length;t<F;t++)if(D=Ba[t]["@url"].substr(1),X={},X.name=(fa?fa:la)+(t?t:""),X.id=(la?la:fa)+(t?t:""),X.meshId=Xa,X.meshName=D,pb||(X.position=ga.position,X.rotation=ga.rotation,X.scale=ga.scale,X.matrix=ga.matrix),ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode)(fb=Aa.parentNode["@id"])&&pa[fb]?ya.parentMap.push({parent:fb,child:X.id}):1<Ba.length&&(pb?pa[pb.id]&&ya.parentMap.push({parent:pb.id,child:X.id}):(pb=X,X={}))}else if(ha){var Yc=
ha["@url"].substr(1);ya.cameras.push({name:fa?fa:la,id:fa?fa:la,source:Yc,position:ga.position,rotation:ga.rotation})}else if(Ha){var Zc=Ha["@url"].substr(1);ya.lights.push({name:fa?fa:la,id:fa?fa:la,source:Zc,position:ga.position,rotation:ga.rotation||[0,0,0]})}else X={position:ga.position,rotation:ga.rotation,scale:ga.scale,matrix:ga.matrix},X.name=fa?fa:la,X.id=la?la:fa,ya.sceneObjects.push(X),pa[X.id]=!0,Aa.parentNode&&(fb=Aa.parentNode["@id"])&&pa[fb]&&ya.parentMap.push({parent:fb,child:X.id})}O.scenes.push(ya)}}var wc=
Q.library_animations,qa;if(wc){var Ja=wc.animation;Ja&&!Ja.length&&(Ja=[Ja]);if(Ja)for(var Xb=0,$c=Ja.length;Xb<$c;Xb++){var Ab=Ja[Xb];qa=Ab["@id"];O.animations[qa]={};O.animations[qa].sources=[];var Ka=Ab.source;Ka&&!Ka.length&&(Ka=[Ka]);if(Ka.length){K=0;for(N=Ka.length;K<N;K++){var Ca=Ka[K];m=Ca["@id"];var xc=Ca.technique_common,Bb=null,yc=null;Ca.name_array?Bb=d.textDelimArray(Ca.name_array.$," "):Ca.Name_array?Bb=d.textDelimArray(Ca.Name_array.$," "):Ca.float_array&&(yc=d.floatDelimArray(Ca.float_array.$,
" "));var Yb=0,zc="",Cb=1;if(xc){f=xc;var Zb=f.accessor,Yb=parseInt(Zb["@count"],10),zc=Zb["@source"].substr(1),Ac=Zb["@stride"];Ac&&(Cb=parseInt(Ac,10))}O.animations[qa].sources[m]={data:Bb?Bb:yc,count:Yb,source:zc,stride:Cb};1!==Cb&&(O.animations[qa].sources[m].data=d.repackArray(O.animations[qa].sources[m].data,Cb,Yb))}}(Da=Ab.sampler)&&!Da.length&&(Da=[Da]);if(Da){O.animations[qa].samplers=[];K=0;for(N=Da.length;K<N;K++){var Bc=Da[K],ad=Bc["@id"];(P=Bc.input)&&!P.length&&(P=[P]);if(P){var Cc=
[];x=0;for(F=P.length;x<F;x++)W=P[x],Cc[W["@semantic"]]=W["@source"].substr(1);O.animations[qa].samplers[ad]=Cc}}}var La=Ab.channel;La&&!La.length&&(La=[La]);if(La){O.animations[qa].channels=[];L=0;for(M=La.length;L<M;L++){var Dc=La[L],bd=Dc["@source"].substr(1),Ec=Dc["@target"],Fc=Ec.split("/"),cd=Fc[0],Gc=Fc[1].split(".");O.animations[qa].channels.push({source:bd,target:Ec,targetName:cd,paramName:Gc[0],typeName:Gc[1]})}}}}var Hc=Q.scene;if(Hc&&(Sa=Hc.instance_visual_scene)){var dd=Sa["@url"].substr(1);
O.scene=dd}return O}var w=h.undef,q=h.enums,n=h.GLCore,r=h.log,c={fixuaxis:function(c,a){if(0===c)return[a[1],a[0],a[2]];if(1===c)return a;if(2===c)return[a[0],a[2],-a[1]]},fixscaleaxis:function(c,a){if(0===c)return[a[1],a[0],a[2]];if(1===c)return a;if(2===c)return[a[0],a[2],a[1]]},fixukaxis:function(c,a,b,e){return a===q.motion.POS&&b===q.motion.Z&&c===q.motion.Z?-e:e},getAllOf:function(c,a){for(var b=[c],e=[],d,f,m,o;b.length;)for(f in d=b.pop(),d)if(d.hasOwnProperty(f)){if(f===a)if(d[f].length){m=
0;for(o=d[f].length;m<o;m++)e.push(d[f][m])}else e.push(d[f]);if("object"==typeof d[f])if(d[f].length){m=0;for(o=d[f].length;m<o;m++)b.push(d[f][m])}else b.push(d[f])}return e},quaternionFilterZYYZ:function(c,a){var b=h.vec3,e=c,d=new h.Quaternion;a!==w&&(e=b.add(c,a));d.fromEuler(e[0],e[2],-e[1]);return d.toEuler()},cl_getInitalTransform:function(g,a){var b=h.util,e={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},d=a.translate,f=a.rotate,m=a.scale;if(a.matrix&&!d&&!f&&!m)return e;d&&d.$&&(e.position=
c.fixuaxis(g,b.floatDelimArray(d.$," ")));if(f)for(var d=0,o=f.length;d<o;d++){var n=f[d],q=n["@sid"],n=b.floatDelimArray(n.$," ");if("rotateX"==q||"rotationX"==q)e.rotation[0]=n[3];else if("rotateY"==q||"rotationY"==q)e.rotation[1]=n[3];else if("rotateZ"==q||"rotationZ"==q)e.rotation[2]=n[3]}m&&(e.scale=c.fixscaleaxis(g,b.floatDelimArray(m.$," ")));return e}};return{loadCollada:function(g,a,b){var a=y(g,a,b),e=a.up_axis,d=[],f,m,o,s,r,v,u,z;m=0;for(o=a.materials.length;m<o;m++){r=a.materials[m];
u=new h.Material(r.mat);u.name=r.name||null;v=0;for(s=r.mat.textures_ref.length;v<s;v++){z=r.mat.textures_ref[v];var B=null,B=void 0===h.Textures_ref[z.image]?new h.Texture(z.image,n.default_filter,b,g):h.Textures_obj[h.Textures_ref[z.image]];u.setTexture(B,z.type)}d[r.id]=u}v=[];m=0;for(o=a.meshes.length;m<o;m++){var B=a.meshes[m],C=new h.Mesh({name:B.id});C.points=B.points;var H=!1;u=0;for(z=B.parts.length;u<z;u++){var t=B.parts[u];0!==t.material&&((s=d[t.material])||(s=new h.Material({name:t.material})),
C.setFaceMaterial(s));var x=t.normals.length?!0:!1,F=t.texcoords.length?!0:!1,A=t.colors.length?!0:!1;A&&(d[t.material].color_map=!0);s=0;for(r=t.faces.length;s<r;s++){var E=C.addFace(t.faces[s]);x&&(C.faces[E].point_normals=t.normals[s]);F&&(C.faces[E].uvs=t.texcoords[s]);A&&(C.faces[E].point_colors=t.colors[s])}H|=x}C.faces.length&&(b?b.addMesh(g,g+":"+meshId,C):(H||C.calcNormals(),C.triangulateQuads(),C.compile()),v[B.id]=C)}o=[];g=0;for(s=a.cameras.length;g<s;g++)o[a.cameras[g].id]=a.cameras[g];
B=[];s=0;for(r=a.lights.length;s<r;s++)B[a.lights[s].id]=a.lights[s];b={};d={};m={};g={};u=0;for(z=a.scenes.length;u<z;u++){C=a.scenes[u];H=new h.Scene;s=0;for(r=C.sceneObjects.length;s<r;s++)t=C.sceneObjects[s],x=new h.SceneObject(t),x.obj=(v[t.meshName]?v[t.meshName]:v[t.meshId])||null,t.matrix&&x.setMatrix(t.matrix),b[t.id]=x,H.bindSceneObject(x);s=0;for(r=C.lights.length;s<r;s++)t=C.lights[s],x=new h.Light(B[t.source]),x.position=t.position,x.rotation=t.rotation,d[t.id]=x,H.bindLight(x);C.cameras.length&&
(s=C.cameras[0],r=new h.Camera(o[s.source]),r.position=s.position,r.rotation=s.rotation,m[s.id]=r,H.camera=r);s=0;for(r=C.parentMap.length;s<r;s++)t=C.parentMap[s],b[t.parent].bindChild(b[t.child]);g[C.id]=H}for(var I in a.animations)if(a.animations.hasOwnProperty(I)&&(v=a.animations[I],v.channels.length)){cCount=0;for(s=v.channels.length;cCount<s;cCount++){o=v.channels[cCount];t=v.samplers[o.source];r=v.sources[t.INPUT];u=v.sources[t.OUTPUT];z=v.sources[t.INTERPOLATION];var B=v.sources[t.IN_TANGENT],
C=v.sources[t.OUT_TANGENT],H=t.IN_TANGENT!==w,t=t.OUT_TANGENT!==w,x=null,A=b[o.targetName],F=m[o.targetName],G=d[o.targetName];A?(null===A.motion&&(A.motion=new h.Motion),x=A.motion):F?(null===F.motion&&(F.motion=new h.Motion),x=F.motion):G&&(null===G.motion&&(G.motion=new h.Motion),x=G.motion);if(null!==x){A=q.motion.POS;E=q.motion.X;2===e&&(x.yzflip=!0);f=o.paramName;if("rotateX"===f||"rotationX"===f)A=q.motion.ROT,E=q.motion.X;else if("rotateY"===f||"rotationY"===f)A=q.motion.ROT,E=q.motion.Y;
else if("rotateZ"===f||"rotationZ"===f)A=q.motion.ROT,E=q.motion.Z;else if("location"===f){if(A=q.motion.POS,"X"===o.typeName&&(E=q.motion.X),"Y"===o.typeName&&(E=q.motion.Y),"Z"===o.typeName)E=q.motion.Z}else if("translate"===f){if(A=q.motion.POS,"X"===o.typeName&&(E=q.motion.X),"Y"===o.typeName&&(E=q.motion.Y),"Z"===o.typeName)E=q.motion.Z}else if("LENS"===f)continue;else"FOV"===f?(A=q.motion.FOV,E=3):"ZNEAR"===f?(A=q.motion.NEARCLIP,E=3):"ZFAR"===f?(A=q.motion.FARCLIP,E=3):"intensity"===f&&(A=
q.motion.INTENSITY,E=3);G&&3>A&&(G.method=q.light.method.DYNAMIC);mCount=0;for(o=r.data.length;mCount<o;mCount++)if(k=null,"object"===typeof u.data[mCount]){i=0;for(iMax=u.data[mCount].length;i<iMax;i++)G=i,2===e&&2===i?G=1:2===e&&1===i&&(G=2),k=x.setKey(A,G,r.data[mCount],c.fixukaxis(a.up_axis,A,G,u.data[mCount][i])),z&&(f=z.data[mCount][i],"LINEAR"===f?k.shape=q.envelope.shape.LINE:"BEZIER"===f&&(k.shape=!H&&!t?q.envelope.shape.LINEAR:q.envelope.shape.BEZI))}else if(G=E,ofs=0,F&&A===q.motion.ROT&&
2===e&&0===G&&(ofs=-90),A===q.motion.ROT?k=x.setKey(A,G,r.data[mCount],u.data[mCount]+ofs):(2===e&&2===E?G=1:2===e&&1===E&&(G=2),k=x.setKey(A,G,r.data[mCount],c.fixukaxis(a.up_axis,A,G,u.data[mCount]))),z)if(f=z.data[mCount],"LINEAR"===f)k.shape=q.envelope.shape.LINE;else if("BEZIER"===f)if(!H&&!t)k.shape=q.envelope.shape.LINEAR,k.continutity=1;else{k.shape=q.envelope.shape.BEZ2;f=B.data[mCount][0];var J,L=C.data[mCount][0];A===q.motion.ROT?(J=B.data[mCount][1],G=C.data[mCount][1],k.param[0]=f-k.time,
k.param[1]=J-k.value+ofs,k.param[2]=L-k.time,k.param[3]=G-k.value+ofs):(J=c.fixukaxis(a.up_axis,A,G,B.data[mCount][1]),G=c.fixukaxis(a.up_axis,A,G,C.data[mCount][1]),k.param[0]=f-k.time,k.param[1]=J-k.value,k.param[2]=L-k.time,k.param[3]=G-k.value)}}}}I=null;return I=a.scene?g[a.scene]:g.pop()},parseCollada:y}});
CubicVR.RegisterModule("GML",function(h){function y(q){var n=CubicVR.util;this.strokes=[];this.bounds=[1,1,1];this.origin=[0,0,0];this.upvector=[0,1,0];this.viewvector=[0,0,1];this.manual_pos=0;if(q!==w){var q=n.getXML(q),h=q.getElementsByTagName("header");if(!h.length)return null;var c=h[0],h=q.getElementsByTagName("environment");if(!h.length)return null;this.name=null;c=c.getElementsByTagName("name");c.length&&(this.name=n.collectTextNode(c[0]));c=h[0].getElementsByTagName("screenBounds");c.length&&
(this.bounds=[parseFloat(n.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("z")[0]))]);c=h[0].getElementsByTagName("origin");c.length&&(this.origin=[parseFloat(n.collectTextNode(c[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(c[0].getElementsByTagName("z")[0]))]);h=h[0].getElementsByTagName("up");
h.length&&(this.upvector=[parseFloat(n.collectTextNode(h[0].getElementsByTagName("x")[0])),parseFloat(n.collectTextNode(h[0].getElementsByTagName("y")[0])),parseFloat(n.collectTextNode(h[0].getElementsByTagName("z")[0]))]);q=q.getElementsByTagName("drawing");h=0;for(c=q.length;h<c;h++)for(var g=q[h].getElementsByTagName("stroke"),a=0,b=0,e=0,d=0,f=0,m=g.length;f<m;f++){for(var o=g[f].getElementsByTagName("pt"),s=o.length,D=Array(s),v,u,z,B=0,C=s;B<C;B++)z=o[B],s=parseFloat(n.collectTextNode(z.getElementsByTagName("x")[0])),
v=parseFloat(n.collectTextNode(z.getElementsByTagName("y")[0])),u=parseFloat(n.collectTextNode(z.getElementsByTagName("z")[0])),z=parseFloat(n.collectTextNode(z.getElementsByTagName("time")[0])),1===this.upvector[0]?D[B]=[v!==v?0:v,s!==s?0:-s,u!==u?0:u,z]:1===this.upvector[1]?D[B]=[s!==s?0:s,v!==v?0:v,u!==u?0:u,z]:1===this.upvector[2]&&(D[B]=[s!==s?0:s,u!==u?0:-u,v!==v?0:v,z]),a<s&&(a=s),b<v&&(b=v),e<u&&(e=u),d<z&&(d=z);if(e>d){o=0;for(B=D.length;o<B;o++)s=D[o][3],D[o][3]=D[o][2],D[o][2]=s/this.bounds[2]}this.strokes[f]=
D}}}var w=h.undef;y.prototype={addStroke:function(h,n){var r=[];n===w&&(n=0.1);for(var c=0,g=h.length;c<g;c++){var a=[h[c][0],h[c][1],h[c][2]];this.manual_pos+=n;a.push(this.manual_pos);r.push(a)}this.strokes.push(r)},recenter:function(){var h=CubicVR.vec3,n=[0,0,0],r=[this.strokes[0][0][0],this.strokes[0][0][1],this.strokes[0][0][2]],c,g,a,b;a=0;for(b=this.strokes.length;a<b;a++){c=0;for(g=this.strokes[a].length;c<g;c++)n[0]>this.strokes[a][c][0]&&(n[0]=this.strokes[a][c][0]),n[1]>this.strokes[a][c][1]&&
(n[1]=this.strokes[a][c][1]),n[2]>this.strokes[a][c][2]&&(n[2]=this.strokes[a][c][2]),r[0]<this.strokes[a][c][0]&&(r[0]=this.strokes[a][c][0]),r[1]<this.strokes[a][c][1]&&(r[1]=this.strokes[a][c][1]),r[2]<this.strokes[a][c][2]&&(r[2]=this.strokes[a][c][2])}h=h.multiply(h.subtract(r,n),0.5);a=0;for(b=this.strokes.length;a<b;a++){c=0;for(g=this.strokes[a].length;c<g;c++)this.strokes[a][c][0]-=h[0],this.strokes[a][c][1]-=this.upvector[1]?h[1]:-h[1],this.strokes[a][c][2]-=h[2]}},generateObject:function(h,
n,r,c,g){var a=CubicVR.vec3;h===w&&(h=0);n===w&&(n=0);g===w&&(g=!1);c===w&&(c=0.02);r===w&&(r=0.015);for(var b=0!==n,e=0,d=0,f=new CubicVR.Mesh(this.name),m,o,s,D,v,u,z=0,B=this.strokes.length;z<B;z++){u=new CubicVR.Envelope;var C=new CubicVR.Envelope,y=new CubicVR.Envelope,t=this.strokes[z].length,x=[],F=[],A=0,E=this.strokes[z];for(v=0;v<t;v++){var I=E[v],G=u.addKey(I[3],I[0]),J=C.addKey(I[3],I[1]),L;L=g?y.addKey(I[3],I[2]):y.addKey(I[3],0);G.tension=0.5;J.tension=0.5;L.tension=0.5;0!==v?(m=I[0]-
m,o=I[1]-o,s=I[2]-s,D=I[3]-D,s=Math.sqrt(m*m+o*o+s*s),x[v-1]=s,F[v-1]=D):A=I[3];m=I[0];o=I[1];s=I[2];D=I[3]}t=f.points.length;for(v=0;v<x.length;v++){E=F[v];J=Math.ceil(3*(x[v]/c));I=A;G=A+E;for(J=E/J;I<G-J;I+=J){I===A&&(m=u.evaluate(I),o=C.evaluate(I),s=y.evaluate(I));var M,K;L=u.evaluate(I+J);M=C.evaluate(I+J);K=y.evaluate(I+J);var N=L-m,Y=M-o,ca=K-s;Math.sqrt(N*N+Y*Y+ca*ca);N=a.multiply(a.normalize(a.cross(this.viewvector,a.normalize([N,Y,ca]))),r/2);f.addPoint([m-N[0],-(o-N[1]),s-N[2]+(b?n/2:
0)]);f.addPoint([m+N[0],-(o+N[1]),s+N[2]+(b?n/2:0)]);m=L;o=M;s=K}A+=E}C=f.points.length;if(b){v=t;for(u=C;v<u;v++)f.addPoint([f.points[v][0],f.points[v][1],f.points[v][2]-(b?n/2:0)])}v=0;for(u=C-t;v<=u-4;v+=2){0===e%h&&d++;f.setSegment(d);y=[t+v,t+v+1,t+v+3,t+v+2];f.addFace(y);if(b&&(y=[y[3]+C-t,y[2]+C-t,y[1]+C-t,y[0]+C-t],f.addFace(y),y=[t+v,t+v+2,t+v+2+C-t,t+v+C-t],f.addFace(y),y=[t+v+1+C-t,t+v+3+C-t,t+v+3,t+v+1],f.addFace(y),0===v&&(y=[t+v+C-t,t+v+1+C-t,t+v+1,t+v],f.addFace(y)),v===u-4))y=[t+v+
2,t+v+3,t+v+3+C-t,t+v+2+C-t],f.addFace(y);e++}}f.calcFaceNormals();f.triangulateQuads();f.calcNormals();f.compile();return f}};return{GML:y}});
CubicVR.RegisterModule("PDF",function(){return{PDF:function(h){if(!h.src)throw"PDF Error: you must specify a src url for a PDF.";var y=h.src,w=h.callback||function(){},q,n=[],r=[];this.__defineGetter__("pages",function(){return q?q.numPages:0});this.getPage=function(c){var g=q.numPages,c=1>c?1:c;return n[(c>g?g:c)-1]};this.getPageTexture=function(c,g,a){c=this.getPage(c);g=g||c.width;a=a||c.height;return new CubicVR.PdfTexture(c,{width:g,height:a})};getPdf({url:y,error:function(){console.log("PDF Error: error loading pdf `"+
y+"`")}},function(c){q=new PDFDoc(c);for(var c=1,g=q.numPages;c<=g;c++){var a=q.getPage(c);n.push(a);r.push(a)}w()})}}});
CubicVR.RegisterModule("Particles",function(h){function y(n,h,c,g,a,b,e){n&&(this.last_particle=this.particles=null,this.pTex=c!==w?c:null,this.vWidth=g,this.vHeight=a,this.alpha=b!==w?b:!1,this.alphaCut=e!==w?e:0,this.pfunc=function(a,b){var c=b-a.start_time;if(0>c)return 0;if(c>a.life_time&&a.life_time)return-1;a.pos[0]=a.startpos[0]+c*a.velocity[0]+c*c*a.accel[0];a.pos[1]=a.startpos[1]+c*a.velocity[1]+c*c*a.accel[1];a.pos[2]=a.startpos[2]+c*a.velocity[2]+c*c*a.accel[2];null!==this.pgov&&this.pgov(a,
b);return 1},this.pgov=null,this.hasColor=h===w?!1:h,c=null!==this.pTex,this.vs=["#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;",this.hasColor?"attribute vec3 aColor;":"","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvarying vec4 color;\nvarying vec2 screenPos;",c?"varying float pSize;":"","void main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);",c?"screenPos=vec2(position.x/position.w,position.y/position.w);":"","gl_Position = position;",
this.hasColor?"color = vec4(aColor.r,aColor.g,aColor.b,1.0);":"color = vec4(1.0,1.0,1.0,1.0);",c?"pSize=200.0/position.z;":"float pSize=200.0/position.z;","gl_PointSize = pSize;\n}"].join("\n"),this.fs=["#ifdef GL_ES\nprecision highp float;\n#endif",c?"uniform sampler2D pMap;":"","varying vec4 color;",c?"varying vec2 screenPos;":"",c?"uniform vec3 screenDim;":"",c?"varying float pSize;":"","void main(void) {\nvec4 c = color;",c?"vec2 screen=vec2((gl_FragCoord.x/screenDim.x-0.5)*2.0,(gl_FragCoord.y/screenDim.y-0.5)*2.0);":
"",c?"vec2 pointCoord=vec2( ((screen.x-screenPos.x)/(pSize/screenDim.x))/2.0+0.5,((screen.y-screenPos.y)/(pSize/screenDim.y))/2.0+0.5);":"",c?"vec4 tc = texture2D(pMap,pointCoord); gl_FragColor = vec4(c.rgb*tc.rgb,1.0);":"gl_FragColor = c;","}"].join("\n"),this.maxPoints=n,this.numParticles=0,this.arPoints=new Float32Array(3*n),this.glPoints=null,h&&(this.arColor=new Float32Array(3*n),this.glColor=null),this.shader_particle=new CubicVR.Shader(this.vs,this.fs),this.shader_particle.use(),this.shader_particle.addVertexArray("aVertexPosition"),
this.hasColor&&this.shader_particle.addVertexArray("aColor"),this.shader_particle.addMatrix("uMVMatrix"),this.shader_particle.addMatrix("uPMatrix"),null!==this.pTex&&(this.shader_particle.addInt("pMap",0),this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",[g,a,0])),this.genBuffer())}var w=h.undef,q=h.GLCore;y.prototype={resizeView:function(n,h){this.vWidth=n;this.vHeight=h;null!==this.pTex&&(this.shader_particle.addVector("screenDim"),this.shader_particle.setVector("screenDim",
[n,h,0]))},addParticle:function(n){null===this.last_particle?this.particles=n:this.last_particle.nextParticle=n;this.last_particle=n},genBuffer:function(){var n=q.gl;this.glPoints=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW);this.hasColor&&(this.glColor=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},updatePoints:function(){var n=q.gl;n.bindBuffer(n.ARRAY_BUFFER,
this.glPoints);n.bufferData(n.ARRAY_BUFFER,this.arPoints,n.DYNAMIC_DRAW)},updateColors:function(){var n=q.gl;this.hasColor&&(n.bindBuffer(n.ARRAY_BUFFER,this.glColor),n.bufferData(n.ARRAY_BUFFER,this.arColor,n.DYNAMIC_DRAW))},draw:function(n,h,c){var g=q.gl;this.shader_particle.use();null!==this.pTex&&this.pTex.use(g.TEXTURE0);this.shader_particle.setMatrix("uMVMatrix",n);this.shader_particle.setMatrix("uPMatrix",h);g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,null);g.bindBuffer(g.ARRAY_BUFFER,this.glPoints);
g.vertexAttribPointer(this.shader_particle.uniforms.aVertexPosition,3,g.FLOAT,!1,0,0);g.enableVertexAttribArray(this.shader_particle.uniforms.aVertexPosition);this.hasColor&&(g.bindBuffer(g.ARRAY_BUFFER,this.glColor),g.vertexAttribPointer(this.shader_particle.uniforms.aColor,3,g.FLOAT,!1,0,0),g.enableVertexAttribArray(this.shader_particle.uniforms.aColor));if(c!==w){this.numParticles=0;if(null===this.particles){g.disable(g.BLEND);return}for(var n=this.particles,h=null,a=0;null!==n;){var b=3*this.numParticles,
e=this.pfunc(n,c);if(1===e){if(this.arPoints[b]=n.pos[0],this.arPoints[b+1]=n.pos[1],this.arPoints[b+2]=n.pos[2],null!==n.color&&this.arColor!==w&&(this.arColor[b]=n.color[0],this.arColor[b+1]=n.color[1],this.arColor[b+2]=n.color[2]),this.numParticles++,a++,this.numParticles===this.maxPoints)break}else-1===e?null!==h&&(h.nextParticle=n.nextParticle):0===e&&a++;h=n;n=n.nextParticle}a||(this.last_particle=this.particles=null);this.updatePoints();this.hasColor&&this.updateColors()}this.alpha&&(g.enable(g.BLEND),
g.enable(g.DEPTH_TEST),g.depthMask(0),g.blendFunc(g.ONE,g.ONE_MINUS_SRC_COLOR));g.drawArrays(g.POINTS,0,this.numParticles);this.alpha&&(g.disable(g.BLEND),g.depthMask(1),g.blendFunc(g.ONE,g.ONE));this.hasColor&&g.disableVertexAttribArray(this.shader_particle.uniforms.aColor)}};return{ParticleSystem:y,Particle:function(n,h,c,g,a){this.startpos=new Float32Array(n);this.pos=new Float32Array(n);this.velocity=new Float32Array(g!==w?g:[0,0,0]);this.accel=new Float32Array(a!==w?a:[0,0,0]);this.start_time=
h!==w?h:0;this.life_time=c!==w?c:0;this.nextParticle=this.color=null}}});
CubicVR.RegisterModule("Lines",function(h){function y(h){h=h||{};this.color=h.color||[1,1,1];this.maxPoints=h.maxPoints||1024;this.vs="#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 aVertexPosition;\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\nvoid main(void) {\nvec4 position = uPMatrix * uMVMatrix * vec4(aVertexPosition,1.0);\ngl_Position = position;\n}";this.fs="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec3 color;\nvoid main(void) {\nvec4 c = vec4(color,1.0);\ngl_FragColor = c;\n}";this.arLines=
new Float32Array(6*this.maxPoints);this.glLines=null;this.lineLength=0;this.shader_line=new CubicVR.Shader(this.vs,this.fs);this.shader_line.use();this.shader_line.addVertexArray("aVertexPosition");this.shader_line.addVector("color",this.color);this.shader_line.addMatrix("uMVMatrix");this.shader_line.addMatrix("uPMatrix");this.genBuffer();this.newSegment=!1}var w=h.GLCore;y.prototype={genBuffer:function(){var h=w.gl;this.glLines=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,
this.arLines,h.DYNAMIC_DRAW)},update:function(){var h=w.gl;h.bindBuffer(h.ARRAY_BUFFER,this.glLines);h.bufferData(h.ARRAY_BUFFER,this.arLines,h.DYNAMIC_DRAW)},addPoint:function(h){var n=this.lineLength;1<n&&(this.arLines[3*n]=this.arLines[3*(n-1)],this.arLines[3*n+1]=this.arLines[3*(n-1)+1],this.arLines[3*n+2]=this.arLines[3*(n-1)+2],this.lineLength++,n++);this.arLines[3*n]=h[0];this.arLines[3*n+1]=h[1];this.arLines[3*n+2]=h[2];this.lineLength++},addSegment:function(h){var n=this.lineLength;this.arLines[3*
n]=h[0];this.arLines[3*n+1]=h[1];this.arLines[3*n+2]=h[2];this.lineLength++},clear:function(){this.lineLength=0},render:function(h){var n=w.gl,r=h.mvMatrix,h=h.pMatrix;this.shader_line.use();this.shader_line.setMatrix("uMVMatrix",r);this.shader_line.setMatrix("uPMatrix",h);this.shader_line.setVector("color",this.color);n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);n.bindBuffer(n.ARRAY_BUFFER,this.glLines);n.vertexAttribPointer(this.shader_line.uniforms.aVertexPosition,3,n.FLOAT,!1,0,0);n.enableVertexAttribArray(this.shader_line.uniforms.aVertexPosition);
n.drawArrays(n.LINES,0,this.lineLength)}};return{Lines:y}});
CubicVR.RegisterModule("HeightField",function(h){var y=h.undef,w=h.enums;w.heightfield={brush:{SINE:0,SQUARE:1},op:{ADD:0,REPLACE:1,SUBTRACT:2}};var q=function(c){c=c||{};this.operation=h.parseEnum(w.draw.op,c.operation||c.op)||w.draw.op.REPLACE;this.brushType=h.parseEnum(w.draw.brush,c.brushType)||w.draw.brush.SINE;this.brushSize=c.size||5;this.strength=c.strength||1};q.prototype={setOperation:function(c){this.operation=h.parseEnum(w.draw.op,c)},getOperation:function(){return this.operation},setBrushType:function(c){this.brushType=
h.parseEnum(w.draw.brush,c)||w.draw.brush.SINE},getBrushType:function(){return this.brushType},setSize:function(c){this.brushSize=c},getSize:function(){return this.brushSize},setStrength:function(c){this.strength=c},getStrength:function(){return this.strength}};var n=function(c){c=c||{};this.divX=c.divX||null;this.divZ=c.divZ||null;this.size=c.size||null;this.cellSize=this.sizeZ=this.sizeX=this.cellSize=this.hfFloatBuffer=this.hfUInt8Buffer=this.hfBuffer=null;this.ofsX=c.ofsX||-this.cellSize/2;this.ofsZ=
c.ofsZ||-this.cellSize/2;this.divX&&(this.divZ&&this.size)&&this.initBuffer(this.divX,this.divZ,this.size);this.areaBuffered=!1;this.drawArea={startX:0,startZ:0,endX:0,endZ:0}};n.prototype={initBuffer:function(c,g,a){this.hfBuffer=new ArrayBuffer(4*c*g);this.hfUInt8Buffer=new Uint8Array(this.hfBuffer);this.hfFloatBuffer=new Float32Array(this.hfBuffer);this.divX=c||null;this.divZ=g||null;this.size=a||null;this.divX>this.divZ?(this.sizeX=a,this.sizeZ=a/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?
a/this.divZ*this.divX:a,this.sizeZ=a);this.drawBuffer=[];this.cellSize=this.sizeX/this.divX;this.startX=-(this.sizeX/2)+this.ofsX;this.startZ=-(this.sizeZ/2)+this.ofsZ},setBrush:function(c){this.brush=c},getBrush:function(){return this.brush},draw:function(c,g,a){var b=this.brush||a,a=b.getOperation(),e=b.getSize(),d=b.getBrushType(),b=b.getStrength();if(this.areaBuffered){var f=c-e,m=g-e,o=c+e,n=g+e;f<this.drawArea.startX&&(this.drawArea.startX=f);m<this.drawArea.startZ&&(this.drawArea.startZ=m);
o>this.drawArea.endX&&(this.drawArea.endX=o);o>this.drawArea.endX&&(this.drawArea.endZ=n)}else this.drawArea={startX:c-e,startZ:g-e,endX:c+e,endZ:g+e},this.areaBuffered=!0;this.drawBuffer.push([c,g,a,e,d,b])},getDrawArea:function(){return!this.areaBuffered?!1:this.drawArea},clearDrawArea:function(){this.areaBuffered=!1},flush:function(){if(!this.drawBuffer.length)return!1;for(;this.drawBuffer.length;){var c=this.drawBuffer.pop();this.drawFunc(c[0],c[1],c[2],c[3],c[4],c[5])}return!0},needsFlush:function(){return 0!==
this.drawBuffer.length},drawFunc:function(c,g,a,b,e,d){for(var a=this.hfFloatBuffer,e=this.divX,f=this.divZ,b=b/this.cellSize,c=(c-this.startX)/this.cellSize,g=(g-this.startZ)/this.cellSize,m=parseInt(Math.floor(c-b),10),o=parseInt(Math.ceil(c+b),10);m<o;m++)for(var n=m-c,h=parseInt(Math.floor(g-b),10),q=parseInt(Math.ceil(g+b),10);h<q;h++)if(!(0>m||m>=e||0>h||h>=f)){var u=h-g,u=d*((1-Math.sqrt(n*n+u*u)/b)/2);0>u&&0<=d&&(u=0);0<u&&0>=d&&(u=0);a[h*e+m]+=u}},getUint8Buffer:function(){return this.hfUInt8Buffer},
getFloat32Buffer:function(){return this.hfFloatBuffer},getDivX:function(){return this.divX},getDivZ:function(){return this.divZ},getSizeX:function(){return this.sizeX},getSizeZ:function(){return this.sizeZ},getStartX:function(){return this.startX},getStartZ:function(){return this.startZ},getCellSize:function(){return this.cellSize},getSize:function(){return this.size},setRect:function(c){var c=c||{},g=c.value||0,a=c.src||c.func||null,b=c.startX||0,e=c.startZ||0,d=c.walkX,f=c.walkZ,c=this.hfFloatBuffer,
m,o=this.startX,n=this.startZ;if(b!==y&&e!==y&&d!==y&&f!==y){if(!(b>=this.divX)&&!(e>=this.divZ)&&(b+d>=this.divX&&(d=this.divX-1-b),e+f>=this.divZ&&(f=this.divZ-1-e),!(0>=d||0>=f))){m=b;for(b+=d;m<b;m++)for(var d=e,h=e+f;d<h;d++){var q=m+d*this.divX;c[q]=null===a?g:a(this.cellSize*m+o,this.cellSize*d+n,q)}}}else{m=0;for(b=this.hfFloatBuffer.length;m<b;m++)null===a?c[m]=g:(e=a(m%this.divX*this.cellSize+o,Math.floor(m/this.divX)*this.cellSize+n,m),c[m]=e)}},getIndicesAt:function(c,g){if("object"===
typeof c)return this.getIndicesAt(c[0],c[2]);var a=this.startX,b=this.startZ,e=Math.floor((c-a)/this.cellSize),d=Math.floor((g-b)/this.cellSize);if(0>e||e>=this.divX-1||0>d||d>=this.divZ-1)return-1;if(1<=Math.abs(g-((d+1)*this.cellSize+b))/Math.abs(c-(e*this.cellSize+a)))return a=[e+(d+1)*this.divX,e+1+d*this.divX,e+d*this.divX],[e,d,a,0];a=[e+(d+1)*this.divX,e+1+(d+1)*this.divX,e+1+d*this.divX];return[e,d,a,1]},getHeightValue:function(c,g){var a=h.triangle;if("object"===typeof c)return this.getHeightValue(c[0],
c[2]);var b=this.getIndicesAt(c,g);if(-1===b)return 0;var e=b[2],d=b[0]*this.cellSize+this.startX,f=b[1]*this.cellSize+this.startZ,m;m=0===b[3]?a.normal([d,this.hfFloatBuffer[e[0]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[1]],f],[d,this.hfFloatBuffer[e[2]],f]):a.normal([d,this.hfFloatBuffer[e[0]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[1]],f+this.cellSize],[d+this.cellSize,this.hfFloatBuffer[e[2]],f]);a=m[0];b=m[1];m=m[2];e=[d,this.hfFloatBuffer[e[0]],f+this.cellSize];
return(a*c+m*g+(-(a*e[0])-b*e[1]-m*e[2]))/-b},rayIntersect:function(c,g){var a=c.slice(0),b=this.startX,e=this.startZ,d=this.startX+this.sizeX,f=this.startZ+this.sizeZ,m=this.cellSize,o=h.vec2,n=h.vec3,q=n.normalize(g),v=[q[0],q[2]],u=[a[0],a[2]];if(a[0]<b||a[0]>d||a[2]<e||a[2]>f){var r=[[b,e],[d,e],[b,f],[d,f]],B=[];a[0]>=d&&B.push([r[1],r[3]]);a[0]<=b&&B.push([r[0],r[2]]);a[2]>=f&&B.push([r[2],r[3]]);a[2]<=e&&B.push([r[0],r[1]]);if(0!==B.length){a=[];d=0;for(f=B.length;d<f;d++)r=o.lineIntersect(u,
o.add(u,v),B[d][0],B[d][1]),!1!==r&&o.onLine(B[d][0],B[d][1],r)&&a.push(r);r=0;B=-1;d=0;for(f=a.length;d<f;d++){var C=o.length(a[d],u);0===d?(r=C,B=0):C<r&&(B=d,r=C)}if(-1!=B){if(t=r/o.length(v),a=[a[B][0],0,a[B][1]],a[1]=c[1]+q[1]*t,a[1]<=this.getHeightValue(a[0],a[2]))return!1}else return!1}u=[a[0],a[2]]}r=Math.floor((u[0]-b)/m);f=Math.floor((u[1]-e)/m);B=u[0]-(b+r*m);d=u[1]-(e+f*m);d=B<d?B/Math.abs(v[0]):d/Math.abs(v[1]);0===d?(B=u[0],d=u[1]):(B=u[0]+d*v[0],d=u[1]+d*v[1]);for(var r=B-(b+r*m),C=
d-(e+f*m),f=0<=v[0]?r:m-r,r=0<=v[1]?C:m-C,C=this.getFloat32Buffer(),w,t;;){var x=(m-f)/Math.abs(v[0]),y=(m-r)/Math.abs(v[1]),x=x<y?x:y;w=v[0]*x;var A=v[1]*x,f=f+Math.abs(w),r=r+Math.abs(A),x=(B+(B+w))/2,y=(d+(d+A))/2,B=B+w,d=d+A,x=Math.floor((x-b)/m),y=Math.floor((y-e)/m);if(f>=m)for(;f>=m;)f-=m;if(r>=m)for(;r>=m;)r-=m;t=o.length(u,[B,d])/o.length(v);w=o.length(u,[B-w,d-A])/o.length(v);t=a[1]+q[1]*t;w=a[1]+q[1]*w;if(x>this.divX||0>x||y>this.divZ||0>y)return!1;var A=C[y*this.divX+x],E=C[y*this.divX+
x+1],I=C[(y+1)*this.divX+x],G=C[(y+1)*this.divX+x+1];if(0>=t-A||0>=t-E||0>=t-I||0>=t-G||0>=w-A||0>=w-E||0>=w-I||0>=w-G){E=[x+(y+1)*this.divX,x+1+y*this.divX,x+y*this.divX];A=[x+(y+1)*this.divX,x+1+(y+1)*this.divX,x+1+y*this.divX];t=b+m*x;w=e+m*y;tmpNormA=h.triangle.normal([t,C[E[0]],w+m],[t+m,C[E[1]],w],[t,C[E[2]],w]);tmpNormB=h.triangle.normal([t,C[A[0]],w+m],[t+m,C[A[1]],w+m],[t+m,C[A[2]],w]);E=n.linePlaneIntersect(tmpNormA,[t,C[E[0]],w+m],a,n.add(a,q));x=Math.abs(e+(y+1)*m-E[0])/Math.abs(b+x*m-
E[2]);if(1<=x&&E[0]>=t-1.0E-8&&E[0]<=t+m+1.0E-8&&E[2]>=w-1.0E-8&&E[2]<=w+1.0E-8+m)return E;y=n.linePlaneIntersect(tmpNormB,[t,C[A[0]],w+m],a,n.add(a,q));if(1>x&&y[0]>=t-1.0E-8&&y[0]<=t+m+1.0E-8&&y[2]>=w-1.0E-8&&y[2]<=w+m+1.0E-8)return y}}}};var r=h.extendClassGeneral(h.Mesh,function(c){c=c||{};c.dynamic=!0;c.buildWireframe=!0;this.material=c.material;this._update=h.Mesh.prototype.update;h.Mesh.apply(this,[c]);this.hField=c.hField||null;this.divX=c.divX||null;this.divZ=c.divZ||null;this.viewX=c.viewX||
0;this.viewZ=c.viewZ||0;this.ofsX=c.ofsX||0;this.ofsZ=c.ofsZ||0;this.edgeX=c.edgeX||0;this.edgeZ=c.edgeZ||0;this.normalBuffer=[];this.genHeightfieldMesh()},{setIndexedHeight:function(c,g,a){this.points[c+g*this.divX][1]=a},genHeightfieldMesh:function(){var c,g,a=this.divX+this.edgeX,b=this.divZ+this.edgeZ,e=this.hField.getCellSize(),d=e*this.divX;c=e*this.divZ;0!==this.points.length&&this.clean();var f=-(c/2);for(g=0;g<b;g++){var m=-(d/2);for(c=0;c<a;c++)this.addPoint([m+this.ofsX,0,f+this.ofsZ]),
m+=e;f+=e}this.setFaceMaterial(this.material);c=-1/(a-1);g=1/(b-1);for(d=f=0;d<b-1;d++){m=1;for(e=0;e<a-1;e++)f1=this.addFace([e+(d+1)*a,e+1+d*a,e+d*a]),f2=this.addFace([e+(d+1)*a,e+1+(d+1)*a,e+1+d*a]),this.faces[f1].uvs=[[m,f+g],[m+c,f],[m,f]],this.faces[f2].uvs=[[m,f+g],[m+c,f+g],[m+c,f]],m+=c;f+=g}},recalcNormals:function(c){var g;if(c=c||this.normalMapRef){var c=this.divX+this.edgeX,a=this.divZ+this.edgeZ;if(!this.normalBuffer.length){for(g=0;g<this.points.length;g++)this.normalBuffer.push([0,
1,0]);var b=0;for(g=0;g<a-1;g++)for(k=0;k<c-1;k++)this.faces[b++].point_normals=[this.normalBuffer[k+(g+1)*c],this.normalBuffer[k+1+g*c],this.normalBuffer[k+g*c]],this.faces[b++].point_normals=[this.normalBuffer[k+(g+1)*c],this.normalBuffer[k+1+(g+1)*c],this.normalBuffer[k+1+g*c]]}a=this.hField;b=a.getFloat32Buffer();g=this.viewX||0;var e=(this.viewZ||0)*a.getDivX()+g;for(g=0;g<this.points.length;g++){var d=g%c,f=Math.floor(g/c),m=e+d+(f-1)*a.getDivX(),o=e+d+(f+1)*a.getDivX(),n=e+(d+1)+f*a.getDivX(),
q=e+(d-1)+f*a.getDivX(),d=e+d+f*a.getDivX(),m=b[m],o=b[o],n=b[n],q=b[q],d=b[d];m===y&&(m=d);o===y&&(o=d);n===y&&(n=d);q===y&&(q=d);q=h.vec3.normalize([(n-d+(d-q))/2,2,(m-d+(d-o))/2]);this.normalBuffer[g][0]=q[0];this.normalBuffer[g][1]=q[1];this.normalBuffer[g][2]=q[2]}return this}},update:function(){var c=this.viewX||0,g=this.viewZ||0,a=this.divX+this.edgeX,b=this.divZ+this.edgeZ,e=this.hField.getDivX();this.hField.getDivZ();for(var d=this.hField.getFloat32Buffer(),f=g,b=g+b;f<b;f++)for(var m=c,
o=c+a;m<o;m++)this.points[(f-g)*a+(m-c)][1]=d[f*e+m];this._update()}});return{HeightField:n,HeightFieldBrush:q,HeightFieldMesh:r}});
CubicVR.RegisterModule("Landscape",function(h){var y=h.undef,w=Math.PI/2;return{Landscape:h.extendClassGeneral(h.SceneObject,function(){if(1<arguments.length)this.hField=new h.HeightField({size:arguments[0],divX:arguments[1],divZ:arguments[2]}),this.hfMesh=new h.HeightFieldMesh({hField:this.hField,size:arguments[0],divX:arguments[1],divZ:arguments[2],material:arguments[3],ofsX:this.hField.getCellSize()/2,ofsZ:this.hField.getCellSize()/2}),this.hfMesh.prepare(),h.SceneObject.apply(this,[{mesh:this.hfMesh,
shadowCast:!1}]);else{var q=arguments[0]||{};this.size=q.size||128;this.divX=q.divX||128;this.divZ=q.divZ||128;this.tiles=[];this.tileMeshes=[];this.tileMaterials=[];this.tileSpats=[];this.tileX=q.tileX||this.divX;this.tileZ=q.tileZ||this.divZ;this.tileChanged=[];this.tileSpatChanged=[];this.hField=new h.HeightField({size:this.size,divX:this.divX,divZ:this.divZ});this.divX>this.divZ?(this.sizeX=this.size,this.sizeZ=this.size/this.divX*this.divZ):(this.sizeX=this.divZ>this.divX?this.size/this.divZ*
this.divX:this.size,this.sizeZ=this.size);this.cellSize=this.sizeX/this.divX;this.tileSize=this.cellSize*this.tileX;this.spatResolution=q.spatResolution||256;this.spats=q.spats||[];h.SceneObject.apply(this,[{mesh:null,shadowCast:!1}]);for(var n=q=0,r=0;r<this.divZ;r+=this.tileZ){for(var c=q=0;c<this.divX;c+=this.tileX){var g=new h.DrawBufferTexture({width:this.spatResolution,height:this.spatResolution}),a=c+1!=this.tileX?1:0,b=r+1!=this.tileZ?1:0,e=new h.SpatMaterial({color:[1,1,1],specular:[0.05,
0.05,0.05],spats:this.spats,sourceTexture:g,spatResolution:this.spatResolution,spatOffset:[this.divX/(this.divX+a),this.divZ/(this.divZ+b),1]}),a=new h.HeightFieldMesh({hField:this.hField,size:this.tileSize,divX:this.tileX,divZ:this.tileZ,viewX:c,viewZ:r,edgeX:a,edgeZ:b,material:e});a.prepare();var b=new h.SceneObject({mesh:a}),d=this.hField.getStartX(),f=this.hField.getStartZ();b.position[0]=d+this.tileSize*q+this.tileSize/2;b.position[2]=f+this.tileSize*n+this.tileSize/2;this.bindChild(b);this.tiles.push(b);
this.tileMeshes.push(a);this.tileMaterials.push(e);this.tileSpats.push(g);this.tileChanged.push(!1);this.tileSpatChanged.push(!1);q++}n++}}},{update:function(){var h,n;this.hField.needsFlush()&&this.hField.flush();h=this.hField.getDrawArea();if(!1!==h){var r=this.getTileAt(h.startX-this.cellSize,h.startZ-this.cellSize,h.endX-h.startX+this.cellSize,h.endZ-h.startZ,this.cellSize);!1!==r&&r.length===y&&(r=[r]);h=0;for(n=r.length;h<n;h++)this.tileChanged[r[h]]=!0;this.hField.clearDrawArea()}h=0;for(n=
this.tiles.length;h<n;h++)if(this.tileChanged[h]&&(this.tileMeshes[h].update(),this.tileChanged[h]=!1),this.tileSpatChanged[h])this.tileSpats[h].update(),this.tileSpatChanged[h]=!1},getHeightField:function(){return this.hField},mapGen:function(h,n,r,c,g){this.hField.setRect({src:h,startX:n,startZ:r,walkX:c,walkZ:g});this.hfMesh.update()},getFaceAt:function(h,n){return this.hField.getFaceAt([h,0,n])},getHeightValue:function(h,n){return this.hField.getHeightValue([h,0,n])},orient:function(h,n,r,c,g,
a){a===y&&(a=0);var b,e,d=[];b=r/2;var f=c/2;e=Math.sqrt(f*f+b*b);f=Math.atan2(f,b);g*=Math.PI/180;b=h+Math.sin(g)*a;a=n+Math.cos(g)*a;d[0]=this.getHeightValue([b+e*Math.cos(-f-w+g),0,a+e*-Math.sin(-f-w+g)]);d[1]=this.getHeightValue([b+e*Math.cos(f-w+g),0,a+e*-Math.sin(f-w+g)]);d[2]=this.getHeightValue([b+e*Math.cos(-f+w+g),0,a+e*-Math.sin(-f+w+g)]);d[3]=this.getHeightValue([b+e*Math.cos(f+w+g),0,a+e*-Math.sin(f+w+g)]);e=-Math.atan2(d[1]-d[2],r);a=-Math.atan2(d[0]-d[1],c);e+=-Math.atan2(d[0]-d[3],
r);a+=-Math.atan2(d[3]-d[2],c);return[[h,(d[2]+d[3]+d[1]+d[0])/4,n],[e/2*(180/Math.PI),g,a/2*(180/Math.PI)]]},getTileAt:function(h,n,r,c){var r=r||0,c=c||0,g=this.hField.getStartX(),a=this.hField.getStartZ(),b=Math.floor(this.divX/this.tileX),e=Math.floor((h-g)/(this.tileX*this.tileSize)*this.tileX),d=Math.floor((n-a)/(this.tileZ*this.tileSize)*this.tileZ),f=0;if(0===r&&0===c)return f=parseInt(e+d*b,10);h=Math.floor((h+r-g)/(this.tileX*this.tileSize)*this.tileX);n=Math.floor((n+c-a)/(this.tileZ*this.tileSize)*
this.tileZ);for(c=[];d<=n;d++)for(a=e;a<=h;a++)f=d*(this.divX/this.tileX)+a,0<=f&&f<this.tiles.length&&c.push(f);return c},getSpatLocation:function(h,n,r){if(r===y)h=(1-(h/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divX/this.tileX)%this.spatResolution,n=(1-(n/this.getHeightField().getSize()+0.5))*this.spatResolution*(this.divZ/this.tileZ)%this.spatResolution;else var c=this.divX/this.tileX,g=r%c,c=Math.floor(r/c),r=this.hField.getStartX(),c=this.hField.getStartZ()+c*this.tileSize,
h=(1-(h-(r+g*this.tileSize))/this.tileSize)*this.spatResolution,n=(1-(n-c)/this.tileSize)*this.spatResolution;return{x:h,z:n}},drawSpat:function(h,n,r){var c=r.getSize()*(this.size/this.spatResolution),g=h-c/2,a=n-c/2,c=this.getTileAt(g,a,h+c/2-g,n+c/2-a);!1!==c&&c.length===y&&(c=[c]);if(!1!==c){g=0;for(a=c.length;g<a;g++){var b=c[g],e=this.getSpatLocation(h,n,b);0<=b&&b<this.tileSpats.length&&(this.tileSpats[b].draw(e.x,e.z,r),this.tileSpatChanged[b]=!0)}}}})}});
CubicVR.RegisterModule("SpatMaterial",function(h){var y=h.undef,w;return{SpatMaterial:h.extendClassGeneral(h.Material,function(q){q=q||{};w||(w=new h.Texture);this.spats=q.spats||[w,w,w,w,w];this.sourceTex=q.sourceTexture||w;this.spatResolution=q.spatResolution||256;this.spatTexel=1/this.spatResolution;var n=this.spats,r;for(r in n){var c=n[r];"string"===typeof c&&(n[r]=h.Textures_ref[c]!==y?h.Textures_obj[h.Textures_ref[c]]:new h.Texture(c))}this.spatOffset=q.spatOffset||[1,1,1];this.spatShader=
new h.CustomShader({vertex:"void main(void) {\n  vertexTexCoordOut = cubicvr_texCoord();\n  gl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n  #if !LIGHT_DEPTH_PASS  // not needed if shadowing \n    vertexNormalOut = matrixNormal * cubicvr_normal();\n    cubicvr_lighting();\n  #endif // !LIGHT_DEPTH_PASS \n}",fragment:"uniform sampler2D spatImage;\nuniform sampler2D spat0;\nuniform sampler2D spat1;\nuniform sampler2D spat2;\nuniform sampler2D spat3;\nuniform sampler2D spat4;\nuniform vec3 spatOffset;\nuniform float spatTexel;\nvoid main(void) \n{  \nvec2 texCoord = cubicvr_texCoord();\nvec2 spatTexCoord = texCoord*30.0;\nvec4 color = texture2D(spat0,spatTexCoord);\nvec2 spatSourceCoord = vec2(texCoord.x*spatOffset.x,texCoord.y*spatOffset.y);\nif (spatSourceCoord.s<=spatTexel/2.0) {\n   spatSourceCoord.s=spatTexel/2.0;\n}\nif (spatSourceCoord.s>=1.0-spatTexel/2.0) {\n   spatSourceCoord.s=1.0-spatTexel/2.0;\n}\nif (spatSourceCoord.t<=spatTexel/2.0) {\n   spatSourceCoord.t=spatTexel/2.0;\n}\nif (spatSourceCoord.t>=1.0-spatTexel/2.0) {\n   spatSourceCoord.t=1.0-spatTexel/2.0;\n}\nvec4 spatSource = texture2D(spatImage,spatSourceCoord);\ncolor = mix(color,texture2D(spat1,spatTexCoord),spatSource.r);\ncolor = mix(color,texture2D(spat2,spatTexCoord),spatSource.g);\ncolor = mix(color,texture2D(spat3,spatTexCoord),spatSource.b);\ncolor = mix(color,texture2D(spat4,spatTexCoord),spatSource.a);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n}",
init:function(){},update:function(c){return function(a,b){var e=b.textureIndex;a.spatImage.set(e++,c.sourceTex);a.spatOffset.set(c.spatOffset);a.spatTexel.set(c.spatTexel);n[0]&&a.spat0.set(e++,n[0]);n[1]&&a.spat1.set(e++,n[1]);n[2]&&a.spat2.set(e++,n[2]);n[3]&&a.spat3.set(e++,n[3]);n[4]&&a.spat4.set(e++,n[4])}}(this)});q.shader=this.spatShader;h.Material.apply(this,[q])},{setSpats:function(h){this.spats=h},getSpats:function(){return this.spats},setSource:function(h){this.sourceTexture=h}})}});
CubicVR.RegisterModule("Octree",function(h){function y(a,c,d,f,g){var o=this._children=[];this._dirty=!1;o[0]=null;o[1]=null;o[2]=null;o[3]=null;o[4]=null;o[5]=null;o[6]=null;o[7]=null;this._child_index=g||-1;this._root=d||null;this._max_depth=c||0;a=this._size=a||0;f=this._position=f||[0,0,0];this._nodes=[];this._lights=[];this._static_lights=[];this._sphere=[f[0],f[1],f[2],Math.sqrt(3*(this._size/2*this._size/2))];c=this._bbox=[[0,0,0],[0,0,0]];d=h.aabb;d.reset(c,f);a/=2;d.engulf(c,[f[0]+a,f[1]+
a,f[2]+a]);d.engulf(c,[f[0]-a,f[1]-a,f[2]-a]);this._debug_visible=!1}function w(){this.position=[0,0,0];this.visible=!1;this._object=null}function q(){this.last_in=[];this._planes=[];this.sphere=null;for(var a=0;6>a;++a)this._planes[a]=[0,0,0,0]}var n=h.undef,r=h.plane,c=h.sphere,g=h.enums;g.frustum={plane:{LEFT:0,RIGHT:1,TOP:2,BOTTOM:3,NEAR:4,FAR:5}};g.octree={TOP_NW:0,TOP_NE:1,TOP_SE:2,TOP_SW:3,BOTTOM_NW:4,BOTTOM_NE:5,BOTTOM_SE:6,BOTTOM_SW:7};var a=function(a,c,d){d=a.slice((d||c)+1||a.length);
a.length=0>c?a.length+c:c;return a.push.apply(a,d)};y.prototype.destroy=function(){var a,c,d;a=0;for(c=this._static_lights.length;a<c;++a)d=this._static_lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;a=0;for(c=this._lights.length;a<c;++a)d=this._lights[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null;this._lights=this._static_lights=null;a=0;for(c=this._children.length;a<c;++a)null!==this._children[a]&&this._children[a].destroy();a=0;for(c=this._nodes.length;a<
c;++a)d=this._nodes[a],d.octree_leaves=null,d.octree_common_root=null,d.octree_aabb=null,d.dynamic_lights=[],d.static_lights=[];this._children[0]=null;this._children[1]=null;this._children[2]=null;this._children[3]=null;this._children[4]=null;this._children[5]=null;this._children[6]=null;this._bbox=this._sphere=this._static_lights=this._lights=this._nodes=this._position=this._root=this._children=this._children[7]=null};y.prototype.toString=function(){return"[Octree: @"+this._position+", depth: "+
this._max_depth+", size: "+this._size+", nodes: "+this._nodes.length+", measured size:"+[this._bbox[1][0]-this._bbox[0][0],this._bbox[1][2]-this._bbox[0][2]]+"]"};y.prototype.remove=function(b){var c=!1,d=this._nodes.length,f;f=d-1;for(d=this._nodes.length;0<=f;--f)if(b===this._nodes[f]){a(this._nodes,f);this.dirty_lineage();c=!0;break}if(!c)for(f=d-1;0<=f;--f)if(b===this._lights[f]){a(this._lights,f);this.dirty_lineage();break}};y.prototype.dirty_lineage=function(){this._dirty=!0;null!==this._root&&
this._root.dirty_lineage()};y.prototype.cleanup=function(){for(var a=this._children.length,c=0,d=0;d<a;++d){var f=this._children[d];if(null!==f){var g=!0;!0===f._dirty&&(g=f.cleanup());g?++c:this._children[d]=null}}return 0===this._nodes.length&&(0===this._static_lights.length&&0===this._lights.length)&&(0===c||0===a)?!1:!0};y.prototype.insert_light=function(a){this.insert(a,!0)};y.prototype.propagate_static_light=function(a){var c,d;c=0;for(d=this._nodes.length;c<d;++c)-1===this._nodes[c].static_lights.indexOf(a)&&
this._nodes[c].static_lights.push(a);for(c=0;8>c;++c)null!==this._children[c]&&this._children[c].propagate_static_light(a)};y.prototype.collect_static_lights=function(a){var c,d;c=0;for(d=this._static_lights.length;c<d;++c)-1===a.static_lights.indexOf(this._static_lights[c])&&a.static_lights.push(this._static_lights[c]);for(c=0;8>c;++c)null!==this._children[c]&&this._children[c].collect_static_lights(a)};y.prototype.insert=function(a,c){function d(a,b,c,e){var d,f;if(c)if(b.method===g.light.method.STATIC){-1===
a._static_lights.indexOf(b)&&a._static_lights.push(b);c=0;for(d=a._nodes.length;c<d;++c)-1===a._nodes[c].static_lights.indexOf(b)&&a._nodes[c].static_lights.push(b);for(f=a._root;null!==f;){c=0;for(l=f._nodes.length;c<l;++c)d=f._nodes[c],-1===d.static_lights.indexOf(b)&&d.static_lights.push(b);f=f._root}}else-1===a._lights.indexOf(b)&&a._lights.push(b);else{a._nodes.push(b);c=0;for(d=a._static_lights.length;c<d;++c)-1===b.static_lights.indexOf(a._static_lights[c])&&b.static_lights.push(a._static_lights[c]);
for(f=a._root;null!==f;){c=0;for(d=f._static_lights.length;c<d;++c){var m=f._static_lights[c];-1===b.static_lights.indexOf(m)&&b.static_lights.push(m)}f=f._root}}b.octree_leaves.push(a);b.octree_common_root=e;e=h.aabb;e.engulf(b.octree_aabb,a._bbox[0]);e.engulf(b.octree_aabb,a._bbox[1])}c===n&&(c=!1);null===this._root&&(a.octree_leaves=[],a.octree_common_root=null);if(0===this._max_depth)d(this,a,c,this._root);else{var f=this._position,m,o,s,q,r,u,z;o=a.getAABB();z=[o[0][0],o[0][1],o[0][2]];var B=
[o[1][0],o[1][1],o[1][2]];m=z[0]<f[0]&&z[1]<f[1]&&z[2]<f[2];o=B[0]>f[0]&&z[1]<f[1]&&z[2]<f[2];r=z[0]<f[0]&&B[1]>f[1]&&z[2]<f[2];u=B[0]>f[0]&&B[1]>f[1]&&z[2]<f[2];s=z[0]<f[0]&&z[1]<f[1]&&B[2]>f[2];q=B[0]>f[0]&&z[1]<f[1]&&B[2]>f[2];z=z[0]<f[0]&&B[1]>f[1]&&B[2]>f[2];f=B[0]>f[0]&&B[1]>f[1]&&B[2]>f[2];if(m&&o&&r&&u&&s&&q&&z&&f)d(this,a,c,this),c?a.method==g.light.method.STATIC&&this.propagate_static_light(a):this.collect_static_lights(a);else{for(var B=0,C=this._static_lights.length;B<C;++B)a.static_lights===
n&&(a.static_lights=[]),-1===a.static_lights.indexOf(this._static_lights[B])&&a.static_lights.push(this._static_lights[B]);var B=this._size/2,C=this._size/4,w=0,t=this._position[0],x=this._position[1],F=this._position[2];m&&(m=[t-C,x-C,F-C],null===this._children[g.octree.TOP_NW]&&(this._children[g.octree.TOP_NW]=new y(B,this._max_depth-1,this,m,g.octree.TOP_NW)),this._children[g.octree.TOP_NW].insert(a,c),++w);o&&(m=[t+C,x-C,F-C],null===this._children[g.octree.TOP_NE]&&(this._children[g.octree.TOP_NE]=
new y(B,this._max_depth-1,this,m,g.octree.TOP_NE)),this._children[g.octree.TOP_NE].insert(a,c),++w);r&&(m=[t-C,x+C,F-C],null===this._children[g.octree.BOTTOM_NW]&&(this._children[g.octree.BOTTOM_NW]=new y(B,this._max_depth-1,this,m,g.octree.BOTTOM_NW)),this._children[g.octree.BOTTOM_NW].insert(a,c),++w);u&&(m=[t+C,x+C,F-C],null===this._children[g.octree.BOTTOM_NE]&&(this._children[g.octree.BOTTOM_NE]=new y(B,this._max_depth-1,this,m,g.octree.BOTTOM_NE)),this._children[g.octree.BOTTOM_NE].insert(a,
c),++w);s&&(m=[t-C,x-C,F+C],null===this._children[g.octree.TOP_SW]&&(this._children[g.octree.TOP_SW]=new y(B,this._max_depth-1,this,m,g.octree.TOP_SW)),this._children[g.octree.TOP_SW].insert(a,c),++w);q&&(m=[t+C,x-C,F+C],null===this._children[g.octree.TOP_SE]&&(this._children[g.octree.TOP_SE]=new y(B,this._max_depth-1,this,m,g.octree.TOP_SE)),this._children[g.octree.TOP_SE].insert(a,c),++w);z&&(m=[t-C,x+C,F+C],null===this._children[g.octree.BOTTOM_SW]&&(this._children[g.octree.BOTTOM_SW]=new y(B,
this._max_depth-1,this,m,g.octree.BOTTOM_SW)),this._children[g.octree.BOTTOM_SW].insert(a,c),++w);f&&(m=[t+C,x+C,F+C],null===this._children[g.octree.BOTTOM_SE]&&(this._children[g.octree.BOTTOM_SE]=new y(B,this._max_depth-1,this,m,g.octree.BOTTOM_SE)),this._children[g.octree.BOTTOM_SE].insert(a,c),++w);if(1<w||null===a.octree_common_root)a.octree_common_root=this}}};y.prototype.draw_on_map=function(a,c,d){function f(a,b,d,f,h){var n=a<d?a:d,u=b<f?b:f,a=a<d?d-a:a-d,b=b<f?f-b:b-f;c.save();void 0!==h&&
(c.fillStyle=h,c.fillRect(g+n,o+u,a,b));c.strokeRect(g+n,o+u,a,b);c.restore()}var g=a.width/2,o=a.height/2,h,q,r,u,z,B,C;if(d===n||"map"===d)c.save(),!1!==this._debug_visible?(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="#FF0000"):(c.fillStyle="rgba(0,0,0,0)",c.strokeStyle="rgba(0,0,0,0)"),c.beginPath(),z=this._size/2,h=this._position[0],q=this._position[2],c.moveTo(g+h-z,g+q-z),c.lineTo(g+h-z,g+q+z),c.lineTo(g+h+z,g+q+z),c.lineTo(g+h+z,g+q-z),c.stroke(),c.fill(),c.restore();if(d===n||"objects"===d){c.save();
z=0;for(C=this._nodes.length;z<C;++z)B=this._nodes[z],c.fillStyle="#5500FF",c.strokeStyle=!0===B.visible&&!1===B.culled?"#FFFFFF":"#000000",c.beginPath(),h=B.aabb[0][0],q=B.aabb[0][2],r=B.aabb[1][0]-h,u=B.aabb[1][2]-q,c.rect(g+h,o+q,r,u),c.stroke();c.restore()}if(d===n||"lights"===d){z=0;for(C=this._lights.length;z<C;++z)u=this._lights[z],c.fillStyle=!1===u.culled&&!0===u.visible?"rgba(255, 255, 255, 0.1)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FFFF00",c.beginPath(),B=u.distance,h=u.position[0],
q=u.position[2],c.arc(g+h,o+q,B,0,2*Math.PI,!0),c.closePath(),c.stroke(),c.fill(),c.beginPath(),h=u.aabb[0][0],q=u.aabb[0][2],r=u.aabb[1][0]-h,u=u.aabb[1][2]-q,c.rect(g+h,o+q,r,u),c.closePath(),c.stroke();z=0;for(C=this._static_lights.length;z<C;++z)u=this._static_lights[z],c.fillStyle=!1===u.culled&&!0===u.visible?"rgba(255, 255, 255, 0.01)":"rgba(255, 255, 255, 0.0)",c.strokeStyle="#FF66BB",c.beginPath(),B=u.distance,h=u.position[0],q=u.position[2],c.arc(g+h,o+q,B,0,2*Math.PI,!0),c.closePath(),
c.stroke(),c.fill(),c.beginPath(),h=u.aabb[0][0],q=u.aabb[0][2],r=u.aabb[1][0]-h,u=u.aabb[1][2]-q,c.rect(g+h,o+q,r,u),c.closePath(),c.stroke()}if("lights"!=d&&"objects"!=d&&"map"!=d){c.save();h=this._nodes;z=0;for(u=h.length;z<u;++z)if(B=h[z],B.name==d){c.strokeStyle="#FFFF00";c.lineWidth=3;c.beginPath();h=B.aabb[0][0];q=B.aabb[0][2];r=B.aabb[1][0]-h;u=B.aabb[1][2]-q;c.rect(g+h,o+q,r,u);c.closePath();c.stroke();h=B.octree_aabb;c.strokeStyle="#0000FF";f(h[0][0],h[0][2],h[1][0],h[1][2]);c.lineWidth=
1;null!==B.common_root&&(c.strokeStyle="#00FF00");break}c.lineWidth=1;c.strokeStyle="#FFFF00";f(this._bbox[0][0],this._bbox[0][2],this._bbox[1][0],this._bbox[1][2],"#444444");c.fill();c.restore()}z=0;for(C=this._children.length;z<C;++z)null!==this._children[z]&&this._children[z].draw_on_map(a,c,d)};y.prototype.contains_point=function(a){return a[0]<=this._position[0]+this._size/2&&a[1]<=this._position[1]+this._size/2&&a[2]<=this._position[2]+this._size/2&&a[0]>=this._position[0]-this._size/2&&a[1]>=
this._position[1]-this._size/2&&a[2]>=this._position[2]-this._size/2};y.prototype.get_frustum_hits=function(a,e){var d={objects:[],lights:[]};if((e===n||!0===e)&&!this.contains_point(a.position)){if(!1===c.intersects(a.frustum.sphere,this._sphere))return d;var f=a.frustum.contains_sphere(this._sphere);if(-1===f)return this._debug_visible=!1,d;if(1===f)this._debug_visible=2,e=!1;else if(0===f){this._debug_visible=!0;f=a.frustum.contains_box(this._bbox);if(-1===f)return this._debug_visible=!1,d;1===
f&&(this._debug_visible=3,e=!1)}}var g,o,f=0;for(g=this._nodes.length;f<g;++f)o=this._nodes[f],d.objects.push(o),o.dynamic_lights=[].concat(this._lights),o.was_culled=o.culled,o.culled=!1,o.drawn_this_frame=!1;this._debug_visible=0<this._lights.length?4:this._debug_visible;f=0;for(g=this._lights.length;f<g;++f)o=this._lights[f],!0===o.visible&&(d.lights.push(o),o.was_culled=o.culled,o.culled=!1);f=0;for(g=this._static_lights.length;f<g;++f)o=this._static_lights[f],!0===o.visible&&(o.culled=!1);for(f=
0;8>f;++f)if(null!==this._children[f]){g=this._children[f].get_frustum_hits(a,e);var h;o=0;for(h=g.objects.length;o<h;++o){d.objects.push(g.objects[o]);for(var q=g.objects[o].dynamic_lights,r=0,u=this._lights.length;r<u;++r)0>q.indexOf(this._lights[r])&&q.push(this._lights[r])}o=0;for(h=g.lights.length;o<h;++o)0>d.lights.indexOf(g.lights[o])&&d.lights.push(g.lights[o])}return d};y.prototype.reset_node_visibility=function(){this._debug_visible=!1;var a,c;a=0;for(c=this._nodes.length;a<c;++a)this._nodes[a].culled=
!0;a=0;for(c=this._lights.length;a<c;++a)this._lights[a].culled=!0;a=0;for(c=this._static_lights.length;a<c;++a)this._static_lights[a].culled=!0;a=0;for(c=this._children.length;a<c;++a)null!==this._children[a]&&this._children[a].reset_node_visibility()};w.prototype.toString=function(){return"[OctreeNode "+this.position+"]"};w.prototype.attach=function(a){this._object=a};q.prototype.extract=function(a,c,d){var f=h.mat4,m=h.vec3;if(!(c===n||d===n)){f=f.multiply(d,c);c=this._planes;c[g.frustum.plane.LEFT][0]=
f[3]+f[0];c[g.frustum.plane.LEFT][1]=f[7]+f[4];c[g.frustum.plane.LEFT][2]=f[11]+f[8];c[g.frustum.plane.LEFT][3]=f[15]+f[12];c[g.frustum.plane.RIGHT][0]=f[3]-f[0];c[g.frustum.plane.RIGHT][1]=f[7]-f[4];c[g.frustum.plane.RIGHT][2]=f[11]-f[8];c[g.frustum.plane.RIGHT][3]=f[15]-f[12];c[g.frustum.plane.TOP][0]=f[3]-f[1];c[g.frustum.plane.TOP][1]=f[7]-f[5];c[g.frustum.plane.TOP][2]=f[11]-f[9];c[g.frustum.plane.TOP][3]=f[15]-f[13];c[g.frustum.plane.BOTTOM][0]=f[3]+f[1];c[g.frustum.plane.BOTTOM][1]=f[7]+f[5];
c[g.frustum.plane.BOTTOM][2]=f[11]+f[9];c[g.frustum.plane.BOTTOM][3]=f[15]+f[13];c[g.frustum.plane.NEAR][0]=f[3]+f[2];c[g.frustum.plane.NEAR][1]=f[7]+f[6];c[g.frustum.plane.NEAR][2]=f[11]+f[10];c[g.frustum.plane.NEAR][3]=f[15]+f[14];c[g.frustum.plane.FAR][0]=f[3]-f[2];c[g.frustum.plane.FAR][1]=f[7]-f[6];c[g.frustum.plane.FAR][2]=f[11]-f[10];c[g.frustum.plane.FAR][3]=f[15]-f[14];for(var o=0;6>o;++o)r.normalize(c[o]);o=-c[g.frustum.plane.NEAR][3];c=c[g.frustum.plane.FAR][3]-o;d=c*(1/d[5]);d=m.subtract([0,
0,o+0.5*c],[d,d,o+c]);d=m.length(d);f=[f[3],f[9],f[10]];o=m.length(f);f=m.multiply(f,1/o);a=[a.position[0],a.position[1],a.position[2]];a=m.add(a,m.multiply(f,0.5*c));a=m.add(a,m.multiply(f,1));this.sphere=[a[0],a[1],a[2],d]}};q.prototype.contains_sphere=function(a){for(var c=h.vec3,d=this._planes,f=0;6>f;++f){var g=d[f],g=c.dot([g[0],g[1],g[2]],[a[0],a[1],a[2]])+g.d;this.last_in[f]=1;if(g<-a[3])return-1;if(Math.abs(g)<a[3])return 0}return 1};q.prototype.draw_on_map=function(a,c){var d=a.width/2,
f=a.height/2;c.save();for(var g=this._planes,o=[0,1,4,5],h=0,n=o.length;h<n;++h){var q=g[o[h]];c.strokeStyle="#FF00FF";h<this.last_in.length&&this.last_in[h]&&(c.strokeStyle="#FFFF00");var u=-d,r=d,B=(-q[3]-q[0]*r)/q[2];c.moveTo(d+u,f+(-q[3]-q[0]*u)/q[2]);c.lineTo(d+r,f+B);c.stroke()}c.strokeStyle="#0000FF";c.beginPath();c.arc(d+this.sphere[0],f+this.sphere[2],this.sphere[3],0,2*Math.PI,!1);c.closePath();c.stroke();c.restore()};q.prototype.contains_box=function(a){var c=0,d=[];d[0]=a[0];d[1]=[a[0][0],
a[0][1],a[1][2]];d[2]=[a[0][0],a[1][1],a[0][2]];d[3]=[a[0][0],a[1][1],a[1][2]];d[4]=[a[1][0],a[0][1],a[0][2]];d[5]=[a[1][0],a[0][1],a[1][2]];d[6]=[a[1][0],a[1][1],a[0][2]];d[7]=a[1];for(var a=this._planes,f=0;6>f;++f){for(var g=8,o=1,h=0;8>h;++h)-1===r.classifyPoint(a[f],d[h])&&(o=0,--g);this.last_in[f]=o;if(0===g)return-1;c+=o}return 6===c?1:0};return{Frustum:q,Octree:y}});
CubicVR.RegisterModule("CVRXML",function(h){function y(a,c,f,g){var o=CubicVR.util,h=null,n=null;g.triangles&&(n=o.intDelimArray(b.getTextNode(g,"triangles")," "));if(n&&(g.segments&&(h=o.intDelimArray(b.getTextNode(g,"segments")," ")),null===h&&(h=[0,parseInt(n.length/3,10)]),g=0,a.setFaceMaterial(c),n.length)){p=0;for(pMax=h.length;p<pMax;p+=2){c=3*h[p+1];a.setSegment(h[p]);j=g;for(jMax=g+c;j<jMax;j+=3)o=a.addFace([n[j],n[j+1],n[j+2]]),f&&a.faces[o].setUV([f[j],f[j+1],f[j+2]]);g+=c}}}function w(a){var c=
CubicVR.util,f=new CubicVR.UVMapper,m=null,o=null;if(a.type)switch(m=b.getTextNode(a,"type"),m){case "planar":f.projection_mode=g.uv.projection.PLANAR;break;case "cylindrical":f.projection_mode=g.uv.projection.CYLINDRICAL;break;case "spherical":f.projection_mode=g.uv.projection.SPHERICAL;break;case "cubic":f.projection_mode=g.uv.projection.CUBIC}if(!m)return null;"uv"===m&&a.uv&&(o=b.getPoints(a,"uv"));if(a.axis)switch(b.getTextNode(a,"axis")){case "x":f.projection_axis=g.uv.axis.X;break;case "y":f.projection_axis=
g.uv.axis.Y;break;case "z":f.projection_axis=g.uv.axis.Z}a.center&&(f.center=c.floatDelimArray(b.getTextNode(a,"center")));a.rotation&&(f.rotation=c.floatDelimArray(b.getTextNode(a,"rotation")));a.scale&&(f.scale=c.floatDelimArray(b.getTextNode(a,"scale")));a.wrap_w&&(f.wrap_w_count=parseFloat(b.getTextNode(a,"wrap_w")));a.wrap_h&&(f.wrap_h_count=parseFloat(b.getTextNode(a,"wrap_h")));return""!==m&&"uv"!==m?f:o}function q(e,d){if(a[e]!==c)return a[e];var f=CubicVR.util,m,o,n,q;m=null;m="object"==
typeof e?e:-1!=e.indexOf(".js")?f.getJSON(e):CubicVR.util.xml2badgerfish(f.getXML(e));m.root&&(m=m.root);m.properties&&(m=m.properties);f=new CubicVR.Mesh;m.points&&(n=b.getPoints(m,"points"))&&f.addPoint(n);var r=m.material;r&&!r.length&&(r=[r]);var u=[];if(r){m=0;for(n=r.length;m<n;m++){var z=r[m],B;B=z;var C=d,H=new CubicVR.Material({name:B.name?B.name.$:null});B.shininess&&(H.shininess=b.getFloatNode(B,"shininess",H.shininess)/100);H.opacity=b.getFloatNode(B,"alpha",H.opacity);H.max_smooth=b.getFloatNode(B,
"max_smooth",H.max_smooth);H.color=b.getFloatDelimNode(B,"color",H.color);H.ambient=b.getFloatDelimNode(B,"ambient",H.ambient);H.diffuse=b.getFloatDelimNode(B,"diffuse",H.diffuse);H.specular=b.getFloatDelimNode(B,"specular",H.specular);o=void 0;if(o=b.getTextNode(B,"texture"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.COLOR);if(o=b.getTextNode(B,"texture_luminosity"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:
new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.AMBIENT);if(o=b.getTextNode(B,"texture_normal"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.NORMAL);if(o=b.getTextNode(B,"texture_specular"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.SPECULAR);if(o=b.getTextNode(B,"texture_bump"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:
new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.BUMP);if(o=b.getTextNode(B,"texture_envsphere"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.ENVSPHERE);if(o=b.getTextNode(B,"texture_alpha"))o=(C?C:"")+o,tex=h.Textures_ref[o]!==c?h.Textures_obj[h.Textures_ref[o]]:new CubicVR.Texture(o),H.setTexture(tex,g.texture.map.ALPHA);B=H;var t=null;o=C=null;z.uvmapper&&((C=w(z.uvmapper))&&!C.length?u.push([C,B]):o=C);(H=z.part)&&
!H.length&&(H=[H]);if(H&&H.length){var x=null,F=null;o=0;for(q=H.length;o<q;o++){var A=H[o],x=null;if(t=A.uvmapper)x=w(t),z.triangles&&(F=t=f.faces.length,x&&!x.length?(y(f,B,null,A),F=f.faces.length-1,f.calcFaceNormals(t,F),x.apply(f,B,c,t,F)):x&&x.length?y(f,B,x,A):C&&!C.length&&(y(f,B,null,A),F=f.faces.length-1,f.calcFaceNormals(t,F),C.apply(f,B,c,t,F)));if(A.procedural){(t=A.uvmapper)&&(x=w(t));var F=A.transform?b.getTransform(A.transform):c,t=c,A=A.procedural,E=b.getTextNode(A,"type");F&&(t=
new CubicVR.Transform,t.translate(F.position),t.pushMatrix(),t.rotate(F.rotation),t.pushMatrix(),t.scale(F.scale));C||(C=c);x={material:B,uvmapper:C||x};if("box"===E||"cube"===E)x.size=b.getFloatNode(A,"size"),f.booleanAdd(CubicVR.primitives.box(x),t);else if("sphere"===E)x.radius=b.getFloatNode(A,"radius"),x.lat=b.getIntNode(A,"lat"),x.lon=b.getIntNode(A,"lon"),f.booleanAdd(CubicVR.primitives.sphere(x),t);else if("cone"===E)x.base=b.getFloatNode(A,"base"),x.height=b.getFloatNode(A,"height"),x.lon=
b.getIntNode(A,"lon"),f.booleanAdd(CubicVR.primitives.cone(x),t);else if("plane"===E)x.size=b.getFloatNode(A,"size"),f.booleanAdd(CubicVR.primitives.plane(x),t);else if("cylinder"===E)x.radius=b.getFloatNode(A,"radius"),x.height=b.getFloatNode(A,"height"),x.lon=b.getIntNode(A,"lon"),f.booleanAdd(CubicVR.primitives.cylinder(x),t);else if("torus"===E)x.innerRadius=b.getFloatNode(A,"innerRadius"),x.outerRadius=b.getFloatNode(A,"outerRadius"),x.lat=b.getIntNode(A,"lat"),x.lon=b.getIntNode(A,"lon"),f.booleanAdd(CubicVR.primitives.torus(x),
t);else if("lathe"===E)x.points=b.getPoints(A,"p"),x.lon=b.getIntNode(A,"lon"),f.booleanAdd(CubicVR.primitives.lathe(x),t);else if("polygon"===E){F=b.getPoints(A,"p");F=new CubicVR.Polygon(F);(E=A.cut)&&!E.length&&(E=[E]);if(E.length){o=0;for(n=E.length;o<q;o++)F.cut(new CubicVR.Polygon(b.getPoints(E[o])))}x.front=0;x.back=0;x.frontShift=0;x.backShift=0;x.frontDepth=0;x.backDepth=0;if(A.extrude&&(A=A.extrude,x.front=b.getFloatNode(A,"front",0),x.back=b.getFloatNode(A,"back",0),x.frontShift=b.getFloatNode(A,
"frontBevelShift",0),x.backShift=b.getFloatNode(A,"backBevelShift",0),x.frontDepth=b.getFloatNode(A,"frontBevelDepth",0),x.backDepth=b.getFloatNode(A,"backBevelDepth",0),x.depth=b.getFloatNode(A,"depth",0),x.shift=b.getFloatNode(A,"shift",0),x.bevel=b.getFloatNode(A,"bevel",0),x.depth&&(!x.backDepth&&!x.frontDepth)&&(x.front=-x.depth/2,x.back=x.depth/2),x.shift&&(!x.backShift&&!x.frontShift)&&(x.frontShift=x.shift,x.backShift=x.shift),x.bevel&&!x.backDepth&&!x.frontDepth))x.frontDepth=x.bevel,x.backDepth=
x.bevel;A=F.toExtrudedBeveledMesh(new CubicVR.Mesh,x);A.setFaceMaterial(x.material);f.booleanAdd(A,t)}}}}else y(f,B,o,z)}}f.triangulateQuads();f.calcNormals();m=0;for(n=u.length;m<n;m++)u[m][0].apply(f,u[m][1]);f.compile();return a[e]=f}function n(a){return null===a?!1:a.getElementsByTagName("x").length||a.getElementsByTagName("y").length||a.getElementsByTagName("z").length||a.getElementsByTagName("fov").length}function r(a,b,f){var m=CubicVR.util,o=[];o[0]=a.getElementsByTagName("x");o[1]=a.getElementsByTagName("y");
o[2]=a.getElementsByTagName("z");o[3]=a.getElementsByTagName("fov");var h,n,q,u,r,B;for(B in o)if(o.hasOwnProperty(B)&&o[B]!==c&&o[B].length){h=o[B][0].getElementsByTagName("time");n=o[B][0].getElementsByTagName("value");q=o[B][0].getElementsByTagName("in");u=o[B][0].getElementsByTagName("out");r=o[B][0].getElementsByTagName("tcb");var C=null,w=null,t=null,x=a=null;q.length&&(a=m.collectTextNode(q[0]));u.length&&(x=m.collectTextNode(u[0]));h.length&&(C=m.floatDelimArray(m.collectTextNode(h[0])," "));
n.length&&(w=m.floatDelimArray(m.collectTextNode(n[0])," "));r.length&&(t=m.floatDelimArray(m.collectTextNode(r[0])," "));if(null!==C&&null!==w){h=0;for(n=C.length;h<n;h++)q=f.setKey(b,B,C[h],w[h]),t&&(q.tension=t[3*h],q.continuity=t[3*h+1],q.bias=t[3*h+2])}w=C=g.envelope.behavior.CONSTANT;if(a)switch(a){case "reset":C=g.envelope.behavior.RESET;break;case "constant":C=g.envelope.behavior.CONSTANT;break;case "repeat":C=g.envelope.behavior.REPEAT;break;case "oscillate":C=g.envelope.behavior.OSCILLATE;
break;case "offset":C=g.envelope.behavior.OFFSET;break;case "linear":C=g.envelope.behavior.LINEAR}if(x)switch(x){case "reset":w=g.envelope.behavior.RESET;break;case "constant":w=g.envelope.behavior.CONSTANT;break;case "repeat":w=g.envelope.behavior.REPEAT;break;case "oscillate":w=g.envelope.behavior.OSCILLATE;break;case "offset":w=g.envelope.behavior.OFFSET;break;case "linear":w=g.envelope.behavior.LINEAR}f.setBehavior(b,B,C,w)}}var c=h.undef,g=CubicVR.enums,a=[],b={getPoints:function(a,d,f){a=d?
b.getTextNode(a,d):a.$;if(!a)return c;a=a.split(" ");i=0;for(iMax=a.length;i<iMax;i++){a[i]=a[i].split(",");j=0;for(jMax=a[i].length;j<jMax;j++)a[i][j]=parseFloat(a[i][j]);f&&(a[i][2]=0)}return a},getTransform:function(a){var b=CubicVR.util;if(!a)return null;var c={position:[0,0,0],rotation:[0,0,0],scale:[1,1,1]},g;postition=a.position;g=a.rotation;a=a.scale;g&&(c.rotation=b.floatDelimArray(g.$));a&&(c.scale=b.floatDelimArray(a.$));return g||a?c:null},getTextNode:function(a,b,c){a=a[b];if(!a)return c;
a.length&&(a=a[0]);return a.$?a.$:c},getFloatNode:function(a,c,f){return(a=b.getTextNode(a,c))?(a=parseFloat(a),a!=a?f:a):f},getIntNode:function(a,c,f){return(a=b.getTextNode(a,c))?(a=parseInt(a,10),a!=a?f:a):f},getFloatDelimNode:function(a,c,f,g){var o=CubicVR.util;return(a=b.getTextNode(a,c))?o.floatDelimArray(a,g):f},getIntDelimNode:function(a,c,f,g){var o=CubicVR.util;return(a=b.getTextNode(a,c))?o.intDelimArray(a,g):f}};return{loadMesh:q,loadScene:function(a,b,f){var m=CubicVR.util;b===c&&(b=
"");f===c&&(f="");for(var o=new CubicVR.Mesh,h=m.getXML(a),a=new CubicVR.Scene,w=[],v=h.getElementsByTagName("sceneobjects"),u,z,B,C=0,y=v[0].childNodes.length;C<y;C++){var t=v[0].childNodes[C];if("sceneobject"===t.tagName){var x="unnamed",F="",A="",o=t.getElementsByTagName("name");o.length&&(x=m.collectTextNode(o[0]));o=t.getElementsByTagName("parent");o.length&&(F=m.collectTextNode(o[0]));o=t.getElementsByTagName("model");o.length&&(A=m.collectTextNode(o[0]));B=z=u=null;o=t.getElementsByTagName("position");
o.length&&(u=o[0]);o=t.getElementsByTagName("rotation");o.length&&(z=o[0]);o=t.getElementsByTagName("scale");o.length&&(B=o[0]);o=null;""!==A&&(o=q(b+A,f));o=new CubicVR.SceneObject(o,x);n(u)?(o.motion||(o.motion=new CubicVR.Motion),r(u,g.motion.POS,o.motion)):u&&(o.position=m.floatDelimArray(m.collectTextNode(u)));n(z)?(o.motion||(o.motion=new CubicVR.Motion),r(z,g.motion.ROT,o.motion)):o.rotation=m.floatDelimArray(m.collectTextNode(z));n(B)?(o.motion||(o.motion=new CubicVR.Motion),r(B,g.motion.SCL,
o.motion)):o.scale=m.floatDelimArray(m.collectTextNode(B));a.bindSceneObject(o);""!==F&&w.push([o,F])}}for(var E in w)w.hasOwnProperty(E)&&a.getSceneObject(w[E][1]).bindChild(w[E][0]);b=h.getElementsByTagName("camera");b.length&&((z=u=null,f="",o=b[0].getElementsByTagName("name"),E=a.camera,h=null,o.length&&(f=o[0].firstChild.nodeValue),o=b[0].getElementsByTagName("target"),o.length&&(f=o[0].firstChild.nodeValue),""!==f&&(E.targetSceneObject=a.getSceneObject(f)),o=b[0].getElementsByTagName("position"),
o.length&&(u=o[0]),o=b[0].getElementsByTagName("rotation"),o.length&&(z=o[0]),o=b[0].getElementsByTagName("fov"),o.length&&(h=o[0]),n(u)?(E.motion||(E.motion=new CubicVR.Motion),r(u,g.motion.POS,E.motion)):u&&(E.position=m.floatDelimArray(u.firstChild.nodeValue)),n(z)?(E.motion||(E.motion=new CubicVR.Motion),r(z,g.motion.ROT,E.motion)):z&&(E.rotation=m.floatDelimArray(z.firstChild.nodeValue)),n(h))?(E.motion||(E.motion=new CubicVR.Motion),r(h,g.motion.FOV,E.motion)):h&&(E.fov=parseFloat(h.firstChild.nodeValue)));
return a}}});
CubicVR.RegisterModule("Worker",function(h){function y(a){var b=this;this.message=a.message||function(){};this.send=function(a,b){postMessage({message:a,data:b})};self.addEventListener("message",function(a){"init"!==a.data.message&&b.message(a.data)},!1)}function w(a){function b(a){setTimeout(function(){c.send("test",a)},1E3)}a&&b(a);var c=new y({message:b})}function q(a){function b(a){a=s.getURL(a);c.send("done",a.length)}var c;c=new y({message:function(a){b(a)}});a&&b(a)}function n(a){function b(a){a=s.getURL(a);
c.send("loaded",a)}var c,d;c=new y({message:function(a){if("parse"===a.message)d=new o,CubicVR.loadCollada("","",d,a.data),c.send("parsed");else if("getMesh"===a.message){if(a=d.meshMap[":"+a.data]){var b=a.triangulateQuads().compileVBO(a.compileMap());c.send("getMesh",{mesh:a,vbo:b})}}else throw Error("Not a SceneFileWorker command: "+a.message);}});a&&b(a)}function r(b){function c(b){var e=new a,f;for(f in b)b.hasOwnProperty(f)&&(e[f]=b[f]);b=e.triangulateQuads().compileVBO(e.compileMap());d.send("done",
b)}var d;d=new y({message:function(a){c(a)}});b&&c(b)}try{window||(self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}})}catch(c){self.window=self,self.document={},self.fakeWindow=!0,self.console={log:function(){}}}var g=h.undef,a=CubicVR.Mesh,b=CubicVR.Texture,e=CubicVR.Material,d=CubicVR.SceneObject,f=CubicVR.Motion,m=CubicVR.Envelope,o=CubicVR.DeferredBin,s=CubicVR.util;return{Worker:function(a){this.worker=new Worker(CubicVR.getScriptLocation()+"CubicVR.js");this.message=
a.message||function(){};this.error=a.error||function(a){console.log("Error: "+a.message+": "+a.lineno)};this.type=a.type;var b=this;this.worker.onmessage=function(a){b.message(a.data)};this.worker.onerror=function(a){b.error(a)};this.init=function(a){b.send("init",{type:b.type,data:a})};this.send=function(a,c){b.worker.postMessage({message:a,data:c})};this.send("CubicVR_InitWorker",CubicVR.getScriptLocation());(a.data||a.autoStart)&&b.init(a.data)},ResourcePool:function(){function c(b){var d=b.parsed||
function(){},e={},f;b.url.match(/\.dae/)&&(f=new CubicVR.Worker({type:"sceneFile",data:b.url,message:function(b){if("loaded"===b.message){var b=(new DOMParser).parseFromString(b.data,"text/xml"),c=s.xml2badgerfish(b);console.log(b);f.send("parse",c)}else if("getMesh"===b.message){var c=new a,g;for(g in b.data.mesh)b.data.mesh.hasOwnProperty(g)&&(c[g]=b.data.mesh[g]);c.bindBuffer(c.bufferVBO(b.data.vbo));e.getMesh&&e.getMesh(c)}else"parsed"===b.message&&d()}}));this.getSceneObject=function(a,b){f.send("getMesh",
a);e.getMesh=b}}function f(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}var g=this,m={};this.createSceneFileManager=function(a){var b=new c({url:a.url,parsed:a.parsed});return m[a.url]=b};this.removeSceneFileManager=function(a){if("string"===typeof settings)delete m[settings];else for(var b in m)m[b]===a&&delete m[b]};this.createSceneObjectFromMesh=function(c){var m=c.scene,o=c.object,h=c.assetBase||"",n=g.createSceneFileManager({url:c.mesh,parsed:function(){o&&n.getSceneObject(o,
function(c){for(var c=f(c,new a),g=0,o=c.materials.length;g<o;++g){for(var n=f(c.materials[g],new e),u=0,q=n.textures.length;u<q;++u){var s=n.textures[g];n.textures[g]=new b(h+s.img_path,s.filter_type)}c.materials[g]=n}c=new d(c);m.bindSceneObject(c)})}})};this.loadFile=function(a,b){b=b||function(){};new CubicVR.Worker({type:"file",data:mesh,message:function(a){b(a.data)}})}},loadColladaWorker:function(c,o,h,n){var q;try{q=new Worker(CubicVR.getScriptLocation()+"collada.js")}catch(s){throw Error("Can't find collada.js");
}var r=[],t=[];q.onmessage=function(o){function q(a,b){for(var c in a)b[c]=a[c]}function s(a){if(a.motion){for(var b=a.motion.controllers,c=[],d=0,e=b.length;d<e;++d){var g=b[d];if(g){for(var o=[],h=0,n=g.length;h<n;++h){var u=g[h];if(u){var r=u.keys[0];1<u.keys.length&&(r.prev=null,r.next=u.keys[1],r=u.keys[1]);for(var t=1,v=u.keys.length-1;t<v;++t)r.prev=u.keys[t-1],r.next=u.keys[t+1],r=u.keys[t+1];1<u.keys.length&&(r=u.keys[u.keys.length-1],r.prev=u.keys[u.keys.length-2],r.next=null);u.firstKey=
u.keys[0];u.lastKey=u.keys[u.keys.length-1];u.keys=u.firstKey;r=new m;q(u,r);o[h]=r}else g[h]=null}c[d]=o}else b[d]=null}a.motion.controllers=c;b=new f;q(a.motion,b);a.motion=b}}function v(b){var e=new d;q(b,e);if(null!==b.obj){var f=t[b.obj.id];if(f===g)if(f=new a,q(b.obj,f),e.obj=f,t[b.obj.id]=f,n){if(0<f.points.length){n.addMesh(c,c+":"+f.id,f);for(var m=0,o=f.faces.length;m<o;++m){var h=f.faces[m],u=h.material;h.material=r[u]!==g?r[u]:0}}}else e.obj.triangulateQuads(),e.obj.calcNormals(),e.obj.compile(),
e.obj.clean();else e.obj=f}e.trans=new Transform;if(b.children&&0<b.children.length&&(e.children=[],b.children)){f=0;for(m=b.children.length;f<m;++f)o=v(b.children[f]),e.bindChild(o)}return e}var B;B=o.data.message;if("materials"==B){var w=JSON.parse(o.data.data),o=0;for(B=w.length;o<B;++o){var C=new e(w[o].name),y=C.material_id;q(w[o],C);C.material_id=y;r[w[o].material_id]=y;for(var y=0,M=w[o].textures.length;y<M;++y){var K=w[o].textures[y];if(K){var N=Texture_ref[K.img_path];N===g?(K=new b(K.img_path,
K.filter_type,n,c),C.textures[y]=K):C.textures[y]=Textures_obj[N]}else C.textures[y]=0}}}else if("scene"==B){w=JSON.parse(o.data.data);o=0;for(B=w.sceneObjects.length;o<B;++o)C=w.sceneObjects[o],null!==C.obj&&nop(),C.reassembled===g&&(s(C),C.reassembled=!0),w.sceneObjects[o]=v(C);C=new Scene;o=C.camera;B=o.transform;q(w.camera,o);q(w.camera.transform,B);s(o);C.camera=o;C.camera.transform=B;C.camera.frustum=new Frustum;o=0;for(B=w.sceneObjects.length;o<B;++o){y=w.sceneObjects[o];C.bindSceneObject(y);
try{y.getAABB()}catch(Y){}}o=0;for(B=w.lights.length;o<B;++o)y=new Light,q(w.lights[o],y),y.trans=new Transform,s(y),C.bindLight(y);h(C)}else console.log("message from collada worker:",o.data.message)};q.onerror=function(a){console.log("error from collada worker:",a.message)};q.postMessage({message:"start",params:{meshUrl:c,prefix:o,rootDir:CubicVR.getScriptLocation()}})},InitWorker:function(){var a={test:w,prepareMesh:r,file:q,sceneFile:n};self.addEventListener("message",function(b){if("init"===
b.data.message){var c=b.data.data.type;if(c in a)new a[c](b.data.data.data);else throw Error("Invalid worker type.");}},!1)}}});
CubicVR.RegisterModule("Polygon",function(h){function y(a){var b=[],c=a.length;if(3>c)return null;var e=[],g;g=a.length;for(var h=0,n=g-1,q=0;q<g;n=q++)h+=a[n][0]*a[q][1]-a[q][0]*a[n][1];if(0<0.5*h)for(g=0;g<c;g++)e[g]=g;else for(g=0;g<c;g++)e[g]=c-1-g;q=2*c;h=0;for(g=c-1;2<c;){if(0>=q--)return null;var r=g;c<=r&&(r=0);g=r+1;c<=g&&(g=0);n=g+1;c<=n&&(n=0);var w;a:{w=a;var y=r,t=g,x=n,F=c,A=e,E=void 0,I=void 0,G=void 0,J=void 0,L=void 0,M=void 0,K=void 0,N=void 0,Y=void 0,I=w[A[y]][0],G=w[A[y]][1],
J=w[A[t]][0],L=w[A[t]][1],M=w[A[x]][0],K=w[A[x]][1];if(d>(J-I)*(K-G)-(L-G)*(M-I))w=!1;else{for(E=0;E<F;E++)if(!(E==y||E==t||E==x)){var N=w[A[E]][0],Y=w[A[E]][1],ca=void 0,U=void 0,na=void 0,Q=void 0,O=void 0,Ma=void 0,gb=void 0,hb=void 0,Na=void 0,qb=void 0,Oa=void 0,ib=void 0,ca=na=O=void 0,ca=M-J,U=K-L,na=I-M,Q=G-K,O=J-I,Ma=L-G,gb=N-I,hb=Y-G,Na=N-J,qb=Y-L,Oa=N-M,ib=Y-K,ca=ca*qb-U*Na,O=O*hb-Ma*gb,na=na*ib-Q*Oa;if(0<=ca&&0<=na&&0<=O){w=!1;break a}}w=!0}}if(w){q=e[r];r=e[g];n=e[n];b.push(q);b.push(r);
b.push(n);h++;n=g;for(q=g+1;q<c;n++,q++)e[n]=e[q];c--;q=2*c}}return b}function w(a,b,c){c===e&&(c=0);var d;d=y(b);var g=CubicVR.util.repackArray(d,3,d.length/3),h=[],n=a.points.length;d=0;for(iMax=b.length;d<iMax;d++)h.push([b[d][0],b[d][1],c]);a.addPoint(h);d=0;for(iMax=g.length;d<iMax;d++)a.addFace([g[d][0]+n,g[d][1]+n,g[d][2]+n])}function q(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)}function n(a,b){var c,d,e=[],g=a.length,h=b.length,n=[];for(c=0;c<g;c++)for(d=0;d<h;d++){var r=q(a[c],
b[d]);e.push([r,c,d])}e.sort(function(a,b){return a[0]>b[0]});for(c=0;5>c;c++)for(d=0;d<e.length;d++)c!=d&&e[c][1]!=e[d][1]&&e[c][2]!=e[d][2]&&e[c][1]<e[d][1]&&e[c][2]<e[d][2]&&4>Math.abs(e[c][1]-e[d][1])&&4>Math.abs(e[c][2]-e[d][2])&&n.push([c,d]);n.sort(function(a,b){return e[a[0]][0]+e[a[1]][0]>e[b[0]][0]+e[b[1]][0]});10<n.length&&(n.length=10);d=[];for(c=0;c<n.length;c++)d.push([e[n[c][0]],e[n[c][1]]]);return d}function r(a,b){var c=n(a,b),d;if(!c.length)return null;d=c[0][0];var e=c[0][1],c=
e[1]-d[1],e=e[2]-d[2],g=a.slice(d[1]),g=g.concat(a.slice(0,d[1])),h=b.slice(d[2]),h=h.concat(b.slice(0,d[2])),q=[];for(d=c;d<g.length;d++)q.push(g[d]);q.push(g[0]);for(d=e;d<h.length;d++)q.push(h[d]);q.push(h[0]);var r=[];for(d=0;d<=c;d++)r.push(g[d]);for(d=0;d<=e;d++)r.push(h[d]);return[q,r]}function c(a){for(var b=[0,0],c=0;c<a.length;c++)b[0]+=a[c][0],b[1]+=a[c][1];b[0]/=a.length;b[1]/=a.length;return b}function g(a,b,c){for(var d=[],e=0;e<a.length;e++){var g=[a[e][0]-b[0],a[e][1]-b[1]],h=Math.sqrt(g[0]*
g[0]+g[1]*g[1])+c,g=Math.atan2(g[1],g[0]);d[e]=[b[0]+Math.cos(g)*h,b[1]+Math.sin(g)*h]}return d}function a(a,b,c,d,e){var g,h=a.points.length;if(b.length!=c.length)return null;var n=b.length;for(g=0;g<n;g++)a.addPoint([b[g][0],b[g][1],d]);for(g=0;g<n;g++)a.addPoint([c[g][0],c[g][1],e]);for(g=0;g<n-1;g++)a.addFace([h+g,h+g+1,h+(g+n+1),h+(g+n)]);g=n-1;a.addFace([h+g,h,h+n,h+(g+n)])}function b(a){this.points=a;this.cuts=[];this.result=[]}var e=h.undef,d=1.0E-10;b.prototype={cut:function(a){this.cuts.push(a)},
toMesh:function(a){if(0!==this.points.length){var b;a||(a=new CubicVR.Mesh);this.result=[this.points];for(b=0;b<this.cuts.length;b++){var c=this.cuts[b].points.slice(0),c=c.reverse(),c=r(this.result[0],c);this.result[0]=c[0];this.result.push(c[1])}for(b=0;b<this.result.length;b++)w(a,this.result[b]);a.removeDoubles();return a}},toExtrudedMesh:function(b,c,d){if(0!==this.points.length){var g,h;c===e&&(c=0);d===e&&(d=0);var n=c!=d;b||(b=new CubicVR.Mesh);this.result=[this.points];for(h=0;h<this.cuts.length;h++)g=
this.cuts[h].points.slice(0),g=g.reverse(),g=r(this.result[0],g),this.result[0]=g[0],this.result.push(g[1]);g=new CubicVR.Mesh;for(h=0;h<this.result.length;h++)w(g,this.result[h],d);b.booleanAdd(g);g.flipFaces();if(n)for(h=0;h<g.points.length;h++)g.points[h][2]=c;b.booleanAdd(g);if(n){a(b,this.points,this.points,c,d);for(h=0;h<this.cuts.length;h++)g=this.cuts[h].points.slice(0),g=g.reverse(),a(b,g,g,c,d)}b.removeDoubles();return b}},toExtrudedBeveledMesh:function(b,d,e,h,n,q,u){var z=[],B=[],y,H,
t,x;if(0!==this.points.length){"object"===typeof d&&(u=d,d=u.front||0,e=u.back||0,h=u.frontDepth||0,n=u.frontShift||0,q=u.backDepth||0,u=u.backShift||0);var F=d!==e,A=0!==q,E=0!==h;b||(b=new CubicVR.Mesh);E?(H=c(this.points),H=g(this.points,H,-n),this.result=[H.slice(0)]):this.result=[this.points.slice(0)];for(x=0;x<this.cuts.length;x++)t=c(this.cuts[x].points),t=g(this.cuts[x].points,t,n),t=t.reverse(),z.push(t),t=r(this.result[0],t),this.result[0]=t[0],this.result.push(t[1]);n=new CubicVR.Mesh;
for(x=0;x<this.result.length;x++)w(n,this.result[x],d-h);n.flipFaces();b.booleanAdd(n);if(A||E){y=c(this.points);y=g(this.points,y,-u);this.result=[y.slice(0)];for(x=0;x<this.cuts.length;x++)t=c(this.cuts[x].points),t=g(this.cuts[x].points,t,u),t=t.reverse(),B.push(t),t=r(this.result[0],t),this.result[0]=t[0],this.result.push(t[1]);n=new CubicVR.Mesh;for(x=0;x<this.result.length;x++)w(n,this.result[x],e+q)}else{for(x=0;x<n.points.length;x++)n.points[x][2]=e;n.flipFaces()}b.booleanAdd(n);E&&a(b,H,
this.points,d-h,d);F&&a(b,this.points,this.points,d,e);A&&a(b,this.points,y,e,e+q);for(x=0;x<z.length;x++)t=this.cuts[x].points.slice(0).reverse(),E&&a(b,z[x],t,d-h,d),F&&a(b,t,t,d,e),A&&a(b,t,B[x],e,e+q);b.removeDoubles();return b}}};return{polygon:{triangulate2D:y,toMesh:w,findNearPair:function(a,b){for(var c=[0,0],d=q(a[0],b[0]),e=a.length,g=b.length,h=0;h<e;h++)for(var n=0;n<g;n++){var r=q(a[h],b[n]);r<d&&(c[0]=h,c[1]=n,d=r)}return c},subtract:r,addOffset:function(a,b){for(var c=[],d=0,e=a.length;d<
e;d++){var g=a[d];c.push([g[0]+b[0],g[1]+b[1]])}return c}},Polygon:b}});
CubicVR.RegisterModule("ScenePhysics",function(h){function y(a,b){b.setX(a[0]);b.setY(a[1]);b.setZ(a[2])}function w(a,b){b.setX(a.x);b.setY(a.y);b.setZ(a.z);b.setW(a.w)}function q(a,b){b.x=a.x();b.y=a.y();b.z=a.z();b.w=a.w()}function n(a){return new Ammo.btVector3(a[0],a[1],a[2])}function r(a){var b=new Ammo.btQuaternion;b.setEulerZYX(a[2]*(Math.PI/180),a[1]*(Math.PI/180),a[0]*(Math.PI/180));return b}function c(a){return[a.x(),a.y(),a.z()]}function g(a){this.setManifold(a)}var a=h.undef,b=h.enums;
b.physics={body:{STATIC:0,DYNAMIC:1,GHOST:2,SOFT:3},constraint:{P2P:0},collision_flags:{STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32},rigid_flags:{DISABLE_WORLD_GRAVITY:1},collision_types:{COLLISION_OBJECT:1,RIGID_BODY:2,GHOST_OBJECT:3,SOFT_BODY:4,HF_FLUID:5},collision_states:{ACTIVE_TAG:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5}};var e,d,f,m,o,s=function(a,b,c){var d;
!a.position&&a.sceneObject&&(d=a,a=a.sceneObject,b=d.properties,c=d.collision);d=h.get(d)||{};this.properties=new h.RigidProperties(b?h.get(b):{collision:c});this.collisionEvents=[];this.parent=null;this.init_position=a.position.slice(0);this.init_rotation=a.rotation.slice(0);this.init_linearVelocity=this.linearVelocity=d.linearVelocity||[0,0,0];this.init_angularVelocity=this.angularVelocity=d.angularVelocity||[0,0,0];this.init_impulse=this.impulse=d.impulse||[0,0,0];this.init_impulsePosition=this.impulsePosition=
d.impulsePosition||[0,0,0];this.collision_flags=this.rigid_flags=null;this.sceneObject=a;this.transform=new Ammo.btTransform;this.transform.setIdentity();this.transform.setOrigin(n(this.init_position));this.transform.setRotation(r(this.init_rotation));this.shape=null;this.motionState=new Ammo.btDefaultMotionState(this.transform);this.localInertia=new Ammo.btVector3(0,0,0);this.ghost=this.body=this.bodyInit=null;this.noDeactivate=!1};s.prototype={getProperties:function(){return this.properties},getSceneObject:function(){return this.sceneObject},
getInitialPosition:function(){return this.init_position},getInitialRotation:function(){return this.init_rotation},setInitialPosition:function(){this.init_position=init_position_in},setInitialRotation:function(){this.init_rotation=init_rotation_in},getType:function(){return this.properties.type},getMass:function(){return this.properties.mass},getRestitution:function(){return this.properties.restitution},getCollisionMap:function(){return this.properties.collision},setMass:function(a){this.properties.mass=
a;this.body&&this.body.setMassProps(a,this.localInertia)},setRestitution:function(a){this.restitution=a},getBody:function(){if(!this.body&&!this.ghost){var a=this.getCollisionShape();this.getType()===b.physics.body.GHOST?(this.body=null,this.ghost=new Ammo.btGhostObject,this.ghost.setCollisionShape(a),this.ghost.setWorldTransform(this.transform),this.ghost._cvr_rigidbody=this):(this.getMass()&&a.calculateLocalInertia(this.getMass(),this.localInertia),this.bodyInit=new Ammo.btRigidBodyConstructionInfo(this.getMass(),
this.motionState,a,this.localInertia),this.friction&&this.bodyInit.set_m_friction(this.friction),this.body=new Ammo.btRigidBody(this.bodyInit),this.getRestitution()&&this.body.setRestitution(this.getRestitution()),y(this.linearVelocity,m),this.body.setLinearVelocity(m),y(this.angularVelocity,m),this.body.setAngularVelocity(m),h.vec3.equal([0,0,0],this.impulse)||(y(this.impulse,m),y(this.impulsePosition,o),this.body.applyImpulse(m,o)),this.rigid_flags&&this.body.setFlags(this.rigid_flags),this.collision_flags&&
this.body.setFlags(this.collision_flags),this.body._cvr_rigidbody=this)}return this.body||this.ghost},updateSceneObject:function(a){if(this.body&&(this.body.isActive()||a))return this.body.getMotionState().getWorldTransform(e),a=e.getOrigin(),a.x!=a.x?console.log("origin is NaN"):(this.sceneObject.position[0]=a.x(),this.sceneObject.position[1]=a.y(),this.sceneObject.position[2]=a.z()),a=e.getRotation(),d.x=a.x(),d.y=a.y(),d.z=a.z(),d.w=a.w(),d.x!=d.x?console.log("rotation is NaN"):(a=d.toEuler(),
this.sceneObject.rotation[0]=a[0],this.sceneObject.rotation[1]=a[1],this.sceneObject.rotation[2]=a[2]),!0},reset:function(){if(this.body){var a=this.body.getWorldTransform().getOrigin();y(this.init_position,a);this.body.getWorldTransform().getRotation();this.resetMotion();a=this.init_rotation;d.fromEuler(a[0],a[1],a[2]);a=[d.x,d.y,d.z,d.w];f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);f.setW(a[3]);this.body.getWorldTransform().setRotation(f);this.activate()}},resetMotion:function(){y(this.init_linearVelocity,
m);this.body.setLinearVelocity(m);y(this.init_angularVelocity,m);this.body.setAngularVelocity(m);h.vec3.equal([0,0,0],this.init_impulse)||(y(this.init_impulse,m),y(this.init_impulsePosition,o),this.body.applyImpulse(m,o))},getCollisionShape:function(){if(!this.shape){var a;a=this.getCollisionMap();if(a.getResult())a=a.getResult();else{var c=a.getShapes(),d,g,f,m,o,q,s,v=[],w=null;g=0;for(f=c.length;g<f;g++){d=c[g];w=null;if(d.type===b.collision.shape.BOX)w=new Ammo.btBoxShape(new Ammo.btVector3(d.size[0]/
2,d.size[1]/2,d.size[2]/2));else if(d.type===b.collision.shape.SPHERE)w=new Ammo.btSphereShape(d.radius);else if(d.type===b.collision.shape.CAPSULE)w=new Ammo.btCapsuleShape(d.radius,d.height);else if(d.type===b.collision.shape.CYLINDER)w=new Ammo.btCylinderShape(new Ammo.btVector3(d.size[0]/2,d.size[1]/2,d.size[2]/2));else if(d.type===b.collision.shape.CONE)w=new Ammo.btConeShape(d.radius,d.height);else if(d.type===b.collision.shape.MESH){s=d.mesh;w=new Ammo.btTriangleMesh;q=d.size;var D=new Ammo.btVector3(0,
0,0),J=new Ammo.btVector3(0,0,0),L=new Ammo.btVector3(0,0,0),M=s.getMaterials();m=0;for(o=s.faces.length;m<o;m++){var K=s.faces[m];M[K.material].collision&&3===K.points.length&&(D.setValue(s.points[K.points[0]][0]*q[0],s.points[K.points[0]][1]*q[1],s.points[K.points[0]][2]*q[2]),J.setValue(s.points[K.points[1]][0]*q[0],s.points[K.points[1]][1]*q[1],s.points[K.points[1]][2]*q[2]),L.setValue(s.points[K.points[2]][0]*q[0],s.points[K.points[2]][1]*q[1],s.points[K.points[2]][2]*q[2]),w.addTriangle(D,J,
L))}0===this.getMass()||this.getType()==b.physics.body.STATIC||this.getType()==b.physics.body.GHOST?(this.setMass(0),w=new Ammo.btBvhTriangleMeshShape(w,!0)):w=new Ammo.btConvexTriangleMeshShape(w,!0)}else if(d.type===b.collision.shape.CONVEX_HULL){s=d.mesh;q=d.size;D=new Ammo.btVector3(0,0,0);w=new Ammo.btConvexHullShape;m=0;for(o=s.points.length;m<o;m++)y([s.points[m][0]*q[0],s.points[m][1]*q[1],s.points[m][2]*q[2]],D),w.addPoint(D)}else if(d.type===b.collision.shape.HEIGHTFIELD){var J=D=s=q=0,
N;d.landscape&&!d.getHeightField&&d.landscape instanceof h.HeightField?d.heightfield=d.landscape:d.landscape&&d.landscape instanceof h.Landscape&&(q=d.landscape.getHeightField().getDivX(),D=d.landscape.getHeightField().getDivZ(),s=d.landscape.getHeightField().getSizeX(),J=d.landscape.getHeightField().getSizeZ(),N=d.landscape.getMesh().points,d.landscape.getHeightField());d.heightfield&&d.heightfield instanceof h.HeightField&&(q=d.heightfield.getDivX(),D=d.heightfield.getDivZ(),s=d.heightfield.getSizeX(),
J=d.heightfield.getSizeZ(),N=d.getMesh().points);w=Ammo.allocate(4*N.length,"float",Ammo.ALLOC_NORMAL);m=0;for(o=q*D;m<o;m++)Ammo.setValue(w+(m<<2),N[m][1],"float");w=new Ammo.btHeightfieldTerrainShape(q,D,w,1,-100,100,1,0,!1);w.setUseDiamondSubdivision(!0);m=new Ammo.btVector3(s/q,1,J/D);w.setLocalScaling(m)}w&&(0!==d.margin&&w.setMargin(d.margin),v.push({cShape:d,btShape:w}))}c=null;if(1===v.length)c=v[0].btShape;else if(1<v.length){e=new Ammo.btTransform;c=new Ammo.btCompoundShape(!1);g=0;for(f=
v.length;g<f;g++)e.setIdentity(),e.setOrigin(n(v[g].cShape.position)),e.setRotation(r(v[g].cShape.rotation)),c.addChildShape(e,v[g].btShape)}a.setResult(c);a=c}this.shape=a}return this.shape},setAngularVelocity:function(a){this.angularVelocity=a;this.body&&(y(a,m),this.body.setAngularVelocity(m))},setGravity:function(a){this.gravity=a;this.body&&(y(a,m),this.body.setGravity(m))},getGravity:function(){return this.gravity&&!this.body?this.gravity:c(this.body.getGravity())},setLinearVelocity:function(a){this.linearVelocity=
a;this.body&&(y(a,m),this.body.setLinearVelocity(m))},applyImpulse:function(a,b){this.impulse=a||[0,0,0];this.impulsePosition=b||[0,0,0];this.body&&!h.vec3.equal([0,0,0],a)&&(y(this.impulse,m),y(this.impulsePosition,o),this.body.applyImpulse(m,o))},applyForce:function(a,b){this.body&&!h.vec3.equal([0,0,0],a)&&(y(a,m),y(b,o),this.body.applyImpulse(m,o))},getAngularVelocity:function(){return c(this.body.getAngularVelocity())},getLinearVelocity:function(){return c(this.body.getLinearVelocity())},activate:function(a){this.noDeactivate=
a||!1;this.body&&(this.noDeactivate&&this.body.setActivationState(b.physics.collision_states.DISABLE_DEACTIVATION),this.body.activate())},setAngularFactor:function(b){this.body&&b!==a&&(b.length||(b=[b,b,b]),y(b,m),this.body.setAngularFactor(m))},isActive:function(){return this.body?this.body.isActive():!1},isStatic:function(){return this.properties.type==b.physics.body.STATIC},setRigidFlags:function(a){this.rigid_flags=a;this.body&&this.body.setFlags(a)},setCollisionFlags:function(a){this.collision_flags=
a=h.parseEnum(b.physics.collision_flags,a);this.body&&this.body.setCollisionFlags(a)},setPosition:function(a){this.position=a;if(this.body||this.ghost)y(a,m),this.body&&this.body.getCenterOfMassTransform().setOrigin(m),this.ghost&&this.ghost.getWorldTransform().setOrigin(m)},getRotation:function(){if(!this.body&&!this.ghost)return this.init_rotation;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);var a=new h.Quaternion;q(f,a);
return a},setRotation:function(a){this.rotation=a.toEuler();if(this.body||this.ghost)w(a,f),this.body&&this.body.getCenterOfMassTransform().setRotation(f),this.ghost&&this.ghost.getWorldTransform().setRotation(f)},getRotationEuler:function(){if(!this.body&&!this.ghost)return this.init_rotation;var a=new h.Quaternion;this.body&&this.body.getCenterOfMassTransform().getRotation(f);this.ghost&&this.ghost.getWorldTransform().getRotation(f);q(f,a);return a.toEuler()},setRotationEuler:function(a){this.rotation=
a;f.setEuler(this.rotation[2]*(Math.PI/180),this.rotation[1]*(Math.PI/180),this.rotation[0]*(Math.PI/180));this.body&&this.body.getCenterOfMassTransform().setRotation(f);this.ghost&&this.body.getWorldTransform().setRotation(f)}};var D=function(c){c=c||{};this.ctype=h.parseEnum(b.physics.constraint,c.ctype)||b.physics.constraint.P2P;this.strength=c.strength||0.1;this.maxImpulse=c.maxImpulse||0;this.rigidBodyA=c.rigidBodyA||c.rigidBody||null;this.rigidBodyB=c.rigidBodyB||null;this.positionA=c.positionA||
[0,0,0];this.positionB=c.positionB||c.position||[0,0,0];this.damping=c.damping!=a?c.damping:1;this.btConstraint=null;this.localPivotA=n(this.positionA);this.localPivotB=n(this.positionB)};D.prototype={getConstraint:function(){if(!this.btConstraint){if(!this.rigidBodyA)return!1;this.ctype===b.physics.constraint.P2P&&(this.btConstraint=this.rigidBodyA&&this.rigidBodyB?new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),this.rigidBodyB.getBody(),this.localPivotA,this.localPivotB):new Ammo.btPoint2PointConstraint(this.rigidBodyA.getBody(),
this.localPivotA),this.btConstraint.get_m_setting().set_m_tau(this.strength),this.btConstraint.get_m_setting().set_m_damping(this.damping),this.maxImpulse&&this.btConstraint.get_m_setting().set_m_impulseClamp(this.maxImpulse),this.btConstraint===Ammo.NULL&&(this.btConstraint=null))}return this.btConstraint},setStrength:function(a){this.strength=a;this.btConstraint&&this.btConstraint.get_m_setting().set_m_tau(this.strength)},setDamping:function(a){this.damping=a;this.btConstraint&&this.btConstraint.get_m_setting().set_damping(this.damping)},
setMaxImpulse:function(a){this.maxImpulse=a;this.btConstraint&&this.btConstraint.get_m_setting().set_impulseClamp(this.maxImpulse)},getStrength:function(){return this.strength},setPosition:function(a){this.positionB=a;this.btConstraint&&(y(this.positionB,this.localPivotB),this.btConstraint.setPivotB(this.localPivotB))},getPosition:function(){return this.positionB}};g.prototype={getContact:function(){var a=this.manifold.getContactPoint(j);return a===Ammo.NULL?null:{impulse:a.getAppliedImpulse(),lifetime:a.getLifeTime(),
friction:a.get_m_combinedFriction(),positionA:c(a.getPositionWorldOnA()),positionB:c(a.getPositionWorldOnB())}},setManifold:function(a){this.numContacts=a.getNumContacts();this.manifold=a}};var v=function(){this.rigidObjects=[];this.ghostObjects=[];this.contactObjects=[];this.collisionObjects=[];this.active_count=0;this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration;this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration);this.overlappingPairCache=new Ammo.btDbvtBroadphase;
this.solver=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration);this.dynamicsWorld.setGravity(new Ammo.btVector3(0,-10,0));this.overlappingPairCache.getOverlappingPairCache().setInternalGhostPairCallback(new Ammo.btGhostPairCallback);if(!e||!d)m=new Ammo.btVector3,o=new Ammo.btVector3,e=new Ammo.btTransform,d=new h.Quaternion,f=new Ammo.btQuaternion};v.prototype={addConstraint:function(a){var b=
a.getConstraint();return b?(this.dynamicsWorld.addConstraint(b),a.rigidBodyA.activate(!0),!0):!1},removeConstraint:function(a){return(a=a.getConstraint())?(this.dynamicsWorld.removeConstraint(a),!0):!1},setGravity:function(a){y(a,m);this.dynamicsWorld.setGravity(m)},bindSceneObject:function(a,b){var c=new h.RigidBody(a,b);this.rigidObjects.push(c);c.getBody();c.activate();this.dynamicsWorld.addRigidBody(c.getBody());c.updateSceneObject(!0);return c},bind:function(a){a instanceof h.Vehicle?a.initBody(this):
a instanceof h.RigidBody&&this.bindRigidBody(a)},remove:function(a){a instanceof h.RigidBody&&this.removeRigidBody(a)},bindRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1!==this.ghostObjects.indexOf(a))return;this.ghostObjects.push(a);var c=a.getBody();a.properties.blocker||c.setCollisionFlags(c.getCollisionFlags()+b.physics.collision_flags.NO_CONTACT_RESPONSE);this.dynamicsWorld.addCollisionObject(c)}else{if(-1!==this.rigidObjects.indexOf(a))return;this.rigidObjects.push(a);c=
a.getBody();a.activate();this.dynamicsWorld.addRigidBody(c);a.updateSceneObject(!0)}var d,e;if((d=a.getSceneObject())&&(e=d.getEventHandler()))e.hasEvent(b.event.CONTACT)&&this.contactObjects.push(a),e.hasEvent(b.event.COLLIDE)&&this.collisionObjects.push(a)},removeRigidBody:function(a){if(a.getType()===b.physics.body.GHOST){if(-1===this.ghostObjects.indexOf(a))return;this.ghostObjects.splice(this.ghostObjects.indexOf(a),1);this.dynamicsWorld.removeCollisionObject(a.getBody())}else{if(-1===this.rigidObjects.indexOf(a))return;
this.rigidObjects.splice(this.rigidObjects.indexOf(a),1);this.dynamicsWorld.removeRigidBody(a.getBody())}var c,d;if((c=a.getSceneObject())&&(d=c.getEventHandler()))d.hasEvent(b.event.CONTACT)&&-1!==this.contactObjects.indexOf(a)&&this.contactObjects.splice(this.contactObjects.indexOf(a),1),d.hasEvent(b.event.COLLIDE)&&-1!==this.collisionObjects.indexOf(a)&&this.collisionObjects.splice(this.collisionObjects.indexOf(a),1)},getActiveCount:function(){return this.active_count},stepSimulation:function(a,
b){this.dynamicsWorld.stepSimulation(a,b||2);for(var c=0,d=0,e=this.rigidObjects.length;d<e;d++)this.rigidObjects[d].updateSceneObject()&&c++;this.active_count=c},triggerEvents:function(){var a,c,d,e,f=this.dynamicsWorld;if(this.contactObjects.length){var h=f.getDispatcher().getNumManifolds();for(a=0;a<h;a++){var m=f.getDispatcher().getManifoldByIndexInternal(a),n=Ammo.wrapPointer(m.getBody0(),Ammo.btRigidBody)._cvr_rigidbody||null,o=Ammo.wrapPointer(m.getBody1(),Ammo.btRigidBody)._cvr_rigidbody||
null;if(n&&(e=n.getSceneObject())&&(c=e.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.self=n,d.other=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m);else if(o&&o.isStatic()&&(e=o.getSceneObject())&&(c=e.getEventHandler())&&c.hasEvent(b.event.CONTACT))d=c.triggerEvent(b.event.CONTACT),d.other=n,d.self=o,d.contacts?d.contacts.setManifold(m):d.contacts=new g(m)}}f=this.collisionObjects.length;for(a=0;a<f;a++)if(n=this.collisionObjects[a],(e=n.getSceneObject())&&
(c=e.getEventHandler())&&c.hasEvent(b.event.COLLIDE))if(d=c.getProperties(b.event.COLLIDE),m=d.collidesWith,d.mf=d.mf||[],d.alg=d.alg||[],m&&m.length){h=[];n=n.getBody();a=0;for(iMax=m.length;a<iMax;a++){var o=m[a],q=o.getBody();d.mf[a]||(d.mf[a]=new Ammo.btManifoldResult(n,q));d.alg[a]||(d.alg[a]=this.dynamicsWorld.getDispatcher().findAlgorithm(n,q));d.alg[a].processCollision(n,q,this.dynamicsWorld.getDispatchInfo(),d.mf[a]);0<d.mf[a].getPersistentManifold().getNumContacts()&&(h.push(o),this.dynamicsWorld.getDispatcher().clearManifold(d.mf[a].getPersistentManifold()))}if(h.length&&
(d=c.triggerEvent(b.event.COLLIDE)))d.collisions=h}f=this.ghostObjects.length;for(a=0;a<f;a++)if(d=this.ghostObjects[a],e=d.getSceneObject())if((c=e.getEventHandler())&&c.hasEvent(b.event.CONTACT_GHOST))if(e=d.getBody(),h=e.getNumOverlappingObjects()){d=c.triggerEvent(b.event.CONTACT_GHOST);d.contacts=d.contacts||[];d.contacts.length>h&&(d.contacts.length=h);for(c=0;c<h;c++)m=Ammo.btRigidBody.prototype.upcast(e.getOverlappingObject(c)),d.contacts[c]=m._cvr_rigidbody||null}},reset:function(){for(var a=
0,b=this.rigidObjects.length;a<b;a++)this.rigidObjects[a].reset()},getRayHit:function(a,b,d,e){var g,a=n(a);g=n(b);d=d||!1;e=e||!1;b=new Ammo.ClosestRayResultCallback(a,g);this.dynamicsWorld.rayTest(a,g,b);if(b.hasHit()&&(body=Ammo.btRigidBody.prototype.upcast(b.get_m_collisionObject()),body!==Ammo.NULL&&!(body.isStaticObject()&&!d||body.isKinematicObject()&&!e))){d=body;e=b.get_m_hitPointWorld();a=d.getCenterOfMassTransform().inverse().op_mul(e);if(g=d._cvr_rigidbody)return Ammo.destroy(b),{position:c(e),
localPosition:c(a),rigidBody:g,ammoBody:d};Ammo.destroy(b);return{position:c(e),localPosition:c(a),rigidBody:null,ammoBody:d}}Ammo.destroy(b)}};return{ScenePhysics:v,Constraint:D,RigidProperties:function(c){this.type=h.parseEnum(b.physics.body,c.type);this.mass=c.mass!==a?c.mass:this.type?1:0;this.size=c.size||[1,1,1];this.restitution=c.restitution||(this.type?0:1);this.friction=c.friction||1;if((this.collision=c.collision)&&!this.collision.getShapes)this.collision=new h.CollisionMap(this.collision);
this.blocker=c.blocker||!1},RigidBody:s,vec3bt_copy:y,btvec3_copy:function(a,b){b[0]=a.x();b[1]=a.y();b[2]=a.z()},quatbt_copy:w,btquat_copy:q}});
CubicVR.RegisterModule("CollisionMap",function(h){var y=h.enums;y.collision={shape:{BOX:0,SPHERE:1,CYLINDER:2,CONE:3,CAPSULE:4,MESH:5,HEIGHTFIELD:6,CONVEX_HULL:7}};var w=function(h){this.shapes=[];this.result=null;if(h){h&&!h.length&&(h=[h]);for(var n=0,r=h.length;n<r;n++)this.addShape(h[n])}};w.prototype={addShape:function(q){q.type=h.parseEnum(y.collision.shape,q.type);q.position=q.position||[0,0,0];q.rotation=q.rotation||[0,0,0];q.size=q.size||[1,1,1];q.radius=q.radius||1;q.height=q.height||1;
q.margin=q.margin||0;q.mesh=q.mesh||null;this.shapes.push(q)},getShapes:function(){return this.shapes},setResult:function(h){this.result=h},getResult:function(){return this.result}};return{CollisionMap:w}});
CubicVR.RegisterModule("RigidVehicle",function(h){var y=h.undef,w=h.enums,q,n,r=function(c){var c=h.get(c)||{},a=c.mesh,b=c.collision;this.maxEngineForce=c.maxEngineForce||2E3;this.maxBreakingForce=c.maxBreakingForce||125;this.steeringClamp=c.steeringClamp||0.51;this.mass=c.mass||400;this.rightIndex=this.gVehicleSteering=this.gBreakingForce=this.gEngineForce=0;this.upIndex=1;this.forwardIndex=2;this.m_tuning=this.m_vehicle=this.m_vehicleRayCaster=null;this.wheelDirectionCS0=new Ammo.btVector3;this.wheelAxleCS=
new Ammo.btVector3;this.wheels=[];this.bodyMesh=a;this.bodyCollision=new h.CollisionMap(b);this.sceneObject=new h.SceneObject(this.bodyMesh);if(!q||!n)new Ammo.btVector3,new Ammo.btVector3,q=new Ammo.btTransform,n=new h.Quaternion,new Ammo.btQuaternion;if(c.wheels!=y){a=0;for(b=c.wheels.length;a<b;a++){var e=c.wheels[a];e instanceof h.VehicleWheel?this.addWheel(e):this.addWheel(new h.VehicleWheel(e))}}};r.prototype={getSceneObject:function(){return this.sceneObject},initBody:function(c){this.body=
new h.RigidBody(this.sceneObject,{collision:this.bodyCollision,mass:this.mass,restitution:0.1});h.vec3bt_copy([0,-1,0],this.wheelDirectionCS0);h.vec3bt_copy([-1,0,0],this.wheelAxleCS);this.gVehicleSteering=0;this.body.setLinearVelocity([0,0,0]);this.body.setAngularVelocity([0,0,0]);this.m_vehicleRayCaster=new Ammo.btDefaultVehicleRaycaster(c.dynamicsWorld);this.m_tuning=new Ammo.btVehicleTuning;this.m_vehicle=new Ammo.btRaycastVehicle(this.m_tuning,this.body.getBody(),this.m_vehicleRayCaster);this.body.getBody().setActivationState(w.physics.collision_states.DISABLE_DEACTIVATION);
this.m_vehicle.setCoordinateSystem(this.rightIndex,this.upIndex,this.forwardIndex);for(var a=new Ammo.btVector3,b=0;b<this.wheels.length;b++)h.vec3bt_copy(this.wheels[b].getWheelPosition(),a),this.m_vehicle.addWheel(a,this.wheelDirectionCS0,this.wheelAxleCS,this.wheels[b].getSuspensionRest(),this.wheels[b].getWheelRadius(),this.m_tuning,this.wheels[b].getSteering());c.dynamicsWorld.addVehicle(this.m_vehicle);c.bind(this.body);this.updateSuspension()},evaluate:function(){for(var c=this.m_vehicle.getNumWheels(),
a=0;a<c;a++){this.wheels[a].isSteering()&&this.m_vehicle.setSteeringValue(this.gVehicleSteering,a);this.wheels[a].isBraking()&&this.m_vehicle.setBrake(this.gBrakingForce,a);this.wheels[a].isDriving()&&this.m_vehicle.applyEngineForce(this.gEngineForce,a);this.m_vehicle.updateWheelTransform(a,!0);var b=this.m_vehicle.getWheelTransformWS(a),e=b.getOrigin();this.wheels[a].wheelObj.position[0]=e.x();this.wheels[a].wheelObj.position[1]=e.y();this.wheels[a].wheelObj.position[2]=e.z();b=b.getRotation();n.x=
b.x();n.y=b.y();n.z=b.z();n.w=b.w();b=n.toEuler();this.wheels[a].wheelObj.rotation[0]=b[0];this.wheels[a].wheelObj.rotation[1]=b[1];this.wheels[a].wheelObj.rotation[2]=b[2]}this.body.isActive()||this.body.activate();this.updateSceneObject(!0)},getRigidBody:function(){return this.body},updateSceneObject:function(c){if(this.body&&(this.body.isActive()||c))return this.body.getBody().getMotionState().getWorldTransform(q),c=q.getOrigin(),c.x!=c.x?console.log("origin is NaN"):(this.sceneObject.position[0]=
c.x(),this.sceneObject.position[1]=c.y(),this.sceneObject.position[2]=c.z()),c=q.getRotation(),n.x=c.x(),n.y=c.y(),n.z=c.z(),n.w=c.w(),n.x!=n.x?console.log("rotation is NaN"):(c=n.toEuler(),this.sceneObject.rotation[0]=c[0],this.sceneObject.rotation[1]=c[1],this.sceneObject.rotation[2]=c[2]),!0},setEngineForce:function(c){this.gEngineForce=c;this.gEngineForce>this.maxEngineForce&&(this.gEngineForce=this.maxEngineForce);this.gEngineForce<-this.maxEngineForce&&(this.gEngineForce=-this.maxEngineForce)},
getEngineForce:function(){return this.gEngineForce},incEngine:function(c){this.setEngineForce(this.getEngineForce()+c)},decEngine:function(c){this.setEngineForce(this.getEngineForce()-c)},setSteering:function(c){this.gVehicleSteering=c},getSteering:function(){return this.gVehicleSteering},incSteering:function(c){this.gVehicleSteering+=c;this.gVehicleSteering>this.steeringClamp&&(this.gVehicleSteering=this.steeringClamp);this.gVehicleSteering<-this.steeringClamp&&(this.gVehicleSteering=-this.steeringClamp)},
setBrake:function(c){this.gBreakingForce=c},getWheelGroundPosition:function(c){return this.wheels[c].wheelObj.getWorldPosition()-[0,wheels[c].getWheelRadius(),0]},getWheelSkid:function(c){return this.m_vehicle.getWheelInfo(c).get_m_skidInfo()},getRigidGround:function(c){this.m_vehicle.getWheelInfo(c)},addWheel:function(c,a){a===y&&(a=this.wheels.length);this.wheels[a]=c},getWheel:function(c){return this.wheels[c]},bindToScene:function(c){for(var a=this.wheels.length,b=0;b<a;b++)c.bind(this.getWheelObj(b));
c.bind(this.getSceneObject())},getWheelObj:function(c){return this.getWheel(c).wheelObj},updateSuspension:function(){var c,a=this.m_vehicle.getNumWheels();for(c=0;c<a;c++){var b=this.m_vehicle.getWheelInfo(c);b.set_m_suspensionStiffness(this.wheels[c].getSuspensionStiffness());b.set_m_suspensionRestLength1(this.wheels[c].getSuspensionRest());b.set_m_wheelsDampingRelaxation(this.wheels[c].getDampingRelaxation());b.set_m_wheelsDampingCompression(this.wheels[c].getDampingCompression());b.set_m_frictionSlip(this.wheels[c].getFrictionSlip());
b.set_m_rollInfluence(this.wheels[c].getRollInfluence())}if(this.m_vehicle){this.m_vehicle.resetSuspension();for(c=0;c<a;c++)this.m_vehicle.updateWheelTransform(c,!0)}},getMass:function(){return this.mass},setMass:function(c){this.mass=c;this.body&&this.body.setMass(this.mass)}};var c=function(c){c=h.get(c)||{};this.wheelRef=new h.SceneObject;this.wheelObj=new h.SceneObject;this.wheelRef.scale=c.scale||[1,1,1];this.wheelRadius=c.radius||0;this.wheelWidth=c.width||0;c.mesh!=y&&this.setModel(c.mesh);
this.suspensionStiffness=c.suspensionStiffness||40;this.suspensionRest=c.suspensionRest||0.05;this.dampingRelaxation=c.dampingRelaxation||2.3;this.dampingCompression=c.dampingCompression||2.4;this.frictionSlip=c.frictionSlip||0.94;this.rollInfluence=c.rollInfluence||0.5;this.wheelPosition=c.position||[0,0,0];this.wheelRotation=[0,0,0];this.steering=c.steering||!1;this.braking=c.braking||!1;this.driving=c.driving||!1};c.prototype={setModel:function(c,a,b){this.wheelModel=c;this.wheelRadius=a||0;this.wheelWidth=
b||0;0===this.wheelRadius&&(this.wheelRadius=(this.wheelModel.bb[1][1]-this.wheelModel.bb[0][1])/2,this.wheelRadius+=(this.wheelModel.bb[1][2]-this.wheelModel.bb[0][2])/2,this.wheelRadius/=2);0===this.wheelWidth&&(this.wheelWidth=this.wheelModel.bb[1][0]-this.wheelModel.bb[0][0]);this.wheelRef.obj=this.wheelModel;this.wheelObj.bindChild(this.wheelRef)},setSuspensionStiffness:function(c){this.suspensionStiffness=c},getSuspensionStiffness:function(){return this.suspensionStiffness},setSuspensionRest:function(c){this.suspensionRest=
c},getSuspensionRest:function(){return this.suspensionRest},setDampingRelaxation:function(c){this.dampingRelaxation=c},getDampingRelaxation:function(){return this.dampingRelaxation},setDampingCompression:function(c){this.dampingCompression=c},getDampingCompression:function(){return this.dampingCompression},setFrictionSlip:function(c){this.frictionSlip=c},getFrictionSlip:function(){return this.frictionSlip},setRollInfluence:function(c){this.rollInfluence=c},getRollInfluence:function(){return this.rollInfluence},
setWheelRadius:function(c){this.wheelRadius=c},getWheelRadius:function(){return this.wheelRadius},setWheelWidth:function(c){this.wheelWidth=c},getWheelWidth:function(){return this.wheelWidth},setWheelRotation:function(c){this.wheelRotation=c;this.wheelRef.setRotation(wheelRotation)},getWheelRotation:function(){return this.wheelRotation},setWheelPosition:function(c){this.wheelPosition=c;this.wheelObj.position=wheelPosition},getWheelPosition:function(){return this.wheelPosition},setSteering:function(c){this.steering=
c},getSteering:function(){return this.steering},isSteering:function(){return this.steering},setBraking:function(){this.braking=this.braking_in},isBraking:function(){return this.braking},setDriving:function(c){this.driving=c},isDriving:function(){return this.driving}};return{Vehicle:r,VehicleWheel:c}});window.CubicVRShader.CubicVRCoreVS="attribute vec3 vertexPosition;\nattribute vec3 vertexNormal;\nattribute vec2 vertexTexCoord;\n#if VERTEX_COLOR\nattribute vec3 vertexColor;\nvarying vec3 vertexColorOut;\n#endif\n#if VERTEX_MORPH\nattribute vec3 vertexMorphPosition;\nattribute vec3 vertexMorphNormal;\nuniform float materialMorphWeight;\n#endif\nvarying vec2 vertexTexCoordOut;\nuniform vec2 materialTexOffset;\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#endif\nuniform mat4 matrixModelView;\nuniform mat4 matrixProjection;\nuniform mat4 matrixObject;\nuniform mat3 matrixNormal;\nvarying vec3 vertexNormalOut;\nvarying vec4 vertexPositionOut;\n#if !LIGHT_DEPTH_PASS\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform mat4 lightShadowMatrix[LIGHT_COUNT];\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#endif \nvoid cubicvr_normalMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvec3 tangent;\nvec3 binormal;\nvec3 c1 = cross( vertexNormal, vec3(0.0, 0.0, 1.0) );\nvec3 c2 = cross( vertexNormal, vec3(0.0, 1.0, 0.0) );\nif ( length(c1) > length(c2) )  {\ntangent = c1;\n}  else {\ntangent = c2;\n}\ntangent = normalize(tangent);\nbinormal = cross(vertexNormal, tangent);\nbinormal = normalize(binormal);\nmat4 uMVOMatrix = matrixModelView * matrixObject;\nmat3 TBNMatrix = mat3( (vec3 (uMVOMatrix * vec4 (tangent, 0.0))),\n(vec3 (uMVOMatrix * vec4 (binormal, 0.0))),\n(vec3 (uMVOMatrix * vec4 (vertexNormal, 0.0)))\n);\nenvEyeVectorOut = vec3(uMVOMatrix * vec4(vertexPosition,1.0)) * TBNMatrix;\n#endif\n#endif\n}\nvoid cubicvr_environmentMap() {\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nenvTexCoordOut = normalize( vertexPositionOut.xyz );\n#else\nvec3 ws = (matrixModelView * vec4(vertexPosition,1.0)).xyz;\nvec3 r = reflect(ws, vertexNormalOut );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nenvTexCoordOut.s = r.x/m + 0.5;\nenvTexCoordOut.t = r.y/m + 0.5;\n#endif\n#endif\n#if VERTEX_COLOR\nvertexColorOut = vertexColor;\n#endif\n#endif\n}\nvoid cubicvr_shadowMap() {\n#if (LIGHT_IS_SPOT||LIGHT_IS_AREA) && LIGHT_SHADOWED\nfor (int i = 0; i < LIGHT_COUNT; i++)\n{\n#if LIGHT_SHADOWED\n#if VERTEX_MORPH\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0));\n#else\nlightProjectionOut[i] = lightShadowMatrix[i] * (matrixObject * vec4(vertexPosition, 1.0));\n#endif\n#endif\n}\n#endif\n}\nvoid cubicvr_lighting() {\n#if !LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),vertexNormalOut),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),vertexNormalOut),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(vertexNormalOut, halfVector),0.0);\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\nspecTotal += spec2;\n}\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 accum = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\natt *= spotEffect;\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(vertexNormalOut, normalize(l)));\nfloat NdotH = max(0.0, dot(vertexNormalOut, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\nspec2 = lightSpecular[i] * materialSpecular * power;\nspecTotal += spec2*spotEffect;\n}\nlightColorOut = accum;\nlightSpecularOut = specTotal;\n#endif\n#endif \ncubicvr_normalMap();\ncubicvr_shadowMap();\ncubicvr_environmentMap();\n}\nvec2 cubicvr_texCoord() {\nreturn vertexTexCoord + materialTexOffset;\n}\nvec4 cubicvr_transform() {\n#if LIGHT_DEPTH_PASS\nvertexNormalOut = vec3(0.0,0.0,0.0);\n#endif\n#if VERTEX_MORPH\nvec4 vPos = matrixObject * vec4(vertexPosition+(vertexMorphPosition-vertexPosition)*materialMorphWeight, 1.0);\n#else\nvec4 vPos = matrixObject * vec4(vertexPosition, 1.0);\n#endif\nvertexPositionOut = matrixModelView * vPos;\nreturn vPos;\n}\nvec3 cubicvr_normal() {\n#if VERTEX_MORPH\nreturn normalize(matrixObject*vec4(vertexNormal+(vertexMorphNormal-vertexNormal)*materialMorphWeight,0.0)).xyz;\n#else\nreturn normalize(matrixObject*vec4(vertexNormal,0.0)).xyz;\n#endif\n}\n#define customShader_splice 1\nvoid main(void)\n{\nvertexTexCoordOut = cubicvr_texCoord();\ngl_Position =  matrixProjection * matrixModelView * cubicvr_transform();\n#if !LIGHT_DEPTH_PASS  \nvertexNormalOut = matrixNormal * cubicvr_normal();\ncubicvr_lighting();\n#endif \n}\n";
window.CubicVRShader.CubicVRCoreFS="#ifdef GL_ES\n#if LIGHT_PERPIXEL\nprecision highp float;\n#else\nprecision lowp float;\n#endif\n#endif\n#if FOG_ENABLED\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\n#endif\nuniform vec3 materialAmbient;\nuniform vec3 lightAmbient;\nuniform vec3 materialColor;\n#if LIGHT_PERPIXEL\nuniform vec3 materialDiffuse;\nuniform vec3 materialSpecular;\nuniform float materialShininess;\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\nuniform vec3 lightDirection[LIGHT_COUNT];\nuniform vec3 lightPosition[LIGHT_COUNT];\nuniform vec3 lightSpecular[LIGHT_COUNT];\nuniform vec3 lightDiffuse[LIGHT_COUNT];\nuniform float lightIntensity[LIGHT_COUNT];\nuniform float lightDistance[LIGHT_COUNT];\n#if LIGHT_IS_SPOT\nuniform float lightCutOffAngle[LIGHT_COUNT];\n#endif\n#endif\n#if LIGHT_IS_PROJECTOR\nuniform sampler2D lightProjectionMap[LIGHT_COUNT];\n#endif\n#if LIGHT_SHADOWED\nvarying vec4 lightProjectionOut[LIGHT_COUNT];\nuniform sampler2D lightShadowMap[LIGHT_COUNT];\nuniform vec3 lightDepthClip[LIGHT_COUNT];\n#endif\n#else \nvarying vec3 lightColorOut;\nvarying vec3 lightSpecularOut;\n#endif  \nvarying vec3 vertexNormalOut;\nvarying vec2 vertexTexCoordOut;\n#if VERTEX_COLOR\nvarying vec3 vertexColorOut;\n#endif\n#if FX_DEPTH_ALPHA||LIGHT_DEPTH_PASS||LIGHT_SHADOWED\nuniform vec3 postDepthInfo;\nfloat ConvertDepth3(float d) { return (postDepthInfo.x*postDepthInfo.y)/(postDepthInfo.y-d*(postDepthInfo.y-postDepthInfo.x));  }\nfloat DepthRange( float d ) { return ( d - postDepthInfo.x ) / ( postDepthInfo.y - postDepthInfo.x ); }\nfloat ConvertDepth3A(float d, float near, float far) { return (near*far)/(far-d*(far-near));  }\nfloat DepthRangeA( float d, float near, float far ) { return ( d - near ) / ( far - near ); }\n#endif\n#if LIGHT_DEPTH_PASS\nvec4 packFloatToVec4i(const float value)\n{\nconst vec4 bitSh = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\nconst vec4 bitMsk = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\nvec4 res = fract(value * bitSh);\nres -= res.xxyz * bitMsk;\nreturn res;\n}\n#endif\n#if LIGHT_SHADOWED\nfloat unpackFloatFromVec4i(const vec4 value)\n{\nconst vec4 bitSh = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\nreturn(dot(value, bitSh));\n}\n#if LIGHT_SHADOWED_SOFT\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec2 filterTaps[6];\nfilterTaps[0] = vec2(-0.326212,-0.40581);\nfilterTaps[1] = vec2(-0.840144,-0.07358);\nfilterTaps[2] = vec2(-0.695914,0.457137);\nfilterTaps[3] = vec2(-0.203345,0.620716);\nfilterTaps[4] = vec2(0.96234,-0.194983);\nfilterTaps[5] = vec2(0.473434,-0.480026);\n/*  filterTaps[6] = vec2(0.519456,0.767022);\nfilterTaps[7] = vec2(0.185461,-0.893124);\nfilterTaps[8] = vec2(0.507431,0.064425);\nfilterTaps[9] = vec2(0.89642,0.412458) ;\nfilterTaps[10] =vec2(-0.32194,-0.932615);\nfilterTaps[11] =vec2(-0.791559,-0.59771); */\nfloat shadow = 0.0;\nvec4  shadowSample;\nfloat distanceFromLight;\nfor (int i = 0; i < 6; i++) {\nshadowSample = texture2D(shadowTex,shadowCoord.st+filterTaps[i]*(2.0*texel_size));\ndistanceFromLight = unpackFloatFromVec4i(shadowSample);\nshadow += distanceFromLight <= shadowCoord.z ? 0.0 : 1.0 ;\n}\nshadow /= 6.0;\nreturn shadow;\n}\n#else\nfloat getShadowVal(sampler2D shadowTex,vec4 shadowCoord, float proj, float texel_size) {\nvec4 shadowSample = texture2D(shadowTex,shadowCoord.st);\nfloat distanceFromLight = unpackFloatFromVec4i(shadowSample);\nfloat shadow = 1.0;\nshadow = distanceFromLight <= (shadowCoord.z) ? 0.0 : 1.0 ;\nreturn shadow;\n}\n#endif\n#endif\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\nuniform sampler2D textureColor;\n#endif\n#if TEXTURE_BUMP||TEXTURE_NORMAL\nvarying vec3 envEyeVectorOut;\n#endif\n#if TEXTURE_BUMP\nuniform sampler2D textureBump;\n#endif\n#if TEXTURE_ENVSPHERE\nuniform sampler2D textureEnvSphere;\nuniform float materialEnvironment;\n#if TEXTURE_NORMAL\nvarying vec3 envTexCoordOut;\n#else\nvarying vec2 envTexCoordOut;\n#endif\n#endif\n#if TEXTURE_REFLECT\nuniform sampler2D textureReflect;\n#endif\n#if TEXTURE_NORMAL\nuniform sampler2D textureNormal;\n#endif\nuniform float materialAlpha;\n#if TEXTURE_AMBIENT\nuniform sampler2D textureAmbient;\n#endif\n#if TEXTURE_SPECULAR\nuniform sampler2D textureSpecular;\n#endif\n#endif \n#if TEXTURE_ALPHA\nuniform sampler2D textureAlpha;\n#endif\nvarying vec4 vertexPositionOut;\nvec2 cubicvr_texCoord() {\n#if LIGHT_DEPTH_PASS\nreturn vertexTexCoordOut;\n#else\n#if TEXTURE_BUMP\nfloat height = texture2D(textureBump, vertexTexCoordOut.xy).r;\nfloat v = (height) * 0.05 - 0.04; \nvec3 eye = normalize(envEyeVectorOut);\nreturn vertexTexCoordOut.xy + (eye.xy * v);\n#else\nreturn vertexTexCoordOut;\n#endif\n#endif\n}\nvec3 cubicvr_normal(vec2 texCoord) {\n#if TEXTURE_NORMAL && !LIGHT_DEPTH_PASS\nvec3 bumpNorm = vec3(texture2D(textureNormal, texCoord));\nvec3 n = (vec4(normalize(vertexNormalOut),1.0)).xyz;\nbumpNorm = (bumpNorm-0.5)*2.0;\nbumpNorm.y = -bumpNorm.y;\nreturn normalize((n+bumpNorm)/2.0);\n#else\nreturn normalize(vertexNormalOut);\n#endif\n}\n#if FOG_ENABLED\nvec4 apply_fog(vec4 color) {\nvec4 outColor = color;\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#if USE_FOG_EXP\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\n#if USE_FOG_LINEAR\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\noutColor = mix( color, vec4( fogColor, color.w ), fogFactor );\n#endif\nreturn outColor;\n}\n#endif\nvec4 cubicvr_color(vec2 texCoord) {\nvec4 color = vec4(0.0,0.0,0.0,0.0);\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_COLOR\n#if !(LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA)\ncolor = texture2D(textureColor, texCoord).rgba;\ncolor.rgb *= materialColor;\n#else\ncolor = texture2D(textureColor, texCoord).rgba;\n#if !TEXTURE_ALPHA\nif (color.a<=0.9) {\ndiscard;\n}\n#endif\ncolor.rgb *= materialColor;\n#endif\n#if VERTEX_COLOR\ncolor *= vec4(vertexColorOut,1.0);\n#endif\n#else\n#if VERTEX_COLOR\ncolor = vec4(vertexColorOut,1.0);\n#else\ncolor = vec4(materialColor,1.0);\n#endif\n#endif\n#if TEXTURE_ALPHA\ncolor.a = texture2D(textureAlpha, texCoord).r;\n#if FX_DEPTH_ALPHA\nif (color.a < 0.9) discard;\n#else\n#if MATERIAL_ALPHA\nif (color.a == 0.0) discard;\n#else\nif (color.a < 0.9) discard;\n#endif\n#endif\n#else\n#if MATERIAL_ALPHA\ncolor.a = materialAlpha;\n#endif\n#endif\n#endif\nreturn color;\n}\nvec4 cubicvr_lighting(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\nvec3 accum = lightAmbient;\n#if LIGHT_PERPIXEL\n#if LIGHT_IS_POINT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 lightDirection = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(lightDirection);\nvec3 halfVector = normalize(vec3(0.0,0.0,1.0)+lightDirection);\nfloat NdotL = max(dot(normalize(lightDirection),n),0.0);\nif (NdotL > 0.0) {\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\naccum += att * NdotL * lightDiffuse[i] * materialDiffuse;\nfloat NdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nvec3 spec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nvec3 spec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_DIRECTIONAL\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\nNdotHV = max(dot(n, halfVector),0.0);\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\nspecTotal += spec2;\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_AREA\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nfloat NdotL;\nfloat NdotHV = 0.0;\nvec3 halfVector;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nhalfVector = normalize(vec3(0.0,0.0,1.0)-lightDirection[i]);\nNdotL = max(dot(normalize(-lightDirection[i]),n),0.0);\nif (NdotL > 0.0)   {\nNdotHV = max(dot(n, halfVector),0.0);\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s > 0.000&&shadowCoord.s < 1.000 && shadowCoord.t > 0.000 && shadowCoord.t < 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\naccum += shadow * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#else\naccum += lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * pow(NdotHV,materialShininess);\n#else\nspec2 = lightSpecular[i] * materialSpecular * pow(NdotHV,materialShininess);\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2;\n#if LIGHT_SHADOWED\n#endif\n}\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#endif\n#if LIGHT_IS_SPOT\nvec3 specTotal = vec3(0.0,0.0,0.0);\nvec3 spec2 = vec3(0.0,0.0,0.0);\nvec3 halfVector;\nfloat spotEffect;\nfloat spotDot;\nfloat power;\nfor (int i = 0; i < LIGHT_COUNT; i++) {\nvec3 l = lightPosition[i]-vertexPositionOut.xyz;\nfloat dist = length(l);\nfloat att = clamp(((lightDistance[i]-dist)/lightDistance[i]), 0.0, 1.0)*lightIntensity[i];\natt = clamp(att,0.0,1.0);\nspotDot = dot(normalize(-l), normalize(lightDirection[i]));\nif ( spotDot < cos((lightCutOffAngle[i]/2.0)*(3.14159/180.0)) ) {\nspotEffect = 0.0;\n}\nelse {\nspotEffect = pow(spotDot, 1.0);\n}\n#if !LIGHT_IS_PROJECTOR\natt *= spotEffect;\n#endif\nvec3 v = normalize(-vertexPositionOut.xyz);\nvec3 h = normalize(l + v);\nfloat NdotL = max(0.0, dot(n, normalize(l)));\nfloat NdotH = max(0.0, dot(n, h));\nif (NdotL > 0.0) {\npower = pow(NdotH, materialShininess);\n}\nelse {\npower = 0.0;\n}\n#if LIGHT_SHADOWED\nvec4 shadowCoord = lightProjectionOut[i] / lightProjectionOut[i].w;\nshadowCoord.z = DepthRangeA(ConvertDepth3A(shadowCoord.z,lightDepthClip[i].x,lightDepthClip[i].y),lightDepthClip[i].x,lightDepthClip[i].y);\nvec4 shadowSample;\nfloat shadow = 1.0;\nif (shadowCoord.s >= 0.000&&shadowCoord.s <= 1.000 && shadowCoord.t >= 0.000 && shadowCoord.t <= 1.000) if (i == 0) { shadow = getShadowVal(lightShadowMap[0],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);}\n#if LIGHT_COUNT>1\nelse if (i == 1) { shadow = getShadowVal(lightShadowMap[1],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>2\nelse if (i == 2) { shadow = getShadowVal(lightShadowMap[2],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\n#if LIGHT_COUNT>3\nelse if (i == 3) { shadow = getShadowVal(lightShadowMap[3],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>4\nelse if (i == 4) { shadow = getShadowVal(lightShadowMap[4],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>5\nelse if (i == 5) { shadow = getShadowVal(lightShadowMap[5],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>6\nelse if (i == 6) { shadow = getShadowVal(lightShadowMap[6],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z);  }\n#endif\n#if LIGHT_COUNT>7\nelse if (i == 7) { shadow = getShadowVal(lightShadowMap[7],shadowCoord,lightProjectionOut[i].w,lightDepthClip[i].z); }\n#endif\natt = att * shadow;\n#endif\n#if LIGHT_IS_PROJECTOR && LIGHT_SHADOWED\nif (shadowCoord.s >= 0.0&&shadowCoord.s <= 1.0 && shadowCoord.t >= 0.0 && shadowCoord.t <= 1.0 && spotDot > cos((90.0)*(3.14159/180.0))) {\nvec3 projTex = texture2D(lightProjectionMap[i],shadowCoord.st).rgb;\naccum += att * projTex * lightIntensity[i] * materialDiffuse * lightDiffuse[i] * NdotL;\n}\n#else\naccum += att * lightDiffuse[i] * materialDiffuse * NdotL;\n#endif\n#if TEXTURE_SPECULAR\nspec2 = lightSpecular[i] * texture2D(textureSpecular, vec2(texCoord.s, texCoord.t)).rgb * power;\n#else\nspec2 = lightSpecular[i] * materialSpecular * power;\n#endif\n#if LIGHT_SHADOWED\nspec2 *= shadow;\n#endif\nspecTotal += spec2*spotEffect;\n}\ncolor.rgb *= accum;\ncolor.rgb += specTotal;\n#if LIGHT_SHADOWED\n#endif\n#endif\n#else\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb *= lightColorOut;\ncolor.rgb += lightSpecularOut;\n#endif\n#endif \n#if TEXTURE_AMBIENT\n#if LIGHT_IS_POINT||LIGHT_IS_DIRECTIONAL||LIGHT_IS_SPOT||LIGHT_IS_AREA\ncolor.rgb += texture2D(textureAmbient, texCoord).rgb*(vec3(1.0,1.0,1.0)+materialColor*materialAmbient);\n#else\ncolor.rgb = color.rgb*texture2D(textureAmbient, texCoord).rgb;\n#endif\n#else\n#if TEXTURE_COLOR\ncolor.rgb += materialAmbient*texture2D(textureColor, texCoord).rgb;\n#else\ncolor.rgb += materialColor*materialAmbient;\n#endif\n#endif\n#endif\n#if FOG_ENABLED\nreturn apply_fog(color);\n#else\nreturn color;\n#endif\n}\nvec4 cubicvr_environment(vec4 color_in, vec3 n, vec2 texCoord) {\nvec4 color = color_in;\n#if !LIGHT_DEPTH_PASS\n#if TEXTURE_REFLECT\nfloat environmentAmount = texture2D( textureReflect, texCoord).r;\n#endif\n#if TEXTURE_ENVSPHERE\n#if TEXTURE_NORMAL\nvec3 r = reflect( envTexCoordOut, n );\nfloat m = 2.0 * sqrt( r.x*r.x + r.y*r.y + (r.z+1.0)*(r.z+1.0) );\nvec3 coord;\ncoord.s = r.x/m + 0.5;\ncoord.t = r.y/m + 0.5;\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, coord.st).rgb * materialEnvironment;\n#endif\n#else\n#if TEXTURE_REFLECT\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * environmentAmount;\n#else\ncolor.rgb += materialColor*texture2D( textureEnvSphere, envTexCoordOut).rgb * materialEnvironment;\n#endif\n#endif\n#endif \n#endif \n#if FX_DEPTH_ALPHA\n#if !MATERIAL_ALPHA\nfloat linear_depth = DepthRange( ConvertDepth3(gl_FragCoord.z) );\ncolor.a = linear_depth;\n#endif\n#endif\nreturn color;\n}\n#if LIGHT_DEPTH_PASS\nvec4 cubicvr_depthPack(vec2 texCoord) {\n#if TEXTURE_ALPHA\nfloat alphaVal = texture2D(textureAlpha, texCoord).r;\nif (alphaVal < 0.9) discard;\n#endif\nreturn packFloatToVec4i(DepthRange( ConvertDepth3(gl_FragCoord.z)));\n}\n#endif\n#define customShader_splice 1\nvoid main(void)\n{\nvec2 texCoord = cubicvr_texCoord();\n#if !LIGHT_DEPTH_PASS\nvec4 color = cubicvr_color(texCoord);\nvec3 normal = cubicvr_normal(texCoord);\ncolor = cubicvr_environment(color,normal,texCoord);\ncolor = cubicvr_lighting(color,normal,texCoord);\ngl_FragColor = clamp(color,0.0,1.0);\n#else \ngl_FragColor = cubicvr_depthPack(texCoord);\n#endif\n}\n";
